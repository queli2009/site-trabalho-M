/**
 * IMPORTANT NOTE:
 *
 * This file is licensed only for the use of Apple developers in providing MusicKit Web Services,
 * and is subject to the Apple Media Services Terms and Conditions and the Apple Developer Program
 * License Agreement. You may not copy, modify, re-host, or create derivative works of this file or the
 * accompanying Documentation, or any part thereof, including any updates, without Apple's written consent.
 *
 * ACKNOWLEDGEMENTS:
 * https://js-cdn.music.apple.com/musickit/v1/acknowledgements.txt
 */

!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).MusicKit={})}(this,(function(e){"use strict";var n=void 0!==typeof self?self:this;function formatArtworkURL(e,n,d){return n=n||e.height||100,d=d||e.width||100,window.devicePixelRatio>=1.5&&(d*=2,n*=2),e.url.replace("{h}",""+n).replace("{w}",""+d).replace("{f}","jpeg")}const K=()=>{},asAsync=e=>{e.then(K,K)},d=/\/(?:([a-z]{2})\/)?(album|artist|episode|movie|music-video|playlist|podcast|post|season|show|song|station)\/(?:[^/]*\/)?(?:id)?(\d+|[a-z]{2}\.[a-z0-9-]+|umc.cmc.[a-zA-Z0-9]+)(?:.*(?:[?|&]i=(\d+)).*)?.*$/i;function parseMediaURL(e){const n=e.match(d)||[];let[,p,h,y,_]=n;"music-video"===h&&(h="musicVideo"),-1!==["album","playlist"].indexOf(h)&&_?(h="song",y=_):"podcast"===h&&_&&(h="episode",y=_);return{storefrontId:p,kind:h,contentId:y,itemId:_}}function formattedMediaURL(e){const n=parseMediaURL(e),{storefrontId:d,kind:p,contentId:h}=n;if([d,p,h].some(e=>void 0===e))throw new TypeError("Invalid Media URL: "+e);const y=!!h&&h.startsWith("umc.");return{storefrontId:d,kind:p,contentId:h,isUTS:y}}const p=/^http(?:s)?\:\/\/(?:itunes|(embed\.)?(music|podcasts|tv))\.apple\.com/i,h=["allow-forms","allow-popups","allow-same-origin","allow-scripts","allow-storage-access-by-user-activation","allow-top-navigation-by-user-activation"],y=["autoplay *","encrypted-media *","fullscreen *","clipboard-write"];function dasherize$1(e){return e.replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").replace(/(^-+)|(-+$)/,"").toLowerCase()}const _=new Map;function pluralizeMediaType(e){if(_.has(e))return _.get(e);let n=dasherize$1(e);return e.endsWith("y")?n=n.substring(0,n.length-1)+"ies":n.endsWith("s")||(n+="s"),_.set(e,n),n}function normalizeMediaType(e){return pluralizeMediaType(e)}const m=["contributors","modalities","movie","musicVideo","musicMovie","trailer","tvEpisode","uploadedVideo","uploaded-videos","music-videos","music-movies","tv-episodes","workouts"];function itemType(e){var n,d;return void 0!==(null==e||null===(d=e.attributes)||void 0===d||null===(n=d.playParams)||void 0===n?void 0:n.kind)?e.attributes.playParams.kind:null==e?void 0:e.type}function isVideo(e){var n;return null!=e&&(!0===e.isUTS||m.includes(e.type)||"video"===(null===(n=e.attributes)||void 0===n?void 0:n.mediaKind))}function isPodcastEpisode(e){var n;return!0===(null===(n=itemType(e))||void 0===n?void 0:n.startsWith("podcast-episode"))}function isLive(e){var n;return!!(null==e||null===(n=e.attributes)||void 0===n?void 0:n.isLive)}function isStream$1(e){var n,d;return"stream"===(null==e||null===(d=e.attributes)||void 0===d||null===(n=d.playParams)||void 0===n?void 0:n.format)}function isTracksRadioStation(e){var n,d;return"tracks"===(null==e||null===(d=e.attributes)||void 0===d||null===(n=d.playParams)||void 0===n?void 0:n.format)}function isAlgoStation(e){return function(...e){return isTracksRadioStation(...e)}(e)}function isRadioStation(e,n){var d,p,h;return"radioStation"===(null==e||null===(p=e.attributes)||void 0===p||null===(d=p.playParams)||void 0===d?void 0:d.kind)&&(void 0===n||(null===(h=e.attributes)||void 0===h?void 0:h.mediaKind)===n)}function isRadioEpisode(e,n){var d;return isRadioStation(e,n)&&isStream$1(e)&&!isLive(e)&&"Episode"===(null==e||null===(d=e.attributes)||void 0===d?void 0:d.streamingRadioSubType)}function isLiveRadioStation(e,n){return isRadioStation(e,n)&&isLive(e)&&isStream$1(e)}function isLiveRadioKind(e,n){return isLiveRadioStation(e,n)}function _define_property$2f(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const g={INVALID_ERROR_ID:"INVALID_ERROR_ID",INVALID_ERROR_REASON:"INVALID_ERROR_REASON",ACCESS_DENIED:"ACCESS_DENIED",AGE_GATE:"AGE_GATE",AUTHORIZATION_ERROR:"AUTHORIZATION_ERROR",BUFFER_STALLED_ERROR:"BUFFER_STALLED_ERROR",CONFIGURATION_ERROR:"CONFIGURATION_ERROR",CONTENT_EQUIVALENT:"CONTENT_EQUIVALENT",CONTENT_RESTRICTED:"CONTENT_RESTRICTED",CONTENT_UNAVAILABLE:"CONTENT_UNAVAILABLE",CONTENT_UNSUPPORTED:"CONTENT_UNSUPPORTED",DEVICE_LIMIT:"DEVICE_LIMIT",GEO_BLOCK:"GEO_BLOCK",INVALID_ARGUMENTS:"INVALID_ARGUMENTS",PLAYREADY_CBC_ENCRYPTION_ERROR:"PLAYREADY_CBC_ENCRYPTION_ERROR",MEDIA_CERTIFICATE:"MEDIA_CERTIFICATE",MEDIA_DESCRIPTOR:"MEDIA_DESCRIPTOR",MEDIA_LICENSE:"MEDIA_LICENSE",MEDIA_KEY:"MEDIA_KEY",MEDIA_PLAYBACK:"MEDIA_PLAYBACK",MEDIA_SESSION:"MEDIA_SESSION",NETWORK_ERROR:"NETWORK_ERROR",NOT_FOUND:"NOT_FOUND",NOT_IMPLEMENTED:"NOT_IMPLEMENTED",PARSE_ERROR:"PARSE_ERROR",PLAY_ACTIVITY:"PLAY_ACTIVITY",REQUEST_ERROR:"REQUEST_ERROR",QUOTA_EXCEEDED:"QUOTA_EXCEEDED",SERVER_ERROR:"SERVER_ERROR",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE",STREAM_UPSELL:"STREAM_UPSELL",SUBSCRIPTION_ERROR:"SUBSCRIPTION_ERROR",TOKEN_EXPIRED:"TOKEN_EXPIRED",UNAUTHORIZED_ERROR:"UNAUTHORIZED_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR",UNSUPPORTED_ERROR:"UNSUPPORTED_ERROR",USER_INTERACTION_REQUIRED:"USER_INTERACTION_REQUIRED",INTERNAL_ERROR:"INTERNAL_ERROR",OUTPUT_RESTRICTED:"OUTPUT_RESTRICTED",WIDEVINE_CDM_EXPIRED:"WIDEVINE_CDM_EXPIRED"},b={400:g.REQUEST_ERROR,401:g.UNAUTHORIZED_ERROR,403:g.ACCESS_DENIED,404:g.NOT_FOUND,405:g.NOT_FOUND,413:g.REQUEST_ERROR,414:g.REQUEST_ERROR,429:g.QUOTA_EXCEEDED,500:g.SERVER_ERROR,501:g.NOT_FOUND,503:g.SERVICE_UNAVAILABLE},P={"-1003":g.MEDIA_LICENSE,"-1004":g.DEVICE_LIMIT,"-1017":g.GEO_BLOCK,1010:g.NOT_FOUND,2002:g.AUTHORIZATION_ERROR,2034:g.TOKEN_EXPIRED,3059:g.DEVICE_LIMIT,3063:g.SUBSCRIPTION_ERROR,3076:g.CONTENT_UNAVAILABLE,3082:g.CONTENT_RESTRICTED,3084:g.STREAM_UPSELL,5002:g.SERVER_ERROR,180202:g.PLAYREADY_CBC_ENCRYPTION_ERROR,190121:g.WIDEVINE_CDM_EXPIRED},S=new Set([g.CONTENT_EQUIVALENT,g.CONTENT_UNAVAILABLE,g.CONTENT_UNSUPPORTED,g.SERVER_ERROR,g.SUBSCRIPTION_ERROR,g.UNSUPPORTED_ERROR,g.USER_INTERACTION_REQUIRED]);function isMKError(e){return void 0!==e&&e instanceof MKUniqueError}class MKUniqueError extends Error{static isMKError(e){return isMKError(e)}get errorCode(){return this.reason}constructor(e,n,d){if("string"!=typeof(p=e)||!/mk-[0-9]{3,}/.test(p))throw new MKUniqueError("mk-000",g.INVALID_ERROR_ID,{description:"Invalid error id format: "+e});var p;if(void 0===n||!(n in g))throw new MKUniqueError("mk-001",g.INVALID_ERROR_REASON,"Invalid error reason: "+n);"string"==typeof(d=null!=d?d:{})?d={description:d}:d instanceof Error&&(d={origin:d}),void 0===d.description&&void 0!==d.origin&&(d.description=isMKError(d.origin)?d.origin.description:d.origin.message);let h=`[${e}] ${n}`;var y;void 0!==d.description&&(h+="; "+d.description),super(h),_define_property$2f(this,"isMKError",!0),_define_property$2f(this,"id",void 0),_define_property$2f(this,"reason",void 0),_define_property$2f(this,"description",void 0),_define_property$2f(this,"origin",void 0),_define_property$2f(this,"data",void 0),this.name="MKError",this.id=e,this.reason=n,this.description=null!==(y=d.description)&&void 0!==y?y:"",this.origin=d.origin,this.data=d.data}}_define_property$2f(MKUniqueError,"Reason",g),Object.assign(MKUniqueError,g);class MKError extends MKUniqueError{static playActivityError(e){return new this(g.PLAY_ACTIVITY,e)}static parseError(e){return new this(g.PARSE_ERROR,e)}static responseError(e){const{status:n,statusText:d}=e,p=new this(b[n]||g.NETWORK_ERROR,d||""+n);return p.data=e,p}static serverError(e,n=g.UNKNOWN_ERROR){let{status:d,dialog:p,failureType:h,customerMessage:y,errorMessage:_,message:m}=e;p&&(m=p.message||p.customerMessage||p.errorMessage,p.message=m);const b=P[h]||P[d]||n,S=new this(b,m||y||_);return b===g.STREAM_UPSELL&&p&&p.okButtonAction&&p.okButtonAction.url&&(p.okButtonAction.url=p.okButtonAction.url.replace(/\&(?:challenge|key-system|uri|user-initiated)=[^\&]+/gim,"")),S.dialog=p,S}static internalError(e){return new this(g.INTERNAL_ERROR,e)}constructor(e,n){S.has(e)&&(n=null!=n?n:e),super("mk-007",e,{description:n}),_define_property$2f(this,"dialog",void 0)}}class GenericStorage{get data(){return this._data}set data(e){this._data=e}get length(){return this.keys.length}get keys(){return Object.keys(this.data)}getItem(e){return this.data[e]||null}setItem(e,n){this.data[e]=n}removeItem(e){delete this.data[e]}clear(){this.keys.forEach(e=>this.removeItem(e))}key(e){return this.keys[e]||null}constructor(e={}){var n,d,p;p=void 0,(d="_data")in(n=this)?Object.defineProperty(n,d,{value:p,enumerable:!0,configurable:!0,writable:!0}):n[d]=p,this.data=e}}function getCookie(e="",n=document.cookie){const d=n.match(new RegExp(`(?:^|;\\s*)${e}=([^;]*)`));if(d)return d[1]}function setCookie(e,n,d="",p=14,h,y){const _=new Date;h=null!=h?h:window;const m=(y=null!=y?y:/\./.test(h.location.hostname)?h.location.hostname:"").length>0?`domain=${y}; `:"";_.setTime(_.getTime()+24*p*60*60*1e3);let g="";"https:"===h.location.protocol&&(g="; secure"),h.document.cookie=`${e}=${n}; expires=${_.toUTCString()}; ${m}path=${d}${g}`}function removeCookie(e,n,d){setCookie(e,"","/",0,n,d)}function hasSessionStorage(){let e=!1;try{e="undefined"!=typeof sessionStorage}catch(St){}return e}function getSessionStorage(){let e;return hasSessionStorage()&&(e=sessionStorage),e}function hasLocalStorage(){let e=!1;try{e="undefined"!=typeof localStorage}catch(St){}return e}function getLocalStorage(){let e;return hasLocalStorage()&&(e=localStorage),e}function getJsonFromLocalStorage(e){const n=function(e){if(!hasLocalStorage())return;const n=getLocalStorage().getItem(e);return null!==n?n:void 0}(e);if(n)try{return JSON.parse(n)}catch(St){return}}function _define_property$2d(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class Notifications{get shouldStorageDispatch(){return"undefined"!=typeof window&&hasSessionStorage()&&this.dispatchNamespace}addEventListener(e,n){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].push(n)}dispatchEvent(e,n){Array.isArray(this._eventRegistry[e])&&this._eventRegistry[e].forEach(e=>e(n))}dispatchDistributedEvent(e,n){if(this.dispatchEvent(e,n),this.shouldStorageDispatch){var d;const p=`${this.dispatchNamespace}:${e}`;null===(d=getSessionStorage())||void 0===d||d.setItem(p,JSON.stringify(n))}}removeEventListener(e,n){if(Array.isArray(this._eventRegistry[e])){const d=this._eventRegistry[e].indexOf(n);this._eventRegistry[e].splice(d,1)}}_handleGlobalStorageEvent(e){var n;if(this.dispatchNamespace&&(null===(n=e.key)||void 0===n?void 0:n.startsWith(this.dispatchNamespace+":"))){const n=e.key.substring(this.dispatchNamespace.length+1);this.dispatchEvent(n,JSON.parse(e.newValue))}}constructor(e=[],n){_define_property$2d(this,"dispatchNamespace",void 0),_define_property$2d(this,"_eventRegistry",{}),e.forEach(e=>{this._eventRegistry[e]=[]}),n&&n.namespace&&(this.dispatchNamespace="com.apple."+n.namespace),this.shouldStorageDispatch&&(this._handleGlobalStorageEvent=this._handleGlobalStorageEvent.bind(this),window.addEventListener("storage",this._handleGlobalStorageEvent))}}var T="undefined"!=typeof FastBoot?FastBoot.require("buffer").Buffer:"undefined"!=typeof process&&null!==process.versions&&null!==process.versions.node?Buffer:window.Buffer;function memoize(e){return function(...n){let d="",p=n.length;for(e._memoized=e._memoized||{};p--;){const e=n[p];d+=e===Object(e)?JSON.stringify(e):e}return d in e._memoized?e._memoized[d]:e._memoized[d]=e(...n)}}function generateUUID(){let e=strRandomizer()+strRandomizer();for(;e.length<16;)e+=strRandomizer();return e.slice(0,16)}function strRandomizer(){return Math.random().toString(16).substring(2)}function isLibraryType(e){if(void 0===e)return!1;const n="string"==typeof e?e:e.id;return/^[a|i|l|p]{1}\.[a-zA-Z0-9]+$/.test(n)}const k=memoize(e=>/^(a\.)?[a-zA-Z0-9]+$/.test(e));function detectNodeEnvironment(){var e,n,d,p;return void 0!==(null===(d=globalThis)||void 0===d||null===(n=d.process)||void 0===n||null===(e=n.versions)||void 0===e?void 0:e.node)||void 0!==(null===(p=globalThis)||void 0===p?void 0:p.FastBoot)}function isNodeEnvironment$1(){return detectNodeEnvironment()}const E=memoize(detectNodeEnvironment()?e=>T.from(e,"base64").toString("binary"):e=>window.atob(e));memoize(detectNodeEnvironment()?e=>T.from(e).toString("base64"):e=>window.btoa(e));const debounce=(e,n=250,d={isImmediate:!1})=>{let p;return function(...h){const y=this,_=d.isImmediate&&void 0===p;void 0!==p&&clearTimeout(p),p=setTimeout((function(){p=void 0,d.isImmediate||e.apply(y,h)}),n),_&&e.apply(y,h)}},arrayEquals=(e,n)=>!!e&&!!n&&[].every.call(e,(e,d)=>e===n[d]);function hasOwn(e,n){return Object.prototype.hasOwnProperty.call(Object(e),n)}function deepClone(e){const n=Object.prototype.toString.call(e).toLowerCase().slice(8,-1);switch(n){case"set":return new Set([...e].map(e=>deepClone(e)));case"map":return new Map([...e].map(([e,n])=>[deepClone(e),deepClone(n)]));case"date":return new Date(e.getTime());case"regexp":{const n=e,d="string"==typeof n.flags?n.flags:[n.global?"g":void 0,n.ignoreCase?"i":void 0,n.multiline?"m":void 0,n.sticky?"y":void 0,n.unicode?"u":void 0].filter(e=>void 0!==e).join("");return RegExp(e.source,d)}case"arraybuffer":{const n=e;if("function"==typeof n.slice)return n.slice(0);{const d=new e.constructor(n.byteLength);return new Uint8Array(d).set(new Uint8Array(n)),d}}case"dataview":case"int8array":case"uint8array":case"uint8clampedarray":case"int16array":case"uint16array":case"int32array":case"uint32array":case"float32array":case"float64array":case"bigint64array":case"biguint64array":{const d=e;return new(0,d.constructor)(deepClone(d.buffer),d.byteOffset,"dataview"===n?d.byteLength:d.length)}case"array":case"object":{const n=Array.isArray(e)?[]:{};for(const d in e)hasOwn(e,d)&&(n[d]=deepClone(e[d]));return n}default:return e}}function isEmpty(e){if("object"!=typeof e)throw new TypeError("Source is not an Object");for(const n in e)if(hasOwn(e,n))return!1;return!0}function transform$b(e,n,d=!1){return d&&(e=Object.keys(e).reduce((n,d)=>(n[e[d]]=d,n),{})),Object.keys(e).reduce((d,p)=>{const h=e[p],y="function"==typeof h?h():function(e,n){return n.split(".").reduce((e,n)=>{if(void 0!==e)return e[n]},e)}(n,h);return y&&function(e,n,d){n.split(".").reduce((n,p,h,y)=>{const _=h===y.length-1,m=hasOwn(n,p),g=n[p]instanceof Object,b=null===n[p];if(!_&&m&&(!g||b))throw new TypeError(`Value at ${y.slice(0,h+1).join(".")} in keypath is not an Object.`);return _?(n[p]=d,e):m?n[p]:n[p]={}},e)}(d,p,y),d},{})}function transformKeys(e,n){return Object.keys(e).reduce((d,p)=>(d[n(p)]=e[p],d),{})}const w={};function findOrCreate(e,n){const d=e.toLowerCase().replace(/[^a-zA-Z0-9]+(.)/g,(e,n)=>n.toUpperCase());if(hasOwn(w,d)){const p=w[d];if(n!==p.constructor)throw new Error(`DevFlag ${e} was already registered with a different type (${p.constructor.name})`);return p}const p=new n(e);return Object.defineProperty(w,d,{configurable:!0,enumerable:!0,get:function(){return p},set:function(e){p.set(e)}}),p}class LocalStorageDevFlag{get value(){return this.get()}get configured(){return void 0!==this.value}read(){var e,n;const d=null!==(n=null===(e=getLocalStorage())||void 0===e?void 0:e.getItem(this.key))&&void 0!==n?n:null;return null!==d?d:void 0}write(e){var n;null===(n=getLocalStorage())||void 0===n||n.setItem(this.key,e)}clear(){var e;null===(e=getLocalStorage())||void 0===e||e.removeItem(this.key)}constructor(e){if(function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"key",void 0),"string"!=typeof e||""===e.trim())throw new Error("DevFlag requires a non-empty string key");this.key=e}}class StringDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,n){this.register(e).set(n)}get(){return this.read()}set(e){"string"!=typeof e&&console.warn("Value for StringDevFlag should be a string"),this.write(e)}}class BooleanDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,n){this.register(e).set(n)}get(){const e=this.read();if(void 0!==e)return"1"===e||"true"===e.toLowerCase()}set(e){"boolean"==typeof e?this.write(!0===e?"1":"0"):console.warn("Value for BooleanDevFlag should be a boolean")}get enabled(){return!0===this.get()}enable(){this.set(!0)}disable(){this.set(!1)}toggle(){this.set(!this.get())}}class JsonDevFlag extends LocalStorageDevFlag{static register(e){return findOrCreate(e,this)}static get(e){return this.register(e).get()}static set(e,n){this.register(e).set(n)}get(){const e=this.read();if(void 0!==e)try{return JSON.parse(e)}catch(he){return}}set(e){this.write(JSON.stringify(e))}prop(e){if(void 0!==this.value)return this.value[e]}}const O=["contributors","modalities","musicVideo","podcast-episodes","radioStation","song","uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo","workouts","workout-programs"],I={mediaItemStateDidChange:"mediaItemStateDidChange",mediaItemStateWillChange:"mediaItemStateWillChange"},$={CRITICAL:50,ERROR:40,WARNING:30,NOTICE:20,INFO:10,DEBUG:2,TRACE:1,NONE:0};const A={OFF:"NONE",0:"NONE","+":"INFO","++":"DEBUG",V:"DEBUG",D:"DEBUG",VERBOSE:"DEBUG",VV:"TRACE",SILLY:"TRACE","*":"TRACE"};function getLoggingLevel(e,n={}){if("number"==typeof e)return function(e){return"number"==typeof e&&Object.values($).includes(e)}(e)?e:void 0;let d=e.toUpperCase();return n.allowShorthands&&void 0!==A[d]&&(d=A[d]),function(e){return"string"==typeof e&&void 0!==$[e.toUpperCase()]}(d)?$[d]:void 0}function getLoggingLevelName(e){for(const[n,d]of Object.entries($))if(e===d)return n}function walk(e,n){const d=[e];for(;d.length>0;){const e=d.shift();void 0!==e&&(d.push(...e.children),n(e))}}function _define_property$2b(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$15(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$2b(e,n,d[n])}))}return e}function _object_spread_props$J(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _define_property1(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const R=$.ERROR,DEFAULT_POLICY=(e,n)=>e!==$.NONE&&n>=e;class Logger$1{get parent(){return this._parent}get children(){return Array.from(this._children.values())}get namespace(){return void 0===this._parent?this.name:this._parent.namespace+"/"+this.name}get enabled(){return this.level!==$.NONE}get level(){var e,n,d;return null!==(d=null!==(n=this._level)&&void 0!==n?n:null===(e=this.parent)||void 0===e?void 0:e.level)&&void 0!==d?d:R}get levelName(){var e;return null!==(e=getLoggingLevelName(this.level))&&void 0!==e?e:"UNKNOWN"}get levelPolicy(){var e,n,d;return null!==(d=null!==(n=this._levelPolicy)&&void 0!==n?n:null===(e=this.parent)||void 0===e?void 0:e.levelPolicy)&&void 0!==d?d:DEFAULT_POLICY}get handlers(){var e,n,d;return null!==(d=null!==(n=this._handlers)&&void 0!==n?n:null===(e=this.parent)||void 0===e?void 0:e.handlers)&&void 0!==d?d:{}}isEnabledFor(e){return this.levelPolicy(this.level,e)}setLevel(e){const n=getLoggingLevel(e);void 0!==n&&(this._level=n)}clearLevel(){this._level=void 0}setLevelPolicy(e){this._levelPolicy=e}clearLevelPolicy(){this._levelPolicy=void 0}addHandler(e,n){this._handlers||(this._handlers={}),this._handlers[e]=n}hasHandler(e){var n;return void 0!==(null===(n=this._handlers)||void 0===n?void 0:n[e])}removeHandler(e){void 0!==this._handlers&&(delete this._handlers[e],0===Object.keys(this._handlers).length&&this.clearHandlers())}clearHandlers(){this._handlers=void 0}createChild(e,n){const d=this._children.get(e);return void 0!==d?d:new Logger$1(e,_object_spread_props$J(_object_spread$15({},n),{parent:this}))}linkChild(e){if(void 0!==e.parent&&e.parent!==this)throw new Error(`Logger '${e.name}' is already a child of a different parent ('${e.parent.name}')`);const n=this._children.get(e.name);if(void 0!==n&&n!==e)throw new Error(`A child with name '${e.name}' is already registered`);return void 0===n&&(this._children.set(e.name,e),e.linkParent(this)),e}unlinkChild(e){const n=this._children.get(e.name);return n===e&&(this._children.delete(e.name),n.unlinkParent()),e}getByName(e){return this._children.get(e)}getByNamespace(e){return function(e,n,d="/"){if(""===(n=n.trim())||"*"===n)return e;const p=n.split(d);p[0].trim()===e.name&&p.shift();if(0===p.length)return e;let h=e;for(;void 0!==h&&p.length>0;){const e=p.shift();h=h.getByName(e.trim())}return h}(this,e)}linkParent(e){return this.parent!==e&&(this.unlinkParent(),this._parent=e,e.linkChild(this)),this}unlinkParent(){return void 0!==this._parent&&(this._parent.unlinkChild(this),this._parent=void 0),this}log(e,n,...d){const p=getLoggingLevel(e);void 0!==p&&this.logRecord({time:Date.now(),namespace:this.namespace,level:p,message:n,args:d})}logRecord(e){if(!this.levelPolicy(this.level,e.level))return;const n=_object_spread$15({namespace:this.namespace},e);for(const d of Object.values(this.handlers))d.process(n)}error(e,...n){this.log($.ERROR,e,...n)}warning(e,...n){this.log($.WARNING,e,...n)}warn(e,...n){this.warning(e,...n)}info(e,...n){this.log($.INFO,e,...n)}debug(e,...n){this.log($.DEBUG,e,...n)}trace(e,...n){this.log($.TRACE,e,...n)}constructor(e,n){_define_property1(this,"name",void 0),_define_property1(this,"_parent",void 0),_define_property1(this,"_children",new Map),_define_property1(this,"_level",void 0),_define_property1(this,"_levelPolicy",void 0),_define_property1(this,"_handlers",void 0),this.name=e,this._levelPolicy=null==n?void 0:n.levelPolicy,this._handlers=null==n?void 0:n.handlers,void 0!==(null==n?void 0:n.parent)&&this.linkParent(n.parent),void 0!==(null==n?void 0:n.level)&&this.setLevel(n.level)}}function _define_property$2a(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class CallbackHandler{process(e){this.enabled&&void 0!==this.callback&&this.callback(e)}constructor(e,n={}){var d;_define_property$2a(this,"enabled",void 0),_define_property$2a(this,"callback",void 0),this.callback=e,this.enabled=null===(d=n.enabled)||void 0===d||d}}const C=/%{([^}]+)}/gi,M={timestamp:e=>String(e.time),time:e=>String(e.time),datetime:e=>new Date(e.time).toISOString(),date:e=>new Date(e.time).toISOString(),level:e=>String(e.level),levelname:e=>{var n;return null!==(n=getLoggingLevelName(e.level))&&void 0!==n?n:"UNKNOWN"},message:e=>e.message,name:e=>e.namespace.split("/").pop(),namespace:e=>e.namespace};function _define_property$29(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const D=new Map([[$.CRITICAL,"error"],[$.ERROR,"error"],[$.WARNING,"warn"],[$.NOTICE,"warn"],[$.INFO,"log"],[$.DEBUG,"debug"]]),j=(x="%{datetime} %{levelname} - [%{namespace}] %{message}",function(e){return x.replace(C,(function(n,d){return d=d.toLowerCase(),void 0!==M[d]?M[d](e):n}))});var x;const N=memoize(e=>{const n=E(e);return L(n)});function ensureArray(e=[]){return Array.isArray(e)?e:[e]}const L=memoize(e=>{const n=e.length,d=new ArrayBuffer(n),p=new Uint8Array(d);for(let h=0;h<n;h++)p[h]=e.charCodeAt(h);return p}),U=memoize(e=>{const n=e.length,d=new ArrayBuffer(2*n),p=new Uint16Array(d);for(let h=0;h<n;h++)p[h]=e.charCodeAt(h);return p}),F=memoize(e=>{let n,d,p,h,y,_,m,g=0;const b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let P="";for(;g<e.length;)n=e[g++],d=g<e.length?e[g++]:Number.NaN,p=g<e.length?e[g++]:Number.NaN,h=n>>2,y=(3&n)<<4|d>>4,_=(15&d)<<2|p>>6,m=63&p,isNaN(d)?_=m=64:isNaN(p)&&(m=64),P+=b.charAt(h)+b.charAt(y)+b.charAt(_)+b.charAt(m);return P});let isMergeableObject=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){let n=Object.prototype.toString.call(e);return"[object RegExp]"===n||"[object Date]"===n||function(e){return e.$$typeof===B}(e)}(e)};let B="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function cloneUnlessOtherwiseSpecified(e,n){return!1!==n.clone&&n.isMergeableObject(e)?deepmerge((d=e,Array.isArray(d)?[]:{}),e,n):e;var d}function defaultArrayMerge(e,n,d){return e.concat(n).map((function(e){return cloneUnlessOtherwiseSpecified(e,d)}))}function getKeys(e){return Object.keys(e).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(n){return e.propertyIsEnumerable(n)})):[]}(e))}function mergeObject(e,n,d){let p={};return d.isMergeableObject(e)&&getKeys(e).forEach((function(n){p[n]=cloneUnlessOtherwiseSpecified(e[n],d)})),getKeys(n).forEach((function(h){d.isMergeableObject(n[h])&&e[h]?p[h]=function(e,n){if(!n.customMerge)return deepmerge;let d=n.customMerge(e);return"function"==typeof d?d:deepmerge}(h,d)(e[h],n[h],d):p[h]=cloneUnlessOtherwiseSpecified(n[h],d)})),p}function deepmerge(e,n,d){(d=d||{}).arrayMerge=d.arrayMerge||defaultArrayMerge,d.isMergeableObject=d.isMergeableObject||isMergeableObject;let p=Array.isArray(n);return p===Array.isArray(e)?p?d.arrayMerge(e,n,d):mergeObject(e,n,d):cloneUnlessOtherwiseSpecified(n,d)}function _define_property$28(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$14(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$28(e,n,d[n])}))}return e}function _object_spread_props$I(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _object_without_properties$3(e,n){if(null==e)return{};var d,p,h=function(e,n){if(null==e)return{};var d,p,h={},y=Object.keys(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||(h[d]=e[d]);return h}(e,n);if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||Object.prototype.propertyIsEnumerable.call(e,d)&&(h[d]=e[d])}return h}deepmerge.all=function(e,n){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,d){return deepmerge(e,d,n)}),{})};const isDataRecord=e=>!(!e||"function"!=typeof e.hasAttributes||"function"!=typeof e.hasRelationships||"function"!=typeof e.hasViews||"function"!=typeof e.serialize);class DataRecord{hasProperties(e){return!e||(e.attributes||e.relationships||e.views?!(e.attributes&&!this.hasAttributes(e.attributes))&&(!(e.relationships&&!this.hasRelationships(e.relationships))&&!(e.views&&!this.hasViews(e.views))):this.hasAttributes()||this.hasRelationships()||this.hasViews())}hasAttributes(e){return this._hasProperties(this._mjs.attributes,e)}hasRelationships(e){return this._hasProperties(this._mjs.relationships,e)}hasViews(e){return this._hasProperties(this._mjs.views,e)}meta(e){return e?this._meta[e]:this._meta}serialize(e=!0,n={},d={}){const p={id:this.id,type:this.type};return n[`${this.type}-${this.id}`]&&!d.allowFullDuplicateSerializations?p:(n[`${this.type}-${this.id}`]=!0,this.hasAttributes()&&(p.attributes=this._mjs.attributes.reduce((e,n)=>(e[n]=this[n],e),{})),this._mjs.relationships.length>0&&(p.relationships=this._serializeRelatedData(this._mjs.relationships,n,d)),this._mjs.views.length>0&&(p.views=this._serializeRelatedData(this._mjs.views,n,d)),e?{data:p}:p)}setProperty(e,n,d="attributes",p={}){function isMergeableObject(e){return!(!e||"object"!=typeof e||e instanceof DataRecord)}hasOwn(this,e)||(this._mjs[d]||(this._mjs[d]=[]),this._mjs[d].push(e));const setDescriptor=e=>({value:e,writable:!0,configurable:!0,enumerable:!0});this[e]&&n&&"object"==typeof this[e]&&"object"==typeof n?"attributes"===d?Object.defineProperty(this,e,setDescriptor(deepmerge(this[e],n,{arrayMerge:function(e,n,d){return n},isMergeableObject:isMergeableObject}))):"relationships"===d&&Array.isArray(this[e])&&p.extendRelationships?Object.defineProperty(this,e,setDescriptor(deepmerge(this[e],n,{isMergeableObject:isMergeableObject}))):Object.defineProperty(this,e,setDescriptor(n)):Object.defineProperty(this,e,setDescriptor(n))}removeRelative(e,n){this[e]&&(Array.isArray(this[e])?this[e]=this[e].filter(e=>e.id!==n):delete this[e])}setParent(e){const n=this._mjs.parents,d=n&&n.length>0;this._mjs.parents=d?n.concat(e):e}_hasProperties(e,n){return!!e&&(n?ensureArray(n).every(n=>e.includes(n)):e.length>0)}_serializeRelatedData(e,n={},d={}){return e.reduce((e,p)=>{if(d.excludeRelationships&&d.excludeRelationships.has(p))return e;if(d.includeRelationships&&!d.includeRelationships.has(p))return e;const h=this[p];return Array.isArray(h)?e[p]={data:h.map(e=>"function"==typeof e.serialize?e.serialize(!1,n,d):e)}:e[p]=h&&"function"==typeof h.serialize?h.serialize(!1,n,d):h,e},{})}constructor(e,n,d={}){_define_property$28(this,"type",void 0),_define_property$28(this,"id",void 0),_define_property$28(this,"_mjs",void 0),_define_property$28(this,"_meta",void 0),this.type=e,this.id=n,this._mjs={attributes:[],relationships:[],views:[]},this._meta={},this._mjs=_object_spread$14({},this._mjs,d)}}class DataStore extends Notifications{get mapping(){return this._mapping}set mapping(e){this._mapping=e}clear(){this._records={},this._expiryRecords=new Set}peek(e,n,d){if(this._checkForExpiredRecords(),!this._records[e])return n?null:[];if(!n)return Object.values(this._records[e]);if(Array.isArray(n))return n.map(n=>{const p=this._records[e][n];if(p&&p.hasProperties(d))return p});const p=this._records[e][n];return p&&p.hasProperties(d)?p:null}populateDataRecords(e,n={},d={}){if(!e.data)return[];if(!Array.isArray(e.data))return this.populateDataRecord(e.data,n,d);const p=[];return e.data.forEach((e,h)=>{const y=_object_spread_props$I(_object_spread$14({},d),{parents:d.parents?[_object_spread_props$I(_object_spread$14({},d.parents[0]),{position:h})]:[]});d.parents&&(d.parents[0].position=h);const _=this.populateDataRecord(e,n,y);p.push(_)}),p}populateDataRecord(e,n={},d){const p=d.filter||this.filter,h=d.mapping||this.mapping;if(p&&!p(e))return;if(h){let n="function"==typeof h?h(e):transform$b(h,e);Object.assign(e,n)}this._shouldDisableRecordReuse&&(n={});const y=this._materializeRecord(n,_object_spread$14({id:e.id,type:e.type},d));return e.meta&&(y._meta=e.meta),e.attributes&&e.attributes.cachingPolicy&&e.attributes.cachingPolicy.maxAge&&(y._mjs.expiration=Date.now()+1e3*e.attributes.cachingPolicy.maxAge,this._removeOnExpiration&&this._expiryRecords.add(y)),this._populateDataAttributes(e,y),"object"==typeof e.relationships&&Object.keys(e.relationships).forEach(p=>{let _=e.relationships[p];_&&"data"in _&&(_=this.populateDataRecords(_,n,{mapping:h,parents:[{relationshipName:p,parentType:y.type,parentId:y.id}]}),y.setProperty(p,_,"relationships",d))}),"object"==typeof e.views&&Object.keys(e.views).forEach(d=>{const p=e.views[d];if(p.attributes||p.data){const e=new DataRecord("view",d);if(this._populateDataAttributes(p,e),p.data){const d=this.populateDataRecords(p,n,h);e.setProperty("data",d,"relationships")}y.setProperty(d,e,"views")}}),y}query(e,n){this._checkForExpiredRecords();let includeRecord=e=>!1;return"string"==typeof e&&n?includeRecord=d=>(null==d?void 0:d[e])===n:"function"==typeof e?includeRecord=n=>{try{return e(n)}catch(St){return!1}}:"object"==typeof e&&(includeRecord=n=>{const d=Object.keys(e);let p=0;return d.forEach(d=>{(null==n?void 0:n[d])===e[d]&&p++}),d.length===p}),Object.values(this._records).reduce((e,n)=>(Object.values(n).forEach(n=>{includeRecord(n)&&e.push(n)}),e),[])}remove(e,n){setTimeout(this._checkForExpiredRecords.bind(this),0);if(!hasOwn(this._records,e))return;const d=this.peek(e,n);d&&(this.dispatchEvent("dataRecordWillDelete",[e,n]),d._mjs.parents&&d._mjs.parents.length>0&&d._mjs.parents.forEach(({relationshipName:e,parentType:n,parentId:p})=>{this.peek(n,p).removeRelative(e,d.id)}),delete this._records[e][n],this.dispatchEvent("dataRecordDidDelete",[e,n]))}save(e,n={}){return setTimeout(this._checkForExpiredRecords.bind(this),0),this.populateDataRecords(e,this._records,n)}_populateDataAttributes(e,n){"object"==typeof e.attributes&&(this.dispatchEvent("dataRecordWillPopulate",[n.type,n.id]),Object.keys(e.attributes).forEach(d=>{n.setProperty(d,e.attributes[d],"attributes")}),this.dispatchEvent("dataRecordDidPopulate",[n.type,n.id]))}_materializeRecord(e,n){const{type:d,id:p}=n,h=_object_without_properties$3(n,["type","id"]);return e[d]=e[d]||{},e[d][p]?e[d][p].setParent(h.parents||[]):e[d][p]=new DataRecord(d,p,h),this.dispatchEvent("dataRecordDidMaterialize",[d,p]),e[d][p]}_checkForExpiredRecords(){const e=[];this._expiryRecords.forEach(n=>{Date.now()>n._mjs.expiration&&(e.push([n.type,n.id]),this._expiryRecords.delete(n))}),e.forEach(e=>{this.remove(...e)})}constructor(e={}){super(["dataRecordDidDelete","dataRecordWillDelete","dataRecordDidMaterialize","dataRecordWillPopulate","dataRecordDidPopulate"]),_define_property$28(this,"_records",void 0),_define_property$28(this,"_expiryRecords",void 0),_define_property$28(this,"_mapping",void 0),_define_property$28(this,"_removeOnExpiration",!1),_define_property$28(this,"_shouldDisableRecordReuse",!0),_define_property$28(this,"filter",void 0),this._records={},this._expiryRecords=new Set,this._removeOnExpiration=!!e.removeOnExpiration,this._mapping=e.mapping,this._shouldDisableRecordReuse=!!e.shouldDisableRecordReuse,this.filter=e.filter}}function _define_property$27(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class DeveloperToken{get isExpired(){return this.expiration<Date.now()}_decode(e){return JSON.parse(E(e))}constructor(e){if(_define_property$27(this,"token",void 0),_define_property$27(this,"expiration",void 0),_define_property$27(this,"keyId",void 0),_define_property$27(this,"teamId",void 0),this.token=e,!e||!/^[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}\.[a-z0-9\-\_]{16,}/i.test(e))throw new Error("Invalid token.");const[n,d]=e.split("."),{exp:p,iss:h}=this._decode(d);if(this.expiration=1e3*p,this.isExpired)throw new Error("Initialized with an expired token.");this.teamId=h;const{kid:y}=this._decode(n);this.keyId=y}}function flattenAll(e){return function(e,n=1){if("function"==typeof Array.prototype.flat)return Array.prototype.flat.call(e,n);if(null==e)throw new TypeError("Cannot convert undefined or null to object");return Array.isArray(e)||(e=Array.from(e)),function flat(e,n){return n<=0?e.slice():Array.prototype.reduce.call(e,(function(e,d){return Array.isArray(d)?e.concat(flat(d,n-1)):[...e,d]}),[])}(e,n)}(e,1/0)}function invoke(e){return void 0===e||(e=>"function"!=typeof e)(e)?e:e()}function isObject$1(e){return!!e&&"object"==typeof e&&!Array.isArray(e)}function isFunction$2(e){return"function"==typeof e}function isString$1(e){return"string"==typeof e}function isEmptyString$1(e,n){return isString$1(e)?0===(!1!==(null==n?void 0:n.trim)?e.trim():e).length:!1===(null==n?void 0:n.strict)}function _define_property$26(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$13(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$26(e,n,d[n])}))}return e}function _object_spread_props$H(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const V=function(e){return"boolean"==typeof e}(G=isEmptyString$1)?!G:function(...e){return!G(...e)};var G;function formatPrimitive(e,n){const d=n.path.map((e,d)=>0===d?n.encode(e):`[${n.encode(e)}]`).join("");return null===e?d:`${d}=${n.encode(e)}`}const q={comma:function(e,n){return formatPrimitive(e.join(","),n)},repeat:function(e,n){return e.map(e=>formatPrimitive(String(e),n)).filter(e=>e.length>0).join("&")},bracket:function(e,n){return e.map((function(e){return n.next(e,_object_spread_props$H(_object_spread$13({},n),{path:[...n.path,""]}))})).filter(V).join("&")},index:function(e,n){return e.map((function(e,d){return n.next(e,_object_spread_props$H(_object_spread$13({},n),{path:[...n.path,String(d)]}))})).filter(V).join("&")}},H={bracket:function(e,n){return Object.keys(e).sort(n.sort).map((function(d){return n.next(e[d],_object_spread_props$H(_object_spread$13({},n),{path:n.path.concat(d)}))})).filter(V).join("&")}},DEFAULT_ENCODER=e=>encodeURIComponent(String(e)),STRING_ENCODER=e=>String(e);function encodeQueryParameters(e,n){if(!e)return"";let d="";if(!0===(null==n?void 0:n.prefix)?d="?":isString$1(null==n?void 0:n.prefix)&&(d=n.prefix),isString$1(e))return d+e.replace(/^[?&]+/,"");var p;const h=isFunction$2(null==n?void 0:n.arrayFormat)?n.arrayFormat:q[null!==(p=null==n?void 0:n.arrayFormat)&&void 0!==p?p:"comma"];var y;const _=isFunction$2(null==n?void 0:n.objectFormat)?n.objectFormat:H[null!==(y=null==n?void 0:n.objectFormat)&&void 0!==y?y:"bracket"];var m;const g=null!==(m=null==n?void 0:n.sort)&&void 0!==m?m:(...e)=>0;let b=DEFAULT_ENCODER;isFunction$2(null==n?void 0:n.encode)?b=n.encode:!1===(null==n?void 0:n.encode)&&(b=STRING_ENCODER);const P=_(e,{path:[],next:function(e,d){return function(e,n){return void 0===e&&!1!==(null==n?void 0:n.skipUndefined)||(null===e&&!1!==(null==n?void 0:n.skipNull)||!(!isEmptyString$1(e)||!1===(null==n?void 0:n.skipEmptyString)))}(e,n)?"":isObject$1(e)?_(e,d):Array.isArray(e)?h(e,d):formatPrimitive(e,d)},encode:b,sort:g});return""===P?"":d+P}function _define_property$25(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const DEFAULT_CACHE_KEY_FUNCTION=(e,n)=>`${n}${e}`;class NetworkCache{getItem(e){const n=this.cacheKeyForPath(e),d=this.storage.getItem(n);if(null!==d){const{x:e,d:p}=JSON.parse(d);if(e>Date.now())return p;this.storage.removeItem(n)}}setItem(e,n,d=this.ttl){const p=this.cacheKeyForPath(e);this.storage.setItem(p,JSON.stringify({x:Date.now()+d,d:n}))}removeItem(e){const n=this.cacheKeyForPath(e);this.storage.removeItem(n)}removeItemsMatching(e,n=!0){const d=this.cacheKeyForPath(e);this.removeItemsMatchingCacheKey(d,n)}clear(){this.removeItemsMatchingCacheKey(this.prefix,!1)}removeItemsMatchingCacheKey(e,n){const d=new RegExp(`^${e}${n?"$":""}`);(this.storage instanceof GenericStorage?this.storage.keys:Object.keys(this.storage)).forEach(e=>{e&&d.test(e)&&this.storage.removeItem(e)})}cacheKeyForPath(e){return this.cacheKeyFunction(e,this.prefix)}constructor(e={}){_define_property$25(this,"storage",void 0),_define_property$25(this,"prefix",void 0),_define_property$25(this,"ttl",void 0),_define_property$25(this,"cacheKeyFunction",void 0),this.storage=e.storage||new GenericStorage,this.prefix=e.prefix||"",this.ttl=e.ttl||3e5,this.cacheKeyFunction=e.cacheKeyFunction||DEFAULT_CACHE_KEY_FUNCTION}}function joinURLPath(...e){const n=flattenAll(e).map(e=>e instanceof URL?e.pathname:e).filter(e=>"string"==typeof e&&0!==e.trim().length);if(0===n.length)return"";let d=n[0];for(let p=1;p<n.length;p++)d=d.replace(/[/]+$/,"")+"/"+n[p].replace(/^[/]+/,"");return/^([a-z][a-z0-9\-_+]+)?:\/\//i.test(d)||(d="/"+d.replace(/^[/]+/,"")),d}function splitURLPath(e){e instanceof URL&&(e=e.pathname);const n=[],d=e.lastIndexOf("#");-1!==d&&(n.unshift(e.slice(d)),e=e.slice(0,d));const p=e.lastIndexOf("?");return-1!==p&&(n.unshift(e.slice(p)),e=e.slice(0,p)),[...e.split(RegExp("(?<![/:]+)\\/+")),...n].filter(e=>0!==e.trim().length)}function _define_property$24(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$12(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$24(e,n,d[n])}))}return e}function _object_spread_props$G(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const z="undefined"!=typeof Headers,headersToDict=e=>{let n={};var d;return d=e,z&&d instanceof Headers?e.forEach((e,d)=>n[d]=e):Array.isArray(e)?e.forEach(([e,d])=>n[e]=d):n=e,n},mergeFetchHeaders=(e={},n={})=>_object_spread$12({},headersToDict(e),headersToDict(n)),mergeFetchOptions=(e,n)=>{if(e||n)return(null==e?void 0:e.headers)&&(null==n?void 0:n.headers)?_object_spread_props$G(_object_spread$12({},e,n),{headers:mergeFetchHeaders(e.headers,n.headers)}):_object_spread$12({},e,n)};function parseQueryParams(e){if(!e||e.startsWith("http")&&!e.includes("?"))return{};try{var n;return parseParams(null!==(n=e.split("?")[1])&&void 0!==n?n:e,"&",decodeURIComponent)}catch(St){return{}}}function parseParams(e,n="&",d=(e=>e)){return"string"!=typeof e?{}:e.split(n).map(e=>e.trim().split("=",2)).reduce((e,n)=>{const[p,h]=n;return""===p&&void 0===h||(e[d(p)]=d(h),void 0===h&&(e[d(p)]=void 0)),e},{})}function getMaxAgeFromHeaders(e){const n=function(e,n){if(void 0!==n)return z&&n instanceof Headers?n.get(e):n[e]}("cache-control",e);if(n){return(e=>{const n=Number(e);if(Number.isFinite(n))return n})(parseParams(n,",")["max-age"])}}function buildURL(e,n,d){isObject$1(n)&&(d=n,n="");const p=joinURLPath([e,null!=n?n:""]);let h="?";p.endsWith("&")||p.endsWith("?")?h="":p.includes("?")&&(h="&");return p+(void 0!==d?encodeQueryParameters(d,{prefix:h}):"")}function asyncGeneratorStep$1t(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$23(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$11(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$23(e,n,d[n])}))}return e}class TokenSession extends class{clearCacheForRequest(e,n){"object"==typeof e&&(n=e,e=void 0),this.networkCache.removeItemsMatching(buildURL(this.url,null!=e?e:"",n))}request(e,n,d){var p,h=this;return(p=function*(){d||"object"!=typeof e||(d=n||{},n=e,e=void 0);let p={};"object"==typeof(d=_object_spread$11({method:h.method,headers:h.headers,reload:!1},h._fetchOptions,d)).queryParameters?(p=d.queryParameters,delete d.queryParameters):"GET"!==d.method&&"DELETE"!==d.method||(p=n);const y=buildURL(h.url,null!=e?e:"",p),{method:_,reload:m=!1,useRawResponse:g}=d;if(d.headers=h.buildHeaders(d),delete d.reload,delete d.useRawResponse,"GET"===_&&!m){const e=h.getCacheItem(y);if(e)return Promise.resolve(e)}n&&Object.keys(n).length&&("POST"===_||"PUT"===_)&&(d.body=d.body||n,"application/x-www-form-urlencoded"===d.contentType?(d.body=encodeQueryParameters(d.body),d.headers.set("Content-Type","application/x-www-form-urlencoded")):(d.body=JSON.stringify(d.body),d.headers.set("Content-Type","application/json")));const b=yield h._fetchFunction(y,d);if(!b.ok)return Promise.reject(b);let P;try{P=yield b.json()}catch(St){P={}}if(P.errors)return Promise.reject(P.errors);const S=g?P:P.results||P.data||P;if("GET"===_){var T;const e=null!==(T=getMaxAgeFromHeaders(b.headers))&&void 0!==T?T:h.ttl;h.setCacheItem(y,S,e)}return S},function(){var e=this,n=arguments;return new Promise((function(d,h){var y=p.apply(e,n);function _next(e){asyncGeneratorStep$1t(y,d,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1t(y,d,h,_next,_throw,"throw",e)}_next(void 0)}))})()}buildHeaders({headers:e,reload:n=!1}={}){void 0===e&&(e=this.headers);const d=(e=>new e.constructor(e))(e);return n&&d.set("Cache-Control","no-cache"),d}getCacheItem(e){const n=this.networkCache.storage,d=`${this.prefix}${this.prefix}cache-mut`,p=n.getItem(d)||null,h=this.headers.get("Music-User-Token")||this.headers.get("Media-User-Token")||null;return h!==p&&(this.networkCache.clear(),null===h?n.removeItem(d):n.setItem(d,h)),this.networkCache.getItem(e)}setCacheItem(e,n,d=this.ttl){this.networkCache.setItem(e,n,d)}clearNetworkCache(){this.networkCache.clear()}_key(e,n){const d=function(e){try{const[n,d]=e.split("?",2);if(void 0===d)return n;const p=d.split("&").map(e=>e.split("=",2)),h=[...Array(p.length).keys()];h.sort((e,n)=>{const d=p[e],h=p[n];return d<h?-1:d>h?1:e-n});const y=h.map(e=>p[e]);return`${n}?${y.map(([e,n])=>void 0!==n?`${e}=${n}`:e).join("&")}`}catch(St){return e}}(e).toLowerCase().replace(this.url,"");return`${this.prefix}${d.replace(/[^-_0-9a-z]{1,}/g,".")}`}constructor(e,n){if(_define_property$23(this,"url",void 0),_define_property$23(this,"headers",void 0),_define_property$23(this,"prefix",""),_define_property$23(this,"storage",void 0),_define_property$23(this,"networkCache",void 0),_define_property$23(this,"ttl",void 0),_define_property$23(this,"method","GET"),_define_property$23(this,"_fetchOptions",void 0),_define_property$23(this,"_fetchFunction",void 0),this.url=e,(n=n||{}).storage&&n.underlyingStorage)throw new Error("only pass storage OR underlyingStorage in sessionOptions to URLSession");const d=n.underlyingStorage||{};if(this.storage=n.storage||new GenericStorage(d),this.networkCache=new NetworkCache({storage:this.storage,prefix:this.prefix,cacheKeyFunction:this._key.bind(this)}),this.ttl=n.ttl||3e5,this._fetchOptions=_object_spread$11({},n.fetchOptions),"function"!=typeof n.fetch&&"function"!=typeof fetch)throw new Error("window.fetch is not defined");var p;this._fetchFunction=null!==(p=n.fetch)&&void 0!==p?p:fetch.bind(window),this.headers=this._fetchOptions.headers||new Headers,delete this._fetchOptions.headers}}{get developerToken(){return this._developerToken.token}constructor(e,n,d){super(e,d),_define_property$23(this,"userToken",void 0),_define_property$23(this,"_developerToken",void 0),this._developerToken=new DeveloperToken(n),this.headers.set("Authorization","Bearer "+this.developerToken),d=d||{},this.userToken=d.userToken,this.userToken&&this.headers.set("Media-User-Token",this.userToken)}}const Y=Date.now();function now(){var e,n;if("function"==typeof(null===(e=globalThis.process)||void 0===e?void 0:e.hrtime)){const[e,n]=process.hrtime();return Math.floor(1e3*e+1e-6*n)}return"function"==typeof(null===(n=globalThis.performance)||void 0===n?void 0:n.now)?globalThis.performance.now()-Y:Date.now()-Y}const formatByte=e=>("0"+(255&e).toString(16)).slice(-2),toHexString=(e,n=8)=>{if(!(e instanceof Uint8Array))return"";const d=Array.prototype.map.call(e,formatByte).join("");return 0===n?d:d.replace(new RegExp(`(.{1,${n}})`,"g"),"$1 ").trim()};function compareUint8Array(e,n){if(void 0===e&&void 0===n)return!0;if(typeof e!=typeof n)return!1;if(n=n,(e=e).byteLength!==n.byteLength)return!1;for(let d=0;d<e.byteLength;d++)if(e[d]!==n[d])return!1;return!0}function parseVersion(e){const n={version:e.toLowerCase()},d=e.toLowerCase().split(".").filter(e=>!!e);if(d.length<=1&&!/^\d+$/.test(d[0]))return n;const p=parseInt(d[0],10),h=parseInt(d[1],10),y=parseInt(d[2],10);return Number.isNaN(p)||(n.major=p,Number.isNaN(h)||(n.minor=h),Number.isNaN(y)||(n.patch=y)),n}function applyRules(e,n,d){const{userAgent:p}=null!=n?n:{};if("string"!=typeof p||""===p.trim())return d;for(const h of e){const e=h.slice(0,-1),y=h[h.length-1];let _=null;for(const h of e)if(_=p.match(h),null!==_){Object.assign(d,y(_,n,d));break}if(null!==_)break}return d}function _define_property$22(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$10(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$22(e,n,d[n])}))}return e}function _object_spread_props$F(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}var W,Q;const J={browser:[[/^(itunes|music|tv)\/([\w.]+)\s/i,e=>_object_spread_props$F(_object_spread$10({name:"webview",variant:e[1].trim().toLowerCase().replace(/(music|tv)/i,"$1.app")},parseVersion(e[2])),{mobile:!1})],[/(?:(?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w.]+);)/i,e=>_object_spread$10({name:"webview",variant:"facebook",mobile:!0},parseVersion(e[1]))],[/(instagram|snapchat)[/ ]([-\w.]+)/i,e=>_object_spread$10({name:"webview",variant:e[1].trim().toLowerCase(),mobile:!0},parseVersion(e[2]))],[/musical_ly(?:.+app_?version\/|_)([\w.]+)/i,e=>_object_spread$10({name:"webview",variant:"tiktok",mobile:!0},parseVersion(e[1]))],[/twitter/i,()=>({name:"webview",variant:"twitter",mobile:!0})],[/ wv\).+?(?:version|chrome)\/([\w.]+)/i,e=>_object_spread$10({name:"webview",mobile:!0},parseVersion(e[1]))],[/electron\/([\w.]+) safari/i,e=>_object_spread$10({name:"electron",mobile:!1},parseVersion(e[1]))],[/tesla\/(.*?(20\d\d\.([-\w.])+))/i,e=>_object_spread_props$F(_object_spread$10({name:"other",variant:"tesla",mobile:!1},parseVersion(e[2])),{version:e[1]})],[/(samsung|huawei)browser\/([-\w.]+)/i,e=>_object_spread$10({name:"other",variant:e[1].trim().toLowerCase().replace(/browser/i,""),mobile:!0},parseVersion(e[2]))],[/yabrowser\/([-\w.]+)/i,e=>_object_spread$10({name:"other",variant:"yandex",mobile:!1},parseVersion(e[1]))],[/(brave|flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w.]+)/i,(e,{userAgent:n})=>_object_spread$10({name:"other",variant:e[1].trim().toLowerCase(),mobile:/mobile/i.test(n)},parseVersion(e[2].replace(/-/g,".")))],[/edg(e|ios|a)?\/([\w.]+)/i,e=>_object_spread$10({name:"edge",mobile:/(edgios|edga)/i.test(null!==(W=e[1])&&void 0!==W?W:"")},parseVersion(e[2]))],[/trident.+rv[: ]([\w.]{1,9})\b.+like gecko/i,e=>_object_spread$10({name:"ie",mobile:!1},parseVersion(e[1]))],[/opr\/([\w.]+)/i,/opera mini\/([-\w.]+)/i,/opera [mobiletab]{3,6}\b.+version\/([-\w.]+)/i,/opera(?:.+version\/|[/ ]+)([\w.]+)/i,e=>_object_spread$10({name:"opera",mobile:/mobile/i.test(e[0])},parseVersion(e[1]))],[/headlesschrome(?:\/([\w.]+)| )/i,e=>_object_spread$10({name:"chrome",variant:"headless",mobile:!1},parseVersion(e[1]))],[/\b(?:crmo|crios)\/([\w.]+)/i,e=>_object_spread$10({name:"chrome",mobile:!0},parseVersion(e[1]))],[/chrome(?: browser)?\/v?([\w.]+)( mobile)?/i,e=>_object_spread$10({name:"chrome",mobile:/mobile/i.test(null!==(Q=e[2])&&void 0!==Q?Q:"")},parseVersion(e[1]))],[/\bfocus\/([\w.]+)/i,e=>_object_spread$10({name:"firefox",variant:"focus",mobile:!0},parseVersion(e[1]))],[/fxios\/([\w.-]+)/i,/(?:mobile|tablet);.*(?:firefox)\/([\w.-]+)/i,e=>_object_spread$10({name:"firefox",mobile:!0},parseVersion(e[1]))],[/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[/ ]?([\w.+]+)/i,e=>_object_spread$10({name:"firefox",variant:e[1].trim().toLowerCase(),mobile:!1},parseVersion(e[2]))],[/(?:firefox)\/([\w.]+)/i,/(?:mozilla)\/([\w.]+) .+rv:.+gecko\/\d+/i,e=>_object_spread$10({name:"firefox",mobile:!1},parseVersion(e[1]))],[/version\/([\w.,]+) .*mobile(?:\/\w+ | ?)safari/i,/version\/([\w.,]+) .*(safari)/i,/webkit.+?(?:mobile ?safari|safari)(?:\/([\w.]+))/i,e=>_object_spread$10({name:"safari",mobile:/mobile/i.test(e[0])},parseVersion(e[1]))]],engine:[[/webkit\/(?:537\.36).+chrome\/(?!27)([\w.]+)/i,e=>_object_spread$10({name:"blink"},parseVersion(e[1]))],[/windows.+ edge\/([\w.]+)/i,e=>_object_spread$10({name:"blink"},parseVersion(e[1]))],[/presto\/([\w.]+)/i,e=>_object_spread$10({name:"presto"},parseVersion(e[2]))],[/trident\/([\w.]+)/i,e=>_object_spread$10({name:"trident"},parseVersion(e[1]))],[/gecko\/([\w.]+)/i,e=>_object_spread$10({name:"gecko"},parseVersion(e[1]))],[/(khtml|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w.]+)/i,e=>_object_spread$10({name:"other"},parseVersion(e[2]))],[/webkit\/([\w.]+)/i,e=>_object_spread$10({name:"webkit"},parseVersion(e[1]))]],os:[[/microsoft windows (vista|xp)/i,/windows nt 6\.2; (arm)/i,/windows (?:phone(?: os)?|mobile)[/ ]?([\d.\w ]*)/i,/windows[/ ]?([ntce\d. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d.]+)/i,e=>_object_spread$10({name:"windows"},parseVersion(e[1]))],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[/ ])([\d.]+)/i,e=>_object_spread$10({name:"ios"},parseVersion(e[1].replace(/_/g,".")))],[/mac(?:intosh;?)? os x ?([\d._]+)/i,e=>_object_spread$10({name:"macos"},parseVersion(e[1].replace(/_/g,".")))],[/cros [\w]+(?:\)| ([\w.]+)\b)/i,e=>_object_spread$10({name:"chromeos"},parseVersion(e[1]))],[/(?:android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-/ ]?([\w.]*)/i,/droid ([\w.]+|[\d+])\b.+(android[- ]x86|harmonyos)/i,e=>_object_spread$10({name:"android"},parseVersion(e[1]))],[/linux/i,()=>({name:"linux"})]]};function parseUserAgent(e,n){var d,p,h;var y;return function(e,n){let d=e;for(const p of n)d=p(d);return d}({navigator:e,ua:null!==(h=null===(d=e)||void 0===d?void 0:d.userAgent)&&void 0!==h?h:"",extensions:[],browser:applyRules(J.browser,e,{name:"unknown",mobile:!1}),engine:applyRules(J.engine,e,{name:"unknown"}),os:applyRules(J.os,e,{name:"unknown"})},null!==(y=null===(p=n)||void 0===p?void 0:p.extensions)&&void 0!==y?y:[])}function _define_property$21(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$$(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$21(e,n,d[n])}))}return e}function _object_spread_props$E(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function flagsExtension(e){let n=e.os.name;const d="android"===e.os.name;let p="macos"===e.os.name,h="ios"===e.os.name;var y;const _="ipados"===n||h&&/ipad/i.test(e.ua)||p&&(null!==(y=e.navigator.maxTouchPoints)&&void 0!==y?y:0)>=2;_&&(n="ipados",h=!1,p=!1);const m=_object_spread_props$E(_object_spread$$({},e.browser),{isUnknown:"unknown"===e.browser.name,isSafari:"safari"===e.browser.name,isChrome:"chrome"===e.browser.name,isFirefox:"firefox"===e.browser.name,isEdge:"edge"===e.browser.name,isWebView:"webview"===e.browser.name,isOther:"other"===e.browser.name,isMobile:e.browser.mobile||h||_||d||!1}),g=_object_spread_props$E(_object_spread$$({},e.engine),{isUnknown:"unknown"===e.engine.name,isWebKit:"webkit"===e.engine.name,isBlink:"blink"===e.engine.name,isGecko:"gecko"===e.engine.name}),b=_object_spread_props$E(_object_spread$$({},e.os),{name:n,isUnknown:"unknown"===e.os.name,isLinux:"linux"===e.os.name,isWindows:"windows"===e.os.name,isMacOS:p,isAndroid:d,isIOS:h,isIPadOS:_});return _object_spread_props$E(_object_spread$$({},e),{extensions:[...e.extensions,"flags"],browser:m,os:b,engine:g})}let X;function getGlobal(){if(void 0===X){function exists(e){return e&&e.Math===Math&&e}X=exists("object"==typeof globalThis&&globalThis)||exists("object"==typeof window&&window)||function(){return this}()||Function("return this")()}return X}function asyncGeneratorStep$1s(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1s(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1s(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1s(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function isBrowserEnvironment(){return _isBrowserEnvironment.apply(this,arguments)}function _isBrowserEnvironment(){return(_isBrowserEnvironment=_async_to_generator$1s((function*(){return void 0!==getGlobal().navigator}))).apply(this,arguments)}function asyncGeneratorStep$1r(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1r(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1r(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1r(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function isNodeEnvironment(){return _isNodeEnvironment.apply(this,arguments)}function _isNodeEnvironment(){return(_isNodeEnvironment=_async_to_generator$1r((function*(){var e,n;return void 0!==(null===(n=getGlobal().process)||void 0===n||null===(e=n.versions)||void 0===e?void 0:e.node)}))).apply(this,arguments)}function asyncGeneratorStep$1q(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1q(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1q(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1q(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$20(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$_(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$20(e,n,d[n])}))}return e}const Z={playready:"com.microsoft.playready",widevine:"com.widevine.alpha",clearkey:"org.w3.clearkey",fairplay:"com.apple.fps"},ee="com.apple.fps.1_0",te="com.microsoft.playready";function detectEMESupport(){return _detectEMESupport.apply(this,arguments)}function _detectEMESupport(){return(_detectEMESupport=_async_to_generator$1q((function*(){var e;const n=getGlobal();return void 0!==(null===(e=n.navigator)||void 0===e?void 0:e.requestMediaKeySystemAccess)&&void 0!==n.MediaKeys&&void 0!==n.MediaKeySystemAccess}))).apply(this,arguments)}function detectLegacyKeySystems(e){return _detectLegacyKeySystems.apply(this,arguments)}function _detectLegacyKeySystems(){return(_detectLegacyKeySystems=_async_to_generator$1q((function*(e){var n,d,p,h;const y=null!==(h=null===(n=e)||void 0===n?void 0:n.contentType)&&void 0!==h?h:'video/mp4; codecs="avc1.42E01E"',_=[],m=getGlobal();return"function"==typeof(null===(d=m.WebKitMediaKeys)||void 0===d?void 0:d.isTypeSupported)&&!0===m.WebKitMediaKeys.isTypeSupported(ee,y)&&_.push("fairplay_legacy"),"function"==typeof(null===(p=m.MSMediaKeys)||void 0===p?void 0:p.isTypeSupported)&&!0===m.MSMediaKeys.isTypeSupported(te,y)&&_.push("playready_legacy"),_}))).apply(this,arguments)}function supportsEMEConfiguration(e,n){return _supportsEMEConfiguration.apply(this,arguments)}function _supportsEMEConfiguration(){return(_supportsEMEConfiguration=_async_to_generator$1q((function*(e,n){const d=_object_spread$_({initDataTypes:["keyids","cenc"]},n);if(void 0===d.audioCapabilities&&void 0===d.videoCapabilities)throw new Error("Configuration should at least include a audioCapabilities or videoCapabilities key");const p=-1!==e.indexOf(".")?e:Z[e];if(void 0===p)return!1;var h,y;const _=[...null!==(h=d.audioCapabilities)&&void 0!==h?h:[],...null!==(y=d.videoCapabilities)&&void 0!==y?y:[]].map(({contentType:e})=>e);try{const e=(yield navigator.requestMediaKeySystemAccess(p,[d])).getConfiguration();var m,g;const n=[...null!==(m=e.audioCapabilities)&&void 0!==m?m:[],...null!==(g=e.videoCapabilities)&&void 0!==g?g:[]].map(({contentType:e})=>e);return _.every(e=>n.includes(e))}catch(he){if("NotSupportedError"===he.name||"SecurityError"===he.name)return!1;throw he}}))).apply(this,arguments)}function detectEMEKeySystems(e){return _detectEMEKeySystems.apply(this,arguments)}function _detectEMEKeySystems(){return(_detectEMEKeySystems=_async_to_generator$1q((function*(e){var n,d;const p=[];if((yield isNodeEnvironment())||!(yield detectEMESupport()))return p;function buildCapability(e){return"string"==typeof e?{contentType:e}:e}const h=void 0!==(null===(n=e)||void 0===n?void 0:n.videoCapability)?[buildCapability(e.videoCapability)]:[buildCapability('video/mp4; codecs="avc1.42E01E"')],y=void 0!==(null===(d=e)||void 0===d?void 0:d.audioCapability)?[buildCapability(e.audioCapability)]:[];for(const[_,m]of Object.entries(Z))(yield supportsEMEConfiguration(m,{videoCapabilities:h,audioCapabilities:y}))&&p.push(_);return p}))).apply(this,arguments)}function asyncGeneratorStep$1p(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1p(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1p(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1p(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function detectMMSSupport(){return _detectMMSSupport.apply(this,arguments)}function _detectMMSSupport(){return(_detectMMSSupport=_async_to_generator$1p((function*(){var e,n,d,p;const h=getGlobal(),y=void 0!==h.ManagedMediaSource,_="function"==typeof(null===(n=h.ManagedSourceBuffer)||void 0===n||null===(e=n.prototype)||void 0===e?void 0:e.appendBuffer)&&"function"==typeof(null===(p=h.ManagedSourceBuffer)||void 0===p||null===(d=p.prototype)||void 0===d?void 0:d.remove);return y&&_}))).apply(this,arguments)}function asyncGeneratorStep$1o(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1o(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1o(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1o(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function detectMSESupport(){return _detectMSESupport.apply(this,arguments)}function _detectMSESupport(){return(_detectMSESupport=_async_to_generator$1o((function*(){return void 0!==getGlobal().MediaSource&&void 0!==getGlobal().SourceBuffer}))).apply(this,arguments)}function asyncGeneratorStep$1n(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1n(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1n(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1n(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function detectPictureInPictureSupport(){return _detectPictureInPictureSupport.apply(this,arguments)}function _detectPictureInPictureSupport(){return(_detectPictureInPictureSupport=_async_to_generator$1n((function*(){var e,n,d;if(yield isNodeEnvironment())return!1;const p=document.createElement("video");return void 0!==(null===(e=p)||void 0===e?void 0:e.webkitSupportsPresentationMode)&&"function"==typeof(null===(n=p)||void 0===n?void 0:n.webkitSetPresentationMode)||void 0!==(null===(d=document)||void 0===d?void 0:d.pictureInPictureEnabled)}))).apply(this,arguments)}function asyncGeneratorStep$1m(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1m(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1m(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1m(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1$(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _detect(){return(_detect=_async_to_generator$1m((function*(){var e;const n=null===(e=globalThis)||void 0===e?void 0:e.window;var d;const p=null!==(d=null==n?void 0:n.navigator)&&void 0!==d?d:{userAgent:"",maxTouchPoints:0},h=yield isBrowserEnvironment(),y=yield isNodeEnvironment(),_=yield detectEMEKeySystems(),m=yield detectLegacyKeySystems();let g=void 0;return _.includes("fairplay")&&(g="fairplay"),_.includes("playready")&&(g="playready"),_.includes("widevine")&&(g="widevine"),{userAgent:yield parseUserAgent(p,{extensions:[flagsExtension]}),isBrowserEnvironment:h,isNodeEnvironment:y,isPictureInPictureSupported:yield detectPictureInPictureSupport(),isMMSSupported:yield detectMMSSupport(),isMSESupported:yield detectMSESupport(),isEMESupported:yield detectEMESupport(),isDRMAvailable:void 0!==g,availableKeySystems:_,preferredKeySystem:g,hasWebKitMediaKeysSupport:m.includes("fairplay_legacy"),hasMSMediaKeysSupport:m.includes("playready_legacy")}}))).apply(this,arguments)}class RuntimeEnvironment{get isConfigured(){return this.configured}get userAgent(){return this.config.userAgent}get ua(){return this.userAgent.ua}get isNodeEnvironment(){return this.config.isNodeEnvironment}get isBrowserEnvironment(){return this.config.isBrowserEnvironment}get isPictureInPictureSupported(){return this.config.isPictureInPictureSupported}get isMMSSupported(){return this.config.isMMSSupported}get isMSESupported(){return this.config.isMSESupported}get isEMESupported(){return this.config.isEMESupported}get isDRMAvailable(){return this.config.isDRMAvailable}get availableKeySystems(){return this.config.availableKeySystems}get preferredKeySystem(){return this.config.preferredKeySystem}get hasWebKitMediaKeysSupport(){return this.config.hasWebKitMediaKeysSupport}get hasMSMediaKeysSupport(){return this.config.hasMSMediaKeysSupport}get browser(){return this.userAgent.browser}get engine(){return this.userAgent.engine}get os(){return this.userAgent.os}get isMobile(){return this.browser.isMobile}static detect(){var e=this;return _async_to_generator$1m((function*(){return new e(yield function(){return _detect.apply(this,arguments)}())}))()}configure(e){for(const[n,d]of Object.entries(e))this.config[n]=d;this.configured=!0}constructor(e){_define_property$1$(this,"configured",!1),_define_property$1$(this,"config",void 0),this.config=e,this.configured=!0}}function _define_property$1_(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function omit(e,n){const d=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1_(e,n,d[n])}))}return e}({},e);for(const p of Object.keys(e))n.includes(p)&&delete d[p];return d}class PubSub{publish(e,n){const d=this.getSubscribersForType(e);void 0!==d&&d.forEach(d=>{d(e,n)})}subscribe(e,n){this.getSubscribersForType(e,!0).push(n)}subscribeOnce(e,n){const onceCallback=(e,d)=>{this.unsubscribe(e,onceCallback),n(e,d)};this.subscribe(e,onceCallback)}unsubscribe(e,n){const d=this.getSubscribersForType(e);if(void 0!==d)for(let p=0;p<d.length;p++)if(d[p]===n){d.splice(p,1);break}}clear(e){void 0===e?this.events={}:delete this.events[e]}getSubscribersForType(e,n=!1){return void 0===this.events[e]&&n&&(this.events[e]=[]),this.events[e]}constructor(){!function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"events",Object.create(null))}}function asyncGeneratorStep$1l(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1l(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1l(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1l(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1Y(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class RequestManager{static create(e){var n=this;return _async_to_generator$1l((function*(){return new n(e)}))()}get fetch(){if(void 0===this.fetchFunction)throw new MKError(MKError.Reason.INTERNAL_ERROR,"Could not find fetch implementation");return this.fetchFunction}get isConfigured(){return this.configured}configure(e){void 0!==(null==e?void 0:e.fetchFunction)&&(this.fetchFunction=e.fetchFunction),this.configured=!0}buildURL(e,n,d){return new URL(buildURL(e,n,d))}buildHeaders(...e){return flattenAll(e).reduce((function(e,n){let d;return d=n instanceof Headers||n instanceof Map?Array.from(n.entries()):Object.entries(n),d.map(([n,d])=>{void 0===d?e.delete(n):e.set(n,d)}),e}),new Headers)}buildRequest(e,n){return new Request(new URL(e),n)}fetchText(e){var n=this;return _async_to_generator$1l((function*(){let d;try{d=yield n.fetch(e)}catch(he){const d=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+d)}try{return yield d.text()}catch(he){const d=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as text for "+d)}}))()}fetchJSON(e){var n=this;return _async_to_generator$1l((function*(){let d;try{d=yield n.fetch(e)}catch(he){const d=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+d)}try{return yield d.json()}catch(he){const d=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as JSON for "+d)}}))()}fetchArrayBuffer(e){var n=this;return _async_to_generator$1l((function*(){let d;try{d=yield n.fetch(e)}catch(he){const d=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.NETWORK_ERROR,"Unable to complete request for "+d)}try{return yield d.arrayBuffer()}catch(he){const d=e instanceof Request?e.url:String(e);throw new MKError(MKError.Reason.REQUEST_ERROR,"Unable to read body as ArrayBuffer for "+d)}}))()}constructor(e){var n;_define_property$1Y(this,"configured",!1),_define_property$1Y(this,"fetchFunction",void 0!==(null===(n=globalThis)||void 0===n?void 0:n.fetch)?fetch.bind(globalThis):void 0),this.configure(null!=e?e:{})}}const re=new Map;function singularizeMediaType(e){if(re.has(e))return re.get(e);let n=dasherize$1(e);return n.endsWith("s")&&(n=n.slice(0,-1)),re.set(e,n),n}const ne=new Logger$1("media-item");function mediaItemLogString(e){let n=e.id;var d;const p=null!==(d=e.attributes)&&void 0!==d?d:{};let h="";const y=p.name||p.title;return isEmptyString$1(y)||(h+=y),isEmptyString$1(p.albumName)||(h+=" - "+p.albumName),isEmptyString$1(p.artistName)||(h+=" - "+p.artistName),""!==h&&(n+=` (${h})`),n}var ie=function(e){return e[e.none=0]="none",e[e.preview=1]="preview",e[e.unencryptedFull=2]="unencryptedFull",e[e.encryptedFull=3]="encryptedFull",e}({}),oe=function(e){return e[e.none=0]="none",e[e.loading=1]="loading",e[e.ready=2]="ready",e[e.playing=3]="playing",e[e.ended=4]="ended",e[e.unavailable=5]="unavailable",e[e.restricted=6]="restricted",e[e.error=7]="error",e[e.unsupported=8]="unsupported",e}({});const{none:ae,loading:se,ready:ce,playing:le,ended:ue,unavailable:de,restricted:pe,error:he,unsupported:ye}=oe,fe={[ae]:{allowed:[se],unknown:[ue,de,pe,he,ye]},[se]:{allowed:[ce,pe,he,ye],unknown:[]},[ce]:{allowed:[le],unknown:[he]},[le]:{allowed:[ue,he],unknown:[de,pe,ye]},[ue]:{allowed:[],unknown:[]},[de]:{allowed:[],unknown:[]},[pe]:{allowed:[],unknown:[]},[he]:{allowed:[],unknown:[]},[ye]:{allowed:[],unknown:[]}},toName=e=>oe[e],createMediaItemStateGuard=(e=ae)=>{const n={current:e,set:function(e){const{current:d}=n;if(!((e,n)=>fe[e].allowed.includes(n))(d,e)){const n=((e,n)=>fe[e].unknown.includes(n))(d,e);ne.debug(`MediaItem.state was changed from ${toName(d)} to ${toName(e)}`,n?"but it is unknown whether it should be allowed or not.":"and it should not be happening")}n.current=e}};return n};function transform$a(e){return transform$b({"attributes.albumName":"metadata.playlistName","attributes.artistName":"metadata.artistName","attributes.artwork":function(){const n=null==e?void 0:e.artworkURL;if(n)return function(e){const n=e.split("/").pop(),[d,p]=!!n&&n.match(/\d+/g)||["100","100"];return{width:parseInt(d,10),height:parseInt(p,10),url:e.replace(`${d}x${p}`,"{w}x{h}")}}(n)},"attributes.composerName":"metadata.composerName","attributes.contentRating":function(){var n;if(1===(null==e||null===(n=e.metadata)||void 0===n?void 0:n.explicit))return"explicit"},"attributes.discNumber":function(){var n;return(null==e||null===(n=e.metadata)||void 0===n?void 0:n.discNumber)||1},"attributes.durationInMillis":"metadata.duration","attributes.genreNames":function(){var n;return[null==e||null===(n=e.metadata)||void 0===n?void 0:n.genre]},"attributes.isrc":function(){var n;const d=null==e||null===(n=e.metadata)||void 0===n?void 0:n.xid;if(d)return d.replace(/^([^:]+):isrc:/,"$1")},"attributes.name":"metadata.itemName","attributes.playParams.id":"metadata.itemId","attributes.playParams.kind":"metadata.kind","attributes.previews":function(){return[{url:null==e?void 0:e.previewURL}]},"attributes.releaseDate":"metadata.releaseDate","attributes.trackNumber":"metadata.trackNumber",assetURL:"URL",cloudId:"metadata.cloud-id",id:function(){var n;return""+(null==e||null===(n=e.metadata)||void 0===n?void 0:n.itemId)},flavor:"flavor",type:"metadata.kind"},e)}function _define_property$1X(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const{mediaItemStateDidChange:_e,mediaItemStateWillChange:ve}=I,me=BooleanDevFlag.register("mk-music-movie-playback");class MediaItem extends Notifications{get ageGatePolicy(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.ageGatePolicy}get albumInfo(){const{albumName:e,artistName:n}=this,d=[];return n&&d.push(n),e&&d.push(e),d.join(" - ")}get albumName(){return this.attributes.albumName}get artistName(){return this.attributes.genreNames&&this.attributes.genreNames.indexOf("Classical")>-1&&this.attributes.composerName?this.attributes.composerName:this.attributes.artistName}get artwork(){var e,n;return null!==(n=this.attributes.artwork)&&void 0!==n?n:null===(e=this.attributes.images)||void 0===e?void 0:e.coverArt16X9}get artworkURL(){if(this.artwork&&this.artwork.url)return this.artwork.url}get canPlay(){return this.isPlayable&&this.isReady}get container(){return this._container}set container(e){this._container=e}get contentRating(){return this.attributes.contentRating}get context(){return this._context}set context(e){this._context=e}get defaultPlayable(){var e;return null===(e=this.playables)||void 0===e?void 0:e[0]}get discNumber(){return this.attributes.discNumber}get hasContainerArtwork(){return this.container&&this.container.attributes&&this.container.attributes.artwork&&this.container.attributes.artwork.url}get hasPlaylistContainer(){return this.container&&"playlists"===this.container.type&&this.container.attributes}get supportsLinearScrubbing(){var e,n,d;return this.isLinearStream&&!0===(null===(d=this.defaultPlayable)||void 0===d||null===(n=d.assets)||void 0===n||null===(e=n.streamCapability)||void 0===e?void 0:e.supportsLinearScrubbing)}get isAssetScrubbingDisabled(){return!!this.isLinearStream&&!this.supportsLinearScrubbing}get isLinearStream(){return"LiveService"===(null==(e=this)?void 0:e.type)||"Event"===(null==e||null===(n=e.defaultPlayable)||void 0===n?void 0:n.type)||"EbsEvent"===(null==e||null===(d=e.defaultPlayable)||void 0===d?void 0:d.type);var e,n,d}get isAlgoStation(){return isAlgoStation(this)}get isRadioStation(){return isRadioStation(this)}get isRadioEpisode(){return isRadioEpisode(this)}get isLiveRadioStation(){return isLiveRadioStation(this)}get isLiveAudioStation(){return isLiveRadioStation(this,"audio")}get isLiveVideoStation(){return isLiveRadioStation(this,"video")}get isAOD(){return isRadioEpisode(e=this,n)||!!(null==e||null===(d=e.attributes)||void 0===d?void 0:d.isAOD);var e,n,d}get isSong(){return"song"===itemType(this)}get isPodcastEpisode(){return isPodcastEpisode(this)}get info(){return`${this.title} - ${this.albumInfo}`}get isCloudItem(){return this.isLibraryItem}get isLibraryItem(){var e,n;return!0===(null===(e=this.playParams)||void 0===e?void 0:e.isLibrary)||isLibraryType(null===(n=this.playParams)||void 0===n?void 0:n.id)||isLibraryType(this.id)}get isCloudUpload(){return"-1"===String(this._songId)}get isExplicitItem(){return"explicit"===this.contentRating}get isLoading(){return this.state===oe.loading}get isPlayableMediaType(){return!("musicMovie"!==this.type||!me.enabled)||(this.isUTS||-1!==O.indexOf(this.type))}get isPlayable(){var e;return!!this.isUTS||!!this.isPlayableMediaType&&(!!(this.isLiveRadioStation||this.isRadioEpisode||this.hasOffersHlsUrl)||(this.needsPlayParams?!!this.playParams:!!this.rawAssetUrl||!!(null===(e=this.attributes.previews)||void 0===e?void 0:e.length)))}get isPlaying(){return this.state===oe.playing}get isPreparedToPlay(){const e=isString$1(this.assetURL)&&!isEmptyString$1(this.assetURL),n=!(!this.keyURLs||isEmptyString$1(this.keyURLs["hls-key-cert-url"])||isEmptyString$1(this.keyURLs["hls-key-server-url"])||isEmptyString$1(this.keyURLs["widevine-cert-url"]));if("song"===this.type){var d;const e=isString$1(this.songId)&&!isEmptyString$1(this.songId)&&"-1"!==this.songId;var p;const h=(null!==(p=null===(d=this.assets)||void 0===d?void 0:d.length)&&void 0!==p?p:0)>0;return e&&h&&n}return this.isUTS?e&&n||this.playRawAssetURL:e||this.playRawAssetURL}get isrc(){return this.attributes.isrc}get isReady(){return this.state===oe.ready}get isRestricted(){return this.state===oe.restricted}get isUTS(){return!!this.defaultPlayable}get isUnavailable(){return this.state===oe.unavailable}get needsPlayParams(){return["musicMovie","musicVideo","song"].includes(this.type)}get normalizedType(){return normalizeMediaType(this.type)}get offers(){return this.attributes.offers}get offersHlsUrl(){const{offers:e}=this,n=null==e?void 0:e.find(e=>{var n;return!!(null===(n=e.hlsUrl)||void 0===n?void 0:n.length)});return null==n?void 0:n.hlsUrl}get hasOffersHlsUrl(){return isString$1(this.offersHlsUrl)&&!isEmptyString$1(this.offersHlsUrl)}get rawAssetUrl(){return this.attributes.assetUrl}set playbackData(e){if(void 0===e)return;this.previewURL&&(e.previewURL=this.previewURL);const n=transform$a(e);this.artwork&&n.artwork&&delete n.artwork,n.id!==this.id&&delete n.id,this.playParams&&n.attributes.playParams&&(n.attributes.playParams=this.playParams),n.attributes=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1X(e,n,d[n])}))}return e}({},this.attributes,n.attributes),Object.assign(this,n),ne.debug("media-item: item merged with playbackData",this),this.state=oe.ready}get playbackDuration(){return this.attributes.durationInMillis||this.attributes.durationInMilliseconds}get playEvent(){var e;return null===(e=this.defaultPlayable)||void 0===e?void 0:e.playEvent}get playlistArtworkURL(){var e,n,d;return this.hasPlaylistContainer&&this.hasContainerArtwork?null===(d=this.container)||void 0===d||null===(n=d.attributes)||void 0===n||null===(e=n.artwork)||void 0===e?void 0:e.url:this.artworkURL}get playlistName(){var e,n;return this.hasPlaylistContainer?null===(n=this.container)||void 0===n||null===(e=n.attributes)||void 0===e?void 0:e.name:this.albumName}get playParams(){return this.attributes.playParams}get playRawAssetURL(){return this.isCloudUpload||!!this.rawAssetUrl}get previewURL(){var e,n,d,p,h,y,_,m,g,b,P,S,T,k,E;return(null===(d=this.attributes)||void 0===d||null===(n=d.previews)||void 0===n||null===(e=n[0])||void 0===e?void 0:e.url)||(null===(y=this.attributes)||void 0===y||null===(h=y.previews)||void 0===h||null===(p=h[0])||void 0===p?void 0:p.hlsUrl)||(null===(b=this.attributes)||void 0===b||null===(g=b.trailers)||void 0===g||null===(m=g[0])||void 0===m||null===(_=m.assets)||void 0===_?void 0:_.hlsUrl)||(null===(T=this.attributes)||void 0===T||null===(S=T.movieClips)||void 0===S||null===(P=S[0])||void 0===P?void 0:P.hlsUrl)||(null===(E=this.attributes)||void 0===E||null===(k=E.video)||void 0===k?void 0:k.hlsUrl)}get rating(){return this.attributes.rating}get releaseDate(){if(this._releaseDate)return this._releaseDate;if(this.attributes&&(this.attributes.releaseDate||this.attributes.releaseDateTime)){const e=this.attributes.releaseDate||this.attributes.releaseDateTime;return this._releaseDate=/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0,this._releaseDate}}set releaseDate(e){this._releaseDate="string"==typeof e?/^\d{4}-\d{1,2}-\d{1,2}/.test(e)?new Date(e):void 0:"number"==typeof e?new Date(e):e}get songId(){return void 0!==this._songId&&"-1"!==String(this._songId)?this._songId:this.id}set songId(e){this._songId=void 0!==e?String(e):void 0}get state(){return this._state.current}set state(e){const n={oldState:this._state.current,state:e};this._stateWillChange&&this._stateWillChange(this),this.dispatchEvent(ve,n),this._state.set(e),this._stateDidChange&&this._stateDidChange(this),this.dispatchEvent(_e,n)}get title(){return this.attributes.name||this.attributes.title}get trackNumber(){return this.attributes.trackNumber}beginMonitoringStateDidChange(e){this._stateDidChange=e}beginMonitoringStateWillChange(e){this._stateWillChange=e}endMonitoringStateDidChange(){this._stateDidChange=void 0}endMonitoringStateWillChange(){this._stateWillChange=void 0}isEqual(e){return this.id===e.id&&this.type===e.type&&this.attributes===e.attributes}resetState(){this.endMonitoringStateWillChange(),this.endMonitoringStateDidChange(),this.state=oe.none}restrict(){this.isExplicitItem&&(this.state=oe.restricted,this._removePlayableData())}notSupported(){this.state=oe.unsupported,this._removePlayableData()}updateFromLoadError(e){switch(e.reason){case MKError.Reason.CONTENT_RESTRICTED:this.state=oe.restricted;break;case MKError.Reason.CONTENT_UNAVAILABLE:this.state=oe.unavailable;break;default:this.state=oe.error}}_removePlayableData(){var e,n,d;null===(e=this.attributes)||void 0===e||delete e.playParams,null===(n=this.attributes)||void 0===n||delete n.previews,null===(d=this.attributes)||void 0===d||delete d.trailers}toString(){var e;const{name:n,title:d,artistName:p}=null!==(e=this.attributes)&&void 0!==e?e:{};var h;return`<MediaItem id="${this.id}" title="${null!==(h=null!=n?n:d)&&void 0!==h?h:"-"}" artist="${null!=p?p:"-"}" />`}constructor(e={}){super([_e,ve]),_define_property$1X(this,"id",void 0),_define_property$1X(this,"type",void 0),_define_property$1X(this,"contentType",void 0),_define_property$1X(this,"cloudId",void 0),_define_property$1X(this,"playables",void 0),_define_property$1X(this,"channels",void 0),_define_property$1X(this,"assetURL",void 0),_define_property$1X(this,"hlsMetadata",{}),_define_property$1X(this,"flavor",void 0),_define_property$1X(this,"currentKeyPlay",void 0),_define_property$1X(this,"keyPlayShelf",void 0),_define_property$1X(this,"keyServerQueryParameters",void 0),_define_property$1X(this,"podpafMetrics",void 0),_define_property$1X(this,"attributes",{}),_define_property$1X(this,"playbackType",ie.none),_define_property$1X(this,"href",void 0),_define_property$1X(this,"relationships",void 0),_define_property$1X(this,"_container",void 0),_define_property$1X(this,"_context",void 0),_define_property$1X(this,"_releaseDate",void 0),_define_property$1X(this,"_state",createMediaItemStateGuard()),_define_property$1X(this,"_stateDidChange",void 0),_define_property$1X(this,"_stateWillChange",void 0),_define_property$1X(this,"_songId",void 0),_define_property$1X(this,"assets",[]),_define_property$1X(this,"keyURLs",void 0),ne.debug("media-item: creating Media Item with options:",e);var n;e.id&&e.attributes?(Object.assign(this,e),this.type=(null===(n=this.playParams)||void 0===n?void 0:n.kind)?this.playParams.kind:this.type||"song"):(this.id=e.id||generateUUID(),this.type=e.type||"song",this.attributes={playParams:{id:this.id,kind:this.type}});this.contentType=e.contentType,this._context=e.context||{},e.container?this._container=e.container:e.containerId&&e.containerType&&(this._container={id:e.containerId,type:e.containerType})}}const ge=["contributors","modalities","movie","musicVideo","musicMovie","trailer","tvEpisode","uploadedVideo","uploaded-videos","music-videos","music-movies","tv-episodes","workouts"];var be=function(e){return e[e.none=0]="none",e[e.loading=1]="loading",e[e.playing=2]="playing",e[e.paused=3]="paused",e[e.stopped=4]="stopped",e[e.ended=5]="ended",e[e.seeking=6]="seeking",e[e.waiting=8]="waiting",e[e.stalled=9]="stalled",e[e.completed=10]="completed",e}({}),Pe=function(e){return e[e.pictureinpicture=0]="pictureinpicture",e[e.inline=1]="inline",e}({});const Se={AFG:"143610",AGO:"143564",AIA:"143538",ALB:"143575",AND:"143611",ARE:"143481",ARG:"143505",ARM:"143524",ATG:"143540",AUS:"143460",AUT:"143445",AZE:"143568",BEL:"143446",BEN:"143576",BFA:"143578",BGD:"143490",BGR:"143526",BHR:"143559",BHS:"143539",BIH:"143612",BLR:"143565",BLZ:"143555",BMU:"143542",BOL:"143556",BRA:"143503",BRB:"143541",BRN:"143560",BTN:"143577",BWA:"143525",CAF:"143623",CAN:"143455",CHE:"143459",CHL:"143483",CHN:"143465",CIV:"143527",CMR:"143574",COD:"143613",COG:"143582",COL:"143501",CPV:"143580",CRI:"143495",CYM:"143544",CYP:"143557",CZE:"143489",DEU:"143443",DMA:"143545",DNK:"143458",DOM:"143508",DZA:"143563",ECU:"143509",EGY:"143516",ESP:"143454",EST:"143518",ETH:"143569",FIN:"143447",FJI:"143583",FRA:"143442",FSM:"143591",GAB:"143614",GBR:"143444",GEO:"143615",GHA:"143573",GIN:"143616",GMB:"143584",GNB:"143585",GRC:"143448",GRD:"143546",GTM:"143504",GUY:"143553",HKG:"143463",HND:"143510",HRV:"143494",HUN:"143482",IDN:"143476",IND:"143467",IRL:"143449",IRQ:"143617",ISL:"143558",ISR:"143491",ITA:"143450",JAM:"143511",JOR:"143528",JPN:"143462",KAZ:"143517",KEN:"143529",KGZ:"143586",KHM:"143579",KNA:"143548",KOR:"143466",KWT:"143493",LAO:"143587",LBN:"143497",LBR:"143588",LBY:"143567",LCA:"143549",LIE:"143522",LKA:"143486",LTU:"143520",LUX:"143451",LVA:"143519",MAC:"143515",MAR:"143620",MCO:"143618",MDA:"143523",MDG:"143531",MDV:"143488",MEX:"143468",MKD:"143530",MLI:"143532",MLT:"143521",MMR:"143570",MNE:"143619",MNG:"143592",MOZ:"143593",MRT:"143590",MSR:"143547",MUS:"143533",MWI:"143589",MYS:"143473",NAM:"143594",NER:"143534",NGA:"143561",NIC:"143512",NLD:"143452",NOR:"143457",NPL:"143484",NRU:"143606",NZL:"143461",OMN:"143562",PAK:"143477",PAN:"143485",PER:"143507",PHL:"143474",PLW:"143595",PNG:"143597",POL:"143478",PRT:"143453",PRY:"143513",PSE:"143596",QAT:"143498",ROU:"143487",RUS:"143469",RWA:"143621",SAU:"143479",SEN:"143535",SGP:"143464",SLB:"143601",SLE:"143600",SLV:"143506",SRB:"143500",STP:"143598",SUR:"143554",SVK:"143496",SVN:"143499",SWE:"143456",SWZ:"143602",SYC:"143599",TCA:"143552",TCD:"143581",THA:"143475",TJK:"143603",TKM:"143604",TON:"143608",TTO:"143551",TUN:"143536",TUR:"143480",TWN:"143470",TZA:"143572",UGA:"143537",UKR:"143492",URY:"143514",USA:"143441",UZB:"143566",VCT:"143550",VEN:"143502",VGB:"143543",VNM:"143471",VUT:"143609",WSM:"143607",XKX:"143624",YEM:"143571",ZAF:"143472",ZMB:"143622",ZWE:"143605"};function asyncGeneratorStep$1k(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1k(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1k(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1k(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}const Te={AW:"ABW",AF:"AFG",AO:"AGO",AI:"AIA",AX:"ALA",AL:"ALB",AD:"AND",AE:"ARE",AR:"ARG",AM:"ARM",AS:"ASM",AQ:"ATA",TF:"ATF",AG:"ATG",AU:"AUS",AT:"AUT",AZ:"AZE",BI:"BDI",BE:"BEL",BJ:"BEN",BQ:"BES",BF:"BFA",BD:"BGD",BG:"BGR",BH:"BHR",BS:"BHS",BA:"BIH",BL:"BLM",BY:"BLR",BZ:"BLZ",BM:"BMU",BO:"BOL",BR:"BRA",BB:"BRB",BN:"BRN",BT:"BTN",BV:"BVT",BW:"BWA",CF:"CAF",CA:"CAN",CC:"CCK",CH:"CHE",CL:"CHL",CN:"CHN",CI:"CIV",CM:"CMR",CD:"COD",CG:"COG",CK:"COK",CO:"COL",KM:"COM",CV:"CPV",CR:"CRI",CU:"CUB",CW:"CUW",CX:"CXR",KY:"CYM",CY:"CYP",CZ:"CZE",DE:"DEU",DJ:"DJI",DM:"DMA",DK:"DNK",DO:"DOM",DZ:"DZA",EC:"ECU",EG:"EGY",ER:"ERI",EH:"ESH",ES:"ESP",EE:"EST",ET:"ETH",FI:"FIN",FJ:"FJI",FK:"FLK",FR:"FRA",FO:"FRO",FM:"FSM",GA:"GAB",GB:"GBR",GE:"GEO",GG:"GGY",GH:"GHA",GI:"GIB",GN:"GIN",GP:"GLP",GM:"GMB",GW:"GNB",GQ:"GNQ",GR:"GRC",GD:"GRD",GL:"GRL",GT:"GTM",GF:"GUF",GU:"GUM",GY:"GUY",HK:"HKG",HM:"HMD",HN:"HND",HR:"HRV",HT:"HTI",HU:"HUN",ID:"IDN",IM:"IMN",IN:"IND",IO:"IOT",IE:"IRL",IR:"IRN",IQ:"IRQ",IS:"ISL",IL:"ISR",IT:"ITA",JM:"JAM",JE:"JEY",JO:"JOR",JP:"JPN",KZ:"KAZ",KE:"KEN",KG:"KGZ",KH:"KHM",KI:"KIR",KN:"KNA",KR:"KOR",KW:"KWT",LA:"LAO",LB:"LBN",LR:"LBR",LY:"LBY",LC:"LCA",LI:"LIE",LK:"LKA",LS:"LSO",LT:"LTU",LU:"LUX",LV:"LVA",MO:"MAC",MF:"MAF",MA:"MAR",MC:"MCO",MD:"MDA",MG:"MDG",MV:"MDV",MX:"MEX",MH:"MHL",MK:"MKD",ML:"MLI",MT:"MLT",MM:"MMR",ME:"MNE",MN:"MNG",MP:"MNP",MZ:"MOZ",MR:"MRT",MS:"MSR",MQ:"MTQ",MU:"MUS",MW:"MWI",MY:"MYS",YT:"MYT",NA:"NAM",NC:"NCL",NE:"NER",NF:"NFK",NG:"NGA",NI:"NIC",NU:"NIU",NL:"NLD",NO:"NOR",NP:"NPL",NR:"NRU",NZ:"NZL",OM:"OMN",PK:"PAK",PA:"PAN",PN:"PCN",PE:"PER",PH:"PHL",PW:"PLW",PG:"PNG",PL:"POL",PR:"PRI",KP:"PRK",PT:"PRT",PY:"PRY",PS:"PSE",PF:"PYF",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",SA:"SAU",SD:"SDN",SN:"SEN",SG:"SGP",GS:"SGS",SH:"SHN",SJ:"SJM",SB:"SLB",SL:"SLE",SV:"SLV",SM:"SMR",SO:"SOM",PM:"SPM",RS:"SRB",SS:"SSD",ST:"STP",SR:"SUR",SK:"SVK",SI:"SVN",SE:"SWE",SZ:"SWZ",SX:"SXM",SC:"SYC",SY:"SYR",TC:"TCA",TD:"TCD",TG:"TGO",TH:"THA",TJ:"TJK",TK:"TKL",TM:"TKM",TL:"TLS",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TV:"TUV",TW:"TWN",TZ:"TZA",UG:"UGA",UA:"UKR",UM:"UMI",UY:"URY",US:"USA",UZ:"UZB",VA:"VAT",VC:"VCT",VE:"VEN",VG:"VGB",VI:"VIR",VN:"VNM",VU:"VUT",WF:"WLF",WS:"WSM",XK:"XKX",YE:"YEM",ZA:"ZAF",ZM:"ZMB",ZW:"ZWE"};function getLanguageId(e="en-US"){const n=ke[e.toLowerCase()];if(n)return n;if(e.includes("-")){const n=e.split("-")[0],d=ke[n.toLowerCase()];if(d)return d}return ke["en-us"]}const ke={af:48,sq:1,ar:34,eu:1,bg:49,be:1,ca:42,zh:19,"zh-tw":18,"zh-cn":19,"zh-hk":45,"zh-sg":19,hr:41,cs:22,da:11,nl:10,"nl-be":65,en:1,"en-us":1,"en-eg":26,"en-au":27,"en-gb":2,"en-ca":6,"en-nz":27,"en-ie":26,"en-za":26,"en-jm":26,"en-bz":26,"en-tt":26,"en-001":26,et:30,fo:1,fa:59,fi:12,fr:3,"fr-ca":5,gd:2,de:4,"de-ch":57,el:23,he:36,hi:50,hu:21,is:31,id:37,it:7,ja:9,ko:13,lv:33,lt:32,mk:1,mt:1,no:14,nb:14,nn:14,pl:20,"pt-br":15,pt:24,rm:1,ro:39,ru:16,sr:1,sk:40,sl:52,es:8,"es-mx":28,"es-419":44,sv:17,th:35,ts:1,tn:1,tr:25,uk:29,ur:55,ve:1,vi:43,xh:1,yi:1,zu:56,ms:38,iw:36,lo:46,tl:47,kk:51,ta:53,te:54,bn:58,ga:60,ht:61,la:62,pa:63,sa:64};let Ee="Music-User-Token";function getLanguages(){if("undefined"==typeof navigator)return[];if(navigator.languages)return navigator.languages;const e=navigator.language||navigator.userLanguage;return e?[e]:[]}Ee="Media-User-Token";const we=["apps.apple.com","books.apple.com","fitness.apple.com","music.apple.com","podcasts.apple.com","tv.apple.com"];function determineBaseCookieDomain(e){let n=e;return e&&we.some((function(d){if(e.endsWith("."+d))return n=d,!0})),n}const Oe=new Set(["apps","books","music","podcasts","tv"]),Ie=/\.apple\.com$/;function getCommerceHostname(e,n){!n&&"undefined"!=typeof location&&location.hostname&&(n=location);let d=e+".itunes.apple.com";if(!n)return d;const p=function(e){if(!e||!Ie.test(e))return;const n=e.split(".");let d=n[n.length-3];const p=d;if(d&&d.includes("-")){const e=d.split("-");d=e[e.length-1]}return Oe.has(d)?p:void 0}(n.hostname);return p&&(d=`${e}.${p}.apple.com`),d}function buildQueryParams(e={app:"music",p:"subscribe"}){return void 0===e.app&&(e.app="music"),void 0===e.p&&(e.p="subscribe"),Object.keys(e).map(n=>`${encodeURIComponent(n)}=${encodeURIComponent(e[n])}`).join("&")}var $e=function(e){return e.DEFAULT_CID="pldfltcid",e.TV_CID="pltvcid",e.RESTRICTIONS_ENABLED="itre",e.STOREFRONT_COUNTRY_CODE="itua",e.USER_TOKEN="media-user-token",e}({}),Ae=function(e){return e[e.MUSIC=0]="MUSIC",e[e.PODCAST=1]="PODCAST",e[e.TV=2]="TV",e}({});const Re={[Ae.TV]:"com.apple.onboarding.tvappweb",[Ae.MUSIC]:"com.apple.onboarding.musicappweb",[Ae.PODCAST]:"com.apple.onboarding.podcastsweb"},Ce={[Ae.TV]:"pltvcid",[Ae.MUSIC]:"pldfltcid",[Ae.PODCAST]:"pldfltcid"},Me={"com.apple.onboarding.tvappweb":1,"com.apple.onboarding.musicappweb":1,"com.apple.onboarding.podcastsweb":1},De=new Logger$1("storekit");function asyncGeneratorStep$1j(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1W(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class Dispatch{get source(){return this._source}set source(e){if(!e&&this._source)return this._source.removeEventListener("message",this.handle),void(this._source=void 0);e.addEventListener("message",this.handle),this._source=e}apply(e,n){if(!this.destination)throw new Error("No destination");const d=this._sequence++,p=new Promise((e,n)=>{this._registry[d]={resolve:e,reject:n}});return this.send(this.destination,{jsonrpc:"2.0",id:d,method:e,params:n}),p}call(e,...n){return this.apply(e,n)}handleRequest(e){var n,d=this;return(n=function*(){const n={jsonrpc:"2.0",id:e.id},p=d.methods[e.method];if(!p)return Object.assign(n,{error:{code:-32601,message:"Method not found"}});try{const d=yield p.apply(void 0,ensureArray(e.params));return Object.assign(n,{result:d})}catch(he){return Object.assign(n,{error:{code:he.code||-32603,message:he.message}})}},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$1j(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1j(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}handleResponse(e){const n=this._registry[e.id];delete this._registry[e.id],n&&(e.error?n.reject(Object.assign(Error(),e.error)):n.resolve(e.result))}send(e,n){e.postMessage(n,e.window===e?this.origin:void 0)}constructor(e={}){_define_property$1W(this,"destination",void 0),_define_property$1W(this,"origin",void 0),_define_property$1W(this,"methods",void 0),_define_property$1W(this,"_registry",{}),_define_property$1W(this,"_sequence",0),_define_property$1W(this,"_source",void 0),_define_property$1W(this,"handle",e=>{e.data&&"2.0"===e.data.jsonrpc&&("*"!==this.origin&&this.origin!==e.origin||(e.data.method&&this.destination?this.handleRequest(e.data).then(e=>{this.send(this.destination,e)}):(hasOwn(e.data,"result")||e.data.error)&&this.handleResponse(e.data)))}),this.destination=e.destination,this.methods=e.methods||{},this.origin=e.origin||"*",e.source&&(this.source=e.source)}}function asyncGeneratorStep$1i(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1i(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1i(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1i(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1V(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$X(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1V(e,n,d[n])}))}return e}function _object_spread_props$D(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}var je=function(e){return e[e.UNAVAILABLE=-1]="UNAVAILABLE",e[e.NOT_DETERMINED=0]="NOT_DETERMINED",e[e.DENIED=1]="DENIED",e[e.RESTRICTED=2]="RESTRICTED",e[e.AUTHORIZED=3]="AUTHORIZED",e}({});function validateToken(e){return"string"==typeof e&&e.length>0}const xe=`https://${getCommerceHostname("buy")}/commerce/account/authenticateMusicKitRequest`,Ne="https://authorize.music.apple.com",Le=/^https?:\/\/(.+\.)*(apple\.com|apps\.mzstatic\.com)(\/[\w\d]+)*$/;var Ue=function(e){return e[e.AUTHORIZE=0]="AUTHORIZE",e[e.SUBSCRIBE=1]="SUBSCRIBE",e}({});class ServiceSetupView{get isServiceView(){return/(authorize\.(.+\.)*apple\.com)/i.test(window.location.hostname)||window&&window.name===this.target||!1}focus(){this._window&&window.focus&&this._window.focus()}load(e={action:0}){var n=this;return _async_to_generator$1i((function*(){return 1===e.action?n._subscribeAction(e.parameters):n._authorizeAction(e.parameters)}))()}present(e="",n){const{height:d,left:p,top:h,width:y}=this._calculateClientDimensions(),_={height:650,menubar:"no",resizable:"no",scrollbars:"no",status:"no",toolbar:"no",width:650},m=_object_spread$X(_object_spread_props$D(_object_spread$X({},_),{left:y/2-_.width/2+p,top:d/2-_.height/2+h}),n),g=Object.keys(m).map(e=>`${e}=${m[e]}`).join(",");return/trident|msie/i.test(navigator.userAgent)?(this._window=window.open(window.location.href,this.target,g)||void 0,this._window.location.href=e):this._window=window.open(e,this.target,g)||void 0,/\bedge\b/i.test(navigator.userAgent)&&(this._window.opener=self),this.focus(),this._window}_startPollingForWindowClosed(e){this._window&&void 0===this._windowClosedInterval&&(this._windowClosedInterval=setInterval(()=>{var n;(null===(n=this._window)||void 0===n?void 0:n.closed)&&(this._stopPollingForWindowClosed(),e())},500))}_stopPollingForWindowClosed(){void 0!==this._windowClosedInterval&&(clearInterval(this._windowClosedInterval),this._windowClosedInterval=void 0)}_authorizeAction(e={}){var n=this;return _async_to_generator$1i((function*(){var d;let p,h;const y=(null===(d=window.location)||void 0===d?void 0:d.href)||"";return"GET"===n.authenticateMethod?h=`${Ne}/woa?${buildQueryParams(_object_spread_props$D(_object_spread$X({},n.deeplinkParameters),{a:btoa(n._thirdPartyInfo()),referrer:y}))}`:(p=n._buildFormElement(xe),document.body.appendChild(p)),new Promise((d,y)=>{const _=n.present(h);n._startPollingForWindowClosed(()=>{y(0)}),n.dispatch=new Dispatch({methods:{authorize:function(e,n,p){if(validateToken(e)){d({restricted:n&&"1"===n,userToken:e,cid:p})}else y(0)},close:function(){},decline:function(){y(1)},switchUserId:function(){y(0)},thirdPartyInfo:()=>n._thirdPartyInfo(n.developerToken,_object_spread$X({},n.deeplinkParameters,e)),unavailable:function(){y(-1)}},origin:Ne,source:window,destination:_}),p&&p.submit()})}))()}_buildFormElement(e,n=this.target,d=this.developerToken){const p=document.createElement("form");p.setAttribute("method","post"),p.setAttribute("action",e),p.setAttribute("target",n),p.style.display="none";const h=document.createElement("input");h.setAttribute("name","jwtToken"),h.setAttribute("value",d),p.appendChild(h);const y=document.createElement("input");y.setAttribute("name","isWebPlayer"),y.setAttribute("value","true"),p.appendChild(y);const _=document.createElement("input");return _.setAttribute("name","LogoURL"),_.setAttribute("value",""),p.appendChild(_),p}_calculateClientDimensions(e=window){return{height:e.innerHeight?e.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:screen.height,left:e.screenLeft?e.screenLeft:screen.availLeft||screen.left,top:e.screenTop?e.screenTop:screen.availTop||screen.top,width:e.innerWidth?e.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:screen.width}}_subscribeAction(e={}){var n=this;return _async_to_generator$1i((function*(){return Object.assign(e,n.deeplinkParameters),new Promise((d,p)=>{const h="https://authorize.music.apple.com/upsell?"+buildQueryParams(e);n.present(h),window.addEventListener("message",({data:e,origin:n,source:h})=>{const{closeWindow:y,launchClient:_}="string"==typeof e?JSON.parse(e):e;n&&!Le.test(n)||(_?0===_.supported?p("Unable to subscribe on this platform."):d(_):p("Subscribe action error."))})})}))()}_thirdPartyInfo(e=this.developerToken,n){let d=this.iconURL;const p=window.location.host||document.referrer,h=[...[].slice.call(document.querySelectorAll('link[rel="apple-music-app-icon"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon-precomposed"]')),...[].slice.call(document.querySelectorAll('link[rel="apple-touch-icon"]'))];if(h&&h[0]&&h[0].href){const e=h.find(e=>!!e.sizes&&"120x120"===e.sizes.value);var y;d=null!==(y=null==e?void 0:e.href)&&void 0!==y?y:h[0].href}return JSON.stringify({thirdPartyIconURL:d,thirdPartyName:p,thirdPartyParameters:n,thirdPartyToken:e})}constructor(e,n={}){if(_define_property$1V(this,"developerToken",void 0),_define_property$1V(this,"authenticateMethod",void 0),_define_property$1V(this,"deeplinkParameters",void 0),_define_property$1V(this,"iconURL",void 0),_define_property$1V(this,"target",void 0),_define_property$1V(this,"dispatch",void 0),_define_property$1V(this,"_window",void 0),_define_property$1V(this,"_windowClosedInterval",void 0),this.developerToken=e,this.authenticateMethod="GET",this.target="apple-music-service-view",this.deeplinkParameters=n&&n.deeplinkParameters||{},this.iconURL=n&&n.iconURL,this.authenticateMethod=n&&n.authenticateMethod||"GET",this.isServiceView&&window.opener!==window){var d;const e=null===(d=getSessionStorage())||void 0===d?void 0:d.getItem("ac"),n=null!=e?new URL(e).origin:void 0;var p;if(n)this.dispatch=new Dispatch({destination:null!==(p=window.opener)&&void 0!==p?p:void 0,origin:n,source:window})}}}function asyncGeneratorStep$1h(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1h(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1h(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1h(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1U(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}var Fe=function(e){return e.ID="us",e.LANGUAGE_TAG="en-gb",e}({});function _fetchStorefronts(){return(_fetchStorefronts=_async_to_generator$1h((function*(e,n="https://api.music.apple.com/v1"){const d=new Headers({Authorization:"Bearer "+e}),p=yield fetch(n+"/storefronts",{headers:d}),h=yield p.json();return h.errors?Promise.reject(h.errors):h.data}))).apply(this,arguments)}class Storefront{static inferFromLanguages(e,n=getLanguages()){return _async_to_generator$1h((function*(){const d=yield function(e){return _fetchStorefronts.apply(this,arguments)}(e),p=d.map(e=>e.id),h=n[0]||"en-US",[y,_]=h.toLowerCase().split(/-|_/),m=p.includes(_)?_:"us";return d.find(e=>e.id===m)}))()}constructor(e,n,d){_define_property$1U(this,"id",void 0),_define_property$1U(this,"attributes",void 0),_define_property$1U(this,"href",void 0),_define_property$1U(this,"type",void 0),this.id=e,this.attributes=n,this.type="storefronts",this.href=d||`/v1/${this.type}/${e}`}}function asyncGeneratorStep$1g(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1T(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const Ke=["music.apple.com","podcasts.apple.com","tv.apple.com"],Be=["mut-refresh",$e.DEFAULT_CID,$e.STOREFRONT_COUNTRY_CODE,$e.TV_CID,$e.USER_TOKEN],Ve=new Map([["signIn","/auth/v2/web"],["signOut","/auth/v2/web/logout"],["refresh","/auth/v2/web/refresh"]]);class Reflector{onUserTokenChange(){const e=this.getUserToken(),n=this.previousUserToken!==e;if(this.previousUserToken=e,De.debug("Reflector.onUserTokenChange hasChanged?",n),n)return e?this.reflect():this.clear()}skipJsCookieWrite(e){return Be.includes(e)}refresh(){if(!this.allowMultiReflection)return;const e=getCookie("mut-refresh");return getCookie($e.USER_TOKEN)&&!e?this.makeRequests("refresh"):void 0}reflect(){if(this.allowMultiReflection)return this.makeRequests("signIn");{const e=Be.map(e=>getCookie(e));this.clearAppleComCookies(),Be.forEach((n,d)=>{const p=e[d],h=getCookie(n);p&&!h&&(De.debug("Reflector.reflect calling setCookie",n,p),setCookie(n,p,"/",166,void 0,determineBaseCookieDomain(this.hostname)))})}}clear(){if(this.allowMultiReflection)return this.makeRequests("signOut");De.debug("Reflector nothing to clear, no allowMultiReflection")}makeRequests(e){var n,d=this;return(n=function*(){De.debug("Reflector makeRequests()",e);try{const n=Ve.get(e);for(const e of Ke){const p=`https://auth.${e}${n}`;De.debug("Reflector.makeRequests for",p);try{yield fetch(p,{headers:{Authorization:"Bearer "+d.developerToken},method:"POST",credentials:"include"})}catch(St){De.error("Reflector fetch failed for ",p,St)}}d.clearAppleComCookies()}catch(St){De.error("Reflector makeRequests failed",St)}De.debug("Reflector calling onRequestsComplete"),d.onRequestsComplete()},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$1g(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1g(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}clearAppleComCookies(){De.debug("Reflector.clearAppleComCookies"),Be.forEach(e=>removeCookie(e,void 0,"apple.com"))}constructor({hostname:e,developerToken:n,getUserToken:d,startingUserToken:p,onRequestsComplete:h,allowMultiReflection:y}){_define_property$1T(this,"developerToken",void 0),_define_property$1T(this,"getUserToken",void 0),_define_property$1T(this,"onRequestsComplete",void 0),_define_property$1T(this,"allowMultiReflection",!1),_define_property$1T(this,"previousUserToken",void 0),_define_property$1T(this,"hostname",void 0),this.hostname=e,this.developerToken=n,this.getUserToken=d,this.previousUserToken=p,this.onRequestsComplete=h,this.allowMultiReflection=y&&function(e){if(!e)return!1;for(const n of Ke)if(n===e||e.endsWith("."+n))return!0;return!1}(this.hostname),this.onUserTokenChange=this.onUserTokenChange.bind(this),De.debug("Reflector allowMultiReflection?",this.allowMultiReflection)}}function asyncGeneratorStep$1f(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1f(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1f(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1f(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1S(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$W(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1S(e,n,d[n])}))}return e}function _ts_metadata$y(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}var Ge=function(e){return e.authorizationStatusDidChange="authorizationStatusDidChange",e.authorizationStatusWillChange="authorizationStatusWillChange",e.eligibleForSubscribeView="eligibleForSubscribeView",e.needsGDPRDidChange="needsGDPRDidChange",e.storefrontCountryCodeDidChange="storefrontCountryCodeDidChange",e.storefrontIdentifierDidChange="storefrontIdentifierDidChange",e.userTokenDidChange="userTokenDidChange",e}({});$e.DEFAULT_CID;let qe=!1;qe=!0;const He="https://"+getCommerceHostname("buy"),ze=`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa`;class StoreKit extends Notifications{updateUserTokenFromStorage(){const e=this._getStorageItem($e.USER_TOKEN);this.userToken=e||void 0}get authorizationStatus(){return this._authorizationStatus}set authorizationStatus(e){this._authorizationStatus!==e&&(this._getIsActiveSubscription.updateCache(void 0),this.dispatchEvent("authorizationStatusWillChange",{authorizationStatus:this._authorizationStatus,newAuthorizationStatus:e}),this._authorizationStatus=e,this.dispatchEvent("authorizationStatusDidChange",{authorizationStatus:e}))}get cid(){if(!this._cids[this.cidNamespace]){const e=this._getStorageItem(this.cidNamespace);this._cids[this.cidNamespace]=e||void 0}return this._cids[this.cidNamespace]}set cid(e){e?this._setStorageItem(this.cidNamespace,e):this._removeStorageItem(this.cidNamespace),this._cids[this.cidNamespace]=e}eligibleForSubscribeView(){var e=this;return _async_to_generator$1f((function*(){const n=yield e.hasMusicSubscription();return(!e.hasAuthorized||e.hasAuthorized&&!n)&&!e._dispatchedSubscribeView}))()}get hasAuthorized(){return this.authorizationStatus>je.DENIED}get logoutURL(){if(!this._disableLogoutURL)return this.iTunesBuyBase+"/account/web/logout"}get parentalControls(){return this._parentalControls}set parentalControls(e){this._parentalControls=e,e&&(this.realm===Ae.MUSIC||this.realm===Ae.PODCAST?this.restrictedEnabled=e.musicParentalControlsEnabled:this.realm===Ae.TV&&e.videoContentRestrictions&&(this.authorizationStatus=je.RESTRICTED))}get isU13(){return!!this._isU13}set isU13(e){this._isU13=e}get _pldfltcid(){return this._cids[$e.DEFAULT_CID]}set _pldfltcid(e){this._cids[$e.DEFAULT_CID]=e}get privacyAcknowledgements(){return this._privacyAcknowledgements}set privacyAcknowledgements(e){if(this._privacyAcknowledgements=e,!e)return this._gdprVersion=-1,void(this._needsGDPR=void 0);if(this.bundleId){var n;const d=null!==(n=this._needsGDPR)&&void 0!==n&&n;this._gdprVersion=e[this.bundleId]||0,this._needsGDPR=this._gdprVersion<(Me[this.bundleId]||0),d!==this._needsGDPR&&this.dispatchEvent("needsGDPRDidChange",{GDPRVersion:this._gdprVersion,needsGDPR:this._needsGDPR})}}get restrictedEnabled(){if(this.userToken&&"boolean"!=typeof this._restrictedEnabled){const e=this._getStorageItem($e.RESTRICTIONS_ENABLED);if(e)this._restrictedEnabled="0"!==e;else if(this._storefrontCountryCode){const e=["br","ch","gt","hu","id","in","it","kr","la","lt","my","ru","sg","tr"];this._restrictedEnabled=-1!==e.indexOf(this._storefrontCountryCode)||void 0}}return this._restrictedEnabled}set restrictedEnabled(e){this._restrictedEnabledOverridden||(this.userToken&&void 0!==e&&this._setStorageItem($e.RESTRICTIONS_ENABLED,e?"1":"0"),this._restrictedEnabled=e,e&&(this.authorizationStatus=je.RESTRICTED))}overrideRestrictEnabled(e){this._restrictedEnabledOverridden=!1,this.restrictedEnabled=e,this._restrictedEnabledOverridden=!0}get storefrontCountryCode(){if(!this._storefrontCountryCode){const e=this._getStorageItem($e.STOREFRONT_COUNTRY_CODE);this._storefrontCountryCode=(null==e?void 0:e.toLowerCase())||Fe.ID}return this._storefrontCountryCode}set storefrontCountryCode(e){e&&this.userToken?this._setStorageItem($e.STOREFRONT_COUNTRY_CODE,e):this._removeStorageItem($e.STOREFRONT_COUNTRY_CODE),e!==this._storefrontCountryCode&&(this._storefrontCountryCode=e,this.dispatchEvent("storefrontCountryCodeDidChange",{storefrontCountryCode:e}))}get storefrontIdentifier(){return this._storefrontIdentifier}set storefrontIdentifier(e){this._storefrontIdentifier=e,this.dispatchEvent("storefrontIdentifierDidChange",{storefrontIdentifier:e})}runTokenValidations(e,n=!0){e&&validateToken(e)?(n&&this._setStorageItem($e.USER_TOKEN,e),this.authorizationStatus=this.restrictedEnabled?je.RESTRICTED:je.AUTHORIZED):(this._removeStorageItem($e.USER_TOKEN),this.authorizationStatus=je.NOT_DETERMINED)}wrapDynamicUserTokenForChanges(e,n=invoke(e)){if("function"!=typeof e)return e;let d=n;return()=>{const n=invoke(e);return d!==n&&(d=n,this.runTokenValidations(n,!1),this.dispatchEvent("userTokenDidChange",{userToken:n})),n||""}}get dynamicUserToken(){return this._dynamicUserToken}set dynamicUserToken(e){const n=invoke(e);this._dynamicUserToken=this.wrapDynamicUserTokenForChanges(e,n),this.runTokenValidations(n,"function"!=typeof e),this.dispatchEvent("userTokenDidChange",{userToken:n})}get userToken(){return invoke(this.dynamicUserToken)}set userToken(e){this.dynamicUserToken=e}get userTokenIsValid(){return validateToken(this.userToken)}deeplinkURL(e={}){return"https://finance-app.itunes.apple.com/deeplink?"+buildQueryParams(e=_object_spread$W({},this.deeplinkParameters||{},e))}itunesDeeplinkURL(e={p:"browse"}){return"https://itunes.apple.com/deeplink?"+buildQueryParams(e=_object_spread$W({},this.deeplinkParameters||{},e))}pldfltcid(){var e=this;return _async_to_generator$1f((function*(){if(!e._cids[$e.DEFAULT_CID])try{yield e.infoRefresh()}catch(St){return}return e._cids[$e.DEFAULT_CID]}))()}renewUserToken(){var e=this;return _async_to_generator$1f((function*(){if(!e.userToken)return e.requestUserToken();const n=new Headers({Authorization:"Bearer "+e.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+e.userToken}),d=yield e.fetch(e.playBase+"/renewMusicToken",{method:"POST",headers:n});if(401===d.status)return yield e.revokeUserToken(),Promise.reject(new Error("Renew token"));const p=yield d.json();return p["music-token"]&&(e.userToken=p["music-token"]),e.userToken}))()}requestStorefrontCountryCode(){var e=this;return _async_to_generator$1f((function*(){if(e.authorizationStatus<=je.DENIED)return Promise.reject("Not authorized: "+e.authorizationStatus);const n=new Headers({Authorization:"Bearer "+e.developerToken,[Ee]:e.userToken||""}),d=yield e.fetch(e.apiBase+"/me/storefront",{headers:n});if(d&&!d.ok)return 401!==d.status&&403!==d.status||e._reset(),Promise.reject("Storefront Country Code error.");const p=yield d.json();if(p.errors)return Promise.reject(p.errors);const[h]=p.data;return h&&h.id?(e.storefrontCountryCode=h.id,e.storefrontCountryCode):Promise.reject("Storefront Country Code error.")}))()}requestStorefrontIdentifier(){var e=this;return _async_to_generator$1f((function*(){if(!e.storefrontIdentifier){const n=yield Storefront.inferFromLanguages(e.developerToken);e.storefrontIdentifier=n.id}return e.storefrontIdentifier}))()}requestUserToken(){var e=this;return _async_to_generator$1f((function*(){if(e._serviceSetupView.isServiceView)return e.userToken||"";try{const n=yield e._serviceSetupView.load({action:Ue.AUTHORIZE});e.cid=n.cid,e.userToken=n.userToken,e.restrictedEnabled=n.restricted}catch(n){return e._reset(),e.authorizationStatus=n,Promise.reject(n)}return e.userToken}))()}revokeUserToken(){var e=this;return _async_to_generator$1f((function*(){try{yield e._webPlayerLogout()}catch(St){}e.dispatchEvent("authorizationStatusWillChange",{authorizationStatus:e.authorizationStatus,newAuthorizationStatus:je.NOT_DETERMINED}),e._reset(),e.dispatchEvent("authorizationStatusDidChange",{authorizationStatus:e.authorizationStatus}),e.dispatchEvent("userTokenDidChange",{userToken:e.userToken})}))()}setCids(e){this._cids=_object_spread$W({},this._cids,e),Object.keys(this._cids).forEach(e=>{this._setStorageItem(e,this._cids[e])})}shouldDisplayPrivacyLink(e){var n=this;return _async_to_generator$1f((function*(){return e||(e=n.bundleId),void 0!==n._needsGDPR||(yield n.me()),n._needsGDPR}))()}hasMusicSubscription(){var e=this;return _async_to_generator$1f((function*(){return!!e.hasAuthorized&&e._getIsActiveSubscription()}))()}_getIsActiveSubscription(){var e=this;return _async_to_generator$1f((function*(){var n;if(e.realm===Ae.PODCAST)return!0;return!!(null===(n=(yield e.me()).subscription)||void 0===n?void 0:n.active)}))()}resetSubscribeViewEligibility(){this._dispatchedSubscribeView=!1}presentSubscribeViewForEligibleUsers(e={},n=!0){var d=this;return _async_to_generator$1f((function*(){const p=yield d.eligibleForSubscribeView();if(!d._serviceSetupView.isServiceView&&p){if(!n)return d.dispatchEvent("eligibleForSubscribeView",e),void(d._dispatchedSubscribeView=!0);try{const e=yield d._serviceSetupView.load({action:Ue.SUBSCRIBE});return d._dispatchedSubscribeView=!0,e}catch(h){return d.revokeUserToken()}}}))()}infoRefresh(){var e=this;return _async_to_generator$1f((function*(){if(e.authorizationStatus<=je.DENIED)return Promise.reject("Not authorized: "+e.authorizationStatus);const n=new Headers({Authorization:"Bearer "+e.developerToken,[Ee]:e.userToken||""});try{const d=yield e.fetch(e.iTunesBuyBase+"/account/web/infoRefresh",{credentials:"include",headers:n}),p=yield d.json();e.setCids(p)}catch(St){}}))()}me(){if(this.authorizationStatus<=je.DENIED)return Promise.reject("Not authorized: "+this.authorizationStatus);if(!this._me){var e=this;this._me=new Promise(function(){var n=_async_to_generator$1f((function*(n,d){const p=new Headers({Authorization:"Bearer "+e.developerToken,[Ee]:e.userToken||""}),h=buildURL(e.apiBase,"/me/account",_object_spread$W({meta:"subscription"},e.meParameters));let y;try{y=yield e.fetch(h,{headers:p})}catch(St){return d(new MKError(MKError.Reason.NETWORK_ERROR,"Failed to fetch /me/account"))}if(y&&!y.ok)return e.realm===Ae.TV||401!==y.status&&403!==y.status||e._reset(),d("Account error.");let _=yield y.json();if(_.errors)return d(_.errors);const{data:m,meta:g}=_;if(!g||!g.subscription)return d("Account error.");e.storefrontCountryCode=g.subscription.storefront;const b={meta:g,subscription:g.subscription};m&&m.length&&(b.attributes=m[0].attributes);try{let d=yield e.fetch(e.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:p});if(_=yield d.json(),e.isU13=_.isU13,e.parentalControls=_.parentalControlsData,e.privacyAcknowledgements=_.privacyAcknowledgement,isEmpty(e.privacyAcknowledgements||{})){try{yield e.infoRefresh()}catch(St){n(b)}d=yield e.fetch(e.iTunesBuyBase+"/account/web/info",{credentials:"include",headers:p}),_=yield d.json(),e.isU13=_.isU13,e.parentalControls=_.parentalControlsData,e.privacyAcknowledgements=_.privacyAcknowledgement}b.info=_}catch(St){console.warn("Failed to fetch privacyAcknowledgements",St)}return n(b)}));return function(e,d){return n.apply(this,arguments)}}()).then(e=>{var n;return this._getIsActiveSubscription.updateCache((null===(n=e.subscription)||void 0===n?void 0:n.active)||!1),this._me=null,e}).catch(e=>(this._me=null,Promise.reject(e)))}return this._me}musicSubscriptionOffers(e,n=getLanguages()){var d=this;return _async_to_generator$1f((function*(){let p;if(d.hasAuthorized){p=(yield d.me()).info.storeFrontISO3A}else{if(!e){const p=yield Storefront.inferFromLanguages(d.developerToken,n);e=null==p?void 0:p.id}p=e&&Te[e.toUpperCase()]||"USA"}const h=getLanguageId(n[0]),y=Se[p];if(!h||!y)return[];const _=new Headers({"X-Apple-Store-Front":`${y}-${h},8`});d.userToken&&(_.set("Authorization","Bearer "+d.developerToken),_.set("Music-User-Token",d.userToken));const m=yield d.fetch(d.iTunesBuyBase+"/commerce/web/subscription/offers/music",{headers:_});if(!m.ok)return Promise.reject(m.status);return(yield m.json()).offers}))()}_getStorageItem(e){var n;if(e)return"cookie"===this.persist?getCookie(e):"localstorage"===this.persist?null===(n=this.storage)||void 0===n?void 0:n.getItem(`${this.storagePrefix}.${e}`):void 0}_processLocationHash(e){const n=/^\#([a-zA-Z0-9+\/]{200,}={0,2})$/;if(n.test(e)){const d=e.replace(n,"$1");try{const{itre:e,musicUserToken:n,cid:p}=JSON.parse(atob(d));this.restrictedEnabled=e&&"1"===e,this.userToken=n,this.cid=p}catch(St){}history.replaceState(null,document.title," ")}}_removeStorageItem(e){if("cookie"===this.persist)this._removeCookieFromDomains(e);else if("localstorage"===this.persist){var n;return null===(n=this.storage)||void 0===n?void 0:n.removeItem(`${this.storagePrefix}.${e}`)}}_removeCookieFromDomains(e,n=window){De.debug("Calling removeCookie",e),removeCookie(e);const{hostname:d}=n.location,p=d.split(".");if(p.length&&(p.shift(),p.length>2))for(let h=p.length;h>2;h--){const d=p.join(".");p.shift(),De.debug("Calling removeCookie",e,n,d),removeCookie(e,n,d)}}_reset(e=je.NOT_DETERMINED){this._authorizationStatus=e,this._cids={},this._dispatchedSubscribeView=!1,this._restrictedEnabled=void 0,this._storefrontCountryCode=void 0,this._getIsActiveSubscription.updateCache(void 0),Object.keys(Ce).forEach(e=>{this._removeStorageItem(Ce[e])}),this._removeStorageItem($e.RESTRICTIONS_ENABLED),this._removeStorageItem($e.USER_TOKEN),this._removeStorageItem($e.STOREFRONT_COUNTRY_CODE),this._dynamicUserToken=void 0,this._me=null,this.privacyAcknowledgements=void 0}_setStorageItem(e,n){if("cookie"===this.persist){var d;if(null===(d=this.reflector)||void 0===d?void 0:d.skipJsCookieWrite(e))return;return De.debug("Calling setCookie from _setStorageItem",e,n),setCookie(e,n,"/",180,void 0,determineBaseCookieDomain(window.location.hostname))}var p;if("localstorage"===this.persist)return null===(p=this.storage)||void 0===p?void 0:p.setItem(`${this.storagePrefix}.${e}`,n)}_webPlayerLogout(){var e=this;return _async_to_generator$1f((function*(){const n=e.logoutURL;if(!n)return;const d=new Headers({Authorization:"Bearer "+e.developerToken,Accept:"application/json","Content-Type":"application/json",["X-Apple-"+Ee]:""+e.userToken});d.delete("X-Apple-"+Ee),d.append(Ee,e.userToken||"");const p=yield e.fetch(n,{method:"POST",headers:d,credentials:"include"});return p&&!p.ok?Promise.reject(p.status):p.json()}))()}constructor(e,n){var d;(super(["authorizationStatusDidChange","authorizationStatusWillChange","eligibleForSubscribeView","needsGDPRDidChange","storefrontCountryCodeDidChange","userTokenDidChange","storefrontIdentifierDidChange"]),_define_property$1S(this,"developerToken",void 0),_define_property$1S(this,"apiBase",void 0),_define_property$1S(this,"bundleId",void 0),_define_property$1S(this,"cidNamespace",void 0),_define_property$1S(this,"deeplinkParameters",void 0),_define_property$1S(this,"iconURL",void 0),_define_property$1S(this,"iTunesBuyBase",void 0),_define_property$1S(this,"meParameters",void 0),_define_property$1S(this,"persist",void 0),_define_property$1S(this,"playBase",void 0),_define_property$1S(this,"prefix",void 0),_define_property$1S(this,"realm",void 0),_define_property$1S(this,"storage",void 0),_define_property$1S(this,"storagePrefix",void 0),_define_property$1S(this,"whenAuthCompleted",void 0),_define_property$1S(this,"fetch",void 0),_define_property$1S(this,"_authorizationStatus",void 0),_define_property$1S(this,"_developerToken",void 0),_define_property$1S(this,"_disableLogoutURL",void 0),_define_property$1S(this,"_dispatchedSubscribeView",void 0),_define_property$1S(this,"_me",void 0),_define_property$1S(this,"_cids",void 0),_define_property$1S(this,"_gdprVersion",void 0),_define_property$1S(this,"_needsGDPR",void 0),_define_property$1S(this,"_isU13",void 0),_define_property$1S(this,"_parentalControls",void 0),_define_property$1S(this,"_privacyAcknowledgements",void 0),_define_property$1S(this,"_restrictedEnabled",void 0),_define_property$1S(this,"_restrictedEnabledOverridden",void 0),_define_property$1S(this,"_serviceSetupView",void 0),_define_property$1S(this,"reflector",void 0),_define_property$1S(this,"_storefrontCountryCode",void 0),_define_property$1S(this,"_storefrontIdentifier",void 0),_define_property$1S(this,"_dynamicUserToken",void 0),this.developerToken=e,this.apiBase="https://api.music.apple.com/v1",this.iTunesBuyBase=He,this.meParameters={},this.persist="localstorage",this.playBase=ze,this.prefix="music",this.realm=Ae.MUSIC,this.storage=getLocalStorage(),this._authorizationStatus=je.NOT_DETERMINED,this._disableLogoutURL=!1,this._dispatchedSubscribeView=!1,this._me=null,this._cids={},this._gdprVersion=-1,this._needsGDPR=void 0,this._restrictedEnabledOverridden=!1,this._dynamicUserToken=getCookie($e.USER_TOKEN),De.info("StoreKit initialized"),n&&(n.apiBase&&(this.apiBase=n.apiBase),n.deeplink&&(this.deeplinkParameters=n.deeplink),n.meParameters&&(this.meParameters=n.meParameters),n.persist&&(this.persist=n.persist),n.prefix&&(this.prefix=n.prefix),void 0!==n.realm&&(this.realm=n.realm),void 0!==n.disableLogoutURL&&(this._disableLogoutURL=n.disableLogoutURL),this.bundleId=Re[this.realm]),this.fetch=void 0!==n&&"function"==typeof n.fetch?n.fetch:globalThis.fetch.bind(globalThis),this.cidNamespace=Ce[this.realm],this._developerToken=new DeveloperToken(e),this._serviceSetupView=new ServiceSetupView(e,{authenticateMethod:n&&n.authenticateMethod,iconURL:n&&n.iconURL,deeplinkParameters:this.deeplinkParameters}),this.storagePrefix=`${this.prefix}.${this._developerToken.teamId}`.toLocaleLowerCase(),isNodeEnvironment$1()||"cookie"!==this.persist||(De.debug("Creating Reflector"),this.reflector=new Reflector({hostname:window.location.hostname,developerToken:this.developerToken,getUserToken:()=>this.userToken,startingUserToken:getCookie($e.USER_TOKEN),onRequestsComplete:()=>{this.userToken!==getCookie($e.USER_TOKEN)&&(De.debug("StoreKit.onRequestsComplete called, resetting"),this.updateUserTokenFromStorage(),this._cids={})},allowMultiReflection:!(null==n?void 0:n.disableAuthBridge)}),this.addEventListener("userTokenDidChange",this.reflector.onUserTokenChange)),this.updateUserTokenFromStorage(),this.developerToken&&this.userTokenIsValid&&(this._restrictedEnabled=this.restrictedEnabled,this.shouldDisplayPrivacyLink(this.bundleId).catch(()=>{})),this._storefrontCountryCode=this.storefrontCountryCode,this.whenAuthCompleted=Promise.resolve(),isNodeEnvironment$1())||(this._processLocationHash(window.location.hash),"cookie"===this.persist&&(null===(d=this.reflector)||void 0===d||d.refresh()))}}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([((e=300)=>(n,d,p)=>{if(void 0===p||"function"!=typeof p.value)throw new TypeError(`Only methods can be decorated with @CachedResult, but ${d} is not a method.`);return{configurable:!0,get:function(){const n=p.value,h=1e3*e;let y,_=-1;function cachedResultMethod(){return _cachedResultMethod.apply(this,arguments)}function _cachedResultMethod(){return(_cachedResultMethod=_async_to_generator$1k((function*(...e){const d=Date.now();return(void 0===y||-1===_||_>0&&d>_+h)&&(_=d,y=yield n.apply(this,e)),y}))).apply(this,arguments)}return cachedResultMethod.updateCache=function(e){_=Date.now(),y=e},cachedResultMethod.getCachedValue=()=>y,Object.defineProperty(this,d,{value:cachedResultMethod,configurable:!0,writable:!0}),cachedResultMethod}}})(900),_ts_metadata$y("design:type",Function),_ts_metadata$y("design:paramtypes",[]),_ts_metadata$y("design:returntype",Promise)],StoreKit.prototype,"_getIsActiveSubscription",null);const Ye=new Logger$1("player"),We=new Logger$1("paf"),Qe=new Logger$1("services"),Je=BooleanDevFlag.register("mk-console-logging"),Xe=StringDevFlag.register("mk-logging-levels"),Ze=$.ERROR;let et=Ze;const tt=new Logger$1("mk",{level:et,handlers:{console:new class{get hasConsole(){return"undefined"!=typeof console}process(e){if(!this.enabled||!this.hasConsole)return;let n="log";if(this.mapLevels){const p=this.levelMapping.get(e.level);void 0!==(d=p)&&d in console&&(n=p)}var d,p;const h=null!==(p=e.args)&&void 0!==p?p:[],y=this.format(e);console[n](y,...h)}constructor(e={}){var n,d,p,h;_define_property$29(this,"enabled",void 0),_define_property$29(this,"mapLevels",void 0),_define_property$29(this,"levelMapping",void 0),_define_property$29(this,"format",void 0),this.enabled=null===(n=e.enabled)||void 0===n||n,this.mapLevels=null===(d=e.mapLevels)||void 0===d||d,this.levelMapping=null!==(p=e.levelMapping)&&void 0!==p?p:D,this.format=null!==(h=e.formatter)&&void 0!==h?h:j}}({enabled:!1}),external:new CallbackHandler(()=>{})}});function applyLoggingLevels(e){!function(e,n){walk(e,(function(e){let d;const p=e.namespace;e.clearLevel(),void 0===e.parent&&void 0!==n["*"]?d=getLoggingLevel(n["*"]):void 0!==n[p]&&(d=getLoggingLevel(n[p])),void 0!==d&&e.setLevel(d)}))}(tt,function(e){const n=getLoggingLevel(e.trim(),{allowShorthands:!0});if(void 0!==n)return{"*":n};const d={},p=e.split(",").filter(e=>""!==e.trim());for(const g of p){var h,y;const e=g.split("=",2);if(2!==e.length)continue;var _;const n=null!==(_=null===(h=e[0])||void 0===h?void 0:h.trim())&&void 0!==_?_:"";var m;const p=getLoggingLevel(null!==(m=null===(y=e[1])||void 0===y?void 0:y.trim())&&void 0!==m?m:"",{allowShorthands:!0});""!==n&&void 0!==p&&(d[n]=p)}return d}(e))}function clearLoggingLevels(){tt.setLevel(et),function(e,n={includeRoot:!0}){walk(e,(function(e){(void 0!==e.parent||n.includeRoot)&&e.clearLevel()}))}(tt,{includeRoot:!1})}function setConsoleOutput(e){tt.handlers.console.enabled=null!=e&&e}function setRootLoggingLevel(e){var n;et=null!==(n=getLoggingLevel(e))&&void 0!==n?n:et}const rt={getLogger:(e="*")=>tt.getByNamespace(null!=e?e:"*"),setConsoleOutput(e){!0===e?(Je.enable(),setConsoleOutput(!0),tt.info("Console output is enabled with level "+tt.levelName)):(Je.disable(),setConsoleOutput(!1))},setLoggingLevels(e,n){""!==e.trim()?(Xe.set(e),applyLoggingLevels(e),rt.setConsoleOutput(null==n||n)):rt.clearLoggingLevels(null!=n&&n)},clearLoggingLevels(e=!1){rt.setConsoleOutput(e),Xe.clear(),clearLoggingLevels()},listLoggers:e=>function(e){const n={};void 0!==e&&(e=e.startsWith("mk/")?e:"mk/"+e);const d=tt.children;for(;d.length>0;){const p=d.shift();if(void 0===p)break;(void 0===e||p.namespace.startsWith(e))&&(n[p.namespace]=p.levelName,d.unshift(...p.children))}return n}(e)};Je.enabled&&rt.setConsoleOutput(Je.enabled),void 0!==Xe.value&&rt.setLoggingLevels(Xe.value,Je.enabled);const AsyncDebounce=(e=100,n)=>(d,p,h)=>{const y=h.value,_=asyncDebounce(y,e,n);h.value=_},asyncDebounce=(e,n=250,d={isImmediate:!1})=>{let p,h;function fulfill(e){return null==e?void 0:e.resolve(d.cancelledValue)}const clearLastPromise=()=>{p&&(p.resolved||(fulfill(p),p.timeoutId&&clearTimeout(p.timeoutId)),p=void 0)},invokeFn=(n,d,h,y)=>{e.apply(n,y).then(e=>{d(e),p&&(p.resolved=!0)}).catch(h)};return d.isImmediate?function(...e){const d=Date.now(),y=this;return h&&d>=h&&clearLastPromise(),h=Date.now()+n,p?fulfill(Promise):new Promise((n,d)=>{p={resolve:n,reject:d},invokeFn(y,n,d,e)})}:function(...e){const d=this;return p&&clearLastPromise(),new Promise((function(h,y){const _=setTimeout(invokeFn.bind(void 0,d,h,y,e),n);p={resolve:h,reject:y,timeoutId:_}}))}};function deprecationWarning(e,n={}){var d;const p=null!==(d=n.message)&&void 0!==d?d:e+" has been deprecated",h=[];n.since&&h.push("since: "+n.since),n.until&&h.push("until: "+n.until),console.warn("Deprecation Warning: "+p+(h.length>0?` (${h.join(", ")})`:""))}function asyncGeneratorStep$1e(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1e(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1e(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1e(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}const nt={},SerialAsync=e=>{let n=Promise.resolve();return(d,p,h)=>{const y=h.value;return h.value=_async_to_generator$1e((function*(...d){return e&&(n=(e=>{let n=nt[e];return n||(n=Promise.resolve(),nt[e]=n),n})(e)),n=n.catch(()=>{}).then(()=>y.apply(this,d)),e&&(nt[e]=n),n})),h}};var it=function(e){return e[e.STANDARD=64]="STANDARD",e[e.HIGH=256]="HIGH",e}({}),ot=function(e){return e.apiStorefrontChanged="apiStorefrontChanged",e.hlsLevelUpdated="hlsLevelUpdated",e.mediaContentComplete="mediaContentComplete",e.playbackPause="playbackPause",e.playbackPlay="playbackPlay",e.playbackScrub="playbackScrub",e.playbackSeek="playbackSeek",e.playbackSkip="playbackSkip",e.playbackStop="playbackStop",e.lyricsPlay="lyricsPlay",e.lyricsStop="lyricsStop",e.playerActivate="playerActivate",e.playerExit="playerExit",e.queueModified="queueModified",e.userActivityIntent="userActivityIntent",e.applicationActivityIntent="applicationActivityIntent",e.timedMetadata="timedMetadata",e}({});class TimingAccuracy{time(e=0){return 1===this.mode?Math.round(e):e}constructor(e=!1){!function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"mode",void 0),this.mode=e?0:1}}const at={audioTrackAdded:"audioTrackAdded",audioTrackChanged:"audioTrackChanged",audioTrackRemoved:"audioTrackRemoved",bufferedProgressDidChange:"bufferedProgressDidChange",drmUnsupported:"drmUnsupported",forcedTextTrackChanged:"forcedTextTrackChanged",mediaCanPlay:"mediaCanPlay",mediaElementCreated:"mediaElementCreated",mediaPlaybackError:"mediaPlaybackError",nowPlayingItemDidChange:"nowPlayingItemDidChange",nowPlayingItemWillChange:"nowPlayingItemWillChange",metadataDidChange:"metadataDidChange",hlsDaterangeUpdated:"player.hls.daterangeUpdated",playbackBitrateDidChange:"playbackBitrateDidChange",playbackDurationDidChange:"playbackDurationDidChange",playbackProgressDidChange:"playbackProgressDidChange",playbackRateDidChange:"playbackRateDidChange",playbackStateDidChange:"playbackStateDidChange",playbackStateWillChange:"playbackStateWillChange",playbackTargetAvailableDidChange:"playbackTargetAvailableDidChange",playbackTargetIsWirelessDidChange:"playbackTargetIsWirelessDidChange",playbackTimeDidChange:"playbackTimeDidChange",playbackVolumeDidChange:"playbackVolumeDidChange",playerTypeDidChange:"playerTypeDidChange",presentationModeDidChange:"presentationModeDidChange",primaryPlayerDidChange:"primaryPlayerDidChange",textTrackAdded:"textTrackAdded",textTrackChanged:"textTrackChanged",textTrackRemoved:"textTrackRemoved",timedMetadataDidChange:"timedMetadataDidChange"};function _define_property$1Q(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class BitrateCalculator{get bitrate(){return this._bitrate}set bitrate(e){this._bitrate!==e&&(this._bitrate=e,this._dispatcher.publish(at.playbackBitrateDidChange,{bitrate:e}))}_calculateAverageDownlink(){return 0===this._downlinkSamples.length?0:this._downlinkSamples.reduce((e,n)=>e+n,0)/this._downlinkSamples.length||0}_recalculateBitrate(e){Ye.debug("_recalculateBitrate",e),this._downlinkSamples.push(e);this._calculateAverageDownlink()>it.STANDARD?(Ye.debug("setting bitrate to",it.HIGH),this.bitrate=it.HIGH):(Ye.debug("setting bitrate to",it.STANDARD),this.bitrate=it.STANDARD)}constructor(e,n=it.STANDARD){var d,p,h;_define_property$1Q(this,"_bitrate",void 0),_define_property$1Q(this,"_dispatcher",void 0),_define_property$1Q(this,"_downlinkSamples",[]),this._bitrate=n,this._dispatcher=e,void 0!==(null===(h=window)||void 0===h||null===(p=h.navigator)||void 0===p||null===(d=p.connection)||void 0===d?void 0:d.downlink)&&this._recalculateBitrate(100*(window.navigator.connection.downlink||0))}}var st=function(e){return e.MUSICKIT="music_kit-integration",e.OTHER="other",e.MINI="mini",e.SONG="song",e.ALBUM="album",e.ALBUM_CLASSICAL="album-classical",e.ARTIST="artist",e.COMPILATION="compilation",e.COMPILATION_CLASSICAL="compilation-classical",e.PLAYLIST="playlist",e.PLAYLIST_CLASSICAL="playlist-classical",e.RADIO="radio",e.SEARCH="search",e.STATION="station",e}({}),ct=function(e){return e[e.UNKNOWN=0]="UNKNOWN",e[e.RADIO=1]="RADIO",e[e.PLAYLIST=2]="PLAYLIST",e[e.ALBUM=3]="ALBUM",e[e.ARTIST=4]="ARTIST",e}({}),lt=function(e){return e[e.NOT_APPLICABLE=0]="NOT_APPLICABLE",e[e.OTHER=1]="OTHER",e[e.TRACK_SKIPPED_FORWARDS=2]="TRACK_SKIPPED_FORWARDS",e[e.PLAYBACK_MANUALLY_PAUSED=3]="PLAYBACK_MANUALLY_PAUSED",e[e.PLAYBACK_SUSPENDED=4]="PLAYBACK_SUSPENDED",e[e.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM=5]="MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM",e[e.PLAYBACK_PAUSED_DUE_TO_INACTIVITY=6]="PLAYBACK_PAUSED_DUE_TO_INACTIVITY",e[e.NATURAL_END_OF_TRACK=7]="NATURAL_END_OF_TRACK",e[e.PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT=8]="PLAYBACK_STOPPED_DUE_TO_SESSION_TIMEOUT",e[e.TRACK_BANNED=9]="TRACK_BANNED",e[e.FAILED_TO_LOAD=10]="FAILED_TO_LOAD",e[e.PAUSED_ON_TIMEOUT=11]="PAUSED_ON_TIMEOUT",e[e.SCRUB_BEGIN=12]="SCRUB_BEGIN",e[e.SCRUB_END=13]="SCRUB_END",e[e.TRACK_SKIPPED_BACKWARDS=14]="TRACK_SKIPPED_BACKWARDS",e[e.NOT_SUPPORTED_BY_CLIENT=15]="NOT_SUPPORTED_BY_CLIENT",e[e.QUICK_PLAY=16]="QUICK_PLAY",e[e.EXITED_APPLICATION=17]="EXITED_APPLICATION",e}({}),ut=function(e){return e[e.Manual=0]="Manual",e[e.Interval=1]="Interval",e[e.SkipIntro=2]="SkipIntro",e[e.Automatic=3]="Automatic",e[e.SkipToLiveManual=4]="SkipToLiveManual",e[e.SkipToLiveAutomatic=5]="SkipToLiveAutomatic",e}({});var dt,pt=function(e){return e[e.REPEAT_UNKNOWN=0]="REPEAT_UNKNOWN",e[e.REPEAT_OFF=1]="REPEAT_OFF",e[e.REPEAT_ONE=2]="REPEAT_ONE",e[e.REPEAT_ALL=3]="REPEAT_ALL",e}({}),ht=function(e){return e[e.SHUFFLE_UNKNOWN=0]="SHUFFLE_UNKNOWN",e[e.SHUFFLE_OFF=1]="SHUFFLE_OFF",e[e.SHUFFLE_ON=2]="SHUFFLE_ON",e}({}),yt=function(e){return e[e.AUTO_UNKNOWN=0]="AUTO_UNKNOWN",e[e.AUTO_OFF=1]="AUTO_OFF",e[e.AUTO_ON=2]="AUTO_ON",e[e.AUTO_ON_CONTENT_UNSUPPORTED=3]="AUTO_ON_CONTENT_UNSUPPORTED",e}({}),ft=function(e){return e[e.NOT_SPECIFIED=0]="NOT_SPECIFIED",e[e.CONTAINER_CHANGED=1]="CONTAINER_CHANGED",e}({}),_t=function(e){return e[e.PLAY_END=0]="PLAY_END",e[e.PLAY_START=1]="PLAY_START",e[e.LYRIC_DISPLAY=2]="LYRIC_DISPLAY",e}({}),vt=function(e){return e[e.INVALID=0]="INVALID",e[e.ITUNES_STORE_CONTENT=1]="ITUNES_STORE_CONTENT",e[e.NON_SONG_CLIP=2]="NON_SONG_CLIP",e[e.AD=3]="AD",e[e.STREAM=4]="STREAM",e[e.AUDIO_AD=5]="AUDIO_AD",e[e.VIDEO_AD=6]="VIDEO_AD",e[e.TIMED_METADATA_PING=7]="TIMED_METADATA_PING",e[e.ARTIST_UPLOADED_CONTENT=8]="ARTIST_UPLOADED_CONTENT",e[e.AGGREGATE_NON_CATALOG_PLAY_TIME=9]="AGGREGATE_NON_CATALOG_PLAY_TIME",e[e.ORIGINAL_CONTENT_MOVIES=10]="ORIGINAL_CONTENT_MOVIES",e[e.ORIGINAL_CONTENT_SHOWS=11]="ORIGINAL_CONTENT_SHOWS",e}({}),mt=function(e){return e[e.AUDIO=0]="AUDIO",e[e.VIDEO=1]="VIDEO",e}({}),gt=function(e){return e[e.AUTO=0]="AUTO",e[e.MANUAL=1]="MANUAL",e}({}),bt=function(e){return e[e.ORIGINATING_DEVICE=0]="ORIGINATING_DEVICE",e[e.PAIRED_WATCH=1]="PAIRED_WATCH",e[e.SONOS=2]="SONOS",e[e.CAR_PLAY=3]="CAR_PLAY",e[e.WEB_AUC=4]="WEB_AUC",e[e.TWITTER_AUC=5]="TWITTER_AUC",e[e.MUSIC_SDK=6]="MUSIC_SDK",e[e.ATV_REMOTE=7]="ATV_REMOTE",e[e.WEBPLAYER=8]="WEBPLAYER",e[e.WHOLE_HOUSE_AUDIO=9]="WHOLE_HOUSE_AUDIO",e[e.MUSICKIT=10]="MUSICKIT",e[e.VW=11]="VW",e[e.UNKNOWN_SOURCE_TYPE=12]="UNKNOWN_SOURCE_TYPE",e[e.AMAZON=13]="AMAZON",e[e.PORSCHE=14]="PORSCHE",e[e.CHROMECAST=15]="CHROMECAST",e[e.WEB_APP=16]="WEB_APP",e[e.MERCEDES_BENZ=17]="MERCEDES_BENZ",e[e.THIRD_PARTY_TV=18]="THIRD_PARTY_TV",e[e.SEAT=19]="SEAT",e[e.CUPRA=20]="CUPRA",e}({}),Pt=function(e){return e[e.EPISODE=1]="EPISODE",e[e.SHOUTCAST=2]="SHOUTCAST",e}({});
/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */
function t(e,n){var d="function"==typeof Symbol&&e[Symbol.iterator];if(!d)return e;var p,h,y=d.call(e),_=[];try{for(;(void 0===n||n-- >0)&&!(p=y.next()).done;)_.push(p.value)}catch(e){h={error:e}}finally{try{p&&!p.done&&(d=y.return)&&d.call(y)}finally{if(h)throw h.error}}return _}!function(e){e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped"}(dt||(dt={}));var St={type:"xstate.init"};function r(e){return void 0===e?[]:[].concat(e)}function o(e){return{type:"xstate.assign",assignment:e}}function i(e,n){return"string"==typeof(e="string"==typeof e&&n&&n[e]?n[e]:e)?{type:e}:"function"==typeof e?{type:e.name,exec:e}:e}function a(e){return function(n){return e===n}}function u(e){return"string"==typeof e?{type:e}:e}function c(e,n){return{value:e,context:n,actions:[],changed:!1,matches:a(e)}}function f(e,n,d){var p=n,h=!1;return[e.filter((function(e){if("xstate.assign"===e.type){h=!0;var n=Object.assign({},p);return"function"==typeof e.assignment?n=e.assignment(p,d):Object.keys(e.assignment).forEach((function(h){n[h]="function"==typeof e.assignment[h]?e.assignment[h](p,d):e.assignment[h]})),p=n,!1}return!0})),p,h]}function s(e,n){void 0===n&&(n={});var d=t(f(r(e.states[e.initial].entry).map((function(e){return i(e,n.actions)})),e.context,St),2),p=d[0],h=d[1],y={config:e,_options:n,initialState:{value:e.initial,actions:p,context:h,matches:a(e.initial)},transition:function(n,d){var p,h,_="string"==typeof n?{value:n,context:e.context}:n,m=_.value,g=_.context,b=u(d),P=e.states[m];if(P.on){var S=r(P.on[b.type]);try{for(var T=function(e){var n="function"==typeof Symbol&&Symbol.iterator,d=n&&e[n],p=0;if(d)return d.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&p>=e.length&&(e=void 0),{value:e&&e[p++],done:!e}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")}(S),k=T.next();!k.done;k=T.next()){var E=k.value;if(void 0===E)return c(m,g);var w="string"==typeof E?{target:E}:E,O=w.target,I=w.actions,$=void 0===I?[]:I,A=w.cond,R=void 0===A?function(){return!0}:A,C=void 0===O,M=null!=O?O:m,D=e.states[M];if(R(g,b)){var j=t(f((C?r($):[].concat(P.exit,$,D.entry).filter((function(e){return e}))).map((function(e){return i(e,y._options.actions)})),g,b),3),x=j[0],N=j[1],L=j[2],U=null!=O?O:m;return{value:U,context:N,actions:x,changed:O!==m||x.length>0||L,matches:a(U)}}}}catch(t){p={error:t}}finally{try{k&&!k.done&&(h=T.return)&&h.call(T)}finally{if(p)throw p.error}}}return c(m,g)}};return y}var l=function(e,n){return e.actions.forEach((function(d){var p=d.exec;return p&&p(e.context,n)}))};function v(e){var n=e.initialState,d=dt.NotStarted,p=new Set,h={_machine:e,send:function(h){d===dt.Running&&(n=e.transition(n,h),l(n,u(h)),p.forEach((function(e){return e(n)})))},subscribe:function(e){return p.add(e),e(n),{unsubscribe:function(){return p.delete(e)}}},start:function(p){if(p){var y="object"==typeof p?p:{context:e.config.context,value:p};n={value:y.value,actions:[],context:y.context,matches:a(y.value)}}return d=dt.Running,l(n,St),h},stop:function(){return d=dt.Stopped,p.clear(),h},get state(){return n},get status(){return d}};return h}const Tt=/(?:st|ra)\.([0-9]+)/,kt=/st\.([0-9]+)/;function asyncGeneratorStep$1d(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1P(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$V(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1P(e,n,d[n])}))}return e}function _object_spread_props$C(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _object_without_properties$2(e,n){if(null==e)return{};var d,p,h=function(e,n){if(null==e)return{};var d,p,h={},y=Object.keys(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||(h[d]=e[d]);return h}(e,n);if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||Object.prototype.propertyIsEnumerable.call(e,d)&&(h[d]=e[d])}return h}const toTimeMeasuredData=e=>{var{timestamp:n}=e;return _object_spread_props$C(_object_spread$V({},_object_without_properties$2(e,["timestamp"])),{"milliseconds-since-play":Date.now()-n})};class PlayActivitySender{get accessToken(){return invoke(this._accessToken)}get musicUserToken(){return invoke(this._musicUserToken)}get url(){return this._isQA?"https://universal-activity-service.itunes.apple.com/qa/play":"https://universal-activity-service.itunes.apple.com/play"}send(e){var n,d=this;return(n=function*(){const n={client_id:d._clientId,event_type:d._eventType,data:ensureArray(e).map(toTimeMeasuredData)};if(0===n.data.length)throw new Error("send() called without any data");const p=d._generateFetchOptions({method:"POST",body:JSON.stringify(n),headers:d.headers()});return yield d._fetch(d.url,p),d._logInfo&&We.info("play activity:",d._sourceType===bt.AMAZON?JSON.stringify(n):n),n},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$1d(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1d(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}baseHeaders(){var e,n;const d=null!==(n=null===(e=this._fetchOptions)||void 0===e?void 0:e.headers)&&void 0!==n?n:{};return d instanceof this._headersClass?new this._headersClass(Array.from(d.entries())):new this._headersClass(d)}headers(){const e=this._preferDSID?"X-Dsid":"media-user-token",n=this.baseHeaders();return n.set("Authorization","Bearer "+this.accessToken),n.set("Content-Type","application/json"),n.set(e,""+this.musicUserToken),this._isQA&&void 0!==this._traceTag&&n.set("Data-Trace-Tag",this._traceTag),n}_generateFetchOptions(e){return _object_spread$V({},this._fetchOptions,e)}constructor(e){var n,d,p,h;_define_property$1P(this,"mode",gt.AUTO),_define_property$1P(this,"_accessToken",void 0),_define_property$1P(this,"_musicUserToken",void 0),_define_property$1P(this,"_bundleId",void 0),_define_property$1P(this,"_clientId",void 0),_define_property$1P(this,"_eventType",void 0),_define_property$1P(this,"_fetch",void 0),_define_property$1P(this,"_fetchOptions",void 0),_define_property$1P(this,"_headersClass",void 0),_define_property$1P(this,"_isQA",!1),_define_property$1P(this,"_logInfo",!1),_define_property$1P(this,"_preferDSID",!1),_define_property$1P(this,"_sourceType",void 0),_define_property$1P(this,"_traceTag",void 0),this._accessToken=e.accessToken,this._bundleId=e.bundleId,this._clientId=e.clientId,this._eventType=e.eventType,this._fetch=null!==(n=e.fetch)&&void 0!==n?n:fetch,this._fetchOptions=null!==(d=e.fetchOptions)&&void 0!==d?d:{},this._headersClass=null!==(p=e.headersClass)&&void 0!==p?p:Headers,this._isQA=null!==(h=e.isQA)&&void 0!==h&&h,this._logInfo=e.logInfo||this._isQA,this._musicUserToken=e.musicUserToken,this._preferDSID=e.preferDSID,this._sourceType=e.sourceType,this._traceTag=e.traceTag}}const fullAppId=(e,n)=>{if(void 0===(null==n?void 0:n.name))return"MusicKitApp/1.0";if(void 0!==e)return e;return`${function(e){return e.toLowerCase().replace(/[-_]+/g," ").replace(/[^\w\s]/g,"").replace(/\b./g,e=>e.toUpperCase()).replace(/\s/g,"")}(n.name)}/${(null==n?void 0:n.version)||"1.0"}`},os=e=>{var n,d;const p=e.toLowerCase();let h,y="Unidentified OS";const _=/mobile/.test(p);var m;_&&/android|adr/.test(p)?(y="Android",h=p.match(/(?:android|adr)\ ((\d+[._])+\d+)/)):_&&/iphone|ipad|ipod/.test(p)?(y="iOS",h=p.match(/os\ ((\d+[._])+\d+)\ like\ mac\ os\ x/)):/tizen/.test(p)?(y="Tizen",h=p.match(/tizen (.*)/)):/web0s|webos/.test(p)?(y="WebOS",h=p.match(/[web0s|webos] (.*)/)):!_&&/cros/.test(p)?y="ChromeOS":!_&&/macintosh/.test(p)?(y="macOS",h=p.match(/os\ x\ ((\d+[._])+\d+)\b/)):!_&&/linux/.test(p)?y="Linux":!_&&/windows/.test(p)&&(y="Windows",h=p.match(/windows ([^\)]*)/));return`${y}/${null!==(m=null==h||null===(d=h[1])||void 0===d||null===(n=d.replace)||void 0===n?void 0:n.call(d,/_/g,"."))&&void 0!==m?m:"0.0"}`},model=e=>"model/"+((null==e?void 0:e.platform)||"Unavailable"),build=e=>{const n=null==e?void 0:e.build;return void 0===n||""===n?"build/0.0.0":"build/"+n};function asyncGeneratorStep$1c(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1O(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$U(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1O(e,n,d[n])}))}return e}function _object_spread_props$B(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const Et={platform:"",userAgent:""};class PlayActivityBase{get accessToken(){return invoke(this._accessToken)}get appID(){return void 0===this._appId&&(this._appId=fullAppId(this._appId,this._appInfo)),this._appId}get deviceName(){return this._deviceName}get musicUserToken(){return invoke(this._musicUserToken)}get navigator(){var e;return null!==(e=this._navigator)&&void 0!==e?e:"undefined"==typeof navigator?Et:navigator}get storefrontId(){return invoke(this._storefrontId)}get userAgent(){var e;return null!==(e=this._userAgent)&&void 0!==e?e:this.navigator.userAgent}get userIsSubscribed(){return invoke(this._userIsSubscribed)}get allowReportingId(){return invoke(this._allowReportingId)}get utcOffsetInSeconds(){if(void 0===this._utcOffsetInSeconds&&void 0!==this._utcOffset&&!isNaN(this._utcOffset)){const e=60*this._utcOffset;this._utcOffsetInSeconds=e<=0?Math.abs(e):-e}return void 0===this._utcOffsetInSeconds||isNaN(this._utcOffsetInSeconds)?-1:this._utcOffsetInSeconds}send(e){var n,d=this;return(n=function*(){return d.sender.send(e)},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$1c(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1c(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}buildDescriptorForPlayParams(e,n,d,p,h){const y="stream"===e.format?vt.STREAM:vt.ITUNES_STORE_CONTENT;return _object_spread$U(_object_spread_props$B(_object_spread$U({},e),{container:d,duration:null!=p?p:0,eventType:n,itemType:y}),h)}buildForPlayParams(e,n,d,p=0,h={},y=!1){return this.build(this.buildDescriptorForPlayParams(e,n,d,p,h),y)}constructor(e,n,d,p){var h,y,_,m,g,b;(_define_property$1O(this,"_accessToken",void 0),_define_property$1O(this,"_musicUserToken",void 0),_define_property$1O(this,"_storefrontId",void 0),_define_property$1O(this,"privateEnabled",void 0),_define_property$1O(this,"siriInitiated",void 0),_define_property$1O(this,"bundleId",void 0),_define_property$1O(this,"buildVersion",void 0),_define_property$1O(this,"clientId",void 0),_define_property$1O(this,"eventType",void 0),_define_property$1O(this,"guid",void 0),_define_property$1O(this,"internalBuild",void 0),_define_property$1O(this,"metricsClientId",void 0),_define_property$1O(this,"preferDSID",void 0),_define_property$1O(this,"sender",void 0),_define_property$1O(this,"sourceType",void 0),_define_property$1O(this,"_appId",void 0),_define_property$1O(this,"_appInfo",void 0),_define_property$1O(this,"_deviceName",void 0),_define_property$1O(this,"_navigator",void 0),_define_property$1O(this,"_utcOffset",void 0),_define_property$1O(this,"_utcOffsetInSeconds",void 0),_define_property$1O(this,"_userAgent",void 0),_define_property$1O(this,"_userIsSubscribed",void 0),_define_property$1O(this,"_allowReportingId",void 0),this._accessToken=e,this._musicUserToken=n,this._storefrontId=d,this.privateEnabled=!1,this.siriInitiated=!1,this.clientId="JSCLIENT",this.eventType="JSPLAY",this.internalBuild=!1,this.preferDSID=!1,this.sourceType=bt.MUSICKIT,this._utcOffset=(new Date).getTimezoneOffset(),this._userIsSubscribed=!0,this._allowReportingId=!1,p)&&(this._appInfo=p.app,this._navigator=p.navigator,this._userAgent=p.userAgent,hasOwn(p,"utcOffset")&&isNaN(p.utcOffset)?this._utcOffsetInSeconds=-1:hasOwn(p,"utcOffset")&&(this._utcOffset=p.utcOffset),this.clientId=p.clientId||"JSCLIENT",this._deviceName=p.deviceName,this.guid=p.guid,this.metricsClientId=p.metricsClientId,this.preferDSID=null!==(_=p.preferDSID)&&void 0!==_&&_,this.sourceType=void 0!==p.sourceType&&"number"==typeof p.sourceType?p.sourceType:bt.MUSICKIT,this._userIsSubscribed=null===(m=p.userIsSubscribed)||void 0===m||m,this._allowReportingId=null!==(g=p.allowReportingId)&&void 0!==g&&g,(null===(y=p.app)||void 0===y?void 0:y.bundleId)&&(this.bundleId=null===(b=p.app)||void 0===b?void 0:b.bundleId));this.buildVersion=((e,n,d,p)=>[fullAppId(e,n),os(p),model(d),build(n)].join(" "))(this._appId,this._appInfo,this.navigator,this.userAgent),this.sender=new PlayActivitySender({bundleId:this.bundleId,accessToken:this._accessToken,clientId:this.clientId,eventType:this.eventType,fetch:null==p?void 0:p.fetch,fetchOptions:null==p?void 0:p.fetchOptions,headersClass:null==p||null===(h=p.fetch)||void 0===h?void 0:h.Headers,isQA:null==p?void 0:p.isQA,logInfo:null==p?void 0:p.logInfo,musicUserToken:this._musicUserToken,preferDSID:this.preferDSID,sourceType:this.sourceType,traceTag:null==p?void 0:p.traceTag})}}const wt=new Map([["play",_t.PLAY_START],["playbackstarted",_t.PLAY_START],["stop",_t.PLAY_END],["playbackstopped",_t.PLAY_END]]);function mapEventTypeString(e){return"number"==typeof e?e:null!==(n=wt.get(e))&&void 0!==n?n:_t.PLAY_END;var n}const Ot=new Map([["exit",lt.EXITED_APPLICATION],["next",lt.TRACK_SKIPPED_FORWARDS],["pause",lt.PLAYBACK_MANUALLY_PAUSED],["playbackfinished",lt.NATURAL_END_OF_TRACK],["playbackstopped",lt.PLAYBACK_MANUALLY_PAUSED],["previous",lt.TRACK_SKIPPED_BACKWARDS],["scrub_begin",lt.SCRUB_BEGIN],["scrub_end",lt.SCRUB_END],["stop",lt.NATURAL_END_OF_TRACK]]);function normalizePlayActivityDescriptor(e){const n=deepClone(e),d=function(e){var n;const d=null!==(n=e.eventType)&&void 0!==n?n:_t.PLAY_START;if("number"==typeof d)return{eventType:d};return{eventTypeString:d,eventType:mapEventTypeString(d)}}(e);return n.eventType=d.eventType,n.eventTypeString=d.eventTypeString,void 0===n.endReasonType&&void 0!==d.eventTypeString&&(n.endReasonType=function(e){if(void 0!==e)return Ot.get(e)}(d.eventTypeString)),!1!==n.reporting&&(n.reporting=!0),n}function _define_property$1N(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$A(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const createHelper=(e,n)=>(d,p,h)=>{const{helpers:y}=h.cache;return e in y||(y[e]=n(d,p,h)),y[e]};const returnAsField=(e,n)=>(...d)=>function(e,n){if(void 0!==n)return{[e]:n}}(e,n(...d)),createFieldFn=(e,n)=>{const normalizeReturnValue=n=>null==n?void 0:{[e]:n};return(d,p,h)=>{const{fields:y}=h.cache;return e in y||(h.cache.fields=_object_spread_props$A(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1N(e,n,d[n])}))}return e}({},y),{[e]:normalizeReturnValue(n(d,p,h))})),h.cache.fields[e]}},createClientFieldFn=(e,n)=>createFieldFn(e,(e,d,{client:p})=>p[n]),It=createFieldFn("event-type",(e,n,d)=>{return void 0===e.eventType?_t.PLAY_START:e.itemType===vt.TIMED_METADATA_PING&&void 0!==e.timedMetadata?_t.PLAY_END:null!==(p=e.eventType)&&void 0!==p?p:_t.PLAY_START;var p}),$t=createHelper("should-include-audio-quality",(e,n,d)=>{var p,h;const y=e.userPreference;return It(e,n,d)["event-type"]===_t.PLAY_END&&void 0!==(null===(p=e.audioQuality)||void 0===p?void 0:p.provided)&&void 0!==(null===(h=e.audioQuality)||void 0===h?void 0:h.targeted)&&void 0!==(null==y?void 0:y.audioQuality)&&void 0!==(null==y?void 0:y.playbackFormat)}),At=createFieldFn("audio-quality-provided",(e,n,d)=>{if(!$t(e,n,d))return;const p=e.audioQuality;if(void 0===(null==p?void 0:p.provided))return;const{provided:h}=p;var y,_,m;return{"audio-sample-rate-in-hz":null!==(y=h.audioSampleRateHz)&&void 0!==y?y:0,"audio-bit-depth":null!==(_=h.audioBitDepth)&&void 0!==_?_:0,"bit-rate-in-bps":null!==(m=h.bitRateBps)&&void 0!==m?m:0,codec:h.codec,"audio-channel-type":h.audioChannelType,"playback-format":h.playbackFormat}}),Rt=createFieldFn("audio-quality-targeted",(e,n,d)=>{if(!$t(e,n,d))return;const p=e.audioQuality;if(void 0===(null==p?void 0:p.targeted))return;const{targeted:h}=p;var y,_,m;return{"audio-sample-rate-in-hz":null!==(y=h.audioSampleRateHz)&&void 0!==y?y:0,"audio-bit-depth":null!==(_=h.audioBitDepth)&&void 0!==_?_:0,"bit-rate-in-bps":null!==(m=h.bitRateBps)&&void 0!==m?m:0,codec:h.codec,"audio-channel-type":h.audioChannelType,"playback-format":h.playbackFormat}}),Ct=createClientFieldFn("bundle-id","bundleId"),Mt=createClientFieldFn("build-version","buildVersion"),Dt=["uploadedVideo","uploadedAudio","uploaded-videos","uploaded-audios"],jt=createHelper("is-auc",({kind:e})=>void 0!==e&&Dt.includes(e)),xt=createHelper("should-send-timed-metadata",({endReasonType:e,eventType:n,itemType:d,timedMetadata:p})=>void 0!==p&&(d===vt.TIMED_METADATA_PING||n===_t.PLAY_START||e===lt.PLAYBACK_MANUALLY_PAUSED)),Nt=createFieldFn("type",(e,n,d)=>{const{id:p,reporting:h}=e;var y;if("-1"===p||!h)switch(null===(y=It(e,n,d))||void 0===y?void 0:y["event-type"]){case _t.PLAY_END:return vt.AGGREGATE_NON_CATALOG_PLAY_TIME;case _t.PLAY_START:if("-1"===p)return vt.INVALID}const{format:_,kind:m,itemType:g}=e;return"musicMovie"===m?vt.ORIGINAL_CONTENT_MOVIES:xt(e,n,d)?g===vt.TIMED_METADATA_PING?g:vt.STREAM:"stream"===_?vt.STREAM:jt(e,n,d)?vt.ARTIST_UPLOADED_CONTENT:null!=g?g:vt.ITUNES_STORE_CONTENT}),Lt=createFieldFn("container-type",(e,n,d)=>{var p,h,y,_;if((null===(p=Nt(e,n,d))||void 0===p?void 0:p.type)===vt.AGGREGATE_NON_CATALOG_PLAY_TIME)return;const m=null!==(_=null===(h=e.container)||void 0===h?void 0:h.type)&&void 0!==_?_:null===(y=e.container)||void 0===y?void 0:y.kind;if("number"==typeof m)return m;switch(m){case"album":case"albums":case"library-albums":return ct.ALBUM;case"artist":case"artists":case"library-artists":return ct.ARTIST;case"playlist":case"playlists":case"library-playlists":return ct.PLAYLIST;case"radio":case"radioStation":case"station":case"stations":return ct.RADIO;default:return ct.UNKNOWN}});function _define_property$1M(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const Ut=[returnAsField("album-adam-id",(e,n,d)=>{var p;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])!==ct.ALBUM)return;const{container:h}=e,y=null==h?void 0:h.id;return void 0===y||isLibraryType(y)?void 0:y}),returnAsField("cloud-album-id",(e,n,d)=>{var p;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])!==ct.ALBUM)return;const{container:h}=e,y=null==h?void 0:h.id;return void 0!==y&&isLibraryType(y)?y:void 0}),returnAsField("global-playlist-id",(e,n,d)=>{var p;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])!==ct.PLAYLIST)return;const{container:h}=e;var y;const _=null!==(y=null==h?void 0:h.catalogId)&&void 0!==y?y:null==h?void 0:h.globalId;return(null==h?void 0:h.isLibrary)&&_?_:isLibraryType(null==h?void 0:h.id)||null==h?void 0:h.id}),returnAsField("playlist-version-hash",(e,n,d)=>{var p;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])!==ct.PLAYLIST)return;const{container:h}=e,y=null==h?void 0:h.versionHash;return void 0!==y&&""!==y?y:void 0}),returnAsField("station-hash",(e,n,d)=>{var p,h;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])!==ct.RADIO)return;const y=null===(h=e.container)||void 0===h?void 0:h.stationHash;return void 0!==y&&""!==y?y:void 0}),returnAsField("station-id",(e,n,d)=>{var p,h;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])===ct.RADIO)return null===(h=e.container)||void 0===h?void 0:h.id}),returnAsField("station-personalized-id",(e,n,d)=>{var p,h;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])!==ct.RADIO)return;const y=null===(h=e.container)||void 0===h?void 0:h.id;return void 0!==y&&kt.test(y)?parseInt(y.replace(kt,"$1"),10):void 0}),returnAsField("universal-library-id",(e,n,d)=>{var p;if((null===(p=Lt(e,n,d))||void 0===p?void 0:p["container-type"])!==ct.PLAYLIST)return;const{container:h}=e;var y;const _=null!==(y=null==h?void 0:h.catalogId)&&void 0!==y?y:null==h?void 0:h.globalId,m=null==h?void 0:h.id;if(void 0!==m)if((null==h?void 0:h.isLibrary)&&_){if(""!==m)return m}else if(isLibraryType(m))return m})],Ft=createFieldFn("container-ids",(e,n,d)=>{var p;if((null===(p=Nt(e,n,d))||void 0===p?void 0:p.type)===vt.AGGREGATE_NON_CATALOG_PLAY_TIME)return;const h=Ut.reduce((p,h)=>function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1M(e,n,d[n])}))}return e}({},p,h(e,n,d)),Object.create(null));return isEmpty(h)?void 0:h}),Kt=createClientFieldFn("developer-token","accessToken"),Bt=createClientFieldFn("device-name","deviceName"),Vt=createFieldFn("display-type",(e,n,d)=>{var p,h;if((null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])===_t.LYRIC_DISPLAY)return null===(h=e.lyricDescriptor)||void 0===h?void 0:h.displayType}),Gt=createHelper("initial-start-position-in-milliseconds",({position:e=0,startPositionInMilliseconds:n})=>n||Math.round(1e3*e)),qt=createFieldFn("end-position-in-milliseconds",(e,n,d)=>{var p;switch(null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"]){case _t.LYRIC_DISPLAY:var h;if(void 0===(null===(h=e.lyricDescriptor)||void 0===h?void 0:h.duration))return;return Math.round(e.lyricDescriptor.duration);case _t.PLAY_START:return;default:if(n&&void 0===n.position)return;return e.endPositionInMilliseconds||Gt(e,n,d)}}),Ht=createHelper("is-private",({id:e,reporting:n})=>"-1"===e||!n),zt=createFieldFn("end-reason-type",(e,n,d)=>{var p;if(!n||void 0!==(null==n?void 0:n.position))return(null===(p=Nt(e,n,d))||void 0===p?void 0:p.type)===vt.TIMED_METADATA_PING&&void 0!==e.timedMetadata||Ht(e,n,d)&&e.eventType===_t.PLAY_END?lt.NOT_APPLICABLE:e.endReasonType}),{CONTAINER_CHANGED:Yt,NOT_SPECIFIED:Wt}=ft,Qt=createFieldFn("event-reason-hint-type",(e,n,d)=>{var p,h;if((null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])!==_t.PLAY_START)return;const y=e.container;return void 0===y?Wt:!1===n?d.isAlexa?Wt:Yt:(null==n||null===(h=n.container)||void 0===h?void 0:h.id)!==y.id?Yt:Wt}),Jt=createFieldFn("feature-name",(e,n,d)=>{var p,h,y;if((null===(p=Nt(e,n,d))||void 0===p?void 0:p.type)===vt.AGGREGATE_NON_CATALOG_PLAY_TIME)return;return""+(null!==(y=null===(h=e.container)||void 0===h?void 0:h.name)&&void 0!==y?y:st.MUSICKIT)}),Xt=createClientFieldFn("guid","guid"),Zt=createHelper("should-have-auc-adam-id",jt),er=createHelper("should-have-radio-adam-id",({id:e,container:n})=>Tt.test(e)||"radioStation"===(null==n?void 0:n.kind)),tr=createHelper("is-library-item-or-library-type",({id:e,isLibrary:n},d,p)=>n||isLibraryType(e)),rr=createHelper("catalog-id",({catalogId:e,container:n})=>null!=e?e:null==n?void 0:n.catalogId),nr=createHelper("is-library-item-with-catalog-id",(e,n,d)=>e.isLibrary&&!!rr(e,n,d));function _define_property$1L(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const ir=[returnAsField("auc-adam-id",(e,n,d)=>{if(!Ht(e,n,d)&&!er(e,n,d))return Zt(e,n,d)?e.id:void 0}),returnAsField("cloud-id",(e,n,d)=>{var p;const{id:h}=e,y=void 0!==h&&""!==h;return Ht(e,n,d)&&(null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])===_t.PLAY_START&&y&&"-1"!==h?h:er(e,n,d)||Zt(e,n,d)?e.cloudId:nr(e,n,d)&&y||tr(e,n,d)?h:e.cloudId}),returnAsField("lyric-id",(e,n,d)=>{var p,h;if((null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])===_t.LYRIC_DISPLAY)return null===(h=e.lyricDescriptor)||void 0===h?void 0:h.id}),returnAsField("purchased-adam-id",(e,n,d)=>e.purchasedId),returnAsField("reporting-adam-id",(e,n,d)=>{if(!0!==d.client.allowReportingId)return;var p;return(null!==(p=It(e,n,d))&&void 0!==p?p:{})["event-type"],tr(e,n,d)?e.reportingId:void 0}),returnAsField("radio-adam-id",(e,n,d)=>{if(Ht(e,n,d))return;const{container:p,id:h}=e;return Tt.test(h)||"radioStation"===(null==p?void 0:p.kind)?parseInt((""+h).replace(Tt,"$1"),10):void 0}),returnAsField("subscription-adam-id",(e,n,d)=>{if(!(Ht(e,n,d)||er(e,n,d)||Zt(e,n,d))){if(nr(e,n,d))return rr(e,n,d);if(!tr(e,n,d))return e.id}})],or=createFieldFn("ids",(e,n,d)=>{var p;if((null===(p=Nt(e,n,d))||void 0===p?void 0:p.type)===vt.AGGREGATE_NON_CATALOG_PLAY_TIME)return;const h=ir.reduce((p,h)=>function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1L(e,n,d[n])}))}return e}({},p,h(e,n,d)),Object.create(null));return isEmpty(h)?void 0:h}),ar=createClientFieldFn("internal-build","internalBuild"),sr=createFieldFn("is-collaborative",(e,n,d)=>{var p;return!0===(null===(p=e.container)||void 0===p?void 0:p.isCollaborative)||void 0}),cr=createFieldFn("lyric-language",(e,n,d)=>{var p,h;if((null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])===_t.LYRIC_DISPLAY)return null===(h=e.lyricDescriptor)||void 0===h?void 0:h.language}),lr=createHelper("has-episode-streaming-kind",({streamingKind:e},n,d)=>e===Pt.EPISODE),ur=createHelper("is-stream",(e,n,d)=>{var p;return(null===(p=Nt(e,n,d))||void 0===p?void 0:p.type)===vt.STREAM}),dr=createHelper("is-live-stream",(e,n,d)=>ur(e,n,d)&&!lr(e,n,d)),pr=createFieldFn("media-duration-in-milliseconds",(e,n,d)=>{var p;const h=null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"];if(h===_t.LYRIC_DISPLAY)return 0;if(dr(e,n,d))return 0;const y=Math.round(1e3*e.duration);if(h===_t.PLAY_START)return y;var _,m;const g=null!==(m=e.startPositionInMilliseconds)&&void 0!==m?m:Math.round(1e3*(null!==(_=e.position)&&void 0!==_?_:0));return g>1e3*e.duration?g:y}),{AUDIO:hr,VIDEO:yr}=mt,fr=createFieldFn("media-type",(e,n,d)=>{var p;if((null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])===_t.LYRIC_DISPLAY)return hr;const{kind:h,mediaType:y}=e;if("number"==typeof y)return y;const _="string"==typeof y?y:h;return _&&/video|movie/i.test(_)?yr:hr}),_r=createClientFieldFn("metrics-client-id","metricsClientId"),vr=createFieldFn("offline",()=>!1),mr=createFieldFn("persistent-id",()=>generateUUID()),gr=createFieldFn("play-mode",(e,n,d)=>{var p,h,y,_,m;if((null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])===_t.LYRIC_DISPLAY||(null===(h=Nt(e,n,d))||void 0===h?void 0:h.type)===vt.AGGREGATE_NON_CATALOG_PLAY_TIME)return{"auto-play-mode":null!==(y=gr.autoplayMode)&&void 0!==y?y:0,"repeat-play-mode":null!==(_=gr.repeatPlayMode)&&void 0!==_?_:0,"shuffle-play-mode":null!==(m=gr.shufflePlayMode)&&void 0!==m?m:0};const g=invoke(e.playMode);var b,P,S;return void 0!==g?{"auto-play-mode":null!==(b=g.autoplayMode)&&void 0!==b?b:0,"repeat-play-mode":null!==(P=g.repeatPlayMode)&&void 0!==P?P:0,"shuffle-play-mode":null!==(S=g.shufflePlayMode)&&void 0!==S?S:0}:void 0}),br=createClientFieldFn("private-enabled","privateEnabled"),Pr=createFieldFn("reco-data",(e,n,d)=>{var p,h;if((null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"])!==_t.LYRIC_DISPLAY&&(null===(h=Nt(e,n,d))||void 0===h?void 0:h.type)!==vt.AGGREGATE_NON_CATALOG_PLAY_TIME)return e.recoData}),Sr=createClientFieldFn("sb-enabled","userIsSubscribed"),Tr=createClientFieldFn("siri-initiated","siriInitiated"),kr=createClientFieldFn("source-type","sourceType"),Er=createFieldFn("start-position-in-milliseconds",(e,n,d)=>{var p,h;const y=null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"];return y===_t.LYRIC_DISPLAY||(null===(h=Nt(e,n,d))||void 0===h?void 0:h.type)===vt.AGGREGATE_NON_CATALOG_PLAY_TIME||dr(e,n,d)?0:y===_t.PLAY_START?Gt(e,n,d):null!==(m=null!==(_=e.startPositionInMilliseconds)&&void 0!==_?_:previousPosition(n))&&void 0!==m?m:0;var _,m}),previousPosition=e=>e&&void 0!==e.position?Math.round(1e3*e.position):0,wr=createClientFieldFn("store-front","storefrontId"),Or=createFieldFn("timed-metadata",(e,n,d)=>{var p,h;const y=e.timedMetadata;if(void 0===y)return;const _=null===(p=It(e,n,d))||void 0===p?void 0:p["event-type"];return(null===(h=zt(e,n,d))||void 0===h?void 0:h["end-reason-type"])!==lt.SCRUB_END&&_===_t.PLAY_END?toHexString(y,0):void 0}),Ir=createFieldFn("timestamp",({timestamp:e},n,d)=>null!=e?e:Date.now()),$r=createClientFieldFn("user-agent","userAgent"),Ar=createFieldFn("user-preference-audio-quality",(e,n,d)=>{var p;if($t(e,n,d))return null===(p=e.userPreference)||void 0===p?void 0:p.audioQuality}),Rr=createFieldFn("user-preference-playback-format",(e,n,d)=>{var p;if($t(e,n,d))return null===(p=e.userPreference)||void 0===p?void 0:p.playbackFormat}),Cr=createFieldFn("user-token",(e,n,{client:d})=>{if(!d.preferDSID)return d.musicUserToken}),Mr=createFieldFn("utc-offset-in-seconds",(e,n,d)=>{var p;return(null===(p=Nt(e,n,d))||void 0===p?void 0:p.type)===vt.AGGREGATE_NON_CATALOG_PLAY_TIME?0:d.client.utcOffsetInSeconds}),Dr={"audio-quality-provided":At,"audio-quality-targeted":Rt,"bundle-id":Ct,"build-version":Mt,"container-ids":Ft,"container-type":Lt,"developer-token":Kt,"device-name":Bt,"display-type":Vt,"end-position-in-milliseconds":qt,"end-reason-type":zt,"event-reason-hint-type":Qt,"event-type":It,"feature-name":Jt,guid:Xt,ids:or,"internal-build":ar,"is-collaborative":sr,"lyric-language":cr,"media-duration-in-milliseconds":pr,"media-type":fr,"metrics-client-id":_r,offline:vr,"persistent-id":mr,"play-mode":gr,"private-enabled":br,"reco-data":Pr,"sb-enabled":Sr,"siri-initiated":Tr,"source-type":kr,"start-position-in-milliseconds":Er,"store-front":wr,"timed-metadata":Or,timestamp:Ir,type:Nt,"user-agent":$r,"user-preference-audio-quality":Ar,"user-preference-playback-format":Rr,"user-token":Cr,"utc-offset-in-seconds":Mr};function _define_property$1K(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$Q(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1K(e,n,d[n])}))}return e}function _object_spread_props$z(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}let jr=0;function _define_property$1J(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$y(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const buildPlayActivityData$1=(e,n,d,p=!1)=>{const h=((e,...n)=>_object_spread_props$z(_object_spread$Q({},e,Object.assign({},...n)),{cache:{fields:Object.assign({},...n.map(e=>{var n;return null==e||null===(n=e.cache)||void 0===n?void 0:n.fields})),helpers:Object.assign({},...n.map(e=>{var n;return null==e||null===(n=e.cache)||void 0===n?void 0:n.helpers}))}}))("boolean"==typeof p?((e={},n)=>_object_spread$Q({id:(jr++).toFixed(0),client:n,isAlexa:!1},e))({isAlexa:p},e):_object_spread_props$y(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1J(e,n,d[n])}))}return e}({},p),{client:e}));return n=normalizePlayActivityDescriptor(n),d&&(d=normalizePlayActivityDescriptor(d)),Object.assign(Object.create(null),...Object.values(Dr).map(e=>null==e?void 0:e(n,d,h)))};function _define_property$1I(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$O(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1I(e,n,d[n])}))}return e}function _object_spread_props$x(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _define_property$1H(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$N(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1H(e,n,d[n])}))}return e}function _object_spread_props$w(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function asyncGeneratorStep$1b(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1b(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1b(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1b(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1G(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$v(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}class LyricsPlayActivity extends PlayActivityBase{get state(){return this._machine.state.value}play(e){var n=this;return _async_to_generator$1b((function*(){var d;if("playing"===n.state)throw Error("lyrics are already being displayed. Did you forget to stop them?");if(void 0===e)throw Error("Missing descriptor for lyrics play");We.info(`Staring tracking: lyricsId=${null===(d=e.lyricDescriptor)||void 0===d?void 0:d.id}, itemId=${e.id}, catalogId=${e.catalogId}`),n.startDescriptor=e,n._machine.send({type:"play"})}))()}stop(){var e=this;return _async_to_generator$1b((function*(){var n;if("playing"!==e.state)throw Error("lyrics are not being displayed. Did you forget to display them?");if(void 0===e.startDescriptor)throw Error("Missing start descriptor for lyrics stop");We.info(`Stopping tracking: lyricsId=${null===(n=e.startDescriptor.lyricDescriptor)||void 0===n?void 0:n.id}, itemId=${e.startDescriptor.id}, catalogId=${e.startDescriptor.catalogId}`),e._machine.send({type:"stop"});const d=e._machine.state.context.duration,p=JSON.parse(JSON.stringify(e.startDescriptor));p.lyricDescriptor=_object_spread_props$v(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1G(e,n,d[n])}))}return e}({},p.lyricDescriptor),{duration:Math.round(d)}),We.debug("Clearing tracked descriptor"),e.startDescriptor=void 0;const h=e.build(p,!1);try{We.debug("Sending PAF request with data payload"),yield e.send(h),We.debug("Done sending PAF request")}catch(he){console.error("Error sending Lyrics PAF request: "+he.message),We.error("Error sending Lyrics PAF request: "+he.message)}}))()}exit(){return _async_to_generator$1b((function*(){}))()}build(e,n){return((e,n,d)=>{if(void 0===n)throw new Error("called without a play activity descriptor");const p=_object_spread_props$x(_object_spread$O({},n),{eventType:_t.LYRIC_DISPLAY});return((e,...n)=>n.reduce((e,n)=>n(e),e))(_object_spread_props$x(_object_spread$O({},buildPlayActivityData$1(e,p,d,!1)),{"media-duration-in-milliseconds":0,"media-type":mt.AUDIO,"start-position-in-milliseconds":0,"play-mode":{"auto-play-mode":0,"repeat-play-mode":0,"shuffle-play-mode":0}}),e=>omit(e,["character-display-count","event-reason-hint-type","reco-data"]))})(this,e,n)}constructor(e,n,d,p){super(e,n,d,p),_define_property$1G(this,"_machine",void 0),_define_property$1G(this,"startDescriptor",void 0),this._machine=v(s({id:"lpaf",initial:"idle",context:{initialShowTime:-1,duration:-1},states:{idle:{entry:o(e=>_object_spread_props$w(_object_spread$N({},e),{initialShowTime:void 0,duration:now()-e.initialShowTime})),on:{play:"playing"}},playing:{entry:o(e=>_object_spread_props$w(_object_spread$N({},e),{initialShowTime:now()})),on:{stop:"idle"}}}})).start()}}const createCookieJar=e=>{switch(void 0===e&&(e="browser"),e){case"browser":return{get:getCookie,set:setCookie};case"memory":return((e={})=>({get(n){if(void 0!==n)return e[n]},set(n,d){e[n]=d}}))();default:return e}},empty=(e,n)=>write(e,n,[],"/",0),read=(e,n)=>{const d=e.get(n);if(void 0===d||""===d)return[];return ensureArray(JSON.parse(atob(d)))},write=(e,n,d,p,h,y)=>e.set(n,btoa(JSON.stringify(d)),p,h,y);function asyncGeneratorStep$1a(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1a(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1a(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1a(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1F(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const{AUTO:xr}=gt;class PlayActivityBatchableSender{flush(){var e=this;return _async_to_generator$1a((function*(){const n=read(e.jar,"amupaee");if(void 0!==n&&0!==n.length)try{yield e.sender.send(n),empty(e.jar,"amupaee")}catch(he){throw new Error("flush: "+he.message)}}))()}send(e){var n=this;return _async_to_generator$1a((function*(){if(n.mode===xr&&(Array.isArray(e)||e["end-reason-type"]!==lt.EXITED_APPLICATION))return n.sender.send(e);((e,n,d,p,h,y)=>{write(e,n,[...read(e,n),d],p,h,y)})(n.jar,"amupaee",e,"/")}))()}constructor(e,n){_define_property$1F(this,"sender",void 0),_define_property$1F(this,"jar",void 0),_define_property$1F(this,"mode",void 0),this.sender=e,this.jar=n,this.mode=xr}}function asyncGeneratorStep$19(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$19(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$19(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$19(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1E(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class Timeline{get events(){return this._events}get first(){return this.at(0)}get keys(){return this._keys}get last(){return this.at(this.length-1)}get length(){return this._keys.length}get second(){return this.at(1)}at(e){if(e>this.length-1)throw new Error("Invalid timeline index");const n=this._keys[e];return this._events[n]}before(e){if("number"!=typeof e){const n=[];for(const e in this._events)hasOwn(this._events,e)&&n.push(this._events[e]);e=this._keys[n.indexOf(e)]}const n=this._keys.indexOf(e);if(-1===n)throw new Error("Key not found");if(n>0)return this._events[this._keys[n-1]]}drain(){const e=this._keys.map(e=>this._events[e]);return this.reset(),e}reset(){this._events={},this._keys=[]}pop(){var e=this;return _async_to_generator$19((function*(){const n=e._keys.pop();if(void 0===n)return Promise.reject("TIMELINE IS EMPTY");const d=e._events[n];return delete e._events[n],Promise.resolve(d)}))()}add(e,n){var d=this;return _async_to_generator$19((function*(){return d.push(e,n)}))()}push(e,n=Date.now()){var d=this;return _async_to_generator$19((function*(){for(;-1!==d._keys.indexOf(n);)n++;return d._events[n]=e,d._keys.push(n),Promise.resolve(n)}))()}shift(){var e=this;return _async_to_generator$19((function*(){const n=e._keys.shift();if(void 0===n)return Promise.reject("TIMELINE IS EMPTY");const d=e._events[n];return delete e._events[n],Promise.resolve(d)}))()}unshift(e,n=Date.now()){var d=this;return _async_to_generator$19((function*(){for(;-1!==d._keys.indexOf(n);)n++;return d._events[n]=e,d._keys.unshift(n),Promise.resolve(n)}))()}constructor(){_define_property$1E(this,"_events",{}),_define_property$1E(this,"_keys",[])}}const transitionEvent=e=>({type:e});function deriveTransitionEvent(e){if(e.itemType===vt.TIMED_METADATA_PING)return!1;if(function(e){return e.eventType===_t.PLAY_START}(e))return transitionEvent("play");if(function(e){if(e.eventType!==_t.PLAY_END)return!1;if(void 0===e.endReasonType)throw new Error("PLAY_END activity descriptor requires an endReasonType value");return!0}(e)){const n=e.endReasonType;if(n===lt.SCRUB_BEGIN)return transitionEvent("scrubBegin");if(n===lt.SCRUB_END)return transitionEvent("scrubEnd");if(n===lt.EXITED_APPLICATION)return!1}return transitionEvent("stop")}function _define_property$1D(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$L(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1D(e,n,d[n])}))}return e}function _object_spread_props$u(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _object_without_properties$1(e,n){if(null==e)return{};var d,p,h=function(e,n){if(null==e)return{};var d,p,h={},y=Object.keys(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||(h[d]=e[d]);return h}(e,n);if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||Object.prototype.propertyIsEnumerable.call(e,d)&&(h[d]=e[d])}return h}class MPAFStateMachine{get currentState(){return this.machineService.state}get currentStateName(){return this.currentState.value}matches(e){return this.machineService.state.matches(e)}transition(e,n){const d=deriveTransitionEvent(e);if(!1===d)return this.currentStateName;if(this.machineService.send(d),this.matches("error"))throw new Error(this.machineService.state.context.errorMessage);return this.currentStateName}constructor(){_define_property$1D(this,"machine",void 0),_define_property$1D(this,"machineService",void 0),this.machine=s({id:"mpaf",initial:"idle",context:{},states:{error:{},idle:{on:{play:"playing",stop:"idle",scrubBegin:{target:"scrubbing",actions:o(e=>_object_spread_props$u(_object_spread$L({},e),{stateBeforeScrub:"idle"}))},scrubEnd:{target:"error",actions:["clearStateBeforeScrub","setScrubEndError"]}}},playing:{on:{scrubBegin:{target:"scrubbing",actions:o(e=>_object_spread_props$u(_object_spread$L({},e),{stateBeforeScrub:"playing"}))},stop:"idle",scrubEnd:{target:"error",actions:["clearStateBeforeScrub","setScrubEndError"]}}},scrubbing:{on:{scrubEnd:[{target:"idle",cond:({stateBeforeScrub:e})=>"idle"===e,actions:["clearStateBeforeScrub"]},{target:"playing",actions:["clearStateBeforeScrub"]}]}}}},{actions:{clearStateBeforeScrub:o(e=>_object_without_properties$1(e,["stateBeforeScrub"])),setScrubEndError:o(e=>_object_spread_props$u(_object_spread$L({},e),{errorMessage:"The scrub() method was called with the SCRUB_END action without a previous SCRUB_START descriptor"}))}}),this.machineService=v(this.machine).start()}}function asyncGeneratorStep$18(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$18(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$18(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$18(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1C(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$K(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1C(e,n,d[n])}))}return e}function _object_spread_props$t(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}class StatelessPlayActivity extends PlayActivityBase{build(e,n){return buildPlayActivityData$1(this,e,n,"JSCLIENT"!==this.clientId)}constructor(e,n,d,p){super(e,n,d,p)}}class PlayActivity{get mode(){return this.sender.mode}set mode(e){this.sender.mode=e}get privateEnabled(){return this._paf.privateEnabled}set privateEnabled(e){this._paf.privateEnabled=e}clearTimedMetadata(){this.timedMetadata=void 0}setTimedMetadata(e){this.timedMetadata=e}activate(e=!1){var n=this;return _async_to_generator$18((function*(){if(e)try{yield n.flush()}catch(p){if(!(e=>(e=>{switch(typeof e){case"string":return e;case"object":return e.message?"string"!=typeof e.message?"":e.message:"";default:return""}})(e).includes("send() called without any data"))(p))throw p}const d=n.timeline.last;if(d&&d.endReasonType===lt.EXITED_APPLICATION)return n.timeline.pop();n.clearTimedMetadata()}))()}exit(e=0){var n=this;return _async_to_generator$18((function*(){yield n.stop(e,lt.EXITED_APPLICATION)}))()}pause(e=0){var n=this;return _async_to_generator$18((function*(){yield n.stop(e,lt.PLAYBACK_MANUALLY_PAUSED)}))()}pingTimedMetadata(e,n,d=this.previousDescriptor){var p=this;return _async_to_generator$18((function*(){yield p._addToTimeline(_object_spread_props$t(_object_spread$K({},d),{position:e,itemType:vt.TIMED_METADATA_PING,timedMetadata:n}))}))()}play(e,n=0){var d=this;return _async_to_generator$18((function*(){const p=d.timeline.length>0;if(void 0===e){if(!p)return;const e=d.previousDescriptor;return e.eventType===_t.PLAY_END&&delete e.endReasonType,void(yield d._addToTimeline(_object_spread_props$t(_object_spread$K({},d.sanitizePreviousDescriptor(e)),{eventType:_t.PLAY_START})))}if(p){const e=d.previousDescriptor;if(d._machine.matches("playing")&&!(({id:e,reporting:n=!0,eventType:d})=>("-1"===e||!n)&&d===_t.PLAY_END)(e))return Promise.reject(new Error("The play() method was called without a previous stop() or pause() call."))}yield d._addToTimeline(_object_spread_props$t(_object_spread$K({},e),{eventType:_t.PLAY_START,position:n}))}))()}scrub(e=0,n=lt.SCRUB_BEGIN){var d=this;return _async_to_generator$18((function*(){yield d._addToTimeline(_object_spread_props$t(_object_spread$K({},d.sanitizePreviousDescriptor(d.previousDescriptor)),{eventType:_t.PLAY_END,endReasonType:n,position:e}))}))()}skip(e,n=lt.TRACK_SKIPPED_FORWARDS,d=0){var p=this;return _async_to_generator$18((function*(){yield p.stop(d,n),yield p.play(e)}))()}stop(e=0,n=lt.NATURAL_END_OF_TRACK){var d=this;return _async_to_generator$18((function*(){let p=d.previousDescriptor;if(p.endReasonType===lt.EXITED_APPLICATION&&(yield d.timeline.pop(),empty(d._cookieJar,"amupaee"),p=d.previousDescriptor),d._machine.matches("playing")){const h=_object_spread_props$t(_object_spread$K({},d.sanitizePreviousDescriptor(p)),{eventType:_t.PLAY_END,endReasonType:n,position:e,timedMetadata:d.timedMetadata});yield d._addToTimeline(h)}}))()}build(e,n){if(void 0===e&&void 0===n&&We.warn("You are calling build() from a stateful PAF client. Please, use a stateless client or exit(), pause(), play(), scrub(), skip() or stop() instead."),void 0===e){if(0===this.timeline.length)throw new Error("build() called without a play activity descriptor");e=this.timeline.last}if(void 0===n){if(void 0===(n=this.timeline.before(e))&&e.eventType===_t.PLAY_END)throw new Error("Cannot build() for PLAY_END descriptors without previous descriptors");n=null!=n&&n}return this._paf.build(_object_spread$K({timedMetadata:this.timedMetadata},e),n)}addForPlayParams(e,n,d,p=0,h={}){var y=this;return _async_to_generator$18((function*(){yield y._addToTimeline(y.buildDescriptorForPlayParams(e,n,d,p,h))}))()}buildDescriptorForPlayParams(e,n,d,p=0,h={}){const y="stream"===e.format?vt.STREAM:vt.ITUNES_STORE_CONTENT;return normalizePlayActivityDescriptor(_object_spread$K(_object_spread_props$t(_object_spread$K({},e),{container:d,duration:p,eventType:n,itemType:y}),h))}flush(){return this.sender.flush()}_addToTimeline(e){var n=this;return _async_to_generator$18((function*(){e=_object_spread_props$t(_object_spread$K({},e),{timestamp:Date.now()});const d=n.timeline.length>0&&n.timeline.last;yield n.timeline.add(e);const p=n.build(e,d);yield n.send(p,e)}))()}get previousDescriptor(){const e=this.timeline.last;if(void 0===e)throw new Error("A method was called without a previous descriptor");return omit(e,["timestamp"])}buildForPlayParams(e,n,d,p=0,h={},y=!1){return We.warn("You are using buildsForPlayParams from a stateful PlayActivity. Please, use StatelessPlayActivity instead"),this._paf.buildForPlayParams(e,n,d,p,h,y)}send(e,n){e=ensureArray(e);const d=normalizePlayActivityDescriptor(n);return e.forEach(e=>this._machine.transition(d,e)),this.sender.send(e)}sanitizePreviousDescriptor(e){let n=deepClone(e);return n.itemType===vt.TIMED_METADATA_PING&&(n=omit(n,["itemType"])),n}constructor(e,n,d,p){_define_property$1C(this,"sender",void 0),_define_property$1C(this,"timeline",new Timeline),_define_property$1C(this,"_cookieJar",void 0),_define_property$1C(this,"_paf",void 0),_define_property$1C(this,"_machine",void 0),_define_property$1C(this,"timedMetadata",void 0),this._paf=new StatelessPlayActivity(e,n,d,p),this._cookieJar=createCookieJar(null==p?void 0:p.cookieJar),this.sender=new PlayActivityBatchableSender(this._paf.sender,this._cookieJar),this._machine=new MPAFStateMachine}}const Bind=()=>(e,n,d)=>{if(void 0===d||"function"!=typeof d.value)throw new TypeError(`Only methods can be decorated with @Bind, but ${n} is not a method.`);return{configurable:!0,get:function(){const e=d.value.bind(this);return Object.defineProperty(this,n,{value:e,configurable:!0,writable:!0}),e}}},Nr="mk-player-tsid",Lr=["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"],Ur=["fullscreenElement","webkitFullscreenElement","mozFullScreenElement","msFullscreenElement"],Fr=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],noop=()=>Promise.resolve(),Kr=(e=>{if(void 0===e)return noop;const n=Lr.find(n=>"function"==typeof e.prototype[n]);return"string"!=typeof n?noop:(e=self.document)=>{var d;return null==e||null===(d=e[n])||void 0===d?void 0:d.call(e)}})(Document),Br=(e=>{if(void 0===e)return()=>!1;const n=Ur.find(n=>n in e.prototype);return"string"!=typeof n?()=>!1:(e=self.document)=>!!e[n]})(Document),Vr=(e=>{if(void 0===e)return noop;const n=Fr.find(n=>"function"==typeof e.prototype[n]);return"string"!=typeof n?noop:e=>null==e?void 0:e[n]()})(HTMLElement);function asyncGeneratorStep$17(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$17(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$17(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$17(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}class Fullscreen{exit(){var e=this;return _async_to_generator$17((function*(){if(e.isInFullscreen())return e.stopDispatchingEvents(()=>e.exitFullscreen())}))()}request(e){var n=this;return _async_to_generator$17((function*(){if(void 0!==e)return n.stopDispatchingEvents(()=>n.requestFullscreenForElement(e))}))()}stopDispatchingEvents(e){var n=this;return _async_to_generator$17((function*(){return n.player.windowHandlers.stopListeningToVisibilityChanges(e)}))()}exitFullscreen(){return Kr()}isInFullscreen(){return Br()}requestFullscreenForElement(e){return Vr(e)}constructor(e){!function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"player",void 0),this.player=e}}function asyncGeneratorStep$16(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1A(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class UnsupportedSeeker{start(){Ye.warn("seeker.start is not supported in this playback method")}end(){Ye.warn("seeker.end is not supported in this playback method")}seekToTime(e){return Ye.warn("seekToTime is not supported in this playback method"),Promise.resolve()}constructor(){_define_property$1A(this,"ended",!1)}}class PlayerSeeker{get ended(){return this._ended}get isEngagedInPlayback(){return this._player.isEngagedInPlayback}get stillPlayingSameItem(){return this._currentItem===this._player.nowPlayingItem}end(){Ye.debug("seeker: end"),-1!==this._startTime?this._ended?Ye.warn("seeker: Cannot end the same seeker twice."):(this.dispatchStartEvent(),this.dispatchEndEvent()):Ye.warn("seeker: Cannot end a seeker before starting it.")}seekToTime(e){var n,d=this;return(n=function*(){if(Ye.debug("seeker: seekToTime",e),!d.ended)return d.stillPlayingSameItem||(d._currentItem=d._player.nowPlayingItem,d._startTime=0),d._lastSeekedTime=e,d._player.seekToTime(e);Ye.warn("seeker: Cannot seek once the seeker has ended")},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$16(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$16(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}start(){Ye.debug("seeker: start"),-1===this._startTime?(this._currentItem=this._player.nowPlayingItem,this._startTime=this._player.currentPlaybackTime,this._lastSeekedTime=this._startTime):Ye.warn("seeker: Cannot start same seeker twice")}dispatch(e,n){this.isEngagedInPlayback?(Ye.debug("seeker: dispatch",e),this._player.dispatch(e,n)):Ye.debug("seeker: do not dispatch because isEngagedInPlayback",this.isEngagedInPlayback)}dispatchStartEvent(){this.stillPlayingSameItem||(this._startTime=0,this._lastSeekedTime=0),this.dispatch(ot.playbackScrub,{item:this._currentItem,position:this._startTime})}dispatchEndEvent(){this._ended=!0,this.dispatch(ot.playbackScrub,{item:this._currentItem,position:this._lastSeekedTime,endReasonType:lt.SCRUB_END})}constructor(e){_define_property$1A(this,"_ended",!1),_define_property$1A(this,"_lastSeekedTime",-1),_define_property$1A(this,"_player",void 0),_define_property$1A(this,"_startTime",-1),_define_property$1A(this,"_currentItem",void 0),Ye.debug("seeker: new"),this._player=e}}function asyncGeneratorStep$15(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1z(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$x(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$x(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const{visibilityChangeEvent:Gr,visibilityState:qr,unloadEventName:Hr}=(()=>{let e="visibilitychange",n="visibilityState";void 0!==document.mozHidden?(e="mozvisibilitychange",n="mozVisibilityState"):void 0!==document.msHidden?(e="msvisibilitychange",n="msVisibilityState"):document.webkitHidden&&(e="webkitvisibilitychange",n="webkitVisibilityState");return{visibilityChangeEvent:e,visibilityState:n,unloadEventName:"onpagehide"in window?"pagehide":"unload"}})();class WindowHandlers{activate(e=self,n=self.document){n.addEventListener(Gr,this.visibilityChanged),e.addEventListener("storage",this.storage,!1),e.addEventListener(Hr,this.windowUnloaded)}deactivate(){document.removeEventListener(Gr,this.visibilityChanged),window.removeEventListener("storage",this.storage),window.addEventListener(Hr,this.windowUnloaded)}stopListeningToVisibilityChanges(e){var n,d=this;return(n=function*(){d.dispatchVisibilityChanges=!1;const n=yield e();return d.dispatchVisibilityChanges=!0,n},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$15(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$15(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}dispatch(e,n={}){this.player.dispatch(e,n)}storage({key:e,newValue:n}){e===Nr&&this.player.tsidChanged(n)}visibilityChanged(e){const n=e.target[qr];Ye.info("dc visibilityState",n,e,Br()),this.runtimeEnvironment.os.isIOS&&this.dispatchVisibilityChanges&&("hidden"===n?this.dispatch(ot.playerExit,{item:this.player.nowPlayingItem,position:this.player.currentPlaybackTime}):"visible"===n&&this.dispatch(ot.playerActivate))}windowUnloaded(){this.player.isPlaying&&this.dispatch(ot.playerExit,{item:this.player.nowPlayingItem,position:this.player.currentPlaybackTime})}constructor(e,n){_define_property$1z(this,"player",void 0),_define_property$1z(this,"runtimeEnvironment",void 0),_define_property$1z(this,"dispatchVisibilityChanges",!0),this.player=e,this.runtimeEnvironment=n}}function asyncGeneratorStep$14(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$14(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$14(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$14(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1y(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$J(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1y(e,n,d[n])}))}return e}function _ts_metadata$w(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}_ts_decorate$x([Bind(),_ts_metadata$x("design:type",Function),_ts_metadata$x("design:paramtypes",[void 0]),_ts_metadata$x("design:returntype",void 0)],WindowHandlers.prototype,"storage",null),_ts_decorate$x([Bind(),_ts_metadata$x("design:type",Function),_ts_metadata$x("design:paramtypes",["undefined"==typeof Event?Object:Event]),_ts_metadata$x("design:returntype",void 0)],WindowHandlers.prototype,"visibilityChanged",null),_ts_decorate$x([Bind(),_ts_metadata$x("design:type",Function),_ts_metadata$x("design:paramtypes",[]),_ts_metadata$x("design:returntype",void 0)],WindowHandlers.prototype,"windowUnloaded",null);const zr=["canplay","durationchange","ended","error","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","timeupdate","volumechange","waiting"],Yr=["NotAllowedError","NotSupportedError"];class BasePlayer{get bitrate(){return this._bitrateCalculator.bitrate}get currentBufferedProgress(){return this._currentBufferedProgress}get _currentDuration(){return this._targetElement.duration}get _currentTime(){const e=this._targetElement.currentTime,n=this._buffer;var d;return e-(null!==(d=null==n?void 0:n.currentTimestampOffset)&&void 0!==d?d:0)}get currentPlaybackDuration(){const e=this.nowPlayingItem;if(!e)return 0;const n="podcast-episodes"===e.type,d=e.playbackType===ie.encryptedFull||e.playbackType===ie.unencryptedFull,p=e.playbackDuration;return d&&p&&!n?this.calculateTime(p/1e3):this.calculateTime(this._currentDuration)}get currentPlaybackTime(){return this.calculateTime(this._currentTime)}calculateTime(e){return this._timing.time(e)}get currentPlaybackTimeRemaining(){return this.currentPlaybackDuration-this.currentPlaybackTime}get currentPlaybackProgress(){return this._currentPlaybackProgress||0}get hasMediaElement(){return this._targetElement instanceof HTMLElement&&null!==this._targetElement.parentNode}get isEngagedInPlayback(){return!this._stopped&&!this.isPaused()}get isPlaying(){return this.playbackState===be.playing}get isPrimaryPlayer(){return this._isPrimaryPlayer}set isPrimaryPlayer(e){var n;e!==this._isPrimaryPlayer&&(this._isPrimaryPlayer=e,this._isPrimaryPlayer?null===(n=getLocalStorage())||void 0===n||n.setItem(Nr,this._serial):(this._dispatcher.publish(at.primaryPlayerDidChange,{target:this}),this.pause({userInitiated:!1})))}get isReady(){return 0!==this._targetElement.readyState}get nowPlayingItem(){return this._nowPlayingItem}set nowPlayingItem(e){const n=this._dispatcher;if(void 0===e)return n.publish(at.nowPlayingItemWillChange,{item:e}),this._nowPlayingItem=e,void n.publish(at.nowPlayingItemDidChange,{item:e});const d=this._nowPlayingItem,p=this._buffer;(null==d?void 0:d.isEqual(e))||(n.publish(at.nowPlayingItemWillChange,{item:e}),this.isPlaying&&(null==p?void 0:p.currentItem)!==e&&this._pauseMedia(),d&&(Ye.debug("setting state to ended on ",d.title),d.state=oe.ended,d.endMonitoringStateDidChange(),d.endMonitoringStateWillChange()),this._nowPlayingItem=e,Ye.debug("setting state to playing on ",e.title),e.state=oe.playing,e&&e.info&&this._setTargetElementTitle(e.info),n.publish(at.nowPlayingItemDidChange,{item:e}),n.publish(at.playbackDurationDidChange,{currentTarget:this._targetElement,duration:this.currentPlaybackDuration,target:this._targetElement,type:"durationchange"}))}get playbackRate(){return this._targetElement.playbackRate}set playbackRate(e){this._targetElement.playbackRate=e}get defaultPlaybackRate(){return this._targetElement.defaultPlaybackRate}set defaultPlaybackRate(e){this._targetElement.defaultPlaybackRate=e}get playbackState(){return this._playbackState}setPlaybackState(e,n){const d=this._playbackState;if(e===d)return;const p={oldState:d,state:e,nowPlayingItem:n};Ye.debug("BasePlayer.playbackState is changing",p),this._dispatcher.publish(at.playbackStateWillChange,p),this._playbackState=e,this._dispatcher.publish(at.playbackStateDidChange,p)}get playbackTargetAvailable(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetAvailable}set playbackTargetAvailable(e){e!==this._playbackTargetAvailable&&(this._playbackTargetAvailable=e,this._dispatcher.publish(at.playbackTargetAvailableDidChange,{available:e}))}get playbackTargetIsWireless(){return void 0!==window.WebKitPlaybackTargetAvailabilityEvent&&this._playbackTargetIsWireless}set playbackTargetIsWireless(e){e!==this._playbackTargetIsWireless&&(this._playbackTargetIsWireless=e,this._dispatcher.publish(at.playbackTargetIsWirelessDidChange,{playing:e}))}get volume(){return this._targetElement.volume}set volume(e){this._targetElement.volume=e}get isDestroyed(){return this._isDestroyed}get isInitialized(){return this._isInitialized}clearNextManifest(){var e;null===(e=this._buffer)||void 0===e||e.clearNextManifest()}initialize(){var e=this;return _async_to_generator$14((function*(){Ye.trace("BasePlayer.initialize"),e._isInitialized?Ye.warn("Player is already initialized"):(yield e.initializeMediaElement(),yield e.initializeExtension(),e.initializeEventHandlers(),e._dispatcher.publish(at.mediaElementCreated,e._targetElement),e._isInitialized=!0)}))()}initializeEventHandlers(){if(this.windowHandlers.activate(),!this.hasMediaElement)return;const e=this._targetElement;window.WebKitPlaybackTargetAvailabilityEvent&&(e.addEventListener("webkitplaybacktargetavailabilitychanged",e=>{this.playbackTargetAvailable="available"===e.availability}),e.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",e=>{this.playbackTargetIsWireless=e.target===this._targetElement&&!this.playbackTargetIsWireless})),Ye.debug(`Adding event handlers to <HTMLMediaElement id=${this._targetElement.id} />`,this._targetElement),zr.forEach(n=>e.addEventListener(n,this)),this._dispatcher.publish(ot.playerActivate)}removeEventHandlers(){Ye.trace("BasePlayer.removeEventHandlers()"),setTimeout(()=>{Ye.debug(`Removing event handlers from <HTMLMediaElement id=${this._targetElement.id} />`,this._targetElement),zr.forEach(e=>this._targetElement.removeEventListener(e,this)),this.windowHandlers.deactivate()},0)}isPaused(){return this._paused}exitFullscreen(){return this.fullscreen.exit()}requestFullscreen(e){return this.fullscreen.request(e)}newSeeker(){var e;return null===(e=this._seeker)||void 0===e||e.end(),this._seeker=new PlayerSeeker(this),this._seeker}stop(e){var n=this;return _async_to_generator$14((function*(){Ye.debug("BasePlayer.stop",e),yield n._waitForPendingPlay(),n.isPlaying&&(Ye.debug("BasePlayer.play dispatching playbackStop"),n.dispatch(ot.playbackStop,_object_spread$J({item:n.nowPlayingItem,position:n.currentPlaybackTime,startPosition:n.initialPlaybackTime,playingDate:n.currentPlayingDate,startPlayingDate:n.initialPlayingDate},e))),yield n.stopMediaAndCleanup()}))()}stopMediaAndCleanup(e=be.stopped){var n=this;return _async_to_generator$14((function*(){Ye.debug("BasePlayer.stopMediaAndCleanup",e),yield n.stopMediaElement(),n._stopped=!0,n._paused=!1;const d=n.nowPlayingItem;n.nowPlayingItem=void 0,n.initialPlayingDate=void 0,n.initialPlaybackTime=void 0,n.setPlaybackState(e,d)}))()}onPlaybackError(e,n){this.resetDeferredPlay(),this.stop({endReasonType:lt.FAILED_TO_LOAD,userInitiated:!1})}calculatePlaybackProgress(){const e=Math.round(100*(this.currentPlaybackTime/this.currentPlaybackDuration||0))/100;this._currentPlaybackProgress!==e&&(this._currentPlaybackProgress=e,this._dispatcher.publish(at.playbackProgressDidChange,{progress:this._currentPlaybackProgress}))}calculateBufferedProgress(e){const n=Math.round(e/this.currentPlaybackDuration*100);this._currentBufferedProgress!==n&&(this._currentBufferedProgress=n,this._dispatcher.publish(at.bufferedProgressDidChange,{progress:n}))}destroy(){var e,n;if(Ye.debug("BasePlayer.destroy()"),this._isDestroyed=!0,this._dispatcher.unsubscribe(at.mediaPlaybackError,this.onPlaybackError),!this.hasMediaElement)return;const d=this._targetElement;null===(e=this.extension)||void 0===e||e.destroy(d),this.resetMediaElement(),this.removeEventHandlers(),null===(n=d.parentNode)||void 0===n||n.removeChild(d)}handleEvent(e){var n=this;return _async_to_generator$14((function*(){"timeupdate"!==e.type&&Ye.debug("BasePlayer.handleEvent: ",e.type,e);const{nowPlayingItem:d}=n;switch(e.timestamp=Date.now(),e.type){case"canplay":n._dispatcher.publish(at.mediaCanPlay,e),n._playbackState!==be.waiting||n._targetElement.paused||n.setPlaybackState(be.playing,d);break;case"durationchange":n._targetElement.duration!==1/0&&(e.duration=n.currentPlaybackDuration,n._dispatcher.publish(at.playbackDurationDidChange,e),n.calculatePlaybackProgress());break;case"ended":{var p;if(Ye.debug('media element "ended" event'),null===(p=n.nowPlayingItem)||void 0===p?void 0:p.isLinearStream)return void Ye.warn("ignoring ended event for linear stream",e);if(n.isElementCleaned()){Ye.debug('media element already cleaned, ignoring "ended" event');break}const d=n.nowPlayingItem,h=(null==d?void 0:d.playbackDuration)?d.playbackDuration/1e3:n.currentPlaybackTime,y=n.currentPlayingDate;yield n.stopMediaAndCleanup(be.ended),n.dispatch(ot.playbackStop,{item:d,position:h,playingDate:y,endReasonType:lt.NATURAL_END_OF_TRACK});break}case"error":Ye.error("Playback Error",e,n._targetElement.error),n._dispatcher.publish(at.mediaPlaybackError,new MKError(MKError.Reason.MEDIA_PLAYBACK,"Playback Error"));break;case"loadedmetadata":n._dispatcher.publish(at.metadataDidChange,e);break;case"loadstart":n.setPlaybackState(be.loading,d);break;case"pause":n.setPlaybackState(n._stopped?be.stopped:be.paused,d);break;case"play":case"playing":n._paused=!1,n._stopped=!1,n.isPrimaryPlayer=!0,n.setPlaybackState(be.playing,d);break;case"progress":{const e=n._targetElement.buffered;n.handleBufferStart(),1===e.length&&0===e.start(0)&&n.calculateBufferedProgress(e.end(0));break}case"ratechange":n._dispatcher.publish(at.playbackRateDidChange,e);break;case"seeked":n._stopped?n.setPlaybackState(be.stopped,d):n._paused?n.setPlaybackState(be.paused,d):n.playbackState!==be.ended&&n.setPlaybackState(be.playing,d);break;case"seeking":n.playbackState===be.paused?n._paused=!0:n.playbackState===be.stopped&&(n._stopped=!0),n.playbackState!==be.ended&&n.setPlaybackState(be.seeking,d);break;case"timeupdate":{n._dispatcher.publish(at.playbackTimeDidChange,{currentPlaybackDuration:n.currentPlaybackDuration,currentPlaybackTime:n.currentPlaybackTime,currentPlaybackTimeRemaining:n.currentPlaybackTimeRemaining}),n.calculatePlaybackProgress();const e=n._buffer;e&&(e.currentTime=n.currentPlaybackTime);break}case"volumechange":n._dispatcher.publish(at.playbackVolumeDidChange,e);break;case"waiting":n.setPlaybackState(be.waiting,d)}}))()}handleBufferStart(){const{_targetElement:e}=this;void 0!==this.initialPlaybackTime||e.paused||0===e.buffered.length||(this.initialPlaybackTime=this.currentPlaybackTime,this.initialPlayingDate=this.currentPlayingDate,Ye.debug("BasePlayer.handleBufferStart: setting initialPlaybackTime",this.initialPlaybackTime))}pause(e={}){var n=this;return _async_to_generator$14((function*(){yield n._waitForPendingPlay(),n.isPlaying&&(yield n._pauseMedia(),n._paused=!0,n.dispatch(ot.playbackPause,_object_spread$J({item:n.nowPlayingItem,position:n.currentPlaybackTime,playingDate:n.currentPlayingDate},e)))}))()}play(e=!0){var n=this;return _async_to_generator$14((function*(){if(Ye.debug("BasePlayer.play()"),n.nowPlayingItem)try{yield n._playMedia(),Ye.debug("BasePlayer.play dispatching playbackPlay"),n.dispatch(ot.playbackPlay,{userInitiated:e,item:n.nowPlayingItem,position:n.currentPlaybackTime,playingDate:n.currentPlayingDate})}catch(St){if(St&&Yr.includes(St.name)&&Ye.error("BasePlayer.play() rejected due to",St),"NotAllowedError"===(null==St?void 0:St.name))throw new MKError(MKError.Reason.USER_INTERACTION_REQUIRED,"Playback of media content requires user interaction first and cannot be automatically started on page load.")}}))()}preload(){return this._loadMedia()}showPlaybackTargetPicker(){this.playbackTargetAvailable&&this._targetElement.webkitShowPlaybackTargetPicker()}dispatch(e,n){void 0===n.item&&(n.item=this.nowPlayingItem),hasOwn(n,"isPlaying")||(n.isPlaying=this.isPlaying),this._dispatcher.publish(e,n)}tsidChanged(e){void 0!==e&&""!==e&&(this.isPrimaryPlayer=e===this._serial)}_waitForPendingPlay(){var e=this;return _async_to_generator$14((function*(){e._deferredPlay&&(yield e._deferredPlay.promise,e._deferredPlay=void 0)}))()}_loadMedia(){var e=this;return _async_to_generator$14((function*(){Ye.debug("BasePlayer._loadMedia",e._targetElement),e._targetElement.load()}))()}_pauseMedia(){var e=this;return _async_to_generator$14((function*(){e._targetElement.pause()}))()}_playAssetURL(e,n){var d=this;return _async_to_generator$14((function*(){Ye.debug("BasePlayer._playAssetURL",e),d._targetElement.src=e;const p=d._loadMedia();if(n)return Ye.debug("BasePlayer.loadOnly"),void(yield p);yield d._playMedia()}))()}playItemFromUnencryptedSource(e,n,d){var p=this;return _async_to_generator$14((function*(){return(null==d?void 0:d.startTime)&&(e+="#t="+d.startTime),n||p.startPlaybackSequence(),yield p._playAssetURL(e,n),p.finishPlaybackSequence()}))()}_playMedia(){var e=this;return _async_to_generator$14((function*(){Ye.debug("BasePlayer._playMedia",e._targetElement,e.extension);try{yield e._targetElement.play(),e._playbackDidStart=!0}catch(he){throw Ye.error("BasePlayer._playMedia: targetElement.play() rejected",he),he}}))()}_setTargetElementTitle(e){this.hasMediaElement&&(this._targetElement.title=e)}resetDeferredPlay(){this._deferredPlay=void 0}stopMediaElement(){var e=this;return _async_to_generator$14((function*(){Ye.trace("BasePlayer.stopMediaElement()"),e.hasMediaElement&&(Ye.debug("Stopping HTMLMediaElement id="+e._targetElement.id,e._targetElement),e._targetElement.pause(),e.resetMediaElement())}))()}resetMediaElement(){Ye.trace("BasePlayer.cleanupElement()");const e=this._targetElement;e&&!this.isElementCleaned()?(Ye.debug("Resetting HTMLMediaElement",e),e.currentTime=0,e.removeAttribute("src"),e.removeAttribute("title")):Ye.debug("No HTMLMediaElement to reset")}isElementCleaned(){const e=this._targetElement;return!e||0===e.currentTime&&""===e.src&&""===e.title}finishPlaybackSequence(){var e;Ye.debug("BasePlayer.finishPlaybackSequence",this._deferredPlay);const n=null===(e=this._deferredPlay)||void 0===e?void 0:e.resolve(void 0);return this._deferredPlay=void 0,n}startPlaybackSequence(){return Ye.debug("BasePlayer.startPlaybackSequence",this._deferredPlay),this._deferredPlay&&(Ye.warn("Previous playback sequence not cleared"),this.finishPlaybackSequence()),this._deferredPlay=function(){let e,n;return{promise:new Promise((function(d,p){e=d,n=p})),resolve:function(n){null==e||e(n)},reject:function(e){null==n||n(e)}}}(),this._deferredPlay.promise}toString(){return`<${this.constructor.name} id="${this.id}" isInitialized=${this.isInitialized} isDestroyed=${this.isDestroyed} />`}constructor(e){var n;_define_property$1y(this,"id",generateUUID()),_define_property$1y(this,"privateEnabled",!1),_define_property$1y(this,"siriInitiated",!1),_define_property$1y(this,"windowHandlers",void 0),_define_property$1y(this,"_dispatcher",void 0),_define_property$1y(this,"_buffer",void 0),_define_property$1y(this,"services",void 0),_define_property$1y(this,"_context",void 0),_define_property$1y(this,"_currentBufferedProgress",0),_define_property$1y(this,"initialPlayingDate",void 0),_define_property$1y(this,"initialPlaybackTime",void 0),_define_property$1y(this,"_nowPlayingItem",void 0),_define_property$1y(this,"_paused",!1),_define_property$1y(this,"_playbackDidStart",!1),_define_property$1y(this,"_playbackState",be.none),_define_property$1y(this,"_stopped",!1),_define_property$1y(this,"_timing",void 0),_define_property$1y(this,"_bitrateCalculator",void 0),_define_property$1y(this,"_currentPlaybackProgress",0),_define_property$1y(this,"_isPrimaryPlayer",!0),_define_property$1y(this,"_playbackTargetAvailable",!1),_define_property$1y(this,"_playbackTargetIsWireless",!1),_define_property$1y(this,"_seeker",void 0),_define_property$1y(this,"_serial",Date.now().toString()),_define_property$1y(this,"fullscreen",void 0),_define_property$1y(this,"_isDestroyed",!1),_define_property$1y(this,"_isInitialized",!1),_define_property$1y(this,"_deferredPlay",void 0),this.services=e.services,this._dispatcher=e.services.dispatcher,this._timing=e.services.timing,this._context=e.context||{},this.privateEnabled=e.privateEnabled||!1,this.siriInitiated=e.siriInitiated||!1,this._bitrateCalculator=e.services.bitrateCalculator,this.windowHandlers=new WindowHandlers(this,e.services.runtime),this.fullscreen=new Fullscreen(this),null===(n=getLocalStorage())||void 0===n||n.setItem(Nr,this._serial),this._dispatcher.subscribe(at.mediaPlaybackError,this.onPlaybackError)}}function generateAssetUrl(e,n){if("Preview"===e.type&&!isEmptyString$1(e.previewURL,{trim:!0}))return e.previewURL;if(!e.assetURL)throw new Error("Cannot generate asset URL");const d={};return(null==n?void 0:n.startOver)&&(d.startOver=!0),(null==n?void 0:n.bingeWatching)&&(d.bingeWatching=!0),e.supportsLinearScrubbing&&(d.linearScrubbingSupported=!0),e.assetURL.match(/xapsub=accepts-css/)||(d.xapsub="accepts-css"),buildURL(e.assetURL,d)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$w("design:type",Function),_ts_metadata$w("design:paramtypes",[String,void 0===MKError?Object:MKError]),_ts_metadata$w("design:returntype",void 0)],BasePlayer.prototype,"onPlaybackError",null);var Wr=function(e){return e.playbackLicenseError="playbackLicenseError",e.playbackSessionError="playbackSessionError",e.manifestParsed="manifestParsed",e.audioCodecIdentified="audioCodecIdentified",e.audioTracksSwitched="audioTracksSwitched",e.audioTracksUpdated="audioTracksUpdated",e.textTracksSwitched="textTracksSwitched",e.textTracksUpdated="textTracksUpdated",e.inlineStylesParsed="inlineStylesParsed",e.levelUpdated="levelUpdated",e}({}),Qr=function(e){return e.MP4="audio/mp4",e.AVC1="video/mp4",e}({});function toPersistedTrack(e){return{label:e.label,kind:e.kind,language:e.language}}function saveTrack(e,n){var d,p;d=e,p=toPersistedTrack(n),hasLocalStorage()&&(p?getLocalStorage().setItem(d,JSON.stringify(p)):getLocalStorage().setItem(d,""))}function loadTrack(e){return getJsonFromLocalStorage(e)}function trackEquals(e,n){const d=toPersistedTrack(e),p=toPersistedTrack(n);for(const h of Object.keys(d))if(d[h]!==p[h])return!1;return!0}function _define_property$1x(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class AudioTrackManager{get isDestroyed(){return this._isDestroyed}get currentTrack(){return this.tracks.find(e=>e.enabled)}set currentTrack(e){e&&(Ye.debug("MEDIA_TRACK Setting audio track "+e.label),this.extensionTracks?(Ye.debug(`MEDIA_TRACK Setting track on extension ${e.id}-${e.label}`),this.extensionTracks.audioTrack=e):(Ye.debug("MEDIA_TRACK disabling all audio tracks"),Array.from(this.mediaElement.audioTracks).forEach(n=>{n!==e&&(n.enabled=!1)}),Ye.debug("MEDIA_TRACK enabling",e),e.enabled=!0),!this._canPersistSelection||function(e){return void 0!==e.characteristics&&e.characteristics.includes("com.apple.amp.appletv.home-team-radio")}(e)||function(e){return void 0!==e.characteristics&&e.characteristics.includes("com.apple.amp.appletv.away-team-radio")}(e)||(saveTrack("mk-audio-track",e),Ye.debug(`MEDIA_TRACK save track selection ${e.language},${e.label},${e.kind}`)))}get tracks(){return this.extensionTracks?this._extensionTracks||this.extensionTracks.audioTracks||[]:Array.from(this.mediaElement.audioTracks)}destroy(){if(this._isDestroyed=!0,this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(Wr.audioTracksUpdated,this.onExtensionAudioTracksUpdated),e.removeEventListener(Wr.audioTracksSwitched,this.onExtensionAudioTrackSwitched)}else{if(!this.mediaElement.audioTracks)return;this.mediaElement.audioTracks.removeEventListener("addtrack",this.onAudioTrackAdded),this.mediaElement.audioTracks.removeEventListener("change",this.onAudioTrackChanged),this.mediaElement.audioTracks.removeEventListener("removetrack",this.onAudioTrackRemoved)}}onExtensionAudioTracksUpdated(e){var n;Ye.debug("MEDIA_TRACK Extension audio tracks updated",e),this._extensionTracks=e;const d=loadTrack("mk-audio-track");let p;if((null===(n=this.tracks)||void 0===n?void 0:n.length)>=0&&void 0!==d&&(void 0===this.currentTrack||!trackEquals(this.currentTrack,d))&&(p=this.tracks.find(e=>trackEquals(e,d))),p)this.currentTrack=p;else{var h,y;const e=null===(h=this.tracks)||void 0===h?void 0:h.find(e=>e.isDefault),n=null!=e?e:null===(y=this.tracks)||void 0===y?void 0:y[0];Ye.debug("Setting current track to:",n),this._canPersistSelection=!1,this.currentTrack=n,this._canPersistSelection=!0}this.dispatcher.publish(at.audioTrackAdded,e)}onExtensionAudioTrackSwitched(e){Ye.debug("MEDIA_TRACK Extension audio track switched",e);const{selectedId:n}=e;if(this._extensionTracks){const updateTrackEnabledState=e=>{e.enabled=n===e.id};this._extensionTracks.forEach(updateTrackEnabledState)}this.dispatcher.publish(at.audioTrackChanged,e)}onAudioTrackAdded(e){const n=loadTrack("mk-audio-track");void 0!==n&&trackEquals(e.track,n)&&(Ye.debug("Found new track matching persisted track: "+e.track.label),this.currentTrack=e.track),this.dispatcher.publish(at.audioTrackAdded,e)}onAudioTrackChanged(e){this.dispatcher.publish(at.audioTrackChanged,e)}onAudioTrackRemoved(e){this.dispatcher.publish(at.audioTrackRemoved,e)}constructor(e,n,d){if(_define_property$1x(this,"mediaElement",void 0),_define_property$1x(this,"dispatcher",void 0),_define_property$1x(this,"extensionTracks",void 0),_define_property$1x(this,"_extensionTracks",void 0),_define_property$1x(this,"_isDestroyed",void 0),_define_property$1x(this,"_canPersistSelection",void 0),this.mediaElement=e,this.dispatcher=n,this.extensionTracks=d,this._extensionTracks=[],this._isDestroyed=!1,this._canPersistSelection=!0,this.extensionTracks){Ye.debug("MEDIA_TRACK Initializing audio track manager for hls track events"),this.onExtensionAudioTracksUpdated=this.onExtensionAudioTracksUpdated.bind(this),this.onExtensionAudioTrackSwitched=this.onExtensionAudioTrackSwitched.bind(this);const e=this.extensionTracks;e.addEventListener(Wr.audioTracksUpdated,this.onExtensionAudioTracksUpdated),e.addEventListener(Wr.audioTracksSwitched,this.onExtensionAudioTrackSwitched)}else{if(!e.audioTracks)return;Ye.debug("MEDIA_TRACK Initializing audio track manager for native track events"),this.onAudioTrackAdded=this.onAudioTrackAdded.bind(this),this.onAudioTrackChanged=this.onAudioTrackChanged.bind(this),this.onAudioTrackRemoved=this.onAudioTrackRemoved.bind(this),e.audioTracks.addEventListener("addtrack",this.onAudioTrackAdded),e.audioTracks.addEventListener("change",this.onAudioTrackChanged),e.audioTracks.addEventListener("removetrack",this.onAudioTrackRemoved)}}}const Jr=[],Xr=[];function nextAvailableAudioElement(){let e=Xr.pop();return e?Ye.debug(`dom-helpers: retrieving audio tag, ${Xr.length} remain`):(Ye.debug("dom-helpers: no available audio tags, creating one"),e=document.createElement("audio")),e}function deferPlayback(){fillAvailableElements("audio",Xr),fillAvailableElements("video",Jr),Ye.debug(`dom-helpers: defer playback called.  There are ${Jr.length} available video elements and ${Xr.length} available audio elements.`)}function fillAvailableElements(e,n){let d=100-n.length;for(;d>0;){const p=document.createElement(e);p.load(),n.push(p),d--}}var Zr="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n?n:"undefined"!=typeof self?self:{};function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,n){return e(n={exports:{}},n.exports),n.exports}var en=createCommonjsModule((function(e,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isValidScrollSetting=n.isValidPositionAlignSetting=n.isValidLineAlignSetting=n.isValidLineAndPositionSetting=n.isValidDirectionSetting=n.isValidAlignSetting=n.isValidPercentValue=void 0,n.isValidPercentValue=function(e){return"number"==typeof e&&e>=0&&e<=100},n.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},n.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},n.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},n.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},n.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},n.isValidScrollSetting=function(e){return["","up"].includes(e)}}));unwrapExports(en),en.isValidScrollSetting,en.isValidPositionAlignSetting,en.isValidLineAlignSetting,en.isValidLineAndPositionSetting,en.isValidDirectionSetting,en.isValidAlignSetting,en.isValidPercentValue;var tn=createCommonjsModule((function(e,n){Object.defineProperty(n,"__esModule",{value:!0});const d={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "},p={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},h={v:"title",lang:"lang"},y={rt:"ruby"},_={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class ParserUtility{static parseTimeStamp(e){function computeSeconds(e){const[n,d,p,h]=e.map(e=>e?parseInt(""+e):0);return 3600*n+60*d+p+h/1e3}const n=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return n?n[3]?computeSeconds([n[1],n[2],n[3].substring(1),n[4]]):parseInt(n[1])>59?computeSeconds([n[1],n[2],null,n[4]]):computeSeconds([null,n[1],n[2],n[4]]):null}static parseContent(e,n,m,g=!1){let b=n.text;function nextToken(){if(!b)return null;const e=/^([^<]*)(<[^>]+>?)?/.exec(b);return n=e[1]?e[1]:e[2],b=b.substr(n.length),n;var n}function unescape1(e){return d[e]}function unescape(e){return e.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,unescape1)}function shouldAdd(e,n){return!y[n.dataset.localName]||y[n.dataset.localName]===e.dataset.localName}function createElement(n,d,y){const b=p[n];if(!b)return null;const P=e.document.createElement(b);P.dataset.localName=b;const S=h[n];if(S&&y&&(P[S]=y.trim()),d)if(m[d]){const e=function(e){let n="";for(const d in e)n+=_[d]?_[d]:d+":"+e[d]+";";return n}(m[d]);P.setAttribute("style",e)}else g&&console.info(`WebVTT: parseContent: Style referenced, but no style defined for '${d}'!`);return P}const P=e.document.createElement("div"),S=[];let T,k,E=P;for(;null!==(T=nextToken());)if("<"!==T[0])E.appendChild(e.document.createTextNode(unescape(T)));else{if("/"===T[1]){S.length&&S[S.length-1]===T.substr(2).replace(">","")&&(S.pop(),E=E.parentNode);continue}const n=ParserUtility.parseTimeStamp(T.substr(1,T.length-2));let d;if(n){d=e.document.createProcessingInstruction("timestamp",n.toString()),E.appendChild(d);continue}if(k=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(T),!k)continue;if(d=createElement(k[1],k[2],k[3]),!d)continue;if(!shouldAdd(E,d))continue;k[2],S.push(k[1]),E.appendChild(d),E=d}return P}}n.default=ParserUtility}));unwrapExports(tn);var rn=createCommonjsModule((function(e,n){var d=Zr&&Zr.__decorate||function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_};Object.defineProperty(n,"__esModule",{value:!0}),n.VTTCue=void 0;let p=class{get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number: "+e);this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number: "+e);this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!en.isValidDirectionSetting(e))throw new SyntaxError("An invalid or illegal string was specified for vertical: "+e);this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!en.isValidLineAndPositionSetting(e))throw new SyntaxError("An invalid number or illegal string was specified for line: "+e);this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!en.isValidLineAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: "+e);this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!en.isValidLineAndPositionSetting(e))throw new Error("Position must be between 0 and 100 or auto: "+e);this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!en.isValidPositionAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: "+e);this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100: "+e);this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!en.isValidAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for align: "+e);this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return tn.default.parseContent(window,this,{})}static create(e){if(!e.hasOwnProperty("startTime")||!e.hasOwnProperty("endTime")||!e.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");const n=new this(e.startTime,e.endTime,e.text);return Object.keys(e).forEach(d=>{n.hasOwnProperty(d)&&(n[d]=e[d])}),n}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){const e={};return Object.keys(this).forEach(n=>{this.hasOwnProperty(n)&&"getCueAsHTML"!==n&&"hasBeenReset"!==n&&"displayState"!==n&&(e[n]=this[n])}),e}constructor(e,n,d){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position="auto",this._positionAlign="auto",this._size=100,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=n,this._text=d}};p=d([function(e){let n=e;"undefined"!=typeof window&&null!=window.VTTCue&&(n=window.VTTCue,n.create=e.create,n.fromJSON=e.fromJSON,n.prototype.toJSON=e.prototype.toJSON);return n}],p),n.VTTCue=p}));unwrapExports(rn),rn.VTTCue;var nn=createCommonjsModule((function(e,n){var d=Zr&&Zr.__decorate||function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_};Object.defineProperty(n,"__esModule",{value:!0}),n.VTTRegion=void 0;let p=class{get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!en.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!en.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){const n=e.toLowerCase();if(en.isValidScrollSetting(n))return void(this._scroll=n)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!en.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!en.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!en.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){const e={};return Object.keys(this).forEach(n=>{this.hasOwnProperty(n)&&(e[n]=this[n])}),e}static create(e){const n=new this;return Object.keys(e).forEach(d=>{n.hasOwnProperty(d)&&(n[d]=e[d])}),n}static fromJSON(e){return this.create(JSON.parse(e))}constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}};p=d([function(e){let n=e;"undefined"!=typeof window&&null!=window.VTTRegion&&(n=window.VTTRegion,n.create=e.create,n.fromJSON=e.fromJSON,n.prototype.toJSON=e.prototype.toJSON);return n}],p),n.VTTRegion=p}));unwrapExports(nn),nn.VTTRegion;var on=createCommonjsModule((function(e,n){Object.defineProperty(n,"__esModule",{value:!0})}));unwrapExports(on);var an=createCommonjsModule((function(e,n){var d=Zr&&Zr.__createBinding||(Object.create?function(e,n,d,p){void 0===p&&(p=d),Object.defineProperty(e,p,{enumerable:!0,get:function(){return n[d]}})}:function(e,n,d,p){void 0===p&&(p=d),e[p]=n[d]}),p=Zr&&Zr.__exportStar||function(e,n){for(var p in e)"default"===p||n.hasOwnProperty(p)||d(n,e,p)};Object.defineProperty(n,"__esModule",{value:!0}),n.VTTRegion=n.VTTCue=n.WebVTTParser=n.ParsingError=void 0,Object.defineProperty(n,"VTTCue",{enumerable:!0,get:function(){return rn.VTTCue}}),Object.defineProperty(n,"VTTRegion",{enumerable:!0,get:function(){return nn.VTTRegion}});class ParsingError extends Error{constructor(e,n){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,n?this.message=n:e instanceof ParsingError&&(this.message=e.message)}}n.ParsingError=ParsingError,ParsingError.Errors={BadSignature:new ParsingError(0,"Malformed WebVTT signature."),BadTimeStamp:new ParsingError(1,"Malformed time stamp.")};class Settings{set(e,n){this.get(e)||""===n||(this.values[e]=n)}get(e,n,d){return"object"==typeof n&&"string"==typeof d?this.has(e)?this.values[e]:n[d]:this.has(e)?this.values[e]:n}has(e){return e in this.values}alt(e,n,d){for(let p=0;p<d.length;++p)if(n===d[p]){this.set(e,n);break}}integer(e,n){/^-?\d+$/.test(n)&&this.set(e,parseInt(n,10))}percent(e,n){if(n.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{const d=parseFloat(n);if(d>=0&&d<=100)return this.set(e,d),!0}catch(d){return!1}return!1}constructor(){this.values={}}}class WebVTTParser{static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof ParsingError&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,n,d,p){const h=p?e.split(p):[e];for(const y of h){if("string"!=typeof y)continue;const e=y.split(d);if(2!==e.length)continue;n(e[0],e[1])}}parseCue(e,n,d){const p=e,consumeTimeStamp=()=>{const n=tn.default.parseTimeStamp(e);if(null===n)throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed timestamp: "+p);return e=e.replace(/^[^\sa-zA-Z-]+/,""),n},skipWhitespace=()=>{e=e.replace(/^\s+/,"")};if(skipWhitespace(),n.startTime=consumeTimeStamp(),skipWhitespace(),"--\x3e"!==e.substr(0,3))throw new ParsingError(ParsingError.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): "+p);e=e.substr(3),skipWhitespace(),n.endTime=consumeTimeStamp(),skipWhitespace(),((e,n)=>{const p=new Settings;this.parseOptions(e,(e,n)=>{let h,y;switch(e){case"region":for(let h=d.length-1;h>=0;h--)if(d[h].id===n){p.set(e,d[h].region);break}break;case"vertical":p.alt(e,n,["rl","lr"]);break;case"line":h=n.split(","),y=h[0],p.integer(e,y),p.percent(e,y)&&p.set("snapToLines",!1),p.alt(e,y,["auto"]),2===h.length&&p.alt("lineAlign",h[1],["start","middle","center","end"]);break;case"position":if(h=n.split(","),p.percent(e,h[0]),2===h.length){let e=["line-left","line-right","center","auto","left","start","middle","end","right"];p.alt("positionAlign",h[1],e)}break;case"size":p.percent(e,n);break;case"align":let _=["start","center","end","left","right","middle"];p.alt(e,n,_)}},/:/,/\s/),n.region=p.get("region",null),n.vertical=p.get("vertical",""),n.line=p.get("line",void 0===n.line?"auto":n.line);const h=p.get("lineAlign","start");n.lineAlign="center"===h||"middle"===h?this.middleOrCenter:h,n.snapToLines=p.get("snapToLines",!0),n.size=p.get("size",100);const y=p.get("align","center");n.align="center"===y||"middle"===y?this.middleOrCenter:y,n.position=p.get("position","auto");let _=p.get("positionAlign",{start:"start",left:"start",center:"center",middle:"middle",right:"end",end:"end"},n.align);n.positionAlign="center"===_||"middle"===_?this.middleOrCenter:{start:"start","line-left":"start",left:"start",center:"center",middle:"middle","line-right":"end",right:"end",end:"end"}[_]})(e,n)}parseRegion(e){const n=new Settings;if(this.parseOptions(e,(e,d)=>{switch(e){case"id":n.set(e,d);break;case"width":n.percent(e,d);break;case"lines":n.integer(e,d);break;case"regionanchor":case"viewportanchor":{const p=d.split(",");if(2!==p.length)break;const h=new Settings;if(h.percent("x",p[0]),h.percent("y",p[1]),!h.has("x")||!h.has("y"))break;n.set(e+"X",h.get("x")),n.set(e+"Y",h.get("y"));break}case"scroll":n.alt(e,d,["up"])}},/=/,/\s/),n.has("id")){const e=new nn.VTTRegion;e.width=n.get("width",100),e.lines=n.get("lines",3),e.regionAnchorX=n.get("regionanchorX",0),e.regionAnchorY=n.get("regionanchorY",100),e.viewportAnchorX=n.get("viewportanchorX",0),e.viewportAnchorY=n.get("viewportanchorY",100),e.scroll=n.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:n.get("id"),region:e})}}parseStyle(e){const parseStyles=e=>{const n={},d=e.split(";");for(let p=0;p<d.length;p++)if(d[p].includes(":")){const e=d[p].split(":",2),h=e[0].trim(),y=e[1].trim();""!==h&&""!==y&&(n[h]=y)}return n},n=e.split("}");n.pop();for(const d of n){let e=null,n=null;const p=d.split("{");p[0]&&(e=p[0].trim()),p[1]&&(n=parseStyles(p[1])),e&&n&&(this._styles[e]=n)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,(function(e,n){switch(e){case"Region":this.parseRegion(n)}}),/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));const collectNextLine=()=>{const e=this.buffer;let n=0;const calculateBreakPosition=(e,n)=>{const d={start:-1,length:-1};if("\r"===e[n])d.start=n,d.length=1;else if("\n"===e[n])d.start=n,d.length=1;else if("<"===e[n]&&n+1<e.length&&"b"===e[n+1]&&n+2<e.length&&"r"===e[n+2]){let p=n+2;for(;p<e.length&&">"!==e[p++];);d.start=n,d.length=p-n}return d};let d={start:e.length,length:0};for(;n<e.length;){const p=calculateBreakPosition(e,n);if(p.length>0){d=p;break}++n}const p=e.substr(0,d.start);return this.buffer=e.substr(d.start+d.length),p};try{let e;if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;this.alreadyCollectedLine="",e=collectNextLine();const n=/^(ï»¿)?WEBVTT([ \t].*)?$/.exec(e);if(!n||!n[0])throw new ParsingError(ParsingError.Errors.BadSignature);this.state="HEADER"}for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(this.alreadyCollectedLine?(e=this.alreadyCollectedLine,this.alreadyCollectedLine=""):e=collectNextLine(),this.state){case"HEADER":e.includes(":")?this.parseHeader(e):e||(this.state="ID");continue;case"NOTE":e||(this.state="ID");continue;case"STYLE":e?this.styleCollector+=e:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(e)){this.state="STYLE";break}if(!e)continue;if(this.cue=new rn.VTTCue(0,0,""),this.state="CUE",!e.includes("--\x3e")){this.cue.id=e;continue}case"CUE":try{this.parseCue(e,this.cue,this.regionList)}catch(St){this.reportOrThrowError(St),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":{const n=e.includes("--\x3e");if(!e||n){this.alreadyCollectedLine=e,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=e;continue}case"BADCUE":e||(this.state="ID");continue}}}catch(St){this.reportOrThrowError(St),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),(this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new ParsingError(ParsingError.Errors.BadSignature)}catch(St){this.reportOrThrowError(St)}return this.onflush&&this.onflush(),this}styles(){return this._styles}constructor(e,n,d){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=n||new TextDecoder("utf8"),this.regionList=[],this.alreadyCollectedLine="",this.onStylesParsedCallback=d,this._styles={},this.middleOrCenter="center";const p=new rn.VTTCue(0,0,"middleOrCenter");try{p.align="center","center"!==p.align&&(this.middleOrCenter="middle")}catch(St){this.middleOrCenter="middle"}}}n.default=WebVTTParser,n.WebVTTParser=WebVTTParser,p(on,n)}));unwrapExports(an),an.VTTRegion,an.VTTCue,an.WebVTTParser,an.ParsingError;var sn=createCommonjsModule((function(e,n){var d=Zr&&Zr.__createBinding||(Object.create?function(e,n,d,p){void 0===p&&(p=d),Object.defineProperty(e,p,{enumerable:!0,get:function(){return n[d]}})}:function(e,n,d,p){void 0===p&&(p=d),e[p]=n[d]}),p=Zr&&Zr.__exportStar||function(e,n){for(var p in e)"default"===p||n.hasOwnProperty(p)||d(n,e,p)};Object.defineProperty(n,"__esModule",{value:!0}),n.VTTCue=n.WebVTTRenderer=n.BoxPosition=n.CueStyleBox=n.StyleBox=void 0,Object.defineProperty(n,"VTTCue",{enumerable:!0,get:function(){return rn.VTTCue}});const h=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],y=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class StyleBox{applyStyles(e,n){n=n||this.div;for(const d in e)e.hasOwnProperty(d)&&(n.style[d]=e[d])}formatStyle(e,n){return 0===e?"0":e+n}}n.StyleBox=StyleBox;class CueStyleBox extends StyleBox{determineBidi(e){let n,d=[],p="";if(!e||!e.childNodes)return"ltr";function pushNodes(e,n){for(let d=n.childNodes.length-1;d>=0;d--)e.push(n.childNodes[d])}function nextTextNode(e){if(!e||!e.length)return null;let n=e.pop(),d=n.textContent||n.innerText;if(d){const n=/^.*(\n|\r)/.exec(d);return n?(e.length=0,n[0]):d}return"ruby"===n.tagName?nextTextNode(e):n.childNodes?(pushNodes(e,n),nextTextNode(e)):void 0}function isContainedInCharacterList(e,n){for(const d of n)if(e>=d[0]&&e<=d[1])return!0;return!1}for(pushNodes(d,e);p=nextTextNode(d);)for(let e=0;e<p.length;e++)if(n=p.charCodeAt(e),isContainedInCharacterList(n,y))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;const n=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return n&&n.length>=4?n[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}constructor(e,n,d,p,h,y=!1){super(),this.loggingEnabled=y,this.cue=n;let _={start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[n.positionAlign]||n.align;"middle"===_&&(_="center");let m={textAlign:_,whiteSpace:"pre-line",position:"absolute"};m.direction=this.determineBidi(this.cueDiv),m.writingMode=this.directionSettingToWritingMode(n.vertical),m.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(m),m={backgroundColor:p.backgroundColor,display:"inline-block"},this.parseOpacity(m.backgroundColor)&&(m.padding="5px",m.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(m,this.backgroundDiv),m={color:d.color,backgroundColor:d.backgroundColor,textShadow:d.textShadow,fontSize:d.fontSize,fontFamily:d.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"},m.writingMode=this.directionSettingToWritingMode(n.vertical),m.unicodeBidi="plaintext",this.cueDiv=tn.default.parseContent(e,n,h,this.loggingEnabled),this.applyStyles(m,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);let g=0;if("number"==typeof n.position){let e=n.positionAlign||n.align;if(e)switch(e){case"start":case"left":g=n.position;break;case"center":case"middle":g=n.position-n.size/2;break;case"end":case"right":g=n.position-n.size}}""===n.vertical?this.applyStyles({left:this.formatStyle(g,"%"),width:this.formatStyle(n.size,"%")}):this.applyStyles({top:this.formatStyle(g,"%"),height:this.formatStyle(n.size,"%")})}}n.CueStyleBox=CueStyleBox;class BoxPosition{calculateNewLines(e){let n=1;for(let d=0;d<e.length;d++)"\n"===e[d]&&n++;return n}move(e,n){switch(n=void 0!==n?n:this.singleLineHeight,e){case"+x":this.left+=n,this.right+=n;break;case"-x":this.left-=n,this.right-=n;break;case"+y":this.top+=n,this.bottom+=n;break;case"-y":this.top-=n,this.bottom-=n}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(const n of e)if(this.overlaps(n))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,n){switch(n){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){let n=null;e instanceof StyleBox&&e.div?n=e.div:e instanceof HTMLElement&&(n=e);let d=n.offsetHeight||0,p=n.offsetWidth||0,h=n.offsetTop||0,y=h+d,_=n.getBoundingClientRect();const{left:m,right:g}=_;return _.top&&(h=_.top),_.height&&(d=_.height),_.width&&(p=_.width),_.bottom&&(y=_.bottom),{left:m,right:g,top:h,height:d,bottom:y,width:p}}static getBoxPosition(e,n){if(e&&e.length>0){let d=0,p=e[0][n];for(let h=0;h<e.length;h++)n in["top","right"]?e[h][n]>p&&(d=h,p=e[h][n]):n in["bottom","left"]&&e[h][n]<p&&(d=h,p=e[h][n]);return e[d]}return null}static moveToMinimumDistancePlacement(e,n,d){"height"===e.property?"+y"===n?(e.top=d.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===n&&(e.bottom=d.bottomMostBoxPosition.top-0,e.top=e.bottom-e.height):"width"===e.property&&("+x"===n?(e.left=d.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===n&&(e.right=d.leftMostBoxPosition.left-0,e.left=e.right-e.width))}static moveBoxToLinePosition(e,n,d){const p=e.cue;let h,y=new BoxPosition(e),_=function(e){if("number"==typeof e.line&&(e.snapToLines||e.line>=0&&e.line<=100))return e.line;if(!e.track||!e.track.textTrackList||!e.track.textTrackList.mediaElement)return-1;let n=0;const d=e.track,p=d.textTrackList;for(let h=0;h<p.length&&p[h]!==d;h++)"showing"===p[h].mode&&n++;return-1*++n}(p),m=[];if(p.snapToLines){let e=0;switch(p.vertical){case"":m=["+y","-y"],h="height";break;case"rl":m=["+x","-x"],h="width";break;case"lr":m=["-x","+x"],h="width"}const d=y.lineHeight,g=n[h]+d,b=m[0];if(_<0){let h=0;switch(p.vertical){case"":h=n.height-d-.05*n.height;break;case"rl":case"lr":h=-n.width+d+.05*n.width}e=h,m=m.reverse()}else{switch(p.vertical){case"":e=d*Math.round(_);break;case"rl":e=n.width-d*Math.round(_);break;case"lr":e=d*Math.round(_)}Math.abs(e)>g&&(e=e<0?-1:1,e*=Math.ceil(g/d)*d)}y.move(b,e)}else{const d=""===p.vertical?n.height:n.width,h=y.lineHeight/d*100;switch(p.lineAlign){case"center":case"middle":_-=h/2;break;case"end":_-=h}switch(p.vertical){case"":e.applyStyles({top:e.formatStyle(_,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(_,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(_,"%")})}m=["+y","-y","+x","-x"],"+y"===p.axis?m=["+y","-y","+x","-x"]:"-y"===p.axis&&(m=["-y","+y","+x","-x"]),y=new BoxPosition(e)}const g=function(e,p){let h;for(let y=0;y<p.length;y++){e.moveIfOutOfBounds(n,p[y]);let _=0,m=!1;for(;e.overlapsAny(d)&&!(_>9);)m?e.move(p[y]):(d&&d.length>0&&(h||(h={topMostBoxPosition:BoxPosition.getBoxPosition(d,"top"),bottomMostBoxPosition:BoxPosition.getBoxPosition(d,"bottom"),leftMostBoxPosition:BoxPosition.getBoxPosition(d,"left"),rightMostBoxPosition:BoxPosition.getBoxPosition(d,"right")}),BoxPosition.moveToMinimumDistancePlacement(e,p[y],h)),m=!0),_++}return e}(y,m);e.move(g.toCSSCompatValues(n))}constructor(e){var n;let d,p,h,y,_,m;if(e instanceof CueStyleBox&&e.cue?(n=e.cue)&&""!==n.vertical?this.property="width":this.property="height":e instanceof BoxPosition&&(this.property=e.property||"height"),e instanceof CueStyleBox&&e.div){h=e.div.offsetHeight,y=e.div.offsetWidth,_=e.div.offsetTop;const n=e.div.firstChild;if(m=n?n.getBoundingClientRect():e.div.getBoundingClientRect(),d=m&&m[this.property]||null,n&&n.firstChild){const e=n.firstChild;if(e&&"string"==typeof e.textContent){p=d/this.calculateNewLines(e.textContent)}}}else e instanceof BoxPosition&&(m=e);this.left=m.left,this.right=m.right,this.top=m.top||_,this.height=m.height||h,this.bottom=m.bottom||_+(m.height||h),this.width=m.width||y,this.lineHeight=null!==d?d:m.lineHeight,this.singleLineHeight=null!==p?p:m.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}}n.BoxPosition=BoxPosition;class WebVTTRenderer{initSubtitleCSS(){const e=[new rn.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?tn.default.parseContent(this.window,e,this.globalStyleCollection,this.loggingEnabled):null}setStyles(e){function applyStyles(e,n,d){for(const p in n)n.hasOwnProperty(p)&&(!0===d&&void 0!==e[p]||!1===d)&&(e[p]=n[p])}for(const n in e){let d=!1,p=null;"::cue"===n?(p=this.foregroundStyleOptions,d=!0):"::-webkit-media-text-track-display"===n&&(p=this.backgroundStyleOptions,d=!0);const y=e[n];if(!0===d)applyStyles(p,y,d);else for(let e=0;e<h.length;e++){const p=h[e].exec(n);if(p&&4===p.length){const e=p[2],n={};applyStyles(n,y,d),this.globalStyleCollection[e]=n}}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(e){if(!e)return;for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(!function(e){for(let n=0;n<e.length;n++)if(e[n].hasBeenReset||!e[n].displayState)return!0;return!1}(e)){for(let n=0;n<e.length;n++)this.paddedOverlay.appendChild(e[n].displayState);return}const n=[],d=BoxPosition.getSimpleBoxPosition(this.paddedOverlay);e.length>1&&(e=function(e){const n=[];let d=0;for(let p=0;p<e.length;p++){let h=e[p];if("number"!=typeof h.line)return e;d+=h.line,n.push(h)}return d/=e.length,d>50?(n.forEach((function(e){e.axis="-y"})),n.sort((e,n)=>n.line-e.line)):(n.forEach((function(e){e.axis="+y"})),n.sort((e,n)=>e.line-n.line)),n}(e));for(let p=0;p<e.length;p++){let h=e[p],y=new CueStyleBox(this.window,h,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection,this.loggingEnabled);this.paddedOverlay.appendChild(y.div),BoxPosition.moveBoxToLinePosition(y,d,n),h.displayState=y.div,n.push(BoxPosition.getSimpleBoxPosition(y))}}setSize(e,n){e&&(this.overlay.style.width=e+"px"),n&&(this.overlay.style.height=n+"px")}getOverlay(){return this.overlay}constructor(e,n,d=!1){if(!e)return null;this.window=e,this.overlay=n,this.loggingEnabled=d,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};const p=e.document.createElement("div");p.style.position="absolute",p.style.left="0",p.style.right="0",p.style.top="0",p.style.bottom="0",p.style.margin="1.5%",this.paddedOverlay=p,n.appendChild(this.paddedOverlay),this.initSubtitleCSS()}}n.default=WebVTTRenderer,n.WebVTTRenderer=WebVTTRenderer,p(on,n)}));unwrapExports(sn),sn.VTTCue,sn.WebVTTRenderer,sn.BoxPosition,sn.CueStyleBox,sn.StyleBox;var cn=createCommonjsModule((function(e,n){var d=Zr&&Zr.__createBinding||(Object.create?function(e,n,d,p){void 0===p&&(p=d),Object.defineProperty(e,p,{enumerable:!0,get:function(){return n[d]}})}:function(e,n,d,p){void 0===p&&(p=d),e[p]=n[d]}),p=Zr&&Zr.__exportStar||function(e,n){for(var p in e)"default"===p||n.hasOwnProperty(p)||d(n,e,p)};Object.defineProperty(n,"__esModule",{value:!0}),p(an,n),p(sn,n)}));unwrapExports(cn);var ln=cn.WebVTTRenderer;function isTextTrackID3FrameCue(e){return null!=e&&"string"==typeof e.id&&void 0!==e.value&&"string"==typeof e.value.key}const un={[Z.clearkey]:"",[Z.widevine]:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",[Z.playready]:"com.microsoft.playready",[Z.fairplay]:"com.apple.streamingkeydelivery"};function _define_property$1w(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const{textTracksSwitched:dn,textTracksUpdated:pn,inlineStylesParsed:hn}=Wr;class TextTrackManager{get isDestroyed(){return this._isDestroyed}get currentTrack(){return this.tracks.find(e=>"showing"===e.mode)}set currentTrack(e){if(!e)return;let n;saveTrack("mk-text-track",e),Ye.debug(`MEDIA_TRACK save track selection ${e.language},${e.label},${e.kind}`),this.extensionTracks?(Ye.debug("MEDIA_TRACK Setting track on extension "+e.label),"Off"===e.label?(this.clearCurrentlyPlayingTrack(),n=this.extensionTracks.forcedTextTrackForCurrentAudioTrack,this.extensionTracks.textTrack=n||void 0):this.extensionTracks.textTrack=e):(Ye.debug("MEDIA_TRACK Setting track on element "+e.label),this._tracks.forEach(n=>{n!==e&&"showing"===n.mode&&(n.mode="disabled")}),e&&(Ye.debug("MEDIA_TRACK setting track mode to showing for "+e.label),this.isTrackOff(e)?(this._tracks[0].mode="showing",n=this.selectNativeForcedTrack(this.mediaElement.audioTracks)):e.mode="showing")),this.dispatcher.publish(at.forcedTextTrackChanged,n)}get tracks(){return this._tracks}destroy(){if(this._isDestroyed=!0,this.clearCurrentlyPlayingTrack(),this.extensionTracks){const e=this.extensionTracks;e.removeEventListener(pn,this.onExtensionTextTracksAdded),e.removeEventListener(dn,this.onExtensionTextTrackSwitched),e.removeEventListener(hn,this.onExtensionInlineStylesParsed)}else this.mediaElement.textTracks.removeEventListener("addtrack",this.onTextTrackAdded),this.mediaElement.textTracks.removeEventListener("change",this.onTextTrackChanged),this.mediaElement.textTracks.removeEventListener("removetrack",this.onTextTrackRemoved),this.mediaElement.removeEventListener("playing",this.onPlayStart);this.dispatcher.unsubscribe(at.audioTrackChanged,this.onAudioTrackAddedOrChanged),this.dispatcher.unsubscribe(at.audioTrackAdded,this.onAudioTrackAddedOrChanged)}restoreSelectedTrack(){var e;const n=loadTrack("mk-text-track");if((null===(e=this.tracks)||void 0===e?void 0:e.length)>=0&&void 0!==n&&(void 0===this.currentTrack||!trackEquals(this.currentTrack,n)))for(const d of this.tracks)if(trackEquals(d,n)){Ye.debug("Found track matching persisted track: "+d.label),this.currentTrack=d;break}}getSavedTrack(){return loadTrack("mk-text-track")}onExtensionInlineStylesParsed(e){var n;Ye.debug("MEDIA_TRACK Extension inline styles parsed",e),null===(n=this.renderer)||void 0===n||n.setStyles(e.styles)}onExtensionTextTracksAdded(e){Ye.debug("MEDIA_TRACK Extension text tracks updated",e),this._tracks.push(...e),this.restoreSelectedTrack(),this.dispatcher.publish(at.textTrackAdded,e)}onExtensionTextTrackSwitched(e){Ye.debug("MEDIA_TRACKS Extension text track switched",e),this.handleVTT(e);const n=e.track;if(this._tracks){const updateTrackState=d=>{e.track?n.forced&&"Off"===d.label||"Off"===n.label&&"Off"===d.label?d.mode="showing":d.mode=n.persistentID===d.id?"showing":"disabled":d.mode="Off"===d.label?"showing":"disabled"};this._tracks.forEach(updateTrackState)}this.dispatcher.publish(at.textTrackChanged,e)}handleVTT(e){var n;const d=null==e||null===(n=e.track)||void 0===n?void 0:n.id;if(void 0!==d&&d>=0){const e=this.filterSelectableTextTracks(this.mediaElement.textTracks)[d];this.onNativeTrackChange(e)}else this.clearCurrentlyPlayingTrack()}onAudioTrackAddedOrChanged(){if(Ye.debug("MEDIA_TRACKS text track manager detects audio track change"),this.shouldForceSubtitle())if(this.extensionTracks){Ye.debug("MEDIA_TRACKS selecting forced text track via extension");const e=this.extensionTracks.forcedTextTrackForCurrentAudioTrack;e?(Ye.debug("MEDIA_TRACKS forced track found:",e),this.extensionTracks.textTrack=e,this.dispatcher.publish(at.forcedTextTrackChanged,e)):this.clearCurrentlyPlayingTrack()}else Ye.debug("MEDIA_TRACKS selecting forced text track natively"),this.currentTrack=this._tracks[0]}onTextTrackAdded(e){this._tracks.push(e.track),this.dispatcher.publish(at.textTrackAdded,e)}onPlayStart(){this.restoreSelectedTrack()}onTextTrackRemoved(e){this.dispatcher.publish(at.textTrackRemoved,e)}onTextTrackChanged(e){const n=this.findNativeSelectedTextTrack();let d=this.getSavedTrack();if(d||(d=this._tracks[0]),n&&!trackEquals(n,d))if(this.isTrackOff(d)&&"forced"!==n.kind){const e=this.tracks.find(e=>trackEquals(e,d));this.currentTrack=e}else{const e=this.findNativeTrack(d);e&&(this.currentTrack=e)}else this.dispatcher.publish(at.textTrackChanged,e)}findNativeSelectedTextTrack(){for(let e=0;e<this.mediaElement.textTracks.length;e++){const n=this.mediaElement.textTracks[e];if("showing"===n.mode)return n}}findNativeTrack(e){for(let n=0;n<this.mediaElement.textTracks.length;n++){const d=this.mediaElement.textTracks[n];if(trackEquals(d,e))return d}}selectNativeForcedTrack(e){for(let n=0;n<e.length;n++){const d=e[n];if(d.enabled){const e=this.findNativeForcedTrack(d);return e&&"showing"!==e.mode&&(e.mode="showing"),e}}}findNativeForcedTrack(e){const n=this.mediaElement.textTracks;for(let d=0;d<n.length;d++){const p=n[d];if("forced"===p.kind&&p.language===e.language)return p}}onNativeTrackChange(e){this.clearCurrentlyPlayingTrack(),this._currentlyPlayingTrack=e,e.addEventListener("cuechange",this.onCueChange)}clearCurrentlyPlayingTrack(){var e;void 0!==this._currentlyPlayingTrack&&function(e){return null!=e&&"string"==typeof e.id&&"removeEventListener"in e}(this._currentlyPlayingTrack)&&(this._currentlyPlayingTrack.removeEventListener("cuechange",this.onCueChange),null===(e=this.renderer)||void 0===e||e.processCues({}),delete this._currentlyPlayingTrack)}onCueChange(e){const n=e&&e.target&&e.target.activeCues;var d;n&&(null===(d=this.renderer)||void 0===d||d.processCues(n))}filterSelectableTextTracks(e){const n=[];for(let d=0;d<e.length;d++){const p=e[d];("captions"===p.kind||"subtitles"===p.kind||"metadata"===p.kind&&p.customTextTrackCueRenderer)&&n.push(p)}return n}shouldForceSubtitle(){Ye.debug("MEDIA_TRACKS Determining whether to select forced text track");const e=this.getSavedTrack();return!e||this.isTrackOff(e)}isTrackOff(e){return"Off"===e.label||"Auto"===e.label}constructor(e,n,d){_define_property$1w(this,"mediaElement",void 0),_define_property$1w(this,"dispatcher",void 0),_define_property$1w(this,"extensionTracks",void 0),_define_property$1w(this,"_tracks",void 0),_define_property$1w(this,"renderer",void 0),_define_property$1w(this,"_currentlyPlayingTrack",void 0),_define_property$1w(this,"_isDestroyed",void 0),this.mediaElement=e,this.dispatcher=n,this.extensionTracks=d,this._tracks=[],this._isDestroyed=!1;const p=this.getSavedTrack();if(this._tracks.push({id:-2,label:"Off",language:"",kind:"subtitles",mode:!p||this.isTrackOff(p)?"showing":"disabled"}),this.extensionTracks){Ye.debug("MEDIA_TRACK Initializing text track manager for HLS.js track events");const n=e.parentElement;this.renderer=new ln(window,n,!1),this.renderer.setStyles({"::cue":{fontSize:"calc(1vw + 1em)"}}),this.onExtensionTextTracksAdded=this.onExtensionTextTracksAdded.bind(this),this.onExtensionTextTrackSwitched=this.onExtensionTextTrackSwitched.bind(this),this.onExtensionInlineStylesParsed=this.onExtensionInlineStylesParsed.bind(this),this.onCueChange=this.onCueChange.bind(this);const d=this.extensionTracks;d.addEventListener(pn,this.onExtensionTextTracksAdded),d.addEventListener(dn,this.onExtensionTextTrackSwitched),d.addEventListener(hn,this.onExtensionInlineStylesParsed)}else Ye.debug("MEDIA_TRACK Initializing text track manager for native track events"),this.onTextTrackAdded=this.onTextTrackAdded.bind(this),this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.onTextTrackRemoved=this.onTextTrackRemoved.bind(this),this.onPlayStart=this.onPlayStart.bind(this),e.textTracks.addEventListener("addtrack",this.onTextTrackAdded),e.textTracks.addEventListener("change",this.onTextTrackChanged),e.textTracks.addEventListener("removetrack",this.onTextTrackRemoved),e.addEventListener("playing",this.onPlayStart);this.onAudioTrackAddedOrChanged=debounce(this.onAudioTrackAddedOrChanged.bind(this)),n.subscribe(at.audioTrackChanged,this.onAudioTrackAddedOrChanged),n.subscribe(at.audioTrackAdded,this.onAudioTrackAddedOrChanged)}}function asyncGeneratorStep$13(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$13(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$13(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$13(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1v(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$v(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const yn={"picture-in-picture":Pe.pictureinpicture,inline:Pe.inline},fn={};fn[Pe.pictureinpicture]="picture-in-picture",fn[Pe.inline]="inline";const{presentationModeDidChange:_n}=at,{playbackLicenseError:vn}=Wr,{stopped:mn}=be;class VideoPlayer extends BasePlayer{get audioTracks(){var e,n;return null!==(n=null===(e=this.audioTrackManager)||void 0===e?void 0:e.tracks)&&void 0!==n?n:[]}get containerElement(){return this._context.videoContainerElement?this._context.videoContainerElement:document.getElementById("apple-music-video-container")}get currentAudioTrack(){var e;return null===(e=this.audioTrackManager)||void 0===e?void 0:e.currentTrack}set currentAudioTrack(e){void 0!==this.audioTrackManager&&(this.audioTrackManager.currentTrack=e)}get currentTextTrack(){var e;return null===(e=this.textTrackManager)||void 0===e?void 0:e.currentTrack}set currentTextTrack(e){void 0!==this.textTrackManager&&(this.textTrackManager.currentTrack=e)}get _targetElement(){return this.video||function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1v(e,n,d[n])}))}return e}({},document.createElement("video"))}get textTracks(){var e,n;return null!==(n=null===(e=this.textTrackManager)||void 0===e?void 0:e.tracks)&&void 0!==n?n:[]}initializeExtension(){var e=this;return _async_to_generator$13((function*(){const{os:n}=e.services.runtime;e.restrictPlatforms&&n.isAndroid?Ye.warn("videoPlayer.initializeExtension Not supported on the current platform"):e.video||Ye.warn("videoPlayer.initializeExtension No video element, not initializing extension")}))()}onPlaybackLicenseError(e){this.resetDeferredPlay(),this._dispatcher.publish(vn,e)}setupTrackManagers(e){var n,d,p,h;null===(d=this.textTrackManager)||void 0===d||null===(n=d.destroy)||void 0===n||n.call(d),this.textTrackManager=new TextTrackManager(this._targetElement,this._dispatcher,e),null===(h=this.audioTrackManager)||void 0===h||null===(p=h.destroy)||void 0===p||p.call(h),this.audioTrackManager=new AudioTrackManager(this._targetElement,this._dispatcher,e)}destroy(){var e,n;this.finishPlaybackSequence(),null===(e=this.textTrackManager)||void 0===e||e.destroy(),null===(n=this.audioTrackManager)||void 0===n||n.destroy(),super.destroy()}initializeEventHandlers(){var e=this,_superprop_get_initializeEventHandlers=()=>super.initializeEventHandlers;return _async_to_generator$13((function*(){_superprop_get_initializeEventHandlers().call(e),e.hasMediaElement&&(e._targetElement.addEventListener("webkitpresentationmodechanged",e.pipEventHandler),e._targetElement.addEventListener("enterpictureinpicture",e.pipEventHandler),e._targetElement.addEventListener("leavepictureinpicture",e.pipEventHandler))}))()}removeEventHandlers(){if(super.removeEventHandlers(),!this.hasMediaElement)return;const{_targetElement:e}=this;e.removeEventListener("webkitpresentationmodechanged",this.pipEventHandler),e.removeEventListener("enterpictureinpicture",this.pipEventHandler),e.removeEventListener("leavepictureinpicture",this.pipEventHandler)}initializeMediaElement(){var e=this;return _async_to_generator$13((function*(){Ye.debug("videoPlayer.initializeMediaElement Initializing media element");const n=e.containerElement;n?(e.video=function(){let e=Jr.pop();return e?Ye.debug(`dom-helpers: retrieving video tag, ${Jr.length} remain`):(Ye.debug("dom-helpers: no available video tags, creating one"),e=document.createElement("video")),e}(),e.video.autoplay=!1,e.video.controls=!1,e.video.playsInline=!0,e.video.id="apple-music-video-player",n.appendChild(e.video)):Ye.warn("videoPlayer.initializeMediaElement No video element; no container defined")}))()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$13((function*(){yield _superprop_get_stopMediaElement().call(e),e.destroy()}))()}pipEventHandler(e){switch(e.type){case"enterpictureinpicture":this._dispatcher.publish(_n,{mode:Pe.pictureinpicture});break;case"leavepictureinpicture":this._dispatcher.publish(_n,{mode:Pe.inline});break;case"webkitpresentationmodechanged":{const e=this._targetElement;this._dispatcher.publish(_n,{mode:this._translateStringToPresentationMode(e.webkitPresentationMode)});break}}}playItemFromEncryptedSource(e,n=!1,d={}){var p=this;return _async_to_generator$13((function*(){if(Ye.debug("videoPlayer.playItemFromEncryptedSource",e,n),p.playbackState===mn)return void Ye.debug("video-player.playItemFromEncryptedSource aborting playback because player is stopped");e.playbackType=ie.encryptedFull,p.nowPlayingItem=e,e.state=oe.loading,p.userInitiated=n;const h=generateAssetUrl(e,d);yield p.playHlsStream(h,e,d)}))()}playItemFromUnencryptedSource(e,n,d){var p=this;return _async_to_generator$13((function*(){if(Ye.debug("videoPlayer.playItemFromUnencryptedSource",e,n),p.playbackState===mn)return void Ye.debug("videoPlayer.playItemFromUnencryptedSource aborting playback because player is stopped");const[d]=e.split("?");d.endsWith("m3u")||d.endsWith("m3u8")?yield p.playHlsStream(e):yield p._playAssetURL(e,n)}))()}setPresentationMode(e){var n=this;return _async_to_generator$13((function*(){const d=n._targetElement;if(d.webkitSupportsPresentationMode&&"function"==typeof d.webkitSetPresentationMode)return d.webkitSetPresentationMode(n._translatePresentationModeToString(e));if(d.requestPictureInPicture&&document.exitPictureInPicture){if(e===Pe.pictureinpicture)return d.requestPictureInPicture();if(e===Pe.inline)return document.exitPictureInPicture()}}))()}_translateStringToPresentationMode(e){let n=yn[e];return void 0===n&&(Ye.warn(`videoPlayer._translateStringToPresentationMode ${e} is not a valid presentation mode, setting to inline`),n=Pe.inline),n}_translatePresentationModeToString(e){let n=fn[e];return void 0===n&&(Ye.warn(`videoPlayer._translatePresentationModeToString ${e} is not a valid presentation mode, setting to inline`),n="inline"),n}preloadItem(e,n){return _async_to_generator$13((function*(){}))()}constructor(e){var n,d;(super(e),_define_property$1v(this,"extension",void 0),_define_property$1v(this,"video",void 0),_define_property$1v(this,"mediaPlayerType","video"),_define_property$1v(this,"restrictPlatforms",void 0),_define_property$1v(this,"textTrackManager",void 0),_define_property$1v(this,"audioTrackManager",void 0),_define_property$1v(this,"userInitiated",!1),this.pipEventHandler=this.pipEventHandler.bind(this),this.restrictPlatforms=!0,void 0!==(null===(n=e.bag)||void 0===n?void 0:n.features))&&(this.restrictPlatforms=null===(d=e.bag.features.restrictPlatforms)||void 0===d||d)}}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$v("design:type",Function),_ts_metadata$v("design:paramtypes",[void 0]),_ts_metadata$v("design:returntype",void 0)],VideoPlayer.prototype,"onPlaybackLicenseError",null);const decayingOperation=(e,n,d,p=0)=>e().catch(h=>{const y=p+1;function possiblyRetry(p){if(p&&y<3){const p=1e3*y;return new Promise((h,_)=>{setTimeout(()=>{decayingOperation(e,n,d,y).then(h,_)},p)})}throw h}const _=n(h);return"boolean"==typeof _?possiblyRetry(_):_.then(possiblyRetry)});let gn={developerToken:"developerTokenNotSet",musicUserToken:"musicUserTokenNotSet",cid:"cidNotSet"};function asyncGeneratorStep$12(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$12(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$12(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$12(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1u(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$H(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1u(e,n,d[n])}))}return e}function _object_spread_props$s(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function createHlsOffersLicenseChallengeBody(e){return{"adam-id":e.id,id:1}}function createStreamingKeysLicenseChallengeBody(e,n,d=0){var p;return _object_spread$H({id:d,"lease-action":n},null!==(p=e.keyServerQueryParameters)&&void 0!==p?p:{})}function createLicenseChallengeBody(e,n,d){let p,h={challenge:d.challenge||F(d.licenseChallenge),uri:d.keyuri,"key-system":d.keySystem,stkn:d.slotToken};return d.extendedLease&&(h["extended-lease"]=d.extendedLease),h=function(e,n){const d={};for(const p of n)p in e&&void 0!==e[p]&&(d[p]=e[p]);return d}(h,Object.keys(h)),p=n.isUTS?{"streaming-request":{version:1,"streaming-keys":[_object_spread$H({},h,createStreamingKeysLicenseChallengeBody(n,e))]}}:n.isLiveRadioStation?_object_spread$H({},h,function(e){return{event:e.isLiveAudioStation?"beats1":"amtv"}}(n)):n.hasOffersHlsUrl?{"license-requests":[_object_spread$H({},h,createHlsOffersLicenseChallengeBody(n))]}:_object_spread$H({},h,function(e,n=!1){return{adamId:e.songId,isLibrary:e.isCloudItem,"user-initiated":n}}(n,d.userInitiated)),p}class License{fetch(e){const n={Authorization:"Bearer "+gn.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+gn.musicUserToken};this.keySystem===Z.widevine&&(n["X-Apple-Renewal"]=!0);return decayingOperation(()=>(Ye.debug("Fetching License challenge from "+this.licenseUrl,{headers:n,body:e}),fetch(this.licenseUrl,{method:"POST",body:JSON.stringify(e),headers:new Headers(n)})),e=>e instanceof TypeError,"license fetch")}reset(){Ye.debug("Resetting License instance"),this.licenseUrl=void 0,this.playableItem=void 0,this.licenseData=void 0,this.initiated=void 0,this.keySystem=void 0,this.slotToken=void 0,this.startResponse=void 0}start(e,n,d,p,h=!1,y=!1){var _=this;return _async_to_generator$12((function*(){_.licenseUrl=e,_.playableItem=n,_.licenseData=d,_.keySystem=p,_.initiated=h,Ye.debug(`Starting License request to ${_.licenseUrl} with URI ${_.licenseData.keyuri} for ${mediaItemLogString(_.playableItem)}`);const m=d.isRenewalRequest?"renew":"start";Ye.debug(`Treating License request as a ${"renew"===m?"renewal":"new"} request`);const g=createLicenseChallengeBody(m,n,_object_spread_props$s(_object_spread$H({},d),{keySystem:p,extendedLease:y,userInitiated:h}));n.hasOffersHlsUrl&&!_.licenseUrl.includes("start")&&(_.licenseUrl+="/"+m),_.startResponse=_.fetch(g);try{var b,P,S;const e=yield _.startResponse;if(!e.ok){let n;try{n=yield e.json()}catch(St){}_.processJsonError(n)}Ye.debug("Processing License Challenge reponse as JSON");const n=yield e.json();let d=n;return(null==n||null===(P=n["streaming-response"])||void 0===P||null===(b=P["streaming-keys"])||void 0===b?void 0:b.length)?d=n["streaming-response"]["streaming-keys"][0]:(null==n||null===(S=n["license-responses"])||void 0===S?void 0:S.length)&&(d=n["license-responses"][0]),0!==d.status&&_.processJsonError(d),_.slotToken=d.stkn,d}catch(he){throw Ye.error(`License Challenge Request failed to ${_.licenseUrl} with URI ${_.licenseData.keyuri} for ${mediaItemLogString(_.playableItem)}`),_.startResponse=void 0,he}}))()}processJsonError(e){let n=new MKError(MKError.Reason.MEDIA_LICENSE,"Error acquiring license");if((null==e?void 0:e.errorCode)&&(e.status=e.errorCode),-1021===(null==e?void 0:e.status)&&(e.status=190121),e&&0!==e.status){if(!e.message)switch(e.status){case-1004:e.message=MKError.Reason.DEVICE_LIMIT;break;case-1017:e.message=MKError.Reason.GEO_BLOCK;break;default:e.message=MKError.Reason.MEDIA_LICENSE}n=MKError.serverError(e),n.data=e}throw n}stop(){var e=this;return _async_to_generator$12((function*(){if(e.startResponse)try{yield e.startResponse}catch(he){}if(!e.playableItem||!e.licenseData||!e.licenseUrl)return;if(!e.playableItem.isUTS)return;const n=createLicenseChallengeBody("stop",e.playableItem,_object_spread_props$s(_object_spread$H({},e.licenseData),{keySystem:e.keySystem,slotToken:e.slotToken,userInitiated:e.initiated})),d=e.fetch(n);e.reset();try{yield d}catch(he){Ye.warn("license.stop request error",he)}}))()}constructor(){_define_property$1u(this,"licenseUrl",void 0),_define_property$1u(this,"playableItem",void 0),_define_property$1u(this,"licenseData",void 0),_define_property$1u(this,"initiated",void 0),_define_property$1u(this,"keySystem",void 0),_define_property$1u(this,"slotToken",void 0),_define_property$1u(this,"startResponse",void 0)}}function asyncGeneratorStep$11(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$11(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$11(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$11(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1t(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$u(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class KeySession extends Notifications{get extID(){if(this.extURI)return this.extURI.replace("data:;base64,","")}get isFairplay(){return this.keySystem===Z.fairplay}get isPlayReady(){return this.keySystem===Z.playready}get isWidevine(){return this.keySystem===Z.widevine}acquirePlaybackLicense(e,n,d,p){var h=this;return _async_to_generator$11((function*(){if(!h.keyServerURL||!h.developerToken||!h.userToken)return;const{keyServerURL:d,keySystem:y}=h,_=p.item;try{return yield h.license.start(d,_,{challenge:n,keyuri:e},y,h.initiated,h.isLegacyEme&&_.isUTS)}catch(St){h.dispatchEvent(Wr.playbackLicenseError,St)}}))()}startLicenseSession(e){var n=this;return _async_to_generator$11((function*(){let d;Ye.debug("Starting License Session",e);const{message:p,target:h,messageType:y}=e;if(n.keySystem!==Z.fairplay&&"license-request"!==y)return void Ye.debug("not making license request for",y);if(n.isPlayReady){const e=String.fromCharCode.apply(null,new Uint16Array(p.buffer||p));d=(new DOMParser).parseFromString(e,"application/xml").getElementsByTagName("Challenge")[0].childNodes[0].nodeValue}else d=F(new Uint8Array(p));const _=h.extURI||n.extURI,m=n.mediaKeySessions[_];if(!m)return void Ye.debug("no key session info, aborting license request");const g=n.acquirePlaybackLicense(_,d,n.initiated,m);if(m.delayCdmUpdate)m["license-json"]=g;else{const e=yield g;yield n.handleLicenseJson(e,h,_)}}))()}setKeyURLs(e){this.keyCertURL=e[this.isFairplay?"hls-key-cert-url":"widevine-cert-url"],this.keyServerURL=e["hls-key-server-url"]}dispatchKeyError(e){var n,d;this.isFairplay&&4294955417===(null==e||null===(d=e.target)||void 0===d||null===(n=d.error)||void 0===n?void 0:n.systemCode)?Ye.error("Ignoring error",e):(console.error(MKError.Reason.MEDIA_KEY+" error in dispatchKeyError:",e),this.dispatchEvent(Wr.playbackSessionError,new MKError(MKError.Reason.MEDIA_KEY,e)))}dispatchSessionError(e){this.dispatchEvent(Wr.playbackSessionError,new MKError(MKError.Reason.MEDIA_SESSION,e))}loadCertificateBuffer(){var e=this;return _async_to_generator$11((function*(){if(!e.keyCertURL)return Promise.reject(new MKError(MKError.Reason.MEDIA_SESSION,"No certificate URL"));let n;try{n=yield fetch(`${e.keyCertURL}?t=${Date.now()}`)}catch(he){throw e.dispatchKeyError(he),he}const d=yield n.arrayBuffer(),p=String.fromCharCode.apply(String,new Uint8Array(d));return/^\<\?xml/.test(p)?Promise.reject(new MKError(MKError.Reason.MEDIA_CERTIFICATE,"Invalid certificate.")):d}))()}handleSessionCreation(e){var n=this;return _async_to_generator$11((function*(){return n.createSession(e).catch(e=>{n.dispatchSessionError(e)})}))()}handleLicenseJson(e,n,d){var p=this;return _async_to_generator$11((function*(){if(Ye.debug(`updating session ${d} with license response`,e),null==e?void 0:e.license){const d=N(e.license);try{yield n.update(d)}catch(St){Ye.error("Failed to updated media keys",St),p.dispatchKeyError(St)}}}))()}addMediaKeySessionInfo(e,n,d,p=!1){const h=this.mediaKeySessions[e];h?(Ye.debug(`keySession info exists for ${d.title}, making existing session ${h.session.sessionId} the old session`),h.oldSession=h.session,h.session=n):(Ye.debug("creating key session info for "+d.title),this.mediaKeySessions[e]={session:n,item:d,delayCdmUpdate:p})}stopLicenseSession(){Ye.info("key session sending license stop"),this.license.stop()}constructor(){super([Wr.playbackLicenseError,Wr.playbackSessionError]),_define_property$1t(this,"developerToken",void 0),_define_property$1t(this,"adamId",void 0),_define_property$1t(this,"userToken",void 0),_define_property$1t(this,"extURI",void 0),_define_property$1t(this,"item",void 0),_define_property$1t(this,"initiated",!0),_define_property$1t(this,"isLibrary",!1),_define_property$1t(this,"keyCertURL",void 0),_define_property$1t(this,"keyServerURL",void 0),_define_property$1t(this,"keySystem",Z.fairplay),_define_property$1t(this,"isLegacyEme",!1),_define_property$1t(this,"boundDispatchKeyError",void 0),_define_property$1t(this,"boundDispatchSessionError",void 0),_define_property$1t(this,"boundHandleSessionCreation",void 0),_define_property$1t(this,"boundStartLicenseSession",void 0),_define_property$1t(this,"mediaKeySessions",{}),_define_property$1t(this,"_pendingRenewal",void 0),_define_property$1t(this,"license",void 0),this.boundDispatchKeyError=this.dispatchKeyError.bind(this),this.boundDispatchSessionError=this.dispatchSessionError.bind(this),this.boundHandleSessionCreation=this.handleSessionCreation.bind(this),this.boundStartLicenseSession=this.startLicenseSession.bind(this),this.license=new License}}function asyncGeneratorStep$10(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$10(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$10(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$10(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1s(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$t(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$u("design:type",Function),_ts_metadata$u("design:paramtypes",[void 0]),_ts_metadata$u("design:returntype",Promise)],KeySession.prototype,"startLicenseSession",null);class FairplayEncryptedSession extends KeySession{attachMedia(e,n){var d=this;return _async_to_generator$10((function*(){d.keySystem=n.keySystem,d._keySystemAccess=n,e.addEventListener("encrypted",d.boundHandleSessionCreation,!1)}))()}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation);const n=this._mediaKeySessions,d=this._mediaKeySessionRenewals;Object.values(n).forEach(e=>{e.removeEventListener("message",this.boundStartLicenseSession),asAsync(e.close())}),this._mediaKeySessions={},Object.values(d).forEach(e=>clearTimeout(e)),this._mediaKeySessionRenewals={}}createSession(e){var n=this;return _async_to_generator$10((function*(){Ye.debug("fairplay eme:  createSession",e);const d=n._keySystemAccess;if(!d)return;const{initData:p,target:h,initDataType:y}=e;n._mediaKeysPromise||(n._mediaKeysPromise=new Promise(function(){var e=_async_to_generator$10((function*(e,p){const y=yield d.createMediaKeys();try{yield h.setMediaKeys(y),n._mediaKeys=y;const e=yield n.loadCertificateBuffer();yield y.setServerCertificate(e)}catch(he){n.dispatchKeyError(he),p(he)}e(y)}));return function(n,d){return e.apply(this,arguments)}}()));const _=yield n._mediaKeysPromise,m=new Uint8Array(p),g=String.fromCharCode.apply(void 0,Array.from(m));if(n.mediaKeySessions[g])return void Ye.error("fairplay eme: not creating new session for extURI",g);const b=_.createSession();Ye.debug("fairplay eme: creating new key session for",g),n.addMediaKeySessionInfo(g,b,n.item),b.addEventListener("message",n.startFairplayLicenseSession),b.extURI=g,yield b.generateRequest(y,p),n._mediaKeySessions[b.sessionId]=b,Ye.debug("fairplay eme: created session",b)}))()}startFairplayLicenseSession(e){const{message:n,target:d}=e,p=F(new Uint8Array(n)),h=d.extURI||this.extURI,y=this.mediaKeySessions[h];if(y)return this.acquirePlaybackLicense(h,p,this.initiated,y).then(e=>this.handleLicenseJson(e,d,h));Ye.debug("fairplay eme: no key session info, aborting license request",h)}handleLicenseJson(e,n,d){var p=this,_superprop_get_handleLicenseJson=()=>super.handleLicenseJson;return _async_to_generator$10((function*(){if(!e)return;const h=p.mediaKeySessions[d];if(!h)return void Ye.debug("fairplay eme: media key session does not exist, not updating");const y=e["renew-after"];if(e.license&&y){Ye.debug("fairplay eme: got renew after value",y,d);const e=p._mediaKeySessionRenewals,_=e[n.sessionId];_&&clearTimeout(_),e[n.sessionId]=setTimeout(()=>p._renewMediaKeySession(h,d),1e3*y)}yield _superprop_get_handleLicenseJson().call(p,e,n,d)}))()}_renewMediaKeySession(e,n){delete this._mediaKeySessionRenewals[e.session.sessionId],Ye.debug("fairplay eme: renewing session",e),e.session.update(L("renew"))}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$10((function*(){}))()}clearSessions(){return _async_to_generator$10((function*(){}))()}constructor(...e){super(...e),_define_property$1s(this,"_keySystemAccess",void 0),_define_property$1s(this,"_mediaKeysPromise",void 0),_define_property$1s(this,"_mediaKeySessions",{}),_define_property$1s(this,"_mediaKeySessionRenewals",{}),_define_property$1s(this,"_mediaKeys",void 0)}}function asyncGeneratorStep$$(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$$(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$$(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$$(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1r(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$t("design:type",Function),_ts_metadata$t("design:paramtypes",[void 0]),_ts_metadata$t("design:returntype",void 0)],FairplayEncryptedSession.prototype,"startFairplayLicenseSession",null);const bn=/^(?:.*)(skd:\/\/.+)$/i;class WebKitSession extends KeySession{get isDestroyed(){return this._isDestroyed}attachMedia(e,n){return this.target=e,e.addEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("webkitkeyerror",this.boundDispatchKeyError),e}detachMedia(e){e&&(e.removeEventListener("webkitneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("webkitkeyerror",this.boundDispatchKeyError))}destroy(){Ye.debug("FPS destroy"),this._isDestroyed=!0,this.detachMedia(this.target),this.session&&(this.session.removeEventListener("webkitkeyerror",this.boundDispatchKeyError),this.session.removeEventListener("webkitkeymessage",this.boundStartLicenseSession))}createSession(e){Ye.debug("FPS createSession",e);const{initData:n,target:d}=e,{item:p}=this;if(!p)return Ye.error("Cannot createSession without item"),Promise.resolve();const h=this._extractAssetId(n);if(Ye.debug("extURI",h),!d.webkitKeys&&window.WebKitMediaKeys){const e=new window.WebKitMediaKeys(this.keySystem);d.webkitSetMediaKeys(e)}return this.loadCertificateBuffer().then(e=>{const y=this._concatInitDataIdAndCertificate(n,h,e),_="VIDEO"===d.tagName?Qr.AVC1:Qr.MP4,m=d.webkitKeys.createSession(_,y);this.addMediaKeySessionInfo(h,m,p),this.session=m,m.extURI=h,m.addEventListener("webkitkeyerror",this.boundDispatchKeyError),m.addEventListener("webkitkeymessage",this.boundStartLicenseSession)})}_extractAssetId(e){let n=String.fromCharCode.apply(null,new Uint16Array(e.buffer||e));const d=n.match(bn);return d&&d.length>=2&&(n=d[1]),Ye.debug("Extracted assetId from EXT-X-KEY URI",n),n}_concatInitDataIdAndCertificate(e,n,d){"string"==typeof n&&(n=U(n)),d=new Uint8Array(d);let p=0;const h=new ArrayBuffer(e.byteLength+4+n.byteLength+4+d.byteLength),y=new DataView(h);new Uint8Array(h,p,e.byteLength).set(e),p+=e.byteLength,y.setUint32(p,n.byteLength,!0),p+=4;const _=new Uint8Array(h,p,n.byteLength);_.set(n),p+=_.byteLength,y.setUint32(p,d.byteLength,!0),p+=4;return new Uint8Array(h,p,d.byteLength).set(d),new Uint8Array(h,0,h.byteLength)}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$$((function*(){}))()}clearSessions(){return _async_to_generator$$((function*(){}))()}constructor(...e){super(...e),_define_property$1r(this,"target",void 0),_define_property$1r(this,"session",void 0),_define_property$1r(this,"_isDestroyed",!1),_define_property$1r(this,"isLegacyEme",!0)}}function asyncGeneratorStep$_(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$_(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$_(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$_(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}class MSSession extends KeySession{attachMedia(e,n){return this.keySystem=n.keySystem,e.addEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.addEventListener("mskeyerror",this.boundDispatchKeyError),e}detachMedia(e){e.removeEventListener("msneedkey",this.boundHandleSessionCreation,!1),e.removeEventListener("mskeyerror",this.boundDispatchKeyError)}createSession(e){const{initData:n,target:d}=e;if(!d.msKeys){const e=new MSMediaKeys(this.keySystem);d.msSetMediaKeys(e)}const p=d.msKeys.createSession(Qr.MP4,n);return p.addEventListener("mskeyerror",this.dispatchKeyError),p.addEventListener("mskeymessage",this.startLicenseSession.bind(this)),p}applyDelayedCdmUpdates(){}loadKeys(e){return _async_to_generator$_((function*(){}))()}clearSessions(){return _async_to_generator$_((function*(){}))()}}const Pn=[0,0,1,222,112,115,115,104,0,0,0,0,154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149,0,0,1,190],Sn=[190,1,0,0,1,0,1,0,180,1];function concatenate(e,...n){let d=0;for(const y of n)d+=y.length;const p=new e(d);let h=0;for(const y of n)p.set(y,h),h+=y.length;return p}const Tn={[Z.widevine]:e=>{Ye.debug("generating Widevine pssh for keyId");const n=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);for(let d=0;d<e.length;d++)n[n.length-16+d]=e[d];return Ye.debug("generatePSSH",n),n},[Z.playready]:e=>{Ye.debug("generating Playready pssh for keyId"),(e=>{const swap=(e,n,d)=>{const p=e[n];e[n]=e[d],e[d]=p};swap(e,0,3),swap(e,1,2),swap(e,4,5),swap(e,6,7)})(e);const n=F(e),d='<WRMHEADER xmlns="http://schemas.microsoft.com/DRM/2007/03/PlayReadyHeader" version="4.3.0.0"><DATA><PROTECTINFO><KIDS><KID ALGID="AESCTR" VALUE="[KEYID]"></KID></KIDS></PROTECTINFO></DATA></WRMHEADER>'.replace("[KEYID]",n),p=U(d),h=new Uint8Array(p.buffer,p.byteOffset,p.byteLength);return concatenate(Uint8Array,Pn,Sn,h)}};function asyncGeneratorStep$Z(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$Z(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$Z(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Z(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1q(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class PreloadingEncryptedSession extends KeySession{attachMedia(e,n){this.keySystem=n.keySystem,this._keySystemAccess=n,this._target=e}detachMedia(){asAsync(this.clearSessions())}createSession(e){return _async_to_generator$Z((function*(){}))()}_mediaKeysSetup(){var e=this;return _async_to_generator$Z((function*(){const n=e._keySystemAccess;n&&(e._mediaKeysPromise||(e._mediaKeysPromise=new Promise(function(){var d=_async_to_generator$Z((function*(d,p){const h=yield n.createMediaKeys();try{var y;yield null===(y=e._target)||void 0===y?void 0:y.setMediaKeys(h),e._mediaKeys=h}catch(he){e.dispatchKeyError(he),p(he)}if(e.isWidevine){const n=yield e.loadCertificateBuffer();yield h.setServerCertificate(n)}d(h)}));return function(e,n){return d.apply(this,arguments)}}())),yield e._mediaKeysPromise)}))()}createSessionAndGenerateRequest(e,n,d){var p=this;return _async_to_generator$Z((function*(){var h;const y=!!(null==d?void 0:d.isRenewal),_=!!(null==d?void 0:d.delayCdmUpdate);if(!y&&p.mediaKeySessions[e])return;Ye.debug(`createSessionAndGenerateRequest for item ${n.title}, isRenewal ${y}`);const m=null===(h=p._mediaKeys)||void 0===h?void 0:h.createSession(),{keySystem:g}=p;if(!m)return;p.addMediaKeySessionInfo(e,m,n,_);const b=e.includes("data")?e.split(",")[1]:e,P=N(b),S=p.isWidevine&&n.isSong||16===P.length;let T;var k;return Ye.debug("extracted uri",e),p.isPlayReady&&!S?(Ye.debug("handling Playready object"),m.extURI=e,k=P,T=concatenate(Uint8Array,new Uint8Array(Pn),k)):S?(Ye.debug("handling keyId only initData"),m.extURI="data:;base64,"+F(P),T=((e,n)=>{const d=Tn[n];if(!d)return Ye.warn("No pssh generator for ",n),e;return d(Uint8Array.from(e))})(P,g)):(Ye.debug("handling pssh initData"),m.extURI=e,T=P),m.addEventListener("message",p.startLicenseSession),m.generateRequest("cenc",T).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return m.generateRequest("cenc",T);throw e})}))()}handleLicenseJson(e,n,d){var p=this,_superprop_get_handleLicenseJson=()=>super.handleLicenseJson;return _async_to_generator$Z((function*(){var h;if(!e)return;const y=p.mediaKeySessions[d];if(!y)return void Ye.debug("media key session does not exist, not updating");const _=e["renew-after"];if(e.license&&_){Ye.debug("Got renew after value",_,d);const e=p._mediaKeySessionRenewals,h=e[n.sessionId];h&&clearTimeout(h),e[n.sessionId]=setTimeout(()=>p._renewMediaKeySession(y,d),1e3*_)}yield _superprop_get_handleLicenseJson().call(p,e,n,d);const m=null===(h=p.mediaKeySessions[d])||void 0===h?void 0:h.oldSession;m&&(Ye.debug("removing old key session after updating",d),yield p._removeAndCloseSession(m),delete p.mediaKeySessions[d].oldSession,delete p._mediaKeySessionRenewals[m.sessionId])}))()}_renewMediaKeySession(e,n){delete this._mediaKeySessionRenewals[e.session.sessionId],asAsync(this.createSessionAndGenerateRequest(n,e.item,{isRenewal:!0}))}applyDelayedCdmUpdates(){var e=this;return _async_to_generator$Z((function*(){Ye.debug("applying delayed CDM updates");const n=Object.entries(e.mediaKeySessions);for(const d of n){const[n,p]=d;if(p.delayCdmUpdate){const d=yield p["license-json"];Ye.debug("delayed update of license",d),p.delayCdmUpdate=!1,yield e.handleLicenseJson(d,p.session,n)}}}))()}loadKeys(e,n,d){var p=this;return _async_to_generator$Z((function*(){yield p._mediaKeysSetup();const h=p.filterKeyValues(e);for(const e of h){const{dataUri:h}=e;yield p.createSessionAndGenerateRequest(h,n,d)}if(null==n?void 0:n.isLiveAudioStation){const e=Object.keys(p.mediaKeySessions),n=h.reduce((e,n)=>(e[n.dataUri]=!0,e),{});for(const d of e)n[d]||(yield p._scheduleRemoveSession(d))}}))()}filterKeyValues(e){let n;if(1===e.length)n=e;else{const d=un[this.keySystem];n=e.filter(e=>e.keyFormat===d)}return n}clearSessions(e){var n=this;return _async_to_generator$Z((function*(){const d=n.mediaKeySessions;if(null==e?void 0:e.length){const d=n.filterKeyValues(e);for(const e of d){const d=e.dataUri;clearTimeout(n._sessionRemovalTimeouts[d]),yield n._removeSessionImmediately(d)}}else{Object.values(n._sessionRemovalTimeouts).forEach(e=>clearTimeout(e)),Ye.debug("clearing key sessions",d);for(const e of Object.keys(d))yield n._removeSessionImmediately(e)}}))()}_scheduleRemoveSession(e){var n=this;return _async_to_generator$Z((function*(){if(!n.mediaKeySessions[e])return void Ye.warn("no session for dataUri, not scheduling remove",e);if(n._sessionRemovalTimeouts[e])return;const d=setTimeout(()=>{asAsync(n._removeSessionImmediately(e))},6e4);Ye.debug("deferring removal of keysession for dataUri",e),n._sessionRemovalTimeouts[e]=d}))()}_removeSessionImmediately(e){var n=this;return _async_to_generator$Z((function*(){const d=n.mediaKeySessions[e];if(!d)return void Ye.warn("no session for dataUri, not removing",e);Ye.debug("removing keysession for",e);const{session:p,oldSession:h}=d;n._clearSessionRenewal(p),delete n.mediaKeySessions[e],yield n._removeAndCloseSession(p),h&&(yield n._removeAndCloseSession(h))}))()}_removeAndCloseSession(e){var n=this;return _async_to_generator$Z((function*(){e.removeEventListener("message",n.startLicenseSession),Ye.debug("tearing down session",e.sessionId);try{yield e.remove()}catch(St){Ye.warn("Error invoking session.remove()",St)}finally{try{yield e.close()}catch(St){Ye.warn("Error invoking session.close()",St)}}}))()}_clearSessionRenewal(e){const n=this._mediaKeySessionRenewals[e.sessionId];n&&(Ye.debug("clearing scheduled license renewal for session",e.sessionId),clearTimeout(n),delete this._mediaKeySessionRenewals[e.sessionId])}constructor(...e){super(...e),_define_property$1q(this,"_keySystemAccess",void 0),_define_property$1q(this,"_mediaKeysPromise",void 0),_define_property$1q(this,"_mediaKeys",void 0),_define_property$1q(this,"_target",void 0),_define_property$1q(this,"_sessionRemovalTimeouts",{}),_define_property$1q(this,"_mediaKeySessionRenewals",{})}}function asyncGeneratorStep$Y(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$Y(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$Y(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Y(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1p(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const kn=BooleanDevFlag.register("mk-safari-modern-eme");class MediaExtension extends Notifications{get runtime(){return this.services.runtime}get hasMediaSession(){return void 0!==this._session}get isFairplay(){return this._session.isFairplay}set extURI(e){this._session.extURI=e}set initiated(e){this._session.initiated=e}get session(){return this._session}clearSessions(e){var n=this;return _async_to_generator$Y((function*(){var d;return null===(d=n.session)||void 0===d?void 0:d.clearSessions(e)}))()}initializeKeySystem(){var e=this;return _async_to_generator$Y((function*(){var n,d;const{mediaElement:p,contentType:h}=e;if(null===(n=window.WebKitMediaKeys)||void 0===n?void 0:n.isTypeSupported(Z.fairplay+".1_0",Qr.MP4)){let n;kn.enabled&&e.runtime.isEMESupported&&(n=yield function(e){return _requestModernFairplayAccess.apply(this,arguments)}(e.contentType)),void 0!==n?(Ye.warn("media-extension: Using Fairplay modern EME"),e._session=new FairplayEncryptedSession,e._session.attachMedia(p,n)):(Ye.warn("media-extension: Using Fairplay legacy EME"),e._session=new WebKitSession,e._session.attachMedia(p,{keySystem:Z.fairplay}))}else if(null===(d=window.MSMediaKeys)||void 0===d?void 0:d.isTypeSupported(Z.playready,Qr.MP4))e._session=new MSSession,e._session.attachMedia(p,{keySystem:Z.playready});else if(void 0!==e.runtime.preferredKeySystem&&p.canPlayType(h)){const n=Z[e.runtime.preferredKeySystem];if(void 0!==n){e._session=new PreloadingEncryptedSession;const d=yield getKeySystemAccess(n,{initDataTypes:["cenc","keyids"],audioCapabilities:[{contentType:h}],distinctiveIdentifier:"optional",persistentState:"required"});var y;if(d)null===(y=e._session)||void 0===y||y.attachMedia(p,d)}}else Ye.warn("No KeySystem available for playback!");void 0!==e._session&&[Wr.playbackLicenseError,Wr.playbackSessionError].forEach(n=>{e._session.addEventListener(n,d=>{e.dispatchEvent(n,d)})})}))()}setMediaItem(e){!function(e,n){n.keyURLs&&(e.developerToken=gn.developerToken,e.userToken=gn.musicUserToken,e.item=n,e.adamId=n.songId,e.isLibrary=n.isCloudItem,e.setKeyURLs(n.keyURLs))}(this._session,e)}destroy(e){var n;null===(n=this._session)||void 0===n||n.detachMedia(e)}constructor(e){super([Wr.playbackLicenseError,Wr.playbackSessionError]),_define_property$1p(this,"_session",void 0),_define_property$1p(this,"mediaElement",void 0),_define_property$1p(this,"contentType",void 0),_define_property$1p(this,"services",void 0),this.mediaElement=e.mediaElement,this.contentType=e.contentType,this.services=e.services}}function getKeySystemAccess(e,n){return _getKeySystemAccess.apply(this,arguments)}function _getKeySystemAccess(){return(_getKeySystemAccess=_async_to_generator$Y((function*(e,n){try{return navigator.requestMediaKeySystemAccess(e,[n])}catch(he){Ye.warn("Unable to get KeySystem access to "+e)}}))).apply(this,arguments)}function _requestModernFairplayAccess(){return(_requestModernFairplayAccess=_async_to_generator$Y((function*(e){return getKeySystemAccess(Z.fairplay,{initDataTypes:["skd"],audioCapabilities:[{contentType:e,robustness:""}],videoCapabilities:[{contentType:e,robustness:""}],distinctiveIdentifier:"not-allowed",persistentState:"not-allowed",sessionTypes:["temporary"]})}))).apply(this,arguments)}const En=BooleanDevFlag.register("mk-force-audio-mse"),shouldForceAudioMse=()=>En.enabled;function asyncGeneratorStep$X(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1o(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class ByteRangeSegment{load(){var e,n=this;return(e=function*(){const{url:e,range:d}=n;if(!e)return new Uint8Array;const p=new Headers;p.append("Range",d);const h=yield fetch(e,{headers:p}),y=yield h.arrayBuffer();return new Uint8Array(y)},function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$X(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$X(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor({url:e,startByte:n,length:d,isInitSegment:p=!1}){_define_property$1o(this,"url",void 0),_define_property$1o(this,"range",void 0),_define_property$1o(this,"startByte",void 0),_define_property$1o(this,"endByte",void 0),_define_property$1o(this,"length",void 0),_define_property$1o(this,"startTime",void 0),_define_property$1o(this,"endTime",void 0),_define_property$1o(this,"isInitSegment",void 0),this.url=e,this.isInitSegment=p,this.startByte=parseInt(n,10),this.length=parseInt(d,10),this.endByte=this.startByte+this.length-1,this.range=`bytes=${this.startByte}-${this.endByte}`}}function asyncGeneratorStep$W(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$1n(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class ContinuousSegment{load(){var e,n=this;return(e=function*(){const{url:e}=n;if(!e)return new Uint8Array;const d=yield fetch(e),p=yield d.arrayBuffer();return new Uint8Array(p)},function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$W(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$W(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,n=!1){_define_property$1n(this,"url",void 0),_define_property$1n(this,"isInitSegment",void 0),this.url=e,this.isInitSegment=n}}function _define_property$1m(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const wn=/^#EXT-X-BYTERANGE:([^\n]+)\n/gim,On=/^#EXT-X-MAP:([^\n]+)\n/im,In=/#EXTINF:\d*\.\d*\,[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim,$n=/#EXTINF:\d*\.\d*,\s*#EXT-X-BITRATE:\d{1,3}[\n](.+)|^#EXT-X-MAP:URI="([^"]*)"/gim,An=Ye.createChild("hls");class SegmentList{get segments(){return this._segments}addSegment(e,n){this._addedSegments[n]||(An.debug("Adding segment",n),this._segments.push(e),this._addedSegments[n]=!0)}extractLiveRadioSegments(e,n){this._extractContinuousSegments(In,e,n)}extractHlsOffersSegments(e,n){this._extractContinuousSegments($n,e,n)}_extractContinuousSegments(e,n,d){if(!n||!e.test(n))return;let p;for(e.lastIndex=0;p=e.exec(n);){const e=p[0].startsWith("#EXT-X-MAP")?p[2]:p[1];let n=e;/^http(s)?:\/\//.test(n)||(n=joinURLPath([...splitURLPath(d).slice(0,-1),e]));const h=p[0].startsWith("#EXT-X-MAP");this.addSegment(new ContinuousSegment(n,h),e)}}extractByteRangeSegments(e,n){if(!e||!wn.test(e))return;const d=function(e){if(!e||!On.test(e))return;const[,n]=e.match(On);return n.split(",").reduce((e,n)=>{const[d,p]=n.split("=");return e[d.toLowerCase()]=p.replace(/\"/gi,""),e},{})}(e);var p;const h=null!==(p=n.split("/").pop())&&void 0!==p?p:"",y=n.replace(h,d.uri),[_,m]=d.byterange.split("@"),g=new ByteRangeSegment({url:y,startByte:m,length:_});var b;this.addSegment(g,g.range),(null!==(b=e.match(wn))&&void 0!==b?b:[]).forEach(e=>{const[,n,d]=e.match(/^#EXT-X-BYTERANGE:(\d+)@(\d+)\n/),p=new ByteRangeSegment({url:y,startByte:d,length:n});this.addSegment(p,p.range)})}constructor(){_define_property$1m(this,"_segments",[]),_define_property$1m(this,"_addedSegments",{})}}var Rn=function(e){return e.keysParsed="keysParsed",e}({});function asyncGeneratorStep$V(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$V(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$V(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$V(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1l(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$s(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const Cn=/^#EXT-X-TARGETDURATION:(\d+)/im,Mn=/^#EXT-X-KEY:[^\n]+URI="([^"]+)"/im,Dn=/^#EXT-X-KEY:.*(.*$)/gim;class Manifest extends Notifications{parse(){const e=this._item,n=this._data;if("fairplay"!==this.services.runtime.preferredKeySystem||shouldForceAudioMse())if(this._detectKeyTags(),e.hasOffersHlsUrl)this._segmentList.extractHlsOffersSegments(n,e.assetURL);else if(e.isLiveRadioStation){this._segmentList.extractLiveRadioSegments(n,e.assetURL);const[,d]=this._data.match(Cn);Ye.debug(`manifest: setting up manifest refresh interval at ${d} seconds`);const p=1e3*parseInt(d,10);this._manifestRefreshInterval=setInterval(this.liveRadioRefresh,p)}else this._segmentList.extractByteRangeSegments(n,e.assetURL)}static load(e,n){var d=this;return _async_to_generator$V((function*(){Ye.debug("loading manifest for item",e.title);const p=e.assetURL,h=getSessionStorage();var y;const _=!!h&&(null===(y=n.cache)||void 0===y||y),m=n.services;if(_){const n=null==h?void 0:h.getItem(p);if(n)return new d(n,e,{services:m})}const g=(new Date).getTime(),b=yield m.request.fetchText(p),P=(new Date).getTime(),S=new d(b,e,{services:m});return S.downlink=8*b.length/((P-g)/1e3)/1024,_&&(null==h||h.setItem(p,b)),S}))()}get downlink(){return this._downlink}set downlink(e){this._downlink=e}get mediaItem(){return this._item}liveRadioRefresh(){var e=this;return _async_to_generator$V((function*(){const n=yield e.services.request.fetchText(e._url);e._data=n,e._detectKeyTags(),e._segmentList.extractLiveRadioSegments(n,e._url),e.dispatchEvent(Wr.manifestParsed)}))()}segmentsForTimeRange(e){const n=Math.floor(e.start/10)+1,d=Math.floor(e.end/10)+1,{segments:p}=this;return[p[0],...p.slice(n,d+1)]}get segments(){return this._segmentList.segments}get extURI(){if(!this._extURI){const e=this._data.match(Mn);Ye.debug("manifest: EXT_X_KEY_URI matches",e),this._extURI=e&&e[1]||void 0}return this._extURI}get keyValues(){let e=this._modernKeys;return e.length||(e=this._legacyKeys),e}_detectKeyTags(){const e=this.keyValues;e.length&&this.dispatchEvent(Rn.keysParsed,{item:this.mediaItem,keys:e})}get _legacyKeys(){const e=this._data.match(Mn);Ye.debug("manifest: EXT_X_KEY_URI matches",e);const n=e&&e[1]||void 0;this._extURI=n;const d=[];return n&&d.push({keyFormat:un[Z.widevine],dataUri:n}),d}get _modernKeys(){let e;const n=[];for(;e=Dn.exec(this._data);){var d,p;const _=e[0];var h;const m=null!==(h=null===(d=/KEYFORMAT="(.*?)"/.exec(_))||void 0===d?void 0:d[1])&&void 0!==h?h:"";var y;const g=null!==(y=null===(p=/URI="(.*?)"/.exec(_))||void 0===p?void 0:p[1])&&void 0!==y?y:"";m&&g&&n.push({keyFormat:m,dataUri:g})}return n}stop(){this._manifestRefreshInterval&&clearInterval(this._manifestRefreshInterval)}constructor(e,n,d){super([Wr.manifestParsed,Rn.keysParsed]),_define_property$1l(this,"_data",void 0),_define_property$1l(this,"_downlink",0),_define_property$1l(this,"_extURI",void 0),_define_property$1l(this,"_url",void 0),_define_property$1l(this,"_item",void 0),_define_property$1l(this,"_segmentList",new SegmentList),_define_property$1l(this,"_manifestRefreshInterval",void 0),_define_property$1l(this,"services",void 0),this._data=e,this._item=n,this._url=n.assetURL,this.services=d.services}}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$s("design:type",Function),_ts_metadata$s("design:paramtypes",[]),_ts_metadata$s("design:returntype",Promise)],Manifest.prototype,"liveRadioRefresh",null);const jn="seamlessAudioTransition",xn="bufferTimedMetadataDidChange",Nn="loadSegmentError";function encodedArrayToString(e,n="utf-8"){return"iso-8859-1"===n?String.fromCharCode(...e):new TextDecoder(n).decode(e)}function readNullTerminatedString(e,n=0,d){const p=[];d=null!=d?d:e.length;for(let h=n;h<d;h++){const n=e[h];if("\0"===String.fromCharCode(n))break;p.push(String.fromCharCode(n))}return[p.join(""),p.length]}function _define_property$1k(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class BaseMp4Box{get size(){return this.end-this.start}get rawBytes(){return this.data.slice(this.start,this.end)}constructor(e,n,d,p){_define_property$1k(this,"id",void 0),_define_property$1k(this,"data",void 0),_define_property$1k(this,"start",void 0),_define_property$1k(this,"end",void 0),this.id=e,this.data=n,this.start=d,this.end=p}}const Ln=[237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237];class PsshBox extends BaseMp4Box{get systemId(){const{data:e,start:n}=this,d=n+12;return e.slice(d,d+16)}get dataSize(){return this.view.getUint32(28)}get psshData(){const{data:e,start:n,dataSize:d}=this,p=n+32;return e.slice(p,p+d)}get keyBytes(){const{psshData:e}=this;return e.slice(2,18)}get isWidevine(){return arrayEquals(this.systemId,Ln)}constructor(e,n,d){super("pssh",e,n,d),function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"view",void 0),this.view=new DataView(e.buffer,n)}}function _define_property$1i(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class TencBox extends BaseMp4Box{get isProtected(){const{data:e,start:n}=this;return e[n+14]}get defaultKeyId(){const{data:e,start:n}=this;return e.slice(n+16,n+32)}set defaultKeyId(e){const{data:n,start:d}=this;for(let p=0;p<e.length;p++)n[p+d+16]=e[p]}constructor(e,n,d){super("tenc",e,n,d),_define_property$1i(this,"data",void 0),_define_property$1i(this,"start",void 0),_define_property$1i(this,"end",void 0),this.data=e,this.start=n,this.end=d}}function findBox(e,n,d=[]){for(let p=n;p<e.length;){if(0===d.length)return;const n=new DataView(e.buffer,p).getUint32(0),h=encodedArrayToString(e.subarray(p+4,p+8)),y=p+n;if(1===d.length&&h===d[0])return new BaseMp4Box(h,e,p,y);if(h===d[0])return findBox(e,p+8,d.slice(1));p+=n}}const rewriteDefaultKid=e=>{const[n]=function(e){const n=findBox(e,0,["moov","trak","mdia","minf","stbl","stsd"]),d=[];if(!n)return d;for(let p=n.start+16;p<n.end;){let h=findBox(e,p,["enca"]),y=36;if(h||(h=findBox(e,p,["encv"]),y=86),!h)return d;const _=findBox(e,h.start+y,["sinf","schi","tenc"]);_?(d.push(new TencBox(_.data,_.start,_.end)),p=_.end):p=n.end}return d}(e);if(!n)return;const d=function(e){const n=findBox(e,0,["moov"]),d=[];if(!n)return d;const p=new DataView(e.buffer,0);for(let h=n.start+8;h<n.size;){const n=p.getUint32(h);"pssh"===encodedArrayToString(e.subarray(h+4,h+8))&&d.push(new PsshBox(e,h,h+n)),h+=n}return d}(e).find(e=>e.isWidevine);d&&(n.defaultKeyId=d.keyBytes)};function _define_property$1h(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class ID3Tag{get major(){return this.version[0]}get minor(){return this.version[1]}get revision(){var e;return null!==(e=this.version[2])&&void 0!==e?e:0}static parse(e){return function(e){if(0===e.length||"ID3"!==function(e,n=0){return decodeString(e.subarray(n,3))}(e))return;const n={};let d=3;n.version=[3,e[d++],e[d++]],n.flags=function(e,n=5){const d=e[n];return{unsynchronized:decodeBitFlag(d,7),extendedHeader:decodeBitFlag(d,6),experimental:decodeBitFlag(d,5),footer:decodeBitFlag(d,4)}}(e),d+=1;const p=d+4+decodeSynchSafeUint32(e.subarray(d,d+4));d+=4,n.flags.extendedHeader&&(d+=decodeSynchSafeUint32(e.subarray(d,d+4)));n.version[1]>2&&(n.frames=decodeID3Frames(e,n.version,[d,p]));return new ID3Tag(n)}(e)}constructor(e){var n;_define_property$1h(this,"version",[3,2,0]),_define_property$1h(this,"frames",[]),_define_property$1h(this,"flags",{unsynchronized:!1,extendedHeader:!1,footer:!1,experimental:!1}),this.version=e.version,this.flags=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1h(e,n,d[n])}))}return e}({unsynchronized:!1,extendedHeader:!1,footer:!1,experimental:!1},e.flags),this.frames=null!==(n=e.frames)&&void 0!==n?n:[]}}const Un={WXXX:function(e,n,d){const p=decodeCharset(n[0]),[h,y]=decodeNullTerminatedString(n.subarray(1),p),_=y>0?y+2:0;return{key:"WXXX",data:decodeString(n.subarray(_),p),description:h}},TXXX:function(e,n,d){const p=decodeCharset(n[0]),[h,y]=decodeNullTerminatedString(n.subarray(1),p),_=y>0?y+2:0;return{key:"TXXX",data:decodeString(n.subarray(_),p),description:h}},TPE1:function(e,n,d){return{key:"TPE1",data:trimNull(decodeString(n.subarray(1),decodeCharset(n[0])))}},TIT2:function(e,n,d){return{key:"TIT2",data:trimNull(decodeString(n.subarray(1),decodeCharset(n[0])))}},TALB:function(e,n,d){return{key:"TALB",data:trimNull(decodeString(n.subarray(1),decodeCharset(n[0])))}},TEXT:function(e,n,d){return{key:"TEXT",data:trimNull(decodeString(n.subarray(1),decodeCharset(n[0])))}},PRIV:function(e,n,d){const[p,h]=decodeNullTerminatedString(n);if(0===h)return;return{key:"PRIV",owner:p,data:n.slice(h+1)}},CHAP:function(e,n,d){const p=new DataView(n.buffer),h={key:"CHAP",elementId:"",startTime:0,endTime:0,frames:[]},[y,_]=decodeNullTerminatedString(n);h.elementId=y;let m=_+1;return h.startTime=p.getUint32(m),m+=4,h.endTime=p.getUint32(m),m+=4,h.startOffset=p.getUint32(m),m+=4,h.endOffset=p.getUint32(m),m+=4,h.frames=decodeID3Frames(n,d,[m,n.length]),h}};function decodeID3Frames(e,n,d){var p;const h=null!==(p=(d=null!=d?d:[0,e.byteLength])[1])&&void 0!==p?p:e.byteLength;var y;let _=null!==(y=d[0])&&void 0!==y?y:0;const m=new DataView(e.buffer,0,h),g=[];for(;_+8<=h;){var b;const d=decodeString(e.subarray(_,_+4));_+=4;const p=4===n[1]?decodeSynchSafeUint32(e.subarray(_,_+4)):m.getUint32(_);if(_+=4,e[_++],e[_++],_+p>h)break;const y=e.slice(_,_+p),P=null===(b=Un[d])||void 0===b?void 0:b.call(Un,d,y,n);P&&g.push(P),_+=p}return g}function decodeString(e,n="utf-8"){return new TextDecoder(n).decode(e)}function decodeBitFlag(e,n){return 0!=(e&1<<n)}const Fn={0:"iso-8859-1",1:"utf-16",2:"utf-16be",3:"utf-8"};function decodeCharset(e){var n;return null!==(n=Fn[e])&&void 0!==n?n:"iso-8859-1"}function trimNull(e){return e.replace(/^\0*|\0*/g,"")}function decodeNullTerminatedString(e,n="utf-8",d=0){const p=[];for(let h=d;h<e.byteLength;h++){const n=e[h];if(0===n)break;p.push(n)}return[decodeString(new Uint8Array(p),n),p.length]}function decodeSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}function checkBoxName(e,n,d){return!(n+4>e.length)&&(e[n]===d[0]&&e[n+1]===d[1]&&e[n+2]===d[2]&&e[n+3]===d[3])}function findEmsgs(e){const n=e.length,d=[];if(function(e){return(null==e?void 0:e.length)>=8&&checkBoxName(e,4,[102,116,121,112])}(e))return d;for(let p=0;p<n;p++){if(checkBoxName(e,p,[109,111,111,102]))return d;if(checkBoxName(e,p,[101,109,115,103])){const n=p-4,h=new DataView(e.buffer,n).getUint32(0),y=e.subarray(n,n+h);p=p+h-1,d.push(y)}}return d}function _define_property$1g(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class TimedMetadata{storefrontAdamId(e){var n;return null===(n=this.storefrontAdamIds)||void 0===n?void 0:n[e]}equals(e){return function(e,n){var d,p,h,y;if(void 0===e&&void 0===n)return!0;if(typeof e!=typeof n)return!1;if(n=n,(e=e).album!==n.album||e.title!==n.title||e.performer!==n.performer)return!1;if((null===(d=e.links)||void 0===d?void 0:d.length)!==(null===(p=n.links)||void 0===p?void 0:p.length))return!1;for(let g=0;g<(null!==(y=null===(h=e.links)||void 0===h?void 0:h.length)&&void 0!==y?y:0);g++){var _,m;if(!objectKeyValueEquals(null===(_=e.links)||void 0===_?void 0:_[g],null===(m=n.links)||void 0===m?void 0:m[g]))return!1}if(!objectKeyValueEquals(e.storefrontAdamIds,n.storefrontAdamIds))return!1;if(!compareUint8Array(e.blob,n.blob))return!1;return!0}(this,e)}constructor(e){var n;_define_property$1g(this,"performer",void 0),_define_property$1g(this,"title",void 0),_define_property$1g(this,"album",void 0),_define_property$1g(this,"links",void 0),_define_property$1g(this,"storefrontAdamIds",void 0),_define_property$1g(this,"blob",void 0),this.performer=null==e?void 0:e.performer,this.title=null==e?void 0:e.title,this.album=null==e?void 0:e.album,this.links=null==e?void 0:e.links,this.storefrontAdamIds=null!==(n=null==e?void 0:e.storefrontAdamIds)&&void 0!==n?n:{},this.blob=null==e?void 0:e.blob}}function objectKeyValueEquals(e,n){if(void 0===e&&void 0===n)return!0;if(typeof e!=typeof n)return!1;e=e,n=n;const d=Object.keys(e),p=Object.keys(n);if(d.length!==p.length)return!1;for(const h of d)if(e[h]!==n[h])return!1;return!0}function parseStorefrontAdamIds(e){let n;n="Uint8Array"===e.constructor.name?new TextDecoder("utf-8").decode(e):e;const d=n.trim().split(",");if(0===d.length)return;const isEmptyString=e=>void 0===e||""===e,p={};for(const h of d){const[e,n]=h.split(":",2).map(e=>e.trim());isEmptyString(e)||isEmptyString(n)||"0"===n||void 0!==p[e]||(p[e]=n)}return p}function parsePingBlob(e){return"string"==typeof e?Uint8Array.from(atob(e),e=>e.charCodeAt(0)):e}function _define_property$1f(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class Emsg{get length(){return this.data.length}get elementPresentationTime(){const{presentationTime:e,timeScale:n}=this;return e&&n?Math.round(e/n):NaN}get timedMetadata(){var e;if(this._timedMetadata)return this._timedMetadata;const n=null===(e=this.id3)||void 0===e?void 0:e.frames;return n?(this._timedMetadata=function(e){const n={};for(const p of e)if(void 0!==p.key)switch(p.key){case"TALB":n.album=p.data;break;case"TIT2":n.title=p.data;break;case"TPE1":n.performer=p.data;break;case"WXXX":var d;if(void 0!==p.description)if(void 0===n.links&&(n.links=[]),!n.links.some(e=>e.url===p.data))n.links.push({description:null!==(d=p.description)&&void 0!==d?d:"",url:p.data});break;case"PRIV":"com.apple.radio.adamid"===p.owner&&(n.storefrontAdamIds=parseStorefrontAdamIds(p.data)),"com.apple.radio.ping.jingle"===p.owner&&(n.blob=parsePingBlob(p.data))}return new TimedMetadata(n)}(n),this._timedMetadata):void 0}constructor(e){_define_property$1f(this,"data",void 0),_define_property$1f(this,"schemeIdUri",void 0),_define_property$1f(this,"eventDuration",void 0),_define_property$1f(this,"presentationTime",void 0),_define_property$1f(this,"payload",void 0),_define_property$1f(this,"timeScale",void 0),_define_property$1f(this,"id3",void 0),_define_property$1f(this,"id",void 0),_define_property$1f(this,"_timedMetadata",void 0),this.data=e;const n=new DataView(e.buffer);let d=8;if(1!==e[d])return;d+=4,this.timeScale=n.getUint32(d),d+=4;const p=n.getUint32(d);d+=4;const h=n.getUint32(d);if(d+=4,this.presentationTime=Math.pow(2,32)*p+h,!Number.isSafeInteger(this.presentationTime))throw this.presentationTime=Number.MAX_SAFE_INTEGER,new Error("Failed to create 64 bit integer");this.eventDuration=n.getUint32(d),d+=4,this.id=n.getUint32(d),d+=4;const[y,_]=readNullTerminatedString(e,d);d+=_+1,this.schemeIdUri=y;const[m,g]=readNullTerminatedString(e,d);d+=g+1,this.payload=e.subarray(d,e.byteLength),this.id3=ID3Tag.parse(this.payload)}}function _define_property$1e(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class TimedMetadataManager{processEmsgs(e){const n=findEmsgs(e);n.length&&(this._currentEmsgInterval||(this._currentEmsgInterval=setInterval(this._getCurrentEmsg,1e3)),n.forEach(e=>{const n=new Emsg(e);this._emsgLookup[n.elementPresentationTime]=n}))}stop(){const{_currentEmsgInterval:e}=this;e&&clearInterval(e)}_getCurrentEmsg(){const{_currentTime:e,_emsgLookup:n}=this,d=Math.round(e()),p=[],h=Object.keys(n);for(let _=0;_<h.length;_++){const e=parseInt(h[_],10);if(!(e<d))break;p.push(e)}const y=p.pop();if(y){const e=n[y];if(!e)return;const{_currentEmsg:d,_onDidChange:p}=this,h=null==d?void 0:d.payload,_=e.payload;h&&arrayEquals(h,_)||(this._currentEmsg=e,p(e)),this._cleanupEmsgs(y)}}_cleanupEmsgs(e){const{_emsgLookup:n}=this;Object.keys(n).forEach(d=>{parseInt(d,10)<e&&delete n[d]})}constructor(e,n){_define_property$1e(this,"_currentTime",void 0),_define_property$1e(this,"_onDidChange",void 0),_define_property$1e(this,"_currentEmsgInterval",void 0),_define_property$1e(this,"_emsgLookup",void 0),_define_property$1e(this,"_currentEmsg",void 0),this._currentTime=e,this._onDidChange=n,this._emsgLookup={},this._getCurrentEmsg=this._getCurrentEmsg.bind(this)}}function _define_property$1d(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class SegmentProcessor{process(e,n){const{_item:d}=this;try{d.isLiveRadioStation?this._processLiveRadioSegment(e,n):d.hasOffersHlsUrl&&this._processHlsOffersSegment(e,n)}catch(St){Ye.error("Error processing segment",St)}}stop(){this._timedMetadataManager.stop()}_processHlsOffersSegment(e,n){e.isInitSegment&&rewriteDefaultKid(n)}_processLiveRadioSegment(e,n){e.isInitSegment&&rewriteDefaultKid(n),this._timedMetadataManager.processEmsgs(n)}constructor(e,n,d){_define_property$1d(this,"_item",void 0),_define_property$1d(this,"_timedMetadataManager",void 0),this._item=e,this._timedMetadataManager=new TimedMetadataManager(()=>n.currentTime,e=>{d.publish(xn,{item:this._item,metadata:e.timedMetadata,position:n.currentTime,playingDate:void 0})})}}function asyncGeneratorStep$U(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$U(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$U(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$U(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1c(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$r(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$r(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const Kn=Ye.createChild("mse"),Bn=BooleanDevFlag.get("mk-mse-buffer"),{manifestParsed:Vn}=Wr;class MseBuffer{onSourceOpen(){Kn.debug("mediaSource open handler");const{mediaSource:e}=this;if(e.activeSourceBuffers.length>0)return void Kn.debug("not adding new source buffer");Kn.debug("adding new source buffer");const n=e.addSourceBuffer('audio/mp4;codecs="mp4a.40.2"');this.sourceBuffer=n,n.addEventListener("updateend",this.updateEndHandler);const{clip:d,hasAppendWindowSupport:p}=this;d&&(p?(Kn.debug("appendWindowStart/End",d.start,d.end),n.appendWindowStart=d.start,n.appendWindowEnd=d.end):(Kn.debug("seeking for clip",d.start),asAsync(this.seek(d.start)))),this.updateSegmentToFetch(0,!0)}setNextManifest(e){Kn.debug("setting next manifest for ",e.mediaItem.title),this.nextSeamlessTransition?(Kn.debug("abandoning transition scheduled for "+this.nextSeamlessTransition),this.revertSeamlessTransition(!0),this.playbackTimeline.next={manifest:e}):(this.playbackTimeline.next={manifest:e},this.isFullyBuffered&&(Kn.debug("current song is fully buffered, beginning transition to next"),this.transitionToNextManifest()))}isItemPlaying(e){var n,d;const{playbackTimeline:p}=this,h=this.nextSeamlessTransition?null===(n=p.previous)||void 0===n?void 0:n.manifest.mediaItem:null===(d=p.current)||void 0===d?void 0:d.manifest.mediaItem;return!!h&&(Kn.debug(`isItemPlaying ${e.title}, ${h.title}, ${e.id===h.id}`),e.id===h.id)}get currentItem(){return this.manifest.mediaItem}get playableUrl(){let e=this._playableUrl;return e||(e=window.URL.createObjectURL(this.mediaSource),Kn.debug("created url",e),this._playableUrl=e,e)}get segments(){const{manifest:e,clip:n}=this;return n?e.segmentsForTimeRange(n):e.segments||[]}get currentTime(){return this._currentTime}set currentTime(e){if(e+=this.currentTimestampOffset,this._currentTime===e)return;const{nextSeamlessTransition:n}=this;if(n&&e>=n){var d,p;Kn.debug("setting offset to",n),this.currentTimestampOffset=n||0,this.nextSeamlessTransition=void 0,this.duration=this.manifest.mediaItem.playbackDuration/1e3,Kn.debug("buffer setting duration to",this.duration);const e={previous:null===(p=this.playbackTimeline.previous)||void 0===p||null===(d=p.manifest)||void 0===d?void 0:d.mediaItem,current:this.manifest.mediaItem};Kn.debug("dispatching seamless audio transition",e),this.dispatcher.publish(jn,e)}this._currentTime=e;const{isOverBufferLimit:h,timeToTrim:y}=this,_=e>this.timeToTrim;h&&_&&(Kn.debug("buffer over limit, trimming to ",y),this.removeToTime(y),this.timeToTrim+=10)}get hasAppendWindowSupport(){var e;return void 0!==(null===(e=this.sourceBuffer)||void 0===e?void 0:e.appendWindowStart)}seek(e){var n=this;return _async_to_generator$U((function*(){const{duration:d,seekWhenUpdated:p,sourceBuffer:h}=n;if(n.resolveSeekPromise(!1),Kn.debug("seek to ",e),(e=+e)>d&&(Kn.debug("rounding seek time to duration",e,d),e=d),!h)return!1;if(n.revertSeamlessTransition(),h.updating)return Kn.debug("sourcebuffer updating, deferring seek"),new Promise(d=>{p&&p.resolve(!1),n.seekWhenUpdated={seek:n.seek.bind(n,e),resolve:d}});n.currentlyLoadingSegmentIndex=void 0,n.updateSegmentToFetch(0,!0),n.removeToTime(e),n.timeToTrim=10*Math.floor(e/10);const y=n.getSegmentForTime(e);0!==y&&(yield n.firstSegmentLoadPromise),Kn.debug("seeking to",e,"segment",y),n.updateSegmentToFetch(y,!0);const _=new Promise(d=>{n.seekResolver={time:e,resolve:d}});return n.checkSeekBuffered(),_}))()}clearNextManifest(){this.revertSeamlessTransition(!0),this.playbackTimeline.next=void 0}revertSeamlessTransition(e=!1){const{playbackTimeline:n,nextSeamlessTransition:d}=this;if(!d||!n.previous)return void Kn.debug("no need to revert, no transition");this.isAtEndOfStream=e,Kn.debug("reverting seamless transition with discardNextManifest",e),e?this.clearBufferToEnd(d):this.clearBuffer(),Kn.debug("abandoning transition to "+this.manifest.mediaItem.title),n.next=e?void 0:n.current,n.current=n.previous,n.previous=void 0;const p=this.manifest.mediaItem;Kn.debug("current item reverted to "+p.title),this.nextSeamlessTransition=void 0,this.duration=p.playbackDuration/1e3,Kn.debug("reverted duration to "+this.duration),e||(this.currentTimestampOffset=0,this.timestampOffsetAdjustment=0,Kn.debug("reverted currentTimestampOffset and timestampOffsetAdjustment to 0")),this.printInfo(),this.segmentIndexToFetch=-1}get streamHasEnding(){return!this.manifest.mediaItem.isLiveRadioStation}stop(){this.segmentProcessor.stop(),this.setEndOfStream(),this.remove()}remove(){var e;Kn.debug("removing sourceBuffer and mediaSource");const{sourceBuffer:n,mediaSource:d}=this;null===(e=this.seekResolver)||void 0===e||e.resolve(!1),this.manifest.removeEventListener(Vn,this.onManifestParsed);const p=this._playableUrl;p&&(Kn.debug("revoking url",p),window.URL.revokeObjectURL(p)),d.removeEventListener("sourceopen",this.onSourceOpen),n&&(n.removeEventListener("updateend",this.updateEndHandler),this.sourceBuffer=void 0)}onManifestParsed(){const e=this.segmentIndexToFetch+1;Kn.debug("manifestParsed, loading segment",e),this.updateSegmentToFetch(e,!0)}updateEndHandler(){if(this.kickstartBuffer(),this.clearDeferredRemove())return;if(Kn.debug("update end",this.seekWhenUpdated),this.seekWhenUpdated){Kn.debug("updateEndHandler resolving seekWhenUpdated");const{seekWhenUpdated:e}=this;return asAsync(e.seek().then(e.resolve)),void(this.seekWhenUpdated=void 0)}this.checkSeekBuffered();const{clip:e,sourceBuffer:n,hasAppendWindowSupport:d}=this;if(e&&n&&!d){const{buffered:d}=n;if(this.isTimeBuffered(e.end+1)){const p=d.end(d.length-1);return Kn.debug("clipping sourcebuffer to",e.end,p),void n.remove(e.end,p)}}if(this.isAtEndOfStream)return Kn.debug("buffer is at end of stream"),this.streamHasEnding&&(Kn.debug("isAtEndOfStream, not fetching any more segments"),this.playbackTimeline.next||this.setEndOfStream(),this.transitionToNextManifest()),void(this.isAtEndOfStream=!1);Kn.debug("updateEndHandler invoking loadSegment"),asAsync(this.loadSegment())}clearDeferredRemove(){if(0===this.deferredRemoves.length)return!1;const e=this.deferredRemoves.shift();var n;(Kn.trace("clearDeferredRemove",e),e.end>e.start)?null===(n=this.sourceBuffer)||void 0===n||n.remove(e.start,e.end):e.end<=e.start&&Kn.warn(`Trying to remove an invalid time range from SourceBuffer: |${e.start} <=> ${e.end}| (${e.end-e.start})`);return!0}transitionToNextManifest(){var e;Kn.debug("beginning transition to next manifest");const{playbackTimeline:n,sourceBuffer:d}=this;if(!n.next||!d)return void Kn.debug("no next manifest");const p=this.endOfBufferTime||this.currentTimestampOffset;Kn.debug("setting seamless transition at",p),this.nextSeamlessTransition=p,this.timestampOffsetAdjustment=p,this.playbackTimeline.current.endTime=p,n.previous=n.current,Kn.debug("previous manifest set to",null===(e=n.previous)||void 0===e?void 0:e.manifest.mediaItem.title),n.current=n.next,Kn.debug("current manifest set to",n.current.manifest.mediaItem.title),n.next=void 0,this.updateSegmentToFetch(0,!0),this.printInfo()}updateSegmentToFetch(e,n=!1){this.segments.length&&e<this.segments.length&&e!==this.segmentIndexToFetch&&(this.segmentIndexToFetch=e,n&&(Kn.debug("updateSegmentToFetch invoking loadSegment"),asAsync(this.loadSegment())))}loadSegment(){var e=this;return _async_to_generator$U((function*(){const n=e.segmentIndexToFetch,d=e.segments[n];if(n!==e.currentlyLoadingSegmentIndex){if(d)try{Kn.debug("begin loadSegment "+n),e.currentlyLoadingSegmentIndex=n;const h=d.load();0===n&&(e.firstSegmentLoadPromise=h);const y=yield h;if(0!==n&&n!==e.segmentIndexToFetch)return void Kn.debug("load segment index to fetch changed, not processing bytes for segment",n);e.segmentProcessor.process(d,y),Kn.debug("loadSegment processed: "+n);const{sourceBuffer:_,timestampOffsetAdjustment:m}=e;if(!_)return;try{"number"==typeof m&&(Kn.debug("adjusting timestampOffset of sourcebuffer to",m),_.timestampOffset=m,e.timestampOffsetAdjustment=void 0),_.appendBuffer(y),e.isFullyBuffered=!1,e.isOverBufferLimit=!1,Kn.debug("appended to buffer",y.length),e.printBufferTimes(),n===e.segments.length-1?e.isAtEndOfStream=!0:n===e.segmentIndexToFetch&&(Kn.debug("loadSegment bumping segment index to fetch to ",n+1),e.updateSegmentToFetch(n+1))}catch(p){"QuotaExceededError"===p.name?(e.isOverBufferLimit=!0,Kn.debug("reached buffer limit")):Kn.warn("Error appending to source buffer",p)}}catch(St){Kn.error("Error loading segment",St),e.dispatcher.publish(Nn,St)}finally{e.currentlyLoadingSegmentIndex=void 0}}else Kn.debug(`segment ${n} is currently loading, not loading it again`)}))()}setEndOfStream(){const{sourceBuffer:e,mediaSource:n}=this;e&&"ended"!==n.readyState&&(e.updating||"open"!==n.readyState?Kn.error("Could not end of stream (updating, readyState)",e.updating,n.readyState):(Kn.debug("mediaSource.endOfStream"),n.endOfStream(),this.isFullyBuffered=!0))}removeToTime(e){Kn.debug("removing to time",e),e>0&&(this.isTimeBuffered(e)||this.isOverBufferLimit)&&this.safeSourceBufferRemove(0,e)}safeSourceBufferRemove(e,n){Kn.trace("safeSourceBufferRemove",e,n);const{sourceBuffer:d}=this;d&&(d.updating?this.deferredRemoves.push({start:e,end:n}):n<=e?Kn.warn(`Trying to remove an invalid time range from SourceBuffer: |${e} <=> ${n}| (${n-e})`):d.remove(e,n))}get previousOffset(){var e,n;return(null===(n=this.playbackTimeline)||void 0===n||null===(e=n.previous)||void 0===e?void 0:e.endTime)||0}get manifest(){var e;return null===(e=this.playbackTimeline.current)||void 0===e?void 0:e.manifest}checkSeekBuffered(){const{seekResolver:e,currentTimestampOffset:n}=this;if(!e)return;const{time:d}=e,p=d+n,h=this.isTimeBuffered(p);Kn.debug("resolving seek for time, adjustedTime, isBuffered",d,p,h),this.printBufferTimes(),h&&(Kn.debug("resolving seek to true for time:",p),this.element.currentTime=p,this.resolveSeekPromise(!0))}resolveSeekPromise(e){this.seekResolver&&(this.seekResolver.resolve(e),this.seekResolver=void 0)}get endOfBufferTime(){var e;const n=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;return!(!n||!n.length)&&n.end(n.length-1)}isTimeBuffered(e){var n;const d=null===(n=this.sourceBuffer)||void 0===n?void 0:n.buffered;if(!d)return!1;for(let p=0;p<d.length;p++)if(Kn.debug("isTimeBuffered",d.start(p),e,d.end(p)),e>=d.start(p)&&e<=d.end(p))return!0;return!1}clearBufferToEnd(e){const{sourceBuffer:n}=this;if(!n||!n.buffered)return;const d=n.buffered.end(n.buffered.length-1);this.safeSourceBufferRemove(e,d)}clearBuffer(){const{sourceBuffer:e}=this;if(!e||!e.buffered)return;const n=e.buffered;for(let d=0;d<n.length;d++)this.safeSourceBufferRemove(n.start(d),n.end(d))}get bufferTimesString(){var e;const n=null===(e=this.sourceBuffer)||void 0===e?void 0:e.buffered;if(!n)return"";const d=[];for(let p=0;p<n.length;p++)d.push(`start ${n.start(p)} end: ${n.end(p)}`);return d.join(",")}printBufferTimes(){Bn&&Kn.debug("buffer times",this.bufferTimesString)}getSegmentForTime(e){return Math.floor(e/10)+1}kickstartBuffer(){const{hasKickstarted:e,element:n,clip:d}=this,{buffered:p}=n;e||(this.manifest.mediaItem.isSong?d&&this.isTimeBuffered(d.start)&&(n.currentTime=d.start,this.hasKickstarted=!0):p.length&&(n.currentTime=p.start(0),this.hasKickstarted=!0))}printInfo(){var e,n;const{playbackTimeline:d}=this;Kn.info("---- Buffer Info ----"),Kn.info("currently buffering item",d.current.manifest.mediaItem.title),Kn.info("next item to buffer",null===(e=d.next)||void 0===e?void 0:e.manifest.mediaItem.title),Kn.info("previously buffered item",null===(n=d.previous)||void 0===n?void 0:n.manifest.mediaItem.title),Kn.info("currentTimestampOffset",this.currentTimestampOffset),Kn.info("currentTime",this.currentTime),Kn.info("duration",this.duration),Kn.info("nextSeamlessTransition",this.nextSeamlessTransition),Kn.info("timestampOffsetAdjustment",this.timestampOffsetAdjustment),Kn.info("buffered times",this.bufferTimesString),Kn.info("isAtEndOfStream",this.isAtEndOfStream),Kn.info("isFullyBuffered",this.isFullyBuffered),Kn.info("segmentIndexToFetch",this.segmentIndexToFetch),Kn.info("segments.length",this.segments.length),Kn.info("---- End Buffer Info ----")}constructor({dispatcher:e,element:n,manifest:d,currentTime:p,duration:h,clip:y}){_define_property$1c(this,"dispatcher",void 0),_define_property$1c(this,"mediaSource",void 0),_define_property$1c(this,"sourceBuffer",void 0),_define_property$1c(this,"element",void 0),_define_property$1c(this,"_currentTime",void 0),_define_property$1c(this,"currentlyLoadingSegmentIndex",void 0),_define_property$1c(this,"duration",void 0),_define_property$1c(this,"firstSegmentLoadPromise",Promise.resolve()),_define_property$1c(this,"hasKickstarted",!1),_define_property$1c(this,"isOverBufferLimit",void 0),_define_property$1c(this,"seekResolver",void 0),_define_property$1c(this,"seekWhenUpdated",void 0),_define_property$1c(this,"segmentIndexToFetch",-1),_define_property$1c(this,"segmentProcessor",void 0),_define_property$1c(this,"timeToTrim",10),_define_property$1c(this,"isAtEndOfStream",!1),_define_property$1c(this,"isFullyBuffered",!1),_define_property$1c(this,"_playableUrl",void 0),_define_property$1c(this,"clip",void 0),_define_property$1c(this,"deferredRemoves",[]),_define_property$1c(this,"timestampOffsetAdjustment",void 0),_define_property$1c(this,"playbackTimeline",void 0),_define_property$1c(this,"currentTimestampOffset",0),_define_property$1c(this,"nextSeamlessTransition",void 0),this.dispatcher=e,this.clip=y,this.element=n,this.mediaSource=new MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.segmentProcessor=new SegmentProcessor(d.mediaItem,n,e),this.playbackTimeline={current:{manifest:d}},d.addEventListener(Vn,this.onManifestParsed),this._currentTime=p||0,this.duration=h,window.mseBuffer=this}}function asyncGeneratorStep$T(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$T(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$T(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$T(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1b(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$q(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$q(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[]),_ts_metadata$r("design:returntype",void 0)],MseBuffer.prototype,"onSourceOpen",null),_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[]),_ts_metadata$r("design:returntype",void 0)],MseBuffer.prototype,"onManifestParsed",null),_ts_decorate$r([Bind(),_ts_metadata$r("design:type",Function),_ts_metadata$r("design:paramtypes",[]),_ts_metadata$r("design:returntype",void 0)],MseBuffer.prototype,"updateEndHandler",null);const{mediaPlaybackError:Gn}=at;class AudioPlayer extends BasePlayer{destroy(){var e=this,_superprop_get_destroy=()=>super.destroy;return _async_to_generator$T((function*(){_superprop_get_destroy().call(e),e._dispatcher.unsubscribe(Nn,e.onLoadSegmentError)}))()}onLoadSegmentError(e){this._dispatcher.publish(Gn,new MKError(MKError.Reason.MEDIA_SESSION,e)),this.destroy()}get currentPlayingDate(){}get isPlayingAtLiveEdge(){return!1}get seekableTimeRanges(){return this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get supportsPreviewImages(){return!1}get _targetElement(){return this.audio}initializeExtension(){var e=this;return _async_to_generator$T((function*(){e.extension=new MediaExtension({mediaElement:e.audio,contentType:'audio/mp4;codecs="mp4a.40.2"',services:{runtime:e.services.runtime}}),yield e.extension.initializeKeySystem(),e.extension.addEventListener(Wr.playbackLicenseError,n=>{e.resetDeferredPlay(),e._dispatcher.publish(Gn,n)}),e.extension.addEventListener(Wr.playbackSessionError,n=>{e._dispatcher.publish(Gn,new MKError(MKError.Reason.MEDIA_SESSION,n)),e.destroy()})}))()}initializeMediaElement(){var e=this;return _async_to_generator$T((function*(){const n=nextAvailableAudioElement();n.autoplay=!1,n.id="apple-music-player",n.controls=!1,n.muted=!1,n.playbackRate=1,n.preload="metadata",n.volume=1,e.audio=n,document.body.appendChild(n),Ye.debug("initializedMediaElement",n)}))()}removeEventHandlers(){this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate),this._targetElement.removeEventListener("timeupdate",this.delayedCdmUpdateCheck),super.removeEventHandlers()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$T((function*(){var n;yield _superprop_get_stopMediaElement().call(e),yield e.tearDownManifests(),null===(n=e._buffer)||void 0===n||n.stop(),e._buffer=void 0}))()}preloadItem(e){var n=this;return _async_to_generator$T((function*(){const{extension:d,nextManifest:p}=n,h=n._buffer;if("song"!==e.type||!h||!d||!n.isSeamlessAudioTransitionsEnabled)return;if((null==p?void 0:p.mediaItem.id)===e.id)return void Ye.debug("already have next manifest for ",e.title);n._targetElement.removeEventListener("timeupdate",n.onTimeUpdate),n._targetElement.addEventListener("timeupdate",n.onTimeUpdate),Ye.debug("player preparing next manifest for",e.title);const y=yield n.loadAndParseManifest(e,!1);h.setNextManifest(y),d.setMediaItem(e),d.extURI=y.extURI,n.nextManifest=y}))()}playItemFromEncryptedSource(e,n=!1,d){var p=this;return _async_to_generator$T((function*(){const h=p._paused&&!n;Ye.debug("playItemFromEncryptedSource",e.title);const y=h?void 0:p.startPlaybackSequence();if(e.playRawAssetURL)return e.playbackType=ie.unencryptedFull,p.nowPlayingItem=e,yield p._playAssetURL(e.assetURL,h),p.finishPlaybackSequence();const{extension:_}=p;var m,g;p.delaySeamlessCdmUpdates&&(null===(g=p.extension)||void 0===g||null===(m=g.session)||void 0===m||m.applyDelayedCdmUpdates());if(!_)return y;_.initiated=n,_.setMediaItem(e),e.playbackType=ie.encryptedFull,p.nowPlayingItem=e,e.state=oe.loading;const b=yield p.getManifestForItem(e);p.manifest=b;const P=shouldForceAudioMse();if((e.isSong||_.isFairplay&&P)&&(_.extURI=b.extURI),e.state=oe.ready,_.isFairplay&&!P){let n=e.assetURL;(null==d?void 0:d.startTime)&&(n+="#t="+d.startTime),yield p._playAssetURL(n,h)}else{const e=p._buffer;e&&p.isSeamlessAudioTransitionsEnabled&&e.isItemPlaying(b.mediaItem)?Ye.debug("already have buffer, continuing playback"):yield p.beginNewBufferForItem(h,b,d)}return p.finishPlaybackSequence()}))()}getManifestForItem(e){var n=this;return _async_to_generator$T((function*(){var d,p;Ye.debug("reconciling item to play against playing item");const{nextManifest:h,manifest:y,isSeamlessAudioTransitionsEnabled:_}=n,m=n._buffer;if(!m||!y)return Ye.debug("no buffer or manifest, creating manifest [title, buffer, manifest]",e.title,!!m,!!y),n.loadAndParseManifest(e);if(!_)return Ye.debug("seamless transitions disabled, stopping and creating manifest for",e.title),yield n.tearDownManifests(),n.loadAndParseManifest(e);const g=!m.isItemPlaying(e);let b;return Ye.debug("itemMismatch",g),h&&!g?(Ye.debug(`replacing manifest for ${y.mediaItem.title} with next manifest ${h.mediaItem.title}`),b=h,n.nextManifest=void 0,Ye.debug("cease listening for keys on manifest for",y.mediaItem.title),yield n.tearDownManifest(y)):g?(null==h?void 0:h.mediaItem.id)!==e.id?(Ye.debug(`item to play ${e.title} does not match playing or next items, tearing down all manifests`),yield n.tearDownManifests(),b=yield n.loadAndParseManifest(e)):(Ye.debug(`item to play ${e.title} matches next item, tearing down current manifest`),yield n.tearDownManifest(y),b=h):(Ye.debug("item is already playing, returning existing manifest"),b=y),Ye.debug("getManifestForItem loading keys for",y.mediaItem.title),null===(p=n.extension)||void 0===p||null===(d=p.session)||void 0===d||d.loadKeys(b.keyValues,b.mediaItem),b}))()}seekToTime(e){var n=this;return _async_to_generator$T((function*(){const d=n._buffer;if(d){Ye.debug("audio-player: buffer seek to",e);if(!(yield d.seek(e)))return;n.isSeamlessAudioTransitionsEnabled&&n.onTimeUpdate()}else Ye.debug("audio-player: media element seek to",e),n._targetElement.currentTime=e}))()}tearDownManifests(){var e=this;return _async_to_generator$T((function*(){e.manifest=yield e.tearDownManifest(e.manifest),e.nextManifest=yield e.tearDownManifest(e.nextManifest)}))()}tearDownManifest(e){var n=this;return _async_to_generator$T((function*(){const{extension:d}=n;e&&(Ye.debug("tearing down manifest for",e.mediaItem.title),e.stop(),d&&(yield d.clearSessions(e.keyValues)),e.removeEventListener(Rn.keysParsed,n.loadKeysHandler))}))()}loadAndParseManifest(e,n=!0){var d=this;return _async_to_generator$T((function*(){let p;Ye.debug(`will load and parse manifest for ${e.title}, loadKeys ${n}`);try{return p=yield Manifest.load(e,{cache:!1,services:{runtime:d.services.runtime,request:d.services.request}}),n&&p.addEventListener(Rn.keysParsed,d.loadKeysHandler),p.parse(),p}catch(he){d.resetDeferredPlay();const n=new MKError(MKError.Reason.NETWORK_ERROR,"Could not fetch manifest");throw n.data=he,d._dispatcher.publish(Gn,n),n}}))()}onTimeUpdate(){if(!this._buffer)return;const{currentPlaybackTimeRemaining:e,nextManifest:n,delaySeamlessCdmUpdates:d}=this;if(n&&e<15){var p,h,y,_;if(Ye.debug("player loading keys for",n.mediaItem.title,d),d)null===(h=this.extension)||void 0===h||null===(p=h.session)||void 0===p||p.loadKeys(n.keyValues,n.mediaItem,{delayCdmUpdate:!0}),this._targetElement.addEventListener("timeupdate",this.delayedCdmUpdateCheck);else null===(_=this.extension)||void 0===_||null===(y=_.session)||void 0===y||y.loadKeys(n.keyValues,n.mediaItem);this._targetElement.removeEventListener("timeupdate",this.onTimeUpdate)}}delayedCdmUpdateCheck(){var e;const n=null===(e=this.nowPlayingItem)||void 0===e?void 0:e.playbackDuration,d=n?n/1e3:this.currentPlaybackDuration,p=this._currentTime,h=Number((d-p).toFixed(3));if(h<1){const e=1e3*h;Ye.debug("delayed CDM update in ",e),setTimeout(()=>{var e,n;Ye.debug("applying delayed CDM update"),null===(n=this.extension)||void 0===n||null===(e=n.session)||void 0===e||e.applyDelayedCdmUpdates()},e),this._targetElement.removeEventListener("timeupdate",this.delayedCdmUpdateCheck)}}loadKeysHandler(e){var n,d;null===(d=this.extension)||void 0===d||null===(n=d.session)||void 0===n||n.loadKeys(e.keys,e.item)}beginNewBufferForItem(e,n,d){var p=this;return _async_to_generator$T((function*(){if(Ye.debug("creating new MseBuffer for item",n.mediaItem.title,e),p._buffer&&(Ye.debug("stopping old buffer"),p._buffer.stop()),p._buffer=new MseBuffer({dispatcher:p._dispatcher,element:p._targetElement,duration:n.mediaItem.playbackDuration/1e3,manifest:n}),yield p._playAssetURL(p._buffer.playableUrl,!0),!e){let e=Promise.resolve();return(null==d?void 0:d.startTime)&&(e=p.seekToTime(d.startTime)),e.then(()=>p._playMedia())}}))()}setPresentationMode(e){return _async_to_generator$T((function*(){return Promise.resolve()}))()}loadPreviewImage(e){return _async_to_generator$T((function*(){}))()}constructor(e){var n,d;super(e),_define_property$1b(this,"currentAudioTrack",void 0),_define_property$1b(this,"currentTextTrack",void 0),_define_property$1b(this,"textTracks",[]),_define_property$1b(this,"audioTracks",[]),_define_property$1b(this,"audio",void 0),_define_property$1b(this,"isSeamlessAudioTransitionsEnabled",!1),_define_property$1b(this,"delaySeamlessCdmUpdates",!1),_define_property$1b(this,"extension",void 0),_define_property$1b(this,"mediaPlayerType","audio"),_define_property$1b(this,"manifest",void 0),_define_property$1b(this,"nextManifest",void 0);const p=null!==(d=null===(n=e.bag)||void 0===n?void 0:n.features)&&void 0!==d?d:{};this.isSeamlessAudioTransitionsEnabled=!!p["seamless-audio-transitions"],this.delaySeamlessCdmUpdates=!!p["delay-seamless-cdm-updates"],window.audioPlayer=this,this._dispatcher.subscribe(Nn,this.onLoadSegmentError)}}function _define_property$1a(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[void 0]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"onLoadSegmentError",null),_ts_decorate$q([AsyncDebounce(250),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[Number]),_ts_metadata$q("design:returntype",Promise)],AudioPlayer.prototype,"seekToTime",null),_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"onTimeUpdate",null),_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"delayedCdmUpdateCheck",null),_ts_decorate$q([Bind(),_ts_metadata$q("design:type",Function),_ts_metadata$q("design:paramtypes",[void 0]),_ts_metadata$q("design:returntype",void 0)],AudioPlayer.prototype,"loadKeysHandler",null);class VoidMediaElement extends HTMLElement{set volume(e){e!==this._volume&&(this._volume=e,this.dispatchMediaEvent("volumechange"),this.muted=0===e)}get volume(){return this._volume}set playbackRate(e){e!==this._playbackRate&&(this._playbackRate=e,this.dispatchMediaEvent("ratechange"))}get playbackRate(){return this._playbackRate}set currentTime(e){e!==this._currentTime&&(this._currentTime=e,this.dispatchMediaEvent("timeupdate"))}get currentTime(){return this._currentTime}pause(){this.paused=!0,this.dispatchMediaEvent("pause")}play(){this.paused=!1,this.dispatchMediaEvent("play")}dispatchMediaEvent(e){const n=new CustomEvent(e,{detail:{type:e}});this.dispatchEvent(n)}constructor(){super(),_define_property$1a(this,"muted",!1),_define_property$1a(this,"paused",!0),_define_property$1a(this,"_playbackRate",1),_define_property$1a(this,"_volume",1),_define_property$1a(this,"_currentTime",0)}}function asyncGeneratorStep$S(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$S(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$S(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$S(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$19(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const qn=Date.parse("January 01, 2001 0:00:00 GMT");class VoidPlayer extends BasePlayer{startTimerProgress(){this.timerId||(this.timerId=setInterval(()=>{var e,n;const d=null===(e=this._nowPlayingItem)||void 0===e?void 0:e.attributes.elapsedTimeTimestamp,p=null===(n=this._nowPlayingItem)||void 0===n?void 0:n.attributes.elapsedTime,h=1e3*d+qn,y=(Date.now()-h)/1e3;let _=0;var m;p>0&&(_=Math.ceil(Math.min((null===(m=this._nowPlayingItem)||void 0===m?void 0:m.attributes.durationInMillis)/1e3,(p+y)*this._targetElement.playbackRate)));const g=this._targetElement.currentTime+1;this.seekToTime(Math.max(_,g))},1e3))}stopTimerProgress(){clearInterval(this.timerId),this.timerId=void 0}get currentPlayingDate(){}get isPlayingAtLiveEdge(){return!1}get seekableTimeRanges(){return this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get supportsPreviewImages(){return!1}get nowPlayingItem(){return this._nowPlayingItem}set nowPlayingItem(e){if(e===this.nowPlayingItem)return;const n=this._dispatcher;n.publish(at.nowPlayingItemWillChange,{item:e}),this._nowPlayingItem=e,e&&(e.state=oe.playing),n.publish(at.nowPlayingItemDidChange,{item:e}),n.publish(at.playbackDurationDidChange,{currentTarget:this._targetElement,duration:this.currentPlaybackDuration,target:this._targetElement,type:"durationchange"})}get _targetElement(){return this.element}initializeMediaElement(){var e=this;return _async_to_generator$S((function*(){const n=document.createElement("mk-void-media-element");n.id="apple-music-player",e.element=n,document.body.appendChild(n),Ye.debug("initializedMediaElement",n)}))()}removeEventHandlers(){super.removeEventHandlers()}seekToTime(e){var n=this;return _async_to_generator$S((function*(){n._targetElement.currentTime=e}))()}setPresentationMode(e){return _async_to_generator$S((function*(){return Promise.resolve()}))()}loadPreviewImage(e){return _async_to_generator$S((function*(){}))()}playItemFromEncryptedSource(){return _async_to_generator$S((function*(){return Promise.resolve()}))()}initializeExtension(){return _async_to_generator$S((function*(){}))()}preloadItem(e,n){return _async_to_generator$S((function*(){}))()}constructor(e){super(e),_define_property$19(this,"currentAudioTrack",void 0),_define_property$19(this,"currentTextTrack",void 0),_define_property$19(this,"textTracks",[]),_define_property$19(this,"audioTracks",[]),_define_property$19(this,"timerId",void 0),_define_property$19(this,"element",void 0),_define_property$19(this,"extension",void 0),_define_property$19(this,"mediaPlayerType","void");void 0!==customElements.get("mk-void-media-element")||customElements.define("mk-void-media-element",VoidMediaElement)}}function asyncGeneratorStep$R(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$R(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$R(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$R(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$18(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class EncryptedSession extends KeySession{attachMedia(e,n){var d=this;return _async_to_generator$R((function*(){d.keySystem=n.keySystem,d._keySystemAccess=n,e.addEventListener("encrypted",d.boundHandleSessionCreation,!1)}))()}detachMedia(e){e.removeEventListener("encrypted",this.boundHandleSessionCreation)}createSession(e){var n=this;return _async_to_generator$R((function*(){Ye.debug("Encrypted createSession",e);const d=n._keySystemAccess;if(!d)return;const{initData:p,initDataType:h,target:y}=e;return n._mediaKeysPromise||(n._mediaKeysPromise=new Promise(function(){var e=_async_to_generator$R((function*(e,p){const h=yield d.createMediaKeys();try{yield y.setMediaKeys(h)}catch(he){n.dispatchKeyError(he),p(he)}const _=yield n.loadCertificateBuffer();yield h.setServerCertificate(_),n._mediaKeysServerCertificate=_,e(h)}));return function(n,d){return e.apply(this,arguments)}}())),yield n._mediaKeysPromise,n._mediaKeysServerCertificate?n._createSession(y,p,h):void 0}))()}generatePSSH(e){const n=new Uint8Array([0,0,0,52,112,115,115,104,0,0,0,0,237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237,0,0,0,20,8,1,18,16,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),d=N(e);for(let p=0;p<d.length;p++)n[n.length-16+p]=d[p];return Ye.debug("generatePSSH",n),n}_createSession(e,n,d){const p=e.mediaKeys.createSession(),{item:h}=this;if(!h)return;this._teardownCurrentSession(),Ye.debug("creating media key session",p);let y;if(this.isWidevine&&h.isSong)y=this.generatePSSH(this.extID);else{const e=function(e){const n=[],d=new DataView(e.buffer);for(let p=0;p<e.length;){const h=d.getUint32(p);n.push(new PsshBox(e,p,p+h)),p+=h}return n}(new Uint8Array(n)).find(e=>e.isWidevine),d=null==e?void 0:e.rawBytes,h=F(d);Ye.debug("extracted uri",h),p.extURI=h,y=n}return p.addEventListener("message",this.startLicenseSession),this._currentSession=p,p.generateRequest(d,y).catch(e=>{if(e.message.match(/generateRequest.*\(75\)/))return p.generateRequest(d,y);throw e})}_teardownCurrentSession(){this._currentSession&&(Ye.debug("tearing down media key session",this._currentSession),this._currentSession.removeEventListener("message",this.startLicenseSession),this._currentSession=void 0)}applyDelayedCdmUpdates(){}loadKeys(e,n,d){return _async_to_generator$R((function*(){}))()}clearSessions(){return _async_to_generator$R((function*(){}))()}constructor(...e){super(...e),_define_property$18(this,"_currentSession",void 0),_define_property$18(this,"_keySystemAccess",void 0),_define_property$18(this,"_mediaKeysPromise",void 0),_define_property$18(this,"_mediaKeysServerCertificate",void 0)}}function asyncGeneratorStep$Q(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$Q(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$Q(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$Q(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$17(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class MediaExtensionStub extends Notifications{destroy(e){}setMediaItem(e){}initializeKeySystem(){var e=this;return _async_to_generator$Q((function*(){e.session=new EncryptedSession}))()}clearSessions(){return _async_to_generator$Q((function*(){}))()}constructor(e){super(e),_define_property$17(this,"audioTracks",[]),_define_property$17(this,"textTracks",[]),_define_property$17(this,"session",void 0),_define_property$17(this,"extURI",void 0),_define_property$17(this,"hasMediaSession",void 0),_define_property$17(this,"initiated",void 0),_define_property$17(this,"isFairplay",void 0),this.extURI="",this.initiated=!0,this.isFairplay=!0,this.hasMediaSession=!0}}function asyncGeneratorStep$P(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$P(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$P(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$P(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$16(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}class PlayerStub{get hasMediaElement(){return!0}get isEngagedInPlayback(){return!this.paused}get playbackRate(){return this._playbackRate}set playbackRate(e){this._playbackRate=e,this._dispatcher.publish(at.playbackRateDidChange,new Event("ratechange"))}get defaultPlaybackRate(){return this._defaultPlaybackRate}set defaultPlaybackRate(e){this._defaultPlaybackRate=e,this._dispatcher.publish(at.playbackRateDidChange,new Event("ratechange"))}get volume(){return this._volume}set volume(e){this._volume=e,this._dispatcher.publish(at.playbackVolumeDidChange,new Event("volumeChange"))}destroy(){}dispatch(){}exitFullscreen(){return _async_to_generator$P((function*(){}))()}loadPreviewImage(e){return _async_to_generator$P((function*(){}))()}initialize(){return _async_to_generator$P((function*(){}))()}isPaused(){return this.paused}calculateTime(e){return e}clearNextManifest(){}mute(){}newSeeker(){return new PlayerSeeker(this)}pause(e){return _async_to_generator$P((function*(){}))()}play(){return _async_to_generator$P((function*(){}))()}playItemFromEncryptedSource(e,n,d){return _async_to_generator$P((function*(){}))()}playItemFromUnencryptedSource(e,n,d){return _async_to_generator$P((function*(){}))()}preload(){return _async_to_generator$P((function*(){}))()}seekToTime(e){return _async_to_generator$P((function*(){}))()}requestFullscreen(){return _async_to_generator$P((function*(){}))()}setPlaybackState(e,n){}setPresentationMode(e){return _async_to_generator$P((function*(){}))()}showPlaybackTargetPicker(){}stop(e){return _async_to_generator$P((function*(){}))()}stopMediaAndCleanup(){return _async_to_generator$P((function*(){}))()}supportsPictureInPicture(){return!1}tsidChanged(){}preloadItem(e,n){return _async_to_generator$P((function*(){}))()}toString(){return`<PlayerStub id="${this.id}" isInitialized=true isDestroyed=false />`}constructor(e){_define_property$16(this,"id",generateUUID()),_define_property$16(this,"bitrate",it.STANDARD),_define_property$16(this,"audioTracks",[]),_define_property$16(this,"currentBufferedProgress",0),_define_property$16(this,"currentPlaybackDuration",0),_define_property$16(this,"currentPlaybackProgress",0),_define_property$16(this,"currentPlaybackTime",0),_define_property$16(this,"currentPlaybackTimeRemaining",0),_define_property$16(this,"currentPlayingDate",void 0),_define_property$16(this,"isPlayingAtLiveEdge",!1),_define_property$16(this,"isPlaying",!1),_define_property$16(this,"isPrimaryPlayer",!0),_define_property$16(this,"isReady",!1),_define_property$16(this,"nowPlayingItem",void 0),_define_property$16(this,"paused",!1),_define_property$16(this,"playbackState",be.none),_define_property$16(this,"playbackTargetAvailable",!1),_define_property$16(this,"playbackTargetIsWireless",!1),_define_property$16(this,"previewOnly",!1),_define_property$16(this,"supportsPreviewImages",!1),_define_property$16(this,"textTracks",[]),_define_property$16(this,"extension",new MediaExtensionStub([])),_define_property$16(this,"hasAuthorization",!0),_define_property$16(this,"windowHandlers",void 0),_define_property$16(this,"isDestroyed",!1),_define_property$16(this,"services",void 0),_define_property$16(this,"_dispatcher",void 0),_define_property$16(this,"_volume",1),_define_property$16(this,"_playbackRate",1),_define_property$16(this,"_defaultPlaybackRate",1),_define_property$16(this,"currentAudioTrack",void 0),_define_property$16(this,"currentTextTrack",void 0),_define_property$16(this,"seekableTimeRanges",void 0),this.services=e.services,this._dispatcher=e.services.dispatcher,this.windowHandlers=new WindowHandlers(this,e.services.runtime)}}class VideoMediaExtension extends MediaExtension{destroy(e){var n;null===(n=this._session)||void 0===n||n.stopLicenseSession(),super.destroy(e)}}function asyncGeneratorStep$O(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$O(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$O(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$O(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _ts_decorate$p(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$p(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const{mediaPlaybackError:Hn}=at,{playbackLicenseError:zn,playbackSessionError:Yn}=Wr;class NativeSafariVideoPlayer extends VideoPlayer{get currentPlayingDate(){}get isPlayingAtLiveEdge(){return!1}get seekableTimeRanges(){return this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get supportsPreviewImages(){return!1}initializeExtension(){var e=this;return _async_to_generator$O((function*(){if(!e.video)return void Ye.warn("NativeSafariVideoPlayer.initializeExtension No video element, not initializing extension");const n=new VideoMediaExtension({mediaElement:e.video,contentType:'video/mp4;codecs="avc1.42E01E"',services:{runtime:e.services.runtime}});e.extension=n,yield n.initializeKeySystem(),n.addEventListener(zn,e.onPlaybackLicenseError),n.addEventListener(Yn,e.onPlaybackSessionError)}))()}destroy(){Ye.debug("native-safari-video-player.destroy");const{extension:e,video:n}=this;this._blobUrl&&(URL.revokeObjectURL(this._blobUrl),this._blobUrl=void 0),e&&n&&(e.removeEventListener(zn,this.onPlaybackLicenseError),e.removeEventListener(Yn,this.onPlaybackSessionError),n.removeEventListener("loadedmetadata",this.onMetadataLoaded),super.destroy())}loadPreviewImage(e){return _async_to_generator$O((function*(){}))()}preloadItem(e,n){return _async_to_generator$O((function*(){}))()}playHlsStream(e,n,d={}){var p=this;return _async_to_generator$O((function*(){Ye.debug("native-safari-video-player.playHlsStream",e);const{video:h}=p;if(!h){const e="NativeSafariVideoPlayer.playHlsStream(): No video element";throw Ye.error(e),new Error(e)}p.setupTrackManagers();const y=p.startPlaybackSequence(),_=(p.services.manifest.personalizedManifests?p.playByBlob(e,h,d):p.playBySource(e,h,d)).then(()=>y);var m;n&&(null===(m=p.extension)||void 0===m||m.setMediaItem(n));return h.addEventListener("loadedmetadata",p.onMetadataLoaded),_}))()}onPlaybackSessionError(e){this._dispatcher.publish(Hn,new MKError(MKError.Reason.MEDIA_SESSION,e))}onMetadataLoaded(){var e=this;return _async_to_generator$O((function*(){Ye.debug("native-safari-video-player.onMetadataLoaded");const{nowPlayingItem:n}=e;n&&(n.state=oe.ready),yield e._playMedia(),e.finishPlaybackSequence()}))()}seekToTime(e){var n=this;return _async_to_generator$O((function*(){Ye.debug("native-safari-video-player: media element seek to",e),n._targetElement.currentTime=e}))()}playByBlob(e,n,d={}){var p=this;return _async_to_generator$O((function*(){Ye.debug("native-safari-video-player: playing video by blob");const h=p.services.manifest;let y=yield h.getManifest(e);if(!y&&(Ye.debug("native-safari-video-player: fetching manifest"),y=yield h.fetchManifest(e),!y))throw Ye.error("No manifest for "+e),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Failed to load manifest");Ye.debug("native-safari-video-player: loaded manifest",!!y),yield h.clearManifest(e);const _=y.contentType,m=y.content.replace(/^#EXT-X-SESSION-DATA-ITUNES:.*$/gm,""),g=new Blob([m],{type:_});e=URL.createObjectURL(g),p._blobUrl=e;const b=document.createElement("source");b.setAttribute("src",e),_&&b.setAttribute("type",_),Ye.debug("native-safari-video-player: blob url",e),void 0!==d.startTime&&(n.currentTime=d.startTime),n.appendChild(b)}))()}playBySource(e,n,d={}){return _async_to_generator$O((function*(){Ye.debug("native-safari-video-player: playing video by source"),void 0!==d.startTime&&(e+="#t="+d.startTime),n.src=e}))()}constructor(...e){super(...e),function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"_blobUrl",void 0)}}_ts_decorate$p([Bind(),_ts_metadata$p("design:type",Function),_ts_metadata$p("design:paramtypes",[void 0]),_ts_metadata$p("design:returntype",void 0)],NativeSafariVideoPlayer.prototype,"onPlaybackSessionError",null),_ts_decorate$p([Bind(),_ts_metadata$p("design:type",Function),_ts_metadata$p("design:paramtypes",[]),_ts_metadata$p("design:returntype",Promise)],NativeSafariVideoPlayer.prototype,"onMetadataLoaded",null),_ts_decorate$p([AsyncDebounce(250),_ts_metadata$p("design:type",Function),_ts_metadata$p("design:paramtypes",[Number]),_ts_metadata$p("design:returntype",Promise)],NativeSafariVideoPlayer.prototype,"seekToTime",null);const Wn=new RegExp("^https://([a-z0-9]+-)?"+("js-cdn.music.apple.com"+"/musickit/v3/".replace(/v3/,"(v2|v3)")).replace(/[\.\/]/g,"\\$&"),"i"),Qn=/^https:\/\/(.*\/includes\/js-cdn)\//i,Jn=/^([a-z]+:)?\/\//;function findScript(e){return isNodeEnvironment$1()||!e?null:document.querySelector(`script[src*="${e}"]`)}function getScriptSrcElements(){if("undefined"==typeof document||!document.querySelectorAll)return[];return Array.from(document.querySelectorAll("script[src]"))}function determineCdnBaseHost(){if(isNodeEnvironment$1())return"";return`//${function(){for(const e of getScriptSrcElements()){const n=Wn.exec(e.src);if(n)return n[1]||""}return""}()}js-cdn.music.apple.com`}function determineCdnPathHost(){const e=function(){for(const e of getScriptSrcElements()){const n=Qn.exec(e.src);if(n)return n[1]||""}return""}();return e?"//"+e:e}const Xn=StringDevFlag.register("mk-hlsjs-log-level"),Zn=StringDevFlag.register("mk-hlsjs-version");function getHlsJsCdnConfig(){const e={hls:"",rtc:""};if(isNodeEnvironment$1())return e;const n=determineCdnPathHost()||determineCdnBaseHost(),d=Zn.get()||"2.910.1",p=function(){const e=Xn.value;switch(e){case"info":case"error":case"warn":return"hls.production.verbose.min.js";case"trace":case"debug":return console.warn(`HLS log level ${e} is not supported, loading production build.`),"hls.js";default:return"hls.js"}}();return e.hls=`https:${n}/hls.js/${d}/hls.js/${p}`,e.rtc=`https:${n}/hls.js/${d}/rtc.js/rtc.min.js`,e}function cdnBaseURL(e,n=window){var d;if(isNodeEnvironment$1())return"";const p=null===(d=getLocalStorage())||void 0===d?void 0:d.getItem("mkCDNBaseURLOverride");if(p)return p;const h=findScript(e);return h?h.getAttribute("src").replace(new RegExp(e+"$"),""):(determineCdnPathHost()||determineCdnBaseHost())+"/musickit/v3/"}const ei=new Map;function loadScript(e,n){const d=ei.get(e);if(d)return d;const p=new Promise((d,p)=>{isNodeEnvironment$1()&&p("Dynamic script loading is unsupported in Node environments.");if(findScript(e))return d();const h=document.createElement("script");let y;if(n&&Object.keys(n).forEach(e=>{h.setAttribute(e,n[e])}),h.onload=()=>{d()},h.onerror=e=>{p(e)},Jn.test(e))y=e;else{y=`${cdnBaseURL(e)}${e}`}h.src=y,document.head.appendChild(h)});return ei.set(e,p),p}const ti=Ye.createChild("tracks");function _define_property$14(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$F(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$14(e,n,d[n])}))}return e}function _object_spread_props$r(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_decorate$o(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$o(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const{audioTracksSwitched:ri,audioTracksUpdated:ni,inlineStylesParsed:ii,textTracksSwitched:oi,textTracksUpdated:ai}=Wr,si=BooleanDevFlag.register("mk-hlsjs-interstitial-playback");class HlsJsTracks extends Notifications{get isDestroyed(){return this._isDestroyed}get audioTracks(){return this._audioTracks}get textTracks(){return this._textTracks}get currentInterstitialId(){var e,n;return null===(n=this.session.getCurrentIntegratedTimelineSegmentAndCurrentTime())||void 0===n||null===(e=n.segment)||void 0===e?void 0:e.interstitialEventIdentifier}set audioTrack(e){const{currentInterstitialId:n,session:d}=this;d&&e&&void 0!==e.id&&(n?d.setInterstitialAudioSelectedPersistentId(n,e.id):d.audioSelectedPersistentID=e.id)}set textTrack(e){const{currentInterstitialId:n,session:d}=this;var p;const h=null!==(p=null==e?void 0:e.id)&&void 0!==p?p:-1;n?d.setInterstitialSubtitleSelectedPersistentId(n,h):d.subtitleSelectedPersistentID=h}get audioMediaOptions(){const{currentInterstitialId:e,session:n}=this;return n?e?n.getAudioMediaOptionsForItem({itemId:e}):n.audioMediaOptions:[]}get currentAudioMediaOption(){var e;const{currentInterstitialId:n,session:d}=this;if(d)return n?d.getEnabledAudioMediaOptionForItem({itemId:n}):null===(e=this.audioMediaOptions)||void 0===e?void 0:e.find(e=>e.MediaSelectionOptionsPersistentID===d.audioSelectedPersistentID)}get subtitleMediaOptions(){const{currentInterstitialId:e,session:n}=this;return n?e?n.getSubtitleMediaOptionsForItem({itemId:e}):n.subtitleMediaOptions:[]}get forcedTextTrackForCurrentAudioTrack(){const{currentAudioMediaOption:e}=this;if(!e)return;const n=this.subtitleMediaOptions.find(n=>0===n.MediaSelectionOptionsDisplaysNonForcedSubtitles&&n.MediaSelectionOptionsExtendedLanguageTag===e.MediaSelectionOptionsExtendedLanguageTag);return n?this.normalizeTextTrack(n):void 0}audioTracksUpdated(e=[]){const n=e.map(this.normalizeAudioTrack,this);this._audioTracks=n,this.dispatchEvent(ni,n)}handleItemPlaying(e,n){ti.debug("handleItemPlaying",n);const{itemId:d,interstitialId:p}=n;p||this.updateAudioAndTextTracks({itemId:d})}handleInterstitialAssetStarted(e,n){ti.debug("handleInterstitialAssetStarted",n);const{asset:d}=n;this.updateAudioAndTextTracks({itemId:null==d?void 0:d.identifier})}updateAudioAndTextTracks(e){const n=this.session.getAudioMediaOptionsForItem(e),d=this.session.getSubtitleMediaOptionsForItem(e);ti.debug("updateAudioAndTextTracks - updating audio and text tracks with options:",n,d),this.audioTracksUpdated(n),this.subtitleTracksUpdated(d)}handleAudioTrackSwitched(e,n){if(!this.isEventForCurrentItem(n))return;let d=this.session.audioSelectedPersistentID;this.currentInterstitialId&&(d=this.session.getInterstitialAudioSelectedPersistentId(this.currentInterstitialId)),this.dispatchEvent(ri,{selectedId:d})}handleInlineStylesParsed(e,n){this.dispatchEvent(ii,n)}handleManifestLoaded(e,n){if(ti.debug("handleManifestLoaded",n),si.enabled)return;const{audioMediaSelectionGroup:d,subtitleMediaSelectionGroup:p}=n;this.audioTracksUpdated(null==d?void 0:d.MediaSelectionGroupOptions),this.subtitleTracksUpdated(null==p?void 0:p.MediaSelectionGroupOptions)}handleSessionDataComplete(e,n){var d;null==n||null===(d=n.itemList)||void 0===d||d.forEach(e=>{if("_hls.localized-rendition-names"===e["DATA-ID"]&&e.VALUE)try{this._localizedRenditionNames=JSON.parse(e.VALUE),this._audioTracks.forEach(e=>{var n;const d=null===(n=this._localizedRenditionNames)||void 0===n?void 0:n[e.label];d&&(e.localizedRenditionNames=d)}),this.dispatchEvent(ni,this._audioTracks)}catch(St){return void ti.error("Failed to parse _hls.localized-rendition-names",St)}})}handleSubtitleTrackSwitch(e,n){this.isEventForCurrentItem(n)&&this.dispatchEvent(oi,n)}subtitleTracksUpdated(e=[]){const n=[];e.forEach(e=>{0!==e.MediaSelectionOptionsDisplaysNonForcedSubtitles&&n.push(this.normalizeTextTrack(e))}),this._textTracks=n,this.dispatchEvent(ai,n)}normalizeAudioTrack(e){const n=e.MediaSelectionOptionsTaggedMediaCharacteristics,d=(null!=n?n:[]).includes("public.accessibility.describes-video")?"description":"main";return _object_spread_props$r(_object_spread$F({},this.normalizeSelectionOption(e)),{enabled:!1,kind:d,characteristics:n})}normalizeTextTrack(e){var n;let d;return d=(null===(n=e.MediaSelectionOptionsTaggedMediaCharacteristics)||void 0===n?void 0:n.includes("public.accessibility.describes-music-and-sound"))||"clcp"===e.MediaSelectionOptionsMediaType?"captions":"subtitles",_object_spread_props$r(_object_spread$F({},this.normalizeSelectionOption(e)),{mode:"disabled",kind:d})}normalizeSelectionOption(e){return{id:e.MediaSelectionOptionsPersistentID,label:e.MediaSelectionOptionsName,language:e.MediaSelectionOptionsExtendedLanguageTag,interstitialId:e.MediaSelectionOptionsInterstitialId,isDefault:e.MediaSelectionOptionsIsDefault}}isEventForCurrentItem(e){return this.currentInterstitialId?e.interstitialId===this.currentInterstitialId:!e.interstitialId}destroy(){this._isDestroyed=!0;const{AUDIO_TRACK_SWITCHED:e,INLINE_STYLES_PARSED:n,INTERSTITIAL_ASSET_STARTED:d,ITEM_PLAYING:p,MANIFEST_LOADED:h,SESSION_DATA_COMPLETE:y,SUBTITLE_TRACK_SWITCH:_}=window.Hls.Events;this.session.off(e,this.handleAudioTrackSwitched),this.session.off(n,this.handleInlineStylesParsed),this.session.off(d,this.handleInterstitialAssetStarted),this.session.off(p,this.handleItemPlaying),this.session.off(h,this.handleManifestLoaded),this.session.off(y,this.handleSessionDataComplete),this.session.off(_,this.handleSubtitleTrackSwitch)}constructor(e){super([ri,ni,ii,oi,ai]),_define_property$14(this,"session",void 0),_define_property$14(this,"_audioTracks",void 0),_define_property$14(this,"_textTracks",void 0),_define_property$14(this,"_localizedRenditionNames",void 0),_define_property$14(this,"_isDestroyed",void 0),this.session=e,this._audioTracks=[],this._textTracks=[],this._isDestroyed=!1;const{AUDIO_TRACK_SWITCHED:n,INLINE_STYLES_PARSED:d,INTERSTITIAL_ASSET_STARTED:p,ITEM_PLAYING:h,MANIFEST_LOADED:y,SESSION_DATA_COMPLETE:_,SUBTITLE_TRACK_SWITCH:m}=window.Hls.Events;this.session.on(n,this.handleAudioTrackSwitched),this.session.on(d,this.handleInlineStylesParsed),this.session.on(p,this.handleInterstitialAssetStarted),this.session.on(h,this.handleItemPlaying),this.session.on(y,this.handleManifestLoaded),this.session.on(_,this.handleSessionDataComplete),this.session.on(m,this.handleSubtitleTrackSwitch)}}function _define_property$13(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[String,"undefined"==typeof ItemPlayingData?Object:ItemPlayingData]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleItemPlaying",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[String,Object]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleInterstitialAssetStarted",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[String,Object]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleAudioTrackSwitched",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[void 0,void 0]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleInlineStylesParsed",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[String,"undefined"==typeof ManifestLoadedData?Object:ManifestLoadedData]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleManifestLoaded",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[void 0,void 0]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleSessionDataComplete",null),_ts_decorate$o([Bind(),_ts_metadata$o("design:type",Function),_ts_metadata$o("design:paramtypes",[String,"undefined"==typeof SubtitleTrackSwitchData?Object:SubtitleTrackSwitchData]),_ts_metadata$o("design:returntype",void 0)],HlsJsTracks.prototype,"handleSubtitleTrackSwitch",null);class HlsJsPreviewImageLoader{loadPreviewImage(e){return this.lastPosition===e||(this.lastPosition=e,this.lastPromise=new Promise((n,d)=>{this.hls.loadImageIframeData$(e).subscribe(e=>{const{data:d}=e,p=new Blob([d],{type:"image/jpeg"});n(p)})})),this.lastPromise}constructor(e){_define_property$13(this,"hls",void 0),_define_property$13(this,"lastPosition",void 0),_define_property$13(this,"lastPromise",void 0),this.hls=e}}function asyncGeneratorStep$N(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$N(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$N(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$N(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$12(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$n(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$n(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const ci={bufferStalledError:"bufferStalledError",keySystemGenericError:"keySystemGenericError"},li=new Set([MKError.Reason.DEVICE_LIMIT,MKError.Reason.GEO_BLOCK,MKError.Reason.WIDEVINE_CDM_EXPIRED]),ui={[Z.clearkey]:"",[Z.fairplay]:"fairplaystreaming",[Z.widevine]:"widevine",[Z.playready]:"playready"},di=BooleanDevFlag.register("mk-hlsjs-interstitial-playback"),pi=BooleanDevFlag.get("mk-hlsjs-item-preloading"),hi=JsonDevFlag.register("mk-hlsjs-config-overrides"),yi=BooleanDevFlag.get("mk-block-report-cdn-server");class HlsJsVideoPlayer extends VideoPlayer{get shouldDispatchErrors(){return!this.userInitiated||this._playbackDidStart}get supportsPreviewImages(){var e,n;return!this.services.runtime.isMobile&&(null===(n=this._hls)||void 0===n||null===(e=n.iframeVariants)||void 0===e?void 0:e.some(e=>"mjpg"===e.imageCodec))}get currentPlayingDate(){var e;return null===(e=this._hls)||void 0===e?void 0:e.playingDate}get isPlayingAtLiveEdge(){var e;const n=this._hls;return!(!n||!(null===(e=this.nowPlayingItem)||void 0===e?void 0:e.isLinearStream))&&!!n.isPlayingAtLive}get seekableTimeRanges(){const e=this._hls;return e?e.seekableTimeRanges:this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}get currentPlaybackDuration(){return this._integratedTimelineDuration?this._timing.time(this._integratedTimelineDuration):super.currentPlaybackDuration}get currentPlaybackTime(){let e={};var n,d;di.enabled&&(e=null===(n=this._hls)||void 0===n?void 0:n.getCurrentIntegratedTimelineSegmentAndCurrentTime());return null!==(d=null==e?void 0:e.targetTime)&&void 0!==d?d:super.currentPlaybackTime}initializeExtension(){var e=this;return _async_to_generator$N((function*(){const{preferredKeySystem:n}=e.services.runtime;e._keySystem=void 0!==n?Z[n]:void 0;try{var d;if(!e.hlsScriptURL)throw new Error("HLS.js script URL is not configured");yield Promise.all([loadScript(e.hlsScriptURL),null===(d=e._rtcTracker)||void 0===d?void 0:d.loadScript()])}catch(St){throw Ye.error("hlsjs-video-player failed to load script "+e.hlsScriptURL,St),St}}))()}destroy(){var e;if(Ye.debug("hlsjs-video-player.destroy"),null===(e=this._hlsJsTracks)||void 0===e||e.destroy(),this._hls){const{DATERANGE_UPDATED:e,ERROR:n,INTERNAL_ERROR:d,INTERSTITIALS_UPDATED:p,MANIFEST_PARSED:h,KEY_REQUEST_STARTED:y,LICENSE_CHALLENGE_CREATED:_,LEVEL_SWITCHED:m,UNRESOLVED_URI_LOADING:g}=window.Hls.Events,b=this._hls;b.stopLoad(),b.detachMedia(),b.off(n,this.handleHlsError),b.off(d,this.handleHlsError),b.off(h,this.handleManifestParsed),b.off(y,this.handleKeyRequestStarted),b.off(_,this.handleLicenseChallengeCreated),b.off(m,this.handleLevelSwitched),b.off(e,this.handleDaterangeUpdated),di.enabled&&b.off(p,this.handleInterstitialUpdated),this.services.manifest.personalizedManifests&&b.off(g,this.handleUnresolvedUriLoading),b.destroy(),window.hlsSession=void 0}super.destroy(),asAsync(this._license.stop())}playHlsStream(e,n,d={}){var p=this;return _async_to_generator$N((function*(){var h;let y,_;Ye.debug("hlsjs-video-player.playHlsStream",e,n),p._unrecoverableError=void 0,p.createHlsPlayer();const hasKey=(e,n)=>{var d;return void 0!==(null==n||null===(d=n.keyURLs)||void 0===d?void 0:d[e])};p._keySystem===Z.widevine&&hasKey("widevine-cert-url",n)&&(y="WIDEVINE_SOFTWARE",_={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});const m={itemId:null==n?void 0:n.id,subs:"accepts-css",platformInfo:{requiresCDMAttachOnStart:void 0!==p._keySystem,maxSecurityLevel:y,keySystemConfig:_},appData:{serviceName:null===(h=p.appInfo)||void 0===h?void 0:h.name}},{_rtcTracker:g,_hls:b}=p;if(g){const e=g.prepareReportingAgent(n);void 0!==e&&(m.appData.reportingAgent=e)}Ye.debug("RTC: loadSource with load options",m);const P=p.startPlaybackSequence();return p.services.manifest.personalizedManifests&&(e=e.replace("https://","manifest://"),Ye.info("Manifest already loaded, passing url to HLSJS",e)),b.loadSource(e,m,d.startTime),b.attachMedia(p.video),n&&(p._licenseServerUrl=n.keyURLs["hls-key-server-url"],p._keySystem===Z.fairplay&&hasKey("hls-key-cert-url",n)?b.setProtectionData({fairplaystreaming:{serverCertUrl:n.keyURLs["hls-key-cert-url"]}}):hasKey("widevine-cert-url",n)&&b.setProtectionData({widevine:{serverCertUrl:n.keyURLs["widevine-cert-url"]}})),P}))()}preloadItem(e,n){var d=this;return _async_to_generator$N((function*(){if(Ye.trace("preloadItem",e,n),!0===pi){const p=generateAssetUrl(e,n);Ye.debug(`Prefetching HLS source for item "${e.id}" with license URL "${p}"`),d._hls.prefetchSource(p,{itemId:e.id})}}))()}createHlsPlayer(){const{_keySystem:e}=this,{Hls:n}=window,d=Xn.get(),{os:p,browser:h}=this.services.runtime,y={clearMediaKeysOnPromise:!1,customTextTrackCueRenderer:!0,debug:!!d,debugLevel:d,enableItemPreloading:!0===pi,enableIFramePreloading:!1,enablePerformanceLogging:!!d,enablePlayReadyKeySystem:!0,enableQueryParamsForITunes:!this.services.manifest.personalizedManifests,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:ui[e],useMediaKeySystemAccessFilter:!0,maintainMediaKeysBetweenSessions:!1,nativeControlsEnabled:p.isAndroid||h.isSafari,enableContentSteering:!0,allowFastSwitchUp:!0,liveAllowLowLatencyPlayback:!0};di.enabled&&Object.assign(y,{gapless:!0,enableInterstitialPlayback:!0}),(e=>{const{Hls:n}=window;if(n&&yi){const d=deepClone(n.DefaultConfig.fragLoadPolicy);d.default.reportCDNServer=!1,d.customURL.reportCDNServer=!1,e.fragLoadPolicy=d}})(y),(e=>{const n=hi.value;n&&"object"==typeof n&&Object.assign(e,n)})(y);const _=new n(y),{DATERANGE_UPDATED:m,ERROR:g,INTERNAL_ERROR:b,INTERSTITIALS_UPDATED:P,KEY_REQUEST_STARTED:S,LEVEL_SWITCHED:T,LICENSE_CHALLENGE_CREATED:k,MANIFEST_PARSED:E,UNRESOLVED_URI_LOADING:w}=n.Events;_.on(g,this.handleHlsError),_.on(b,this.handleHlsError),_.on(E,this.handleManifestParsed),_.on(S,this.handleKeyRequestStarted),_.on(k,this.handleLicenseChallengeCreated),_.on(T,this.handleLevelSwitched),_.on(m,this.handleDaterangeUpdated),di.enabled&&_.on(P,this.handleInterstitialUpdated),this.services.manifest.personalizedManifests&&_.on(w,this.handleUnresolvedUriLoading),this._hls=_,window.hlsSession=_,this._hlsJsTracks=new HlsJsTracks(this._hls),this.setupTrackManagers(this._hlsJsTracks),this._hlsPreviewImageLoader=new HlsJsPreviewImageLoader(this._hls)}handleUnresolvedUriLoading(e,n){var d=this;return _async_to_generator$N((function*(){const e=d._hls,p=n.uri,h=p.replace("manifest://","https://");Ye.debug("handleUnresolvedUriLoading for uri ",p);const y=d.services.manifest;var _;const m=null!==(_=yield y.getManifest(h))&&void 0!==_?_:yield y.fetchManifest(h);m?(yield y.clearManifest(h),e.handleResolvedUri(p,{url:h,status:200,data:m.content})):Ye.error("No cached manifest for "+h)}))()}handleInterstitialUpdated(e,n){Ye.debug("handleInterstitialUpdated - ",e,n),n.integratedTimeline.duration&&(this._integratedTimelineDuration=n.integratedTimeline.duration)}handleLevelSwitched(e,n){var d,p;const{level:h}=n;if(!h)return;const y=null===(d=this._levels)||void 0===d?void 0:d.find(e=>e.persistentId===h);if(!y||(null===(p=this._currentLevel)||void 0===p?void 0:p.persistentId)===(null==y?void 0:y.persistentId))return;this._currentLevel=y;const _=void 0!==y.audioGroupId?this._channelsByGroup[y.audioGroupId]:void 0;this._dispatcher.publish(ot.hlsLevelUpdated,{level:y,channels:_})}handleDaterangeUpdated(e,n){Ye.info("handleDaterangeUpdated",JSON.stringify(n)),this._dispatcher.publish(at.hlsDaterangeUpdated,n)}handleHlsError(e,n){var d;if(Ye.warn("HLS.js error",JSON.stringify(n)),this._unrecoverableError)return;let p=new MKError(MKError.Reason.UNSUPPORTED_ERROR,n.reason);p.data=n;const{bufferStalledError:h,keySystemGenericError:y}=ci;if(n.details===y)return void this._dispatcher.publish(y,p);let _=!1;var m;n.details===h&&"Seek"===n.stallType&&-12909===(null===(d=n.response)||void 0===d?void 0:d.code)&&(p=new MKError(MKError.Reason.BUFFER_STALLED_ERROR,n.stallType),p.data={stallType:n.stallType,code:null===(m=n.response)||void 0===m?void 0:m.code},_=!0);if("output-restricted"===n.reason&&(p=new MKError(MKError.Reason.OUTPUT_RESTRICTED,n.reason)),n.fatal){if(this._hls.destroy(),!this.shouldDispatchErrors&&!_)throw p;this._dispatcher.publish(at.mediaPlaybackError,p)}}handleManifestParsed(e,n){var d=this;return _async_to_generator$N((function*(){var e,p;let h;Ye.debug("handleManifestParsed",n),d._levels=null!==(e=n.levels)&&void 0!==e?e:[],d.nowPlayingItem.state=oe.ready,d._channelsByGroup=(null!==(p=n.audioTracks)&&void 0!==p?p:[]).reduce((e,n)=>(e[n.groupId]=n.channels,e),{});try{yield d._playMedia()}catch(St){throw Ye.warn("error from media element, possibly non-fatal",St),St}finally{h=yield d.finishPlaybackSequence()}return h}))()}handleKeyRequestStarted(e,n){Ye.debug("hlsjs-video.handleKeyRequestStarted"),this._hls.generateKeyRequest(n.keyuri,{})}handleLicenseChallengeCreated(e,n){var d=this;return _async_to_generator$N((function*(){Ye.trace("handleLicenseChallengeCreated",n);const{_licenseServerUrl:e,nowPlayingItem:p,_keySystem:h,userInitiated:y}=d;try{var _;const m=yield null===(_=d._license)||void 0===_?void 0:_.start(e,p,n,h,y),g={statusCode:m.status};(null==m?void 0:m.license)&&(h===Z.fairplay?g.ckc=N(m.license):g.license=N(m.license));const b=m["renew-after"];b&&(g.renewalDate=new Date(Date.now()+1e3*b)),d._hls.setLicenseResponse(n.keyuri,g)}catch(he){if(d._unrecoverableError)return;const p=he.data,h={};void 0!==(null==p?void 0:p.status)&&(h.statusCode=+p.status),Ye.warn("Passing license response error to Hls.js",h),d._hls.setLicenseResponse(n.keyuri,h),MKError.isMKError(he)&&li.has(he.reason)&&(d._unrecoverableError=he,d.resetDeferredPlay(),yield d.stop({endReasonType:lt.FAILED_TO_LOAD,userInitiated:y})),d.onPlaybackLicenseError(he)}}))()}seekToTime(e){var n=this;return _async_to_generator$N((function*(){n._hls?(Ye.debug("hlsjs-video: hls seekTo",e),n._hls.seekTo=e):(Ye.debug("hlsjs-video: media element seek to",e),n._targetElement.currentTime=e)}))()}loadPreviewImage(e){var n=this;return _async_to_generator$N((function*(){var d;return null===(d=n._hlsPreviewImageLoader)||void 0===d?void 0:d.loadPreviewImage(e)}))()}constructor(e){var n,d,p;super(e),_define_property$12(this,"_hls",void 0),_define_property$12(this,"_hlsPreviewImageLoader",void 0),_define_property$12(this,"_hlsJsTracks",void 0),_define_property$12(this,"_keySystem",void 0),_define_property$12(this,"_license",void 0),_define_property$12(this,"_rtcTracker",void 0),_define_property$12(this,"_levels",void 0),_define_property$12(this,"_channelsByGroup",{}),_define_property$12(this,"_currentLevel",void 0),_define_property$12(this,"_licenseServerUrl",void 0),_define_property$12(this,"_unrecoverableError",void 0),_define_property$12(this,"_integratedTimelineDuration",void 0),_define_property$12(this,"hlsScriptURL",void 0),_define_property$12(this,"appInfo",void 0),this._rtcTracker=null==e||null===(n=e.playbackServices)||void 0===n?void 0:n.getRTCStreamingTracker(),this._license=new License,this.hlsScriptURL=null===(d=e.bag)||void 0===d?void 0:d.urls.hls,this.appInfo=null===(p=e.bag)||void 0===p?void 0:p.app}}var fi;function _define_property$11(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$m(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$m(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[String,"undefined"==typeof HlsUnresolvedUriData?Object:HlsUnresolvedUriData]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleUnresolvedUriLoading",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[String,Object]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleInterstitialUpdated",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleLevelSwitched",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[String,"undefined"==typeof HlsDaterangeUpdatedData?Object:HlsDaterangeUpdatedData]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleDaterangeUpdated",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleHlsError",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleManifestParsed",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",void 0)],HlsJsVideoPlayer.prototype,"handleKeyRequestStarted",null),_ts_decorate$n([Bind(),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[void 0,void 0]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"handleLicenseChallengeCreated",null),_ts_decorate$n([AsyncDebounce(250),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[Number]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"seekToTime",null),_ts_decorate$n([(fi=250,(e,n,d)=>{const p=function(e,n){let d,p,h=0;const resetState=()=>{clearTimeout(p),p=0,d=void 0};return function(...y){const _=this;return new Promise((function(m,g){const b=Date.now();b-h<n?(d&&(d.resolve(void 0),resetState()),d={resolve:m,reject:g,args:y},p=setTimeout(()=>{e.apply(_,d.args).then(d.resolve).catch(d.reject),resetState()},n-(b-h+1))):(resetState(),h=b,e.apply(_,y).then(m).catch(g))}))}}(d.value,fi);d.value=p}),_ts_metadata$n("design:type",Function),_ts_metadata$n("design:paramtypes",[Number]),_ts_metadata$n("design:returntype",Promise)],HlsJsVideoPlayer.prototype,"loadPreviewImage",null);class ID3MetadataTrackManager{get activeMetadata(){return this._activeMetadata}get activeCues(){var e;const n=null===(e=this.metadataTrack)||void 0===e?void 0:e.activeCues;return null!=n?Array.from(n):[]}get isDestroyed(){return this._isDestroyed}get tracks(){return void 0!==this.metadataTrack?[this.metadataTrack]:[]}get currentTrack(){return this.metadataTrack}attach(e){if(void 0!==this.mediaElement&&this.mediaElement!==e)throw new Error("MetadaTrackManager is already attached to a different HTMLMediaElement.");this.mediaElement!==e&&(this.mediaElement=e,this.mediaElement.addEventListener("loadedmetadata",this.registerMetadataTrack),this.mediaElement.addEventListener("loadeddata",this.registerMetadataTrack))}detach(){void 0!==this.mediaElement&&(this.mediaElement.removeEventListener("loadedmetadata",this.registerMetadataTrack),this.mediaElement.removeEventListener("loadeddata",this.registerMetadataTrack),this.mediaElement=void 0),void 0!==this.metadataTrack&&(this.metadataTrack.removeEventListener("cuechange",this.onCueChange),this.metadataTrack=void 0)}registerMetadataTrack(e){if(void 0!==this.mediaElement)for(let d=0;d<this.mediaElement.textTracks.length;d++){const e=this.mediaElement.textTracks[d];if("metadata"===e.kind){var n;if(void 0===this.metadataTrack)this.metadataTrack=e,this.metadataTrack.addEventListener("cuechange",this.onCueChange);else ti.warning(`Skipping registering metadata TextTrack with id "${null!==(n=e.id)&&void 0!==n?n:"unknown"}"`);break}}}onCueChange(e){if(ti.debug("Processing metadata cues"),void 0===this.activeCues||this.activeCues.length<=0){var n;if(void 0!==this.activeMetadata)null===(n=this.onchange)||void 0===n||n.call(this);this._activeMetadata=void 0}else{const e=function(e){const n={};for(const h of e){if(!isTextTrackID3FrameCue(h)||void 0===(null==h?void 0:h.value))continue;const e=h.value;switch(e.key){case"TALB":n.album=e.data;break;case"TIT2":n.title=e.data;break;case"TPE1":n.performer=e.data;break;case"WXXX":var d,p;if(n.links=null!==(d=n.links)&&void 0!==d?d:[],!n.links.some(({url:n})=>n===e.data))n.links.push({description:null!==(p=e.description)&&void 0!==p?p:"",url:e.data});break;case"PRIV":{const d=e.owner||e.info;"com.apple.radio.ping.jingle"===d&&(n.blob=parsePingBlob(e.data)),"com.apple.radio.adamid"===d&&(n.storefrontAdamIds=parseStorefrontAdamIds(e.data));break}}}return new TimedMetadata(n)}(this.activeCues);var d;if(void 0===this.activeMetadata||!e.equals(this.activeMetadata))ti.debug("Track TimedMetadata changed",e),this._activeMetadata=e,null===(d=this.onchange)||void 0===d||d.call(this,e)}}saveTrack(){}restoreSelectedTrack(){}destroy(){this._isDestroyed=!0,this.onchange=void 0,this.detach()}constructor(e){_define_property$11(this,"_isDestroyed",!1),_define_property$11(this,"mediaElement",void 0),_define_property$11(this,"metadataTrack",void 0),_define_property$11(this,"_activeMetadata",void 0),_define_property$11(this,"onchange",void 0),this.onchange=null==e?void 0:e.onchange,void 0!==(null==e?void 0:e.element)&&this.attach(e.element)}}function asyncGeneratorStep$M(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$M(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$M(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$M(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$10(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$l(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$l(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}_ts_decorate$m([Bind(),_ts_metadata$m("design:type",Function),_ts_metadata$m("design:paramtypes",[Object]),_ts_metadata$m("design:returntype",void 0)],ID3MetadataTrackManager.prototype,"registerMetadataTrack",null),_ts_decorate$m([Bind(),_ts_metadata$m("design:type",Function),_ts_metadata$m("design:paramtypes",[Object]),_ts_metadata$m("design:returntype",void 0)],ID3MetadataTrackManager.prototype,"onCueChange",null);const _i=BooleanDevFlag.get("mk-hlsjs-item-preloading"),vi={keySystemGenericError:"keySystemGenericError"},mi=new Set([MKError.Reason.DEVICE_LIMIT,MKError.Reason.GEO_BLOCK]),gi={[Z.clearkey]:"",[Z.fairplay]:"fairplaystreaming",[Z.widevine]:"widevine",[Z.playready]:"playready"},bi=Ye.createChild("hlsjs-audio"),Pi=JsonDevFlag.register("mk-hlsjs-config-overrides");class HlsJsAudioPlayer extends BasePlayer{loadPreviewImage(){return _async_to_generator$M((function*(){}))()}get _targetElement(){return this.mediaElement}preloadItem(e,n){var d=this;return _async_to_generator$M((function*(){if(bi.trace("preloadItem",e,n),!0===_i){const p=generateAssetUrl(e,n);bi.debug(`Prefetching HLS source for item "${e.id}" with license URL "${p}"`),d.hls.prefetchSource(p,{itemId:e.id})}}))()}setPresentationMode(e){return _async_to_generator$M((function*(){return Promise.resolve()}))()}get shouldDispatchErrors(){return!this.userInitiated||this._playbackDidStart}get currentPlayingDate(){var e;return null===(e=this.hls)||void 0===e?void 0:e.playingDate}get isPlayingAtLiveEdge(){var e;const n=this.hls;return!(!n||!(null===(e=this.nowPlayingItem)||void 0===e?void 0:e.isLinearStream))&&!!n.isPlayingAtLive}playItemFromEncryptedSource(e,n=!1,d={}){var p=this;return _async_to_generator$M((function*(){bi.trace("HlsJsAudioPlayer.playItemFromEncryptedSource",e,d),p.playbackState!==be.stopped?(bi.debug("Playing Encrypted Item: "+mediaItemLogString(e)),e.playbackType=ie.encryptedFull,p.nowPlayingItem=e,e.state=oe.loading,p.userInitiated=n,yield p.playHlsStream(e.assetURL,e,d)):bi.debug("hlsjsAudioPlayer.playItemFromEncryptedSource aborting playback because player is stopped")}))()}initializeMediaElement(){var e=this;return _async_to_generator$M((function*(){const n=nextAvailableAudioElement();n.autoplay=!1,n.id="apple-music-player",n.controls=!1,n.muted=!1,n.playbackRate=1,n.preload="metadata",n.volume=1,e.mediaElement=n,document.body.appendChild(n),e.id3MetadataManager.attach(n),bi.debug("initializedMediaElement",n)}))()}get seekableTimeRanges(){const e=this.hls;return e?e.seekableTimeRanges:this.currentPlaybackDuration?[{start:0,end:this.currentPlaybackDuration}]:void 0}initializeExtension(){var e=this;return _async_to_generator$M((function*(){const{preferredKeySystem:n}=e.services.runtime;e._keySystem=void 0!==n?Z[n]:void 0;try{var d;if(!e.hlsScriptURL)throw new Error("HLS.js script URL is not configured");yield Promise.all([loadScript(e.hlsScriptURL),null===(d=e._rtcTracker)||void 0===d?void 0:d.loadScript()])}catch(St){throw bi.error("hlsjs-audio-player failed to load script "+e.hlsScriptURL,St),St}}))()}stopMediaElement(){var e=this,_superprop_get_stopMediaElement=()=>super.stopMediaElement;return _async_to_generator$M((function*(){bi.trace("HlsJsAudioPlayer.stopMediaElement()"),yield _superprop_get_stopMediaElement().call(e),e.destroy()}))()}destroy(){if(bi.debug("HlsJsAudioPlayer.destroy()"),this.hls){const e=this.hls;e.stopLoad();const n=e.Events;e.off(n.ERROR,this.handleHlsError),e.off(n.INTERNAL_ERROR,this.handleHlsError),e.off(n.MANIFEST_PARSED,this.handleManifestParsed),e.off(n.KEY_REQUEST_STARTED,this.handleKeyRequestStarted),e.off(n.LICENSE_CHALLENGE_CREATED,this.handleLicenseChallengeCreated),e.off(n.LEVEL_SWITCHED,this.handleLevelSwitched),e.destroy()}this.id3MetadataManager.destroy(),super.destroy(),asAsync(this._license.stop())}playHlsStream(e,n,d={}){var p=this;return _async_to_generator$M((function*(){var h;let y,_;bi.trace("HlsJsAudioPlayer.playHlsStream()",e,n,d),p._unrecoverableError=void 0,bi.debug("Initiating HLS.js player"),p.createHlsPlayer(),p._keySystem===Z.widevine&&(bi.debug("Setting Widevine specific HLS options"),y="WIDEVINE_SOFTWARE",_={initDataTypes:["cenc","keyids"],distinctiveIdentifier:"optional",persistentState:"required"});const m={subs:"accepts-css",platformInfo:{requiresCDMAttachOnStart:void 0!==p._keySystem,maxSecurityLevel:y,keySystemConfig:_},appData:{serviceName:null===(h=p.appInfo)||void 0===h?void 0:h.name},itemId:null==n?void 0:n.id};if(void 0!==p._rtcTracker){const e=p._rtcTracker.prepareReportingAgent(n);void 0!==e&&(bi.debug("Adding RTC agent to loadSource options",e),m.appData.reportingAgent=e)}const g=p.startPlaybackSequence();return bi.info("Loading source into HLS.js: "+e),bi.debug("Calling loadSource with options",m),p.hls.loadSource(e,m,d.startTime),bi.debug("Attaching HTMLMediaElement to HLS instance",p.mediaElement),p.hls.attachMedia(p.mediaElement),n&&(p._licenseServerUrl=n.keyURLs["hls-key-server-url"],p._keySystem===Z.fairplay?(bi.info("Setting Protection Data URL for FairPlay: "+n.keyURLs["hls-key-cert-url"]),p.hls.setProtectionData({fairplaystreaming:{serverCertUrl:n.keyURLs["hls-key-cert-url"]}})):(bi.info("Setting Protection Data URL for Widevine: "+n.keyURLs["widevine-cert-url"]),p.hls.setProtectionData({widevine:{serverCertUrl:n.keyURLs["widevine-cert-url"]}}))),g}))()}createHlsPlayer(){bi.trace("HlsJsAudioPlayer.createHlsPlayer()");const{_keySystem:e}=this,{os:n}=this.services.runtime,{Hls:d}=window,p=Xn.get(),h={clearMediaKeysOnPromise:!1,debug:!!p,debugLevel:p,enableItemPreloading:!0===_i,enablePerformanceLogging:!!p,enablePlayReadyKeySystem:!0,enableRtcReporting:void 0!==this._rtcTracker,keySystemPreference:gi[e],useMediaKeySystemAccessFilter:!0,nativeControlsEnabled:n.isAndroid,enableID3Cues:!0};bi.debug("Reading HLS.js option overrides from DevFlag"),(e=>{const n=Pi.value;n&&"object"==typeof n&&Object.assign(e,n)})(h),bi.debug("Constructing HLS instance",h);const y=new d(h);bi.debug("Using HLS instance with ID "+y.sessionID,h),bi.debug("Adding Event handlers for HLS instance"),y.on(d.Events.ERROR,this.handleHlsError),y.on(d.Events.INTERNAL_ERROR,this.handleHlsError),y.on(d.Events.MANIFEST_PARSED,this.handleManifestParsed),y.on(d.Events.KEY_REQUEST_STARTED,this.handleKeyRequestStarted),y.on(d.Events.LICENSE_CHALLENGE_CREATED,this.handleLicenseChallengeCreated),y.on(d.Events.LEVEL_SWITCHED,this.handleLevelSwitched),this.hls=y}handleLevelSwitched(e,n){var d,p;const{level:h}=n;if(!h)return;const y=null===(d=this._levels)||void 0===d?void 0:d.find(e=>e.persistentId===h);if(!y||(null===(p=this._currentLevel)||void 0===p?void 0:p.persistentId)===(null==y?void 0:y.persistentId))return;this._currentLevel=y;const _=void 0!==y.audioGroupId?this._channelsByGroup[y.audioGroupId]:void 0;this._dispatcher.publish(ot.hlsLevelUpdated,{level:y,channels:_})}handleHlsError(e,n){if(bi.warn("HLS.js error",JSON.stringify(n)),this._unrecoverableError)return;let d=new MKError(MKError.Reason.UNSUPPORTED_ERROR,n.reason);d.data=n;const{keySystemGenericError:p}=vi;if(n.details!==p){if("output-restricted"===n.reason&&(d=new MKError(MKError.Reason.OUTPUT_RESTRICTED,n.reason)),n.fatal){if(this.hls.destroy(),!this.shouldDispatchErrors)throw d;this._dispatcher.publish(at.mediaPlaybackError,d)}}else this._dispatcher.publish(p,d)}handleManifestParsed(e,n){var d=this;return _async_to_generator$M((function*(){var e,p;let h;bi.debug("handleManifestParsed",n),d._levels=null!==(e=n.levels)&&void 0!==e?e:[],d.nowPlayingItem.state=oe.ready,d._channelsByGroup=(null!==(p=n.audioTracks)&&void 0!==p?p:[]).reduce((e,n)=>(e[n.groupId]=n.channels,e),{});try{yield d._playMedia()}catch(St){throw bi.warn("error from media element, possibly non-fatal",St),St}finally{h=yield d.finishPlaybackSequence()}return h}))()}handleKeyRequestStarted(e,n){var d,p;bi.trace("HlsJsAudioPlayer.handleKeyRequestStarted()",n);const h=null!==(p=null===(d=n.appItemIds)||void 0===d?void 0:d[0])&&void 0!==p?p:"unknown";bi.debug(`Generating key request for item ${h} with URI ${n.keyuri}`),this.hls.generateKeyRequest(n.keyuri,{})}handleLicenseChallengeCreated(e,n){var d=this;return _async_to_generator$M((function*(){var e,p;bi.trace("HlsJsAudioPlayer.handleLicenseChallengeCreated()",n);const h=null!==(p=null===(e=n.appItemIds)||void 0===e?void 0:e[0])&&void 0!==p?p:"unknown";bi.debug(`Handling License Challenge for item ${h} with URI ${n.keyuri}`);const y=d.nowPlayingItem;bi.debug("Using MediaItem "+mediaItemLogString(d.nowPlayingItem));try{var _;const e=yield null===(_=d._license)||void 0===_?void 0:_.start(d._licenseServerUrl,y,n,d._keySystem,d.userInitiated),p={statusCode:e.status};(null==e?void 0:e.license)&&(d._keySystem===Z.fairplay?p.ckc=N(e.license):p.license=N(e.license));const h=e["renew-after"];h&&(p.renewalDate=new Date(Date.now()+1e3*h)),bi.debug(`Passing License Challenge Response for ${n.keyuri} to HLS`,p),d.hls.setLicenseResponse(n.keyuri,p)}catch(St){if(d._unrecoverableError)return;const p=St.data,h={};void 0!==(null==p?void 0:p.status)&&(h.statusCode=+p.status),bi.warn("Passing license response error to Hls.js",h),d.hls.setLicenseResponse(n.keyuri,h),mi.has(St.reason)&&(d._unrecoverableError=St,d.resetDeferredPlay(),yield d.stop({endReasonType:lt.FAILED_TO_LOAD,userInitiated:d.userInitiated})),d.onPlaybackLicenseError(St)}}))()}onPlaybackLicenseError(e){this.resetDeferredPlay(),this._dispatcher.publish(Wr.playbackLicenseError,e)}seekToTime(e){var n=this;return _async_to_generator$M((function*(){n.hls?(bi.debug("hlsjs-video: hls seekTo",e),n.hls.seekTo=e):(bi.debug("hlsjs-video: media element seek to",e),n._targetElement.currentTime=e)}))()}constructor(e){var n,d,p;super(e),_define_property$10(this,"currentAudioTrack",void 0),_define_property$10(this,"currentTextTrack",void 0),_define_property$10(this,"textTracks",[]),_define_property$10(this,"audioTracks",[]),_define_property$10(this,"userInitiated",!1),_define_property$10(this,"mediaElement",void 0),_define_property$10(this,"mediaPlayerType","hlsjs-audio"),_define_property$10(this,"hls",void 0),_define_property$10(this,"supportsPreviewImages",!1),_define_property$10(this,"extension",void 0),_define_property$10(this,"_keySystem",void 0),_define_property$10(this,"_license",void 0),_define_property$10(this,"_rtcTracker",void 0),_define_property$10(this,"_levels",void 0),_define_property$10(this,"_channelsByGroup",{}),_define_property$10(this,"_currentLevel",void 0),_define_property$10(this,"_licenseServerUrl",void 0),_define_property$10(this,"_unrecoverableError",void 0),_define_property$10(this,"hlsScriptURL",void 0),_define_property$10(this,"appInfo",void 0),_define_property$10(this,"id3MetadataManager",void 0),this._rtcTracker=null==e||null===(n=e.playbackServices)||void 0===n?void 0:n.getRTCStreamingTracker(),this._license=new License,this.appInfo=null===(d=e.bag)||void 0===d?void 0:d.app,this.hlsScriptURL=null===(p=e.bag)||void 0===p?void 0:p.urls.hls,this.id3MetadataManager=new ID3MetadataTrackManager({onchange:e=>{var n;const d={item:this.nowPlayingItem,metadata:e,position:this.currentPlaybackTime,playingDate:this.currentPlayingDate};bi.debug("Dispatching bufferTimedMetadataDidChange",d),null===(n=this._dispatcher)||void 0===n||n.publish(xn,d)}})}}_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[void 0,void 0]),_ts_metadata$l("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleLevelSwitched",null),_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[void 0,void 0]),_ts_metadata$l("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleHlsError",null),_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[void 0,void 0]),_ts_metadata$l("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"handleManifestParsed",null),_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[Object,Object]),_ts_metadata$l("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"handleKeyRequestStarted",null),_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[Object,"undefined"==typeof LicenseData?Object:LicenseData]),_ts_metadata$l("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"handleLicenseChallengeCreated",null),_ts_decorate$l([Bind(),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",["undefined"==typeof Error?Object:Error]),_ts_metadata$l("design:returntype",void 0)],HlsJsAudioPlayer.prototype,"onPlaybackLicenseError",null),_ts_decorate$l([AsyncDebounce(250),_ts_metadata$l("design:type",Function),_ts_metadata$l("design:paramtypes",[Number]),_ts_metadata$l("design:returntype",Promise)],HlsJsAudioPlayer.prototype,"seekToTime",null),e.version="3.2524.0";const Si=e.version.split("."),Ti=Si[0],ki=Si[Si.length-1];Si[0]="3",Si[Si.length-1]=ki+"-prerelease",Si[0]=Ti,Si[Si.length-1]=ki,e.version=Si.join(".");var Ei=function(e){return e.REPEAT="REPEAT",e.SHUFFLE="SHUFFLE",e.AUTOPLAY="AUTOPLAY",e}({}),wi=function(e){return e[e.PREVIEW_ONLY=0]="PREVIEW_ONLY",e[e.MIXED_CONTENT=1]="MIXED_CONTENT",e[e.FULL_PLAYBACK_ONLY=2]="FULL_PLAYBACK_ONLY",e[e.SHAREPLAY_PARTICIPANT=3]="SHAREPLAY_PARTICIPANT",e}({});const Oi={configured:"musickitconfigured",loaded:"musickitloaded",audioTrackAdded:at.audioTrackAdded,audioTrackChanged:at.audioTrackChanged,audioTrackRemoved:at.audioTrackRemoved,authorizationStatusDidChange:Ge.authorizationStatusDidChange,authorizationStatusWillChange:Ge.authorizationStatusWillChange,bufferedProgressDidChange:at.bufferedProgressDidChange,capabilitiesChanged:"capabilitiesChanged",autoplayEnabledDidChange:"autoplayEnabledDidChange",drmUnsupported:at.drmUnsupported,eligibleForSubscribeView:Ge.eligibleForSubscribeView,forcedTextTrackChanged:at.forcedTextTrackChanged,hlsDaterangeUpdated:at.hlsDaterangeUpdated,mediaCanPlay:at.mediaCanPlay,mediaElementCreated:at.mediaElementCreated,mediaItemStateDidChange:I.mediaItemStateDidChange,mediaItemStateWillChange:I.mediaItemStateWillChange,mediaPlaybackError:at.mediaPlaybackError,mediaSkipAvailable:"mediaSkipAvailable",mediaRollEntered:"mediaRollEntered",mediaUpNext:"mediaUpNext",metadataDidChange:at.metadataDidChange,needsGDPRDidChange:"needsGDPRDidChange",nowPlayingItemDidChange:at.nowPlayingItemDidChange,nowPlayingItemWillChange:at.nowPlayingItemWillChange,playInitiated:"playInitiated",playbackBitrateDidChange:at.playbackBitrateDidChange,playbackDurationDidChange:at.playbackDurationDidChange,playbackProgressDidChange:at.playbackProgressDidChange,playbackRateDidChange:at.playbackRateDidChange,playbackStateDidChange:at.playbackStateDidChange,playbackStateWillChange:at.playbackStateWillChange,playbackTargetAvailableDidChange:at.playbackTargetAvailableDidChange,playbackTargetIsWirelessDidChange:at.playbackTargetIsWirelessDidChange,playbackTimeDidChange:at.playbackTimeDidChange,playbackVolumeDidChange:at.playbackVolumeDidChange,playerTypeDidChange:at.playerTypeDidChange,presentationModeDidChange:at.presentationModeDidChange,primaryPlayerDidChange:at.primaryPlayerDidChange,queueIsReady:"queueIsReady",queueItemsDidChange:"queueItemsDidChange",queueItemForStartPosition:"queueItemForStartPosition",queuePositionDidChange:"queuePositionDidChange",shuffleModeDidChange:"shuffleModeDidChange",repeatModeDidChange:"repeatModeDidChange",storefrontCountryCodeDidChange:Ge.storefrontCountryCodeDidChange,storefrontIdentifierDidChange:Ge.storefrontIdentifierDidChange,textTrackAdded:at.textTrackAdded,textTrackChanged:at.textTrackChanged,textTrackRemoved:at.textTrackRemoved,timedMetadataDidChange:at.timedMetadataDidChange,userTokenDidChange:Ge.userTokenDidChange,webComponentsLoaded:"musickitwebcomponentsloaded"},Ii="sharePlay.playbackStateChanged",$i="sharePlay.volumeChanged",Ai="sharePlay.nextItem",Ri="sharePlay.previousItem",Ci="sharePlay.shuffleModeChanged",Mi="sharePlay.repeatModeChanged",Di="sharePlay.autoPlayChanged",ji="sharePlay.progressChanged",xi="sharePlay.mediaStateUpdate";function asyncGeneratorStep$L(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$$(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$k(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class SpanWatcher{startMonitor(){this.dispatcher.unsubscribe(Oi.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Oi.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Oi.playbackTimeDidChange,this.handleTimeChange)}handleTimeChange(e,{currentPlaybackTime:n}){var d,p=this;return(d=function*(){!Number.isFinite(n)||n<p.start||n>p.stop?p.inWatchSpan=!1:p.inWatchSpan||(p.allowMultiple||p.stopMonitor(),p.inWatchSpan=!0,yield p.callback(n,p))},function(){var e=this,n=arguments;return new Promise((function(p,h){var y=d.apply(e,n);function _next(e){asyncGeneratorStep$L(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$L(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,n,d,p,h=!1){_define_property$$(this,"dispatcher",void 0),_define_property$$(this,"callback",void 0),_define_property$$(this,"start",void 0),_define_property$$(this,"stop",void 0),_define_property$$(this,"allowMultiple",void 0),_define_property$$(this,"inWatchSpan",void 0),this.dispatcher=e,this.callback=n,this.start=d,this.stop=p,this.allowMultiple=h,this.inWatchSpan=!1}}function _define_property$_(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$j(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$k("design:type",Function),_ts_metadata$k("design:paramtypes",[void 0,void 0]),_ts_metadata$k("design:returntype",Promise)],SpanWatcher.prototype,"handleTimeChange",null);class PlaybackMonitor{activate(){this.isActive=!0,this.startMonitor()}deactivate(){this.isActive=!1,this.clearMonitor()}clearMonitor(){this.isMonitoring&&(this.watchers.forEach(e=>e.stopMonitor()),this.isMonitoring=!1)}shouldMonitor(){return this.isActive}startMonitor(){this.shouldMonitor()&&(this.watchers.forEach(e=>e.startMonitor()),this.isMonitoring=!0)}handleMediaItemChange(){this.isActive&&(this.clearMonitor(),this.shouldMonitor()&&this.startMonitor())}constructor(e){_define_property$_(this,"isActive",!1),_define_property$_(this,"isMonitoring",!1),_define_property$_(this,"apiManager",void 0),_define_property$_(this,"dispatcher",void 0),_define_property$_(this,"playbackController",void 0),_define_property$_(this,"watchers",[]),this.handlePlaybackThreshold=this.handlePlaybackThreshold.bind(this),this.playbackController=e.controller,this.dispatcher=e.services.dispatcher,this.dispatcher.subscribe(Oi.nowPlayingItemDidChange,this.handleMediaItemChange),this.apiManager=e.services.apiManager}}function asyncGeneratorStep$K(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$j("design:type",Function),_ts_metadata$j("design:paramtypes",[]),_ts_metadata$j("design:returntype",void 0)],PlaybackMonitor.prototype,"handleMediaItemChange",null);class RollMonitor extends PlaybackMonitor{handlePlaybackThreshold(e,n){var d,p=this;return(d=function*(){if(!p.rollMap.has(n))return;const e=p.rollMap.get(n);p.dispatcher.publish(Oi.mediaRollEntered,e),p.rollMap.delete(n)},function(){var e=this,n=arguments;return new Promise((function(p,h){var y=d.apply(e,n);function _next(e){asyncGeneratorStep$K(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$K(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getRollMetadata().length>0}startMonitor(){this.setupWatchers(this.getRollMetadata()),super.startMonitor()}getRollMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:function(e,n=["pre-roll","mid-roll","post-roll"]){if(void 0===e.hlsMetadata)return[];const d=[];return n.forEach(n=>{const p=parseInt(e.hlsMetadata[n+".count"],10);if(!isNaN(p))for(let h=0;h<p;h++){const p=`${n}.${h}`,y={index:h,type:n,skippable:"true"===e.hlsMetadata[p+".skippable"],"adam-id":e.hlsMetadata[p+".adam-id"],start:Math.round(parseFloat(e.hlsMetadata[p+".start"])),duration:Math.round(parseFloat(e.hlsMetadata[p+".duration"]))},_=p+".dynamic-slot.data-set-id";void 0!==e.hlsMetadata[_]&&(y["dynamic-id"]=e.hlsMetadata[_]),d.push(y)}}),d}(e,["pre-roll","post-roll"])}setupWatchers(e){const n=[];e.forEach(e=>{const{start:d,duration:p}=e,h=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,d,d+p);n.push(h),this.rollMap.set(h,e)}),this.watchers=n}constructor(e){super(e),function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"rollMap",new Map)}}function asyncGeneratorStep$J(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}class SkipAvailable extends PlaybackMonitor{handlePlaybackThreshold(e,n){var d,p=this;return(d=function*(){if(!p.skipMap.has(n))return;const e=p.skipMap.get(n);p.dispatcher.publish(Oi.mediaSkipAvailable,e)},function(){var e=this,n=arguments;return new Promise((function(p,h){var y=d.apply(e,n);function _next(e){asyncGeneratorStep$J(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$J(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;return this.getNowPlayingMetadata().length>0}startMonitor(){this.setupWatchers(this.getNowPlayingMetadata()),super.startMonitor()}getNowPlayingMetadata(){const e=this.playbackController.nowPlayingItem;return void 0===e?[]:function(e){const n=parseInt(e.hlsMetadata["skip.count"],10),d=[];if(isNaN(n)||0===n)return d;for(let p=0;p<n;p++){const n={start:parseFloat(e.hlsMetadata[`skip.${p}.start`]),duration:parseFloat(e.hlsMetadata[`skip.${p}.duration`]),target:parseFloat(e.hlsMetadata[`skip.${p}.target`]),label:e.hlsMetadata[`skip.${p}.label`]};void 0!==e.hlsMetadata[`skip.${p}.promo.enabled`]&&(n.promo={enabled:"true"===e.hlsMetadata[`skip.${p}.promo.enabled`],image:e.hlsMetadata[`skip.${p}.promo.image`],"image-height":parseInt(e.hlsMetadata[`skip.${p}.promo.image-height`],10),"image-width":parseInt(e.hlsMetadata[`skip.${p}.promo.image-width`],10),genre:e.hlsMetadata[`skip.${p}.promo.genre`],"release-year":parseInt(e.hlsMetadata[`skip.${p}.promo.release-year`],10),"rating-display-name":e.hlsMetadata[`skip.${p}.promo.rating-display-name`],"rating-system":e.hlsMetadata[`skip.${p}.promo.rating-system`],"canonical-id":e.hlsMetadata[`skip.${p}.promo.canonical-id`],title:e.hlsMetadata[`skip.${p}.promo.title`],"rating-tag":e.hlsMetadata[`skip.${p}.promo.rating-tag`],"rating-rank":e.hlsMetadata[`skip.${p}.promo.rating-rank`],"up-next":{"is-added":"true"===e.hlsMetadata[`skip.${p}.promo.up-next.is-added`],"add-label":e.hlsMetadata[`skip.${p}.promo.up-next.add-label`],"added-label":e.hlsMetadata[`skip.${p}.promo.up-next.added-label`]},runtime:parseInt(e.hlsMetadata[`skip.${p}.promo.runtime`],10)}),d.push(n)}return d}(e)}setupWatchers(e){const n=[];e.forEach(e=>{const{start:d,target:p,duration:h,promo:y}=e,_=new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,d,y?p:d+h,!0);n.push(_),this.skipMap.set(_,e)}),this.watchers=n}constructor(e){super(e),function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"skipMap",new Map)}}function asyncGeneratorStep$I(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$X(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const hasContentCompletionThresholdData=e=>!isNaN(getUpNextStart(e))&&!isNaN(getWatchedTime(e)),getUpNextStart=e=>parseFloat(e.hlsMetadata["up-next.start"]),getWatchedTime=e=>parseFloat(e.hlsMetadata["watched.time"]),Ni=function(){var e,n=(e=function*(e,n){if(e.isUTS&&e.assetURL)try{const d=generateAssetUrl(e,n.playOptions),p=yield n.manifestManager.fetchManifest(d);e.hlsMetadata=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$X(e,n,d[n])}))}return e}({},e.hlsMetadata,function(e,n={}){const d=/^(?:#EXT-X-SESSION-DATA:?)DATA-ID="([^"]+)".+VALUE="([^"]+)".*$/,p={};for(const h of e.split("\n")){const e=h.match(d);if(e){let d=e[1];e[1].startsWith("com.apple.hls.")&&!1!==n.stripPrefix&&(d=e[1].slice("com.apple.hls.".length));const h=e[2];p[d]=h}}return p}(p.content))}catch(he){Qe.error(he.message,he)}},function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$I(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$I(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))});return function(e,d){return n.apply(this,arguments)}}();function asyncGeneratorStep$H(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _ts_metadata$i(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class UpNextMonitor extends PlaybackMonitor{handlePlaybackThreshold(){var e,n=this;return(e=function*(){n.dispatcher.publish(Oi.mediaUpNext)},function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$H(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$H(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;const e=this.playbackController.nowPlayingItem;return void 0!==e&&hasContentCompletionThresholdData(e)}startMonitor(){this.setupWatchers(),super.startMonitor()}setupWatchers(){const e=this.playbackController.nowPlayingItem;e&&hasContentCompletionThresholdData(e)&&(this.watchers=[new SpanWatcher(this.dispatcher,this.handlePlaybackThreshold,Math.round(this.getStartTime(e)),Number.POSITIVE_INFINITY)])}getStartTime(e){const n=getUpNextStart(e);return isNaN(n)?getWatchedTime(e):n}constructor(e){super(e)}}function _define_property$W(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$i("design:type",Function),_ts_metadata$i("design:paramtypes",[]),_ts_metadata$i("design:returntype",Promise)],UpNextMonitor.prototype,"handlePlaybackThreshold",null);var Li=function(e){return e[e.none=0]="none",e[e.one=1]="one",e[e.all=2]="all",e}({});class BaseRepeatable{get repeatMode(){return 0}set repeatMode(e){e!==this.repeatMode&&Qe.warn("setting repeatMode is not supported in this playback method")}constructor(){_define_property$W(this,"canSetRepeatMode",!1)}}class Repeatable{get repeatMode(){return this._repeatMode}set repeatMode(e){e in Li&&e!==this._repeatMode&&(this._repeatMode=e,this.dispatcher.publish(Oi.repeatModeDidChange,this._repeatMode))}constructor(e,n=0){_define_property$W(this,"canSetRepeatMode",!0),_define_property$W(this,"dispatcher",void 0),_define_property$W(this,"_repeatMode",void 0),this.dispatcher=e,this._repeatMode=n}}const Ui=getHlsJsCdnConfig(),Fi={app:{},autoplay:{maxQueueSizeForAutoplay:50,maxQueueSizeInRequest:10,maxUpcomingTracksToMaintain:10},features:{xtrick:!0,isWeb:!0,bookmarking:!1,"seamless-audio-transitions":!0,"enhanced-hls":!1,"fetch-container-pages":!1},urls:{hls:Ui.hls,rtc:Ui.rtc,mediaApi:"https://amp-api.music.apple.com/v1",webPlayback:`https://${getCommerceHostname("play")}/WebObjects/MZPlay.woa/wa/webPlayback`}},Ki=JsonDevFlag.register("mk-offers-key-urls").get();function asyncGeneratorStep$G(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$G(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$G(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$G(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$V(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$q(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}let Bi;Fi.urls.hlsOffersKeyUrls=Ki||{"hls-key-cert-url":"https://s.mzstatic.com/skdtool_2021_certbundle.bin","hls-key-server-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/podcast/hls/license/streaming/start","widevine-cert-url":"https://play.itunes.apple.com/WebObjects/MZPlay.woa/wa/widevineCert"};class Store{get authorizationStatus(){return this.storekit.authorizationStatus}get cid(){return this.storekit.cid}get developerToken(){return this.storekit.developerToken}get hasAuthorized(){return this._hasAuthorized}get isAuthorized(){return this.storekit.hasAuthorized}get isRestricted(){return this.storekit.authorizationStatus===je.RESTRICTED}get isU13(){return this.storekit.isU13}get metricsClientId(){return this._metricsClientId}set metricsClientId(e){this._metricsClientId=e}get musicUserToken(){return this.storekit.userToken}set musicUserToken(e){this.storekit.userToken=e}updateUserTokenFromStorage(){return this.storekit.updateUserTokenFromStorage()}set dynamicMusicUserToken(e){this.storekit.dynamicUserToken=e}get needsGDPR(){Qe.error("needsGDPR has been deprecated. Plesae migrate to shouldDisplayPrivacyLink()")}get realm(){return this.storekit.realm}set requestUserToken(e){this._providedRequestUserToken=!0,this.storekit.requestUserToken=e}get restrictedEnabled(){return this.storekit.restrictedEnabled}set restrictedEnabled(e){this.storekit.overrideRestrictEnabled(e)}get storefrontCountryCode(){var e;return this.isAuthorized?this.storekit.storefrontCountryCode:null!==(e=this._defaultStorefrontCountryCode)&&void 0!==e?e:this.storekit.storefrontCountryCode}get storefrontId(){return this._apiStorefrontId||this.storekit.storefrontCountryCode}set storefrontId(e){e&&(e=e.toLowerCase()),e!==this._apiStorefrontId&&(this._apiStorefrontId=e,this.dispatcher.publish(ot.apiStorefrontChanged,{storefrontId:e}))}get subscribeURL(){return this.storekit.deeplinkURL({p:"subscribe"})}get subscribeFamilyURL(){return this.storekit.deeplinkURL({p:"subscribe-family"})}get subscribeIndividualURL(){return this.storekit.deeplinkURL({p:"subscribe-individual"})}get subscribeStudentURL(){return this.storekit.deeplinkURL({p:"subscribe-student"})}get userToken(){return this.musicUserToken}authorize(){var e=this;return _async_to_generator$G((function*(){if(e.storekit.userTokenIsValid)return e.storekit.userToken;let n;try{n=yield e.storekit.requestUserToken()}catch(he){try{yield e.unauthorize()}catch(St){}throw new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unauthorized")}return e._providedRequestUserToken&&(e.storekit.userToken=n),e.storekit.userTokenIsValid?(yield e.storekit.requestStorefrontCountryCode().catch(function(){var n=_async_to_generator$G((function*(n){return yield e.unauthorize(),Promise.reject(n)}));return function(e){return n.apply(this,arguments)}}()),n):void 0}))()}shouldDisplayPrivacyLink(e){var n=this;return _async_to_generator$G((function*(){return n.storekit.shouldDisplayPrivacyLink(e)}))()}unauthorize(){var e=this;return _async_to_generator$G((function*(){return e.storekit.revokeUserToken()}))()}constructor(e,n={}){var d,p;_define_property$V(this,"precache",void 0),_define_property$V(this,"storekit",void 0),_define_property$V(this,"dispatcher",void 0),_define_property$V(this,"_apiStorefrontId",void 0),_define_property$V(this,"_defaultStorefrontCountryCode",void 0),_define_property$V(this,"_hasAuthorized",!1),_define_property$V(this,"_metricsClientId",void 0),_define_property$V(this,"_providedRequestUserToken",!1),this.dispatcher=n.services.dispatcher,"precache"in n&&(this.precache=n.precache),n.storefrontId&&(this.storefrontId=n.storefrontId),this._defaultStorefrontCountryCode=n.storefrontCountryCode,("affiliateToken"in n||"campaignToken"in n)&&(n.linkParameters=_object_spread_props$q(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$V(e,n,d[n])}))}return e}({},n.linkParameters||{}),{at:n.affiliateToken,ct:n.campaignToken})),this.storekit=new StoreKit(e,{apiBase:Fi.urls.mediaApi,authenticateMethod:Fi.features["legacy-authenticate-method"]?"POST":"GET",deeplink:n.linkParameters,disableAuthBridge:n.disableAuthBridge,iconURL:Fi.app.icon,meParameters:n.meParameters,persist:n.persist,realm:n.realm||Ae.MUSIC,fetch:null==n||null===(p=n.services)||void 0===p||null===(d=p.request)||void 0===d?void 0:d.fetch,disableLogoutURL:n.disableLogoutURL}),this.storekit.addEventListener(Oi.authorizationStatusDidChange,e=>{const{authorizationStatus:n}=e;this._hasAuthorized=[je.AUTHORIZED,je.RESTRICTED].includes(n)})}}function formattedSeconds(e){return{hours:Math.floor(e/3600),minutes:Math.floor(e%3600/60)}}function asyncGeneratorStep$F(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$F(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$F(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$F(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function hasAuthorization(e){return void 0===e&&(e=Bi&&Bi.storekit),void 0!==e&&e.hasAuthorized&&e.userTokenIsValid}function hasMusicSubscription(e){return _hasMusicSubscription.apply(this,arguments)}function _hasMusicSubscription(){return(_hasMusicSubscription=_async_to_generator$F((function*(e){return void 0===e&&(e=Bi&&Bi.storekit),e.hasMusicSubscription()}))).apply(this,arguments)}function _define_property$U(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function transform$9(e){return function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$U(e,n,d[n])}))}return e}({attributes:{}},transform$b({id:"metadata.itemId",type:"metadata.itemType","attributes.contentRating":function(){var n;if(1===(null==e||null===(n=e.metadata)||void 0===n?void 0:n.isExplicit))return"explicit"},"attributes.playParams":function(){var n,d,p;return 0!==(null==e||null===(n=e.metadata)||void 0===n?void 0:n.isPlayable)&&{id:null==e||null===(d=e.metadata)||void 0===d?void 0:d.itemId,kind:null==e||null===(p=e.metadata)||void 0===p?void 0:p.itemType}},"container.id":"metadata.containerId","container.name":"metadata.containerName","container.type":"metadata.containerType"},e))}function _define_property$T(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$B(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$T(e,n,d[n])}))}return e}function _object_spread_props$p(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const Vi={condition:()=>!0,toOptions:(e,n,d)=>[_object_spread_props$p(_object_spread$B({},e),{context:d})]};function _define_property$S(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$A(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$S(e,n,d[n])}))}return e}function _object_spread_props$o(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const Gi={condition:e=>{var n;return"stations"===e.type&&(null===(n=e.attributes)||void 0===n?void 0:n.isLive)},toOptions:(e,n,d)=>[_object_spread_props$o(_object_spread$A({},e),{context:d,container:{attributes:e.attributes,id:e.id,type:e.type,name:null==d?void 0:d.featureName}})]};function _define_property$R(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$z(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$R(e,n,d[n])}))}return e}function _object_spread_props$n(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const qi={condition:function(e){var n,d,p,h;return"stations"===e.type&&"streaming"===(null===(n=e.attributes)||void 0===n?void 0:n.kind)&&"episode"===(null===(p=e.attributes)||void 0===p||null===(d=p.streamingRadioSubType)||void 0===d?void 0:d.toLowerCase())&&!1===(null===(h=e.attributes)||void 0===h?void 0:h.isLive)},toOptions:function(e,n,d){var p,h;return[_object_spread_props$n(_object_spread$z({},e),{context:d,container:{attributes:e.attributes,id:e.id,type:e.type,name:null==d?void 0:d.featureName,stationHash:null===(h=e.attributes)||void 0===h||null===(p=h.playParams)||void 0===p?void 0:p.stationHash}})]}},hasRelationship=e=>n=>{var d,p;return!!(null===(p=n.relationships)||void 0===p||null===(d=p[e])||void 0===d?void 0:d.data)},typeIs=(...e)=>({type:n})=>e.includes(n),withBagPrefix=e=>{if(void 0===e||""===e)return;const{prefix:n}=Fi;return n?`${n}:${e}`:e};function _define_property$Q(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$m(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const getContainerName$1=(e,n)=>{var d,p;return null!==(p=null!=n?n:null==e||null===(d=e.container)||void 0===d?void 0:d.name)&&void 0!==p?p:st.SONG},Hi={toOptions:(e,n,d)=>{const p=_object_spread_props$m(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$Q(e,n,d[n])}))}return e}({id:e.id},n),{name:withBagPrefix(getContainerName$1(e,null==d?void 0:d.featureName))});return[{relationships:e.relationships,attributes:e.attributes,id:e.id,type:e.type,container:p,context:d}]},condition:typeIs("songs","library-songs","music-videos")};function _define_property$P(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$x(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$P(e,n,d[n])}))}return e}function _object_spread_props$l(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const parseAssets=({type:e,attributes:{assetTokens:n}})=>e.includes("udio")?(e=>{if(void 0===e)return;const[n]=Object.keys(e);return e[n]})(n):(e=>{if(void 0===e)return;const n=Object.keys(e);return e[n[n.length-1]]})(n),zi={condition:typeIs("uploaded-audios","uploadedAudio","uploaded-videos","uploadedVideo"),toOptions:(e,n,d)=>{var p,h;const y=_object_spread_props$l(_object_spread$x({},e),{context:d,attributes:_object_spread_props$l(_object_spread$x({},e.attributes),{assetUrl:parseAssets(e),playParams:null!==(h=null==e||null===(p=e.attributes)||void 0===p?void 0:p.playParams)&&void 0!==h?h:{id:e.id,kind:e.type}})});return void 0!==n&&(y.container=n),void 0!==(null==d?void 0:d.featureName)&&(y.container=_object_spread_props$l(_object_spread$x({},y.container),{name:null==d?void 0:d.featureName})),[y]}};function _define_property$O(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$k(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const Yi={toOptions:function(e,n,d){return e.relationships.episodes.data.map(e=>_object_spread_props$k(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$O(e,n,d[n])}))}return e}({},e),{context:d}))},condition:hasRelationship("episodes"),requiredRelationships:["episodes"]};function asyncGeneratorStep$E(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$E(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$E(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$E(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$N(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$v(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$N(e,n,d[n])}))}return e}function formatRatingsContentType(e,n){return isLibraryType(n)&&k(n)?e.replace(/^library-/,""):isLibraryType(n)&&!/^library-/.test(e)?"library-"+e:e}function normalizeAdamId(e){return e.replace(/^a\./,"")}function makeRequest(e,n,d){return _makeRequest.apply(this,arguments)}function _makeRequest(){return(_makeRequest=_async_to_generator$E((function*(e,n,d,p={}){let h,y=n;const _=d&&d.ids;p=_object_spread$v({},p);const{shouldCacheResults:m=!0,returnRawJSONApiRecords:g=!1,includePagination:b=e.defaultIncludePaginationMetadata,includeResponseMeta:P=!1}=p;delete p.shouldCacheResults,delete p.returnRawJSONApiRecords,delete p.includePagination,delete p.includeResponseMeta,"string"==typeof _&&(y=`${n}/${encodeURIComponent(_)}`,d&&delete d.ids);try{(b||P)&&(p.useRawResponse=!0),h=yield e.request(y,d,p)}catch(S){return"status"in S?404===S.status?Promise.reject(new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"The requested content is not available.")):Promise.reject(MKError.responseError(S)):Promise.reject(MKError.internalError(S))}try{const n=h.results||h.data||h;if("object"==typeof h&&"results"in h&&"meta"in h&&(n.meta=h.meta),0===n.length)return Promise.reject(new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"The requested content is not available."));const y=g?n:e.parseResultData(m,n);if(!b&&!P)return y;if("results"in h){for(const n in h.results)"meta"!==n&&(y[n]=paginateResultSet(h.results[n],y[n],e,d,p));return y}return paginateResultSet(h,y,e,d,p)}catch(he){return Promise.reject(MKError.parseError(he))}}))).apply(this,arguments)}function paginateResultSet(e,n,d,p,h={}){let y,_;h.includePagination=!0;const m=_object_spread$v({},h);delete m.offset,e.next&&(y=()=>makeRequest(d,formatPaginatedUrl(d.url,e.next),p,m)),e.previous&&(_=()=>makeRequest(d,formatPaginatedUrl(d.url,e.previous),p,m));return{data:n,next:y,previous:_,meta:e.meta}}function mapRequestResult(e,n){return"data"in e?(e.data=n(e.data),e):n(e)}function formatPaginatedUrl(e,n){if("function"!=typeof URL)throw new Error("formatPaginatedUrl requires an implementation of URL");const{pathname:d}=new URL(e),p=new RegExp(`^${d}/`);return n.replace(p,"")}const getFeatureName=(e,n)=>{if(n)return n;const d=function(e=[]){return 0!==e.length&&e.filter(({attributes:e})=>!!e&&(e.workName||e.movementName||e.movementCount||e.movementNumber)).length>0}(e.relationships.tracks.data);return"albums"===e.type||"library-albums"===e.type?d?st.ALBUM_CLASSICAL:st.ALBUM:"playlists"===e.type||"library-playlists"===e.type?d?st.PLAYLIST_CLASSICAL:st.PLAYLIST:void 0};function _define_property$M(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$u(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$M(e,n,d[n])}))}return e}function _object_spread_props$j(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const Wi=[{toOptions:(e,n,d)=>{const p={attributes:e.attributes,id:e.id,type:e.type,name:withBagPrefix(getFeatureName(e,null==d?void 0:d.featureName))};return e.relationships.tracks.data.map(e=>({attributes:e.attributes,id:e.id,type:e.type,container:p,context:d}))},condition:hasRelationship("tracks"),requiredRelationships:["tracks"]},Yi,Hi,Gi,qi,zi,{condition:typeIs("music-movies"),toOptions:(e,n,d)=>{var p,h;const y=_object_spread_props$j(_object_spread$u({},e),{context:d,attributes:_object_spread_props$j(_object_spread$u({},e.attributes),{playParams:null!==(h=null==e||null===(p=e.attributes)||void 0===p?void 0:p.playParams)&&void 0!==h?h:{id:e.id,kind:"musicMovie"},offers:void 0})});return void 0!==n&&(y.container=n),void 0!==(null==d?void 0:d.featureName)&&(y.container=_object_spread_props$j(_object_spread$u({},y.container),{name:null==d?void 0:d.featureName})),[y]}}],transform=(e,n,d={})=>{var p,h,y;n=null!==(h=null==n||null===(p=n.serialize)||void 0===p?void 0:p.call(n).data)&&void 0!==h?h:n;return(null!==(y=Wi.find(p=>p.condition(e,n,d)))&&void 0!==y?y:Vi).toOptions(e,n,d).map(e=>new MediaItem(e))},Qi=Wi.reduce((e,n)=>{const d=n.requiredRelationships;return d&&e.push(...d),e},[]),Ji=new Set(Qi),isArrayOf=(e,n)=>Array.isArray(e)&&(0===e.length||n(e[0])),isMediaAPIResource$1=e=>e&&void 0!==e.id&&void 0!==e.type,isMediaItem=e=>e&&void 0!==e.id,isMPMediaItem=e=>e&&void 0!==e.contentId&&void 0!==e.metadata&&void 0!==e.metadata.itemId&&void 0!==e.metadata.itemType,isQueueLoaded=e=>e&&e.loaded;function _define_property$L(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const Xi=tt.linkChild(new Logger$1("queue")),descriptorToMediaItems=e=>{if(!(e=>e&&e.items&&Array.isArray(e.items))(e)&&!isQueueLoaded(e))return[];const n=isQueueLoaded(e)?loadedDescriptorToMediaItem(e):unloadedDescriptorToMediaItem(e);return n.forEach(n=>n.context=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$L(e,n,d[n])}))}return e}({},e.context,n.context)),n},unloadedDescriptorToMediaItem=({items:e})=>isArrayOf(e,isMPMediaItem)?e.map(e=>new MediaItem(transform$9(e))):isArrayOf(e,isMediaItem)?e.map(e=>new MediaItem(e)):[],loadedDescriptorToMediaItem=e=>{const n=[],{loaded:d,container:p,context:h}=e;return void 0===d?[]:isArrayOf(d,isDataRecord)?(d.forEach(e=>{n.push(...dataRecordToMediaItems(e,p,h))}),n):isArrayOf(d,isMediaAPIResource$1)?(d.forEach(e=>{n.push(...resourceToMediaItem(e,p,h))}),n):isDataRecord(d)?dataRecordToMediaItems(d,p,h):isMediaAPIResource$1(d)?resourceToMediaItem(d,p,h):[]},dataRecordToMediaItems=(e,n,d={})=>{const{data:p}=e.serialize(!0,void 0,{includeRelationships:Ji,allowFullDuplicateSerializations:!0});return resourceToMediaItem(p,n,d)},resourceToMediaItem=(e,n,d={})=>(Xi.trace("resourceToMediaItem()",e),transform(e,n,d));function _define_property$K(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}tt.createChild("queue");class QueueItem{restrict(){return this.item.restrict()}constructor(e,n){var d;_define_property$K(this,"isAutoplay",!1),_define_property$K(this,"item",void 0),this.item=e,this.isAutoplay=null!==(d=null==n?void 0:n.isAutoplay)&&void 0!==d&&d}}function toQueueItems(e,n){return e.map(e=>new QueueItem(e,n))}function toMediaItems(e){return e.map(e=>e.item)}const{queueItemsDidChange:Zi,queuePositionDidChange:eo}=Oi;class Queue{get isEmpty(){return 0===this.length}set isRestricted(e){var n;this._isRestricted=e;const d=null===(n=this.currentItem)||void 0===n?void 0:n.id;this._isRestricted&&!this.isEmpty&&(this.removeQueueItems(e=>e.item.isExplicitItem),this.isEmpty&&this._dispatcher.publish(Oi.mediaPlaybackError,new MKError(MKError.Reason.CONTENT_RESTRICTED,"Content restricted")),d&&(this.position=this._getStartItemPosition(d)))}get isRestricted(){return this._isRestricted}get appendTargetIndex(){let e=this.length;const n=this._queueItems.findIndex(e=>e.isAutoplay);return-1!==n&&this.position<n&&(e=n),e}get items(){return toMediaItems(this._queueItems)}get autoplayItems(){return toMediaItems(this._queueItems.filter(e=>e.isAutoplay))}get unplayedAutoplayItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>e.isAutoplay))}get userAddedItems(){return toMediaItems(this._queueItems.filter(e=>!e.isAutoplay))}get unplayedUserItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>!e.isAutoplay))}get playableItems(){return toMediaItems(this._queueItems.filter(e=>canPlay(e.item,this.playbackMode)))}get unplayedPlayableItems(){return toMediaItems(this._unplayedQueueItems.filter(e=>canPlay(e.item,this.playbackMode)))}get length(){return this._queueItems.length}get nextPlayableItem(){if(-1!==this.nextPlayableItemIndex)return this.item(this.nextPlayableItemIndex)}get nextPlayableItemIndex(){return this._nextPlayableItemIndex=this.findPlayableIndexForward(),this._nextPlayableItemIndex}get position(){return this._position}set position(e){this._updatePosition(e)}get isInitiated(){return this.position>=0}get previousPlayableItem(){if(-1!==this.previousPlayableItemIndex)return this.item(this.previousPlayableItemIndex)}get previousPlayableItemIndex(){return this.findPlayableIndexBackward()}removeQueueItems(e){for(let n=this.length-1;n>=0;n--)e(this.queueItem(n),n)&&this.spliceQueueItems(n,1)}indexForItem(e){return("string"==typeof e?this._itemIDs:this.items).indexOf(e)}item(e){var n;return null===(n=this.queueItem(e))||void 0===n?void 0:n.item}get currentItem(){return this.item(this.position)}queueItem(e){var n;return null===(n=this._queueItems)||void 0===n?void 0:n[e]}updateItems(e){this._queueItems=toQueueItems(e),this._reindex(),this._dispatcher.publish(Oi.queueItemsDidChange,this.items)}get currentQueueItem(){return this.queueItem(this.position)}remove(e){if(deprecationWarning("remove",{message:"The queue remove function has been deprecated"}),e===this.position)throw new MKError(MKError.Reason.INVALID_ARGUMENTS);this.splice(e,1)}append(e=[]){return this.appendQueueItems(toQueueItems(e))}appendQueueItems(e=[]){this.spliceQueueItems(this.appendTargetIndex,0,e)}splice(e,n,d=[]){return toMediaItems(this.spliceQueueItems(e,n,toQueueItems(d)))}spliceQueueItems(e,n,d=[],p=!0){d=d.filter(e=>isPlayable(null==e?void 0:e.item,this.playbackMode));const h=this._queueItems.splice(e,n,...d);return this._itemIDs.splice(e,n,...d.map(e=>e.item.id)),p&&(this._dispatcher.publish(ot.queueModified,{start:e,added:toMediaItems(d),removed:toMediaItems(h)}),this._dispatcher.publish(Zi,this.items)),h}clearAfterCurrent(){if(-1===this.position)this.clear();else if(this.length>0&&this.position+1<this.length){const e=this.position+1;this.splice(e,this.length)}}clear(){this.length>0&&(this.splice(0,this.length),this.reset())}reset(){const e=this.position;this._position=-1,e>=0&&this._dispatcher.publish(eo,{oldPosition:e,position:this.position})}_isSameItems(e){if(e.length!==this.length)return!1;const n=e.map(e=>e.id).sort(),d=[...this._itemIDs].sort();let p,h;try{p=JSON.stringify(n),h=JSON.stringify(d)}catch(St){return!1}return p===h}_reindex(){this._queueItems&&(this._itemIDs=this._queueItems.map(e=>e.item.id))}_updatePosition(e){if(e===this._position)return;const n=this._position;this._position=e;const d=this.item(e);d&&canPlay(d,this.playbackMode)||(this._position=this.findPlayableIndexForward(e)),this._position!==n&&this._dispatcher.publish(eo,{oldPosition:n,position:this._position})}findPlayableIndexForward(e=this.position){var n;if(this.isEmpty)return-1;if(this.isInitiated&&!indexInBounds([0,this.position],e))return-1;const d=null===(n=this.repeatable)||void 0===n?void 0:n.repeatMode;if(e<this.length)for(let p=e+1;p<this.length;p++){if(canPlay(this.item(p),this.playbackMode))return p}if(d===Li.all)for(let p=0;p<=e;p++){if(canPlay(this.item(p),this.playbackMode))return p}return-1}findPlayableIndexBackward(e=this.position){var n;if(this.isEmpty)return-1;if(!indexInBounds([0,this.position],e))return-1;const d=null===(n=this.repeatable)||void 0===n?void 0:n.repeatMode;if(e>0)for(let p=e-1;p>=0;p--){if(canPlay(this.item(p),this.playbackMode))return p}if(d===Li.all)for(let p=this.length-1;p>=e;p--){if(canPlay(this.item(p),this.playbackMode))return p}return-1}get _unplayedQueueItems(){const e=this.position<0?0:this.position;return this._queueItems.slice(e)}_getStartItemPosition(e){if(void 0===e)return-1;if("object"==typeof e&&"id"in e&&(e=e.id),"string"==typeof e)return this.indexForItem(e);const n=parseInt(""+e,10);return n>=0&&n<this.length?n:-1}constructor(e){if(_define_property$K(this,"repeatable",void 0),_define_property$K(this,"hasAutoplayStation",!1),_define_property$K(this,"playbackMode",wi.MIXED_CONTENT),_define_property$K(this,"_itemIDs",[]),_define_property$K(this,"_queueItems",[]),_define_property$K(this,"_isRestricted",!1),_define_property$K(this,"_nextPlayableItemIndex",-1),_define_property$K(this,"_position",-1),_define_property$K(this,"_dispatcher",void 0),this._dispatcher=e.services.dispatcher,this.playbackMode=e.playbackMode,!e.descriptor)return;const n=descriptorToMediaItems(e.descriptor).filter(e=>isPlayable(e,this.playbackMode));this._queueItems=toQueueItems(n),this._reindex(),void 0!==e.descriptor.startWith&&(this.position=this._getStartItemPosition(e.descriptor.startWith))}}function isPlayable(e,n){return e.isPlayable||n!==wi.FULL_PLAYBACK_ONLY&&void 0!==e.previewURL}function canPlay(e,n){return isPlayable(e,n)&&!function(e){return e.isRestricted}(e)&&!function(e){return e.isUnavailable}(e)}function indexInBounds(e,n){return e[0]<=n&&n<=e[1]}function _define_property$J(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const to=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$J(e,n,d[n])}))}return e}({},{NEXT_ITEM:"NEXT"},lt);function asyncGeneratorStep$D(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$D(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$D(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$D(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$I(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const ro=["EditorialVideoClip","uploaded-videos","uploadedVideo","musicVideo"],no=function(){var e=_async_to_generator$D((function*(){}));return function(){return e.apply(this,arguments)}}();class BaseSeekable{getSeekSeconds(e){return{BACK:0,FORWARD:0}}seekBackward(e=no){Qe.warn("seekBackward is not supported in this playback method")}seekForward(e=no){Qe.warn("seekForward is not supported in this playback method")}seekToTime(e,n){return _async_to_generator$D((function*(){Qe.warn("seekToTime is not supported in this playback method")}))()}constructor(e){_define_property$I(this,"mediaItemPlayback",void 0),_define_property$I(this,"canSeek",void 0),this.mediaItemPlayback=e,this.canSeek=!1}}class Seekable{getSeekSeconds(e){return(e=>(null==e?void 0:e.isUTS)||ro.includes(null==e?void 0:e.type)?{FORWARD:10,BACK:10}:(null==e?void 0:e.isAOD)?{FORWARD:30,BACK:30}:{FORWARD:30,BACK:15})(e)}seekBackward(e=this._seekToBeginning){var n=this;return _async_to_generator$D((function*(){if(void 0===n.mediaItemPlayback.nowPlayingItem)return void Qe.warn("Cannot seekBackward when nowPlayingItem is not yet set.");const d=n.mediaItemPlayback.currentPlaybackTime-n.getSeekSeconds(n.mediaItemPlayback.nowPlayingItem).BACK;d<0?yield e.call(n):yield n.seekToTime(d,ut.Interval)}))()}seekForward(e=this._seekToEnd){var n=this;return _async_to_generator$D((function*(){if(void 0===n.mediaItemPlayback.nowPlayingItem)return void Qe.warn("Cannot seekForward when nowPlayingItem is not yet set.");const d=n.mediaItemPlayback.currentPlaybackTime+n.getSeekSeconds(n.mediaItemPlayback.nowPlayingItem).FORWARD;d>n.mediaItemPlayback.currentPlaybackDuration?yield e.call(n):yield n.seekToTime(d,ut.Interval)}))()}seekToTime(e,n=ut.Manual){var d=this;return _async_to_generator$D((function*(){if(void 0===d.mediaItemPlayback.nowPlayingItem)return void Qe.warn("Cannot seekToTime when nowPlayingItem is not yet set.");const p=d.mediaItemPlayback.nowPlayingItem,h=d.mediaItemPlayback.currentPlaybackTime,y=d.mediaItemPlayback.currentPlayingDate,_=Math.min(Math.max(0,e),d.mediaItemPlayback.currentPlaybackDuration);let m;if(p.isLinearStream&&void 0!==y){const e=1e3*(_-h);m=new Date(y.getTime()+e)}yield d.mediaItemPlayback.seekToTime(_,n),d._dispatcher.publish(ot.playbackSeek,{item:p,startPosition:h,position:_,playingDate:m,startPlayingDate:y,seekReasonType:n})}))()}_seekToBeginning(){var e=this;return _async_to_generator$D((function*(){yield e.seekToTime(0,ut.Interval)}))()}_seekToEnd(){var e=this;return _async_to_generator$D((function*(){yield e.seekToTime(e.mediaItemPlayback.currentPlaybackDuration,ut.Interval)}))()}constructor(e,n){_define_property$I(this,"_dispatcher",void 0),_define_property$I(this,"mediaItemPlayback",void 0),_define_property$I(this,"canSeek",void 0),this._dispatcher=e,this.mediaItemPlayback=n,this.canSeek=!0}}const shuffleCollection=e=>{const n=[...e],{length:d}=n;for(let p=0;p<d;++p){const e=p+Math.floor(Math.random()*(d-p)),h=n[e];n[e]=n[p],n[p]=h}return n};function _define_property$H(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$h(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}var io=function(e){return e[e.off=0]="off",e[e.songs=1]="songs",e}({});const oo="Shuffling is not supported in this playback method.";class BaseShuffler{set shuffle(e){Qe.warn(oo)}get shuffleMode(){return 0}set shuffleMode(e){Qe.warn(oo)}checkAndReshuffle(e){Qe.warn(oo)}constructor(){_define_property$H(this,"canSetShuffleMode",!1),_define_property$H(this,"queue",void 0)}}class Shuffler{get queue(){return this._queue}set queue(e){this._queue=e,this._unshuffledIDs=e.userAddedItems.map(e=>e.id),this.checkAndReshuffle(!1)}queueModifiedHandler(e,n){if(this._isSpliceFromShuffle)return void(this._isSpliceFromShuffle=!1);const{start:d,added:p,removed:h}=n;if(h.length>0){const e=h.map(e=>e.id);this._unshuffledIDs=this._unshuffledIDs.filter(n=>!e.includes(n))}p.length>0&&this._unshuffledIDs.splice(d,0,...p.map(e=>e.id))}set shuffle(e){this.shuffleMode=e?1:0}get shuffleMode(){return this.mode}set shuffleMode(e){e!==this.shuffleMode&&e in io&&(Qe.debug(`mk: set shuffleMode from ${this.shuffleMode} to ${e}`),this.mode=e,1===this.mode?this.shuffleQueue():this.unshuffleQueue(),this.controller.nowPlayingItem&&(this._queue.position=this._queue.indexForItem(this.controller.nowPlayingItem.id)),this.dispatcher.publish(Oi.shuffleModeDidChange,this.shuffleMode))}checkAndReshuffle(e=!1){1===this.shuffleMode&&this.shuffleQueue(e)}shuffleQueue(e=!0){const{userAddedItems:n}=this._queue;if(n.length<=1)return n;const d=n.slice(0),p=this._queue.position>-1?d.splice(this._queue.position,1):[];let h=[];do{h=shuffleCollection(d)}while(d.length>1&&arrayEquals(h,d));const y=[...p,...h];this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,y.length,toQueueItems(y),e)}unshuffleQueue(e=!0){let n=[];const d=this._unshuffledIDs.reduce((e,n,d)=>(e[n]=d,e),{}),p=[];let h=0;const y=this._queue.item(this._queue.position);this._queue.userAddedItems.forEach(e=>{const _=d[e.id];void 0===_&&p.push(e),n[_]=e,e.id===(null==y?void 0:y.id)&&(h=_)}),n=n.filter(Boolean);const _=n.concat(p);this._isSpliceFromShuffle=!0,this._queue.spliceQueueItems(0,_.length,toQueueItems(_),e),this._queue.position=h}constructor(e,{dispatcher:n}){_define_property$H(this,"controller",void 0),_define_property$H(this,"canSetShuffleMode",void 0),_define_property$H(this,"dispatcher",void 0),_define_property$H(this,"mode",void 0),_define_property$H(this,"_queue",void 0),_define_property$H(this,"_unshuffledIDs",void 0),_define_property$H(this,"_isSpliceFromShuffle",void 0),this.controller=e,this.canSetShuffleMode=!0,this.mode=0,this._unshuffledIDs=[],this._isSpliceFromShuffle=!1,this.dispatcher=n,this.dispatcher.subscribe(ot.queueModified,this.queueModifiedHandler),this._queue=e.queue}}function asyncGeneratorStep$C(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$C(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$C(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$C(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$G(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$r(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$G(e,n,d[n])}))}return e}function _ts_metadata$g(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$h("design:type",Function),_ts_metadata$h("design:paramtypes",[String,Object]),_ts_metadata$h("design:returntype",void 0)],Shuffler.prototype,"queueModifiedHandler",null);var ao=function(e){return e.continuous="continuous",e.serial="serial",e}({});const{queueItemsDidChange:so}=Oi;class PlaybackController{get isActive(){return this._isActive}get isDestroyed(){return this._isDestroyed}updateAutoplay(e,n){this.autoplayEnabled=n}constructContext(e,n){let d=null==e?void 0:e.context;var p;return void 0!==(null==e?void 0:e.featureName)&&void 0===(null==d?void 0:d.featureName)&&(Qe.warn("featureName is deprecated, pass it inside context"),d||(d={}),d.featureName=e.featureName),null!==(p=null!=d?d:n)&&void 0!==p?p:{}}get context(){return this._context}get shuffler(){return this._shuffler}get continuous(){return this._continuous||this.hasAuthorization}set continuous(e){this._continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this._autoplayEnabled=e}get previewOnly(){return this._mediaItemPlayback.previewOnly}get _dispatcher(){return this._services.dispatcher}get hasAuthorization(){return hasAuthorization(this.storekit)}get isPlaying(){return this._mediaItemPlayback.isPlaying}get isPrimaryPlayer(){return this._mediaItemPlayback.isPrimaryPlayer}set isPrimaryPlayer(e){this._mediaItemPlayback.isPrimaryPlayer=e}get isReady(){return this._mediaItemPlayback.isReady}get _mediaItemPlayback(){return this._services.mediaItemPlayback}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get nowPlayingItemIndex(){return this.queue?this.queue.position:-1}get playbackMode(){return this._playbackMode}set playbackMode(e){this._playbackMode=e,this.queue&&(this.queue.playbackMode=e)}get queue(){return this._queue}set queue(e){this.setQueue(e)}get repeatMode(){return this._repeatable.repeatMode}set repeatMode(e){this._repeatable.repeatMode=e}get seekSeconds(){const{nowPlayingItem:e}=this;if(void 0!==e)return this._seekable.getSeekSeconds(e)}set shuffle(e){this._shuffler.shuffle=e}get shuffleMode(){return this._shuffler.shuffleMode}set shuffleMode(e){this._shuffler.shuffleMode=e}get storekit(){return this._storekit}set storekit(e){if(e){var n=this;e.addEventListener(Ge.authorizationStatusWillChange,function(){var e=_async_to_generator$C((function*({authorizationStatus:e,newAuthorizationStatus:d}){e>je.DENIED&&d<je.RESTRICTED?yield n.stop({endReasonType:lt.PLAYBACK_SUSPENDED,userInitiated:!1}):yield n.stop({userInitiated:!1})}));return function(n){return e.apply(this,arguments)}}()),this._storekit=e}}changeToMediaAtIndex(e=0){var n=this;return _async_to_generator$C((function*(){var d,p,h,y;yield n.stop();const _=null===(d=n.queue.item(e))||void 0===d?void 0:d.id,m=null===(h=n._mediaItemPlayback)||void 0===h||null===(p=h.playOptions)||void 0===p?void 0:p.get(_);let g=(null==m?void 0:m.startTime)||0;var b;n._dispatcher.publish(Oi.playInitiated,{item:n.queue.item(e),timestamp:null!==(b=null==m||null===(y=m.meta)||void 0===y?void 0:y.initiatedTimestamp)&&void 0!==b?b:Date.now()});const P=yield n._changeToMediaAtIndex(e,{userInitiated:!0});P&&(P.id!==_&&(g=0),n._dispatcher.publish(ot.playbackPlay,{item:P,position:g,playingDate:n._mediaItemPlayback.currentPlayingDate,userInitiated:!0}))}))()}changeToMediaItem(e){var n=this;return _async_to_generator$C((function*(){const d=n.queue.indexForItem(e);return-1===d?Promise.reject(new MKError(MKError.Reason.MEDIA_DESCRIPTOR)):n.changeToMediaAtIndex(d)}))()}activate(){var e=this;return _async_to_generator$C((function*(){Qe.debug("PlaybackController.activate()"),e._isActive=!0,e._dispatcher.unsubscribe(Oi.playbackStateDidChange,e.onPlaybackStateDidChange),e._dispatcher.subscribe(Oi.playbackStateDidChange,e.onPlaybackStateDidChange),e._skipIntro.activate(),e._upNext.activate(),e._rollMonitor.activate()}))()}deactivate(){var e=this;return _async_to_generator$C((function*(){Qe.debug("PlaybackController.deactivate()"),e._isActive=!1,yield e.stop(),e._dispatcher.unsubscribe(Oi.playbackStateDidChange,e.onPlaybackStateDidChange),e._skipIntro.deactivate(),e._upNext.deactivate(),e._rollMonitor.deactivate()}))()}destroy(){var e=this;return _async_to_generator$C((function*(){e._isDestroyed=!0,yield e.deactivate(),e._dispatcher.unsubscribe(Oi.autoplayEnabledDidChange,e.updateAutoplay)}))()}pause(e){var n=this;return _async_to_generator$C((function*(){return n._mediaItemPlayback.pause(e)}))()}play(){var e=this;return _async_to_generator$C((function*(){if(e.nowPlayingItem)return e._mediaItemPlayback.play();if(!e._queue||e._queue.isEmpty)return;if(e.nowPlayingItemIndex>=0)return e.changeToMediaAtIndex(e.nowPlayingItemIndex);const{queue:n}=e;return-1!==n.nextPlayableItemIndex?e.changeToMediaAtIndex(n.nextPlayableItemIndex):void 0}))()}playSingleMediaItem(e,n){var d=this;return _async_to_generator$C((function*(){e.isUTS&&(yield Ni(e,{manifestManager:d._services.manifest,playOptions:n})),d._dispatcher.publish(Oi.queueItemsDidChange,[e]);const p=yield d._mediaItemPlayback.startMediaItemPlayback(e,!0);if(p){var h;const e={item:p,position:null!==(h=d._mediaItemPlayback.currentPlaybackTime)&&void 0!==h?h:0,playingDate:d._mediaItemPlayback.currentPlayingDate,userInitiated:!0};Qe.debug("playSingleMediaItem: Dispatching DispatchTypes.playbackPlay event",e),d._dispatcher.publish(ot.playbackPlay,e)}}))()}onPlaybackStateDidChange(e,n){var d=this;return _async_to_generator$C((function*(){n.state===be.ended&&(d.continuous||d.repeatMode===Li.one)&&(Qe.debug("controller detected track ended event, moving to next item."),d._dispatcher.publish(ot.applicationActivityIntent,{endReasonType:lt.TRACK_SKIPPED_FORWARDS,userInitiated:!1}),yield d._next())}))()}preload(){var e=this;return _async_to_generator$C((function*(){return e._mediaItemPlayback.preload()}))()}showPlaybackTargetPicker(){this._mediaItemPlayback.showPlaybackTargetPicker()}seekBackward(){var e=this;return _async_to_generator$C((function*(){return e._seekable.seekBackward()}))()}seekForward(){var e=this;return _async_to_generator$C((function*(){return e._seekable.seekForward(e.skipToNextItem.bind(e))}))()}skipToNextItem(){var e=this;return _async_to_generator$C((function*(){return e._next({userInitiated:!0})}))()}skipToPreviousItem(){var e=this;return _async_to_generator$C((function*(){return e._previous({userInitiated:!0})}))()}getNewSeeker(){return this._mediaItemPlayback.getNewSeeker()}seekToTime(e,n){var d=this;return _async_to_generator$C((function*(){yield d._seekable.seekToTime(e,n)}))()}replaceQueue(e,n){var d=this;return _async_to_generator$C((function*(){var p;if(yield d.extractGlobalValues(n),yield d._mediaItemPlayback.stop(),void 0!==(null==n?void 0:n.context)&&(d._context=n.context),d.setQueue(new Queue({services:{runtime:d._services.runtime,request:d._services.request,dispatcher:d._services.dispatcher},descriptor:{loaded:e,context:d.context,startWith:null!==(p=null==n?void 0:n.startWith)&&void 0!==p?p:null==n?void 0:n.startPosition},playbackMode:d.playbackMode})),0===e.length)throw Qe.warn("No items (0) are playable for new queue"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No playable items for queue");if(void 0!==(null==n?void 0:n.shuffleMode)&&(d.shuffleMode=n.shuffleMode),void 0!==(null==n?void 0:n.repeatMode)&&(d.repeatMode=n.repeatMode),function(e){return"number"==typeof e&&!Number.isNaN(e)}(null==n?void 0:n.startTime)){const e=d.queue.nextPlayableItem;e&&d._mediaItemPlayback.playOptions.set(e.id,{startTime:null==n?void 0:n.startTime})}return d._dispatcher.publish("queue.created",d.queue),d._dispatcher.publish("queue.ready",d.queue),d._dispatcher.publish(Oi.queueIsReady,d.queue.items),d.queue}))()}extractGlobalValues(e){var n=this;return _async_to_generator$C((function*(){n._context=n.constructContext(e),void 0!==(null==e?void 0:e.featureName)&&e.context&&(Qe.warn("featureName is deprecated, pass it inside context"),e.context.featureName=e.featureName)}))()}stop(e){var n=this;return _async_to_generator$C((function*(){yield n._mediaItemPlayback.stop(e)}))()}_changeToMediaAtIndex(e=0,n={}){var d=this;return _async_to_generator$C((function*(){if(d.queue.isEmpty)return;d.queue.position=e;const p=d.queue.item(d.queue.position);if(!p)return;var h;const y=yield d._mediaItemPlayback.startMediaItemPlayback(p,null!==(h=n.userInitiated)&&void 0!==h&&h);if(y||p.state!==oe.unsupported)return y;yield d.skipToNextItem()}))()}_next(e={}){var n=this;return _async_to_generator$C((function*(){if(n.queue.isEmpty)return;const{userInitiated:d=!1}=e;return n.repeatMode===Li.one&&void 0!==n.queue.currentItem?(yield n.stop(_object_spread$r({userInitiated:d},e)),void(yield n.play())):(!d&&e.seamlessAudioTransition&&(n._dispatcher.publish(ot.playbackStop,_object_spread$r({userInitiated:d,endReasonType:lt.NATURAL_END_OF_TRACK},e)),e={userInitiated:e.userInitiated,seamlessAudioTransition:!0}),n._nextAtIndex(n.queue.nextPlayableItemIndex,e))}))()}_nextAtIndex(e,n={}){var d=this;return _async_to_generator$C((function*(){if(d.queue.isEmpty)return;const{_mediaItemPlayback:p}=d;var h;const y=null!==(h=n.userInitiated)&&void 0!==h&&h;if(e<0)return Qe.debug("controller/index._next no next item available, stopping playback"),yield d.stop({userInitiated:y,seamlessAudioTransition:n.seamlessAudioTransition}),void(p.playbackState=be.completed);const _=d.isPlaying,m=p.currentPlaybackTime,g=yield d._changeToMediaAtIndex(e,{userInitiated:y});var b;return d._notifySkip(_,g,{userInitiated:y,seamlessAudioTransition:null!==(b=n.seamlessAudioTransition)&&void 0!==b&&b,position:m,direction:lt.TRACK_SKIPPED_FORWARDS}),g}))()}_previous(e={}){var n=this;return _async_to_generator$C((function*(){if(n.queue.isEmpty)return;const{userInitiated:d=!1}=e;if(n.repeatMode===Li.one&&void 0!==n.queue.currentItem)return yield n.stop({endReasonType:lt.TRACK_SKIPPED_BACKWARDS,userInitiated:d}),void(yield n.play());const p=n.queue.previousPlayableItemIndex;if(d&&n.repeatMode===Li.none&&void 0!==n.nowPlayingItem&&-1===p)return yield n.stop({endReasonType:lt.TRACK_SKIPPED_BACKWARDS,userInitiated:!0}),void(yield n.play());if(-1===p)return;const h=n.isPlaying,y=n._mediaItemPlayback.currentPlaybackTime,_=yield n._changeToMediaAtIndex(p,{userInitiated:d});return n._notifySkip(h,_,{userInitiated:d,seamlessAudioTransition:!1,direction:lt.TRACK_SKIPPED_BACKWARDS,position:y}),_}))()}_notifySkip(e,n,d){const{userInitiated:p,direction:h,position:y,seamlessAudioTransition:_=!1}=d,m=this._dispatcher;_?(Qe.debug("seamlessAudioTransition transition, PAF play"),m.publish(ot.playbackPlay,{item:n,position:0,endReasonType:lt.NATURAL_END_OF_TRACK})):e?n?m.publish(ot.playbackSkip,{item:n,userInitiated:p,direction:h,position:y}):m.publish(ot.playbackStop,{item:n,userInitiated:p,position:y}):n&&m.publish(ot.playbackPlay,_object_spread$r({item:n,playingDate:this._mediaItemPlayback.currentPlayingDate,position:0},p?{endReasonType:lt.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM}:{}))}setQueue(e){return Qe.trace("PlaybackController.prepareQueue()"),this.hasAuthorization&&(e.isRestricted=this.storekit.restrictedEnabled||!1),e.repeatable=this._repeatable,this._queue=e,this._shuffler.queue=this._queue,this._dispatcher.publish(so,e.items),e}constructor(e){var n;_define_property$G(this,"_continuous",void 0),_define_property$G(this,"_context",{}),_define_property$G(this,"_autoplayEnabled",void 0),_define_property$G(this,"_playerOptions",void 0),_define_property$G(this,"_queue",void 0),_define_property$G(this,"_storekit",void 0),_define_property$G(this,"_repeatable",void 0),_define_property$G(this,"_shuffler",void 0),_define_property$G(this,"_seekable",void 0),_define_property$G(this,"_services",void 0),_define_property$G(this,"_rollMonitor",void 0),_define_property$G(this,"_skipIntro",void 0),_define_property$G(this,"_upNext",void 0),_define_property$G(this,"_playbackMode",void 0),_define_property$G(this,"_isActive",!1),_define_property$G(this,"_isDestroyed",!1),this.onPlaybackStateDidChange=this.onPlaybackStateDidChange.bind(this),this._autoplayEnabled=null!==(n=null==e?void 0:e.autoplayEnabled)&&void 0!==n&&n,this._continuous=!1,this._services=e.services,this._playerOptions=e,this.storekit=e.storekit,this._skipIntro=new SkipAvailable({controller:this,services:e.services}),this._upNext=new UpNextMonitor({controller:this,services:e.services}),this._rollMonitor=new RollMonitor({controller:this,services:e.services}),this._shuffler=new BaseShuffler,this._seekable=new BaseSeekable(this._mediaItemPlayback),this._repeatable=new BaseRepeatable,this._dispatcher.subscribe(Oi.autoplayEnabledDidChange,this.updateAutoplay),this._playbackMode=e.playbackMode}}function _define_property$F(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$f(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$f(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$g("design:type",Function),_ts_metadata$g("design:paramtypes",[String,Boolean]),_ts_metadata$g("design:returntype",void 0)],PlaybackController.prototype,"updateAutoplay",null);class MediaSessionManager{onCapabilitiesChanged(){this._resetHandlers(),this._setMediaSessionHandlers()}onNowPlayingItemDidChange(e,{item:n}){this._setMediaSessionMetadata(n)}_setMediaSessionMetadata(e){var n,d;this.session&&"MediaMetadata"in window&&e&&(this.session.metadata=new window.MediaMetadata({title:e.title,artist:null!==(d=e.artistName)&&void 0!==d?d:null===(n=e.attributes)||void 0===n?void 0:n.showTitle,album:e.albumName,artwork:e.artwork?[96,128,192,256,384,512].map(n=>({src:formatArtworkURL(e.artwork,n,n),sizes:`${n}x${n}`,type:"image/jpeg"})):[]}))}_setMediaSessionHandlers(){this.session&&(this._resetHandlers(),this.session.setActionHandler("play",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.play()}),this.capabilities.canPause?this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.pause()}):this.session.setActionHandler("pause",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.stop()}),this.capabilities.canSeek&&(this.session.setActionHandler("seekforward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekForward()}),this.session.setActionHandler("seekbackward",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.seekBackward()})),this.capabilities.canSkipToNextItem&&this.session.setActionHandler("nexttrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToNextItem()}),this.capabilities.canSkipToPreviousItem&&this.session.setActionHandler("previoustrack",()=>{var e;return null===(e=this.controller)||void 0===e?void 0:e.skipToPreviousItem()}))}_resetHandlers(){this.session&&(this.session.setActionHandler("play",void 0),this.session.setActionHandler("pause",void 0),this.session.setActionHandler("seekforward",void 0),this.session.setActionHandler("seekbackward",void 0),this.session.setActionHandler("nexttrack",void 0),this.session.setActionHandler("previoustrack",void 0))}constructor(e,n){_define_property$F(this,"capabilities",void 0),_define_property$F(this,"dispatcher",void 0),_define_property$F(this,"controller",void 0),_define_property$F(this,"session",void 0),this.capabilities=e,this.dispatcher=n,this.session=navigator.mediaSession,this.session&&(this.dispatcher.subscribe(Oi.nowPlayingItemDidChange,this.onNowPlayingItemDidChange),this.dispatcher.subscribe(Oi.capabilitiesChanged,this.onCapabilitiesChanged),this._setMediaSessionHandlers())}}function _define_property$E(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[]),_ts_metadata$f("design:returntype",void 0)],MediaSessionManager.prototype,"onCapabilitiesChanged",null),_ts_decorate$f([Bind(),_ts_metadata$f("design:type",Function),_ts_metadata$f("design:paramtypes",[void 0,void 0]),_ts_metadata$f("design:returntype",void 0)],MediaSessionManager.prototype,"onNowPlayingItemDidChange",null);var co=function(e){return e[e.PAUSE=0]="PAUSE",e[e.EDIT_QUEUE=1]="EDIT_QUEUE",e[e.SEEK=2]="SEEK",e[e.REPEAT=3]="REPEAT",e[e.SHUFFLE=4]="SHUFFLE",e[e.SKIP_NEXT=5]="SKIP_NEXT",e[e.SKIP_PREVIOUS=6]="SKIP_PREVIOUS",e[e.SKIP_TO_ITEM=7]="SKIP_TO_ITEM",e[e.AUTOPLAY=8]="AUTOPLAY",e[e.VOLUME=9]="VOLUME",e}({});class Capabilities{set controller(e){this._mediaSession.controller=e}updateChecker(e){this._checkCapability!==e&&(this._checkCapability=e,this._dispatcher.publish(Oi.capabilitiesChanged))}get canEditPlaybackQueue(){return this._checkCapability(1)}get canPause(){return this._checkCapability(0)}get canSeek(){return this._checkCapability(2)}get canSetRepeatMode(){return this._checkCapability(3)}get canSetShuffleMode(){return this._checkCapability(4)}get canSkipToNextItem(){return this._checkCapability(5)}get canSkipToMediaItem(){return this._checkCapability(7)}get canSkipToPreviousItem(){return this._checkCapability(6)}get canAutoplay(){return this._checkCapability(8)}get canSetVolume(){return this._checkCapability(9)}constructor(e){_define_property$E(this,"_dispatcher",void 0),_define_property$E(this,"_checkCapability",void 0),_define_property$E(this,"_mediaSession",void 0),this._dispatcher=e,this._checkCapability=e=>9===e,this._mediaSession=new MediaSessionManager(this,e)}}function asyncGeneratorStep$B(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$B(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$B(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$B(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$D(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$e(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$e(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class ContinuousPlaybackController extends PlaybackController{get continuous(){return!0}set continuous(e){if(!0!==e)throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Continuous playback cannot be disabled for station queues.")}get isLive(){return this._isLiveStation}set isLive(e){e!==this._isLiveStation&&(this._isLiveStation=e,this._dispatcher.publish(Oi.capabilitiesChanged))}get isTracksStation(){return this._isTracksStation}set isTracksStation(e){e!==this._isTracksStation&&(this._isTracksStation=e,this._dispatcher.publish(Oi.capabilitiesChanged))}changeToMediaItem(e){return _async_to_generator$B((function*(){Qe.warn("changeToMediaItem is not supported for this type of playback")}))()}hasCapabilities(e){switch(e){case co.VOLUME:return!0;case co.PAUSE:case co.SKIP_NEXT:case co.SKIP_PREVIOUS:case co.SEEK:return!this.isLive;case co.SKIP_TO_ITEM:case co.AUTOPLAY:case co.EDIT_QUEUE:case co.SHUFFLE:case co.REPEAT:default:return!1}}pause(e){var n=this,_superprop_get_pause=()=>super.pause;return _async_to_generator$B((function*(){if(!n.isLive)return _superprop_get_pause().call(n,e);Qe.warn("pause is not supported for this type of playback")}))()}skipToPreviousItem(){var e=this,_superprop_get_skipToPreviousItem=()=>super.skipToPreviousItem;return _async_to_generator$B((function*(){if(!e.isLive)return _superprop_get_skipToPreviousItem().call(e);Qe.warn("skipToPreviousItem is not supported for this type of playback")}))()}replaceQueue(e,n){var d=this,_superprop_get_replaceQueue=()=>super.replaceQueue;return _async_to_generator$B((function*(){var p;const h=e[0];if(void 0===h)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No Queue item");if(!isRadioStation(h))throw new MKError(MKError.Reason.MEDIA_DESCRIPTOR,"Item is not a Radio Station");return d.station=h,d.isLive=!!(null==h?void 0:h.isLiveRadioStation)||!!(null==h||null===(p=h.attributes)||void 0===p?void 0:p.isLive),d.isTracksStation=isTracksRadioStation(h),d._context=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$D(e,n,d[n])}))}return e}({featureName:st.STATION},null==n?void 0:n.context),d._seekable=d.isLive?new BaseSeekable(d._mediaItemPlayback):new Seekable(d._dispatcher,d._mediaItemPlayback),d.isTracksStation?e=yield d.loadNextTracks(d.station,{context:d.context}):(e.length>1&&Qe.warn(`Attempting to play multiple Live Radio Station items (${e.length})`),e=[h]),_superprop_get_replaceQueue().call(d,e,{context:d.context})}))()}appendToQueue(e){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Appending to the Queue is not supported for this type of playback")}))()}insertInQueue(e,n){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Inserting into the Queue is not supported for this type of playback")}))()}prependToQueue(e,n){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Prepending to the Queue is not supported for this type of playback")}))()}clearQueue(){return _async_to_generator$B((function*(){throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Clearing the Queue is not supported for this type of playback")}))()}getNewSeeker(){return this.hasCapabilities(co.SEEK)?super.getNewSeeker():new UnsupportedSeeker}skipToNextItem(){var e=this,_superprop_get_skipToNextItem=()=>super.skipToNextItem;return _async_to_generator$B((function*(){if(!e.isLive)return _superprop_get_skipToNextItem().call(e);Qe.warn("Method skipToNextItem is not supported for this type of playback")}))()}loadNextTracks(e,n){var d=this;return _async_to_generator$B((function*(){if(0===(null==n?void 0:n.limit))return Qe.warn("Not loading next tracks, limit is set to zero (0)"),[];var p;Qe.debug("Loading tracks for station "+e.id);let h=yield d._services.itemLoader.loadStationNextTracks(e.id,{container:null!==(p=null==n?void 0:n.container)&&void 0!==p?p:e,context:null==n?void 0:n.context,limit:null==n?void 0:n.limit});var y;if(Qe.debug(`Loaded ${h.length} tracks for station ${e.id}`),0===h.length)throw Qe.warn("No track data is available for the current station",{stationId:null===(y=d.station)||void 0===y?void 0:y.id}),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"No track data is available for the current station.");return"number"==typeof(null==n?void 0:n.limit)&&n.limit>0&&(h=h.slice(0,n.limit)),h}))()}queueNextTracks(){var e=this;return _async_to_generator$B((function*(){if(!e.isActive)return void Qe.debug("Not loading next tracks, controller is not active");if(void 0===e.station||!e.isTracksStation)return void Qe.debug("Not loading next tracks, not a tracks radio station");if(e.queue.isEmpty)return void Qe.debug("Not loading next tracks, queue is empty");if(-1!==e.queue.nextPlayableItemIndex)return void Qe.debug("Not loading next tracks, enough playable items in queue");const n=yield e.loadNextTracks(e.station,{context:e.context,limit:1});n.length>0&&(Qe.debug(`Queueing ${n.length} ${1===n.length?"track":"tracks"}`),e.queue.append(n))}))()}activate(){var e=this,_superprop_get_activate=()=>super.activate;return _async_to_generator$B((function*(){yield _superprop_get_activate().call(e),e._dispatcher.subscribe(Oi.queuePositionDidChange,e.queueNextTracks),e.queueNextTracks()}))()}deactivate(){var e=this,_superprop_get_deactivate=()=>super.deactivate;return _async_to_generator$B((function*(){yield _superprop_get_deactivate().call(e),e._dispatcher.unsubscribe(Oi.queuePositionDidChange,e.queueNextTracks)}))()}constructor(e){super(e),_define_property$D(this,"type",ao.continuous),_define_property$D(this,"_isLiveStation",!1),_define_property$D(this,"_isTracksStation",!1),_define_property$D(this,"station",void 0),this._continuous=!0}}function asyncGeneratorStep$A(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$C(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$d(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$d(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}_ts_decorate$e([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[void 0===co?Object:co]),_ts_metadata$e("design:returntype",Boolean)],ContinuousPlaybackController.prototype,"hasCapabilities",null),_ts_decorate$e([Bind(),_ts_metadata$e("design:type",Function),_ts_metadata$e("design:paramtypes",[]),_ts_metadata$e("design:returntype",Promise)],ContinuousPlaybackController.prototype,"queueNextTracks",null);class PercentageWatcher{startMonitor(){this.dispatcher.unsubscribe(Oi.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Oi.playbackTimeDidChange,this.handleTimeChange),this.dispatcher.subscribe(Oi.playbackDurationDidChange,this.updateThreshold),this.dispatcher.subscribe(Oi.playbackTimeDidChange,this.handleTimeChange)}stopMonitor(){this.dispatcher.unsubscribe(Oi.playbackDurationDidChange,this.updateThreshold),this.dispatcher.unsubscribe(Oi.playbackTimeDidChange,this.handleTimeChange),this.threshold=-1}handleTimeChange(e,{currentPlaybackDuration:n,currentPlaybackTime:d}){var p,h=this;return(p=function*(){h.threshold<0&&h.updateThreshold(e,{duration:n}),d<h.threshold||(h.stopMonitor(),yield h.callback(d,h))},function(){var e=this,n=arguments;return new Promise((function(d,h){var y=p.apply(e,n);function _next(e){asyncGeneratorStep$A(y,d,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$A(y,d,h,_next,_throw,"throw",e)}_next(void 0)}))})()}updateThreshold(e,{duration:n}){this.threshold=n*this.percentage}constructor(e,n,d){_define_property$C(this,"dispatcher",void 0),_define_property$C(this,"callback",void 0),_define_property$C(this,"percentage",void 0),_define_property$C(this,"threshold",void 0),this.dispatcher=e,this.callback=n,this.percentage=d,this.threshold=-1}}function asyncGeneratorStep$z(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}_ts_decorate$d([Bind(),_ts_metadata$d("design:type",Function),_ts_metadata$d("design:paramtypes",[void 0,void 0]),_ts_metadata$d("design:returntype",Promise)],PercentageWatcher.prototype,"handleTimeChange",null),_ts_decorate$d([Bind(),_ts_metadata$d("design:type",Function),_ts_metadata$d("design:paramtypes",[void 0,void 0]),_ts_metadata$d("design:returntype",void 0)],PercentageWatcher.prototype,"updateThreshold",null);class Preloader extends PlaybackMonitor{handlePlaybackThreshold(){var e,n=this;return(e=function*(){yield n.playbackController.prepareToPlayNextItem()},function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$z(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$z(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}shouldMonitor(){if(!super.shouldMonitor())return!1;if(!this.playbackController.hasAuthorization||this.playbackController.previewOnly)return!1;const e=this.getNextPlayableItem(),n=void 0!==e;return this.isSeamlessAudioTransitionsEnabled?n:n&&!(null==e?void 0:e.isPreparedToPlay)}getNextPlayableItem(){return this.playbackController.queue.nextPlayableItem}constructor(e){super(e),function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"isSeamlessAudioTransitionsEnabled",!1),this.watchers=[new PercentageWatcher(this.dispatcher,this.handlePlaybackThreshold,.3)],this.isSeamlessAudioTransitionsEnabled=Fi.features["seamless-audio-transitions"]}}function asyncGeneratorStep$y(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$y(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$y(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$y(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$A(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$p(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$A(e,n,d[n])}))}return e}function _object_spread_props$i(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_decorate$c(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$c(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class SerialPlaybackController extends PlaybackController{get autoplayStation(){return this._autoplayStation}get autoplayStarted(){return void 0!==this._autoplayStation}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this._autoplayEnabled=e,!0===e?this.startAutoplay():this.stopAutoplay()}activate(){var e=this,_superprop_get_activate=()=>super.activate;return _async_to_generator$y((function*(){yield _superprop_get_activate().call(e),e._preloader.activate(),e._dispatcher.subscribe(Oi.repeatModeDidChange,e.onRepeatModeChange),e._dispatcher.subscribe(Oi.queueItemsDidChange,e.onQueueChange),e._dispatcher.subscribe(Oi.queuePositionDidChange,e.onQueueChange),e._dispatcher.subscribe(Oi.nowPlayingItemDidChange,e.onQueueChange),e._dispatcher.subscribe(jn,e.onSeamlessAudioTransition)}))()}deactivate(){var e=this,_superprop_get_deactivate=()=>super.deactivate;return _async_to_generator$y((function*(){yield _superprop_get_deactivate().call(e),e._preloader.deactivate(),e._dispatcher.unsubscribe(Oi.repeatModeDidChange,e.onRepeatModeChange),e._dispatcher.unsubscribe(Oi.queueItemsDidChange,e.onQueueChange),e._dispatcher.unsubscribe(Oi.queuePositionDidChange,e.onQueueChange),e._dispatcher.unsubscribe(Oi.nowPlayingItemDidChange,e.onQueueChange),e._dispatcher.unsubscribe(jn,e.onSeamlessAudioTransition),yield e.stopAutoplay()}))()}hasCapabilities(e){switch(e){case co.EDIT_QUEUE:case co.SKIP_NEXT:case co.SKIP_TO_ITEM:case co.AUTOPLAY:case co.VOLUME:case co.SKIP_PREVIOUS:return!0;case co.REPEAT:case co.SHUFFLE:var n,d;return!(null===(d=this.queue)||void 0===d||null===(n=d.currentQueueItem)||void 0===n?void 0:n.isAutoplay);case co.PAUSE:case co.SEEK:var p;return!(null===(p=this.nowPlayingItem)||void 0===p?void 0:p.isAssetScrubbingDisabled);default:return!1}}onSeamlessAudioTransition(e,n){var d=this;return _async_to_generator$y((function*(){Qe.trace("onSeamlessAudioTransition",n),d._next({userInitiated:!1,seamlessAudioTransition:!0,endReasonType:lt.NATURAL_END_OF_TRACK,position:n.previous.playbackDuration/1e3,isPlaying:!1})}))()}onRepeatModeChange(){var e=this;return _async_to_generator$y((function*(){e.repeatMode===Li.none?(Qe.debug("Queueing Autoplay tracks after RepeatMode change"),yield e.queueAutoplayTracks()):(Qe.debug("Removing Autoplay tracks after RepeatMode change"),e.queue.removeQueueItems((n,d)=>d>e.queue.position&&n.isAutoplay)),e.repeatMode!==Li.one&&e.prepareToPlayNextItem()}))()}onQueueChange(){var e=this;return _async_to_generator$y((function*(){e.queue.isInitiated?(e.queue.isEmpty||(yield e.queueAutoplayTracks()),e.prepareToPlayNextItem()):(e.stopAutoplay(),e.startAutoplay())}))()}prepareToPlayNextItem(){var e=this;return _async_to_generator$y((function*(){const n=e.queue.nextPlayableItem;if(n&&e.queue.currentItem!==n&&!n.isPreparedToPlay)if(e.queue.currentItem.isPreparedToPlay)try{return Qe.debug("Preparing next MediaItem: "+mediaItemLogString(n),n),e._mediaItemPlayback.prepareToPlay(n)}catch(St){Qe.debug("next item failed to prepare for playbck -",St)}else Qe.debug("Not preparing next item: current item not prepared to play");else Qe.debug("Not preparing next item: already prepared to play")}))()}appendToQueue(e){var n=this;return _async_to_generator$y((function*(){return n.queue.splice(n.queue.appendTargetIndex,0,e),n.queue}))()}insertInQueue(e,n){var d=this;return _async_to_generator$y((function*(){return d.queue.splice(n,0,e),d.queue}))()}prependToQueue(e,n){var d=this;return _async_to_generator$y((function*(){return!0===(null==n?void 0:n.clear)&&d.queue.clearAfterCurrent(),d.queue.splice(d.queue.position+1,0,e),d.queue}))()}clearQueue(){var e=this;return _async_to_generator$y((function*(){return e.queue.clear(),e.queue}))()}replaceQueue(e,n){var d=this,_superprop_get_replaceQueue=()=>super.replaceQueue;return _async_to_generator$y((function*(){const p=yield _superprop_get_replaceQueue().call(d,e,n);return yield d.stopAutoplay(),yield d.startAutoplay(),p}))()}stopAutoplay(){var e=this;return _async_to_generator$y((function*(){Qe.trace("SerialController.stopAutoplay()"),e._autoplayStation=void 0,e.queue.hasAutoplayStation=!1,Qe.debug("Removing unplayed Autoplay tracks from Queue"),e.queue.isInitiated&&e.queue.removeQueueItems((n,d)=>d>e.queue.position&&!0===n.isAutoplay)}))()}startAutoplay(){var e=this;return _async_to_generator$y((function*(){var n;if(Qe.trace("SerialController.startAutoplay()"),!e.isActive)return void Qe.debug("Not starting autoplay, not active");if(!e.autoplayEnabled)return void Qe.debug("Not starting autoplay, not enabled");if(e.repeatMode!==Li.none)return void Qe.debug("Not starting autoplay, repeat mode is on");if(void 0!==e.autoplayStation)return void Qe.debug("Autoplay station already created");if(e.loadingAutoplayStation)return void Qe.debug("Autoplay station already loading");const d=e.queue.items.slice(-e.maxTracksForAutoplayStation);if(0===d.length)return void Qe.debug("No items in queue to start Autoplay station");e.loadingAutoplayStation=!0;const p=null===(n=e.queue.userAddedItems.slice(-1))||void 0===n?void 0:n.pop();let h,y;void 0!==(null==p?void 0:p.container)&&(h={id:p.container.id,type:p.container.type});try{Qe.info(`Creating Autoplay station with ${d.length} ${1===d.length?"item":"items"}`);y=(yield e._services.itemLoader.createAutoplayStation(e.queue.items.slice(-e.maxTracksForAutoplayStation),{container:h})).station}catch(he){Qe.warning("Unable to create Autoplay station: "+he.message)}void 0===y?Qe.info("Unable to create Autoplay station: no server data"):Qe.info("Created Autoplay Station "+(null==y?void 0:y.id)),e._autoplayStation=y,e.queue.hasAutoplayStation=void 0!==y,e.loadingAutoplayStation=!1,yield e.queueAutoplayTracks()}))()}queueAutoplayTracks(e){var n=this;return _async_to_generator$y((function*(){var d,p;if(void 0===n._autoplayStation)return void Qe.debug("Skipping loading Autoplay tracks, no autoplay station");if(0===(null==e?void 0:e.limit))return void Qe.warn("Skipping loading Autoplay tracks, track limit set to 0");if(n.queue.unplayedUserItems.length>n.autoplayQueueSizeThreshold)return void Qe.debug(`Skipping loading Autoplay tracks, more than ${n.autoplayQueueSizeThreshold} user added tracks in the queue `);if(n.loadingAutoplayTracks)return void Qe.debug("Skipping loading Autoplay tracks, already loading");const h=n.autoplayUpcomingTracksLimit-n.queue.unplayedAutoplayItems.length+((null===(d=n.queue.currentQueueItem)||void 0===d?void 0:d.isAutoplay)?1:0);if(h<=0)return void Qe.debug(`Skipping loading Autoplay tracks, ${n.autoplayUpcomingTracksLimit} autoplay items already in the queue`);n.loadingAutoplayTracks=!0,Qe.debug(`Loading next tracks from Autoplay station ${n._autoplayStation.id} (amount: ${h})`);let y=yield n._services.itemLoader.loadStationNextTracks(n._autoplayStation.id,{limit:h,container:n._autoplayStation,context:_object_spread_props$i(_object_spread$p({},n.context),{featureName:"now_playing",reco_id:(null===(p=n.context.featureName)||void 0===p?void 0:p.startsWith("listen-now"))?void 0:n.context.reco_id})});"number"==typeof(null==e?void 0:e.limit)&&e.limit>0&&(y=y.slice(0,e.limit)),Qe.debug(`Queueing ${y.length} tracks from Autoplay station ${n._autoplayStation.id}`),n.queue.appendQueueItems(y.map(e=>new QueueItem(e,{isAutoplay:!0}))),n.loadingAutoplayTracks=!1}))()}_changeToMediaAtIndex(e=0,n={userInitiated:!1}){var d=this,_superprop_get__changeToMediaAtIndex=()=>super._changeToMediaAtIndex;return _async_to_generator$y((function*(){return yield _superprop_get__changeToMediaAtIndex().call(d,e,n)}))()}get shouldTransitionSeamlessly(){return this._isSeamlessAudioTransitionsEnabled&&this.hasAuthorization&&!this.previewOnly}constructor(e){var n,d,p,h,y,_,m,g,b,P;super(e),_define_property$A(this,"type",ao.serial),_define_property$A(this,"_preloader",void 0),_define_property$A(this,"_isSeamlessAudioTransitionsEnabled",void 0),_define_property$A(this,"autoplayQueueSizeThreshold",void 0),_define_property$A(this,"autoplayUpcomingTracksLimit",void 0),_define_property$A(this,"maxTracksForAutoplayStation",void 0),_define_property$A(this,"_autoplayStation",void 0),_define_property$A(this,"loadingAutoplayStation",!1),_define_property$A(this,"loadingAutoplayTracks",!1),this._queue=new Queue(e),this._repeatable=new Repeatable(this._dispatcher),this._seekable=new Seekable(this._dispatcher,this._mediaItemPlayback),this._shuffler=new Shuffler(this,{dispatcher:this._dispatcher}),this._isSeamlessAudioTransitionsEnabled=!!(null==e||null===(n=e.bag)||void 0===n?void 0:n.features["seamless-audio-transitions"]),this.autoplayQueueSizeThreshold=null!==(g=null==e||null===(p=e.bag)||void 0===p||null===(d=p.autoplay)||void 0===d?void 0:d.maxQueueSizeForAutoplay)&&void 0!==g?g:50,this.autoplayUpcomingTracksLimit=null!==(b=null==e||null===(y=e.bag)||void 0===y||null===(h=y.autoplay)||void 0===h?void 0:h.maxUpcomingTracksToMaintain)&&void 0!==b?b:10,this.maxTracksForAutoplayStation=null!==(P=null==e||null===(m=e.bag)||void 0===m||null===(_=m.autoplay)||void 0===_?void 0:_.maxQueueSizeInRequest)&&void 0!==P?P:10;const S={controller:this,services:e.services};this._preloader=new Preloader(S)}}function _define_property$z(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}_ts_decorate$c([Bind(),_ts_metadata$c("design:type",Function),_ts_metadata$c("design:paramtypes",[void 0===co?Object:co]),_ts_metadata$c("design:returntype",Boolean)],SerialPlaybackController.prototype,"hasCapabilities",null),_ts_decorate$c([Bind(),_ts_metadata$c("design:type",Function),_ts_metadata$c("design:paramtypes",[String,Object]),_ts_metadata$c("design:returntype",Promise)],SerialPlaybackController.prototype,"onSeamlessAudioTransition",null),_ts_decorate$c([Bind(),_ts_metadata$c("design:type",Function),_ts_metadata$c("design:paramtypes",[]),_ts_metadata$c("design:returntype",Promise)],SerialPlaybackController.prototype,"onRepeatModeChange",null),_ts_decorate$c([Bind(),_ts_metadata$c("design:type",Function),_ts_metadata$c("design:paramtypes",[]),_ts_metadata$c("design:returntype",Promise)],SerialPlaybackController.prototype,"onQueueChange",null),_ts_decorate$c([Bind(),_ts_metadata$c("design:type",Function),_ts_metadata$c("design:paramtypes",[]),_ts_metadata$c("design:returntype",Promise)],SerialPlaybackController.prototype,"prepareToPlayNextItem",null);class MKDialog{static presentError(e){const n=e.dialog;void 0!==n?MKDialog.serverDialog(n).present():new MKDialog(e.message).present()}static serverDialog(e){const n=new this(e.message,e.explanation);return e.okButtonAction&&e.okButtonAction.url&&(n._okButtonActionURL=e.okButtonAction.url),e.okButtonString&&(n._okButtonString=e.okButtonString),e.cancelButtonString&&(n._cancelButtonString=e.cancelButtonString),n}static clientDialog(e){const n=new this(e.message,e.explanation);return e.okButtonAction&&(n._okButtonAction=e.okButtonAction),e.cancelButtonAction&&(n._cancelButtonAction=e.cancelButtonAction),e.okButtonString&&(n._okButtonString=e.okButtonString),e.cancelButtonString&&(n._cancelButtonString=e.cancelButtonString),n}get actions(){return this.cancelButton?`<div id="mk-dialog-actions">${this.cancelButton}${this.okButton}</div>`:`<div id="mk-dialog-actions">${this.okButton}</div>`}get cancelButton(){if("string"==typeof this._cancelButtonString)return`<button type="button">${this._cancelButtonString}</button>`}set cancelButton(e){this._cancelButtonString=e}get explanation(){return`<p id="mk-dialog-explanation">${this._explanation}</p>`}get hasOKButtonAction(){return!!this._okButtonActionURL||!!this._okButtonAction}get message(){return`<h5 id="mk-dialog-title">${this._message}</h5>`}get okButton(){return this.hasOKButtonAction&&this._okButtonActionURL?`<button type="button" data-ok-action-url='${this._okButtonActionURL}'>${this._okButtonString}</button>`:`<button type="button">${this._okButtonString}</button>`}present(){const e=document.createDocumentFragment(),n=document.createElement("div");n.id=this.scrimId,e.appendChild(n);const d=document.createElement("div");d.id=this.id,d.classList.add("mk-dialog"),d.setAttribute("role","alertDialog"),d.setAttribute("aria-modal","true"),d.setAttribute("aria-labeledby","mk-dialog-title"),d.setAttribute("aria-describedby","mk-dialog-explanation");let p=`\n      <div id="mk-dialog-body">\n        ${this.message}\n        ${this.explanation}\n      </div>`;p=`\n      ${p}\n      ${this.actions}\n    `,d.innerHTML=p,e.appendChild(d),document.body.appendChild(e),document.querySelector(`#${d.id} #mk-dialog-actions *:first-child`).focus(),setTimeout(()=>{document.querySelector(`#${d.id} #mk-dialog-actions *:first-child`).addEventListener("click",()=>{this._cancelButtonAction&&this._cancelButtonAction(),d.parentElement.removeChild(d),n.parentElement.removeChild(n)}),this.hasOKButtonAction&&(this._okButtonActionURL?document.querySelector(`#${d.id} #mk-dialog-actions *:last-child`).addEventListener("click",e=>{window.open(e.target.dataset.okActionUrl,"_blank"),d.parentElement.removeChild(d),n.parentElement.removeChild(n)}):this._okButtonAction&&document.querySelector(`#${d.id} #mk-dialog-actions *:last-child`).addEventListener("click",e=>{this._okButtonAction(),d.parentElement.removeChild(d),n.parentElement.removeChild(n)}))})}_appendStyle(e){const n=document.createElement("style");n.id=this.styleId,n.styleSheet?n.styleSheet.cssText=e:n.innerHTML=e,document.body.appendChild(n)}constructor(e,n=""){_define_property$z(this,"_message",void 0),_define_property$z(this,"_explanation",void 0),_define_property$z(this,"id",void 0),_define_property$z(this,"scrimId",void 0),_define_property$z(this,"styleId",void 0),_define_property$z(this,"_cancelButtonString",void 0),_define_property$z(this,"_cancelButtonAction",void 0),_define_property$z(this,"_okButtonAction",void 0),_define_property$z(this,"_okButtonActionURL",void 0),_define_property$z(this,"_okButtonString",void 0),this._message=e,this._explanation=n,this.id="musickit-dialog",this.scrimId=this.id+"-scrim",this.styleId=this.id+"-style",this._okButtonString="OK",[this.id,this.scrimId,this.styleId].forEach(e=>{try{const n=document.getElementById(e);n.parentElement.removeChild(n)}catch(St){}}),this._appendStyle("\n#musickit-dialog {\n  --mk-dialog-background: rgba(255, 255, 255, 1);\n  --mk-dialog-text: rgba(0, 0, 0, 0.95);\n  --mk-dialog-border: rgba(0, 0, 0, 0.07);\n  --mk-dialog-scrim: rgba(255, 255, 255, 0.8);\n  --mk-dialog-primary: rgba(0, 122, 255, 1);\n}\n\n@media (prefers-color-scheme: dark) {\n  #musickit-dialog {\n      --mk-dialog-background: rgba(30, 30, 30, 1);\n      --mk-dialog-text: rgba(255, 255, 255, 0.85);\n      --mk-dialog-border: rgba(255, 255, 255, 0.1);\n      --mk-dialog-scrim: rgba(38, 38, 38, 0.8);\n      --mk-dialog-primary: rgba(8, 132, 255, 1);\n  }\n}\n\n#musickit-dialog-scrim {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  height: 100%;\n  background: rgba(0, 0, 0, 0.35);\n}\n\n#musickit-dialog * {\n  -webkit-tap-highlight-color: transparent;\n  -webkit-touch-callout: none;\n  -ms-touch-action: none;\n  -webkit-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  user-select: none;\n  font-family: -apple-system, SF UI Text, Helvetica Neue, Helvetica, sans-serif;\n  font-size: 15px;\n  line-height: 20px;\n}\n\n#musickit-dialog *:focus { outline: 0; }\n\n#musickit-dialog {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  -webkit-justify-content: space-between;\n  -moz-justify-content: space-between;\n  justify-content: space-between;\n  min-width: 277px;\n  max-width: 290px;\n  min-height: 109px;\n  background: var(--mk-dialog-background);\n  box-shadow: 0px 0px 9px rgba(0, 0, 0, 0.18);\n  border-radius: 10px;\n  color: var(--mk-dialog-text);\n  position: fixed;\n  top: 50%;\n  left: 50%;\n  margin-left: -142px;\n  margin-top: -67px;\n  z-index: 9999999999999999999999999;\n}\n\n#musickit-dialog #mk-dialog-body {\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: column;\n  -moz-flex-direction: column;\n  flex-direction: column;\n  flex-grow: 1;\n  -webkit-justify-content: space-evenly;\n  -moz-justify-content: space-evenly;\n  justify-content: space-evenly;\n  -webkit-align-items: stretch;\n  align-items: stretch;\n  padding: 10px 20px;\n  min-height: 74px;\n  text-align: center;\n}\n\n#musickit-dialog .mk-dialog h5 {\n  font-weight: 500;\n  line-height: 20px;\n  margin: 7px 0 0 0;\n  padding: 0;\n}\n\n#musickit-dialog .mk-dialog p {\n  margin: 0 0 7px 0;\n  padding: 0;\n  paddin-top: 3px;\n  line-height: 18px;\n  font-size: 13px;\n  font-weight: 300;\n}\n\n#musickit-dialog #mk-dialog-actions {\n  border-top: 1px solid var(--mk-dialog-border);\n  display: -webkit-box;\n  display: -moz-box;\n  display: -ms-flexbox;\n  display: -webkit-flex;\n  display: flex;\n  -webkit-flex-direction: row;\n  -moz-flex-direction: colrowumn;\n  flex-direction: row;\n  max-height: 41px;\n  min-height: 34px;\n  -webkit-justify-self: flex-end;\n  -moz-justify-self: flex-end;\n  justify-self: flex-end;\n}\n\n#musickit-dialog #mk-dialog-actions button {\n  flex-grow: 1;\n  border: 0;\n  background: none;\n  color: var(--mk-dialog-primary);\n  padding: 0;\n  margin: 0;\n  min-height: 34px;\n  height: 41px;\n  text-align: center;\n}\n\n#musickit-dialog #mk-dialog-actions *:nth-child(2) {\n  border-left: 1px solid var(--mk-dialog-border);\n  font-weight: 500;\n}\n")}}function _define_property$y(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$o(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$y(e,n,d[n])}))}return e}function transformParameters(e,n=25){if(e)return e.limit&&(e.limit=e.limit>n?n:e.limit),e}function transformStoreData(e){const n=_object_spread$o({},e),{href:d}=n;return void 0!==d&&(delete n.href,n.attributes=_object_spread$o({},n.attributes,{href:d})),n}function transformTrackParameters(e){return e.map(e=>"string"==typeof e?{id:e,type:"songs"}:{id:e.id,type:e.type||"songs"})}function _define_property$x(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const lo=["extend","include","l","platform","views"];class LocalDataStore{get hasDataStore(){return this.enableDataStore&&void 0!==this._store}delete(e,n){this.hasDataStore&&this._store.remove(e,n)}read(e,n,d,p){p||"function"!=typeof d||(p=d,d=void 0);const h={};let y=!1;if(d&&(y=Object.keys(d).some(e=>/^(fields|extend)/.test(e)),d.views&&(h.views=d.views),d.include&&(h.relationships=d.include)),this.hasDataStore&&!y){let p,y=[];if(d&&(y=Object.keys(d).reduce((e,n)=>(-1===lo.indexOf(n)&&e.push([n,d[n]]),e),y)),p=y&&1===y.length?this._store.query(y[0][0],y[0][1]):this._store.peek(e,n,h),Array.isArray(p)){if(!d&&p.length)return p}else if(p)return p}if("function"==typeof p)return p()}write(e){return this._prepareDataForDataStore(e,e=>this._store.save(e))}parse(e){return this._prepareDataForDataStore(e,e=>this._store.populateDataRecords(e,{}))}_prepareDataForDataStore(e,n){return this.hasDataStore?Array.isArray(e)?n({data:e}):Object.keys(e).reduce((d,p)=>{const h=e[p];return hasOwn(h,"data")&&(d[p]=n({data:h.data})),"meta"===p&&(d[p]=e[p]),d},{}):e}constructor(e={}){_define_property$x(this,"_store",void 0),_define_property$x(this,"enableDataStore",!1);let n=!1;e.features&&hasOwn(e.features,"api-data-store")&&(this.enableDataStore=!!e.features["api-data-store"]),e.features&&hasOwn(e.features,"disable-data-store-record-reuse")&&(n=!!e.features["disable-data-store-record-reuse"]),this.enableDataStore&&(this._store=e.store||new DataStore({shouldDisableRecordReuse:n}),this._store.mapping=transformStoreData)}}function asyncGeneratorStep$x(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$x(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$x(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$x(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}const ChunkedIdApi=(e,n=100,d=1e3)=>(p,h,y)=>{if(void 0===y||"function"!=typeof y.value)throw new TypeError(`Only methods can be decorated with @ChunkedIdApi, but ${h} is not a method.`);return{configurable:!0,get:function(){const p=y.value;function chunkedIdApi(){return _chunkedIdApi.apply(this,arguments)}function _chunkedIdApi(){return(_chunkedIdApi=_async_to_generator$x((function*(...h){const y=h[e];if(y&&Array.isArray(y)){const _=y[0].length||20,m=Math.min(n,Math.floor(d/_)),g=Math.ceil(y.length/m);if(g>1){const n=h.slice(0,e),d=h.slice(e+1),_=[];let b=0;for(let e=1;e<=g;e++){const h=Math.min(e*m,y.length),g=[...n,y.slice(b,h),...d];_.push(p.apply(this,g)),b+=m}const P=yield Promise.all(_);return[].concat(...P)}}return p.apply(this,h)}))).apply(this,arguments)}return Object.defineProperty(this,h,{value:chunkedIdApi,configurable:!0,writable:!0}),chunkedIdApi}}},formatTimezoneOffset=(e=new Date)=>{const n=e.getTimezoneOffset(),d=Math.floor(Math.abs(n)/60),p=Math.round(Math.abs(n)%60);let h="+";return 0!==n&&(h=n>0?"-":"+"),`${h}${leadingZeros(d,2)}:${leadingZeros(p,2)}`},leadingZeros=(e,n=2)=>{let d=""+e;for(;d.length<n;)d="0"+d;return d};function asyncGeneratorStep$w(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$w(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$w(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$w(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$w(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$h(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_metadata$b(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class Books extends TokenSession{audioBook(e,n,d){return this.resource("audio-books",e,n,d)}audioBooks(e,n,d){return this.collection("audio-books",e,n,d)}collection(e,n,d,p){var h=this;return _async_to_generator$w((function*(){const y=`catalog/${h.storefrontId}/${e}`;return n&&((d=d||{}).ids=n),makeRequest(h,y,d,p)}))()}parseResultData(e,n){return e?this._store.write(n):this._store.parse(n)}resource(e,n,d,p){var h=this;return _async_to_generator$w((function*(){if(!(null==p?void 0:p.reload)){const p=h._store.read(e,n,d);if(p)return p}const[y]=yield h.collection(e,n,d,p);return y}))()}constructor(e,n,d,p,h={},y){super("https://api.books.apple.com/v1",e,_object_spread_props$h(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$w(e,n,d[n])}))}return e}({},y),{userToken:n,storage:p})),_define_property$w(this,"_store",void 0),_define_property$w(this,"defaultIncludePaginationMetadata",void 0),_define_property$w(this,"storefrontId",Fe.ID),d&&(this.storefrontId=d),this._store=new LocalDataStore(h),this.defaultIncludePaginationMetadata=h.features&&hasOwn(h.features,"api-pagination-metadata")}}function asyncGeneratorStep$v(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$v(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$v(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$v(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$v(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$m(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$v(e,n,d[n])}))}return e}function _object_spread_props$g(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_metadata$a(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([ChunkedIdApi(1),_ts_metadata$b("design:type",Function),_ts_metadata$b("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$b("design:returntype",Promise)],Books.prototype,"collection",null);class Podcasts extends TokenSession{catalogResource(e,n,d,p){return this.resource(e,n,d,p)}catalogResources(e,n,d,p){return this.collection(e,n,d,p)}catalogResourceRelationship(e,n,d,p,h){return this.collection(`${e}/${n}/${d}`,void 0,p,h)}search(e,n,d){return this.collection("search",void 0,_object_spread$m({term:e,types:"podcasts"},n),d)}artist(e,n,d){return this.catalogResource("artists",e,n,d)}artists(e,n,d){return this.catalogResources("artists",e,n,d)}artistRelationship(e,n,d,p){return this.catalogResourceRelationship("artists",e,n,d,p)}charts(e,n,d){return this.catalogResources("charts",void 0,_object_spread$m({types:e},n),d)}podcast(e,n,d){return this.catalogResource("podcasts",e,_object_spread$m({include:"episodes"},n),d)}podcasts(e,n,d){var p=this;return _async_to_generator$v((function*(){return p.catalogResources("podcasts",e,_object_spread$m({include:"episodes"},n),d)}))()}podcastRelationship(e,n,d,p){var h=this;return _async_to_generator$v((function*(){return h.catalogResourceRelationship("podcasts",e,n,d,p)}))()}episode(e,n,d){var p=this;return _async_to_generator$v((function*(){return p.resource("podcast-episodes",e,n,d)}))()}episodes(e,n,d){var p=this;return _async_to_generator$v((function*(){return p.catalogResources("podcast-episodes",e,n,d)}))()}collection(e,n,d,p){var h=this;return _async_to_generator$v((function*(){let y;if(n){const p={};p["charts"===e?"types":"ids"]=n,y=Object.assign(p,d)}else y=d;const _=`catalog/${h.storefrontId}/${e}`;return makeRequest(h,_,y,p)}))()}parseResultData(e,n){return e?this._store.write(n):this._store.parse(n)}resource(e,n,d,p){var h=this;return _async_to_generator$v((function*(){if(!(null==p?void 0:p.reload)){const p=h._store.read(e,n,d);if(p)return p}const[y]=yield h.collection(e,n,d,p);return y}))()}constructor(e,n,d=Fe.ID,p,h={},y){super("https://amp-api.podcasts.apple.com/v1",e,_object_spread_props$g(_object_spread$m({},y),{userToken:n,storage:p})),_define_property$v(this,"_store",void 0),_define_property$v(this,"defaultIncludePaginationMetadata",void 0),_define_property$v(this,"storefrontId",void 0),this.storefrontId=d,this._store=new LocalDataStore(h),this.defaultIncludePaginationMetadata=h.features&&hasOwn(h.features,"api-pagination-metadata")}}function asyncGeneratorStep$u(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$u(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$l(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$u(e,n,d[n])}))}return e}function _object_spread_props$f(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_metadata$9(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([ChunkedIdApi(1),_ts_metadata$a("design:type",Function),_ts_metadata$a("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$a("design:returntype",Promise)],Podcasts.prototype,"collection",null);const uo=new Set(["editorial-items"]);class Fitness extends TokenSession{workout(e,n,d){return this.resource("workouts",e,n,d)}contributor(e,n,d){return this.resource("contributors",e,n,d)}editorialItem(e,n,d){return this.resource("editorial-items",e,n,d)}modalities(e,n,d){return this.collection("modalities",e,n,d)}modality(e,n,d){return this.resource("modalities",e,n,d)}workoutProgram(e,n,d){return this.resource("workout-programs",e,n,d)}collection(e,n,d,p){let h;h=n?_object_spread$l({ids:n},d):d;let y="catalog";uo.has(e)&&(y="editorial");return makeRequest(this,`${y}/${this.storefrontId}/${e}`,h,p)}parseResultData(e,n){return e?this._store.write(n):this._store.parse(n)}resource(e,n,d,p){var h,y=this;return(h=function*(){const h=y._store.read(e,n,d);if(h)return h;const[_]=yield y.collection(e,n,d,p);return _},function(){var e=this,n=arguments;return new Promise((function(d,p){var y=h.apply(e,n);function _next(e){asyncGeneratorStep$u(y,d,p,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$u(y,d,p,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,n,d=Fe.ID,p,h={},y){var _;super("https://amp-api.fitness.apple.com/v1",e,_object_spread_props$f(_object_spread$l({},y),{userToken:n,storage:p})),_define_property$u(this,"_store",void 0),_define_property$u(this,"defaultIncludePaginationMetadata",void 0),_define_property$u(this,"storefrontId",Fe.ID),this.storefrontId=d,this._store=new LocalDataStore(h),this.defaultIncludePaginationMetadata=!!(null==h||null===(_=h.features)||void 0===_?void 0:_["api-pagination-metadata"])}}function asyncGeneratorStep$t(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$t(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$t(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$t(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$t(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$k(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$t(e,n,d[n])}))}return e}function _object_spread_props$e(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_metadata$8(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([ChunkedIdApi(1),_ts_metadata$9("design:type",Function),_ts_metadata$9("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions]),_ts_metadata$9("design:returntype","undefined"==typeof Promise?Object:Promise)],Fitness.prototype,"collection",null);class TVLibrary extends TokenSession{genres(e,n){var d=this;return _async_to_generator$t((function*(){return d.collection("genres",_object_spread$k({types:"tv-episodes,movies"},e),n)}))()}movies(e,n){var d=this;return _async_to_generator$t((function*(){return d.collection("movies",e,n)}))()}purchases(e,n){var d=this;return _async_to_generator$t((function*(){return d.collection("",_object_spread$k({types:"tv-episodes,movies"},e),n)}))()}tvEpisodes(e,n){var d=this;return _async_to_generator$t((function*(){return d.collection("tv-episodes",e,n)}))()}collection(e,n,d){var p=this;return _async_to_generator$t((function*(){try{return yield makeRequest(p,"me/purchases/"+e,n,d)}catch(he){if(MKError.isMKError(he)&&he.reason===MKError.Reason.CONTENT_UNAVAILABLE)return(null==d?void 0:d.includePagination)?{data:[],meta:{}}:[];throw he}}))()}parseResultData(e,n){return e?this._store.write(n):this._store.parse(n)}constructor(e,n,d,p={},h){super("https://amp-api.videos.apple.com/v1",e,_object_spread_props$e(_object_spread$k({},h),{userToken:n,storage:d})),_define_property$t(this,"_store",void 0),_define_property$t(this,"defaultIncludePaginationMetadata",void 0),this._store=new LocalDataStore(p),this.defaultIncludePaginationMetadata=p.features&&hasOwn(p.features,"api-pagination-metadata")}}function asyncGeneratorStep$s(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$s(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$s(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$s(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$s(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$j(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$s(e,n,d[n])}))}return e}function _object_spread_props$d(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([ChunkedIdApi(1),_ts_metadata$8("design:type",Function),_ts_metadata$8("design:paramtypes",[String,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$8("design:returntype",Promise)],TVLibrary.prototype,"collection",null);const RecommendationUpdate=()=>(e,n,d)=>{if(void 0===d||"function"!=typeof d.value)throw new TypeError(`Only methods can be decorated with @RecommendationUpdate, but ${n} is not a method.`);return{configurable:!0,get:function(){const e=d.value;function recommendationUpdate(){return _recommendationUpdate.apply(this,arguments)}function _recommendationUpdate(){return(_recommendationUpdate=_async_to_generator$s((function*(...n){const d=yield e.apply(this,n),p=new Map,h=[],y=new Date;if(!d||!Array.isArray(d))return d;if(d.forEach((e,n)=>{var d;const _=e.id;var m;const g=null!==(m=e.nextUpdateDate)&&void 0!==m?m:null===(d=e.attributes)||void 0===d?void 0:d.nextUpdateDate;if(!_||!g)return;new Date(g)<y&&(h.push(_),p.set(_,n))}),!h.length)return d;let[_,m,g,...b]=n;g=_object_spread_props$d(_object_spread$j({},g),{reload:!0});const P=[h,m,g,...b];return(yield e.apply(this,P)).forEach(e=>{const n=p.get(e.id);void 0!==n&&(d[n]=e)}),d}))).apply(this,arguments)}return Object.defineProperty(this,n,{value:recommendationUpdate,configurable:!0,writable:!0}),recommendationUpdate}}};function rejectOnLast(){return Promise.reject("The last middleware in the stack should not call next")}function processMiddleware(e,...n){return e.length?function createNextFunction([e,...n]){return(...d)=>e(createNextFunction(n),...d)}([...e,rejectOnLast])(...n):Promise.reject("processMiddleware requires at mimimum one middleware function")}function parameterizeString(e,n){return function(e){try{return function recursiveTokenizeParameterizedString(e,n=[]){if(e.startsWith("{{")){const d=e.indexOf("}}");if(-1===d)throw new Error("UNCLOSED_PARAMETER");const p={type:1,value:e.slice(2,d)};return d+2<e.length?recursiveTokenizeParameterizedString(e.slice(d+2),[...n,p]):[...n,p]}{const d=e.indexOf("{{");return-1===d?[...n,{type:0,value:e}]:recursiveTokenizeParameterizedString(e.slice(d),[...n,{type:0,value:e.slice(0,d)}])}}(e)}catch(he){if("UNCLOSED_PARAMETER"===he.message)throw new Error(`Unclosed parameter in path: "${e}"`);throw he}}(e).map(e=>{switch(e.type){case 1:return e.value in n?encodeURIComponent(""+n[e.value]):`{{${e.value}}}`;case 0:default:return e.value}}).join("")}function _define_property$r(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$c(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function constructUrlMiddleware(e,n){let d=n.url;var p;return d||(d=buildURL(n.baseUrl,n.path)),n.urlParameters&&(d=parameterizeString(d,n.urlParameters)),e(_object_spread_props$c(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$r(e,n,d[n])}))}return e}({},n),{url:buildURL(d,null!==(p=n.queryParameters)&&void 0!==p?p:{})}))}function asyncGeneratorStep$r(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$r(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$r(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$r(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function unwrapJSONFromResponse(e){return _unwrapJSONFromResponse.apply(this,arguments)}function _unwrapJSONFromResponse(){return(_unwrapJSONFromResponse=_async_to_generator$r((function*(e){try{return yield e.json()}catch(he){return}}))).apply(this,arguments)}function fetchMiddlewareFactory(e){return function(){var n=_async_to_generator$r((function*(n,d){const p=yield e(d.url,d.fetchOptions),h={request:d,response:p,data:yield unwrapJSONFromResponse(p)};if(!p.ok)throw MKError.responseError(p);return h}));return function(e,d){return n.apply(this,arguments)}}()}const po=fetchMiddlewareFactory("undefined"!=typeof fetch?fetch:()=>{throw new Error("window.fetch is not defined")});function _define_property$q(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$h(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$q(e,n,d[n])}))}return e}function _object_spread_props$b(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}var ho=function(e){return e.Replace="REPLACE",e.Merge="MERGE",e}({});const yo=["url"];class APISession{get config(){return this._config}request(e,n={},d={}){var p;return processMiddleware(this.middlewareStack,_object_spread_props$b(_object_spread$h({},this.config.defaultOptions,d),{baseUrl:this.config.url,path:e,fetchOptions:mergeFetchOptions(null===(p=this.config.defaultOptions)||void 0===p?void 0:p.fetchOptions,d.fetchOptions),queryParameters:_object_spread$h({},this.config.defaultQueryParameters,n),urlParameters:_object_spread$h({},this.config.defaultUrlParameters,d.urlParameters)}))}reconfigure(e,n="REPLACE"){"MERGE"===n&&(e=deepmerge(this.config,e)),yo.forEach(n=>{if(void 0===e[n])throw new Error(`Session requires a valid SessionConfig, missing "${n}"`)}),this._config=e,this.middlewareStack=this.createMiddlewareStack()}createMiddlewareStack(){return Array.isArray(this.config.middleware)?[constructUrlMiddleware,...this.config.middleware,this.makeFetchMiddleware()]:[constructUrlMiddleware,this.makeFetchMiddleware()]}makeFetchMiddleware(){return"function"==typeof this.config.fetchFunction?fetchMiddlewareFactory(this.config.fetchFunction):po}constructor(e){_define_property$q(this,"_config",void 0),_define_property$q(this,"middlewareStack",void 0),this.reconfigure(e)}}function _object_without_properties(e,n){if(null==e)return{};var d,p,h=function(e,n){if(null==e)return{};var d,p,h={},y=Object.keys(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||(h[d]=e[d]);return h}(e,n);if(Object.getOwnPropertySymbols){var y=Object.getOwnPropertySymbols(e);for(p=0;p<y.length;p++)d=y[p],n.indexOf(d)>=0||Object.prototype.propertyIsEnumerable.call(e,d)&&(h[d]=e[d])}return h}const fo={music:{url:"https://api.music.apple.com"},apps:{url:"https://amp-api.apps.apple.com"},books:{url:"https://amp-api.books.apple.com"},fitness:{url:"https://amp-api.fitness.apple.com"}};fo.music={url:"https://amp-api.music.apple.com"},fo.videos={url:"https://amp-api.videos.apple.com"},fo.podcasts={url:"https://amp-api.podcasts.apple.com"};class MediaAPIV3{configure(e,n,d=ho.Merge){this.storefrontId=n.storefrontId;const p=function(e){let n={};e.url&&(n.url=e.url);e.storefrontId&&(n.defaultUrlParameters={storefrontId:e.storefrontId});e.mediaUserToken&&(n.defaultOptions={fetchOptions:{headers:{"Media-User-Token":e.mediaUserToken}}});e.developerToken&&(n=deepmerge(n,{defaultOptions:{fetchOptions:{headers:{Authorization:"Bearer "+e.developerToken}}}}));e.options&&(n=deepmerge(n,e.options));return n}(n);if(this[e])this[e].session.reconfigure(p,d);else{var h;const n=new APISession(p),d=n.request.bind(n);d.session=n;const y="undefined"!=typeof process&&"test"===(null===(h=process.env)||void 0===h?void 0:h.NODE_ENV);Object.defineProperty(this,e,{value:d,writable:y,enumerable:!0})}}constructor(e){!function(e,n,d){n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d}(this,"storefrontId",void 0);const{realmConfig:n}=e,d=_object_without_properties(e,["realmConfig"]);for(const p in fo){let e=deepmerge(fo[p],d);const h=null==n?void 0:n[p];h&&(e=deepmerge(e,h)),this.configure(p,e)}}}function dasherize(e){return e.replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()}function asyncGeneratorStep$q(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$o(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function makeAlbumKey(e){var n;return(null===(n=e.artwork)||void 0===n?void 0:n.url)+""+e.artistName+""+e.name}class ServerLedger{_initData(){return{lastTimestamp:0,albums:{added:Object.create(null),removed:Object.create(null)},playlists:{added:Object.create(null),removed:Object.create(null)}}}_checkTimestamp(){const e=this._data.lastTimestamp;e&&e+24e5<Date.now()&&(this._data=this._initData(),this._sessionStorage&&this._sessionStorage.removeItem(this._storageKey))}added(e){this.load();const n=null==e?void 0:e.playlists,d=null==e?void 0:e.albums;return n||d?(n&&n.forEach(e=>{const n=Date.now();this._data.playlists.added[e]=n,this._data.lastTimestamp=n}),d&&d.forEach(e=>{const n=Date.now();this._data.albums.added[e]=n,this._data.lastTimestamp=n}),this.save(),e):e}removed(e){this.load();const n=null==e?void 0:e.playlists;return n?(ensureArray(n).forEach(e=>{if(0!==e.indexOf("pl.")){const n=Date.now();this._data.playlists.removed[e]=n,this._data.lastTimestamp=n}}),this.save(),e):e}reconcile(e,n,d,p,h){var y,_=this;return(y=function*(){_._checkTimestamp();const h=n.data||n;if(!h||!Array.isArray(h)||Array.isArray(d))return n;const y=_._data.albums.added,m=_._data.playlists.removed,g=_._data.playlists.added,b=[],P=p&&!p.offset||!!d&&(void 0===d.offset||0===d.offset);let S=!1;if("all"===e||"playlists"===e){for(let e=h.length-1;e>=0;e--){var T;const n=h[e],d=null===(T=n.playParams)||void 0===T?void 0:T.globalId;"library-playlists"===n.type&&(m[n.id]?h.splice(e,1):d&&g[d]&&(delete g[d],S=!0,P||h.splice(e,1)))}if(P&&_._catalogApi){const e=Object.keys(g);if(e.length){const n=yield _._catalogApi.playlists(e);b.splice(0,0,...n)}}}if(_._catalogApi&&("all"===e||"albums"===e)){const e=Object.keys(y);if(e.length){const n=yield _._catalogApi.albums(e),d=Object.create(null);n.forEach((n,p)=>{const h=makeAlbumKey(n);d[h]={catalogId:e[p],album:n}});for(let e=h.length-1;e>=0;e--){var k;const n=h[e];if(null===(k=n.playParams)||void 0===k||k.globalId,"library-albums"===n.type){const p=makeAlbumKey(n),_=d[p];_&&(delete y[_.catalogId],S=!0,P?delete d[p]:h.splice(e,1))}}if(P){const e=Object.keys(d).map(e=>d[e].album);e.length&&b.splice(0,0,...e)}}}if(S&&_.save(),P&&b.length&&(b.sort((e,n)=>{const d=_._data.albums.added[e.id]||_._data.playlists.added[e.id]||0;return(_._data.albums.added[n.id]||_._data.playlists.added[n.id]||0)-d}),h.splice(0,0,...b)),!h.length)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"The requested content is not available.");const E=n.meta;return E&&void 0===E.total&&(E.total=h.length),n},function(){var e=this,n=arguments;return new Promise((function(d,p){var h=y.apply(e,n);function _next(e){asyncGeneratorStep$q(h,d,p,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$q(h,d,p,_next,_throw,"throw",e)}_next(void 0)}))})()}load(){if(!this._sessionStorage)return;const e=this._sessionStorage.getItem(this._storageKey);if(e)try{this._data=JSON.parse(e),this._data.albums&&this._data.playlists||(this._data=this._initData())}catch(St){this._data||(this._data=this._initData())}else this._data=this._initData()}save(){if(!this._sessionStorage)return;const e=this._data,n=0===Object.keys(e.albums.added).length&&0===Object.keys(e.albums.removed).length&&0===Object.keys(e.playlists.added).length&&0===Object.keys(e.playlists.removed).length;try{if(n)this._sessionStorage.getItem(this._storageKey)&&this._sessionStorage.removeItem(this._storageKey);else{const e=JSON.stringify(this._data);this._sessionStorage.setItem(this._storageKey,e)}}catch(St){}}constructor(e,n,d){_define_property$o(this,"_storageKey",void 0),_define_property$o(this,"_data",this._initData()),_define_property$o(this,"_catalogApi",void 0),_define_property$o(this,"_sessionStorage",void 0),this._catalogApi=n,this._storageKey="mk-server-ledger:"+(e||""),this._sessionStorage=d||getSessionStorage(),this.load()}}function asyncGeneratorStep$p(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$p(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$p(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$p(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$n(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$g(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$n(e,n,d[n])}))}return e}function _object_spread_props$a(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_metadata$7(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const _o="me/library";class Library extends TokenSession{add(e){var n=this;return _async_to_generator$p((function*(){const d=transformKeys(e,dasherize),p=Date.now();if(p-n._last<1e3)return Promise.reject(new MKError(MKError.Reason.QUOTA_EXCEEDED));const h=new Headers({Authorization:"Bearer "+n.developerToken,[Ee]:n.userToken}),y=Object.keys(d).map(e=>`ids[${e}]=${d[e].join(",")}`).join("&");try{const e=yield fetch(`${n.url}/${_o}?${y}`,{method:"POST",headers:h});return e.ok?(n._last=p,n._serverLedger.added(d)):Promise.reject(MKError.responseError(e))}catch(_){return Promise.reject(MKError.responseError(_))}}))()}remove(e){var n=this;return _async_to_generator$p((function*(){if(!n.developerToken||!n.userToken)return Promise.reject("Invalid tokens");const d=new Headers({Authorization:"Bearer "+n.developerToken,[Ee]:n.userToken}),p=transformKeys(e,dasherize),h=Object.keys(p)[0],y=Object.values(p)[0];try{const e=yield fetch(`${n.url}/${_o}/${h}/${y}`,{method:"DELETE",headers:d});return e.ok?n._serverLedger.removed(p):Promise.reject(MKError.responseError(e))}catch(_){return Promise.reject(MKError.responseError(_))}}))()}album(e,n,d){var p=this;return _async_to_generator$p((function*(){return p.resource("albums",e,n,d)}))()}albumRelationship(e,n,d,p){var h=this;return _async_to_generator$p((function*(){return h.collection(`albums/${e}/${n}`,void 0,d,p)}))()}albums(e,n,d){var p=this;return _async_to_generator$p((function*(){let h;try{h=yield p.collection("albums",e,n,_object_spread_props$a(_object_spread$g({},d),{shouldCacheResults:!1}))}catch(St){if(!MKError.isMKError(St)||St.reason!==MKError.Reason.CONTENT_UNAVAILABLE)throw St;h={data:[],meta:{}}}return p._serverLedger.reconcile("albums",h,e,n,d)}))()}artist(e,n,d){var p=this;return _async_to_generator$p((function*(){return p.resource("artists",e,n,d)}))()}artistRelationship(e,n="albums",d,p){var h=this;return _async_to_generator$p((function*(){return h.collection(`artists/${e}/${n}`,void 0,d,p)}))()}artists(e,n,d){var p=this;return _async_to_generator$p((function*(){return p.collection("artists",e,n,d)}))()}createPlaylist(e={},n){var d=this;return _async_to_generator$p((function*(){let p;const{name:h,description:y,tracks:_=[]}=e,m={attributes:{name:h,description:y},relationships:{tracks:{data:transformTrackParameters(_)}}},g=JSON.stringify(m);try{p=yield d.request(_o+"/playlists",n,{body:g,method:"POST"})}catch(he){return Promise.reject(MKError.responseError(he))}try{const[e]=d._store.write(p);return e}catch(he){return Promise.reject(MKError.parseError(he))}}))()}deletePlaylist(e,n){var d=this;return _async_to_generator$p((function*(){let p;const h=`${_o}/playlists/${e}`;try{p=yield d.request(h,n,{method:"DELETE"})}catch(he){return Promise.reject(MKError.responseError(he))}d.purgePlaylistFromCaches(e)}))()}editPlaylist(e,n,d){var p=this;return _async_to_generator$p((function*(){let h;const y=JSON.stringify({attributes:n});try{h=yield p.request(`${_o}/playlists/${e}`,d,{body:y,method:"PATCH"})}catch(he){return Promise.reject(MKError.responseError(he))}try{const d=n,h="library-playlists";return p._store.write({data:[{type:h,id:e,attributes:d}]}),n}catch(he){return Promise.reject(MKError.parseError(he))}}))()}updatePlaylistTracklist(e,n){var d=this;return _async_to_generator$p((function*(){yield d.putPlaylistTracklisting(e,n,"PUT"),d.purgePlaylistFromCaches(e)}))()}appendTracksToPlaylist(e,n){var d=this;return _async_to_generator$p((function*(){yield d.putPlaylistTracklisting(e,n,"POST"),d.purgePlaylistFromCaches(e)}))()}playlistFolder(e,n,d){return this.resource("playlist-folders",e,n,d)}playlistFolders(e,n,d){return this.collection("playlist-folders",e,n,d)}playlistFoldersRoot(e,n){return e=_object_spread_props$a(_object_spread$g({},e),{filter:_object_spread_props$a(_object_spread$g({},null==e?void 0:e.filter),{identity:"playlistsroot"})}),this.playlistFolders(void 0,e,n)}playlistFolderChildren(e,n,d){const p=`playlist-folders/${e}/children`;return this.collection(p,void 0,n,d)}musicVideo(e,n,d){var p=this;return _async_to_generator$p((function*(){return p.resource("music-videos",e,n,d)}))()}musicVideos(e,n,d){var p=this;return _async_to_generator$p((function*(){return p.collection("music-videos",e,n,d)}))()}parseResultData(e,n){return e?this._store.write(n):this._store.parse(n)}playlist(e,n,d){var p=this;return _async_to_generator$p((function*(){return n=_object_spread$g({include:"tracks"},n),p.resource("playlists",e,n,d)}))()}createCatalogPlaylist(e,n,d){var p=this;return _async_to_generator$p((function*(){return d=_object_spread$g({method:"POST"},d),p.resource(`playlists/${e}/catalog`,void 0,n,d)}))()}playlistRelationship(e,n="tracks",d,p){var h=this;return _async_to_generator$p((function*(){return h.collection(`playlists/${e}/${n}`,void 0,d,p)}))()}playlists(e,n,d){var p=this;return _async_to_generator$p((function*(){let h;try{h=e&&e.length>0?yield Promise.all(e.map(e=>p.playlist(e,n,d))):yield p.collection("playlists",e,n,_object_spread_props$a(_object_spread$g({},d),{shouldCacheResults:!1}))}catch(St){if(!MKError.isMKError(St)||St.reason!==MKError.Reason.CONTENT_UNAVAILABLE)throw St;h={data:[],meta:{}}}return p._serverLedger.reconcile("playlists",h,e,n,d)}))()}recentlyAdded(e,n){var d=this;return _async_to_generator$p((function*(){const p=null==e?void 0:e.limit;let h;try{h=yield d.collection("recently-added",void 0,transformParameters(e,p||10),_object_spread_props$a(_object_spread$g({},n),{shouldCacheResults:!1}))}catch(St){if(!MKError.isMKError(St)||St.reason!==MKError.Reason.CONTENT_UNAVAILABLE)throw St;h={data:[],meta:{}}}return d._serverLedger.reconcile("all",h,void 0,e,n)}))()}search(e,n,d){var p=this;return _async_to_generator$p((function*(){n=p._denormalizeLibraryTypes(n);const h=_object_spread$g({term:e,types:"library-albums"},n);return p.collection("search",void 0,h,_object_spread_props$a(_object_spread$g({},d),{shouldCacheResults:!1}))}))()}song(e,n,d){var p=this;return _async_to_generator$p((function*(){return p.resource("songs",e,n,d)}))()}songRelationship(e,n,d,p){var h=this;return _async_to_generator$p((function*(){return h.collection(`songs/${e}/${n}`,void 0,d,p)}))()}songs(e,n,d){var p=this;return _async_to_generator$p((function*(){return p.collection("songs",e,n,d)}))()}collection(e,n,d,p){var h=this;return _async_to_generator$p((function*(){!n||n.length||d||(d=transformParameters(n,100),n=void 0);const y=n?_object_spread$g({ids:n},d):null!=d?d:{};return makeRequest(h,`${_o}/${e}`,y,p)}))()}resource(e,n,d,p){var h=this;return _async_to_generator$p((function*(){if(!(null==p?void 0:p.reload)){const p=h._store.read(e,n,d);if(p)return p}let y=`${_o}/${e}`;n&&(y=`${y}/${n}`);const[_]=yield makeRequest(h,y,d,p);return _}))()}purgePlaylistFromCaches(e){this._store.delete("library-playlists",e),this.networkCache.removeItemsMatching(buildURL(`${_o}/playlists/${e}`,{}),!1)}putPlaylistTracklisting(e,n,d="PUT"){var p=this;return _async_to_generator$p((function*(){const h=transformTrackParameters(n),y=JSON.stringify({data:h});try{yield p.request(`${_o}/playlists/${e}/tracks`,void 0,{body:y,method:d})}catch(he){return Promise.reject(MKError.responseError(he))}}))()}_denormalizeLibraryTypes(e={},n="types"){let d=e[n];return d?("string"==typeof d&&(d=d.split(",")),e[n]=d.map(e=>e.replace(/^(albums|music-videos|playlists|songs)$/,"library-$1")),e):e}constructor(e,n,d,p={},h,y){super(e,n,_object_spread_props$a(_object_spread$g({},y),{userToken:d})),_define_property$n(this,"_last",0),_define_property$n(this,"_store",void 0),_define_property$n(this,"defaultIncludePaginationMetadata",void 0),_define_property$n(this,"_serverLedger",void 0),this._store=new LocalDataStore(p),this._serverLedger=new ServerLedger(d,h),this.defaultIncludePaginationMetadata=p.features&&hasOwn(p.features,"api-pagination-metadata")}}function asyncGeneratorStep$o(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$o(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$o(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$o(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$m(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$f(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$m(e,n,d[n])}))}return e}function _object_spread_props$9(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_decorate$6(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$6(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([ChunkedIdApi(1),_ts_metadata$7("design:type",Function),_ts_metadata$7("design:paramtypes",[String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions]),_ts_metadata$7("design:returntype",Promise)],Library.prototype,"collection",null);var vo=function(e){return e[e.Global=0]="Global",e.Lyrics="lyrics",e.Catalog="catalog",e.Personalized="me",e.Editorial="editorial",e.Engagement="engagement",e.Social="social",e}(vo||{});class API extends TokenSession{activity(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","activities",e,n,d)}))()}activities(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","activities",e,n,d)}))()}album(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","albums",e,n,d)}))()}albumRelationship(e,n,d,p){var h=this;return _async_to_generator$o((function*(){return h.collection("catalog",`albums/${e}/${n}`,void 0,d,p)}))()}albums(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","albums",e,n,d)}))()}appleCurator(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","apple-curators",e,n,d)}))()}appleCurators(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","apple-curators",e,n,d)}))()}artist(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","artists",e,n,d)}))()}artistRelationship(e,n,d,p){var h=this;return _async_to_generator$o((function*(){return h.collection("catalog",`artists/${e}/${n}`,void 0,d,p)}))()}artistView(e,n,d,p){return this.collection("catalog",`artists/${e}/view/${n}`,void 0,d,p)}artists(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","artists",e,n,d)}))()}audioBook(e,n,d){return this.books.audioBook(e,n,d)}audioBooks(e,n,d){return this.books.audioBooks(e,n,d)}catalogResources(e,n={},d){const p=function(e){const n={};if(!e)return n;for(const d of e){if(!d)continue;const{type:e,id:p}=d;e in n||(n[e]=[]),n[e].push(p)}return n}(e);return n=_object_spread_props$9(_object_spread$f({},n),{ids:p}),makeRequest(this,"catalog/"+this.storefrontId,n,d)}changeStation(e,n,d={}){var p=this;return _async_to_generator$o((function*(){return yield makeRequest(p,"me/stations/change-station/"+e,n,_object_spread_props$9(_object_spread$f({},d),{reload:!0,method:"POST",shouldCacheResults:!1}))}))()}charts(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","charts",e,n,_object_spread_props$9(_object_spread$f({},d),{returnRawJSONApiRecords:!0}))}))()}contents(e,n,d){return this.collection("catalog","contents",e,n,d)}curator(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","contents",e,n,d)}))()}curators(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","contents",e,n,d)}))()}curatorRelationship(e,n,d,p){var h=this;return _async_to_generator$o((function*(){return h.collection("catalog",`curators/${e}/${n}`,void 0,d,p)}))()}episode(e,n,d){var p=this;return _async_to_generator$o((function*(){return p._podcastsAPI.catalogResource("podcast-episodes",e,n,d)}))()}episodes(e,n,d){var p=this;return _async_to_generator$o((function*(){return p._podcastsAPI.catalogResources("podcast-episodes",e,n,d)}))()}genre(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","genres",e,n,d)}))()}genres(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","genres",e,n,d)}))()}grouping(e,n,d){var p=this;return _async_to_generator$o((function*(){!n&&isObject$1(e)&&(n=e,e=void 0);const h=_object_spread$f({},{platform:"desktop"},n);return p.resource("editorial","groupings",e,h,_object_spread_props$9(_object_spread$f({},d),{shouldCacheResults:!1}))}))()}groupings(e,n={},d){var p=this;return _async_to_generator$o((function*(){const h=_object_spread$f({},{platform:"desktop"},n);return p.collection("editorial","groupings",e,h,_object_spread_props$9(_object_spread$f({},d),{shouldCacheResults:!1}))}))()}lyric(e,n,d){return this.resource("catalog",`songs/${e}/lyrics`,"",n,_object_spread$f({reload:!0},d))}lyricSnippet(e,n,d){return this.collection("lyrics","snippet/songs",e,n,_object_spread_props$9(_object_spread$f({},d),{returnRawJSONApiRecords:!0}))}historyHeavyRotation(e,n){var d=this;return _async_to_generator$o((function*(){return d.collection("me","history/heavy-rotation",void 0,transformParameters(e,10),n)}))()}multiplex(e,n,d){var p=this;return _async_to_generator$o((function*(){const h=p._store.read("multiplex",e,n);return h||(d=_object_spread$f({returnRawJSONApiRecords:!0},d),makeRequest(p,`editorial/${p.storefrontId}/multiplex/${e}`,n,d))}))()}multiroom(e,n,d){var p=this;return _async_to_generator$o((function*(){const h=p._store.read("multirooms",e,n);if(h)return h;const[y]=yield p.collection("editorial","multirooms/"+e,void 0,n,d);return y}))()}musicMovie(e,n,d){return this.resource("catalog","music-movies",e,n,d)}musicMovies(e,n,d){return this.collection("catalog","music-movies",e,n,d)}musicVideo(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","music-videos",e,n,d)}))()}musicVideos(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","music-videos",e,n,d)}))()}nextStationTracks(e,n,d={}){var p=this;return _async_to_generator$o((function*(){var h;const y=null!==(h=d.queryParameters)&&void 0!==h?h:{};(null==n?void 0:n.clean)&&(y.clean=n.clean,delete n.clean),(null==n?void 0:n.limit)&&(y.limit=n.limit,delete n.limit);return yield makeRequest(p,"me/stations/next-tracks/"+e,n,_object_spread_props$9(_object_spread$f({},d),{reload:!0,method:"POST",queryParameters:y,shouldCacheResults:!1}))}))()}continuousStation(e,n,d={}){var p=this;return _async_to_generator$o((function*(){return yield makeRequest(p,"me/stations/continuous",e,_object_spread_props$9(_object_spread$f({},d),{reload:!0,method:"POST",queryParameters:n,returnRawJSONApiRecords:!0,shouldCacheResults:!1}))}))()}playlist(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","playlists",e,n,d)}))()}playlistRelationship(e,n,d,p){var h=this;return _async_to_generator$o((function*(){return h.collection("catalog",`playlists/${e}/${n}`,void 0,d,p)}))()}playlists(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("catalog","playlists",e,n,d)}))()}podcast(e,n,d){var p=this;return _async_to_generator$o((function*(){return p._podcastsAPI.catalogResource("podcasts",e,_object_spread$f({include:"episodes"},n),d)}))()}podcastRelationship(e,n,d,p){var h=this;return _async_to_generator$o((function*(){return h._podcastsAPI.catalogResourceRelationship("podcasts",e,n,d,p)}))()}podcasts(e,n,d){var p=this;return _async_to_generator$o((function*(){return p._podcastsAPI.catalogResources("podcasts",e,_object_spread$f({include:"episodes"},n),d)}))()}recentPlayed(e,n){var d=this;return _async_to_generator$o((function*(){return d.collection("me","recent/played",void 0,transformParameters(e,10),n)}))()}recentRadioStations(e,n){var d=this;return _async_to_generator$o((function*(){return d.collection("me","recent/radio-stations",void 0,transformParameters(e,10),n)}))()}recordLabel(e,n,d){return this.resource("catalog","record-labels",e,n,d)}recordLabels(e,n,d){return this.collection("catalog","record-labels",e,n,d)}recordLabelView(e,n,d,p){return this.collection("catalog",`record-labels/${e}/view/${n}`,void 0,d,p)}personalRecommendation(e,n,d,p=!0){var h=this;return _async_to_generator$o((function*(){const y=yield h.personalRecommendations(e,n,d,p),[_]=y;return _}))()}refreshPersonalRecommendation(e,n,d){return n=_object_spread$f({timezone:formatTimezoneOffset()},n),d=_object_spread_props$9(_object_spread$f({},d),{method:"POST",queryParameters:n}),this.resource("me","recommendations",e,void 0,d)}personalRecommendations(e,n,d={},p=!0){var h=this;return _async_to_generator$o((function*(){const y=formatTimezoneOffset(),_=yield h.collection("me","recommendations",e,_object_spread$f({timezone:y},n),_object_spread_props$9(_object_spread$f({},d),{shouldCacheResults:p,returnRawJSONApiRecords:!0}));h._reindexRelationships(_,"recommendations");try{return mapRequestResult(_,e=>h.parseResultData(!1,e))}catch(he){return Promise.reject(MKError.parseError(he))}}))()}personalRecommendationView(e,n,d,p={}){var h=this;return _async_to_generator$o((function*(){return h.collection("me",`recommendations/${e}/view/${n}`,void 0,d,p)}))()}recommendations(e,n,d={}){var p=this;return _async_to_generator$o((function*(){const h=formatTimezoneOffset(),y=yield p.collection(0,"recommendations/"+p.storefrontId,e,_object_spread$f({timezone:h},n),_object_spread_props$9(_object_spread$f({},d),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}));p._reindexRelationships(y,"recommendations");try{return mapRequestResult(y,e=>p.parseResultData(!1,e))}catch(he){return Promise.reject(MKError.parseError(he))}}))()}recommendedFriends(e,n,d={}){return d=_object_spread_props$9(_object_spread$f({},d),{method:"POST",body:JSON.stringify(_object_spread$f({ids:{socialProfiles:e}},d.body))}),this.collection(0,"social/recommended-friends",void 0,n,_object_spread_props$9(_object_spread$f({},d),{shouldCacheResults:!1,returnRawJSONApiRecords:!0}))}room(e,n,d){var p=this;return _async_to_generator$o((function*(){const h=p._store.read("rooms",e,n);if(h&&h.hasAttributes("title"))return h;const y=yield p.collection("editorial","rooms/"+e,void 0,n,d),[_]=y;return _}))()}roomContents(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection("editorial",`rooms/${e}/contents`,void 0,n,d)}))()}search(e,n,d){var p=this;return _async_to_generator$o((function*(){const h=_object_spread$f({term:e},n);return d=_object_spread_props$9(_object_spread$f({},d),{useRawResponse:!0}),p.collection("catalog","search",void 0,h,_object_spread_props$9(_object_spread$f({},d),{shouldCacheResults:!1}))}))()}searchHints(e,n,d){var p=this;return _async_to_generator$o((function*(){const h=_object_spread$f({term:e},n),y=yield p.collection("catalog","search/hints",void 0,h,_object_spread_props$9(_object_spread$f({},d),{returnRawJSONApiRecords:!0}));return"topResults"===(null==h?void 0:h.with)&&"topResults"in y&&(y.topResults=p.parseResultData(!0,y.topResults)),y}))()}searchQuery(e,n){var d=this;return _async_to_generator$o((function*(){return n=_object_spread_props$9(_object_spread$f({},n),{useRawResponse:!0}),d.collection("catalog","search/query",void 0,e,_object_spread_props$9(_object_spread$f({},n),{shouldCacheResults:!1}))}))()}searchSuggestions(e,n,d){var p=this;return _async_to_generator$o((function*(){n=_object_spread$f({term:e},n);const h=yield p.collection("catalog","search/suggestions",void 0,n,_object_spread_props$9(_object_spread$f({},d),{returnRawJSONApiRecords:!0}));return Array.isArray(null==h?void 0:h.suggestions)&&h.suggestions.forEach(e=>{"topResults"===e.kind&&(e.content=p.parseResultData(!0,[e.content])[0])}),h}))()}socialBadgingMap(e,n){return this.collection(0,"social/badging-map",void 0,e,_object_spread_props$9(_object_spread$f({},n),{returnRawJSONApiRecords:!0}))}socialProfile(e,n,d){return this.resource("social","social-profiles",e,n,d)}socialProfiles(e,n,d){return this.collection("social","social-profiles",e,n,d)}personalSocialProfile(e,n){return this.resource("me","social-profile",void 0,e,n)}socialPost(e,n={},d){var p=this;return _async_to_generator$o((function*(){e.startsWith("sa.")?n.filter={post:e}:n.ids=e;const[h]=yield p.collection("catalog","contents","",n,d);return h}))()}socialSearch(e,n={},d){var p=this;return _async_to_generator$o((function*(){return n=_object_spread_props$9(_object_spread$f({},n),{term:e}),p.collection("social","search",void 0,n,d)}))()}song(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","songs",e,n,d)}))()}songRelationship(e,n,d,p){var h=this;return _async_to_generator$o((function*(){return h.collection("catalog",`songs/${e}/${n}`,void 0,d,p)}))()}songs(e,n,d){var p=this;return _async_to_generator$o((function*(){return!n&&isObject$1(e)&&(n=e,e=void 0),p.collection("catalog","songs",e,n,d)}))()}tastePreferences(e,n){var d=this;return _async_to_generator$o((function*(){return d.collection("me","taste/taste-preferences",void 0,e,_object_spread_props$9(_object_spread$f({},n),{shouldCacheResults:!1}))}))()}saveTastePreferences(e){var n=this;return _async_to_generator$o((function*(){e=e.map(e=>e instanceof DataRecord?e.serialize().data:e);const d={method:"POST",body:JSON.stringify({data:e}),shouldCacheResults:!0};try{return yield makeRequest(n,"me/taste/taste-preferences",void 0,d)}catch(he){return MKError.isMKError(he)&&he.reason===MKError.Reason.CONTENT_UNAVAILABLE?[]:Promise.reject(MKError.parseError(he))}}))()}tvEpisode(e,n,d){return this.resource("catalog","tv-episodes",e,_object_spread$f({include:"seasons"},n),d)}tvEpisodes(e,n,d){return this.collection("catalog","tv-episodes",e,_object_spread$f({include:"seasons"},n),d)}tvSeason(e,n,d){return this.resource("catalog","tv-seasons",e,_object_spread$f({include:"episodes"},n),d)}tvSeasons(e,n,d){return this.collection("catalog","tv-seasons",e,_object_spread$f({include:"episodes"},n),d)}tvShow(e,n,d){return this.resource("catalog","tv-shows",e,n,d)}tvShows(e,n,d){return this.collection("catalog","tv-shows",e,n,d)}uploadedAudio(e,n,d){var p=this;return _async_to_generator$o((function*(){return n=_object_spread$f({include:"curator,artists"},n),p.resource("catalog","uploaded-audios",e,n,d)}))()}uploadedAudios(e,n,d){var p=this;return _async_to_generator$o((function*(){return n=_object_spread$f({include:"curator,artists"},n),p.collection("catalog","uploaded-audios",e,n,d)}))()}uploadedVideo(e,n,d){var p=this;return _async_to_generator$o((function*(){return n=_object_spread$f({include:"curator,artists"},n),p.resource("catalog","uploaded-videos",e,n,d)}))()}uploadedVideos(e,n,d){var p=this;return _async_to_generator$o((function*(){return n=_object_spread$f({include:"curator,artists"},n),p.collection("catalog","uploaded-videos",e,n,d)}))()}upsellMarketingItems(e,n){return this.collection("engagement","upsell/marketing-items",void 0,e,n)}station(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("catalog","stations",e,n,d)}))()}stations(e,n,d){var p=this;return _async_to_generator$o((function*(){return!n&&isObject$1(e)&&(n=e,e=void 0),p.collection("catalog","stations",e,n,d)}))()}storefront(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource(0,"storefronts",e,n,d)}))()}storefronts(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.collection(0,"storefronts",e,n,d)}))()}musicSummary(e,n,d){var p=this;return _async_to_generator$o((function*(){return p.resource("me","music-summaries",e,n,d)}))()}musicSummarySearch(e={},n){var d=this;return _async_to_generator$o((function*(){return d.collection("me","music-summaries/search",void 0,e,n)}))()}addToLibrary(e){var n=this;return _async_to_generator$o((function*(){return n.developerToken&&n.userToken&&n.library?n.library.add(e):Promise.reject("Invalid tokens")}))()}rating(e,n,d){var p=this;return _async_to_generator$o((function*(){const[h]=yield p.ratings(e,n,d);return h}))()}ratings(e,n,d){if(!this.developerToken||!this.userToken)return Promise.reject("Invalid tokens");const[p]=Object.keys(e),h=e[p],y=Array.isArray(h);if(y&&0===h.length)return Promise.resolve([]);let _="me/ratings/"+formatRatingsContentType(p,y?h[0]:h);return y?n=_object_spread_props$9(_object_spread$f({},n),{ids:h.map(normalizeAdamId)}):_=`${_}/${normalizeAdamId(h)}`,makeRequest(this,_,n,_object_spread$f({shouldCacheResults:!1,reload:!0,includePagination:!1},d))}putRating(e,n,d){var p=this;return _async_to_generator$o((function*(){if(!p.developerToken||!p.userToken)return Promise.reject("Invalid tokens");const[h]=Object.keys(e),y=e[h],_=formatRatingsContentType(h,y),m={method:"PUT",body:JSON.stringify({type:"rating",attributes:{value:n}}),includePagination:!1},g=yield makeRequest(p,`me/ratings/${_}/${normalizeAdamId(y)}`,d,_object_spread$f({shouldCacheResults:!1},m)),[b]=g;return b}))()}deleteRating(e,n){var d=this;return _async_to_generator$o((function*(){if(!d.developerToken||!d.userToken)return Promise.reject("Invalid tokens");const[p]=Object.keys(e),h=e[p],y=formatRatingsContentType(p,h);if(Array.isArray(h))return Promise.all(h.map(e=>d.deleteRating({[p]:e},n))).then(()=>{});yield makeRequest(d,`me/ratings/${y}/${h}`,n,{method:"DELETE",shouldCacheResults:!1,returnRawJSONApiRecords:!0});try{d._store.delete(y,h)}catch(he){return Promise.reject(MKError.parseError(he))}}))()}equivalent(e,n){var d=this;return _async_to_generator$o((function*(){let p=`catalog/${d.userStorefrontId}/${e}`,h={};switch(e){case"albums":case"songs":h={"filter[equivalents]":n};break;case"artists":case"playlists":p=`${p}/${n}`;break;default:return Promise.reject(new MKError(MKError.Reason.INVALID_ARGUMENTS,"Invalid equivalent type"))}return d.resource(0,p,"",h)}))()}collection(e,n,d,p,h){var y=this;return _async_to_generator$o((function*(){let _,m,g=null==h?void 0:h.shouldCacheResults;switch(_=d?_object_spread$f({["charts"===n?"types":"ids"]:d},p):p,e){case"catalog":case"editorial":case"engagement":case"social":case"lyrics":const d=y.storefrontId;m=`${e}/${d}/${n}`;break;case 0:m=n;break;case"me":m=`${e}/${n}`,g=!1}return makeRequest(y,m,_,_object_spread_props$9(_object_spread$f({},h),{shouldCacheResults:g}))}))()}parseResultData(e,n){return e?this._store.write(n):this._store.parse(n)}resource(e,n,d,p,h){var y=this;return _async_to_generator$o((function*(){if(!(null==h?void 0:h.reload)){const e=y._store.read(n,d,p);if(e)return e}const[_]=yield y.collection(e,n,d,p,h);return _}))()}_reindexRelationships(e,n){("data"in e?e.data:e).forEach(e=>{hasOwn(e,"relationships")&&hasOwn(e.relationships,n)&&hasOwn(e.relationships[n],"data")&&Array.isArray(e.relationships[n].data)&&e.relationships[n].data.forEach((e,n)=>{e.id=`${e.id}-${n}`})})}constructor(e,n,d,p,h,y,_={},m){super(e,n,_object_spread_props$9(_object_spread$f({},m),{userToken:p,storage:y})),_define_property$m(this,"_store",void 0),_define_property$m(this,"v3",void 0),_define_property$m(this,"storefrontId",Fe.ID),_define_property$m(this,"defaultIncludePaginationMetadata",void 0),_define_property$m(this,"resourceRelatives",{artists:{albums:{include:"tracks"},playlists:{include:"tracks"},songs:null}}),_define_property$m(this,"userStorefrontId",void 0),_define_property$m(this,"library",void 0),_define_property$m(this,"books",void 0),_define_property$m(this,"tvLibrary",void 0),_define_property$m(this,"_podcastsAPI",void 0),_define_property$m(this,"fitness",void 0),this.defaultIncludePaginationMetadata=_.features&&hasOwn(_.features,"api-pagination-metadata"),this._store=new LocalDataStore(_),d&&(this.storefrontId=d.toLowerCase()),p&&h&&(this.userStorefrontId=h.toLowerCase()),this._podcastsAPI=new Podcasts(n,p,d,y,_,_object_spread$f({},m)),this.fitness=new Fitness(n,p,d,y,_,_object_spread$f({},m)),this.tvLibrary=new TVLibrary(n,p,y,_,_object_spread$f({},m)),this.library=new Library(e,n,p,_,this,_object_spread$f({},m)),this.books=new Books(n,p,d,y,_,_object_spread$f({},m)),this.v3=new MediaAPIV3({developerToken:n,mediaUserToken:p,storefrontId:d,realmConfig:{music:{url:e.replace(/\/v[0-9]+(\/)?$/,"")}}})}}function asyncGeneratorStep$n(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$n(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$n(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$n(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$l(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}let mo;_ts_decorate$6([RecommendationUpdate(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions,void 0]),_ts_metadata$6("design:returntype",Promise)],API.prototype,"personalRecommendations",null),_ts_decorate$6([RecommendationUpdate(),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof MakeRequestOptions?Object:MakeRequestOptions]),_ts_metadata$6("design:returntype",Promise)],API.prototype,"recommendations",null),_ts_decorate$6([ChunkedIdApi(2),_ts_metadata$6("design:type",Function),_ts_metadata$6("design:paramtypes",[void 0===vo?Object:vo,String,Object,"undefined"==typeof QueryParameters?Object:QueryParameters,"undefined"==typeof InternalMakeRequestOptions?Object:InternalMakeRequestOptions]),_ts_metadata$6("design:returntype",Promise)],API.prototype,"collection",null);const go=function(){var e=_async_to_generator$n((function*(e,n=!1){if(mo&&!n){if(void 0===e.storefrontId||e.storefrontId===mo.storefrontId)return mo;mo.clear()}return mo=new MediaAPIService(e.dispatcher),yield mo.configure(e),mo}));return function(n){return e.apply(this,arguments)}}(),bo={album:{isPlural:!1,apiMethod:"album",relationshipMethod:{method:"albumRelationship",relationship:"tracks"}},albums:{isPlural:!0,apiMethod:"albums"},audioBook:{isPlural:!1,apiMethod:"audioBook"},audioBooks:{isPlural:!0,apiMethod:"audioBooks"},episode:{isPlural:!1,apiMethod:"episode"},episodes:{isPlural:!0,apiMethod:"episodes"},musicVideo:{isPlural:!1,apiMethod:"musicVideo"},musicVideos:{isPlural:!0,apiMethod:"musicVideos"},musicMovie:{isPlural:!1,apiMethod:"musicMovie"},musicMovies:{isPlural:!0,apiMethod:"musicMovies"},podcast:{isPlural:!1,apiMethod:"podcast"},podcasts:{isPlural:!0,apiMethod:"podcasts"},playlist:{isPlural:!1,apiMethod:"playlist",relationshipMethod:{method:"playlistRelationship",relationship:"tracks"}},playlists:{isPlural:!0,apiMethod:"playlists"},song:{isPlural:!1,apiMethod:"song"},songs:{isPlural:!0,apiMethod:"songs"},tvEpisode:{isPlural:!1,apiMethod:"tvEpisode"},tvEpisodes:{isPlural:!0,apiMethod:"tvEpisodes"},uploadedAudio:{isPlural:!1,apiMethod:"uploadedAudio"},uploadedAudios:{isPlural:!0,apiMethod:"uploadedAudios"},uploadedVideo:{isPlural:!1,apiMethod:"uploadedVideo"},uploadedVideos:{isPlural:!0,apiMethod:"uploadedVideos"}};class MediaAPIService{get isConfigured(){return void 0!==this._api}get api(){if(void 0===this._api)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"The API cannot be accessed before it is configured.");return this._api}get storefrontId(){return this.store&&this.store.storefrontId}configure(e){var n=this;return _async_to_generator$n((function*(){void 0!==e.store&&(n.store=e.store,[Oi.authorizationStatusDidChange,Oi.userTokenDidChange,Oi.storefrontIdentifierDidChange,Oi.storefrontCountryCodeDidChange].forEach(e=>{n.store.storekit.addEventListener(e,()=>n.resetAPI())}),n._initializeAPI(e))}))()}clear(){this.api&&this.api.clearNetworkCache&&this.api.clearNetworkCache()}getAPIForItem(e){var n=this;return _async_to_generator$n((function*(){return isLibraryType(e)?(yield n.store.authorize(),n.api.library||n.api):n.api}))()}resetAPI(){var e=this;return _async_to_generator$n((function*(){e.clear(),e._initializeAPI()}))()}_initializeAPI(e){if(void 0!==(null==e?void 0:e.api))return void(this._api=e.api);const n=e&&e.store||this.store;if(void 0===n)return;const d=Fi.features["api-session-storage"]?getSessionStorage():void 0,p=e&&e.storefrontId||n.storefrontId,h=new API(this.url,n.developerToken,p,n.storekit.userToken,n.storekit.storefrontCountryCode,d,Fi,null==e?void 0:e.sessionOptions);this._api=h.v3,this._api=h}_updateStorefrontId(e){var n=this;return _async_to_generator$n((function*(){n.api&&e===n.api.storefrontId||(yield n.configure({dispatcher:n._dispatcher,store:n.store,storefrontId:e}))}))()}constructor(e){var n=this;if(_define_property$l(this,"_dispatcher",void 0),_define_property$l(this,"namedQueueOptions",void 0),_define_property$l(this,"url",void 0),_define_property$l(this,"store",void 0),_define_property$l(this,"_api",void 0),this._dispatcher=e,!Fi.urls.mediaApi)throw new Error("bag.urls.mediaApi is not configured");this.url=Fi.urls.mediaApi,this.namedQueueOptions=bo,this._dispatcher.subscribe(ot.apiStorefrontChanged,function(){var e=_async_to_generator$n((function*(e,{storefrontId:d}){yield n._updateStorefrontId(d)}));return function(n,d){return e.apply(this,arguments)}}())}}function asyncGeneratorStep$m(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$m(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$m(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$m(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$k(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function configure$2(e){return _configure$2.apply(this,arguments)}function _configure$2(){return(_configure$2=_async_to_generator$m((function*(e){const n=new UTSClientService;return yield n.configure(e),n}))).apply(this,arguments)}class UTSClientService{get isConfigured(){return void 0!==this.api}configure(e){var n=this;return _async_to_generator$m((function*(){n.api=e.api}))()}clear(){}getAPIForItem(e){var n=this;return _async_to_generator$m((function*(){if(void 0===n.api)throw new Error("UTS has not been configured");return n.api}))()}constructor(){_define_property$k(this,"api",void 0),_define_property$k(this,"namedQueueOptions",{}),_define_property$k(this,"url","")}}var Po=function(e){return e.MEDIA_API="media-api",e.UTS_CLIENT="uts-client",e}({});const createMediaAPIServiceDescriptor=e=>{let n;var d;"api"in e?n={api:e.api}:n=null!==(d=e.configureOptions)&&void 0!==d?d:{};return{apiType:"media-api",options:n}};function asyncGeneratorStep$l(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$j(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$e(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$j(e,n,d[n])}))}return e}class APIServiceManager{get api(){return this.getApiByType(this._defaultAPI)}get apiService(){if(void 0!==this._defaultAPI)return this._apisByType[this._defaultAPI];Qe.error("There is no API instance configured")}get mediaAPI(){return this.getApiByType(Po.MEDIA_API)}get utsClient(){return this.getApiByType(Po.UTS_CLIENT)}getApiByType(e){let n;if(void 0!==e&&(n=this._apisByType[e]),void 0===n||void 0===n.api)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"There is no API instance configured for the requested type: "+e);return n.api}set defaultApiType(e){this._defaultAPI=e}registerAPIService(e){var n,d=this;return(n=function*(){const{apiType:n,options:p}=e,h={store:d.store,dispatcher:d._dispatcher};void 0===d._defaultAPI&&(d._defaultAPI=n),n===Po.MEDIA_API?d._apisByType[n]=yield go.call(d,_object_spread$e({},p,h)):n===Po.UTS_CLIENT&&(d._apisByType[n]=yield configure$2.call(d,_object_spread$e({},p,h)))},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$l(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$l(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}constructor(e,n){_define_property$j(this,"store",void 0),_define_property$j(this,"_dispatcher",void 0),_define_property$j(this,"_apisByType",void 0),_define_property$j(this,"_defaultAPI",void 0),this.store=e,this._dispatcher=n,this._apisByType={}}}const So={};function adaptAddEventListener(e,n,d,p={}){const{once:h}=p,y=function(e,n){const d=getCallbacksForName(e),wrappedCallback=(e,d)=>{n(d)};return d.push([n,wrappedCallback]),wrappedCallback}(n,d);!0===h?e.subscribeOnce(n,y):e.subscribe(n,y)}function getCallbacksForName(e){let n=So[e];return n||(n=[],So[e]=n),n}function asyncGeneratorStep$k(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$k(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$k(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$k(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$i(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const To=Qe.createChild("rtc");class RTCStreamingTracker{get isConfigured(){return void 0!==this.instance}configure(e){var n=this;return _async_to_generator$k((function*(){n.instance=e.instance}))()}handleEvent(e,n,d){}loadScript(){return _async_to_generator$k((function*(){if(!Fi.urls.rtc)throw new Error("bag.urls.rtc is not configured");yield loadScript(Fi.urls.rtc)}))()}prepareReportingAgent(e){this.clearReportingAgent();const{Sender:n,ClientName:d,ServiceName:p,ApplicationName:h,ReportingStoreBag:y,DeviceName:_}=window.rtc.RTCReportingAgentConfigKeys;e=null!=e?e:this.instance.nowPlayingItem;const m=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$i(e,n,d[n])}))}return e}({firmwareVersion:this.generateBrowserVersion(),model:this.options.browserName},this.getMediaIdentifiers(e));void 0===this._storeBag&&(this._storeBag=this.generateStoreBag());const g={[n]:"HLSJS",[d]:this.options.clientName,[p]:this.options.serviceName,[h]:this.options.applicationName,[y]:this._storeBag,[_]:this.options.osVersion,userInfoDict:m};return To.debug("RTC: creating reporting agent with config",g),this.reportingAgent=new window.rtc.RTCReportingAgent(g),To.debug("RTC: created reporting agent",this.reportingAgent),this.reportingAgent}cleanup(){var e=this;return _async_to_generator$k((function*(){e.clearReportingAgent()}))()}getMediaIdentifiers(e){const n=null==e?void 0:e.defaultPlayable;if(n){var d;const e={};return void 0!==(null===(d=n.mediaMetrics)||void 0===d?void 0:d.MediaIdentifier)&&(e.MediaIdentifier=n.mediaMetrics.MediaIdentifier),void 0!==n.channelId&&(e.ContentProvider=n.channelId),e}return"musicVideo"===(null==e?void 0:e.type)?{MediaIdentifier:"adamid="+e.id}:(null==e?void 0:e.isLiveVideoStation)?{MediaIdentifier:"raid="+e.id}:void 0}clearReportingAgent(){void 0!==this.reportingAgent&&(this.reportingAgent.destroy(),To.debug("RTC: called destroy on reporting agent",this.reportingAgent),this.reportingAgent=void 0)}generateBrowserVersion(){return this.options.browserMajorVersion?`${this.options.browserMajorVersion}.${this.options.browserMinorVersion||0}`:"unknown"}generateStoreBag(){var e;const{storeBagURL:n,clientName:d,applicationName:p,serviceName:h,browserName:y}=this.options,_={iTunesAppVersion:`${`${Fi.app.name}-${Fi.app.build}`}/${null===(e=this.instance)||void 0===e?void 0:e.version}`},m=new window.rtc.RTCStorebag.RTCReportingStoreBag(n,d,h,p,y,_);return To.debug("RTC: created store bag",m),m}constructor(e){_define_property$i(this,"options",void 0),_define_property$i(this,"reportingAgent",void 0),_define_property$i(this,"instance",void 0),_define_property$i(this,"currentMediaItem",void 0),_define_property$i(this,"_storeBag",void 0),_define_property$i(this,"requestedEvents",[]),this.options=e}}function asyncGeneratorStep$j(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$h(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$5(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$5(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class PlayActivityService{cleanup(){this.trackers.forEach(e=>{var n;return null===(n=e.cleanup)||void 0===n?void 0:n.call(e)}),this.clearIntention(),this.teardownListeners(),this.registeredEvents.clear()}configure(e){var n,d=this;return(n=function*(){d.cleanup(),d.registeredEvents=function(e){const n=[];for(const d of e)n.push(...d.requestedEvents);return new Set(n)}(d.trackers),d.setupListeners();try{yield Promise.all(d.trackers.map(n=>n.configure(e)))}catch(St){Qe.error("Error configuring a play activity service",St)}},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$j(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$j(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}getTrackerByType(e){return this.trackers.find(n=>n instanceof e)}handleEvent(e,n={}){const d=this.addIntention(e,n);e===ot.playerActivate&&(d.flush="boolean"==typeof n.isPlaying?!n.isPlaying:void 0);for(const p of this.trackers)p.handleEvent(e,d,n.item)}addIntention(e,n){if(![ot.playbackPause,ot.playbackStop].includes(e))return n;const d=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$h(e,n,d[n])}))}return e}({},this.lastUserIntent,this.lastApplicationIntent,n);return this.clearIntention(),d}clearIntention(){this.lastUserIntent=void 0,this.lastApplicationIntent=void 0}recordApplicationIntent(e,n){this.lastApplicationIntent=n}recordUserIntent(e,n){this.lastUserIntent=n}setupListeners(){this.registeredEvents.forEach(e=>{this.dispatcher.subscribe(e,this.handleEvent)}),this.dispatcher.subscribe(ot.userActivityIntent,this.recordUserIntent),this.dispatcher.subscribe(ot.applicationActivityIntent,this.recordApplicationIntent)}teardownListeners(){this.registeredEvents.forEach(e=>{this.dispatcher.unsubscribe(e,this.handleEvent)}),this.dispatcher.unsubscribe(ot.userActivityIntent,this.recordUserIntent),this.dispatcher.unsubscribe(ot.applicationActivityIntent,this.recordApplicationIntent)}constructor(e,n){_define_property$h(this,"dispatcher",void 0),_define_property$h(this,"trackers",void 0),_define_property$h(this,"registeredEvents",void 0),_define_property$h(this,"lastUserIntent",void 0),_define_property$h(this,"lastApplicationIntent",void 0),_define_property$h(this,"isConfigured",void 0),this.dispatcher=e,this.trackers=n,this.registeredEvents=new Set,this.isConfigured=!0}}function asyncGeneratorStep$i(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$i(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$i(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$i(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$g(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$b(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$g(e,n,d[n])}))}return e}function _object_spread_props$8(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function fetchRadioStationAssets(e,n){return _fetchRadioStationAssets.apply(this,arguments)}function _fetchRadioStationAssets(){return(_fetchRadioStationAssets=_async_to_generator$i((function*(e,n){const d=new Headers({Authorization:"Bearer "+n.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+n.mediaUserToken}),p=encodeQueryParameters(_object_spread_props$8(_object_spread$b({},e.playParams),{keyFormat:"web"})),h=`${Fi.urls.mediaApi}/play/assets?${p}`,y=yield fetch(h,{method:"GET",headers:d});if(500===y.status){const n=new MKError(MKError.Reason.SERVER_ERROR);throw n.data=e,n}if(403===y.status){let n;try{var _;n=yield y.json(),n=null==n||null===(_=n.errors)||void 0===_?void 0:_[0]}catch(St){}const d="40303"===(null==n?void 0:n.code)?MKError.Reason.SUBSCRIPTION_ERROR:MKError.Reason.ACCESS_DENIED;var m;const p=new MKError(d,null!==(m=null==n?void 0:n.title)&&void 0!==m?m:null==n?void 0:n.detail);throw p.data=e,p}if(!y.ok){const n=new MKError(MKError.Reason.CONTENT_UNAVAILABLE);throw n.data=e,n}const g=(yield y.json()).results;return Qe.debug(`media-item: loaded data from ${h}: ${JSON.stringify(g)}`),g}))).apply(this,arguments)}function asyncGeneratorStep$h(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$h(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$h(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$h(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function fetchMZPlayItem(e,n){return _fetchMZPlayItem.apply(this,arguments)}function _fetchMZPlayItem(){return(_fetchMZPlayItem=_async_to_generator$h((function*(e,n){const d=new Headers({Authorization:"Bearer "+n.developerToken,Accept:"application/json","Content-Type":"application/json","X-Apple-Music-User-Token":""+n.musicUserToken}),p=String(e.playParams.id),h=e.isLibraryItem?Object.fromEntries([["purchaseAdamId",e.playParams.purchasedId],["subscriptionAdamId",k(p)?p.slice(2):e.playParams.catalogId],["universalLibraryId",isLibraryType(p)?p:void 0]].filter((e,n)=>void 0!==n)):{salableAdamId:p},y=yield fetch(n.endpoint,{method:"POST",body:JSON.stringify(h),headers:d}),_=JSON.parse(yield y.text());if(void 0===(null==_?void 0:_.songList)||0===_.songList.length)throw MKError.serverError(_,MKError.Reason.UNSUPPORTED_ERROR);return _.songList[0]}))).apply(this,arguments)}function asyncGeneratorStep$g(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$g(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$g(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$g(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$f(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$a(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$f(e,n,d[n])}))}return e}function _object_spread_props$7(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[String,Object]),_ts_metadata$5("design:returntype",void 0)],PlayActivityService.prototype,"handleEvent",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[String,"undefined"==typeof ActivityIntention?Object:ActivityIntention]),_ts_metadata$5("design:returntype",void 0)],PlayActivityService.prototype,"recordApplicationIntent",null),_ts_decorate$5([Bind(),_ts_metadata$5("design:type",Function),_ts_metadata$5("design:paramtypes",[String,"undefined"==typeof ActivityIntention?Object:ActivityIntention]),_ts_metadata$5("design:returntype",void 0)],PlayActivityService.prototype,"recordUserIntent",null);const ko=BooleanDevFlag.get("mk-hlsjs-song-playback"),Eo=BooleanDevFlag.get("mk-hlsjs-enhanced-assets");function prepareMediaAPIItem(e,n){return _prepareMediaAPIItem.apply(this,arguments)}function _prepareMediaAPIItem(){return(_prepareMediaAPIItem=_async_to_generator$g((function*(e,n){var d;if(isEmptyString$1(null!==(d=n.developerToken)&&void 0!==d?d:""))throw new MKUniqueError("mk-124",MKUniqueError.Reason.CONFIGURATION_ERROR,{description:"Unable to prepare media item for play: missing developerToken.",data:e});if(void 0===n.mediaUserToken)throw new MKUniqueError("mk-125",MKUniqueError.Reason.AUTHORIZATION_ERROR,{description:"Unable to prepare media item for play: missing MusicUserToken.",data:e});e.hasOffersHlsUrl?yield prepareWithHLSOffers(e,n):e.isLiveVideoStation?yield prepareLiveVideoStation(e,n):e.isLiveRadioStation?yield prepareLiveRadioStation(e,n):e.isRadioEpisode?yield prepareRadioStationEpisode(e,n):"musicVideo"===e.type||"musicMovie"===e.type?yield prepareMusicVideo(e,n):"song"===e.type&&ko?yield prepareCatalogSong(e,n):yield prepareMZPlayItem(e,n)}))).apply(this,arguments)}function prepareWithHLSOffers(e,n){return _prepareWithHLSOffers.apply(this,arguments)}function _prepareWithHLSOffers(){return(_prepareWithHLSOffers=_async_to_generator$g((function*(e,n){var d,p;const h=Fi.urls.hlsOffersKeyUrls;if(!h)throw new MKUniqueError("mk-131",MKUniqueError.Reason.CONTENT_UNSUPPORTED,"HLS OFFERS");var y;updateItemPlaybackProperties(e,{playlist:null!==(y=null===(d=e.attributes)||void 0===d?void 0:d.assetUrl)&&void 0!==y?y:null===(p=e.attributes.offers)||void 0===p?void 0:p[0].hlsUrl,keyURLs:h})}))).apply(this,arguments)}function prepareRadioStationEpisode(e,n){return _prepareRadioStationEpisode.apply(this,arguments)}function _prepareRadioStationEpisode(){return(_prepareRadioStationEpisode=_async_to_generator$g((function*(e,n){const d=yield fetchRadioStationAssets(e,{developerToken:n.developerToken,mediaUserToken:n.mediaUserToken});if(void 0===d.assets||0===d.assets.length)throw new MKUniqueError("mk-126",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"Missing RadioStation assets",data:e});const p=d.assets[0];d.assets.length>1&&Qe.warn("RadioStation endpoint returned multiple assets"),Object.assign(e,{assetURL:p.url,keyURLs:{"hls-key-cert-url":p.fairPlayKeyCertificateUrl,"hls-key-server-url":p.keyServerUrl,"widevine-cert-url":p.widevineKeyCertificateUrl}})}))).apply(this,arguments)}function prepareLiveVideoStation(e,n){return _prepareLiveVideoStation.apply(this,arguments)}function _prepareLiveVideoStation(){return(_prepareLiveVideoStation=_async_to_generator$g((function*(e,n){const d=yield fetchRadioStationAssets(e,{developerToken:n.developerToken,mediaUserToken:n.mediaUserToken});if(void 0===d.assets||0===d.assets.length)throw new MKUniqueError("mk-127",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"Missing RadioStation assets",data:e});const p=d.assets[0];d.assets.length>1&&Qe.warn("RadioStation endpoint returned multiple assets"),Object.assign(e,{assetURL:p.url,keyURLs:{"hls-key-cert-url":p.fairPlayKeyCertificateUrl,"hls-key-server-url":p.keyServerUrl,"widevine-cert-url":p.widevineKeyCertificateUrl}})}))).apply(this,arguments)}function prepareLiveRadioStation(e,n){return _prepareLiveRadioStation.apply(this,arguments)}function _prepareLiveRadioStation(){return(_prepareLiveRadioStation=_async_to_generator$g((function*(e,n){const d=yield fetchRadioStationAssets(e,{developerToken:n.developerToken,mediaUserToken:n.mediaUserToken});if(void 0===d.assets||0===d.assets.length)throw new MKUniqueError("mk-128",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{description:"Missing Live Radio Station assets",data:e});const p=d.assets[0];d.assets.length>1&&Qe.warn("RadioStation endpoint returned multiple assets"),updateItemPlaybackProperties(e,{playlist:p.url,keyURLs:{"hls-key-cert-url":p.fairPlayKeyCertificateUrl,"hls-key-server-url":p.keyServerUrl,"widevine-cert-url":p.widevineKeyCertificateUrl}})}))).apply(this,arguments)}function prepareMusicVideo(e,n){return _prepareMusicVideo.apply(this,arguments)}function _prepareMusicVideo(){return(_prepareMusicVideo=_async_to_generator$g((function*(e,n){if(Qe.trace("prepareMusicVideo",e.playParams.id),!0!==n.subscription||void 0===n.mediaUserToken)return;if(!Fi.urls.webPlayback)throw new MKUniqueError("mk-129",MKUniqueError.Reason.CONFIGURATION_ERROR,{description:"bag.urls.webPlayback is not configured"});const d=yield fetchMZPlayItem(e,{endpoint:Fi.urls.webPlayback,developerToken:n.developerToken,musicUserToken:n.mediaUserToken});updateItemPlaybackProperties(e,{songId:d.songId,playlist:d["hls-playlist-url"],keyURLs:{"hls-key-cert-url":d["hls-key-cert-url"],"hls-key-server-url":d["hls-key-server-url"],"widevine-cert-url":d["widevine-cert-url"]}})}))).apply(this,arguments)}function prepareCatalogSong(e,n){return _prepareCatalogSong.apply(this,arguments)}function _prepareCatalogSong(){return(_prepareCatalogSong=_async_to_generator$g((function*(e,n){var d;const{request:p}=n.services;var h;const y=p.buildURL(Fi.urls.mediaApi,"/play/assets",_object_spread$a(_object_spread_props$7(_object_spread$a({},e.playParams),{includeLicenseUrls:!0,hlsEncryption:null!==(h=n.hlsEncryption)&&void 0!==h?h:"CBC"}),Eo?{hlsProfile:"enhancedHls"}:{})),_=p.buildHeaders({Authorization:"Bearer "+n.developerToken,"X-Apple-Music-User-Token":n.mediaUserToken}),{results:m}=yield p.fetchJSON(p.buildRequest(y,{headers:_}));if(void 0===m||(null===(d=m.assets)||void 0===d?void 0:d.length)<=0)throw new MKUniqueError("mk-130",MKUniqueError.Reason.CONTENT_UNAVAILABLE,{data:e});const g=m.assets[0];updateItemPlaybackProperties(e,{playlist:g.url,keyURLs:{"hls-key-cert-url":g.fairPlayKeyCertificateUrl,"hls-key-server-url":g.keyServerUrl,"widevine-cert-url":g.widevineKeyCertificateUrl}})}))).apply(this,arguments)}function prepareMZPlayItem(e,n){return _prepareMZPlayItem.apply(this,arguments)}function _prepareMZPlayItem(){return(_prepareMZPlayItem=_async_to_generator$g((function*(e,n){if(Qe.trace("prepareItemWithMZPlay",e),!0!==n.subscription||void 0===n.mediaUserToken)return;if(!Fi.urls.webPlayback)throw new Error("bag.urls.webPlayback is not configured");const d=yield fetchMZPlayItem(e,{endpoint:Fi.urls.webPlayback,developerToken:n.developerToken,musicUserToken:n.mediaUserToken});updateItemPlaybackProperties(e,{songId:d.songId,keyURLs:{"hls-key-cert-url":d["hls-key-cert-url"],"hls-key-server-url":d["hls-key-server-url"],"widevine-cert-url":d["widevine-cert-url"]},assets:d.assets})}))).apply(this,arguments)}function updateItemPlaybackProperties(e,n){return void 0!==n.songId&&(e.songId=String(n.songId)),void 0!==n.keyURLs&&(e.keyURLs=n.keyURLs),void 0!==n.playlist&&(e.assetURL=String(n.playlist)),void 0!==n.assets&&(e.assets=n.assets),e}function asyncGeneratorStep$f(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$f(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$f(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$f(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _prepareForEncryptedPlayback(){return(_prepareForEncryptedPlayback=_async_to_generator$f((function*(e,n){var d,p;if(Qe.trace("prepareForEncryptedPlayback()",e),e.isUTS||e.isPreparedToPlay)return Qe.warn("MediaItem is already prepared to play: "+e),e;const{store:h,request:y}=n.services;if(!((null===(d=h.storekit)||void 0===d?void 0:d.hasAuthorized)&&(null===(p=h.storekit)||void 0===p?void 0:p.userTokenIsValid)))return Promise.reject(new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unable to prepare for playback."));try{var _;e.state=oe.loading,yield prepareMediaAPIItem(e,{services:{request:y},developerToken:h.developerToken,mediaUserToken:h.musicUserToken,subscription:null!==(_=yield h.storekit.hasMusicSubscription())&&void 0!==_&&_})}catch(he){if(he.reason===MKError.Reason.AUTHORIZATION_ERROR)yield h.storekit.revokeUserToken();else if(he.reason===MKError.Reason.TOKEN_EXPIRED)try{return yield h.storekit.renewUserToken(),yield prepareMediaAPIItem(e,{services:{request:y},developerToken:h.developerToken,mediaUserToken:h.musicUserToken,subscription:yield h.storekit.hasMusicSubscription()}),e.playbackData=_playbackDataForItem(e,n),e}catch(St){}if(he)return e.state=oe.error,Promise.reject(he)}return e.playbackData=_playbackDataForItem(e,n),e}))).apply(this,arguments)}function _playbackDataForItem(e,n){if(Qe.trace("_playbackDataForItem()",e),e.isCloudUpload)return e.assets[0];if("musicVideo"!==e.type&&!e.isLiveVideoStation){if(!e.isLiveRadioStation){const{runtime:d}=n.services,p=d.availableKeySystems.includes("fairplay"),h=new RegExp(`\\d{1,2}\\:(${p?"cbcp":"ctrp"})(\\d{2,3})`,"i"),[y]=e.assets.filter(e=>{if(!("flavor"in e))return!1;const d=h.test(e.flavor);var p;const y=null!==(p=e.flavor.match(h))&&void 0!==p?p:[];return d&&parseInt(y[2],10)<=n.bitrate});return y}{var d;const p=e.assets.reduce((e,n)=>{const d=n.bandwidth;return e[d]||(e[d]=[]),e[d].push(n),e},{}),h=Object.keys(p).sort((e,n)=>parseInt(e,10)-parseInt(n,10)),y=n.bitrate===it.STANDARD?h[0]:h[h.length-1];(null==p||null===(d=p[y])||void 0===d?void 0:d[0].URL)&&(e.assetURL=p[y][0].URL)}}}function asyncGeneratorStep$e(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$e(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$e(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$e(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$e(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$4(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$4(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const{playbackLicenseError:wo}=Wr,{keySystemGenericError:Oo}=ci,Io=tt.createChild("playback"),$o=BooleanDevFlag.register("mk-broadcast-radio-playback"),Ao=function(){var e=_async_to_generator$e((function*(e,n){var d,p;if(null===(p=e.container)||void 0===p||null===(d=p.attributes)||void 0===d?void 0:d.requiresSubscription){if(!(yield n())){const n=new MKError(MKError.Reason.SUBSCRIPTION_ERROR);throw n.data=e,n}}}));return function(n,d){return e.apply(this,arguments)}}();let Ro=!1;class MediaItemPlayback{get isDestroyed(){return this._isDestroyed}get bitrateCalculator(){return this.services.bitrateCalculator}get dispatcher(){return this.services.dispatcher}get playerManager(){return this.services.player}get manifestManager(){return this.services.manifest}get currentPlaybackTime(){return this._currentPlayer.currentPlaybackTime}get currentPlaybackTimeRemaining(){return this._currentPlayer.currentPlaybackTimeRemaining}get currentPlayingDate(){return this._currentPlayer.currentPlayingDate}get isPlayingAtLiveEdge(){return this._currentPlayer.isPlayingAtLiveEdge}get seekableTimeRanges(){return this._currentPlayer.seekableTimeRanges}get audioTracks(){return this._currentPlayer.audioTracks}get currentAudioTrack(){return this._currentPlayer.currentAudioTrack}set currentAudioTrack(e){this._currentPlayer.currentAudioTrack=e}get currentPlaybackDuration(){return this._currentPlayer.currentPlaybackDuration}get currentBufferedProgress(){return this._currentPlayer.currentBufferedProgress}get currentPlaybackProgress(){return this._currentPlayer.currentPlaybackProgress}get currentTextTrack(){return this._currentPlayer.currentTextTrack}set currentTextTrack(e){this._currentPlayer.currentTextTrack=e}get previewOnly(){return this._previewOnly}set previewOnly(e){this._previewOnly=e}get isPlaying(){return this._currentPlayer.isPlaying}get isPrimaryPlayer(){return this._currentPlayer.isPrimaryPlayer}set isPrimaryPlayer(e){this._currentPlayer.isPrimaryPlayer=e}get isReady(){return this._currentPlayer.isReady}get nowPlayingItem(){return this._currentPlayer.nowPlayingItem}get currentTimedMetadata(){return this._currentTimedMetadata}get playbackRate(){return this._currentPlayer.playbackRate}set playbackRate(e){this._updatePlayerState("playbackRate",e)}get defaultPlaybackRate(){return this._currentPlayer.defaultPlaybackRate}set defaultPlaybackRate(e){this._updatePlayerState("defaultPlaybackRate",e)}get playbackState(){return this._currentPlayer.playbackState}set playbackState(e){this._currentPlayer.setPlaybackState(e,this.nowPlayingItem)}get playbackTargetAvailable(){return this._currentPlayer.playbackTargetAvailable}get playbackTargetIsWireless(){return this._currentPlayer.playbackTargetIsWireless}get supportsPreviewImages(){return this._currentPlayer.supportsPreviewImages}get textTracks(){return this._currentPlayer.textTracks}get volume(){return this._currentPlayer.volume}set volume(e){this._currentPlayer.isDestroyed&&this.dispatcher.publish(at.playbackVolumeDidChange,{}),this._updatePlayerState("volume",e)}clearNextManifest(){this._currentPlayer.clearNextManifest()}destroy(){var e;this._currentTimedMetadata=void 0,this._isDestroyed=!0,this.playerManager.destroy(),this.dispatcher.unsubscribe(wo,this.onPlaybackLicenseError),this.dispatcher.unsubscribe(Oo,this.onKeySystemGenericError),null===(e=this.dispatcher)||void 0===e||e.unsubscribe(Oo,this.onBufferTimedMetadataDidChange)}exitFullscreen(){return this._currentPlayer.exitFullscreen()}loadPreviewImage(e){var n=this;return _async_to_generator$e((function*(){return n._currentPlayer.loadPreviewImage(e)}))()}getNewSeeker(){return this._currentPlayer.newSeeker()}mute(){this._volumeAtMute=this.volume,this.volume=0}pause(e){var n=this;return _async_to_generator$e((function*(){return n._currentPlayer.pause(e)}))()}play(){var e=this;return _async_to_generator$e((function*(){return e._currentPlayer.play()}))()}preload(){var e=this;return _async_to_generator$e((function*(){return e._currentPlayer.preload()}))()}prepareToPlay(e){var n=this;return _async_to_generator$e((function*(){if(Io.trace("MediaItemPlayback.prepareToPlay",e),function(e){var n,d;const p=null!==(d=null==e||null===(n=e.attributes)||void 0===n?void 0:n.offers)&&void 0!==d?d:[];return isPodcastEpisode(e)&&p.some(({type:e})=>"STDQ"===e||"PLUS"===e)}(e))return void Io.info("Free podcast episode, not preparing item: "+e,e);if(yield n.shouldPlayPreview(e))return void Io.info(`Not preparing MediaItem ${e.id} (${e.info}): preview playback only`,e);Io.info("Preparing MediaItem: "+mediaItemLogString(e),e);const d=yield n.prepareForEncryptedPlayback(e,{bitrate:n.bitrateCalculator.bitrate});return Io.info(`Calling ${n._currentPlayer.constructor.name}.preloadItem for ${mediaItemLogString(e)}`),yield n._currentPlayer.preloadItem(e,n.playOptions.get(e.id)),d}))()}requestFullscreen(e){return this._currentPlayer.requestFullscreen(e)}showPlaybackTargetPicker(){this._currentPlayer.showPlaybackTargetPicker()}seekToTime(e,n=ut.Manual){var d=this;return _async_to_generator$e((function*(){yield d._currentPlayer.seekToTime(e,n)}))()}setPresentationMode(e){var n=this;return _async_to_generator$e((function*(){return n._currentPlayer.setPresentationMode(e)}))()}startMediaItemPlayback(e,n=!1){var d=this;return _async_to_generator$e((function*(){var p;Io.trace("MediaItemPlayback.startMediaItemPlayback",e),d._currentTimedMetadata=void 0,e.resetState(),((e,n)=>{const{os:d}=n;if(e.isLinearStream&&("ios"===d.name||"ipados"===d.name)){Io.warn("Cannot play linear stream on iOS or iPad");const n=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"IOS LINEAR");throw n.data={item:e},n}})(e,d.services.runtime),((e,n)=>{const{isMSESupported:d,isMMSSupported:p}=n;if(e.hasOffersHlsUrl&&!d&&!p){Io.warn("HLSjs is not supported");const n=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"HLSjs Unsupported on Device");throw n.data={item:e},n}})(e,d.services.runtime),yield Ao(e,d.hasMusicSubscription);const h=d.playOptions.get(e.id);h&&d.playOptions.delete(e.id);const y=yield d.playerManager.createPlayer(e,{playerOptions:d.playerOptions,playOptions:h});if(yield d.setCurrentPlayer(y),!(null===(p=d._currentPlayer)||void 0===p?void 0:p.hasMediaElement))return Io.warn(`MediaItemPlayback: Could not play media of type ${e.type}, marking item as unsupported and skipping.`),void e.notSupported();try{e.beginMonitoringStateDidChange(e=>d.dispatcher.publish(I.mediaItemStateDidChange,e)),e.beginMonitoringStateWillChange(e=>d.dispatcher.publish(I.mediaItemStateWillChange,e));const p=yield d._playAccordingToPlaybackType(e,n,h);return d._currentPlayback={item:e,userInitiated:n},p}catch(he){throw e.updateFromLoadError(he),Io.error(he.message,he),he}}))()}_playAccordingToPlaybackType(e,n,d){var p=this;return _async_to_generator$e((function*(){var h;if(Io.trace("MediaItemPlayback._playAccordingToPlaybackType()",e,d),yield p.shouldPlayPreview(e))return p._playPreview(e,n);if(!isEmptyString$1(null!==(h=e.rawAssetUrl)&&void 0!==h?h:""))return p._playRawAsset(e,n,d);if(function(e){return isLive(e)&&isStream$1(e)&&void 0!==e.attributes.stationProviderName&&"Shoutcast"===e.attributes.streamingRadioSubType}(e))return p._playBroadcastRadio(e,n);const{runtime:y}=p.services;if(!y.isDRMAvailable){const n=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"NO DRM");throw n.data={item:e},Io.warn("No DRM detected"),n}return p._playEncryptedFull(e,n,d)}))()}_playEncryptedFull(e,n,d){var p=this;return _async_to_generator$e((function*(){if(Io.trace("MediaItemPlayback._playEncryptedFull()",e),!e||!e.isPlayable)return Promise.reject(new MKError(MKError.Reason.MEDIA_PLAYBACK,"Not Playable"));const h=p._currentPlayer;try{Io.debug("Preparing Item for Encrypted Playback: "+mediaItemLogString(e),e),yield p.prepareForEncryptedPlayback(e,{bitrate:p.bitrateCalculator.bitrate})}catch(he){return Io.error("prepareForEncryptedPlayback Error: userInitiated "+n),n?(h.destroy(),Promise.reject(he)):(h.dispatch(at.mediaPlaybackError,he),void h.destroy())}return Io.debug("Fetching Playlist Metadata for "+mediaItemLogString(e)),yield Ni(e,{manifestManager:p.manifestManager,playOptions:d}),Io.debug("Initiating Encrypted Playback for "+mediaItemLogString(e),e),yield h.playItemFromEncryptedSource(e,n,d),e}))()}_playBroadcastRadio(e,n){var d=this;return _async_to_generator$e((function*(){if(Io.debug("MediaItemPlayback: play broadcast radio",e),!$o.enabled){const n=new MKError(MKError.Reason.CONTENT_UNAVAILABLE);throw n.data=e,n}const p=d._currentPlayer,h=p.isPaused()&&!n,y=(yield fetchRadioStationAssets(e,{developerToken:gn.developerToken,mediaUserToken:gn.musicUserToken})).assets[0];return e.playbackType=ie.unencryptedFull,p.nowPlayingItem=e,yield p.playItemFromUnencryptedSource(y.url,h),e}))()}_playRawAsset(e,n,d){var p=this;return _async_to_generator$e((function*(){Io.debug("MediaItemPlayback: play raw asset",e);const h=p._currentPlayer,y=h.isPaused()&&!n;return e.playbackType=ie.unencryptedFull,h.nowPlayingItem=e,yield h.playItemFromUnencryptedSource(e.rawAssetUrl,y,d),e}))()}_playPreview(e,n){var d=this;return _async_to_generator$e((function*(){Io.debug("MediaItemPlayback: play preview",e);const p=d._currentPlayer,h=p.isPaused()&&!n;return d.services.runtime.isDRMAvailable||p.dispatch(at.drmUnsupported,{item:e}),e.playbackType=ie.preview,p.nowPlayingItem=e,yield p.playItemFromUnencryptedSource(e.previewURL,h),e}))()}stop(e){var n=this;return _async_to_generator$e((function*(){yield n._currentPlayer.stop(e)}))()}unmute(){this.volume>0||(this.volume=this._volumeAtMute||1,this._volumeAtMute=void 0)}setCurrentPlayer(e){var n=this;return _async_to_generator$e((function*(){return n._currentPlayer===e||(Io.debug("MediaItemPlayback: setting currentPlayer",e),yield n._currentPlayer.stop(),n._currentPlayer=e,Io.trace("Applying default player state",e,n.playerState),Object.assign(e,n.playerState),n.dispatcher.publish(at.playerTypeDidChange,{player:e})),e}))()}getCurrentPlayer(){return this._currentPlayer}onKeySystemGenericError(e,n){var d=this;return _async_to_generator$e((function*(){Ro?d.dispatcher.publish(at.mediaPlaybackError,n):(Ro=!0,Io.warn("Retrying playback after keysystemGenericError"),yield d.restartPlayback())}))()}onBufferTimedMetadataDidChange(e,n){this._currentTimedMetadata=n.metadata}onPlaybackLicenseError(e,n){var d=this;return _async_to_generator$e((function*(){d.dispatcher.publish(at.mediaPlaybackError,n)}))()}restartPlayback(){var e=this;return _async_to_generator$e((function*(){yield e.stop();const{_currentPlayback:n}=e;if(n){const{item:d,userInitiated:p}=n;d.resetState(),yield e.startMediaItemPlayback(d,p)}}))()}shouldPlayPreview(e){var n=this;return _async_to_generator$e((function*(){var d,p;if(isEmptyString$1(null!==(d=e.previewURL)&&void 0!==d?d:""))return!1;if(n.previewOnly||!e.isPlayable)return!0;if(!isEmptyString$1(null!==(p=e.rawAssetUrl)&&void 0!==p?p:""))return!1;const{storekit:h}=n.services.store;return!(h.hasAuthorized&&h.userTokenIsValid&&(yield h.hasMusicSubscription()))||!n.services.runtime.isDRMAvailable}))()}_updatePlayerState(e,n){this.playerState[e]=n,this._currentPlayer[e]=n}constructor(e){_define_property$e(this,"playerState",{defaultPlaybackRate:1,playbackRate:1,volume:1}),_define_property$e(this,"playOptions",new Map),_define_property$e(this,"hasMusicSubscription",void 0),_define_property$e(this,"prepareForEncryptedPlayback",void 0),_define_property$e(this,"_currentPlayer",void 0),_define_property$e(this,"services",void 0),_define_property$e(this,"_previewOnly",!1),_define_property$e(this,"_volumeAtMute",void 0),_define_property$e(this,"_currentPlayback",void 0),_define_property$e(this,"_isDestroyed",!1),_define_property$e(this,"_currentTimedMetadata",void 0),_define_property$e(this,"playerOptions",void 0),this.services=e.services,this.playerOptions=e.playerOptions;const{playbackServices:n}=e.playerOptions;this.hasMusicSubscription=n.hasMusicSubscription,this.prepareForEncryptedPlayback=n.prepareForEncryptedPlayback,function(e){gn=e}(this.playerOptions.tokens),this._currentPlayer=new PlayerStub(this.playerOptions),this.dispatcher.subscribe(wo,this.onPlaybackLicenseError),this.dispatcher.subscribe(Oo,this.onKeySystemGenericError),this.dispatcher.subscribe(xn,this.onBufferTimedMetadataDidChange)}}_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[String,Object]),_ts_metadata$4("design:returntype",Promise)],MediaItemPlayback.prototype,"onKeySystemGenericError",null),_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[String,Object]),_ts_metadata$4("design:returntype",void 0)],MediaItemPlayback.prototype,"onBufferTimedMetadataDidChange",null),_ts_decorate$4([Bind(),_ts_metadata$4("design:type",Function),_ts_metadata$4("design:paramtypes",[String,Object]),_ts_metadata$4("design:returntype",Promise)],MediaItemPlayback.prototype,"onPlaybackLicenseError",null);const Co=["artist","album","audioBook","episode","librarySong","movie","musicMovie","musicVideo","playlist","podcast","podcastEpisode","radioStation","song","station","trailer","tvEpisode","uploadedAudio","uploadedVideo"],Mo=["artists","albums","audioBooks","episodes","librarySongs","movies","musicVideos","musicMovies","playlists","podcasts","podcastEpisodes","radioStations","songs","stations","trailers","tvEpisodes","uploadedVideos","uploadedAudios"],Do=Qe.createChild("item-loader");function isMediaAPIResource(e){return void 0!==e&&"string"==typeof e.id&&"string"==typeof e.type&&void 0!==e.attributes}function convertToItemDescriptors(e){if(Object.keys(e).reduce((function(e,n){return"item"===n||"items"===n||"url"===n||"urls"===n||Co.includes(n)||Mo.includes(n)?e+1:e}),0)>1)throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Using multiple media kinds is not supported");return function(e){return null!=e&&void 0!==e.item}(e)?convertItemList([e.item]):function(e){return null!=e&&Array.isArray(e.items)}(e)?convertItemList(e.items):function(e){return null!=e&&"string"==typeof e.url}(e)?[convertURL(e.url)]:function(e){return null!=e&&Array.isArray(e.urls)}(e)?e.urls.map(e=>convertURL(e)):function(e){let n;const d=[];for(const _ of Object.keys(e)){const p=translateMediaAPIResource(_);isNamedOptionKey(_)&&(void 0===n?n=[p,e[_]]:d.push(_))}const[p,h]=null!=n?n:[];if(void 0===p||void 0===h)return[];d.length>0&&Do.warn(`Found redundant named options besides ${p}: ${d.join(", ")}`);const y=singularizeMediaType(p);return Array.isArray(h)?h.map(e=>({id:e,kind:y})):[{id:h,kind:y}]}(e)}function convertItemList(e){const n=[];for(const d of e)"string"==typeof d?n.push(convertURL(d)):d instanceof MediaItem?n.push({id:d.id,kind:singularizeMediaType(d.type),item:d}):isMediaAPIResource(d)?n.push({id:d.id,kind:singularizeMediaType(d.type),data:d}):n.push(d);return n}function convertURL(e){if(!function(e){return d.test(String(e))}(e))throw new MKError(MKError.Reason.INVALID_ARGUMENTS,"Invalid media URL: "+e);const{contentId:n,kind:p}=parseMediaURL(e);if(void 0===n)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to resolve URL: "+e);const h=translateMediaAPIResource(p);if(void 0===h||!Co.includes(h)&&!Mo.includes(h))throw new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"Unsupported Media Kind: "+h);return{id:n,kind:singularizeMediaType(h)}}function translateMediaAPIResource(e){const n=singularizeMediaType(e);return"episode"===n?"podcastEpisode":"radio-station"===n?"station":e}function isNamedOptionKey(e){return Co.includes(e)||Mo.includes(e)}function asyncGeneratorStep$d(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$d(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$d(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$d(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$d(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$9(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$d(e,n,d[n])}))}return e}function _object_spread_props$6(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}class MusicItemLoader{get isConfigured(){return void 0!==this.developerToken}static create(e){const n=new this(e);return n.configure(e),n}configure(e){void 0!==e.storefrontId&&(this.storefrontId=e.storefrontId),void 0!==e.developerToken&&(this.developerToken=e.developerToken),void 0!==e.musicUserToken&&(this.musicUserToken=e.musicUserToken),void 0!==e.fetchContainerPages&&(this.fetchContainerPages=e.fetchContainerPages)}convertOptionsToItemDescriptors(e){return convertToItemDescriptors(e)}buildRequest(e,n){const d=new Headers(_object_spread_props$6(_object_spread$9({},null==n?void 0:n.headers),{Authorization:"Bearer "+this.developerToken}));var p;void 0!==this.musicUserToken&&d.set("Music-User-Token",this.musicUserToken);const h=encodeQueryParameters(null!==(p=null==n?void 0:n.queryParams)&&void 0!==p?p:"",{arrayFormat:"repeat",prefix:"?"});var y;const _={method:null!==(y=null==n?void 0:n.method)&&void 0!==y?y:"GET",headers:d};return void 0!==(null==n?void 0:n.body)&&(_.method="POST","string"==typeof n.body?_.body=n.body:(_.body=JSON.stringify(n.body),d.has("Content-Type")||d.set("Content-Type","application/json"))),new Request(buildURL("https://"+this.apiHost,e,h),_)}loadItems(e){var n=this;return _async_to_generator$d((function*(){Do.trace("MusicItemLoader.loadItems()",e),Do.debug("Loading resources for options",e);const d=yield n.loadResources(_object_spread$9({fetchContainerPages:n.fetchContainerPages},e)),p=n.createItems(d,{container:null==e?void 0:e.container,context:null==e?void 0:e.context});return Do.debug(`Transformed ${d.length} resources into ${p.length} MediaItems`),p}))()}loadStation(e){var n=this;return _async_to_generator$d((function*(){Do.debug("Loading Radio Station",e);const d=n.convertOptionsToItemDescriptors(e).find(e=>"station"===e.kind);if(void 0===d)return void Do.debug("No station descriptor found in options, returning undefined");return(yield n.loadItems({restricted:e.restricted,items:[d],container:null==e?void 0:e.container,context:null==e?void 0:e.context,fetchContainerPages:!1}))[0]}))()}loadStationNextTracks(e,n){var d=this;return _async_to_generator$d((function*(){var p,h,y;const _="string"==typeof e?e:e.id,m=d.buildRequest("/v1/me/stations/next-tracks/"+_,{queryParams:void 0!==(null==n?void 0:n.limit)?{limit:n.limit}:void 0,method:"POST"}),g=yield d.fetchResources(m);var b,P,S;const T={id:null!==(b=null==n||null===(p=n.container)||void 0===p?void 0:p.id)&&void 0!==b?b:_,type:"stations",href:null!==(P=null==n||null===(h=n.container)||void 0===h?void 0:h.href)&&void 0!==P?P:`/v1/catalog/${d.storefrontId}/stations/${_}`,attributes:null!==(S=null==n||null===(y=n.container)||void 0===y?void 0:y.attributes)&&void 0!==S?S:{}};var k;const E=null!==(k=null==n?void 0:n.context)&&void 0!==k?k:{};return flattenAll(g.map(e=>transform(e,T,E)))}))()}createAutoplayStation(e,n){var d=this;return _async_to_generator$d((function*(){const p=[];for(let d=0;d<e.length;d++){const h=e[d],y=pluralizeMediaType(h instanceof MediaItem?h.type:h.kind);/(-?songs|artists?)$/.test(y)&&p.push({id:h.id,type:isLibraryType(h.id)?"library-songs":"songs",meta:void 0!==(null==n?void 0:n.container)?{container:n.container}:void 0})}if(0===p.length)throw Do.error("Unable to create AutoplayStation: No items to seed"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to create AutoplayStation: No items to seed");const h=d.buildRequest("/v1/me/stations/continuous",{queryParams:{"limit[results:tracks]":void 0!==(null==n?void 0:n.limit)&&n.limit>1?n.limit:void 0,with:!0===(null==n?void 0:n.withTracks)?["tracks"]:void 0},method:"POST",body:{data:p}}),{errors:y,results:_}=yield d.services.request.fetchJSON(h);if(void 0!==y&&y.length>0){Do.error("Unable to create AutoplayStation: Server Error");const e=new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"Unable to create AutoplayStation: Server Error");throw e.data={errors:y},e}if(void 0===(null==_?void 0:_.station))throw Do.error("Unable to create AutoplayStation: No station returned from server"),new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Unable to create AutoplayStation: No station returned from server");const m=d.createItems(_.station,{container:null==n?void 0:n.container,context:null==n?void 0:n.context})[0];let g=[];return Array.isArray(_.tracks)&&(g=d.createItems(_.tracks,{container:m,context:null==n?void 0:n.context})),{station:m,tracks:g}}))()}loadResources(e){var n=this;return _async_to_generator$d((function*(){const d=convertToItemDescriptors(e),p=function(e){const n=_object_spread$9({},e);if(void 0===e)return n;for(const d of["extend","include","relate","fields"])if(void 0!==n[d]){const p=e[d];"string"==typeof p&&(n[d]=p.split(/(?:,{1}?\s*|\s+)/))}return n}(e.parameters),h=new Map(d.map((e,n)=>[e.id,{position:n,descriptor:e}])),y=function(e,n){const d={};for(const p of e){const e=n(p);void 0===d[e]&&(d[e]=[]),d[e].push(p)}return d}(d,e=>e.kind),_=Object.entries(y),m=[],g=[];for(const[T,k]of _){const d=[],h=[],y=[];for(const e of k)void 0!==e.item||void 0!==e.data?d.push(e):(isLibraryType(e.id)?y:h).push(e);const _=[];/^(?:playlists?|albums?)$/i.test(T)&&_.push("tracks"),/^podcasts?$/i.test(T)&&_.push("episodes");const b=/^(?:playlists?|library-playlists?)$/i.test(T),P=e.restricted?"explicit":void 0;d.length>0&&m.push(...d.map(e=>{var n;return null!==(n=e.item)&&void 0!==n?n:e.data}));const S=deepmerge(deepClone(p),{include:_,extend:b?["hasCollaboration"]:[],restrict:P}),E=16;if(h.length>0){const e=batchIds(h,E);for(const d of e)g.push(n.buildRequest(`/v1/catalog/${n.storefrontId}/${dasherize$1(T)}s`,{queryParams:_object_spread_props$6(_object_spread$9({},S),{ids:d})}))}if(y.length>0)if("song"===T){const e=batchIds(y,E);for(const d of e)g.push(n.buildRequest(`/v1/me/library/${dasherize$1(T)}s/`,{queryParams:_object_spread_props$6(_object_spread$9({},S),{ids:d})}))}else for(const e of y)g.push(n.buildRequest(`/v1/me/library/${dasherize$1(T)}s/${e.id}`,{queryParams:S}))}const b=yield Promise.all(g.map(d=>n.fetchResources(d,{fetchContainerPages:e.fetchContainerPages,containerItemLimit:e.containerItemLimit,restricted:e.restricted}))),P=Array(h.size);for(const e of[...m,...flattenAll(b)]){const n=h.get(e.id);void 0!==(null==n?void 0:n.position)&&(P[n.position]=e)}const S=[];for(const{position:e,descriptor:n}of h.values())void 0===P[e]&&S.push(n);if(S.length>0){const e=new MKError(MKError.Reason.NOT_FOUND,"One or more items could not be resolved: "+S.map(({id:e})=>e).join(", "));throw e.data=S,e}return P}))()}fetchResources(e,n){var d=this;return _async_to_generator$d((function*(){const{request:p}=d.services,h=(null==n?void 0:n.restricted)?"explicit":void 0;var y;const _=null!==(y=null==n?void 0:n.fetchContainerPages)&&void 0!==y&&y;var m;const g=Math.max(0,null!==(m=null==n?void 0:n.containerItemLimit)&&void 0!==m?m:1/0),b=yield p.fetchJSON(e),P=Array.isArray(b.data)?b.data:[b.data];return Promise.all(P.map(function(){var e=_async_to_generator$d((function*(e){var n,y,m;const b=null!==(m=null===(n=e.relationships)||void 0===n?void 0:n.tracks)&&void 0!==m?m:null===(y=e.relationships)||void 0===y?void 0:y.episodes;if(void 0===b)return e;const P=[...b.data];let S;for(_&&P.length<g&&(S=b.next);void 0!==S;){const e=Math.min(100,g-P.length),{data:n,next:y}=yield p.fetchJSON(d.buildRequest(S,{queryParams:{restrict:h,limit:e}}));P.push(...n),S=P.length<g?y:void 0}return null==b||delete b.next,null==b||delete b.href,b.data=P.slice(0,g),e}));return function(n){return e.apply(this,arguments)}}()))}))()}createItems(e,n){return flattenAll((e=Array.isArray(e)?e:[e]).map(e=>transform(e,null==n?void 0:n.container,null==n?void 0:n.context)))}constructor(e){if(_define_property$d(this,"services",void 0),_define_property$d(this,"apiHost",void 0),_define_property$d(this,"fetchContainerPages",void 0),_define_property$d(this,"storefrontId","us"),_define_property$d(this,"developerToken",void 0),_define_property$d(this,"musicUserToken",void 0),this.services=e.services,this.apiHost=e.apiHost.replace(/^https?:[/]{0,2}/i,""),isEmptyString$1(this.apiHost))throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Invalid API Host for Item Loader");var n;this.fetchContainerPages=null!==(n=e.fetchContainerPages)&&void 0!==n&&n}}function batchIds(e,n){return e.reduce((function(e,d,p){const h=Math.floor(p/n);return void 0===e[h]&&(e[h]=[]),e[h].push(d.id),e}),[])}function asyncGeneratorStep$c(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$c(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$c(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$c(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$c(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const jo=Qe.createChild("player"),xo=BooleanDevFlag.register("mk-hlsjs-song-playback"),No=BooleanDevFlag.register("mk-force-native-safari-video-player");class MKPlayerManager{get isDestroyed(){return this._isDestroyed}createPlayer(e,n){var d=this;return _async_to_generator$c((function*(){if(jo.trace("PlayerManager.createPlayer()",e,n),function(e){return null!=e&&!isVideo(e)}(e))return d.createAudioPlayer(e,n);if(isVideo(e))return d.createVideoPlayer(e,n);throw new Error("Unable to create player for MediaItem: "+(null==e?void 0:e.id))}))()}createAudioPlayer(e,n){var d=this;return _async_to_generator$c((function*(){const{playerOptions:p}=n;if(yield function(e){return _contentRequiresHLSjs.apply(this,arguments)}(e)){jo.info("Creating HlsJsAudioPlayer required for content item");const e=new HlsJsAudioPlayer(p);return yield e.initialize(),e}{const e=d.cachedPlayers.get(AudioPlayer);if(void 0!==e&&!e.isDestroyed)return jo.debug("Using cached AudioPlayer instance"),e;jo.info("Creating AudioPlayer as a fall through");const n=new AudioPlayer(p);return yield n.initialize(),jo.debug("Caching AudioPlayer instance"),d.cachedPlayers.set(AudioPlayer,n),n}}))()}createVideoPlayer(e,n){return _async_to_generator$c((function*(){jo.debug("Creating VideoPlayer");const{playerOptions:e}=n;if(No.enabled){jo.info("Creating NativeSafariVideoPlayer with mkForceSafariNativeVideoPlayer enabled");const n=new NativeSafariVideoPlayer(e);return yield n.initialize(),n}jo.info("Creating HLSjsVideoPlayer as the default");const d=new HlsJsVideoPlayer(e);return yield d.initialize(),d}))()}destroy(){this._isDestroyed=!0;for(const e of this.cachedPlayers.values())e.destroy();this.cachedPlayers.clear()}constructor(e){_define_property$c(this,"services",void 0),_define_property$c(this,"cachedPlayers",new Map),_define_property$c(this,"_isDestroyed",!1),this.services=e.services}}function _contentRequiresHLSjs(){return(_contentRequiresHLSjs=_async_to_generator$c((function*(e){var n,d,p;return!!(e.isLiveVideoStation||e.isLinearStream||(null===(p=e.defaultPlayable)||void 0===p||null===(d=p.assets)||void 0===d||null===(n=d.fpsKeyServerUrl)||void 0===n?void 0:n.startsWith("https://linear.tv.apple.com")))||(!!(e.isRadioStation||e.isLiveRadioStation||e.hasOffersHlsUrl||e.isRadioEpisode)||!!xo.enabled)}))).apply(this,arguments)}function asyncGeneratorStep$b(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$b(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$b(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$b(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$b(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}const Lo=["https://play.itunes.apple.com/","https://linear.tv.apple.com/","https://play-edge.itunes.apple.com"],Uo=Ye.createChild("manifest"),Fo=BooleanDevFlag.register("mk-load-manifest-once");class ManifestManager{get fetch(){return this.services.request.fetch}fetchManifest(e){var n=this;return _async_to_generator$b((function*(){return Uo.info("fetching manifest at",e),n.personalizedManifests?n.fetchForCache(e):n.fetchOnly(e)}))()}getManifest(e){var n=this;return _async_to_generator$b((function*(){return n.cache.get(e)}))()}setManifest(e,n){var d=this;return _async_to_generator$b((function*(){d.cache.set(e,n)}))()}clearManifest(e){var n=this;return _async_to_generator$b((function*(){const d=n.cache.get(e);return n.cache.delete(e),d}))()}clearAll(){var e=this;return _async_to_generator$b((function*(){e.cache.clear()}))()}clear(e){e?this.clearManifest(e):this.clearAll()}fetchForCache(e){var n=this;return _async_to_generator$b((function*(){const d={};Lo.some(n=>e.startsWith(n))&&gn.musicUserToken&&(d.Authorization="Bearer "+gn.developerToken,d["media-user-token"]=gn.musicUserToken);const p=yield n.fetch(e,{headers:new Headers(d)});let h=yield p.text();var y;h=((e,n)=>{Uo.info("converting manifest URIs to absolute paths");const d=new URL(e);let p=n.replace(/URI="([^"]*)"/g,(function(e,n){return`URI="${new URL(n,d).href}"`}));return p=p.replace(/^(#EXT-X-STREAM-INF:[^\n]*\n)(.*$)/gim,(function(e,n,p){return`${n}${new URL(p,d).href}`})),p})(e,h);const _=null!==(y=p.headers.get("content-type"))&&void 0!==y?y:void 0,m={url:e,content:h,contentType:_};return n.cache.set(e,m),m}))()}fetchOnly(e){var n=this;return _async_to_generator$b((function*(){const d=yield n.fetch(e),p=yield d.text();var h;const y=null!==(h=d.headers.get("content-type"))&&void 0!==h?h:void 0;return{url:e,content:p,contentType:y}}))()}constructor(e){var n,d;_define_property$b(this,"cache",void 0),_define_property$b(this,"services",void 0),_define_property$b(this,"personalizedManifests",!0),this.services=e.services,this.cache=null!==(n=null==e?void 0:e.cache)&&void 0!==n?n:new Map,this.personalizedManifests=null===(d=null==e?void 0:e.personalizedManifests)||void 0===d||d,Fo.configured&&(this.personalizedManifests=Fo.enabled)}}function asyncGeneratorStep$a(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$a(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$a(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$a(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$a(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$8(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$a(e,n,d[n])}))}return e}function _object_spread_props$5(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_decorate$3(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$3(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const Ko=[MKError.Reason.CONTENT_EQUIVALENT,MKError.Reason.CONTENT_RESTRICTED,MKError.Reason.CONTENT_UNAVAILABLE,MKError.Reason.CONTENT_UNSUPPORTED,MKError.Reason.SERVER_ERROR,MKError.Reason.SUBSCRIPTION_ERROR,MKError.Reason.UNSUPPORTED_ERROR,MKError.Reason.USER_INTERACTION_REQUIRED],Bo=JsonDevFlag.register("mk-bag-features-overrides");class MKInstance{get playbackController(){return this._playbackController}get developerToken(){return Bi.developerToken}get api(){return this._services.apiManager.api}get audioTracks(){return this._mediaItemPlayback.audioTracks}get authorizationStatus(){return Bi.authorizationStatus}get bitrate(){return this._services.bitrateCalculator.bitrate}set bitrate(e){this._services.bitrateCalculator.bitrate=e}get browserSupportsPictureInPicture(){return detectPictureInPictureSupport()}get browserSupportsVideoDrm(){return this.services.runtime.isDRMAvailable}get cid(){return(this.realm===Ae.TV||this.sourceType!==bt.MUSICKIT)&&Bi.cid}get continuous(){var e,n;return null!==(n=null===(e=this._playbackController)||void 0===e?void 0:e.continuous)&&void 0!==n&&n}set continuous(e){this.getPlaybackController().continuous=e}get autoplayEnabled(){return this._autoplayEnabled}set autoplayEnabled(e){this.realm!==Ae.MUSIC&&(e=!1),e!==this.autoplayEnabled&&(this._autoplayEnabled=e,this._services.dispatcher.publish(Oi.autoplayEnabledDidChange,this.autoplayEnabled))}get currentAudioTrack(){return this._mediaItemPlayback.currentAudioTrack}set currentAudioTrack(e){this._mediaItemPlayback.currentAudioTrack=e}get currentPlaybackDuration(){return this._mediaItemPlayback.currentPlaybackDuration}get currentPlaybackProgress(){return this._mediaItemPlayback.currentPlaybackProgress}get currentPlaybackTime(){return this._mediaItemPlayback.currentPlaybackTime}get currentPlayingDate(){return this._mediaItemPlayback.currentPlayingDate}get isPlayingAtLiveEdge(){return this._mediaItemPlayback.isPlayingAtLiveEdge}get seekableTimeRanges(){return this._mediaItemPlayback.seekableTimeRanges}get currentPlaybackTimeRemaining(){return this._mediaItemPlayback.currentPlaybackTimeRemaining}get currentTextTrack(){return this._mediaItemPlayback.currentTextTrack}set currentTextTrack(e){this._mediaItemPlayback.currentTextTrack=e}get isAuthorized(){return Bi.isAuthorized}get isPlaying(){var e,n;return null!==(n=null===(e=this._playbackController)||void 0===e?void 0:e.isPlaying)&&void 0!==n&&n}get isRestricted(){return Bi.isRestricted}get isU13(){return Bi.isU13}get metricsClientId(){return Bi.metricsClientId}set metricsClientId(e){Bi.metricsClientId=e}get musicUserToken(){return Bi.musicUserToken}set musicUserToken(e){e&&Bi.musicUserToken===e||(Bi.musicUserToken=e)}updateUserTokenFromStorage(){return Bi.updateUserTokenFromStorage()}get needsGDPR(){return Bi.needsGDPR}get nowPlayingItem(){return this._mediaItemPlayback.nowPlayingItem}get currentTimedMetadata(){return this._mediaItemPlayback.currentTimedMetadata}get nowPlayingItemIndex(){var e,n;return null!==(n=null===(e=this._playbackController)||void 0===e?void 0:e.nowPlayingItemIndex)&&void 0!==n?n:-1}get playbackMode(){return this._playbackMode}set playbackMode(e){if(-1===Object.values(wi).indexOf(e))return;const n=e===wi.PREVIEW_ONLY,d=this._services.mediaItemPlayback;d&&(d.previewOnly=n),this._playbackMode!==e&&(this._playbackMode=e,void 0!==this._playbackController&&(this._playbackController.playbackMode=e))}get playbackRate(){return this._mediaItemPlayback.playbackRate}set playbackRate(e){this._mediaItemPlayback.playbackRate=e}get defaultPlaybackRate(){return this._mediaItemPlayback.defaultPlaybackRate}set defaultPlaybackRate(e){this._mediaItemPlayback.defaultPlaybackRate=e}get playbackState(){return this._mediaItemPlayback.playbackState}get playbackTargetAvailable(){return this._mediaItemPlayback.playbackTargetAvailable}get playbackTargetIsWireless(){return this._mediaItemPlayback.playbackTargetIsWireless}get previewOnly(){return this.playbackMode===wi.PREVIEW_ONLY}set previewOnly(e){this.playbackMode=e?wi.PREVIEW_ONLY:wi.MIXED_CONTENT}get queue(){var e;return null===(e=this._playbackController)||void 0===e?void 0:e.queue}get queueIsEmpty(){var e,n,d;return null===(d=null===(n=this._playbackController)||void 0===n||null===(e=n.queue)||void 0===e?void 0:e.isEmpty)||void 0===d||d}get realm(){return Bi.realm}get repeatMode(){var e,n;return null!==(n=null===(e=this._playbackController)||void 0===e?void 0:e.repeatMode)&&void 0!==n?n:Li.none}set repeatMode(e){this.getPlaybackController().repeatMode=e}set requestUserToken(e){Bi.requestUserToken=e}get restrictedEnabled(){return Bi.restrictedEnabled}set restrictedEnabled(e){Bi.restrictedEnabled=e}get supportsPreviewImages(){return this._mediaItemPlayback.supportsPreviewImages}get seekSeconds(){var e;return null===(e=this._playbackController)||void 0===e?void 0:e.seekSeconds}get services(){return this._services}set shuffle(e){this.getPlaybackController().shuffle=e}get shuffleMode(){var e,n;return null!==(n=null===(e=this._playbackController)||void 0===e?void 0:e.shuffleMode)&&void 0!==n?n:io.off}set shuffleMode(e){this.getPlaybackController().shuffleMode=e}get storefrontCountryCode(){return Bi.storefrontCountryCode}get subscribeURL(){return Bi.subscribeURL}get subscribeFamilyURL(){return Bi.subscribeFamilyURL}get subscribeIndividualURL(){return Bi.subscribeIndividualURL}get subscribeStudentURL(){return Bi.subscribeStudentURL}get textTracks(){return this._mediaItemPlayback.textTracks}get videoContainerElement(){return this.context.videoContainerElement}set videoContainerElement(e){this.context.videoContainerElement=e}get volume(){return this._mediaItemPlayback.volume}set volume(e){this._mediaItemPlayback.volume=e}get storefrontId(){return Bi.storefrontId}set storefrontId(e){Bi.storefrontId=e}get _mediaItemPlayback(){return this._services.mediaItemPlayback}getPlaybackController(){if(tt.trace("MKInstance.getPlaybackController()",this._playbackController),void 0===this._playbackController)throw new MKError(MKError.Reason.INTERNAL_ERROR,"No PlaybackController active");return this._playbackController}setPlaybackController(e){var n=this;return _async_to_generator$a((function*(){return tt.trace("MKInstance.setPlaybackController()",e),n._playbackController===e||(void 0!==n._playbackController&&(yield n._playbackController.deactivate()),e.autoplayEnabled=n._autoplayEnabled,yield e.activate(),n.capabilities.controller=e,n.capabilities.updateChecker(e.hasCapabilities),n._playbackController=e),e}))()}addEventListener(e,n,d={}){adaptAddEventListener(this._services.dispatcher,e,n,d)}authorize(){var e=this;return _async_to_generator$a((function*(){return e.deferPlayback(),Bi.authorize()}))()}canAuthorize(){return this.services.runtime.isDRMAvailable&&!this.isAuthorized}canUnauthorize(){return this.services.runtime.isDRMAvailable&&this.isAuthorized}changeToMediaAtIndex(e){var n=this;return _async_to_generator$a((function*(){n._isPlaybackSupported()&&(yield n.validateAuthorization(),n.signalChangeItemIntent(),yield n.getPlaybackController().changeToMediaAtIndex(e))}))()}changeToMediaItem(e){var n=this;return _async_to_generator$a((function*(){tt.debug("instance.changeToMediaItem",e),n._isPlaybackSupported()&&(yield n.validateAuthorization(),n.signalChangeItemIntent(),yield n.getPlaybackController().changeToMediaItem(e))}))()}changeUserStorefront(e){var n=this;return _async_to_generator$a((function*(){n.storefrontId=e}))()}cleanup(){var e=this;return _async_to_generator$a((function*(){var n;null===(n=e._services.mediaItemPlayback)||void 0===n||n.destroy(),e.signalIntent({endReasonType:lt.EXITED_APPLICATION});const d=Object.keys(e.playbackControllers).map(n=>e.playbackControllers[n].destroy());try{yield Promise.all(d)}catch(St){tt.error("Error cleaning up controller",St)}e._services.dispatcher.clear()}))()}configure(e){var n=this;return _async_to_generator$a((function*(){return yield n.setPlaybackController(n.getPlaybackControllerByType(ao.serial)),n._whenConfigured=n._configure(e),n._whenConfigured}))()}_configure(e){var n=this;return _async_to_generator$a((function*(){yield Bi.storekit.whenAuthCompleted;const d=e.map(n._services.apiManager.registerAPIService,n._services.apiManager);yield Promise.all(d),yield n._configurePlayActivity(),n._initializeExternalEventPublishing()}))()}deferPlayback(){tt.debug("deferPlayback",this._playbackController),deferPlayback()}getApiByType(e){var n;return null===(n=this._services.apiManager)||void 0===n?void 0:n.getApiByType(e)}me(){return _async_to_generator$a((function*(){try{return yield Bi.storekit.me()}catch(St){return Promise.reject(new MKError(MKError.Reason.AUTHORIZATION_ERROR,"Unauthorized"))}}))()}musicSubscriptionOffers(){return Bi.storekit.musicSubscriptionOffers(this.storefrontId)}musicSubcriptionOffers(){return deprecationWarning("musicSubcriptionOffers",{message:"musicSubcriptionOffers has been deprecated, use musicSubscriptionOffers instead"}),this.musicSubscriptionOffers()}hasMusicSubscription(){return hasMusicSubscription(Bi.storekit)}mute(){return this._mediaItemPlayback.mute()}pause(e){var n=this;return _async_to_generator$a((function*(){if(n._isPlaybackSupported()){try{n.signalIntent({endReasonType:lt.PLAYBACK_MANUALLY_PAUSED}),yield n.getPlaybackController().pause(e)}catch(he){n._handlePlaybackError(he)}return Promise.resolve()}}))()}play(){var e=this;return _async_to_generator$a((function*(){if(tt.debug("instance.play()"),e._isPlaybackSupported()){yield e.validateAuthorization();try{yield e.getPlaybackController().play()}catch(he){e._handlePlaybackError(he)}return Promise.resolve()}}))()}playMediaItem(e,n){var d=this;return _async_to_generator$a((function*(){var p,h;if(tt.trace("MKInstance.playMediaItem()",e,n),(null==n?void 0:n.bingeWatching)||d.deferPlayback(),n=_object_spread$8({},n),(null==e?void 0:e.playEvent)&&!hasOwn(n,"startTime")){const{playEvent:d}=e;d.isDone||void 0===d.playCursorInSeconds||(n.startTime=d.playCursorInSeconds)}d.services.dispatcher.publish(Oi.playInitiated,{item:e,timestamp:null!==(h=null===(p=n.meta)||void 0===p?void 0:p.initiatedTimestamp)&&void 0!==h?h:Date.now()});try{n&&d._mediaItemPlayback.playOptions.set(e.id,n);const p=yield d.getPlaybackController().playSingleMediaItem(e,n);return d.services.dispatcher.publish(Oi.capabilitiesChanged),p}catch(he){tt.error("mk:playMediaItem error",he),d._handlePlaybackError(he)}}))()}removeEventListener(e,n){!function(e,n,d){const p=getCallbacksForName(n);let h;for(let y=p.length-1;y>=0;y--){const[e,n]=p[y];if(e===d){h=n,p.splice(y,1);break}}h&&e.unsubscribe(n,h)}(this._services.dispatcher,e,n)}shouldDisplayPrivacyLink(e){return _async_to_generator$a((function*(){return Bi.shouldDisplayPrivacyLink(e)}))()}exitFullscreen(){return this._mediaItemPlayback.exitFullscreen()}requestFullscreen(e){return this._mediaItemPlayback.requestFullscreen(e)}loadPreviewImage(e){var n=this;return _async_to_generator$a((function*(){return n._mediaItemPlayback.loadPreviewImage(e)}))()}getNewSeeker(){return this.getPlaybackController().getNewSeeker()}seekToTime(e,n=ut.Manual){var d=this;return _async_to_generator$a((function*(){if(d._isPlaybackSupported()){yield d.validateAuthorization();try{yield d.getPlaybackController().seekToTime(e,n)}catch(he){d._handlePlaybackError(he)}return Promise.resolve()}}))()}setPresentationMode(e){var n=this;return _async_to_generator$a((function*(){return n._mediaItemPlayback.setPresentationMode(e)}))()}skipToNextItem(){var e=this;return _async_to_generator$a((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization(),e.signalIntent({endReasonType:lt.TRACK_SKIPPED_FORWARDS,direction:lt.TRACK_SKIPPED_FORWARDS});try{yield e.getPlaybackController().skipToNextItem()}catch(he){e._handlePlaybackError(he)}}}))()}skipToPreviousItem(){var e=this;return _async_to_generator$a((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization(),e.signalIntent({endReasonType:lt.TRACK_SKIPPED_BACKWARDS,direction:lt.TRACK_SKIPPED_BACKWARDS});try{yield e.getPlaybackController().skipToPreviousItem()}catch(he){e._handlePlaybackError(he)}}}))()}seekForward(){var e=this;return _async_to_generator$a((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization();try{e.signalIntent({endReasonType:lt.TRACK_SKIPPED_FORWARDS,direction:lt.TRACK_SKIPPED_FORWARDS}),yield e.getPlaybackController().seekForward()}catch(he){e._handlePlaybackError(he)}}}))()}seekBackward(){var e=this;return _async_to_generator$a((function*(){if(e._isPlaybackSupported()){yield e.validateAuthorization();try{yield e.getPlaybackController().seekBackward()}catch(he){e._handlePlaybackError(he)}}}))()}showPlaybackTargetPicker(){this.getPlaybackController().showPlaybackTargetPicker()}stop(e){var n=this;return _async_to_generator$a((function*(){if(n._isPlaybackSupported()){var d;n.signalIntent({endReasonType:null==e?void 0:e.endReasonType,userInitiated:null===(d=null==e?void 0:e.userInitiated)||void 0===d||d});try{yield n.getPlaybackController().stop(e)}catch(he){n._handlePlaybackError(he)}}}))()}resetSubscribeViewEligibility(){Bi.storekit.resetSubscribeViewEligibility()}unauthorize(){return _async_to_generator$a((function*(){return Bi.unauthorize()}))()}unmute(){return this._mediaItemPlayback.unmute()}_createPlayerOptions(){return{tokens:Bi,bag:Fi,playbackServices:{getRTCStreamingTracker:()=>{var e;return null===(e=this._services.playActivity)||void 0===e?void 0:e.getTrackerByType(RTCStreamingTracker)},hasMusicSubscription:hasMusicSubscription,prepareForEncryptedPlayback:(e,n)=>function(e,n){return _prepareForEncryptedPlayback.apply(this,arguments)}(e,_object_spread_props$5(_object_spread$8({},n),{services:{runtime:this._services.runtime,store:Bi,request:this._services.request}}))},services:this._services,context:this.context,autoplayEnabled:this.autoplayEnabled,privateEnabled:this.privateEnabled,siriInitiated:this.siriInitiated,storekit:null==Bi?void 0:Bi.storekit,playbackMode:this.playbackMode}}getPlaybackControllerByType(e){let n=this.playbackControllers[e];if(void 0!==n)return n;switch(e){case ao.serial:n=new SerialPlaybackController(this._createPlayerOptions());break;case ao.continuous:n=new ContinuousPlaybackController(this._createPlayerOptions());break;default:throw new MKError(MKError.Reason.UNSUPPORTED_ERROR,"Unsupported controller requested: "+e)}return this.playbackControllers[e]=n,n}playbackControllerForItems(e){const n=e[0];return(null==n?void 0:n.isRadioStation)&&!(null==n?void 0:n.isRadioEpisode)?this.getPlaybackControllerByType(ao.continuous):this.getPlaybackControllerByType(ao.serial)}_handlePlaybackError(e){if(tt.error("mediaPlaybackError",e),MKError.isMKError(e)&&Ko.includes(e.reason))throw e;this._playbackErrorDialog&&!this._services.runtime.isNodeEnvironment&&MKDialog.presentError(e)}_initializeInternalEventHandling(){const{dispatcher:e,itemLoader:n}=this._services;Bi.storekit.addEventListener(Oi.userTokenDidChange,({userToken:e})=>{this._whenConfigured&&this._whenConfigured.then(()=>this._configurePlayActivity().catch()).catch(),tt.debug("Setting musicUserToken for MusicItemLoader: "+this.musicUserToken),null==n||n.configure({musicUserToken:e})}),Bi.storekit.addEventListener(Oi.storefrontCountryCodeDidChange,(function({storefrontCountryCode:e}){tt.debug("Setting storefrontId for MusicItemLoader: "+e),null==n||n.configure({storefrontId:e})})),e.subscribe(Oi.mediaPlaybackError,(e,n)=>this._handlePlaybackError(n)),e.subscribe(Oi.playbackVolumeDidChange,(e,n)=>{const d=null==n?void 0:n.target;((null==d?void 0:d.muted)||(null==d?void 0:d.volume))&&(this.volume=(null==d?void 0:d.muted)?0:null==d?void 0:d.volume)}),e.subscribe(Oi.playbackStateDidChange,(e,n)=>{n.state===be.paused&&(tt.debug("mk: playbackStateDidChange callback - calling storekit.presentSubscribeViewForEligibleUsers"),Bi.storekit.presentSubscribeViewForEligibleUsers({state:n.state,item:this.nowPlayingItem},!1))}),e.subscribe(xn,(n,{metadata:d,item:p,position:h,playingDate:y})=>{if(d.blob){const n={item:null!=p?p:this.nowPlayingItem,position:null!=h?h:this.currentPlaybackTime,playingDate:null!=y?y:this.currentPlayingDate,storefrontId:this.storefrontId.toUpperCase(),metadata:d};tt.debug('Dispatching TimedMetadata "ping"',n),e.publish(ot.timedMetadata,n)}})}_initializeExternalEventPublishing(){[Oi.authorizationStatusDidChange,Oi.needsGDPRDidChange,Oi.storefrontCountryCodeDidChange,Oi.storefrontIdentifierDidChange,Oi.userTokenDidChange,Oi.eligibleForSubscribeView].forEach(e=>{Bi.storekit.addEventListener(e,n=>this._services.dispatcher.publish(e,n))}),this._services.dispatcher.subscribe(xn,(e,{metadata:n})=>{tt.debug("Dispatching TimedMetadata change",n),this._services.dispatcher.publish(Oi.timedMetadataDidChange,n)})}configureLogger(e){var n;tt.level===Ze&&(!0===e.debug?setRootLoggingLevel($.DEBUG):void 0!==e.logLevel&&setRootLoggingLevel(e.logLevel)),Je.enabled&&setConsoleOutput(Je.enabled),void 0!==Xe.value&&applyLoggingLevels(Xe.value),void 0!==e.logHandler&&(n=e.logHandler,tt.handlers.external=new CallbackHandler(n))}_configurePlayActivity(){var e=this;return _async_to_generator$a((function*(){void 0!==e._services.playActivity&&(yield e._services.playActivity.configure({instance:e,services:e._services}))}))()}_isPlaybackSupported(){return!this._services.runtime.isNodeEnvironment||(tt.warn("Media playback is not supported in Node environments."),!1)}signalChangeItemIntent(){this.signalIntent({endReasonType:lt.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM})}signalIntent(e){this.services.dispatcher.publish(ot.userActivityIntent,_object_spread$8({userInitiated:!0},e))}validateAuthorization(e=!1){var n=this;return _async_to_generator$a((function*(){(e||n.playbackMode===wi.FULL_PLAYBACK_ONLY)&&(void 0!==n._playbackController&&n._playbackController.isReady&&n._playbackController.isPlaying||(yield n.authorize()))}))()}constructor(n){_define_property$a(this,"app",void 0),_define_property$a(this,"capabilities",void 0),_define_property$a(this,"context",void 0),_define_property$a(this,"_autoplayEnabled",!1),_define_property$a(this,"id",void 0),_define_property$a(this,"prefix",void 0),_define_property$a(this,"privateEnabled",!1),_define_property$a(this,"siriInitiated",!1),_define_property$a(this,"sourceType",bt.MUSICKIT),_define_property$a(this,"version",e.version),_define_property$a(this,"playbackActions",void 0),_define_property$a(this,"guid",void 0),_define_property$a(this,"_bag",Fi),_define_property$a(this,"playbackControllers",{}),_define_property$a(this,"_playbackController",void 0),_define_property$a(this,"_queue",void 0),_define_property$a(this,"_services",void 0),_define_property$a(this,"_playbackErrorDialog",!0),_define_property$a(this,"_playbackMode",wi.MIXED_CONTENT),_define_property$a(this,"_whenConfigured",void 0);const{developerToken:d}=n;if("string"!=typeof d||""===d.trim())throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Missing or empty developer token");Object.assign(Fi.features,function(e=[]){const n={};return e.forEach(e=>{"-"===e.charAt(0)?(e=e.substr(1),n[e]=!1):n[e]=!0}),n}(n.features));const p=Bo.get();p&&(tt.warn("Overriding bag.features with",p),Fi.features=_object_spread$8({},Fi.features,p)),Object.assign(Fi.autoplay,n.autoplay),Object.assign(Fi.app,n.app),Object.assign(Fi.urls,n.urls),tt.debug("Instance Configuration: ",Fi),this.context={};const h=n.services;this.capabilities=new Capabilities(h.dispatcher),"playbackActions"in n&&(this.playbackActions=n.playbackActions),"guid"in n&&(this.guid=n.guid);const y=new ManifestManager({services:{request:h.request}}),_=new TimingAccuracy(!!Fi.features["player-accurate-timing"]),m=new BitrateCalculator(h.dispatcher,n.bitrate),g=function(e,n){return Bi=new Store(e,n),Bi}(d,n);let b=!0===Fi.features["fetch-container-pages"],P="api.music.apple.com";b=this.realm===Ae.MUSIC,P="amp-api.music.apple.com",this.realm===Ae.PODCAST&&(P="amp-api.podcasts.apple.com");const S=new MKPlayerManager({services:{runtime:h.runtime}});if(this._services={runtime:h.runtime,request:h.request,dispatcher:h.dispatcher,itemLoader:MusicItemLoader.create({apiHost:P,services:{runtime:h.runtime,request:h.request},storefrontId:null==g?void 0:g.storefrontId,developerToken:d,musicUserToken:g.musicUserToken,fetchContainerPages:b}),player:S,manifest:y,timing:_,bitrateCalculator:m},void 0!==n.playActivityAPI&&(this._services.playActivity=new PlayActivityService(h.dispatcher,n.playActivityAPI)),n.services=this._services,this.configureLogger(n),this._services.apiManager=new APIServiceManager(g,h.dispatcher),this._services.mediaItemPlayback=new MediaItemPlayback({services:{runtime:h.runtime,request:h.request,dispatcher:h.dispatcher,store:g,player:S,manifest:y,bitrateCalculator:m,timing:_},playerOptions:this._createPlayerOptions()}),n.sourceType&&(this.sourceType=n.sourceType),this._initializeInternalEventHandling(),n.bitrate&&(this.bitrate=n.bitrate),"prefix"in n&&/^(?:web|preview)$/.test(n.prefix||"")&&(this.prefix=Fi.prefix=n.prefix),n.suppressErrorDialog&&(this._playbackErrorDialog=!n.suppressErrorDialog),void 0!==n.playbackMode&&(this.playbackMode=n.playbackMode),"privateEnabled"in n&&(this.privateEnabled=n.privateEnabled||!1),"siriInitiated"in n&&(this.siriInitiated=n.siriInitiated||!1),this.id=generateUUID(),tt.info("MusicKit JS Version: "+this.version),tt.info("InstanceId",this.id),tt.debug("Link Parameters",n.linkParameters),Fi.app&&tt.debug("App",Fi.app),n.userToken){const{userToken:e}=n;"function"==typeof e?Bi.dynamicMusicUserToken=e:this.musicUserToken=e}}}function asyncGeneratorStep$9(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$9(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$9(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$9(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function dispatchDocumentEvent(e){if(detectNodeEnvironment())return;const n=new Event(e,{bubbles:!0,cancelable:!0});setTimeout(()=>document.dispatchEvent(n))}function _loadWebComponents(){return(_loadWebComponents=_async_to_generator$9((function*(){var e;if(detectNodeEnvironment())return;const n=findScript("musickit.js");if(""!==(null==n||null===(e=n.dataset)||void 0===e?void 0:e.webComponents))return;const d="noModule"in n,p=`components/musickit-components/musickit-components${d?".esm":""}.js`,h="https:"+cdnBaseURL(p)+p,y={};d&&(y.type="module"),n.hasAttribute("async")&&(y.async=""),n.hasAttribute("defer")&&(y.defer=""),yield loadScript(h,y),dispatchDocumentEvent(Oi.webComponentsLoaded)}))).apply(this,arguments)}function asyncGeneratorStep$8(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$8(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$8(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$8(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$9(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$7(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$9(e,n,d[n])}))}return e}function _object_spread_props$4(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}_ts_decorate$3([AsyncDebounce(250,{isImmediate:!0}),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",["undefined"==typeof ActivityNotificationOptions?Object:ActivityNotificationOptions]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"pause",null),_ts_decorate$3([AsyncDebounce(250,{isImmediate:!0}),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"play",null),_ts_decorate$3([SerialAsync("skip"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"skipToNextItem",null),_ts_decorate$3([SerialAsync("skip"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"skipToPreviousItem",null),_ts_decorate$3([SerialAsync("seek"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"seekForward",null),_ts_decorate$3([SerialAsync("seek"),_ts_metadata$3("design:type",Function),_ts_metadata$3("design:paramtypes",[]),_ts_metadata$3("design:returntype",Promise)],MKInstance.prototype,"seekBackward",null);const Vo="undefined"!=typeof window&&"undefined"!=typeof document;let Go=!1;const qo=[];function cleanupInstances(){return _cleanupInstances.apply(this,arguments)}function _cleanupInstances(){return(_cleanupInstances=_async_to_generator$8((function*(){const e=qo.map(e=>e.cleanup());yield Promise.all(e),qo.splice(0,qo.length)}))).apply(this,arguments)}function configure$1(e){return _configure$1.apply(this,arguments)}function _configure$1(){return(_configure$1=_async_to_generator$8((function*(e,n=MKInstance,d){if(!e)throw new MKError(MKError.Reason.INVALID_ARGUMENTS,"configuration required");const p={};e.mergeQueryParams&&Vo&&window.location&&(p.linkParameters=_object_spread$7({},e.linkParameters||{},parseQueryParams(window.location.href)));const h=_object_spread$7({runtime:yield RuntimeEnvironment.detect(),dispatcher:new PubSub,request:new RequestManager},null==e?void 0:e.services),y=new n(_object_spread_props$4(_object_spread$7({},e,p),{services:h}));return Go||(yield cleanupInstances()),d&&(yield d(y)),qo.push(y),dispatchDocumentEvent(Oi.configured),y}))).apply(this,arguments)}function getInstances(){return qo}function getInstance(e){if(0!==qo.length)return void 0===e?qo[qo.length-1]:qo.find(n=>n.id===e)}Vo&&(asAsync(function(){return _loadWebComponents.apply(this,arguments)}()),dispatchDocumentEvent(Oi.loaded));const Ho=["uploadedVideo","uploadedAudio","uploaded-videos","uploaded-audios"];function asyncGeneratorStep$7(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$7(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$7(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$7(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$8(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$6(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$8(e,n,d[n])}))}return e}const zo=Qe.createChild("mpaf"),asCode=e=>{switch(typeof e){case"string":return e;case"undefined":return"undefined";default:return"PlayActivityEndReasonType."+lt[e]}};class MPAFTracker{get requestedEvents(){return Array.from(this.dispatchTable.keys())}get isConfigured(){return void 0!==this.instance}get activityTracker(){if(void 0===this._activityTracker)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Play Activity service was called before configuration.");return this._activityTracker}static create(e){return _async_to_generator$7((function*(){const n=new MPAFTracker;return yield n.configure(e),n}))()}configure(e){var n=this;return _async_to_generator$7((function*(){var d,p,h,y;n.instance=e.instance,n.services=e.services,n._activityTracker=(d=e.instance,p={runtime:e.services.runtime,request:e.services.request},new PlayActivity(d.developerToken,d.musicUserToken,d.storefrontCountryCode,{app:{build:Fi.app.build,name:null!==(y=Fi.app.name)&&void 0!==y?y:"",version:Fi.app.version,bundleId:null===(h=Fi.app)||void 0===h?void 0:h.bundleId},fetch:p.request.fetch,isQA:Yo.enabled,logInfo:zo.enabled,sourceType:d.sourceType,guid:d.guid,userIsSubscribed:()=>!(!d.isAuthorized||!Bi.storekit._getIsActiveSubscription.getCachedValue())}))}))()}handleEvent(e,n,d){if(!this.shouldTrackPlayActivity(e,d))return;const p=this.dispatchTable.get(e);void 0!==p&&"function"==typeof this[p]&&this[p](d,n)}activate(e,n={}){var d=this;return _async_to_generator$7((function*(){zo.debug("Activating MPAF tracker"),yield d.activityTracker.activate(n.flush),d.reportTimedMetadata.clear()}))()}exit(e,n={}){var d=this;return _async_to_generator$7((function*(){zo.debug("PAF debug",`client.exit(${n.position})`),d.activityTracker.exit(n.position)}))()}pause(e,n={}){var d=this;return _async_to_generator$7((function*(){if(void 0!==(null==e?void 0:e.id)&&d.reportTimedMetadata.add(e.id),"number"==typeof n.endReasonType)return zo.debug("PAF debug",`client.stop(${n.position}, ${n.endReasonType})`),d.activityTracker.stop(n.position,n.endReasonType);zo.debug("PAF debug",`client.pause(${n.position})`),d.activityTracker.pause(n.position)}))()}play(e,n={}){var d=this;return _async_to_generator$7((function*(){const p=generateItemDescriptorForPAF(ot.playbackPlay,d.instance,e);isLiveRadioKind(e,"video")&&(d.musicLiveVideoStartTime=Date.now()),zo.debug("PAF debug",`client.play(${JSON.stringify(p)}, ${n.position})`),d.activityTracker.play(p,n.position),d.reportTimedMetadata.add(e.id)}))()}scrub(e,n={}){var d=this;return _async_to_generator$7((function*(){zo.debug("PAF debug",`client.scrub(${n.position}, ${asCode(n.endReasonType)})`),d.activityTracker.scrub(n.position,n.endReasonType),void 0!==e&&n.endReasonType===lt.SCRUB_END&&d.reportTimedMetadata.delete(e.id)}))()}seek(e,n={}){var d=this;return _async_to_generator$7((function*(){yield d.scrub(e,{position:n.startPosition,endReasonType:lt.SCRUB_BEGIN}),yield d.scrub(e,{position:n.position,endReasonType:lt.SCRUB_END})}))()}skip(e,n={}){var d=this;return _async_to_generator$7((function*(){const p=generateItemDescriptorForPAF(ot.playbackSkip,d.instance,e);zo.debug("PAF debug",`client.skip(${JSON.stringify(p)}, ${asCode(n.direction)}, ${n.position})`);try{yield d.activityTracker.skip(p,n.direction,n.position),d.reportTimedMetadata.add(e.id)}catch(St){if("A play stop() method was called without a previous play() descriptor"!==St.message)return Promise.reject(St);yield d.play(e,n)}}))()}stop(e,n={}){var d=this;return _async_to_generator$7((function*(){var p;(isLiveRadioKind(e,"video")?(n.position=(Date.now()-d.musicLiveVideoStartTime)/1e3,d.musicLiveVideoStartTime=0):(null==e?void 0:e.isLiveRadioStation)&&n.position&&(n.position=n.position-(n.startPosition||0)),null==e?void 0:e.isLiveRadioStation)&&(n.endReasonType=null!==(p=n.endReasonType)&&void 0!==p?p:lt.PLAYBACK_MANUALLY_PAUSED);zo.debug("PAF debug",`client.stop(${n.position}, ${asCode(n.endReasonType)})`),d.activityTracker.stop(n.position,n.endReasonType),void 0!==(null==e?void 0:e.id)&&d.reportTimedMetadata.delete(e.id)}))()}timedMetadata(e,n){var d=this;return _async_to_generator$7((function*(){var p,h;if(void 0===e||void 0===n||void 0===n.position||void 0===(null===(p=n.metadata)||void 0===p?void 0:p.blob))return void zo.warn("Missing data for TimedMetadata event",n,e);if(!e.isRadioStation)return zo.debug(`Ignoring TimedMetadata at ${n.position}: Not a Radio Station`),void(d.activityTracker.timedMetadata=void 0);if(e.isLiveRadioStation)return zo.debug(`Ignoring TimedMetadata at ${n.position}: Live Radio Station`),void(d.activityTracker.timedMetadata=void 0);const y=null===(h=n.metadata)||void 0===h?void 0:h.blob,_=d.activityTracker.timedMetadata;d.reportTimedMetadata.has(e.id)?void 0===y&&void 0!==_||compareUint8Array(y,_)?zo.debug(`Skipping TimedMetadata report at ${n.position}: unchanged`,shortHex(y)):(zo.debug("Reporting current TimedMetadata at "+n.position,shortHex(_)),d.activityTracker.pingTimedMetadata(n.position,_)):(zo.debug(`Skipping TimedMetadata report at ${n.position}: disabled for ${e.id} (${e.info})`,shortHex(y)),void 0===d.activityTracker.timeline.last||d.activityTracker.timeline.last.eventType!==_t.PLAY_START&&d.activityTracker.timeline.last.endReasonType!==lt.SCRUB_END||d.reportTimedMetadata.add(e.id)),zo.debug("Storing new TimedMetadata at "+n.position,shortHex(y)),d.activityTracker.timedMetadata=y}))()}shouldTrackPlayActivity(e,n){const d=hasAuthorization(),p=!n||n.playbackType!==ie.preview,h=this.alwaysSendForActivityType(e),y=!n||n&&this.mediaRequiresPlayActivity(n);return!(!d||!p||!h&&!y)}alwaysSendForActivityType(e){return e===ot.playerActivate||e===ot.playerExit}mediaRequiresPlayActivity(e){return void 0!==(n=e.type)&&Ho.includes(n)||-1!==["musicMovie","musicVideo","song","radioStation"].indexOf(e.type);var n}constructor(){_define_property$8(this,"instance",void 0),_define_property$8(this,"services",void 0),_define_property$8(this,"_activityTracker",void 0),_define_property$8(this,"reportTimedMetadata",new Set),_define_property$8(this,"musicLiveVideoStartTime",0),_define_property$8(this,"dispatchTable",new Map([[ot.playbackPlay,"play"],[ot.playbackPause,"pause"],[ot.playbackScrub,"scrub"],[ot.playbackSeek,"seek"],[ot.playbackSkip,"skip"],[ot.playbackStop,"stop"],[ot.playerActivate,"activate"],[ot.playerExit,"exit"],[ot.timedMetadata,"timedMetadata"]]))}}function generateItemDescriptorForPAF(e,n,d){const p=_object_spread$6({},function(e,n,d){if(void 0===(null==d?void 0:d.playbackActions)||void 0===n)return{};const p={[Li.all]:pt.REPEAT_ALL,[Li.none]:pt.REPEAT_OFF,[Li.one]:pt.REPEAT_ONE},h={[io.off]:ht.SHUFFLE_OFF,[io.songs]:ht.SHUFFLE_ON};return{playMode(){let e=pt.REPEAT_UNKNOWN,n=ht.SHUFFLE_UNKNOWN,y=yt.AUTO_UNKNOWN;const{playbackActions:_}=d;var m;return _&&(_.includes(Ei.REPEAT)&&(e=p[d.repeatMode]),_.includes(Ei.SHUFFLE)&&(n=h[d.shuffleMode]),_.includes(Ei.AUTOPLAY)&&(y=d.autoplayEnabled&&void 0!==d.queue?(m=d.queue).hasAutoplayStation&&m.items.some(e=>{const{id:n,type:d,container:p}=e;if(p&&"stations"===p.type&&p.name===st.RADIO)return!1;let h=d;return isLibraryType(n)&&(h=h.startsWith("library-")?h:"library-"+h),function(e){return null!==e.match(/-?songs$/i)}(normalizeMediaType(h))})?yt.AUTO_ON:yt.AUTO_ON_CONTENT_UNSUPPORTED:yt.AUTO_OFF)),{repeatPlayMode:e,shufflePlayMode:n,autoplayMode:y}}}}(0,d,n),function(e,n){var d;if(!typeRequiresItem(e))return{};if(void 0===n)return{};const p=null===(d=n.attributes)||void 0===d?void 0:d.mediaKind;return _object_spread$6({},void 0!==p?{mediaType:p}:{},n.playParams)}(e,d),function(e,n){if(!typeRequiresItem(e)||void 0===n)return{};const{context:d={}}=n;return{recoData:d.reco_id}}(e,d),function(e,n){if(!typeRequiresItem(e)||void 0===n)return{};const d=n.playbackDuration;if(!d)return{};return{duration:d/1e3}}(e,d),function(e,n){var d,p,h,y;const _=function(e,n){var d;return itemIsRequired(e,n)&&(null==n||null===(d=n.container)||void 0===d?void 0:d.name)||null}(e,n),m=itemIsRequired(e,n)?_object_spread$6({},null==n?void 0:n.container,null==n||null===(p=n.container)||void 0===p||null===(d=p.attributes)||void 0===d?void 0:d.playParams,(null==n||null===(y=n.container)||void 0===y||null===(h=y.attributes)||void 0===h?void 0:h.hasCollaboration)&&{isCollaborative:!0}):null;if(null===_&&null===m)return;return{container:cleanContainer(_object_spread$6({},m,null!==_?{name:_}:{}))}}(e,d));return zo.trace("PAF descriptor",p),p}const Yo=BooleanDevFlag.register("mk-use-paf-qa-endpoint");const typeRequiresItem=e=>[ot.playbackPlay,ot.playbackSkip].includes(e),itemIsRequired=(e,n)=>void 0!==n&&typeRequiresItem(e);function cleanContainer(e){const n=_object_spread$6({},e);return delete n.attributes,n}function shortHex(e,n=12){if(e instanceof Uint8Array&&(e=toHexString(e)),"string"==typeof e){const d=Math.floor(n/2);return e.length>n?e.slice(0,d)+"..."+e.slice(-d):e}return"0x0000"}function asyncGeneratorStep$6(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$6(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$6(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$6(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$7(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$5(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$7(e,n,d[n])}))}return e}function _object_spread_props$3(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}const Wo=Qe.createChild("lyrics");class LyricsTracker{get requestedEvents(){return Array.from(this.dispatchTable.keys())}get activityTracker(){if(void 0===this.instance||void 0===this.services)throw new MKError(MKError.Reason.CONFIGURATION_ERROR,"Lyrics Play Activity service was called before configuration.");var e,n,d;return void 0===this._activityTracker&&(this._activityTracker=(e=this.instance,n={runtime:this.services.runtime,request:this.services.request},new LyricsPlayActivity(e.developerToken,e.musicUserToken,e.storefrontCountryCode,{app:{build:Fi.app.build,name:null!==(d=Fi.app.name)&&void 0!==d?d:"",version:Fi.app.version},fetch:n.request.fetch,logInfo:Wo.level<=$.INFO,sourceType:e.sourceType,isQA:Qo.enabled,userIsSubscribed:()=>e.isAuthorized&&Bi.storekit._getIsActiveSubscription.getCachedValue()}))),this._activityTracker}get isConfigured(){return void 0!==this.instance}static configure(e){var n=this;return _async_to_generator$6((function*(){const d=new n;return d.configure(e),d}))()}configure(e){var n=this;return _async_to_generator$6((function*(){n.instance=e.instance,n.services=e.services}))()}handleEvent(e,n,d){const p=this.dispatchTable.get(e);void 0!==p&&"function"==typeof this[p]&&this[p](d,n)}lyricsPlay(e,n){var d=this;return _async_to_generator$6((function*(){const p=null==n?void 0:n.lyrics;if(void 0===p)throw new MKError(MKError.Reason.MEDIA_DESCRIPTOR,"Key lyrics is missing from descriptor provided to lyricsPlay");if(void 0===e)throw new MKError(MKError.Reason.MEDIA_DESCRIPTOR,"Cannot display lyrics without a MediaItem");d.activityTracker.play(function(e,n,d){var p,h,y,_;return _object_spread_props$3(_object_spread$5({id:n.id,duration:0,eventType:_t.LYRIC_DISPLAY,container:_object_spread$5({},n.container,null===(h=n.container)||void 0===h||null===(p=h.attributes)||void 0===p?void 0:p.playParams)},n.playParams),{lyricDescriptor:{id:null!==(_=d.id)&&void 0!==_?_:n.id,displayType:d.displayType,language:d.language},recoData:null===(y=n.attributes)||void 0===y?void 0:y.reco_id})}(ot.lyricsPlay,e,p))}))()}lyricsStop(e,n){var d=this;return _async_to_generator$6((function*(){d.activityTracker.stop()}))()}exit(e,n){var d=this;return _async_to_generator$6((function*(){d.activityTracker.exit()}))()}constructor(){_define_property$7(this,"dispatchTable",new Map([[ot.lyricsPlay,"lyricsPlay"],[ot.lyricsStop,"lyricsStop"],[ot.playerExit,"exit"]])),_define_property$7(this,"instance",void 0),_define_property$7(this,"services",void 0),_define_property$7(this,"_activityTracker",void 0)}}const Qo=BooleanDevFlag.register("mk-use-paf-qa-endpoint");function asyncGeneratorStep$5(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$5(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$5(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$5(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$6(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread_props$2(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}class MusicKitInstance extends MKInstance{changeToMediaItem(e){var n=this,_superprop_get_changeToMediaItem=()=>super.changeToMediaItem;return _async_to_generator$5((function*(){return n.assertUserStorefront(),_superprop_get_changeToMediaItem().call(n,e)}))()}play(){var e=this,_superprop_get_play=()=>super.play;return _async_to_generator$5((function*(){return e.assertUserStorefront(),_superprop_get_play().call(e)}))()}playMediaItem(e,n){var d=this,_superprop_get_playMediaItem=()=>super.playMediaItem;return _async_to_generator$5((function*(){if(d._isPlaybackSupported())return d.assertUserStorefront(),_superprop_get_playMediaItem().call(d,e,n)}))()}setStationQueue(e){var n=this;return _async_to_generator$5((function*(){if(tt.debug("instance.setStationQueue()",e),n.assertUserStorefront(),!n._isPlaybackSupported())return void tt.warn("Playback is not supported");const d=n.services.itemLoader.convertOptionsToItemDescriptors(e);if(d.length<1)throw new MKError(MKError.Reason.CONTENT_UNAVAILABLE,"Could not parse descriptors from options");let p;const h=d[0];if("song"===h.kind||"artist"===h.kind){p=(yield n.services.itemLoader.createAutoplayStation([h],{context:e.context,withTracks:!1})).station}else{var y,_;const d=yield n.loadItems(e);if(!(null===(y=d[0])||void 0===y?void 0:y.isRadioStation)&&!(null===(_=d[0])||void 0===_?void 0:_.isRadioEpisode))throw new MKError(MKError.Reason.CONTENT_UNSUPPORTED,"Unsupported Radio Station type: "+d[0].type);p=d[0]}return n.setQueue({item:p,shuffleMode:e.shuffleMode,repeatMode:e.repeatMode,startPlaying:e.startPlaying,startTime:e.startTime,startWith:e.startWith,context:e.context,parameters:e.parameters,autoplay:e.autoplay})}))()}setQueue(e){var n=this;return _async_to_generator$5((function*(){if(tt.debug("instance.setQueue()",e),n.assertUserStorefront(),!n._isPlaybackSupported())return void tt.warn("Playback is not supported");n.signalChangeItemIntent(),n.deferPlayback();const d=yield n.loadItems(e),p=yield n.setPlaybackController(n.playbackControllerForItems(d)),h=yield p.replaceQueue(d,{context:e.context||{},shuffleMode:e.shuffleMode,repeatMode:e.repeatMode,startTime:e.startTime,startWith:e.startWith});var y;return void 0!==e.autoplay&&deprecationWarning("autoplay",{message:"autoplay has been deprecated, use startPlaying instead"}),!0===(null!==(y=e.startPlaying)&&void 0!==y?y:e.autoplay)&&(yield n.play()),h}))()}assertUserStorefront(){const e=Bi.storekit.storefrontCountryCode,n=Bi.storefrontId,d=void 0!==e&&e!==n;if(this.realm===Ae.MUSIC&&!this.previewOnly&&!0===d)throw new MKError(MKError.Reason.CONTENT_EQUIVALENT)}playNext(e,n){var d=this;return _async_to_generator$5((function*(){var p,h;if(d._isPlaybackSupported())return d.deferPlayback(),d.getPlaybackController().prependToQueue(yield d.loadItems(e),{clear:null!==(h=null!==(p=null==e?void 0:e.clear)&&void 0!==p?p:n)&&void 0!==h&&h});tt.warn("Playback is not supported")}))()}playLater(e){var n=this;return _async_to_generator$5((function*(){if(n._isPlaybackSupported())return n.deferPlayback(),n.getPlaybackController().appendToQueue(yield n.loadItems(e));tt.warn("Playback is not supported")}))()}playAt(e,n){var d=this;return _async_to_generator$5((function*(){if(d._isPlaybackSupported())return d.deferPlayback(),d.getPlaybackController().insertInQueue(yield d.loadItems(n),e);tt.warn("Playback is not supported")}))()}clearQueue(){var e=this;return _async_to_generator$5((function*(){var n;return e._mediaItemPlayback.clearNextManifest(),null===(n=e.playbackController)||void 0===n?void 0:n.clearQueue()}))()}lyricsStart(e){this.services.dispatcher.publish(ot.lyricsPlay,{item:this.nowPlayingItem,lyrics:e})}lyricsStop(){this.services.dispatcher.publish(ot.lyricsStop)}loadItems(e){var n=this;return _async_to_generator$5((function*(){var d,p;return n.services.itemLoader.loadItems(_object_spread_props$2(function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$6(e,n,d[n])}))}return e}({},e),{restricted:null!==(p=null===(d=Bi.storekit)||void 0===d?void 0:d.restrictedEnabled)&&void 0!==p&&p}))}))()}}function _define_property$5(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_metadata$2(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class SharePlaySession{updateState(e){const{displayName:n,members:d,mediaState:p}=e;n&&(this.displayName=n),d&&(this.participantCount=d.length),this.didCapabilitiesChange(p.capabilities,this.mediaState.capabilities)&&this.dispatcher.publish(Oi.capabilitiesChanged),this.mediaState=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$5(e,n,d[n])}))}return e}({},this.mediaState,p),this.dispatcher.publish(xi,this.mediaState)}shouldUpdate(e,n){return this.mediaState[e]!==n}didCapabilitiesChange(e,n){for(const d in e)if(e[d]!==n[d])return!0;return!1}checkCapability(e){const{capabilities:n}=this.mediaState;switch(e){case co.AUTOPLAY:return n.autoPlayControl;case co.REPEAT:return n.repeatControl;case co.SHUFFLE:return n.shuffleControl;case co.VOLUME:return n.volumeControl;case co.SEEK:case co.EDIT_QUEUE:case co.PAUSE:case co.SKIP_NEXT:case co.SKIP_PREVIOUS:case co.SKIP_TO_ITEM:return!0;default:return!1}}get lastKnownElapsedTime(){const{queue:e,currentPlayingIndex:n}=this.mediaState,d=e[n];return Math.round(null==d?void 0:d.attributes.elapsedTime)||0}constructor(e,n){_define_property$5(this,"id",void 0),_define_property$5(this,"displayName",void 0),_define_property$5(this,"participantCount",0),_define_property$5(this,"dispatcher",void 0),_define_property$5(this,"mediaState",{autoPlay:!1,capabilities:{autoPlayControl:!0,repeatControl:!0,shuffleControl:!0,volumeControl:!0},playbackState:be.none,volume:1,queue:[],shuffleMode:io.off,repeatMode:Li.none,currentPlayingIndex:0});const{id:d,displayName:p}=e;this.id=d,this.displayName=p,this.dispatcher=n}}!function(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);y>3&&_&&Object.defineProperty(n,d,_)}([Bind(),_ts_metadata$2("design:type",Function),_ts_metadata$2("design:paramtypes",[void 0===co?Object:co]),_ts_metadata$2("design:returntype",void 0)],SharePlaySession.prototype,"checkCapability",null);const SharePlayGuard=e=>(n,d,p)=>{const h=p.value;return p.value=function(...n){if(!this.isInSharePlay)return h.apply(this,n);e&&this.services.dispatcher.publish(e)},p};function asyncGeneratorStep$4(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$4(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$4(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$4(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$4(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _ts_decorate$1(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata$1(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}class SharePlayInstance extends MusicKitInstance{get sharePlay(){return this._sharePlay}get isInSharePlay(){return this.playbackMode===wi.SHAREPLAY_PARTICIPANT}startSharePlay(e){var n=this;return _async_to_generator$4((function*(){var d;if(void 0!==n.sharePlay)return n.sharePlay;n.savePlaybackState();const p=new SharePlaySession(e,n.services.dispatcher);return n.services.dispatcher.subscribe(xi,n.onMediaStateUpdate),n._voidPlayer=new VoidPlayer(n._createPlayerOptions()),n.playbackMode=wi.SHAREPLAY_PARTICIPANT,n._sharePlay=p,n.capabilities.updateChecker(p.checkCapability),yield n._voidPlayer.initialize(),yield n._mediaItemPlayback.setCurrentPlayer(n._voidPlayer),null===(d=n.services.playActivity)||void 0===d||d.cleanup(),p}))()}endSharePlay(){var e=this;return _async_to_generator$4((function*(){e.isInSharePlay&&(e.updateQueue([],0),e._sharePlay=void 0,e.services.dispatcher.unsubscribe(xi,e.onMediaStateUpdate),e.capabilities.updateChecker(e.getPlaybackController().hasCapabilities),e._configurePlayActivity(),e.restorePlaybackState())}))()}get shuffleMode(){return this.isInSharePlay?this._shuffleMode:this.getPlaybackController().shuffleMode}set shuffleMode(e){var n;this.isInSharePlay?e!==this._shuffleMode&&(this._shuffleMode=e,this.services.dispatcher.publish(Oi.shuffleModeDidChange,e),(null===(n=this.sharePlay)||void 0===n?void 0:n.shouldUpdate("shuffleMode",e))&&this.services.dispatcher.publish(Ci,e)):this.getPlaybackController().shuffleMode=e}get repeatMode(){return super.repeatMode}set repeatMode(e){var n;super.repeatMode=e,(null===(n=this.sharePlay)||void 0===n?void 0:n.shouldUpdate("repeatMode",this.repeatMode))&&this.services.dispatcher.publish(Mi,{repeatMode:this.repeatMode})}get autoplayEnabled(){return super.autoplayEnabled}set autoplayEnabled(e){var n;this.capabilities.canAutoplay?(super.autoplayEnabled=e,(null===(n=this.sharePlay)||void 0===n?void 0:n.shouldUpdate("autoPlay",this.autoplayEnabled))&&this.services.dispatcher.publish(Di,{autoPlay:this.autoplayEnabled})):tt.warn("Setting autoplay is not supported in this playback method")}get volume(){return super.volume}set volume(e){var n;this.capabilities.canSetVolume?(super.volume=e,(null===(n=this.sharePlay)||void 0===n?void 0:n.shouldUpdate("volume",this.volume))&&this.services.dispatcher.publish($i,{playbackState:this.volume})):tt.warn("Setting volume is not supported in this playback method")}play(){var e=this,_superprop_get_play=()=>super.play;return _async_to_generator$4((function*(){var n,d;yield _superprop_get_play().call(e),(null===(n=e.sharePlay)||void 0===n?void 0:n.shouldUpdate("playbackState",e.playbackState))&&e.services.dispatcher.publish(Ii,{playbackState:e.playbackState}),null===(d=e._voidPlayer)||void 0===d||d.startTimerProgress()}))()}pause(e){var n=this,_superprop_get_pause=()=>super.pause;return _async_to_generator$4((function*(){var d,p;yield _superprop_get_pause().call(n,e),(null===(d=n.sharePlay)||void 0===d?void 0:d.shouldUpdate("playbackState",n.playbackState))&&n.services.dispatcher.publish(Ii,{playbackState:n.playbackState}),null===(p=n._voidPlayer)||void 0===p||p.stopTimerProgress()}))()}seekToTime(e,n=ut.Manual){var d=this,_superprop_get_seekToTime=()=>super.seekToTime;return _async_to_generator$4((function*(){var p;yield _superprop_get_seekToTime().call(d,e,n),(null===(p=d.sharePlay)||void 0===p?void 0:p.lastKnownElapsedTime)!==d.currentPlaybackTime&&d.services.dispatcher.publish(ji,{elapsedTime:d.currentPlaybackTime})}))()}skipToNextItem(){var e=this,_superprop_get_skipToNextItem=()=>super.skipToNextItem;return _async_to_generator$4((function*(){return _superprop_get_skipToNextItem().call(e)}))()}skipToPreviousItem(){var e=this,_superprop_get_skipToPreviousItem=()=>super.skipToPreviousItem;return _async_to_generator$4((function*(){return _superprop_get_skipToPreviousItem().call(e)}))()}playMediaItem(e,n){var d=this,_superprop_get_playMediaItem=()=>super.playMediaItem;return _async_to_generator$4((function*(){return _superprop_get_playMediaItem().call(d,e,n)}))()}setStationQueue(e){var n=this,_superprop_get_setStationQueue=()=>super.setStationQueue;return _async_to_generator$4((function*(){return _superprop_get_setStationQueue().call(n,e)}))()}setQueue(e){var n=this,_superprop_get_setQueue=()=>super.setQueue;return _async_to_generator$4((function*(){return _superprop_get_setQueue().call(n,e)}))()}assertUserStorefront(){super.assertUserStorefront()}playNext(e,n=!1){var d=this,_superprop_get_playNext=()=>super.playNext;return _async_to_generator$4((function*(){return _superprop_get_playNext().call(d,e,n)}))()}playLater(e){var n=this,_superprop_get_playLater=()=>super.playLater;return _async_to_generator$4((function*(){return _superprop_get_playLater().call(n,e)}))()}playAt(e,n){var d=this,_superprop_get_playAt=()=>super.playAt;return _async_to_generator$4((function*(){return _superprop_get_playAt().call(d,e,n)}))()}updateQueue(e,n){if(void 0===this.queue)return;const d=e.map(e=>new MediaItem(e)),p=d[n];p&&(p.playbackType=ie.encryptedFull),this._voidPlayer&&(this._voidPlayer.nowPlayingItem=p),this.queue.updateItems(d),this.queue.position=n}onMediaStateUpdate(e,{autoPlay:n,currentPlayingIndex:d,queue:p,playbackState:h,shuffleMode:y,repeatMode:_,volume:m}){var g=this;return _async_to_generator$4((function*(){var e,b;g.updateQueue(p,d||0),h===be.paused?yield g.pause():h===be.playing&&(yield g.play()),g.autoplayEnabled=n,g.repeatMode=_,g.shuffleMode=y,g.volume=m,g.playbackRate=(null===(e=g.nowPlayingItem)||void 0===e?void 0:e.attributes.playbackRate)||1,g.seekToTime((null===(b=g.sharePlay)||void 0===b?void 0:b.lastKnownElapsedTime)||0)}))()}savePlaybackState(){const{playbackMode:e,repeatMode:n,shuffleMode:d,volume:p,autoplayEnabled:h}=this;this._previousPlaybackState={autoplayEnabled:h,playbackMode:e,repeatMode:n,shuffleMode:d,volume:p}}restorePlaybackState(){const{autoplayEnabled:e,playbackMode:n,repeatMode:d,shuffleMode:p,volume:h}=this._previousPlaybackState;this.autoplayEnabled=e,this.playbackMode=n,this.repeatMode=d,this.shuffleMode=p,this.volume=h}constructor(...e){super(...e),_define_property$4(this,"_sharePlay",void 0),_define_property$4(this,"_shuffleMode",io.off),_define_property$4(this,"_voidPlayer",void 0),_define_property$4(this,"_previousPlaybackState",{playbackMode:wi.MIXED_CONTENT,volume:1,autoplayEnabled:!1,repeatMode:Li.none,shuffleMode:io.off})}}function asyncGeneratorStep$3(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _define_property$3(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}_ts_decorate$1([SharePlayGuard(Ai),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"skipToNextItem",null),_ts_decorate$1([SharePlayGuard(Ri),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"skipToPreviousItem",null),_ts_decorate$1([SharePlayGuard(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[void 0===MediaItem?Object:MediaItem,"undefined"==typeof PlayOptions?Object:PlayOptions]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"playMediaItem",null),_ts_decorate$1([SharePlayGuard(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",["undefined"==typeof MusicKitQueueOptions?Object:MusicKitQueueOptions]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"setStationQueue",null),_ts_decorate$1([SharePlayGuard(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",["undefined"==typeof MusicKitQueueOptions?Object:MusicKitQueueOptions]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"setQueue",null),_ts_decorate$1([SharePlayGuard(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[]),_ts_metadata$1("design:returntype",void 0)],SharePlayInstance.prototype,"assertUserStorefront",null),_ts_decorate$1([SharePlayGuard(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[Object,void 0]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"playNext",null),_ts_decorate$1([SharePlayGuard(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",["undefined"==typeof MusicKitQueueOptions?Object:MusicKitQueueOptions]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"playLater",null),_ts_decorate$1([SharePlayGuard(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[Number,"undefined"==typeof MusicKitQueueOptions?Object:MusicKitQueueOptions]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"playAt",null),_ts_decorate$1([Bind(),_ts_metadata$1("design:type",Function),_ts_metadata$1("design:paramtypes",[void 0,void 0]),_ts_metadata$1("design:returntype",Promise)],SharePlayInstance.prototype,"onMediaStateUpdate",null);const Jo=Qe.createChild("ctp");class ClickToPlayTracker{get active(){return void 0!==this.rtcTracker}get isConfigured(){return this._isConfigured}configure(e){var n,d=this;return(n=function*(){var n;d.instance=e.instance,d.rtcTracker=null===(n=e.services.playActivity)||void 0===n?void 0:n.getTrackerByType(RTCStreamingTracker),d._isConfigured=!0},function(){var e=this,d=arguments;return new Promise((function(p,h){var y=n.apply(e,d);function _next(e){asyncGeneratorStep$3(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$3(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))})()}handleEvent(e,n,d){e===Oi.playInitiated?(Jo.debug("ClickToPlayTracker.handleEvent",e,n),this.registerPlay(n.item,n.timestamp)):e===Oi.mediaCanPlay&&(Jo.debug("ClickToPlayTracker.handleEvent",e,n),this.trackPlay(this.instance.nowPlayingItem,n.timestamp))}registerPlay(e,n){if(this.active&&void 0!==e){if(void 0!==n)return void 0!==this.tracking&&Jo.warn(`Replacing item ${this.tracking.item.id} with item ${e.id}`),Jo.debug(`Registering ${e.id} initiated at ${n}`),this.tracking={item:e,initiatedTimestamp:n},this.tracking;Jo.warn(`registerPlay timestamp value for item ${e.id} is missing, discarding`)}else Jo.debug("Not registring play: inactive")}trackPlay(e,n){if(!this.active||void 0===e)return void Jo.debug("Not tracking play: inactive");if(void 0===this.tracking)return void Jo.warn("ClickToPlayTracker.trackPlay called without a registered tracking item");const d=null!=n?n:Date.now(),p=this.tracking.initiatedTimestamp,h=d-p;if(Jo.debug(`trackPlay: item=${e.id}, initiated=${p}, started=${d}, timestampDiff=${h}`),p>d)return void Jo.warn("Initiated timestamp is not before started timestamp, ignoring");const y=this.getReportingAgent(e);if(void 0!==y)return Jo.info(`Reporting playback success after ${h}ms`),y.issueReportingEvent(ClickToPlayTracker.EVENT_ID,{event:"playbackStartup",playbackStartupResult:"success",tapToFirstFrame:h,PlayType:e.isLinearStream?"LIVE":"VOD"}),this.tracking=void 0,{item:e,initiatedTimestamp:p,playbackTimestamp:d};Jo.warn(`No reporting agent for ${e.id}, discarding`)}getReportingAgent(e){var n;if(void 0===this.rtcTracker)return void Jo.warn("Could not get RTCReportingAgent from RTCStreamingTracker service");const d=this.rtcTracker.getMediaIdentifiers(e),p=null===(n=this.rtcTracker.reportingAgent)||void 0===n?void 0:n.SessionInfo;if(void 0===d||void 0===p)return;if(Object.entries(d).every((function([e,n]){return p[e]===n})))return this.rtcTracker.reportingAgent;Jo.warn("RTCReportingAgent is not associated with item "+e.id)}constructor(){_define_property$3(this,"_isConfigured",!1),_define_property$3(this,"tracking",void 0),_define_property$3(this,"instance",void 0),_define_property$3(this,"rtcTracker",void 0),_define_property$3(this,"requestedEvents",[Oi.playInitiated,Oi.mediaCanPlay])}}_define_property$3(ClickToPlayTracker,"EVENT_ID",4101);var Xo={setDelegate:!0};function isDefined(e){return void 0!==e}function isDefinedNonNull(e){return isDefined(e)&&null!==e}function isEmptyString(e){return isString(e)&&0===e.length}function isEmptyArray(e){return isArray(e)&&0===e.length}function isEmptyObject(e){return isObject(e)&&0===Object.keys(e).length}function isFunction$1(e){return"function"==typeof e}function isNumber$1(e){return"number"==typeof e}function isInteger$1(e){return isNumber$1(e)&&e%1==0}function isString(e){return"string"==typeof e||e instanceof String}function isArray(e){return!!e&&e.constructor===Array}function isObject(e){return!!e&&e.constructor===Object}function hasGetterAndSetterMethods(e){return isObject(e)&&isFunction$1(e.__lookupGetter__)&&isFunction$1(e.__lookupSetter__)&&isFunction$1(e.__defineGetter__)&&isFunction$1(e.__defineSetter__)}function extend$2(e){var n=[!0,!0,!0].concat(Array.prototype.slice.call(arguments));return copyKeysAndValues.apply(null,n)}function copyKeysAndValues(e,n,d,p){for(var h,y=d&&p||{},_=3;_<arguments.length;_++)for(var m in h=arguments[_])if(Object.prototype.hasOwnProperty.call(h,m)){var g=h[m];(e||null!=g)&&(n||"function"!=typeof g)&&(y[m]=g)}return y}function attachMethods(e,n,d,p){var h=!1;if(e&&n){p=p||{},d=d||n;var captureFunction=function(e,n,d,p,h){var returnValue=function(){return d[h].apply(e,arguments)};return n&&(returnValue.origFunction=n),returnValue.attachedMethod=!0,returnValue};for(var y in n)if(!(y in p)&&n[y]&&isFunction$1(n[y])){var _=e[y],m=null;_&&isFunction$1(_)&&(m=!0===_.attachedMethod?_:_.bind(e)),e[y]=captureFunction(d,m,n,0,y),h=!0}}return h}function detachMethods(e){var n=!1;for(var d in e){if(isFunction$1(e[d])&&!0===e[d].attachedMethod)if(e[d].origFunction)for(;e[d].origFunction;)e[d]=e[d].origFunction,n=!0;else delete e[d]}return n}function globalScope(){return"undefined"!=typeof globalThis?globalThis:void 0!==n?n:"undefined"!=typeof window?window:{}}var Zo=Object.freeze({__proto__:null,_utResetNonOverridableFunctions:function(){Xo={setDelegate:!0}},shallowClone:function(e){var n,d,p={},h=hasGetterAndSetterMethods(e);for(var y in e)n=null,d=null,h&&(n=e.__lookupGetter__(y),d=e.__lookupSetter__(y)),n||d?(n&&p.__defineGetter__(y,n),d&&p.__defineSetter__(y,d)):p[y]=e[y];return p},isDefined:isDefined,isDefinedNonNull:isDefinedNonNull,isDefinedNonNullNonEmpty:function(e){return isDefinedNonNull(e)&&!isEmptyString(e)&&!isEmptyArray(e)&&!isEmptyObject(e)},isEmptyString:isEmptyString,isEmptyArray:isEmptyArray,isEmptyObject:isEmptyObject,isFunction:isFunction$1,isNumber:isNumber$1,isInteger:isInteger$1,isString:isString,isElement:function(e){return!!e&&1==e.nodeType},isArray:isArray,isObject:isObject,values:function(e){var n=[];for(var d in e){var p=e[d];e.hasOwnProperty(d)&&!isFunction$1(p)&&n.push(p)}return n},keys:function(e){var n=[];for(var d in e)e.hasOwnProperty(d)&&!isFunction$1(e[d])&&n.push(d);return n},hasAnyKeys:function(e){for(var n in e)if(e.hasOwnProperty(n))return!0},hasAnyNonNullKeys:function(e){for(var n in e)if(e.hasOwnProperty(n)&&e[n])return!0},hasGetterAndSetterMethods:hasGetterAndSetterMethods,methods:function(e){var n=[];for(var d in e){var p=e[d];e.hasOwnProperty(d)&&isFunction$1(p)&&n.push(p)}return n},invert:function(e){var n={};for(var d in e)e.hasOwnProperty(d)&&!isFunction$1(e[d])&&(n[e[d]]=d);return n},extend:extend$2,copyKeysAndValues:copyKeysAndValues,addNonOverrideableFunctions:function(e){for(var n=0;n<e.length;n++){var d=e[n];Xo[d]=!0}},attachMethods:attachMethods,detachMethods:detachMethods,attachDelegate:function(e,n,d){var p=!1;if(d=d||!1,e&&n&&e!==n){var h={};Object.keys(n).forEach((function(n){e[n]||(h[n]=!0)})),extend$2(h,Xo),p=attachMethods(e,n,d?e:null,h)}return p},setDelegates:function(e,n){var d={};for(var p in e)n[p]&&isFunction$1(e[p].setDelegate)&&(d[p]=e[p].setDelegate.apply(e[p],[n[p]].concat(Array.prototype.slice.call(arguments,2))));return d},resetDelegates:function(e){var n=!1;for(var d in e){var p=e[d];p&&"object"==typeof p&&isFunction$1(p.setDelegate)&&(n|=detachMethods(p))}return!!n},copyDelegatedFunctions:function(e,n){var d=null;if(e&&n&&n.setDelegate){var p,h={};for(p in e)isFunction$1(e[p])&&e[p].origFunction&&(h[p]=e[p]);d=n.setDelegate(h)}return d},dedupedArray:function(e,n){var d={};if(e)for(var p=0;p<e.length;p++)d[e[p]]=0;if(n)for(var h=0;h<n.length;h++)d[n[h]]=0;return Object.keys(d)},globalScope:globalScope}),ea={maxWait:1500,initialDelay:100,factor:2},ExponentialStrategy=function(e,n,d){this.delay=e||ea.initialDelay,this.maxWait=isNumber$1(n)?n:ea.maxWait,this.factor=d||ea.factor,this.timeWaited=0};ExponentialStrategy.prototype.nextDelay=function(){var e=null,n=this.maxWait-this.timeWaited;return n>0&&(this.delay=Math.min(this.delay,n),this.timeWaited+=this.delay),(0===this.maxWait||n>0)&&(e=this.delay,this.delay=this.delay*this.factor),e};var ta=Object.freeze({__proto__:null,exponentialBackoff:function(e,n,d,p,h,y){!function _backoff(e,n,d,p){n.call(n,d,(function(){var h=e.nextDelay();h?setTimeout(_backoff.bind(null,e,n,d,p),h):p.apply(p,arguments)}))}(new ExponentialStrategy(p,h,y),e,n,d)}});var ra=Object.freeze({__proto__:null,deResNumber:function(e,n,d){var p=void 0;if(isDefined(e))if(isDefined(n)||(n=1048576),isDefined(d)||(d=2),isNumber$1(e)&&isNumber$1(n)&&n>0&&isInteger$1(d)&&d>=0){var h=Math.pow(10,d);p=Math[e>0?"floor":"ceil"](e/n/h)*h}else p=NaN;return p}}),na="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxy",ia=na+"z";function snakeCaseToCamelCase(e,n){var d="";if(e)for(var p,h=e.toLowerCase().split("_"),y=0;y<h.length;y++)p=h[y][0],(0!==y||n)&&(p=p.toUpperCase()),d+=p+h[y].slice(1);return d}function randomHexCharacter(e,n,d){var p,h=globalScope(),y=h.crypto||h.msCrypto;return p=e?(16*e()|0).toString(16):y&&y.getRandomValues?(15&y.getRandomValues(new Uint8Array(1))[0]).toString(16):y&&y.randomBytes?y.randomBytes(1).toString("hex")[0]:(16*Math.random()|0).toString(16),n&&d&&(p<n||p>d)&&(p=randomHexCharacter(e,n,d)),p}var oa=Object.freeze({__proto__:null,base10Alphabet:"0123456789",base16Alphabet:"0123456789ABCDEF",base36Alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",base61Alphabet:na,base62Alphabet:ia,startsWith:function(e,n,d){var p=!1;return e&&n&&(e=e.substr(0,n.length),d&&(e=e.toLowerCase(),n=n.toLowerCase()),p=0===e.indexOf(n)),p},endsWith:function(e,n,d){var p=!1;if(e&&n){d&&(e=e.toLowerCase(),n=n.toLowerCase());var h=e.length-n.length;p=h>=0&&e.lastIndexOf(n)===h}return p},trim:function(e,n,d){var p=null,h=new RegExp("^[\t\n\v\f\r             　\u2028\u2029​]+"),y=new RegExp("[\t\n\v\f\r             　\u2028\u2029​]+$");if(e)if(d||n&&"\t\n\v\f\r             　\u2028\u2029​"!=n||!e.trim){var _=null,m=null,g=null;n&&void 0!==n?(_="["+(n=n.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1"))+"]",m=new RegExp("^"+_+"+"),g=new RegExp(_+"+$")):(_="\t\n\v\f\r             　\u2028\u2029​",m=h,g=y),p=e.replace(m,"").replace(g,"")}else p=e.trim();return p},snakeCaseToCamelCase:snakeCaseToCamelCase,snakeCaseToUpperCamelCase:function(e){return snakeCaseToCamelCase(e,!0)},exceptionString:function(e,n){return"The function "+e+"."+n+"() must be overridden with a platform-specific delegate function.If you have no data for this function, have your delegate return null or undefined (no 'return')"},paramString:function(e){var n="",d="",p=!0;for(var h in e){var y=e[h];(y||0===y||!1===y)&&(n+=d+h+"="+encodeURIComponent(y),p&&(d="&",p=!1))}return n},versionStringFromUserAgent:function(e,n){var d=null;n=n||"\\S+";var p=new RegExp("\\b"+n+"/(\\S+)\\b","i").exec(e);return p&&p[1]&&(d=p[1]),d},requestId:function(e){var n=Date.now(),d=Math.floor(1e5*Math.random());return e+"z"+(n=n.toString(36).toUpperCase())+"z"+(d=d.toString(36).toUpperCase())},uuid:function(e){for(var n,d="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",p="",h=0,y=d.length;h<y;h++)p+="x"===(n=d.charAt(h))?randomHexCharacter(e):"y"===n?randomHexCharacter(e,"8","b"):n;return p},randomHexCharacter:randomHexCharacter,convertNumberToBaseAlphabet:function(e,n){var d="",p=n.length;if(p<=36)d=e.toString(p).toUpperCase();else{for(var h,y,_=[];e>0;)h=e%p,y=n.charAt(h),_.push(y),e=(e-h)/p;d=_.reverse().join("")}return""===d&&(d="0"),d},cryptoRandomBase62String:function(e){var n;if(16777215==Math.floor(4294967295/256)){var d,p,h,y,_,m=globalScope(),g=m.crypto||m.msCrypto;if(g&&g.getRandomValues)d=g.getRandomValues(new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT)),_=!0;else if(g&&g.randomBytes){var b=g.randomBytes(16);d=new Uint32Array(b.buffer,b.byteOffset,b.byteLength/Uint32Array.BYTES_PER_ELEMENT),_=!0}else for(d=new Uint32Array(16/Uint32Array.BYTES_PER_ELEMENT),p=0;p<d.length;p++)d[p]=Math.floor(Math.random()*Math.floor(4294967295));if(d){for(n="",p=0;p<d.length;p++)for(y=d[p],h=0;h<6;h++)n+=ia[y%62],y=Math.floor(y/62);e&&(n="1_"+(_?"1":"2")+"_"+n)}}return n}});function _valueForKeyPath(e,n,d){var p=n;if(e&&n)for(var h=e.split("."),y=0;p&&y<h.length;y++){var _=h[y];!(_ in p)&&d&&(p[_]={}),p=_ in p?p[_]:null}return p}function valueForKeyPath(e){var n=null;if(e&&arguments.length>1)for(var d=sourcesArray(Array.prototype.slice.call(arguments,1)),p=d.length-1;p>=0;p--){var h=d[p];if(isDefinedNonNull(n=_valueForKeyPath(e,h)))break}return n}function sourcesArray(e){var n=[],d=[];d=d.concat(e),arguments&&arguments.length>1&&(d=d.concat(Array.prototype.slice.call(arguments,1)));for(var p=0;p<d.length;p++){var h=d[p];n=n.concat(h)}return n}var aa=Object.freeze({__proto__:null,valueForKeyPath:valueForKeyPath,createObjectAtKeyPath:function(e,n){return _valueForKeyPath(e,n,!0)},sourcesArray:sourcesArray});function mergeAndCleanEventFields(e){for(var n=[!1,!1,!1].concat(Array.prototype.slice.call(arguments)),d=[],p=0;p<n.length;p++){var h=n[p];if(h&&h.constructor===Array)for(var y=0;y<h.length;y++)d.push(h[y]);else d.push(h)}return copyKeysAndValues.apply(null,d)}var sa=Object.freeze({__proto__:null,mergeAndCleanEventFields:mergeAndCleanEventFields,processMetricsData:function(e,n,d,p){var h=mergeAndCleanEventFields(p),y=h;if(e&&n){var _={};if(d||(n=n.filter((function(e){return e in h}))),n.length)for(var m=0;m<n.length;m++){var g=n[m],b=e[g];isFunction$1(b)&&(_[g]=b.call(e,h))}y=mergeAndCleanEventFields(y,_)}return y},applyFieldsMap:function(e,n,d,p){var h,y,_;if(e&&n&&d){var m,g;if(y={},h=valueForKeyPath(n,d,d.custom))if(isArray(h))for(m=0;m<h.length;++m)isDefinedNonNull(g=e[h[m]])&&(y[h[m]]=g);else if(isObject(h)){for(var b in h)for(m=0;m<h[b].length;++m)if(isDefinedNonNull(g=valueForKeyPath(h[b][m],e))){y[b]=g;break}}else _="metrics: incorrect data type provided to applyFieldsMap (only accepts objects and Arrays)";else _="metrics: unable to get "+n+" section from fieldsMap"}else{var P=[];e||P.push("data"),n||P.push("sectionName"),d||P.push("fieldsMap"),_="metrics: missing argument(s): "+P.join(",")+" not provided to applyFieldsMap"}return _&&isFunction$1(p)&&p(_),y}});function makeAjaxRequest(e,n,d,p,h,y){var _=new XMLHttpRequest;d=d||void 0,y=y||{},p=isFunction$1(p)?p:function(){},h=isFunction$1(h)?h:function(){};var m=!1!==y.async;y.timeout&&m&&(_.timeout=y.timeout),_.onload=function(){_.status>=200&&_.status<300?p(_.response):h(new Error("XHR error: server responded with status "+_.status+" "+_.statusText),_.status)},_.onerror=function(){h(new Error("XHR error"))},_.open(n,e,m),_.withCredentials="boolean"!=typeof y.withCredentials||y.withCredentials,_.setRequestHeader("Content-type","application/json"),_.send(d)}var ca=Object.freeze({__proto__:null,makeAjaxGetRequest:function(e,n,d){makeAjaxRequest(e,"GET",null,n,d)},makeAjaxRequest:makeAjaxRequest}),la={LOCAL_STORAGE:"localStorage",SESSION_STORAGE:"sessionStorage"},_storageObject=function(e){var n=null,d=!1;return function(){return e?n=e:(d||(console.error("storageObject: storage object not found. Override this function if there is a platform-specific implementation"),d=!0),n||(n={storage:{},getItem:function(e){return this.storage[e]},setItem:function(e,n){this.storage[e]=n},removeItem:function(e){delete this.storage[e]}})),n}};function _defaultStorageObject(e){var n=null,d=e===la.LOCAL_STORAGE;try{n="undefined"!==(d?typeof localStorage:typeof sessionStorage)?d?localStorage:sessionStorage:null}catch(St){n=null,console.error("_utils.storage._defaultStorageObject: Unable to retrieve storage object: "+St)}return n}var ua=_storageObject(_defaultStorageObject(la.LOCAL_STORAGE)),da=_storageObject(_defaultStorageObject(la.SESSION_STORAGE));var pa=Object.freeze({__proto__:null,_utDefaultStorageObject:function(e){return _defaultStorageObject(e)},localStorageObject:ua,sessionStorageObject:da,saveObjectToStorage:function(e,n,d){var p=null;if(d)try{e.setItem(n,JSON.stringify(d)),p=d}catch(St){}else p=e.removeItem(n);return p},objectFromStorage:function(e,n){var d=null,p=e.getItem(n);if(p)try{d=JSON.parse(p)}catch(St){d=void 0}return d}});function FlagSymbol(e){this.key=e}FlagSymbol.prototype.toString=function(){return this.key};var ha={flagArguments:{INCLUDE_CALL_STACK:new FlagSymbol("INCLUDE_CALL_STACK"),MIRROR_TO_SERVER:new FlagSymbol("MIRROR_TO_SERVER"),SUPPRESS_CLIENT_OUTPUT:new FlagSymbol("SUPPRESS_CLIENT_OUTPUT")},setDelegate:function(e){return Zo.attachDelegate(this,e)},execute:function(e,n,d){var p=e.levelStringToIntMap[n];if(e.level()!==e.NONE&&e.level()<=p){var h=Array.prototype.slice.call(d),y=ha.nonFlagLogArguments(h),_=ha.logOptions(e,p,h),m=_.includeCallStack?(new Error).stack:null,g=m?y.concat("\n"+m):y;if(e[n]._lastLog=g,_.mirrorToServer,_.throwInsteadOfPrint)throw new Error(y.toString());_.suppressClientOutput||(console[n]?console[n].apply(console,g):console.log.apply(console,g))}},isFlagObject:function(e){return e&&e===ha.flagArguments[e.toString()]},nonFlagLogArguments:function(e){return e.filter((function(e){return!ha.isFlagObject(e)}))},logOptions:function(e,n,d){var p,h={};return d.forEach((function(e){ha.isFlagObject(e)&&(p=oa.snakeCaseToCamelCase(e.toString()),h[p]=!0)})),Zo.isFunction(e.mirrorToServerLevel)&&e.mirrorToServerLevel()!==e.NONE&&e.mirrorToServerLevel()<=n&&(h.mirrorToServer=!0),e.throwLevel()!==e.NONE&&e.throwLevel()<=n&&(h.throwInsteadOfPrint=!0),h},sendToServer:function(e,n,d,p){}},ya={NONE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4},fa={MIN_LEVEL:ya.NONE,MAX_LEVEL:ya.ERROR,levelIntToStringMap:{0:"none",1:"debug",2:"info",3:"warn",4:"error"},levelStringToIntMap:{none:0,debug:1,info:2,warn:3,error:4}};Zo.extend(fa,ya);var _a={loggerName:"defaultLogger",level:fa.INFO,throwLevel:fa.NONE},va=!1,ma={};function Logger(e){this._loggerName=e,this._level,this._throwLevel,va||(va=!0,Zo.extend(Logger.prototype,fa),Zo.extend(Logger.prototype,ha.flagArguments))}function loggerNamed(e){var n=ma[e=e||_a.loggerName];return n||(n=new Logger(e),ma[e]=n),n}Logger.level=function(){return _a.level},Logger.throwLevel=function(){return _a.throwLevel},Logger.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},Logger.prototype.loggerName=function(){return this._loggerName},Logger.prototype.levelParameterAsInt=function(e){var n,d=null;return Zo.isString(e)?n=this.levelStringToIntMap[e.toLowerCase()]:Zo.isNumber(e)&&(n=e),n>=this.MIN_LEVEL&&n<=this.MAX_LEVEL&&(d=n),d},Logger.prototype.setLevel=function(e){var n=this.levelParameterAsInt(e);null!==n&&(this._level=n)},Logger.prototype.setThrowLevel=function(e){var n=this.levelParameterAsInt(e);null!==n&&(this._throwLevel=n)},Logger.prototype.level=function(){var e=this._level;return Zo.isNumber(e)?e:Logger.level()},Logger.prototype.levelString=function(){return this.levelIntToStringMap[this.level()]},Logger.prototype.throwLevel=function(){var e=this._throwLevel;return Zo.isNumber(e)?e:Logger.throwLevel()},Logger.prototype.debug=function(){ha.execute(this,"debug",arguments)},Logger.prototype.info=function(){ha.execute(this,"info",arguments)},Logger.prototype.warn=function(){ha.execute(this,"warn",arguments)},Logger.prototype.error=function(){ha.execute(this,"error",arguments)},Logger.prototype.lastLog=function(e){return this[e]?this[e]._lastLog:null},Logger.level,Logger.throwLevel;var Environment$4=function(){};Environment$4.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},Environment$4.prototype.localStorageObject=pa.localStorageObject,Environment$4.prototype.sessionStorageObject=pa.sessionStorageObject;var Network=function(){};Network.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},Network.prototype.makeAjaxRequest=ca.makeAjaxRequest;var ga,ba={configBaseUrl:"https://xp.apple.com/config/1/report",disabled:!0},_appendSectionAndSubsectionToConfigSources=function(e,n,d){if(d){e.push(d);var p=d[n];p&&Zo.hasAnyKeys(p)&&e.push(p)}},Config=function(e){this.environment=new Environment$4,this.network=new Network,this.logger=new Logger("mt-client-config"),this._topic=e||"noTopicConfig",this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._keyPathsThatSuppressWarning={configBaseUrl:!0},this._configFetchPromise=null,this.DEBUG_SOURCE_KEY="mtClientConfig_debugSource_"+this._topic,this.CACHED_SOURCE_KEY="mtClientConfig_cachedSource_"+this._topic};Config.defaultConfig=function(){return ga||(ga=new Config("noTopicConfig")),ga},Config.prototype._defaults=function(){return ba},Config.prototype._setInitialized=function(e){this._initialized=e},Config.prototype._setInitCalled=function(e){this._initCalled=e},Config.prototype._setShowedDebugWarning=function(e){this._showedDebugWarning=e},Config.prototype._setShowedNoProvidedSourceWarning=function(e){this._showedNoProvidedSourceWarning=e},Config.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},Config.prototype.resetDelegate=function(){Zo.detachMethods(this),Zo.resetDelegates(this)},Config.prototype.topic=function(){return this._topic},Config.prototype.configHostname=function(){},Config.prototype.configUrl=function(){var e=this.configHostname();return(e?Promise.resolve("https://"+e+"/config/1/report"):this.value("configBaseUrl")).then(function(e){return"noTopicConfig"!==this._topic?e+="/"+this.topic():this.logger.error("config.configUrl(): Topic must be provided"),e}.bind(this))},Config.prototype.sources=function(){},Config.prototype.value=function(e,n){var d=function(){var d,p=this.cachedSource(),h=this.serviceSource(),y=this.sources(),_=this.debugSource(),m=p||h||y||_;return y||h||e in this._keyPathsThatSuppressWarning||this._showedNoProvidedSourceWarning||(this._showedNoProvidedSourceWarning=!0,this.logger.warn("Metrics config: No config provided via delegate or fetched via init(), using cached config values.")),_&&(this._showedDebugWarning||(this._showedDebugWarning=!0,this.logger.warn('"debugSource" found.\nThis will override any same-named client-supplied configSource fields.\nThis setting "sticks" across session, use "setDebugSource(null)" to clear'))),Zo.isArray(y)||(y=[y]),d="disabled"===e?m?[p,h,y,_]:[ba]:[ba,p,h,y,_],d=this.configSourcesWithOverrides(d,n||this.topic()),aa.valueForKeyPath.apply(null,[e].concat(d))}.bind(this);if(this._configFetchPromise)return this._configFetchPromise.then(d);var p=d();return Promise.resolve(p)},Config.prototype.configSourcesWithOverrides=function(e,n){var d=e;if(e&&e.length&&n){d=[];for(var p=0;p<e.length;p++){var h=e[p];if(h)if(Zo.isArray(h)&&h.length){for(var y=[],_=0;_<h.length;_++)_appendSectionAndSubsectionToConfigSources(y,n,h[_]);d.push(y)}else _appendSectionAndSubsectionToConfigSources(d,n,h)}}return d},Config.prototype.setDebugSource=function(e){return this._debugSource=e||null,pa.saveObjectToStorage(this.environment.localStorageObject(),this.DEBUG_SOURCE_KEY,this._debugSource)},Config.prototype.debugSource=function(){return this._debugSource||(this._debugSource=pa.objectFromStorage(this.environment.localStorageObject(),this.DEBUG_SOURCE_KEY)),this._debugSource},Config.prototype.setCachedSource=function(e){return this._cachedSource=e||null,pa.saveObjectToStorage(this.environment.localStorageObject(),this.CACHED_SOURCE_KEY,this._cachedSource)},Config.prototype.cachedSource=function(){return this._cachedSource||(this._cachedSource=pa.objectFromStorage(this.environment.localStorageObject(),this.CACHED_SOURCE_KEY)),this._cachedSource},Config.prototype.setServiceSource=function(e){return this._serviceSource=e,this._serviceSource},Config.prototype.serviceSource=function(){return this._serviceSource},Config.prototype.init=function(e){var n="noTopicConfig"===this._topic||!Zo.isFunction(e);if(n&&this.logger.warn("config.init(): Falling back to default config because configSourcesFn or a valid topic was not provided"),this._initCalled||n)return Promise.resolve(this);this._initCalled=!0;var d=this;return this._configFetchPromise=Promise.resolve(e()).then((function(e){return d.setDelegate({sources:function(){return e}}),d._initialized=!0,d})).catch((function(e){throw d._initCalled=!1,d._initialized=!1,e})),this._configFetchPromise},Config.prototype.cleanup=function(){this._initCalled=this._initialized=!1,this.setCachedSource(),this.setDebugSource(),this.resetDelegate(),this.environment=null,this.network=null,this.logger=null,this._topic=null,this._debugSource=null,this._cachedSource=null,this._serviceSource=null,this._initCalled=!1,this._initialized=!1,this._showedDebugWarning=!1,this._showedNoProvidedSourceWarning=!1,this._configFetchPromise=null},Config.prototype.initialized=function(){return this._initialized};var MetricsConfig=function(e){Config.call(this,e)};function dedupedArray(e,n){var d={};if(e)for(var p=0;p<e.length;p++)d[e[p]]=0;if(n)for(var h=0;h<n.length;h++)d[n[h]]=0;return Object.keys(d)}(MetricsConfig.prototype=Object.create(Config.prototype)).constructor=MetricsConfig,MetricsConfig.prototype.disabled=function(e){return this.value("disabled",e).then((function(e){return!!e}))},MetricsConfig.prototype.blacklistedEvents=function(e){return this.denylistedEvents(e)},MetricsConfig.prototype.denylistedEvents=function(e){var n=this.value("blacklistedEvents",e).then((function(e){return e||[]})).catch((function(){return[]})),d=this.value("denylistedEvents",e).then((function(e){return e||[]})).catch((function(){return[]}));return Promise.all([n,d]).then((function(e){return dedupedArray(e[0],e[1])}))},MetricsConfig.prototype.blacklistedFields=function(e){return this.denylistedFields(e)},MetricsConfig.prototype.denylistedFields=function(e){var n=this.value("blacklistedFields",e).then((function(e){return e||[]})).catch((function(){return[]})),d=this.value("denylistedFields",e).then((function(e){return e||[]})).catch((function(){return[]}));return Promise.all([n,d]).then((function(e){return dedupedArray(e[0],e[1])}))},MetricsConfig.prototype.removeBlacklistedFields=function(e,n){return this.removeDenylistedFields(e,n)},MetricsConfig.prototype.removeDenylistedFields=function(e,n){return e?this.denylistedFields(n).then((function(n){for(var d=0;d<n.length;d++){var p=n[d];p&&p in e&&delete e[p]}return e})):Promise.resolve(e)},MetricsConfig.prototype.metricsDisabledOrBlacklistedEvent=function(e,n){return this.metricsDisabledOrDenylistedEvent(e,n)},MetricsConfig.prototype.metricsDisabledOrDenylistedEvent=function(e,n){return this.disabled(n).then(function(d){return d||!!e&&this.denylistedEvents(n).then((function(n){return n.indexOf(e)>-1}))}.bind(this))},MetricsConfig.prototype.deResFields=function(e){return this.value("deResFields",e).then((function(e){return e||[]}))},MetricsConfig.prototype.applyDeRes=function(e,n){return e?this.deResFields(n).then((function(n){var d;return n.forEach((function(n){(d=n.fieldName)in e&&(e[d]=ra.deResNumber(e[d],n.magnitude,n.significantDigits))})),e})):Promise.resolve(e)};var Delegates=function(e,n){if(!Zo.isDefinedNonNullNonEmpty(e)||!Zo.isString(e))throw new Error("No valid topic was provided to Delegates.");this.config=this.getOrCreateConfig(e),Zo.isDefinedNonNull(n)&&(this.environment=n.environment,this.eventRecorder=n.eventRecorder),this._useOrginalContextForDelegateFunc=!1};function AbstractEventRecorder(){this._operationPromiseChain=Promise.resolve()}Delegates.prototype.init=function(){if(!Zo.isDefinedNonNull(this.environment))throw new Error("No environment was provided to Delegate options.");if(!Zo.isDefinedNonNull(this.eventRecorder))throw new Error("No eventRecorder was provided to Delegate options.");this.config.environment.setDelegate(this.environment),this.config.logger.setDelegate(this.logger),this.config.network.setDelegate(this.network);var e=Zo.isFunction(this.configSources)?this.configSources.bind(this):null;return this.config.init(e)},Delegates.prototype.mergeDelegates=function(e){for(var n in e)this[n]||(this[n]=e[n]);this.config.setDelegate(e.config)},Delegates.prototype.cleanup=function(){Zo.isFunction(this.eventRecorder.cleanup)&&this.eventRecorder.cleanup(),this.config=null,this.eventRecorder=null,this.environment=null},Delegates.prototype.setEventRecorder=function(e){return Zo.isDefinedNonNull(e)&&(Zo.isDefinedNonNull(this.eventRecorder)?(Zo.setDelegates(this.eventRecorder,e),this.eventRecorder.setDelegate(e)):this.eventRecorder=e),this},Delegates.prototype.setEnvironment=function(e){if(Zo.isDefinedNonNull(this.environment)){var n=Object.create(this.environment);Zo.extend(n,e),this.environment=n}else this.environment=e;return this},Delegates.prototype.setConfig=function(e){return this.config.setDelegate(e),this},Delegates.prototype.getOrCreateConfig=function(e){return Zo.isDefinedNonNull(this.config)||(this.config=new MetricsConfig(e)),this.config},Delegates.prototype.configSources=function(){throw new Error("This method should be implemented by subdelegates.")},AbstractEventRecorder.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},AbstractEventRecorder.prototype.recordEvent=function(e,n){var d=Array.prototype.slice.call(arguments,2),p=this;return this._operationPromiseChain=this._operationPromiseChain.then((function(){return Promise.resolve(n).then((function(n){return p._recordEvent.apply(p,[e,n].concat(d))}))})),this._operationPromiseChain},AbstractEventRecorder.prototype.flushUnreportedEvents=function(){var e=Array.prototype.slice.call(arguments),n=this;return this._operationPromiseChain.then((function(){return n._operationPromiseChain=Promise.resolve(),n._flushUnreportedEvents.apply(n,e)}))},AbstractEventRecorder.prototype._recordEvent=function(e,n){},AbstractEventRecorder.prototype._flushUnreportedEvents=function(e){};var Pa={setDelegate:function(e){return Zo.attachDelegate(this,e)},globalScope:function(){return Zo.globalScope()}},Sa={AJAX:"ajax",AJAX_SYNCHRONOUS:"ajaxSynchronous",IMAGE:"image",BEACON:"beacon",BEACON_SYNCHRONOUS:"beaconSynchronous"},Ta=["dsId","consumerId"];function cloneTopicConfigWithTopic(e,n){var d={_topic:n};return Object.setPrototypeOf(d,e),d}var Base$3=function(e){this._validateConfig(e),this._config=e,this._topicConfigCache={},this._topicPropsCache={},this.logger=loggerNamed("mt-event-queue")};Base$3.prototype._validateConfig=function(e){var n="please call constructor with a valid Config instance first.";if(!e)throw new TypeError("Unable to find config, "+n);if(!e.topic||!Zo.isFunction(e.topic))throw new TypeError("Unable to find config.topic function, "+n);if(!e.metricsDisabledOrDenylistedEvent||!Zo.isFunction(e.metricsDisabledOrDenylistedEvent))throw new TypeError("Unable to find config.metricsDisabledOrDenylistedEvent function, "+n);if(!e.removeDenylistedFields||!Zo.isFunction(e.removeDenylistedFields))throw new TypeError("Unable to find config.removeDenylistedFields function, "+n)},Base$3.prototype._removeIdentifiableFieldsForTopic=function(e,n){this._topicPropsCache[e]=this._topicPropsCache[e]||{},this._topicPropsCache[e].anonymous&&Ta.forEach((function(e){delete n[e]}))},Base$3.prototype._record=function(e){},Base$3.prototype.cleanup=function(){this._config=null,this._topicConfigCache=null,this._topicPropsCache={}},Base$3.prototype.recordEvent=function(e,n){if(!this._config||!n)return Promise.resolve(null);var d=this._config,p=this,h=arguments;return Zo.isDefinedNonNullNonEmpty(e)&&e!==d.topic()&&((d=this._topicConfigCache[e])||(d=this._topicConfigCache[e]=cloneTopicConfigWithTopic(this._config,e))),d.metricsDisabledOrDenylistedEvent(n.eventType).then((function(y){return y?null:d.removeDenylistedFields(n).then((function(){return p._removeIdentifiableFieldsForTopic(e,n),p._record.apply(p,[d].concat(Array.prototype.slice.call(h,1)))})).then((function(){return n}))})).catch((function(e){return p.logger.error(e),null}))},Base$3.prototype.sendMethod=function(){return"javascript"},Base$3.prototype.setProperties=function(e,n){this._topicPropsCache[e]=this._topicPropsCache[e]||{},this._topicPropsCache[e]=n};var ka={setDelegate:function(e){return Zo.attachDelegate(this,e)},makeAjaxRequest:ca.makeAjaxRequest};function _isIOS(){var e=navigator.userAgent;return/iPad|iPhone|iPod/.test(e)&&-1==e.indexOf("IEMobile")}function _logger(){return loggerNamed("mt-event-queue")}var Ea=1e4,wa="events",Oa="1.0",Ia=100,$a=2,Aa=Sa,Ra=2,Ca="properties",Ma={eventQueues:{},postIntervalEnabled:!0,enqueueEvent:function(e,n){if(e&&n&&e.topic()){var d=e.topic();return Ma.eventQueues=Ma.eventQueues||{},Ma.eventQueues[d]=Ma.eventQueues[d]||{},Ma.eventQueues[d].topicConfig=e,Ma.eventQueues[d].flushConfig=Ma.eventQueues[d].flushConfig||{},Ma.eventQueues[d][wa]=Ma.eventQueues[d][wa]||[],Ma.eventQueues[d][wa].push(n),0===Object.keys(Ma.eventQueues[d].flushConfig).length&&Promise.all([e.value("metricsUrl"),e.value("requestTimeout"),e.value("postFrequency")]).then((function(e){var n=Ma.eventQueues[d].flushConfig;n.metricsUrl=e[0],n.requestTimeout=e[1],n.postFrequency=e[2]})),e.value("maxPersistentQueueSize").then((function(e){return e=e||Ia,Ma.trimEventQueues(Ma.eventQueues,e),n}))}return Promise.resolve(null)},trimEventQueues:function(e,n){var d=Object.keys(e);d.length&&d.forEach((function(d){var p=e[d][wa];p&&p.length&&p.length>n&&(_logger().warn("eventQueue overflow, deleting LRU events: size is: "+p.length+" which is over max size: "+n),e[d][wa]=p.slice(-n))}))},resetTopicQueue:function(e){Ma.eventQueues[e]&&(Ma.eventQueues[e][wa]=null)},resetTopicRetryAttempts:function(e){Ma.eventQueues[e]&&(Ma.eventQueues[e].retryAttempts=0)},scheduleNextTopicRetryAttempt:function(e){var n=e.topic();return Ma.eventQueues[n]&&this.postIntervalEnabled?e.value("postFrequency").then((function(d){var p=Ma.eventQueues[n];p.retryAttempts=p.retryAttempts||0,p.retryAttempts++;var h=Math.pow($a,p.retryAttempts)*d;Ma.resetTopicPostInterval(n),Ma.setTopicPostInterval(e,h)})):Promise.resolve()},sendEvents:function(e,n){var d=[];for(var p in Ma.eventQueues){var h=Ma.eventQueues[p].topicConfig,y=Ma.sendEventsForTopicConfig(h,e,n);d.push(y)}return Promise.all(d)},sendEventsForTopicConfig:function(e,n,d){var p=e.topic(),h=Ma.eventQueues[p];return Promise.all([e.value("testExponentialBackoff"),e.value("metricsUrl"),e.disabled(),e.value("postFrequency")]).then((function(y){var _=y[0],m=y[1],g=y[2],b=y[3];if(h&&m&&!g&&!_){if(!h.retryAttempts||!d){var P;switch(Ma.resetTopicPostInterval(p),Ma.setTopicPostInterval(e,b),n){case Aa.IMAGE:P=Ma.sendEventsViaImage(e);break;case Aa.BEACON:P=Ma.sendEventsViaBeacon(e);break;case Aa.AJAX_SYNCHRONOUS:P=Ma.sendEventsViaAjax(e,!1);break;case Aa.AJAX:default:P=Ma.sendEventsViaAjax(e,!0)}return P}}else if(_)return Ma.scheduleNextTopicRetryAttempt(e)}))},sendEventsViaImage:function(e){var n=e.topic(),d=Promise.resolve();return Ma.eventQueues[n]&&(d=resolveTopicConfigWithCallback(e,(function(e){var d=e.metricsUrl,p=-1==d.indexOf("?")?"?":"&",h=d+p+"responseType=image",y=Ma.eventQueues[n][wa];y&&y.length&&y.forEach((function(e){var d=Ma.createQueryParams(e);if(d){var p=h+"&"+d,y=new Image,_=Ma.eventQueues[n][Ca];_&&_.anonymous&&y.setAttribute("crossOrigin","anonymous"),y.src=p}})),Ma.resetTopicQueue(n)}))),d},createQueryParams:function(e){var n,d,p="";return Object.keys(e).forEach((function(h,y,_){n=e[h],d=Zo.isString(n)?n:JSON.stringify(n),p+=h+"="+encodeURIComponent(d),y<_.length-1&&(p+="&")})),p.length?p:null},sendEventsViaAjax:function(e,n){var d=Promise.resolve(),p=e.topic();if(Ma.eventQueues[p]&&Ma.eventQueues[p][wa]){var h=Ma.eventQueues[p][wa],y=enrichAndSerializeEvents(h);Ma.resetTopicQueue(p),y&&(d=resolveTopicConfigWithCallback(e,(function(d){var _=d.metricsUrl,m=d.requestTimeout,resetRetryAttempts=function(){Ma.resetTopicRetryAttempts(p)},g=Ma.eventQueues[p][Ca]||{},b={async:n,timeout:m};g.anonymous&&(b.withCredentials=!1),ka.makeAjaxRequest(_,"POST",y,resetRetryAttempts,(function(n,d){if(d>=400&&d<500)resetRetryAttempts();else{var y=Ma.eventQueues[p][wa]||[];Ma.eventQueues[p][wa]=h.concat(y),Ma.scheduleNextTopicRetryAttempt(e)}}),b)})))}return d},sendEventsViaBeacon:function(e){var n=Promise.resolve();if(!Zo.isFunction(navigator.sendBeacon))return _logger().error("navigator.sendBeacon() is not available in the environment"),n;var d=e.topic(),p=Ma.eventQueues[d];if(p){var h=p[Ca];if(h&&h.anonymous)n=Zo.isFunction(Pa.globalScope().fetch)&&!/Firefox/.test(navigator.userAgent)?Ma.sendEventsViaFetch(e,{keepalive:!0}):_isIOS()?Ma.sendEventsViaAjax(e,!1):Ma.sendEventsViaImage(e);else{var y=enrichAndSerializeEvents(p[wa]);y&&(Ma.resetTopicQueue(d),n=resolveTopicConfigWithCallback(e,(function(e){var n=e.metricsUrl,d=new(0,Pa.globalScope().Blob)([y],{type:"application/json"});navigator.sendBeacon(n,d)||_logger().error("navigator.sendBeacon() was unable to queue the data for transfer")})))}}return n},sendEventsViaFetch:function(e,n){var d=Promise.resolve(),p=e.topic(),h=Ma.eventQueues[p],y=Zo.isDefinedNonNull(n)?n.keepalive:null;if(Zo.isDefinedNonNull(h)){var _=enrichAndSerializeEvents(h[wa]);if(_){Ma.resetTopicQueue(p);var m=h[Ca]||{};d=resolveTopicConfigWithCallback(e,(function(e){var n=e.metricsUrl;Zo.globalScope().fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:_,credentials:!0===m.anonymous?"omit":"same-origin",keepalive:!Zo.isDefinedNonNull(y)||y})}))}}return d},setTopicPostInterval:function(e,n){var d=e.topic();Ma.eventQueues[d]&&n&&this.postIntervalEnabled&&(this.resetTopicPostInterval(d),Ma.eventQueues[d].postIntervalToken=Pa.globalScope().setInterval((function(){_logger().debug("MetricsKit: triggering postIntervalTimer for "+d+" at "+(new Date).toString()),Ma.sendEventsForTopicConfig(e)}),n))},resetTopicPostInterval:function(e){Ma.eventQueues[e]&&(Pa.globalScope().clearInterval(Ma.eventQueues[e].postIntervalToken),Ma.eventQueues[e].postIntervalToken=null)},resetQueuePostIntervals:function(){for(var e in Ma.eventQueues)Ma.resetTopicPostInterval(e)},setQueuePostIntervals:function(){var e=[],setTopicPostIntervalFn=function(e){return function(n){Ma.setTopicPostInterval(e,n)}};for(var n in Ma.eventQueues){var d=Ma.eventQueues[n][wa],p=Ma.eventQueues[n].topicConfig;if(d&&d.length){var h=p.value("postFrequency").then(setTopicPostIntervalFn(p));e.push(h)}}return Promise.all(e)},objectContainsValue:function(e,n){var d=!1;for(var p in e){var h=e[p];if(e.hasOwnProperty(p)&&!Zo.isFunction(h)&&h===n){d=!0;break}}return d},setProperties:function(e,n){Ma.eventQueues=Ma.eventQueues||{},Ma.eventQueues[e]=Ma.eventQueues[e]||{},Ma.eventQueues[e][Ca]=n}};function _utQueue(){return Ma}function enrichAndSerializeEvents(e){var n=null;if(e&&e.length){var d={};d.deliveryVersion=Oa,d.postTime=Date.now(),d[wa]=e;try{n=JSON.stringify(d)}catch(St){_logger().error("Error stringifying events as JSON: "+St)}}return n}function metricsUrlForConfig(e){return e.value("metricsUrl").then((function(n){return n+"/"+Ra+"/"+e.topic()}))}function resolveTopicConfigWithCallback(e,n){if(Zo.isFunction(n)){if(Zo.isString(e.metricsUrl)&&!Zo.isFunction(e.value)){var d=Zo.isFunction(e.topic)?e.topic():e.topic,p=e.metricsUrl+"/"+Ra+"/"+d,h=e.requestTimeout||Ea,y=e.postFrequency;return n({requestTimeout:Math.min(h,y),metricsUrl:p})}return Promise.all([e.value("requestTimeout"),e.value("postFrequency"),metricsUrlForConfig(e)]).then((function(e){var d=e[0]||Ea,p=e[1],h=e[2];return n({requestTimeout:Math.min(d,p),metricsUrl:h})}))}_logger().warn("No callback function is provided for resolveTopicConfigWithCallback()")}function requestTimeoutForConfig(e){return Promise.all([e.value("requestTimeout"),e.value("postFrequency")]).then((function(e){var n=e[0]||Ea,d=e[1];return Math.min(n,d)}))}function flushUnreportedEvents(e,n){return e?n===Sa.BEACON_SYNCHRONOUS?function(){for(var e in Ma.eventQueues){var n=Ma.eventQueues[e].flushConfig,d=Zo.extend({},n,{_topic:e,topic:function(){return this._topic}});Ma.sendEventsViaBeacon(d)}}():Zo.isString(n)&&Ma.objectContainsValue(Sa,n)?Ma.sendEvents(n,!0):Zo.isFunction(navigator.sendBeacon)?Ma.sendEvents(Aa.BEACON,!0):_isIOS()?Ma.sendEvents(Aa.AJAX_SYNCHRONOUS,!0):Ma.sendEvents(Aa.IMAGE,!0):Ma.sendEvents(Aa.AJAX,!0)}var QueuedEventRecorder=function(e){Base$3.apply(this,arguments)};(QueuedEventRecorder.prototype=Object.create(Base$3.prototype)).constructor=QueuedEventRecorder,QueuedEventRecorder.prototype._utResetQueue=function(){for(var e in _utQueue().eventQueues)_utQueue().resetTopicPostInterval(e);_utQueue().eventQueues={}},QueuedEventRecorder.prototype._record=function(e,n,d){return function(e,n,d){var p=e.topic();return e.disabled().then((function(h){if(!h)return e.value("postFrequency").then((function(p){return 0===p&&(d=!0),Ma.enqueueEvent(e,n).then((function(){return p}))})).then((function(n){if(d)return Ma.sendEvents(Aa.AJAX,!0);!Ma.eventQueues[p].postIntervalToken&&Ma.postIntervalEnabled&&Ma.setTopicPostInterval(e,n)}))}))}(e,n,d)},QueuedEventRecorder.prototype.SEND_METHOD=Sa,QueuedEventRecorder.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},QueuedEventRecorder.prototype.flushUnreportedEvents=function(e,n){return flushUnreportedEvents.apply(null,arguments)},QueuedEventRecorder.prototype.setProperties=function(e,n){Object.getPrototypeOf(QueuedEventRecorder.prototype).setProperties.call(this,e,n),_utQueue().setProperties(e,n)},QueuedEventRecorder.prototype.cleanup=function(){Object.getPrototypeOf(QueuedEventRecorder.prototype).cleanup.call(this),this._utResetQueue()};var ImmediateEventRecorder=function(e){Base$3.apply(this,arguments)};(ImmediateEventRecorder.prototype=Object.create(Base$3.prototype)).constructor=ImmediateEventRecorder,ImmediateEventRecorder.prototype._record=function(e,n){var d=enrichAndSerializeEvents([n]);if(d)return Promise.all([metricsUrlForConfig(e),requestTimeoutForConfig(e)]).then(function(n){var p=n[0],h={timeout:n[1]};this._topicPropsCache[e.topic()]&&this._topicPropsCache[e.topic()].anonymous&&(h.withCredentials=!1),ka.makeAjaxRequest(p,"POST",d,null,null,h)}.bind(this))};var Da=loggerNamed("mt-event-queue");function Environment$3(e){this._config=e}function EventRecorder$1(e){AbstractEventRecorder.call(this),this._proxyEventRecorder=e,this.SEND_METHOD=e.SEND_METHOD}Environment$3.prototype._document=function(){if("undefined"!=typeof document)return document;throw"metricskit-delegates-html.environment HTML delegate 'document' object not found"},Environment$3.prototype._window=function(){if("undefined"!=typeof window)return window;throw"metricskit-delegates-html.environment HTML delegate 'window' object not found"},Environment$3.prototype.browser=function(){var e=this._window().navigator.userAgent;return Zo.isDefinedNonNull(this._config)&&Zo.isDefinedNonNullNonEmpty(e)?this._config.value("browserMaps").then((function(n){if(!Zo.isDefinedNonNull(n))return null;for(var d=n.specifiedBrowsers||[],p=n.browserMap||{},h=null,y=0;y<d.length;y++){var _=d[y];if(e.indexOf(_)>-1){h=_;break}}if(!Zo.isDefinedNonNull(h)){var m=e.match(/Mozilla\/5.0 \((.*?)\)(\s|$)((.*?)\/(.*?)(\s)\(.*\))?(.*?)\/(.*?)(\s|$)/);Zo.isDefinedNonNullNonEmpty(m)&&m.length>=8&&(h=m[7])}return p[h=Zo.isDefinedNonNull(h)?h.trim():"unknown"]||h})):null},Environment$3.prototype.cookie=function(){return this._window().document.cookie},Environment$3.prototype.pageUrl=function(){return this._window().location.href},Environment$3.prototype.parentPageUrl=function(){var e,n=this._window(),d=n.parent;if(d!==n)try{e=d.location.href}catch(St){e=this._document().referrer}return e},Environment$3.prototype.pixelRatio=function(){return this._window().devicePixelRatio},Environment$3.prototype.screenHeight=function(){return this._window().screen.height},Environment$3.prototype.screenWidth=function(){return this._window().screen.width},Environment$3.prototype.userAgent=function(){return this._window().navigator.userAgent},Environment$3.prototype.windowInnerHeight=function(){return this._window().innerHeight},Environment$3.prototype.windowInnerWidth=function(){return this._window().innerWidth},Environment$3.prototype.windowOuterHeight=function(){return this._window().outerHeight},Environment$3.prototype.windowOuterWidth=function(){return this._window().outerWidth},Environment$3.prototype.timeOriginOffset=function(){var e=null,n=this._window().performance;return n&&n.timing&&(e=n.timing.navigationStart),e},Environment$3.prototype.app=function(){},Environment$3.prototype.appVersion=function(){},Environment$3.prototype.capacityData=function(){},Environment$3.prototype.capacityDataAvailable=function(){},Environment$3.prototype.capacityDisk=function(){},Environment$3.prototype.capacitySystem=function(){},Environment$3.prototype.capacitySystemAvailable=function(){},Environment$3.prototype.connectionType=function(){},Environment$3.prototype.dsId=function(){},Environment$3.prototype.hardwareBrand=function(){},Environment$3.prototype.hardwareFamily=function(){},Environment$3.prototype.hardwareModel=function(){},Environment$3.prototype.hostApp=function(){},Environment$3.prototype.hostAppVersion=function(){},Environment$3.prototype.os=function(){},Environment$3.prototype.osBuildNumber=function(){},Environment$3.prototype.osLanguages=function(){},Environment$3.prototype.osVersion=function(){},Environment$3.prototype.resourceRevNum=function(){},Environment$3.prototype.storeFrontCountryCode=function(){},Environment$3.prototype.storeFrontHeader=function(){},Environment$3.prototype.storeFrontLanguage=function(){},Environment$3.prototype.userType=function(){},EventRecorder$1.prototype=Object.create(AbstractEventRecorder.prototype),EventRecorder$1.prototype.constructor=EventRecorder$1,EventRecorder$1.prototype._recordEvent=function(e,n){return this._proxyEventRecorder.recordEvent.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.flushUnreportedEvents=function(e,n){var d=this,p=Array.prototype.slice.call(arguments);return Zo.isDefinedNonNull(this._proxyEventRecorder.SEND_METHOD)&&n===this._proxyEventRecorder.SEND_METHOD.BEACON_SYNCHRONOUS?this._proxyEventRecorder.flushUnreportedEvents.apply(this._proxyEventRecorder,arguments):this._operationPromiseChain.then((function(){return d._operationPromiseChain=Promise.resolve(),d._proxyEventRecorder.flushUnreportedEvents.apply(d._proxyEventRecorder,p)}))},EventRecorder$1.prototype._flushUnreportedEvents=function(){return this._proxyEventRecorder.flushUnreportedEvents.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.sendMethod=function(){return this._proxyEventRecorder.sendMethod.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.setProperties=function(e,n){return this._proxyEventRecorder.setProperties.apply(this._proxyEventRecorder,arguments)},EventRecorder$1.prototype.cleanup=function(){return this._proxyEventRecorder.cleanup.apply(this._proxyEventRecorder,arguments)};var WebDelegates=function(e,n){var d=this.getOrCreateConfig(e);Delegates.call(this,e,{environment:new Environment$3(d),eventRecorder:new EventRecorder$1(new QueuedEventRecorder(d))}),this.immediateEventRecorder=new EventRecorder$1(new ImmediateEventRecorder(d)),this.network=null,this.logger=null,n&&(this.mergeDelegates(n),n.environment&&this.setEnvironment(n.environment),n.eventRecorder&&this.setEventRecorder(n.eventRecorder),n.network&&this.setNetwork(n.network),n.logger&&this.setLogger(n.logger),n.config&&(n.config.url&&this.config.setDelegate({configUrl:n.config.url}),this.setConfig(n.config)))};(WebDelegates.prototype=Object.create(Delegates.prototype)).constructor=WebDelegates,WebDelegates.prototype.setEnvironment=function(e){return Pa.setDelegate(e),Delegates.prototype.setEnvironment.call(this,e)},WebDelegates.prototype.setNetwork=function(e){return e&&(this.network=e,ka.setDelegate(e)),this},WebDelegates.prototype.setLogger=function(e){return e&&(this.logger=e,Da.setDelegate(e)),this},WebDelegates.prototype.setImmediateEventRecorder=function(e){if(e){var n=Object.create(this.immediateEventRecorder);Object.assign(n,e),this.immediateEventRecorder=n}return this},WebDelegates.prototype.configSources=function(){var e=this;return new Promise((function(n,d){var onFetchSuccess=function(d){try{var p=JSON.parse(d);e.config.setCachedSource(p),e.config.setServiceSource(p),n(p)}catch(he){onFetchFailure(he)}},onFetchFailure=function(n){e.config.setCachedSource(e.config.cachedSource()),d(n)};Promise.resolve(e.config.configUrl()).then((function(n){ta.exponentialBackoff(e.config.network.makeAjaxRequest.bind(e.config.network,n,"GET",null),onFetchSuccess,onFetchFailure)})).catch(onFetchFailure)}))};var Environment$2=function(){};Environment$2.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},Environment$2.prototype.localStorageObject=pa.localStorageObject,Environment$2.prototype.sessionStorageObject=pa.sessionStorageObject,Environment$2.prototype.platformIdentifier=function(e,n,d){};var System$1=function(){this.environment=new Environment$2,this.logger=loggerNamed("mt-client-constraints")};function lookForKeyPath(e,n,d,p){return Zo.isDefined(e)&&Zo.isDefinedNonNullNonEmpty(n)&&Zo.isFunction(p)?function _lookForKeyPath(e,n,d,p,h,y,_){if(Zo.isFunction(e))return h||e;if(p.push(d),0===n.length)return _(e,d,p.slice(1).join("."),h),h||e;if(!Zo.isDefined(e))return h||e;var m=y?e:{},g=n.shift();if(g.length>2&&g.indexOf("[]")===g.length-2){g=g.slice(0,-2),p.push(g),Zo.extend(m,e);var b=m[g];if(Zo.isDefinedNonNull(b)){var P=b.map((function(e,d){var h=y?b:b.slice();return _lookForKeyPath(e,n.slice(),d,p,h,y,_),p.pop(),h[d]}));m[g]=P}}else{var S=e[g];Zo.extend(m,e),m=_lookForKeyPath(S,n,g,p,m,y,_)}return p.pop(),h?(h[d]=m,h):m}(e,n.split("."),null,[],null,d,p):e}var ja={all:{initMatchValue:!0,accumulateMatchResult:function(e,n){return e&&n}},any:{initMatchValue:!1,accumulateMatchResult:function(e,n){return e||n}}};var xa={nonEmpty:function(e,n){return!!Zo.isObject(n)&&n.hasOwnProperty(e)&&Zo.isDefinedNonNullNonEmpty(n[e])},valueMatches:function(e,n,d){if(!Zo.isObject(n))return!1;var p=n[e];return n.hasOwnProperty(e)&&d.indexOf(p)>-1},nonValueMatches:function(e,n,d){if(!Zo.isObject(n)||!Zo.isArray(d))return!1;var p=n[e];return n.hasOwnProperty(e)&&-1===d.indexOf(p)},nestedFieldMatches:function(e,n,d){if(!Zo.isObject(n)||!Zo.isObject(d))return!1;var p=d.matchType,h=d.matches;if(!Zo.isDefinedNonNullNonEmpty(h))return!1;var y=function(e){var n=ja[e];return Zo.isDefinedNonNull(n)||(n=ja.all),n}(p),_=y.initMatchValue;return lookForKeyPath(n,e,!1,(function(e,n,d,p){var m=Object.keys(h).every((function(e){var d=h[e];return!!Zo.isDefinedNonNull(xa[e])&&xa[e](n,p,d)}));_=y.accumulateMatchResult(_,m)})),!!_}},Na="overrideFieldValue",Base$2=function(){};Base$2.prototype.constrainedValue=function(e,n,d){var p=e&&e.hasOwnProperty(d)?e[d]:null;return this.applyConstraintRules(p,n)},Base$2.prototype.applyConstraintRules=function(e,n){var d=e;n&&(n.denylisted||n.blacklisted?d=null:n.hasOwnProperty(Na)&&(d=n.overrideFieldValue));return d};var La=oa.exceptionString,Base$1$1=function(e){this._constraintsInstance=e};function hostname(e){var n,d=withoutParams(e=e||"").split("/");return(n=-1===e.indexOf("//")?d[0]:d[2]).substring(n.indexOf("@")+1).split(":")[0]}function withoutParams(e,n){var d=(e||"").split("?"),p=d[0],h=function(e){return(e||"").split("#")[0]}(d[1]).split("&").filter((function(e){var d=e.split("="),p=d[0],h=d[1];return Zo.isArray(n)?-1!==n.indexOf(p):!!Zo.isObject(n)&&(Zo.isObject(n[p])&&Zo.isArray(n[p].allowedValues)&&-1!==n[p].allowedValues.indexOf(h))})).join("&");return h.length>0?p+"?"+h:p}Base$1$1.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},Base$1$1.prototype.constrainedValue=function(e,n,d,p){throw La("field_actions.Base","constrainedValue")},Base$1$1.prototype.performAction=function(e,n,d,p){return Zo.isDefinedNonNull(p)&&!Zo.isEmptyObject(p)&&(e=this.constrainedValue(e,p,d,n)),e};function generateId(e){if(!Zo.isDefinedNonNull(e)||!Zo.isInteger(e.idVersion))return"0";var n=oa.uuid(),d=e.generatedIdSeparator||"z";return(function(e){var n=[e.idVersion];e.time&&n.push(e.time);return n.map((function(e){return e.toString(16)})).join("-")}(e)+"-"+n||"").split("-").map((function(e){var n=parseInt(e,16);return oa.convertNumberToBaseAlphabet(n,oa.base61Alphabet)})).join(d)}function constrainedValue(e,n,d,p){var h=this.storageKey(p,d,n),y=this._constraintsInstance.system.environment,_=pa.objectFromStorage(y.localStorageObject(),h)||{};return _.value=this.idString(_,n),!this.rulesHaveLifespan(n)||Zo.isNumber(_.expirationTime)&&!this.timeExpired(_.expirationTime)||(_.expirationTime=this.expirationTime(n.lifespan)),pa.saveObjectToStorage(y.localStorageObject(),h,_),_.value}var Ua={};function constrainedValue$1(e,n,d,p){var h=this.storageKey(p,d,n),y=Ua[h];return y||(y=constrainedValue.apply(this,arguments),Ua[h]=y),y}var IdAction=function(){Base$1$1.apply(this,arguments)};(IdAction.prototype=Object.create(Base$1$1.prototype)).constructor=IdAction,IdAction.prototype.SCOPE_STRATEGIES={ALL:"all",MAIN_DOMAIN:"mainDomain"},IdAction.prototype.rulesHaveLifespan=function(e){return e=e||{},Zo.isNumber(e.lifespan)},IdAction.prototype.expirationTime=function(e){return e?Date.now()+e:null},IdAction.prototype.storageKey=function(e,n,d){var p=this.scope(n,d);return this.storageKeyPrefix(d,e)+(p?"_"+p:"")},IdAction.prototype.storageKeyPrefix=function(e,n){return e&&Zo.isString(e.storageKeyPrefix)&&e.storageKeyPrefix.length>0?e.storageKeyPrefix:"mtId_"+n},IdAction.prototype.scope=function(e,n){var d,p,h,y,_,m="";if(n&&(n.namespace&&(m+=n.namespace),n.scopeStrategy)){var g;switch(n.scopeStrategy){case this.SCOPE_STRATEGIES.MAIN_DOMAIN:var b=n.scopeFieldName;d=e[b],p=hostname(d).split("."),h=p[p.length-1],y=p[p.length-2],_=2,h&&2===h.length&&y&&(2===y.length||y in{com:!0,org:!0,net:!0,edu:!0,gov:!0})&&(_=3),g=p.slice(-1*_).join(".")||"unknownDomain";break;case this.SCOPE_STRATEGIES.ALL:default:g=this.SCOPE_STRATEGIES.ALL}m.length&&(m+="_"),m+=g}return m},IdAction.prototype.idString=function(e,n){var d=e?e.value:null,p=d;return(!d||Zo.isNumber(e.expirationTime)&&this.timeExpired(e.expirationTime))&&(p=this.generateId(n)),p},IdAction.prototype.generateId=function(e){return e=e||{},generateId({idVersion:this.generatedIdVersion(),time:this.expirationTime(e.lifespan),generatedIdSeparator:this.generatedIdSeparator(e.tokenSeparator)})},IdAction.prototype.generatedIdVersion=function(){return 4},IdAction.prototype.idTokenSeparator=function(){return"-"},IdAction.prototype.generatedIdSeparator=function(e){return e||"z"},IdAction.prototype.timeExpired=function(e){return e<=Date.now()},IdAction.prototype.constrainedValue=function(e,n,d,p){return d&&n&&!Zo.isEmptyObject(n)&&(e=!0===n.persistIdForSession?constrainedValue$1.apply(this,arguments):constrainedValue.apply(this,arguments)),e};var ClientId=function(e,n){this._base=e,this._idAction=new IdAction(n),this._idAction.setDelegate({storageKey:function(e,n,d){return this.storageKeyPrefix()+"_"+this.scope(n,d)}.bind(this._idAction),storageKeyPrefix:function(){return"mtClientId"}})};ClientId.prototype.constrainedValue=function(e,n){var d=n;n&&Zo.isNumber(n.expirationPeriod)&&((d=Zo.extend({},n)).lifespan=d.expirationPeriod,delete d.expirationPeriod);var p=e?e.clientId:null,h=this._idAction.performAction(p,"clientId",e,d);return this._base.applyConstraintRules(h,n)};var UrlAction=function(){Base$1$1.apply(this,arguments)};(UrlAction.prototype=Object.create(Base$1$1.prototype)).constructor=UrlAction,UrlAction.prototype.SCOPES={HOSTNAME:"hostname",FULL:"full",FULL_WITHOUT_PARAMS:"fullWithoutParams",FULL_WITH_REPLACEMENTS:"fullWithReplacements"},UrlAction.prototype.constrainedValue=function(e,n){if(e&&n&&n.scope)switch(n.scope){case this.SCOPES.HOSTNAME:e=hostname(e);break;case this.SCOPES.FULL_WITHOUT_PARAMS:e=withoutParams(e,n.allowedParams);break;case this.SCOPES.FULL_WITH_REPLACEMENTS:e=function(e,n){var d=e||"";return(n||[]).reduce((function(e,n){var d=new RegExp(n.searchPattern,n.flags),p=n.replaceVal;return e.replace(d,p)}),d)}(e,n.replacements);break;case this.SCOPES.FULL:}return e};var ParentPageUrl=function(e){this._base=e,this._urlAction=new UrlAction};ParentPageUrl.prototype.constrainedValue=function(e,n){var d=e?e.parentPageUrl:null,p=this._urlAction.performAction(d,"parentPageUrl",e,n);return this._base.applyConstraintRules(p,n)};var FieldHandlers=function(e){this.base=new Base$2,this.clientId=new ClientId(this.base,e),this.parentPageUrl=new ParentPageUrl(this.base)},LegacyTreatment=function(e){this._fieldHandlers=new FieldHandlers(e)};function updateFieldRulesets(e,n,d,p){var h=e||{};if(p=p||function(e,n,d){return e[d]||{}},n&&n[d]){var y,_,m=h[d]||{};for(y in h[d]=m,n[d]){var g=p(m,n[d],y);for(_ in m[y]=g,n[d][y])g[_]=n[d][y][_]}}return h}LegacyTreatment.prototype.applyConstraints=function(e,n){return n&&n.fieldConstraints&&(e=this.applyFieldConstraints(e,n.fieldConstraints)),e},LegacyTreatment.prototype.applyFieldConstraints=function(e,n){if(n){var d,p,h,y={};for(h in n)p=n[h],(e.hasOwnProperty(h)||!0===p.generateValue||p.hasOwnProperty(Na))&&(d=h in this._fieldHandlers?this._fieldHandlers[h].constrainedValue(e,p):this._fieldHandlers.base.constrainedValue(e,p,h),y[h]=d);for(h in y)e[h]=y[h];e=sa.mergeAndCleanEventFields(e)}return e};var LegacyConstraintGenerator=function(e){this.treatment=new LegacyTreatment(e)};LegacyConstraintGenerator.prototype.constraintsForEvent=function(e,n,d){if(!n)return Promise.resolve(null);var p=this;return Promise.resolve(n.constraintProfile(d)).then((function(e){if(!e)return null;var p="constraints.profiles."+e;return n.value(p,d)})).then((function(n){var d=null;return n&&n.precedenceOrderedRules&&(d=n.precedenceOrderedRules.reduce((function(n,d){return p.eventMatchesRule(e,d)&&(n=p.updateRules(n,d)),n}),{})),d}))},LegacyConstraintGenerator.prototype.eventMatchesRule=function(e,n){var d=!1;return e&&n.filters&&("any"===n.filters?d=!0:Zo.isObject(n.filters)&&(d=this.eventMatchesNonEmptyFields(e,n.filters.nonEmptyFields)&&this.eventMatchesFieldValues(e,n.filters.valueMatches))),d},LegacyConstraintGenerator.prototype.eventMatchesNonEmptyFields=function(e,n){var d=!1;return e&&(d=!n||!Zo.isArray(n)||n.every((function(n){return xa.nonEmpty(n,e)}))),d},LegacyConstraintGenerator.prototype.eventMatchesFieldValues=function(e,n){var d=!1;return e&&(d=!(n&&Zo.isObject(n)&&!Zo.isEmptyObject(n))||Object.keys(n).every((function(d){var p=n[d];return xa.valueMatches(d,e,p)}))),d},LegacyConstraintGenerator.prototype.updateRules=function(e,n){return updateFieldRulesets(e,n,"fieldConstraints")};var DenylistedEventAction=function(){};DenylistedEventAction.prototype.performAction=function(e,n,d){return!0!==d?e:null};var DenylistedFieldsAction=function(){};DenylistedFieldsAction.prototype.performAction=function(e,n,d){return e&&Zo.isArray(d)&&!Zo.isEmptyArray(d)?(e=Zo.extend({},e),d.forEach((function(n){delete e[n]})),Zo.isEmptyObject(e)?null:e):e};var AllowlistedFieldsAction=function(){};AllowlistedFieldsAction.prototype.performAction=function(e,n,d){if(!e||!Zo.isArray(d)||Zo.isEmptyArray(d))return e;var p={};return d.forEach((function(n){Zo.isDefinedNonNull(e[n])&&(p[n]=e[n])})),Zo.isEmptyObject(p)?null:p};var SessionizationFieldsAction=function(e){this._constraintsInstance=e};SessionizationFieldsAction.prototype.performAction=function(e,n,d){if(!Zo.isDefinedNonNull(e)||!Zo.isDefined(d))return e;if(Zo.isDefinedNonNull(d.sessionResetOptions)){if(!Zo.isDefinedNonNull(d.sessionResetOptions.filters))throw new SyntaxError('sessionizationFields Action: unable to find the required config "filters"');if(!0!==this._resetSession(e,n,d))return e}e=Zo.extend({},e);var p=this._storageKey(e,d),h=this._constraintsInstance.system.environment,y=pa.objectFromStorage(h.localStorageObject(),p)||{};this._shouldCreateNewSession(n,y,d)&&(y.sessionId=this._generateSessionId(d),y.rawFirstEventTimeInSession=n.eventTime,y.firstEventTimeInSession=e.eventTime,y.eventCount=0),y.rawLastEventTimeInSession=n.eventTime,y.lastEventTimeInSession=e.eventTime,y.eventCount+=1,pa.saveObjectToStorage(h.localStorageObject(),p,y);var _=this._getSessionFieldNames(d);return e[_.sessionId]=y.sessionId,d.sessionStartTime&&(e[_.sessionStartTime]=y.firstEventTimeInSession),e},SessionizationFieldsAction.prototype._storageKey=function(e,n){var d=this._scope(e,n);return this._storageKeyPrefix(n)+(Zo.isEmptyString(d)?"":"_"+d)},SessionizationFieldsAction.prototype._storageKeyPrefix=function(e){return e&&Zo.isString(e.storageKeyPrefix)&&e.storageKeyPrefix.length>0?e.storageKeyPrefix:"mtSessionization"},SessionizationFieldsAction.prototype._scope=function(e,n){var d="";return Zo.isDefined(n)&&(Zo.isString(n.namespace)&&(d+=n.namespace),Zo.isString(n.scopeFieldName)&&Zo.isDefinedNonNull(e[n.scopeFieldName])&&(d+="_",d+=e[n.scopeFieldName].toString())),d},SessionizationFieldsAction.prototype._generateSessionId=function(e){return generateId({idVersion:1,time:Date.now(),idTokenSeparator:"-",generatedIdSeparator:e.tokenSeparator})},SessionizationFieldsAction.prototype._shouldCreateNewSession=function(e,n,d){var p=!1;return p|=!Zo.isDefinedNonNull(n.sessionId),Zo.isDefinedNonNull(d.endSessionConditions)&&(Zo.isDefinedNonNull(d.endSessionConditions.lifespan)&&(p|=e.eventTime>=n.rawFirstEventTimeInSession+d.endSessionConditions.lifespan),Zo.isDefinedNonNull(d.endSessionConditions.idleSpan)&&(p|=e.eventTime>=n.rawLastEventTimeInSession+d.endSessionConditions.idleSpan),Zo.isDefinedNonNull(d.endSessionConditions.eventCount)&&(p|=n.eventCount>=d.endSessionConditions.eventCount)),p},SessionizationFieldsAction.prototype._resetSession=function(e,n,d){var p=d.sessionResetOptions,h=this._constraintsInstance._constraintGenerator;if(Zo.isDefinedNonNull(h)&&Zo.isDefinedNonNull(h.eventMatchesTreatment)&&h.eventMatchesTreatment(n,p)){var y=this._storageKey(e,d),_=this._constraintsInstance.system.environment;return pa.saveObjectToStorage(_.localStorageObject(),y,void 0),p.newSessionAfterReset}return!0},SessionizationFieldsAction.prototype._getSessionFieldNames=function(e){var n={sessionId:"sessionId",sessionStartTime:"sessionStartTime"};return Zo.isDefinedNonNull(e.sessionFields)&&(Zo.isDefinedNonNullNonEmpty(e.sessionFields.sessionId)&&(n.sessionId=e.sessionFields.sessionId),Zo.isDefinedNonNullNonEmpty(e.sessionFields.sessionStartTime)&&(n.sessionStartTime=e.sessionFields.sessionStartTime)),n};var ClampingEventAction=function(){};ClampingEventAction.prototype.performAction=function(e,n,d){if(!(e&&d&&Zo.isString(d.timeReference)&&Zo.isNumber(d.bucketInterval)&&Zo.isArray(d.fields)))return e;var p=e[d.timeReference];if(!Zo.isNumber(p))return e;var h=this._clampToBoundary(p,d.bucketInterval),y=h-p;return e[d.timeReference]=h,d.fields.forEach((function(n){var d=e[n];Zo.isNumber(d)&&(e[n]+=y)})),e},ClampingEventAction.prototype._clampToBoundary=function(e,n){var d=e%n,p=e-d;return d<=n/2?p:p+n};var Fa="blacklisted",Ka="denylisted",Ba="blacklistedFields",Va="denylistedFields",Ga="whitelistedFields",qa="allowlistedFields",Ha="sessionizationFields",za="clamping",EventActions=function(e){var n=new DenylistedEventAction,d=new DenylistedFieldsAction,p=new AllowlistedFieldsAction,h=new SessionizationFieldsAction(e),y=new ClampingEventAction;this._actions={},this._actions[Fa]=n,this._actions[Ka]=n,this._actions[Ba]=d,this._actions[Va]=d,this._actions[Ga]=p,this._actions[qa]=p,this._actions[Ha]=h,this._actions[za]=y};EventActions.prototype.getAction=function(e){return this._actions[e]};var NumberAction=function(){Base$1$1.apply(this,arguments)};(NumberAction.prototype=Object.create(Base$1$1.prototype)).constructor=NumberAction,NumberAction.prototype.constrainedValue=function(e,n){var d=n?n.precision:0,p=n?n.buckets:null;if(Zo.isDefinedNonNullNonEmpty(p)){var h=(p=p.slice().sort((function(e,n){return e.start-n.start})))[function(e,n){var d=-1;if(!Zo.isDefinedNonNull(n)||0===e.length||Zo.isDefinedNonNull(e[0])&&n<e[0].start)return-1;if(e[e.length-1].start<n)d=e.length-1;else for(var p=0;p<e.length;p++){var h=e[p].start;if(h===n){d=p;break}if(h>n){d=p-1;break}}return d}(p,e)];Zo.isDefinedNonNull(h)&&(e=h.value)}else Zo.isNumber(e)&&Zo.isNumber(d)&&d>0&&(e=Math.floor(e/d)*d);return e};var SerialNumberGenerator=function(e){e=e||{},this._nextRotationTime=e.nextRotationTime||Number.POSITIVE_INFINITY,this._storageKey=e.namespace||"mt_serial_number",this._initialSerialNumber=e.initialSerialNumber||0,this._rotationPeriod=e.rotationPeriod||Number.POSITIVE_INFINITY};SerialNumberGenerator.prototype.setDelegate=function(e){Zo.attachDelegate(this,e)},SerialNumberGenerator.prototype.localStorageObject=function(){return pa.localStorageObject()},SerialNumberGenerator.prototype.getNextSerialNumber=function(e){var n=this._storageKey,d=this._getCurrentSerialNumberData(n),p=d.sn;return e=Zo.isNumber(e)?e:1,p=parseInt(p,10),isNaN(p)&&(p=this._initialSerialNumber),p=this._increaseSerialNumber(p,e),d.sn=p,pa.saveObjectToStorage(this.localStorageObject(),this._storageKey,d),p},SerialNumberGenerator.prototype.resetSerialNumber=function(){var e=pa.objectFromStorage(this.localStorageObject(),this._storageKey);Zo.isDefinedNonNull(e)&&this._resetSerialNumber(e.exp)},SerialNumberGenerator.prototype.getTime=function(){return Date.now()},SerialNumberGenerator.prototype._increaseSerialNumber=function(e,n){return e+n},SerialNumberGenerator.prototype._getCurrentSerialNumberData=function(e){var n,d,p=pa.objectFromStorage(this.localStorageObject(),e);for(p?(n=p.exp,n=parseInt(n,10),p.exp=n=isNaN(n)?this._nextRotationTime:n):n=this._nextRotationTime-this._rotationPeriod;!p||this.getTime()>=n;)n=d=n+this._rotationPeriod,p=this._resetSerialNumber(d);return p},SerialNumberGenerator.prototype._resetSerialNumber=function(e){var n={};return n.exp=e,n.sn=this._initialSerialNumber,pa.saveObjectToStorage(this.localStorageObject(),this._storageKey,n),n};var TimeAction=function(){Base$1$1.apply(this,arguments),this._storage=this._constraintsInstance.system.environment.localStorageObject(),this._precisionEndTimeCache={},this._serialNumberGenerator=null};(TimeAction.prototype=Object.create(Base$1$1.prototype)).constructor=TimeAction,TimeAction.prototype.constrainedValue=function(e,n,d,p){var h=e;if(Zo.isNumber(e)&&Zo.isObject(n)&&Zo.isNumber(n.precision)&&n.precision>0){var y=this._computePrecisionStartTime(e,n);this._serialNumberGenerator=new SerialNumberGenerator({namespace:this._persistentStorageKey(n,p),nextRotationTime:y+n.precision,rotationPeriod:n.precision}),this._serialNumberGenerator.setDelegate(this._constraintsInstance.system.environment),this._serialNumberGenerator.setDelegate({getTime:function(){return e}});var _=this._serialNumberGenerator.getNextSerialNumber();h=this._computeTimestamp(y,_),this._serialNumberGenerator=null}return h},TimeAction.prototype._computeTimestamp=function(e,n){return e+n},TimeAction.prototype._persistentStorageKey=function(e,n){var d=e.namespace?"_"+e.namespace:"";return(e.storageKeyPrefix||"mtTimestamp")+d+"_"+n},TimeAction.prototype._computePrecisionStartTime=function(e,n){var d=n.precision;return Math.floor(e/d)*d};var HashAction=function(){Base$1$1.apply(this,arguments)};function buildSaltStorageKey(e,n){var d=e.namespace?"_"+e.namespace:"";return(e.storageKeyPrefix||"mtHash")+d+"_salt_"+n}(HashAction.prototype=Object.create(Base$1$1.prototype)).constructor=HashAction,HashAction.prototype.constrainedValue=function(e,n,d,p){return Zo.isDefinedNonNullNonEmpty(e)?this._loadPlatformBasedSalt(n,p).then((function(n){return function(e,n){return[e,n].map((function(e){var n=0;if(Zo.isDefinedNonNullNonEmpty(e))for(var d=0;d<e.length;d++){n=(n<<5)-n+e.charCodeAt(d)}var p=Math.abs(n);return p=parseInt(p,16),oa.convertNumberToBaseAlphabet(p,oa.base62Alphabet)})).join("")}(e,n)})):e},HashAction.prototype.timeExpired=function(e){return!!e&&e<=Date.now()},HashAction.prototype.expirationTime=function(e){return e?Date.now()+e:null},HashAction.prototype._loadPlatformBasedSalt=function(e,n){var d=null,p=this,h=e.platformBasedSalt;return Zo.isDefinedNonNull(h)?(d=this._constraintsInstance.system.environment.platformIdentifier(h.saltNamespace,"userid",h.crossDeviceSync||!0),d=Zo.isDefinedNonNull(d)?d.then((function(d){return Zo.isDefinedNonNull(d)||(p._constraintsInstance.system.logger.warn("Hash: platform returned an empty salt. Will use default salt generator to generate the salt."),d=p._getSalt(e,n)),d})):Promise.resolve(this._getSalt(e,n))):d=Promise.resolve(this._getSalt(e,n)),d},HashAction.prototype._getSalt=function(e,n){var d=this._retrieveSaltFromStorage(e,n),p=e.saltLifespan;if(!Zo.isDefinedNonNull(d)||this.timeExpired(d.expirationTime)){var h=this._constraintsInstance.system.environment.localStorageObject();d={salt:function(){for(var e="";e.length<10;)e+=oa.randomHexCharacter();return e}(),expirationTime:this.expirationTime(p)},pa.saveObjectToStorage(h,buildSaltStorageKey(e,n),d)}return d.salt},HashAction.prototype._retrieveSaltFromStorage=function(e,n){var d=this._constraintsInstance.system.environment.localStorageObject();return pa.objectFromStorage(d,buildSaltStorageKey(e,n))};var Ya="idGenerator",Wa="numberDeres",Qa="timeDeres",Ja="urlDeres",Xa="hash",FieldActions=function(e){this.actions={},this.actions[Ya]=new IdAction(e),this.actions[Wa]=new NumberAction(e),this.actions[Qa]=new TimeAction(e),this.actions[Ja]=new UrlAction(e),this.actions[Xa]=new HashAction(e)};FieldActions.prototype.getAction=function(e){return this.actions[e]};var ActionTreatment=function(e){this._eventActions=new EventActions(e),this._fieldActions=new FieldActions(e)};ActionTreatment.prototype.applyConstraints=function(e,n){var d=e;if(n&&!Zo.isEmptyObject(n)){var p=[],h=this;if(n.fieldActions&&!Zo.isEmptyObject(n.fieldActions)){var y=!1,_=d;_=Object.keys(n.fieldActions).reduce((function(e,m){var g=n.fieldActions[m];if(g){var b=g.denylisted||g.blacklisted,P=g.treatmentType,S=h._fieldActions.getAction(P);e=lookForKeyPath(e,m,!1,(function(e,n,h,P){if(b)delete P[n],y=!0;else if(g.hasOwnProperty(Na))P[n]=g[Na],y=!0;else if(S){var T=S.performAction(e,m,d,g);P[n]=T,T instanceof Promise&&p.push(T.then((function(e){lookForKeyPath(_,m,!0,(function(n,d,p,y){p===h&&(y[d]=e)}))}))),y=!0}}))}return e}),_),y&&(d=p.length>0?Promise.all(p).then((function(){return _})):_)}if(n.eventActions&&!Zo.isEmptyObject(n.eventActions)){var m=Object.keys(n.eventActions),processEventActions=function(d){return m.forEach((function(p){var y=h._eventActions.getAction(p);if(y){var _=n.eventActions[p];d=y.performAction(d,e,_)}})),d};d=d instanceof Promise?Promise.resolve(d).then((function(e){return processEventActions(e)})):processEventActions(d)}}return d};function _updateTreatment(e,n){var d=e||{};return function(e,n){e.eventActions||(e.eventActions={});var d=e.eventActions,p=n.eventActions;p&&Object.keys(p).reduce((function(e,n){var d=e[n],h=p[n];return Zo.isArray(d)?Zo.isArray(h)&&h.forEach((function(e){-1===d.indexOf(e)&&d.push(e)})):Zo.isArray(h)?e[n]=h.slice():(Zo.isObject(h)||!Zo.isObject(h)&&!Zo.isFunction(h))&&(e[n]=h),e}),d)}(d,n),function(e,n){e.fieldActions||(e.fieldActions={});updateFieldRulesets(e,n,"fieldActions",(function(e,n,d){return e[d]&&e[d].treatmentType===n[d].treatmentType?e[d]:{}}))}(d,n),d}var TreatmentGenerator=function(e){this._constraintsInstance=e,this.treatment=new ActionTreatment(e)};TreatmentGenerator.prototype._combineTreatments=function(e,n,d){var p,h=[];return Zo.isArray(e)?(e.forEach((function(e){if(e){var p="treatmentProfiles."+e,y=n.value(p,d).then((function(e){return e&&e.treatments?e.treatments:[]}));h.push(y)}})),p=Promise.all(h).then((function(e){var n=[];return e.forEach((function(e){n=n.concat(e)})),n}))):p=Promise.resolve([]),p},TreatmentGenerator.prototype.constraintsForEvent=function(e,n,d){if(!n)return Promise.resolve(null);var p=this;return Promise.resolve(n.constraintProfiles(d)).then((function(e){return Zo.isDefinedNonNull(e)?e:Promise.resolve(n.constraintProfile(d)).then((function(e){return Zo.isDefinedNonNull(e)?[e]:null}))})).then((function(e){if(Zo.isDefinedNonNull(e)){if(!Zo.isArray(e))throw new TypeError('"constraintProfiles" should be an Array, but got: '+(e?e.constructor:e));return p._combineTreatments(e,n,d).then((function(n){if(0===n.length)throw new SyntaxError("The constraintProfiles: "+e.join(", ")+" are not found in the topic config");return n}))}return Promise.resolve([])})).then((function(n){return n.reduce((function(n,d){return p.eventMatchesTreatment(e,d)&&(n=_updateTreatment(n,d)),n}),null)}))},TreatmentGenerator.prototype.eventMatchesTreatment=function(e,n){var d=n.filters;if(!Zo.isDefinedNonNull(d))return!0;if(Zo.isString(d))return"any"===d;if(0===Object.keys(d).length)throw new SyntaxError("Unable to find the filter in \n"+JSON.stringify(n));return Object.keys(d).every((function(p){var h=d[p];if(h&&Zo.isString(h))return!1;if(!h||!Zo.isObject(h)||Zo.isEmptyObject(h))throw new SyntaxError("Invalid filter object for field ("+p+") in \n"+JSON.stringify(n));return Object.keys(h).every((function(d){var y=h[d];if(xa[d])return xa[d](p,e,y);throw new SyntaxError("Unable to find the filter ("+d+") for field ("+p+")in \n"+JSON.stringify(n))}))}))};var Za={constraintProfile:function(e){return this.value("constraints.defaultProfile",e)},constraintProfiles:function(e){return this.value("defaultTreatmentProfiles",e)}};var Constraints=function(e,n){if(d=e,p=!0,(p&=Zo.isDefinedNonNull(d))&&(p&=!Zo.isEmptyObject(d),p&=Zo.isFunction(d.initialized),p&=Zo.isFunction(d.value),p&=Zo.isFunction(d.constraintProfile)),!p)throw new Error('The topic config is not a valid instance of "mt-client-config".');var d,p;this._isInitialized=!1,this._topicConfig=e,this._constraintGenerator=null,this.system=new System$1,Zo.setDelegates(this.system,n||{})};Constraints.prototype._getConstraintGenerator=function(){var e=this;return this._constraintGenerator?Promise.resolve(this._constraintGenerator):this._topicConfig.value("treatmentProfiles").then((function(n){return Zo.isDefinedNonNull(n)?e._constraintGenerator=new TreatmentGenerator(e):e._constraintGenerator=new LegacyConstraintGenerator(e),e._constraintGenerator}))},Constraints.prototype.constraintsForEvent=function(e,n){var d=this;return this._getConstraintGenerator().then((function(p){return p.constraintsForEvent(e,d._topicConfig,n)}))},Constraints.prototype.applyConstraintTreatments=function(e,n){var d=n?Promise.resolve(n):this.constraintsForEvent(e),p=this;return Promise.all([d,this._getConstraintGenerator()]).then((function(n){var d=n[0];return n[1].treatment.applyConstraints(e,d)})).catch((function(e){return p.system.logger.warn("An error occurred while applying constraints: "+e.message||e),null}))};var es,ts,rs=Constraints;function environmentBaseFieldNames(){return ts||(ts=["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].concat(["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader","storeFrontLanguage"])),ts}var ns,is=Zo.attachDelegate,as=oa.cryptoRandomBase62String,ss=oa.exceptionString;function Base$1(e){if(!Zo.isDefinedNonNull(e))throw new Error("A processor instance is required for creating BaseEventHandler.");this._processor=e,ns||(ns=!0,environmentBaseFieldNames().forEach((function(e){Base$1.prototype[e]=function(n){return n&&n.hasOwnProperty(e)?n[e]:this.environment()[e]()}})))}Base$1._className="eventHandlers.base",Base$1.prototype.setDelegate=function(e){return is(this,e)},Base$1.prototype.environment=function(){throw ss(Base$1._className,"environment")},Base$1.prototype.eventRecorder=function(){throw ss(Base$1._className,"eventRecorder")},Base$1.prototype.metricsData=function(){throw ss(Base$1._className,"metricsData")},Base$1.prototype.processMetricsData=function(){throw ss(Base$1._className,"processMetricsData")},Base$1.prototype.knownFields=function(){return es||(es=environmentBaseFieldNames().concat(["baseVersion","clientEventId","connection","eventTime","eventType","eventVersion","timezoneOffset","xpPostFrequency","xpSendMethod"])),es},Base$1.prototype.baseVersion=function(){return 1},Base$1.prototype.clientEventId=function(e){return e&&e.clientEventId||as(!0)},Base$1.prototype.connection=function(e){return e&&e.connection||this.environment().connectionType()},Base$1.prototype.dsId=function(e){return e&&e.dsId||this.environment().dsId()},Base$1.prototype.eventTime=function(e){return e&&e.eventTime||Date.now()},Base$1.prototype.eventVersion=function(e){return e&&e.eventVersion||null},Base$1.prototype.timezoneOffset=function(e){return e&&e.timezoneOffset||(new Date).getTimezoneOffset()},Base$1.prototype.xpPostFrequency=function(e){return e&&e.xpPostFrequency||this._processor.config.value("postFrequency")},Base$1.prototype.xpSendMethod=function(e){return e&&e.xpSendMethod||this.eventRecorder().sendMethod()};var cs,ls=Base$1,us=Zo.attachDelegate,ds=oa.exceptionString,ps=pa.localStorageObject,hs=pa.sessionStorageObject;function Environment$1(){cs||(cs=!0,["app","appVersion","hardwareFamily","hardwareModel","os","osBuildNumber","osLanguages","osVersion","resourceRevNum","screenHeight","screenWidth","userAgent"].forEach((function(e){Environment$1.prototype[e]=function(){throw ds(Environment$1._className,e)}})),["delegateApp","hardwareBrand","storeFrontCountryCode","storeFrontHeader","storeFrontLanguage"].forEach((function(e){Environment$1.prototype[e]=function(){}})))}Environment$1._className="system.environment",Environment$1.prototype.setDelegate=function(e){return us(this,e)},Environment$1.prototype.connectionType=function(){throw ds(Environment$1._className,"connectionType")},Environment$1.prototype.dsId=function(){},Environment$1.prototype.localStorageObject=ps,Environment$1.prototype.sessionStorageObject=hs,Environment$1.prototype.platformIdentifier=function(){};var ys=Environment$1;function MetricsData$2(){this._eventData={}}MetricsData$2.prototype.updateData=function(){Zo.extend.apply(null,[this._eventData].concat(Array.prototype.slice.call(arguments)))};var fs=MetricsData$2,_s=ys;function PlayActivityEnvironment(){_s.apply(this,arguments)}PlayActivityEnvironment.prototype=Object.create(_s.prototype),PlayActivityEnvironment.prototype.constructor=PlayActivityEnvironment,PlayActivityEnvironment.prototype.consumerId=function(){},PlayActivityEnvironment.prototype.consumerNs=function(){},PlayActivityEnvironment.prototype.isOffline=function(){},PlayActivityEnvironment.prototype.videoViewportHeight=function(){},PlayActivityEnvironment.prototype.videoViewportWidth=function(){};var vs=Zo.attachDelegate,ms=oa.exceptionString,gs="PlayActivityProcessor.system.eventRecorder",EventRecorder=function(){};EventRecorder.prototype.setDelegate=function(e){return vs(this,e)},EventRecorder.prototype.recordEvent=function(e,n){throw ms(gs,"recordEvent")},EventRecorder.prototype.sendMethod=function(){throw ms(gs,"sendMethod")},EventRecorder.prototype.flushUnreportedEvents=function(e){};var bs=loggerNamed("mt-metricskit-processor-play-activity"),System=function(){this.environment=new PlayActivityEnvironment,this.eventRecorder=new EventRecorder,this.logger=bs},EventFields=function(e){this._processor=e};EventFields.prototype.applyFieldsMap=function(e,n){return this._processor.config.value("fieldsMap").then((function(d){return sa.applyFieldsMap(e,n,d)}))};var Utils=function(e){this.eventFields=new EventFields(e)},Ps="unknown",Ss="next",Ts="previous",ks="location",Es="interval",ws="playhead",Os="scrub",Is="transition",$s="interruption",As="buffering",Rs="play",Cs="seek",Ms="playOther",Ds="skipIntro",js="skipToLive",xs="actionType",Ns="consumerId",Ls="consumerNs",Us="dsId",Fs="eventType",Ks="eventVersion",Bs="isOffline",Vs="videoViewportHeight",Gs="videoViewportWidth",qs={TYPE:{MANUAL:"manual",AUTOMATIC:"automatic",UNKNOWN:Ps},ASSET_PLACEMENT:{PRE_ROLL:"preroll",POST_ROLL:"postroll",MID_ROLL:"midroll",FEATURE:"feature",CATCH_UP_TO_LIVE:"catchUpToLive"},PLAY_START_REASON:{PLAY:Rs,PLAY_OTHER:Ms,UNPAUSE:"unpause",NEXT:Ss,PREVIOUS:Ts,SEEK:Cs,TRANSITION:Is,INTERRUPTION:$s,FOREGROUND:"foreground",FOCUS:"focus",BUFFERING:As,UNKNOWN:Ps,SKIP_TO_LIVE:js},PLAY_START_REASON_TYPE:{SKIP_INTRO:Ds,SKIP_TO_LIVE:js},PLAY_STOP_REASON:{COMPLETE:"complete",TRANSITION:Is,PLAY_OTHER:Ms,PAUSE:"pause",SEEK:Cs,NEXT:Ss,INTERRUPTION:$s,BACKGROUND:"background",EXIT:"exit",INACTIVITY:"inactivity",BUFFERING:As,ERROR:"error",FAILURE:"failure",UNKNOWN:Ps,CLOSE_PLAYER:"closePlayer",SKIP_TO_LIVE:js},PLAY_STOP_REASON_TYPE:{SKIP_INTRO:Ds,SKIP_TO_LIVE:js},SEEK_START_REASON:{NEXT:Ss,PREVIOUS:Ts,LOCATION:ks,INTERVAL:Es,PLAYHEAD:ws,SCRUB:Os,UNKNOWN:Ps,SKIP_INTRO:Ds},SEEK_STOP_REASON:{NEXT:Ss,PREVIOUS:Ts,LOCATION:ks,INTERVAL:Es,PLAYHEAD:ws,SCRUB:Os,UNKNOWN:Ps,SEEK:Cs,SKIP_INTRO:Ds},SEEK_STOP_REASON_TYPE:{SKIP_INTRO:Ds}},Hs={ACTIVITY_TYPE:{PLAY:Rs,SEEK:Cs},ACTION_TYPE:{START:"start",STOP:"stop"},EVENT_TYPE:{PLAY_ACTIVITY:"playActivity",SEEK_ACTIVITY:"seekActivity"}},zs={INCLUDES_START_POSITIONS:"includesStartPositions",INCLUDES_END_POSITIONS:"includesEndPositions"},MediaActivity=function(e,n){this._processor=e,this._activityType=n,this._startMetricsDataPromise=Promise.resolve(null),this._isStopped=!1};MediaActivity.ACTIVITY_TYPE=Hs.ACTIVITY_TYPE,Object.defineProperties(MediaActivity.prototype,{isStopped:{get:function(){return this._isStopped}},type:{get:function(){return this._activityType}},startOverallPosition:{get:function(){return this._startMetricsDataPromise?this._startMetricsDataPromise.then((function(e){return e.overallPosition})):Promise.resolve(null)}}}),Zo.extend(MediaActivity.prototype,qs),MediaActivity.prototype.started=function(e,n,d,p){var h=this._startEventHandler(),y=this;if(h){if(this._startMetricsDataPromise=h.metricsData.apply(h,arguments),this.type!=MediaActivity.ACTIVITY_TYPE.SEEK)return this._processor.system.eventRecorder.recordEvent(this._processor.config.topic(),this._startMetricsDataPromise)}else y._processor.system.logger.error('Failed to record the start event with activityType: "'+d+'" due to unexpected current type "'+this.type+'", expected "'+MediaActivity.ACTIVITY_TYPE.PLAY+'" or "'+MediaActivity.ACTIVITY_TYPE.SEEK+'"');return Promise.resolve(null)},MediaActivity.prototype.stopped=function(e,n,d,p){var h=Array.prototype.slice.call(arguments),y=this._stopEventHandler(),_=this;if(y){this._isStopped=!0;var m=this._startMetricsDataPromise.then((function(_){var m=[e,n,d,p,_].concat(Array.prototype.slice.call(h,4));return y.metricsData.apply(y,m)}));return _._processor.system.eventRecorder.recordEvent(_._processor.config.topic(),m)}return _._processor.system.logger.error('Failed to record the stop event with activityType: "'+d+'" due to unexpected current type "'+this.type+'", expected "'+MediaActivity.ACTIVITY_TYPE.PLAY+'" or "'+MediaActivity.ACTIVITY_TYPE.SEEK+'"'),Promise.resolve(null)},MediaActivity.prototype._startEventHandler=function(){var e;switch(this.type){case MediaActivity.ACTIVITY_TYPE.PLAY:e=this._processor.eventHandlers.playStart;break;case MediaActivity.ACTIVITY_TYPE.SEEK:e=this._processor.eventHandlers.seekStart}return e},MediaActivity.prototype._stopEventHandler=function(){var e;switch(this.type){case MediaActivity.ACTIVITY_TYPE.PLAY:e=this._processor.eventHandlers.playStop;break;case MediaActivity.ACTIVITY_TYPE.SEEK:e=this._processor.eventHandlers.seekStop}return e};var Ys=Zo.isInteger,TimeTracker=function(e,n,d){this._date=new Date,this._position=n,this._validatePlaybackRate(e),this._playbackRate=e,this._logger=d};Object.defineProperties(TimeTracker.prototype,{playbackRate:{get:function(){return this._playbackRate}}}),TimeTracker.prototype.update=function(e,n){this._date=new Date,this._position=n,this._validatePlaybackRate(e),this._playbackRate=e},TimeTracker.prototype.estimatedTime=function(e){var n;Ys(e)?n=e:(this._logger.error("VPAFKit error: position should be an integer"),n=Math.round(e));var d=(n-this._position)/(0==this.playbackRate?1:this.playbackRate);return this._date.getTime()+Math.round(d)},TimeTracker.prototype._validatePlaybackRate=function(e){0==e&&this._logger.error("VPAFKit error: playbackRate should not be zero.")};var Ws=Zo.attachDelegate,Qs=Zo.extend,Js=Zo.isFunction,Xs=Zo.isNumber,Zs=fs,ec=zs.INCLUDES_START_POSITIONS,tc=zs.INCLUDES_END_POSITIONS,MediaActivityTracker=function(e,n){Zs.apply(this,arguments),this._processor=e,this._playlist=n,this._playActivity=null,this._playStartPlaylistItem=null,this._seekActivity=null,this._timeTracker=null,this._shouldGenerateTransitions=!0};(MediaActivityTracker.prototype=Object.create(Zs.prototype)).constructor=MediaActivityTracker,Qs(MediaActivityTracker.prototype,qs),Object.defineProperties(MediaActivityTracker.prototype,{shouldGenerateTransitions:{get:function(){return this._shouldGenerateTransitions},set:function(e){this._shouldGenerateTransitions=e}}}),MediaActivityTracker.prototype.setDelegate=function(e){return Ws(this,e)},MediaActivityTracker.prototype.playStarted=function(e,n,d){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},MediaActivityTracker.prototype.playStartedWithPlaybackRate=function(e,n,d,p){var h=Promise.resolve(),y=this;if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var _=this._playlistItem(n,ec);_?h=this._playStarted.apply(this,[_].concat(Array.prototype.slice.call(arguments,1))).then((function(){y.shouldGenerateTransitions&&(y._timeTracker=new TimeTracker(e,n,y._processor.system.logger))})).catch((function(e){y._error(e)})):this._error('Failed to record play start event due to no active playlist item for the overall position "'+n+'".')}return h},MediaActivityTracker.prototype.playStopped=function(e,n,d){var p=this._generatePlaylistTransitionsIfNecessary(e),h=this,y=Array.prototype.slice.call(arguments);return this._hasUnstoppedActivity(this._playActivity)?p=p.then((function(){var e=h._playStopped.apply(h,Array.prototype.slice.call(y));return h._playStartPlaylistItem=null,h._timeTracker=null,e})).catch((function(e){h._error(e)})):this._error("inconsistent state: did you forget to call playStarted?"),p},MediaActivityTracker.prototype.playTransitioned=function(e){var n=this,d=Array.prototype.slice.call(arguments,1);return this.playStopped.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.TRANSITION].concat(d)).then((function(){return n.playStarted.apply(n,[e,n.TYPE.AUTOMATIC,n.PLAY_START_REASON.TRANSITION].concat(d))})).catch((function(e){n._error(e)}))},MediaActivityTracker.prototype.seekStarted=function(e,n,d){var p=Promise.resolve();if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var h=this._playlistItem(e,ec);if(h){var y=this._activityArguments.apply(this,[h].concat(Array.prototype.slice.call(arguments)));this._seekActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.SEEK);var _=this;p=this._seekActivity.started.apply(this._seekActivity,y).catch((function(e){_._error(e)}))}else this._error('Failed to record seek start event due to no active playlist item for the overall position "'+e+'".')}return p},MediaActivityTracker.prototype.seekStopped=function(e,n,d){var p=Promise.resolve(),h=this._playlistItem(e,tc);if(h&&this._hasUnstoppedActivity(this._seekActivity)){var y=this._activityArguments.apply(this,[h].concat(Array.prototype.slice.call(arguments))),_=this;p=this._seekActivity.stopped.apply(this._seekActivity,y).catch((function(e){_._error(e)}))}else this._error("inconsistent state: did you forget to call seekStarted?");return p},MediaActivityTracker.prototype.synchronize=function(e,n){if(this.shouldGenerateTransitions){var d=e>0,p=this._hasUnstoppedActivity(this._playActivity),h=Promise.resolve(),y=this;return p&&d?h=this._generatePlaylistTransitionsIfNecessary(n).then((function(){y._timeTracker.update(e,n)})).catch((function(e){y._error(e)})):p&&!d?this._error("inconsistent state: did you forget to call playStopped?"):!p&&d&&this._error("inconsistent state: did you forget to call playStarted?"),h}},MediaActivityTracker.prototype._playStarted=function(e,n,d,p){var h=this._activityArguments.apply(this,[e].concat(Array.prototype.slice.call(arguments,1)));return this._playStartPlaylistItem=e,this._playActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.PLAY),this._playActivity.started.apply(this._playActivity,h)},MediaActivityTracker.prototype._playStopped=function(e,n,d){var p=this._playStartPlaylistItem,h=this._activityArguments.apply(this,[p].concat(Array.prototype.slice.call(arguments)));return this._playActivity.stopped.apply(this._playActivity,h)},MediaActivityTracker.prototype._playlistItem=function(e,n){var d;return this._playlist&&Js(this._playlist.getItem)&&(d=this._playlist.getItem(e,n)),d||this._error("unable to get item from playlist"),d},MediaActivityTracker.prototype._playlistItems=function(e,n){var d=[];return this._playlist&&Js(this._playlist.getItems)?d=this._playlist.getItems(e,n):this._error("unable to get items from playlist"),d},MediaActivityTracker.prototype._relativePosition=function(e,n){var d;return(n=n||this._playlistItem(e))&&Xs(n.startOverallPosition)&&(d=e-n.startOverallPosition+(n.startPosition||0)),d},MediaActivityTracker.prototype._combineEventData=function(e,n){var d=this._playlist?this._playlist.eventData:null,p=e?e.eventData:null,h=[];return d&&h.push(d),p&&h.push(p),this._eventData&&h.push(this._eventData),n&&(h=h.concat(n)),h},MediaActivityTracker.prototype._activityArguments=function(e,n,d,p){var h=this._relativePosition(n,e),y=this._combineEventData(e,Array.prototype.slice.call(arguments,4)),_=[h,n,d,p].concat(y);return _},MediaActivityTracker.prototype._generatePlaylistTransitionsIfNecessary=function(e){var n=this,d=Promise.resolve();return this.shouldGenerateTransitions&&this._hasUnstoppedActivity(this._playActivity)&&(d=this._playActivity.startOverallPosition.then((function(e){return e||0})).then((function(d){var p,h,y=n._playlistItems(d,e),_=Promise.resolve();n._playlist._returnsOrderedItems||y.sort(n._playlistItemComparator);for(var m=0;m+1<y.length;m++)if(!((p=(h=y[m+1]).startOverallPosition)<=d)){if(p>=e)break;_=_.then(function(){var e=this,d=e.startOverallPosition,p={eventTime:n._timeTracker?n._timeTracker.estimatedTime(d):null};return n._playStopped(d,n.TYPE.AUTOMATIC,n.PLAY_STOP_REASON.TRANSITION,p).then((function(){return n._playStarted(e,d,n.TYPE.AUTOMATIC,n.PLAY_START_REASON.TRANSITION,p)}))}.bind(h))}return _}))),d},MediaActivityTracker.prototype._hasUnstoppedActivity=function(e){return e&&!e.isStopped},MediaActivityTracker.prototype._error=function(e){this._processor.system.logger.error(this.constructor.name+" error: "+e)},MediaActivityTracker.prototype._playlistItemComparator=function(e,n){return e.startOverallPosition==n.startOverallPosition?0:e.startOverallPosition<n.startOverallPosition?-1:1};var HLSRollItemsMediaActivityTracker=function(e,n){MediaActivityTracker.apply(this,arguments)};(HLSRollItemsMediaActivityTracker.prototype=Object.create(MediaActivityTracker.prototype)).constructor=HLSRollItemsMediaActivityTracker,Object.defineProperty(HLSRollItemsMediaActivityTracker.prototype,"shouldGenerateTransitions",{get:function(){return!1},set:function(){this._error('Changing "shouldGenerateTransitions" is not allowed in HLSRollItemsMediaActivityTracker. Please use correct play activity tracker if you need to automatically generate transition play activity events ')}}),HLSRollItemsMediaActivityTracker.prototype.playStarted=function(e,n,d,p){return this.playStartedWithPlaybackRate.apply(this,[1].concat(Array.prototype.slice.call(arguments)))},HLSRollItemsMediaActivityTracker.prototype.playStartedWithPlaybackRate=function(e,n,d,p,h){var y=Promise.resolve(),_=this;if(n<1e3*h.start||n>1e3*(h.start+h.duration))return this._error("The giving overallPosition("+n+") is not in the given roll item's timeframe."),y;if(this._hasUnstoppedActivity(this._playActivity))this._error("inconsistent state: did you forget to call playStopped?");else{var m=this._playlistItem(h);m?y=this._playStarted.apply(this,[m,n,d,p].concat(Array.prototype.slice.call(arguments,5))).catch((function(e){_._error(e)})):this._error('Failed to record play start event due to no active playlist item for the roll item info startOverallPos("'+h.start+'"), duration("'+h.duration+'").')}return y},HLSRollItemsMediaActivityTracker.prototype.jumpFromOverallPosition=function(e,n,d){var p=Promise.resolve(),h=Array.prototype.slice.call(arguments,3),y=this;return e<1e3*n.start||e>1e3*(n.start+n.duration)?(this._error("The giving overallPosition("+e+") is not in the given roll item's timeframe."),p):(this._hasUnstoppedActivity(this._playActivity)&&(p=this.playStopped.apply(this,[e,this.TYPE.AUTOMATIC,this.PLAY_STOP_REASON.NEXT].concat(h))),p=p.then((function(){return y.seekStarted.apply(y,[e,y.TYPE.AUTOMATIC,y.SEEK_START_REASON.NEXT,n].concat(h))})).then((function(){return y.seekStopped.apply(y,[1e3*d.start,y.TYPE.AUTOMATIC,y.SEEK_STOP_REASON.NEXT,d].concat(h))})).then((function(){return y.playStarted.apply(y,[1e3*d.start,y.TYPE.AUTOMATIC,y.PLAY_START_REASON.NEXT,d].concat(h))})))},HLSRollItemsMediaActivityTracker.prototype.playStopped=function(e,n,d){var p=this,h=Promise.resolve();if(this._hasUnstoppedActivity(this._playActivity)){if(e<this._playStartPlaylistItem.startOverallPosition||e>this._playStartPlaylistItem.endOverallPosition)return this._error("inconsistent state: the stop-overall-position("+e+") is out of the active rollItem("+this._playStartPlaylistItem.startOverallPosition+","+this._playStartPlaylistItem.endOverallPosition+")."),h;var y=Array.prototype.slice.call(arguments);h=h.then((function(){var e=p._playStopped.apply(p,Array.prototype.slice.call(y));return p._playStartPlaylistItem=null,p._timeTracker=null,e})).catch((function(e){p._error(e)}))}else this._error("inconsistent state: did you forget to call playStarted?");return h},HLSRollItemsMediaActivityTracker.prototype.seekStarted=function(e,n,d,p){var h=Promise.resolve();if(e<1e3*p.start||e>1e3*(p.start+p.duration))return this._error("The giving overallPosition("+e+") is not in the given roll item's timeframe."),h;if(this._hasUnstoppedActivity(this._seekActivity))this._error("inconsistent state: did you forget to call seekStopped?");else{var y=this._playlistItem(p);if(y){var _=this._activityArguments.apply(this,[y,e,n,d].concat(Array.prototype.slice.call(arguments,4)));this._seekActivity=new MediaActivity(this._processor,MediaActivity.ACTIVITY_TYPE.SEEK);var m=this;h=this._seekActivity.started.apply(this._seekActivity,_).catch((function(e){m._error(e)}))}else this._error('Failed to record seek start event due to no active playlist item for the roll item info startOverallPos("'+p.start+'"), duration("'+p.duration+'").')}return h},HLSRollItemsMediaActivityTracker.prototype.seekStopped=function(e,n,d,p){var h=Promise.resolve(),y=this._playlistItem(p);if(y&&this._hasUnstoppedActivity(this._seekActivity)){var _=this._activityArguments.apply(this,[y,e,n,d].concat(Array.prototype.slice.call(arguments,4))),m=this;h=this._seekActivity.stopped.apply(this._seekActivity,_).catch((function(e){m._error(e)}))}else this._error("inconsistent state: did you forget to call seekStarted?");return h},HLSRollItemsMediaActivityTracker.prototype._playlistItem=function(e){var n;return this._playlist&&Zo.isFunction(this._playlist.getItemForRollItem)&&(n=this._playlist.getItemForRollItem(1e3*e.start,1e3*e.duration)),n||this._error("unable to get item from playlist"),n},HLSRollItemsMediaActivityTracker.prototype._relativePosition=function(e,n){var d;return Zo.isDefinedNonNull(n)?(n&&Zo.isNumber(n.startOverallPosition)&&(d=e-n.startOverallPosition+(n.startPosition||0)),d):(this._error("please provide the active playlist item for calculating the relative position."),d)};var rc=fs,MediaPlaylistItem=function(e){rc.apply(this,arguments),this._startOverallPosition=e,this._startPosition=0};(MediaPlaylistItem.prototype=new rc).constructor=MediaPlaylistItem,Object.defineProperties(MediaPlaylistItem.prototype,{startOverallPosition:{get:function(){return this._startOverallPosition}},startPosition:{get:function(){return this._startPosition},set:function(e){this._startPosition=e}},eventData:{get:function(){return this._eventData}}});var HLSRollItem=function(e,n){MediaPlaylistItem.apply(this,arguments),this._duration=n};(HLSRollItem.prototype=new MediaPlaylistItem).constructor=HLSRollItem,Object.defineProperties(HLSRollItem.prototype,{duration:{get:function(){return this._duration}},endOverallPosition:{get:function(){return this.startOverallPosition+this.duration}}}),HLSRollItem.prototype.containsOverallPosition=function(e){return this.startOverallPosition<=e&&this.endOverallPosition>e};var MediaPlaylist=function(){};MediaPlaylist.prototype.RANGE_OPTIONS=zs,Object.defineProperties(MediaPlaylist.prototype,{eventData:{get:function(){}}}),MediaPlaylist.prototype.getItem=function(e,n){},MediaPlaylist.prototype.getItems=function(e,n){};var HLSVideoPlaylist=function(e){MediaPlaylist.apply(this,arguments),this._startPosition=e,this._mainFeatureMetricsData=Zo.copyKeysAndValues.apply(null,[!1,!1,!1,null].concat(Array.prototype.slice.call(arguments,1))),this._rollItems=[]};(HLSVideoPlaylist.prototype=new MediaPlaylist).constructor=HLSVideoPlaylist,HLSVideoPlaylist.prototype.setDelegate=function(e){return Zo.attachDelegate(this,e)},HLSVideoPlaylist.prototype.addRollInfoItems=function(e){e&&e.length&&e.forEach((function(e){this.addRollInfoItem(e)}),this)},HLSVideoPlaylist.prototype.addRollInfoItem=function(e){e&&this.addRollItem(1e3*e.start,1e3*e.duration,e.metricsData)},HLSVideoPlaylist.prototype.addRollItem=function(e,n){var d=new HLSRollItem(e,n);d.updateData.apply(d,Array.prototype.slice.call(arguments,2)),this._addRollItem(d)},HLSVideoPlaylist.prototype.updateMainFeatureMetricsData=function(){Zo.extend.apply(null,[this._mainFeatureMetricsData].concat(Array.prototype.slice.call(arguments)))},HLSVideoPlaylist.prototype.getItemForRollItem=function(e,n){var d=this._indexOfLastRollItemWithStartBeforePosition(e),p=this._rollItems[d];return Zo.isDefinedNonNull(p)&&p.duration===n?p:null},HLSVideoPlaylist.prototype.getItem=function(e,n){var d,p=this._indexOfLastRollItemWithStartBeforePosition(e);if(Zo.isInteger(p)){for(;n!=this.RANGE_OPTIONS.INCLUDES_START_POSITIONS&&this._rollItems[p].startOverallPosition==e&&p>0;)p--;(d=this._rollItems[p]).containsOverallPosition(e)||n==this.RANGE_OPTIONS.INCLUDES_END_POSITIONS&&d.endOverallPosition==e||(d=this._mainFeatureItemWithStartOverallPosition(d.endOverallPosition))}else d=this._mainFeatureItemWithStartOverallPosition(this._startPosition);return d},HLSVideoPlaylist.prototype.getItems=function(e,n){var d=[];if(this._rollItems.length){var p=this._indexOfLastRollItemWithStartBeforePosition(e);for(Zo.isInteger(p)||(d.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition)),p=0);p<this._rollItems.length;){var h=this._rollItems[p];if(h.startOverallPosition>n)break;if(h.endOverallPosition>=e&&d.push(h),p++,h.endOverallPosition<n)if(p<this._rollItems.length){var y=this._rollItems[p];y.startOverallPosition&&y.startOverallPosition>h.endOverallPosition&&d.push(this._mainFeatureItemWithStartOverallPosition(h.endOverallPosition))}else d.push(this._mainFeatureItemWithStartOverallPosition(h.endOverallPosition))}}else d.push(this._mainFeatureItemWithStartOverallPosition(this._startPosition));return d},HLSVideoPlaylist.prototype._addRollItem=function(e){if(e){var n=this._insertionIndexForItemWithPosition(e.startOverallPosition);this._rollItems.splice(n,0,e)}},HLSVideoPlaylist.prototype._indexOfLastRollItemWithStartBeforePosition=function(e){var n,d=this._rollItems[0];return d&&Zo.isInteger(e)&&d.startOverallPosition<=e&&(n=this._insertionIndexForItemWithPosition(e)-1),n},HLSVideoPlaylist.prototype._insertionIndexForItemWithPosition=function(e){for(var n=0,d=this._rollItems.length;n<d;){var p=Math.floor((n+d)/2);this._rollItems[p].startOverallPosition>e?d=p:n=p+1}return n},HLSVideoPlaylist.prototype._mainFeatureItemWithStartOverallPosition=function(e){var n=new MediaPlaylistItem(e);return n.startPosition=this._featurePlayheadProgress(e),n.updateData(this._mainFeatureMetricsData),n},HLSVideoPlaylist.prototype._featurePlayheadProgress=function(e){e=e||0;var n,d,p=this._indexOfLastRollItemWithStartBeforePosition(e),h=this._startPosition||0;Zo.isInteger(p)||(p=-1);for(var y=p;y>=0;y--)n=this._rollItems[y],0===y?h+=n.startOverallPosition:(d=this._rollItems[y-1],h+=n.startOverallPosition-d.endOverallPosition);return h};var MediaActivityTrackerGenerator=function(e){this._processor=e};MediaActivityTrackerGenerator.prototype.createTracker=function(e){var n=new MediaActivityTracker(this._processor,e);return n.updateData.apply(n,Array.prototype.slice.call(arguments,1)),n},MediaActivityTrackerGenerator.prototype.createHLSRollItemsMediaActivityTracker=function(e){var n=new HLSRollItemsMediaActivityTracker(this._processor,e);return n.updateData.apply(n,Array.prototype.slice.call(arguments,1)),n},MediaActivityTrackerGenerator.prototype.createHLSVideoPlaylist=function(e){var n=new HLSVideoPlaylist(e);return n.updateMainFeatureMetricsData.apply(n,Array.prototype.slice.call(arguments,1)),n},MediaActivityTrackerGenerator.prototype.createMediaPlaylist=function(e){return this.createHLSVideoPlaylist.apply(this,arguments)};var nc=oa.exceptionString,PlayActivityEventHandler=function(e){this._processor=e};PlayActivityEventHandler.prototype.knownFields=function(){throw nc("PlayActivityEventHandler","knownFields")},PlayActivityEventHandler.prototype.eventType=function(e){throw nc("PlayActivityEventHandler","eventType")},PlayActivityEventHandler.prototype.processMetricsData=function(){var e=Array.prototype.slice.call(arguments),n=this.eventType(e),d=this._processor.config,p=this._processor._constraints,h=this;return d.metricsDisabledOrBlacklistedEvent(n).then((function(e){if(e)throw"event was disabled"})).then((function(){var n=h._processor.eventHandlers.base;return n.metricsData.apply(n,e)})).then((function(n){var d=[];e=[n].concat(e);var p=sa.processMetricsData(h,h.knownFields(),!0,e),y={};return Object.keys(p).forEach((function(e){var n=p[e],h=Promise.resolve(n).then((function(n){y[e]=n}));d.push(h)})),Promise.all(d).then((function(){return y}))})).then((function(e){return p.applyConstraintTreatments(e)})).then((function(e){return d.removeBlacklistedFields(e)})).catch((function(n){return h._processor.system.logger.error("PlayActivity Processor: Unable to generate the event ("+h.eventType(e)+") for the topic "+d.topic()+", due to "+n),null}))};var ic=Zo.attachDelegate,oc=Zo.extend,MediaActivity$1=function(e,n,d){PlayActivityEventHandler.call(this,e),this._defaultEventType=n,this._reasonConstants=d,this._defaultActionType};(MediaActivity$1.prototype=Object.create(PlayActivityEventHandler.prototype)).constructor=MediaActivity$1,oc(MediaActivity$1,Hs),Object.defineProperties(MediaActivity$1.prototype,{TYPE:{get:function(){return qs.TYPE}},REASON:{get:function(){return this._reasonConstants}}}),MediaActivity$1.prototype.setDelegate=function(e){return ic(this,e)},MediaActivity$1.prototype.knownFields=function(){var e=[xs,Fs,Ks];return e},MediaActivity$1.prototype.eventType=function(e){return this._defaultEventType},MediaActivity$1.prototype.eventVersion=function(e){var n=this._processor.eventHandlers.base.eventVersion(e);return null!==n?n:1},MediaActivity$1.prototype.actionType=function(e){return this._defaultActionType};var StartMediaActivity=function(e,n,d){MediaActivity$1.apply(this,arguments),this._defaultActionType=MediaActivity$1.ACTION_TYPE.START};(StartMediaActivity.prototype=Object.create(MediaActivity$1.prototype)).constructor=StartMediaActivity,StartMediaActivity.prototype.metricsData=function(e,n,d,p){var h={position:e,overallPosition:n,startType:d,startReason:p},y=Array.prototype.slice.call(arguments,4);return this.processMetricsData.apply(this,[h].concat(y))};var StopMediaActivity=function(e,n,d){MediaActivity$1.apply(this,arguments),this._defaultActionType=MediaActivity$1.ACTION_TYPE.STOP};(StopMediaActivity.prototype=Object.create(MediaActivity$1.prototype)).constructor=StopMediaActivity,StopMediaActivity.prototype.metricsData=function(e,n,d,p,h){var y=this.eventType(),_={position:e,overallPosition:n,stopType:d,stopReason:p,startPosition:(h=h||{}).position,startOverallPosition:h.overallPosition,startTime:h.eventTime,startType:h.startType,startReason:h.startReason,startReasonType:h.startReasonType};y===MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY&&(_.startAssetId=h.assetId);var m=Array.prototype.slice.call(arguments,5);return this.processMetricsData.apply(this,[_].concat(m))};var ac=ls,PlayActivityProcessorBase=function(e){ac.apply(this,arguments)};(PlayActivityProcessorBase.prototype=Object.create(ac.prototype)).constructor=PlayActivityProcessorBase,PlayActivityProcessorBase.prototype.environment=function(){return this._processor.system.environment},PlayActivityProcessorBase.prototype.eventRecorder=function(){return this._processor.system.eventRecorder},PlayActivityProcessorBase.prototype.knownFields=function(){var e=ac.prototype.knownFields().concat([xs,Ns,Ls,Us,Bs,Vs,Gs]);return e},PlayActivityProcessorBase.prototype.consumerId=function(e){var n=Ns;return e&&n in e?e[n]:this.environment().consumerId()},PlayActivityProcessorBase.prototype.consumerNs=function(e){var n=Ls;return e&&n in e?e[n]:this.environment().consumerNs()},PlayActivityProcessorBase.prototype.isOffline=function(e){var n=Bs;return e&&n in e?e[n]:this.environment().isOffline()},PlayActivityProcessorBase.prototype.videoViewportHeight=function(e){var n=Vs;return e&&n in e?e[n]:this.environment().videoViewportHeight()},PlayActivityProcessorBase.prototype.videoViewportWidth=function(e){var n=Gs;return e&&n in e?e[n]:this.environment().videoViewportWidth()},PlayActivityProcessorBase.prototype.metricsData=function(){var e=Array.prototype.slice.call(arguments),n=sa.processMetricsData(this,this.knownFields(),!0,e);return n};var EventHandlers=function(e){this.base=new PlayActivityProcessorBase(e),this.playStart=new StartMediaActivity(e,MediaActivity$1.EVENT_TYPE.PLAY_ACTIVITY,qs.PLAY_START_REASON),this.playStop=new StopMediaActivity(e,MediaActivity$1.EVENT_TYPE.PLAY_ACTIVITY,qs.PLAY_STOP_REASON),this.seekStart=new StartMediaActivity(e,MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY,qs.SEEK_START_REASON),this.seekStop=new StopMediaActivity(e,MediaActivity$1.EVENT_TYPE.SEEK_ACTIVITY,qs.SEEK_STOP_REASON)},PlayActivityProcessor=function(e){if(!Zo.isDefinedNonNull(e))throw new Error("No delegate is provided to PlayActivityProcessor");this._initCalled=!1,this._delegatePackage=e,this.system=new System,this.config=this._delegatePackage.config,this.eventHandlers=new EventHandlers(this),this.utils=new Utils(this),this.mediaActivityTracker=new MediaActivityTrackerGenerator(this)};PlayActivityProcessor.prototype.init=function(){var e,n=Promise.resolve();return this._initCalled||(this._initCalled=!0,this._delegatePackage&&(Zo.setDelegates(this.eventHandlers,this._delegatePackage),Zo.setDelegates(this.system,this._delegatePackage)),e=this.config,Zo.isFunction(e.constraintProfile)&&Zo.isFunction(e.constraintProfiles)||Zo.attachMethods(e,Za,e),n=this._delegatePackage.init(),this._constraints=new rs(this.config,{environment:this.system.environment})),n},PlayActivityProcessor.prototype.cleanup=function(){this._delegatePackage&&Zo.isFunction(this._delegatePackage.cleanup)&&this._delegatePackage.cleanup(),this.config.cleanup(),Zo.resetDelegates(this.eventHandlers),Zo.resetDelegates(this.system),Zo.resetDelegates(this.utils),this.config=null,this.system=null,this.eventHandlers=null,this.utils=null,this._delegatePackage=null,this._constraints=null,this._initCalled=!1};const sc=new Map([[ot.playbackPlay,"play"],[ot.playbackPause,"pause"],[ot.playbackScrub,"scrub"],[ot.playbackSeek,"seek"],[ot.playbackSkip,"skip"],[ot.playbackStop,"stop"],[ot.playerExit,"exit"]]),cc={[lt.EXITED_APPLICATION]:"EXIT",[lt.FAILED_TO_LOAD]:"FAILURE",[lt.MANUALLY_SELECTED_PLAYBACK_OF_A_DIFF_ITEM]:"PLAY_OTHER",[lt.NATURAL_END_OF_TRACK]:"COMPLETE",[lt.PLAYBACK_PAUSED_DUE_TO_INACTIVITY]:"INACTIVITY",[lt.SCRUB_BEGIN]:"SEEK",[lt.TRACK_SKIPPED_BACKWARDS]:"SEEK",[lt.TRACK_SKIPPED_FORWARDS]:"SEEK",[lt.PLAYBACK_SUSPENDED]:"CLOSE_PLAYER",[to.NEXT_ITEM]:"NEXT"},lc="unknown",uc="next",dc="previous",pc="location",hc="interval",yc="playhead",fc="scrub",_c="transition",vc="interruption",mc="buffering",gc="seek",bc="playOther",Pc="skipIntro",Sc="skipToLive",Tc={TYPE:{MANUAL:"manual",AUTOMATIC:"automatic",UNKNOWN:lc},ASSET_PLACEMENT:{PRE_ROLL:"preroll",POST_ROLL:"postroll",MID_ROLL:"midroll",FEATURE:"feature",CATCH_UP_TO_LIVE:"catchUpToLive"},PLAY_START_REASON:{PLAY:"play",PLAY_OTHER:bc,UNPAUSE:"unpause",NEXT:uc,PREVIOUS:dc,SEEK:gc,TRANSITION:_c,INTERRUPTION:vc,FOREGROUND:"foreground",FOCUS:"focus",BUFFERING:mc,UNKNOWN:lc,SKIP_TO_LIVE:Sc},PLAY_START_REASON_TYPE:{SKIP_INTRO:Pc,SKIP_TO_LIVE:Sc},PLAY_STOP_REASON:{COMPLETE:"complete",TRANSITION:_c,PLAY_OTHER:bc,PAUSE:"pause",SEEK:gc,NEXT:uc,INTERRUPTION:vc,BACKGROUND:"background",EXIT:"exit",INACTIVITY:"inactivity",BUFFERING:mc,ERROR:"error",FAILURE:"failure",UNKNOWN:lc,CLOSE_PLAYER:"closePlayer",SKIP_TO_LIVE:Sc},PLAY_STOP_REASON_TYPE:{SKIP_INTRO:Pc,SKIP_TO_LIVE:Sc},SEEK_START_REASON:{NEXT:uc,PREVIOUS:dc,LOCATION:pc,INTERVAL:hc,PLAYHEAD:yc,SCRUB:fc,UNKNOWN:lc,SKIP_INTRO:Pc},SEEK_STOP_REASON:{NEXT:uc,PREVIOUS:dc,LOCATION:pc,INTERVAL:hc,PLAYHEAD:yc,SCRUB:fc,UNKNOWN:lc,SEEK:gc,SKIP_INTRO:Pc},SEEK_STOP_REASON_TYPE:{SKIP_INTRO:Pc}};var kc=function(e){return e.SEEK_STARTED="seekStarted",e.SEEK_STOPPED="seekStopped",e.PLAY_STARTED="playStarted",e.PLAY_STOPPED="playStopped",e}({});function _define_property$2(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}var Ec=function(e){return e.MANUAL="manual",e.AUTOMATIC="automatic",e.UNKNOWN="unknown",e}({}),wc=function(e){return e.buffering="buffering",e.idle="idle",e.paused="paused",e.playing="playing",e}({}),Oc=function(e){return e.bufferStart="BUFFER_START",e.bufferStop="BUFFER_STOP",e.exit="EXIT",e.play="PLAY",e.pause="PAUSE",e.stop="STOP",e.newItem="NEW",e}({});const Ic={initial:"idle",states:{idle:{on:{PLAY:{target:"playing",context:{reason:Tc.PLAY_START_REASON.PLAY,manual:"manual",fromInitialPlay:!0}},NEW:{target:"playing",context:{reason:Tc.PLAY_START_REASON.PLAY}},EXIT:{target:"idle",context:{reason:Tc.PLAY_STOP_REASON.COMPLETE,manual:"automatic"}}}},playing:{on:{BUFFER_START:{target:"buffering",context:{reason:Tc.PLAY_STOP_REASON.BUFFERING,manual:"automatic",fromInitialPlay:"~~previous~~"}},EXIT:{target:"idle",context:{reason:Tc.PLAY_STOP_REASON.EXIT}},PAUSE:{target:"paused",context:{reason:Tc.PLAY_STOP_REASON.PAUSE}},STOP:{target:"idle",context:{reason:Tc.PLAY_STOP_REASON.PLAY_OTHER,manual:"automatic"}},NEW:{target:"playing",context:{reason:Tc.PLAY_STOP_REASON.PLAY_OTHER}}}},paused:{on:{PLAY:{target:"playing",context:{reason:Tc.PLAY_START_REASON.UNPAUSE,manual:"manual"}},NEW:{target:"idle",context:{reason:Tc.PLAY_STOP_REASON.PLAY_OTHER,manual:"manual"}},EXIT:{target:"idle",context:{reason:Tc.PLAY_STOP_REASON.EXIT}}}},buffering:{on:{BUFFER_STOP:{target:"playing",context:{reason:Tc.PLAY_START_REASON.BUFFERING,manual:"automatic"}},EXIT:{target:"idle",context:{reason:Tc.PLAY_STOP_REASON.EXIT}}}}}},$c={manual:"unknown",reason:Tc.PLAY_STOP_REASON.UNKNOWN,fromInitialPlay:!1};class PodPafStateMachine{isAllowedTransition(e){return void 0!==this.getNextState(e)}transition(e,n={}){const d=this.getNextState(e);if(!d)return;Qe.debug(`[mk/activity/PodPaf] Transitioning from ${this.currentState} to ${d.target} because of ${e} event`);const p={};return void 0!==n.manual&&(p.manual=n.manual),void 0!==n.reason&&(p.reason=n.reason),void 0!==n.fromInitialPlay&&(p.fromInitialPlay=n.fromInitialPlay),this.currentContext=function(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$2(e,n,d[n])}))}return e}({},$c,d.context,p,this.preservePreviousContext(d.context)),this.currentState=d.target,this.currentContext}reset(){this.currentState=Ic.initial,this.currentContext=$c}getNextState(e){return Ic.states[this.currentState].on[e]}preservePreviousContext(e){const n={};return["manual","reason","reasonType","fromInitialPlay"].forEach(d=>{"~~previous~~"===e[d]&&(n[d]=this.currentContext[d])}),n}constructor(){_define_property$2(this,"currentState",Ic.initial),_define_property$2(this,"currentContext",$c),_define_property$2(this,"lastTrackedEvent",void 0),_define_property$2(this,"lastPlayStartEvent",void 0)}}const Ac="xp_amp_podcasts_paf",Rc={[ot.playbackPause]:Oc.pause,[ot.playbackPlay]:Oc.play,[ot.playbackStop]:Oc.stop,[ot.playerExit]:Oc.exit};function asMilliseconds(e){return Math.round(1e3*e)}function determineDelegatedPlayback(e){return{delegatedPlayback:e.playbackTargetIsWireless?"Airplay":"None"}}function assertIsDefined(e,n){if(null==e)throw new Error(n)}function assertTracker(e,n){assertIsDefined(e,(null!=n?n:"PAF")+" Tracker: Attempted to track event without first calling createTracker()")}function asyncGeneratorStep$2(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$2(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$2(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$2(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function _define_property$1(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread$1(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property$1(e,n,d[n])}))}return e}function _object_spread_props$1(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}function _ts_decorate(e,n,d,p){var h,y=arguments.length,_=y<3?n:null===p?p=Object.getOwnPropertyDescriptor(n,d):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(e,n,d,p);else for(var m=e.length-1;m>=0;m--)(h=e[m])&&(_=(y<3?h(_):y>3?h(n,d,_):h(n,d))||_);return y>3&&_&&Object.defineProperty(n,d,_),_}function _ts_metadata(e,n){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,n)}const Cc=Qe.createChild("podpaf");class PodPAFTracker{configure(e){var n=this;return _async_to_generator$2((function*(){n.mkInstance=e.instance,n.services=e.services,n.dispatcher=e.services.dispatcher;const d=new WebDelegates(Ac,{config:{configHostname:()=>"daf.xp.apple.com"},environment:{app:()=>"com.apple.podcasts",appVersion:()=>"1.0",delegateApp:()=>"web-podcasts-player",isOffline:()=>!1,storeFrontCountryCode:()=>Bi.storefrontCountryCode}});n.playActivityProcessor=new PlayActivityProcessor(d),yield n.playActivityProcessor.init(),n.setupListeners()}))()}get requestedEvents(){return Array.from(sc.keys())}get isConfigured(){return void 0!==this.mkInstance}setupListeners(){void 0!==this.dispatcher&&(this.dispatcher.subscribe(at.nowPlayingItemWillChange,this.handleNowPlayingItemDidChange),this.dispatcher.subscribe(at.playbackStateDidChange,this.onPlaybackStateChange),this.dispatcher.subscribe(at.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange))}teardownListeners(){void 0!==this.dispatcher&&(this.dispatcher.unsubscribe(at.nowPlayingItemDidChange,this.handleNowPlayingItemDidChange),this.dispatcher.unsubscribe(at.playbackStateDidChange,this.onPlaybackStateChange),this.dispatcher.unsubscribe(at.playbackTargetIsWirelessDidChange,this.handleTargetWirelessChange))}cleanup(){var e=this;return _async_to_generator$2((function*(){e.teardownListeners(),e.stopSynchronizing()}))()}handleNowPlayingItemDidChange(e,n){var d=this;return _async_to_generator$2((function*(){const{item:e}=n;if(!e){var p,h,y;if((null===(p=d.state.lastTrackedEvent)||void 0===p?void 0:p.eventType)===kc.PLAY_STARTED)assertTracker(d.tracker,"PodPAF"),Cc.debug("PodPAF: current item naturally ends"),yield d.trackEvent(kc.PLAY_STOPPED,null!==(y=null===(h=d.mkInstance)||void 0===h?void 0:h.currentPlaybackDuration)&&void 0!==y?y:0,d.tracker.TYPE.AUTOMATIC,d.tracker.PLAY_STOP_REASON.COMPLETE);return Cc.debug("PodPAF.handleNowPlayingItemDidChange: calling exit and clearing currentItem"),d.state.transition(Oc.exit),d.stopSynchronizing(),d.tracker=void 0,void(d.currentItem=void 0)}}))()}onPlaybackStateChange(e,n){var d=this;return _async_to_generator$2((function*(){const{state:e}=n,p=d.currentItem,h={position:d.mkInstance.currentPlaybackTime,playingDate:d.mkInstance.currentPlayingDate,userInitiated:n.userInitiated},y="PlaybackStates."+be[n.oldState],_="PlaybackStates."+be[n.state];Cc.debug(`PodPAF.onPlaybackStateChange: ${y} -> ${_}`,h),e===be.waiting?(Cc.debug("PodPAFTracker.onPlaybackStateChange: triggering bufferStart()",h),yield d.bufferStart(p,h)):e===be.playing?n.oldState===be.waiting&&(Cc.debug("PodPAFTracker.onPlaybackStateChange: triggering bufferEnd()",h),yield d.bufferEnd(p,h)):e!==be.stalled&&Cc.debug("PodPAFTracker.onPlaybackStateChange: resetting isBuffering=false")}))()}handleTargetWirelessChange(){var e;void 0!==this.mkInstance&&(null===(e=this.tracker)||void 0===e||e.updateData(determineDelegatedPlayback(this.mkInstance)))}shouldTrackPlayActivity(e,n){if(!n||!n.podpafMetrics||n.playbackType===ie.preview)return!1;const d=Rc[e];if(void 0!==d){return this.state.isAllowedTransition(d)}return!0}handleEvent(e,n,d){if(!this.shouldTrackPlayActivity(e,d))return;const p=sc.get(e);void 0!==p&&"function"==typeof this[p]&&this[p](d,n)}canTrackItem(e,n={}){var d=this;return _async_to_generator$2((function*(){var p;if(void 0===e)return!1;if((null===(p=d.currentItem)||void 0===p?void 0:p.id)!==e.id){const{manual:p,reason:h}=d.getContextForNewItem(n);d.state.transition(Oc.newItem,{manual:p,reason:h,fromInitialPlay:!0}),d.currentItem=e,Cc.debug("PodPAF: Creating new tracker for new item"),yield d.createTracker(e)}return void 0!==d.tracker}))()}createTracker(e){var n=this;return _async_to_generator$2((function*(){var d;assertIsDefined(n.playActivityProcessor,(null!=(d="PodPAF")?d:"PAF")+" Tracker: Attempted to create tracker without first calling configure()");const{mediaActivityTracker:p}=n.playActivityProcessor,h=p.createMediaPlaylist(0);Cc.debug("PodPAF: Creating Podcast Playlist");const y=_object_spread$1({},e.podpafMetrics,n.getAdditionalTrackingData(n.mkInstance,n.services));return n.tracker=p.createTracker(h,y),Cc.debug("PodPAFTracker.createTracker: creating new tracker for "+(null==e?void 0:e.id)),n.startSynchronizing(),n.tracker}))()}trackEvent(e,n,d,p){var h=this;return _async_to_generator$2((function*(){assertTracker(h.tracker,"PodPAF"),void 0===d&&(d=h.state.currentContext.manual),void 0===p&&(p=h.state.currentContext.reason);const y={eventType:e,position:n,type:d,reason:p},_=h.getAdditionalPlaybackData(e,n),m=asMilliseconds(n);Cc.debug(`PodPAFTracker.trackEvent(${e}, ${m}, ${d}, ${p}, play duration: ${_.playDuration}, play start position: ${_.playStartPosition})`),h.state.lastTrackedEvent=y,yield h.tracker[e].call(h.tracker,m,d,p,_),e===kc.PLAY_STARTED&&(h.state.lastPlayStartEvent=y)}))()}bufferStart(e,n){var d=this;return _async_to_generator$2((function*(){var p;if(Cc.debug("PodPAFTracker: handling bufferStart()"),!(yield d.canTrackItem(e)))return void Cc.debug("PodPAFTracker: aborting bufferStart, no tracker");if(assertTracker(d.tracker,"PodPAF"),d.state.currentState!==wc.playing)return void Cc.debug("PodPafTracker: aborting bufferStart, not playing");if("seek"===(null===(p=d.state.lastTrackedEvent)||void 0===p?void 0:p.reason))return void Cc.debug("PodPAFTracker: aborting bufferStart, after a seek");d.state.transition(Oc.bufferStart);const h=d.state.currentContext.fromInitialPlay;var y;const _=null!==(y=n.position)&&void 0!==y?y:0;h?Cc.debug("PodPafTracker: bufferStart() not tracking PLAY_STOPPED, it is from initial play"):yield d.trackEvent(kc.PLAY_STOPPED,_,d.tracker.TYPE.AUTOMATIC,d.tracker.PLAY_STOP_REASON.BUFFERING)}))()}bufferEnd(e,n){var d=this;return _async_to_generator$2((function*(){var p;if(Cc.debug("PodPAFTracker: handling bufferEnd()"),!(yield d.canTrackItem(e)))return;if(assertTracker(d.tracker,"PodPAF"),d.state.currentState!==wc.buffering)return void Cc.debug("PodPafTracker: aborting bufferEnd, not buffering");if("seek"===(null===(p=d.state.lastTrackedEvent)||void 0===p?void 0:p.reason))return void Cc.debug("PodPAFTracker: aborting bufferEnd, after a seek");d.state.transition(Oc.bufferStop);const h=d.state.currentContext.fromInitialPlay;var y;const _=null!==(y=n.position)&&void 0!==y?y:0;h?Cc.debug("PodPafTracker: bufferEnd() not tracking PLAY_STARTED, it is from initial play"):yield d.trackEvent(kc.PLAY_STARTED,_,d.tracker.TYPE.AUTOMATIC,d.tracker.PLAY_START_REASON.BUFFERING)}))()}scrub(e,n={}){return _async_to_generator$2((function*(){Cc.debug("PodPAFTracker.scrub()")}))()}seek(e,n={}){var d=this;return _async_to_generator$2((function*(){Cc.debug("PodPAFTracker.seek()"),void 0!==e&&void 0!==n.position&&void 0!==n.startPosition&&(!function(e){return e.seekReasonType===ut.Interval}(n)?yield d.trackScrub(e,n):yield d.trackSeek(e,n))}))()}trackScrub(e,n){var d=this;return _async_to_generator$2((function*(){const p=n.position,h=n.startPosition;yield d.trackScrubStart(e,h),yield d.trackScrubStop(e,p)}))()}trackScrubStart(e,n){var d=this;return _async_to_generator$2((function*(){Cc.debug("PodPAFTracker.trackScrubStart()"),(yield d.canTrackItem(e))&&(assertTracker(d.tracker,"PodPAF"),d.state.currentState===wc.playing&&(yield d.trackEvent(kc.PLAY_STOPPED,n,d.tracker.TYPE.AUTOMATIC,d.tracker.PLAY_STOP_REASON.SEEK)),yield d.trackEvent(kc.SEEK_STARTED,n,d.tracker.TYPE.MANUAL,d.tracker.SEEK_START_REASON.SCRUB))}))()}trackScrubStop(e,n){var d=this;return _async_to_generator$2((function*(){Cc.debug("PodPAFTracker.trackScrubStop()"),(yield d.canTrackItem(e))&&(assertTracker(d.tracker,"PodPAF"),yield d.trackEvent(kc.SEEK_STOPPED,n,d.tracker.TYPE.MANUAL,d.tracker.SEEK_STOP_REASON.SCRUB),d.state.currentState===wc.playing&&(yield d.trackEvent(kc.PLAY_STARTED,n,d.tracker.TYPE.AUTOMATIC,d.tracker.PLAY_START_REASON.SEEK)))}))()}trackSeek(e,n){var d=this;return _async_to_generator$2((function*(){const p=_object_spread_props$1(_object_spread$1({},n),{position:n.startPosition});yield d.trackSeekStart(e,p),yield d.trackSeekStop(e,n)}))()}trackSeekStart(e,n){var d=this;return _async_to_generator$2((function*(){if(Cc.debug("PodPAFTracker.seekStart()"),!(yield d.canTrackItem(e)))return;var p;assertTracker(d.tracker,"PodPAF");const h=null!==(p=n.position)&&void 0!==p?p:0;d.state.currentState===wc.playing&&(yield d.trackEvent(kc.PLAY_STOPPED,h,d.tracker.TYPE.MANUAL,d.tracker.PLAY_STOP_REASON.SEEK)),yield d.trackEvent(kc.SEEK_STARTED,h,d.tracker.TYPE.MANUAL,d.tracker.SEEK_START_REASON.INTERVAL)}))()}trackSeekStop(e,n){var d=this;return _async_to_generator$2((function*(){if(Cc.debug("PodPAFTracker.seekEnd()"),!(yield d.canTrackItem(e)))return;var p;assertTracker(d.tracker,"PodPAF");const h=null!==(p=n.position)&&void 0!==p?p:0;yield d.trackEvent(kc.SEEK_STOPPED,h,d.tracker.TYPE.AUTOMATIC,d.tracker.SEEK_STOP_REASON.INTERVAL),d.state.currentState===wc.playing&&(yield d.trackEvent(kc.PLAY_STARTED,h,d.tracker.TYPE.AUTOMATIC,d.tracker.PLAY_START_REASON.SEEK))}))()}play(e,n={}){var d=this;return _async_to_generator$2((function*(){var p;(Cc.debug("PodPAFTracker.play()",e,n),yield d.canTrackItem(e,n))&&(assertTracker(d.tracker,"PodPAF"),d.state.transition(Oc.play,d.getExplicitStateContext(n)),yield d.trackEvent(kc.PLAY_STARTED,null!==(p=n.position)&&void 0!==p?p:0))}))()}pause(e,n={}){var d=this;return _async_to_generator$2((function*(){var p,h;(Cc.debug("PodPAFTracker.pause()",e,n),yield d.canTrackItem(e,n))&&(assertTracker(d.tracker,"PodPAF"),d.state.transition(Oc.pause,d.getExplicitStateContext(n)),yield d.trackEvent(kc.PLAY_STOPPED,null!==(h=n.position)&&void 0!==h?h:0,void 0,null===(p=d.tracker)||void 0===p?void 0:p.PLAY_STOP_REASON.PAUSE))}))()}skip(e,n={}){var d=this;return _async_to_generator$2((function*(){var p,h,y;(Cc.debug("PodPAFTracker.skip()",e,n),yield d.canTrackItem(e,n))&&(assertTracker(d.tracker,"PodPAF"),d.state.transition(Oc.play,d.getExplicitStateContext(n)),yield d.trackEvent(kc.PLAY_STARTED,null!==(y=n.position)&&void 0!==y?y:0,null===(p=d.tracker)||void 0===p?void 0:p.TYPE.AUTOMATIC,null===(h=d.tracker)||void 0===h?void 0:h.PLAY_START_REASON.PLAY_OTHER))}))()}stop(e,n={}){var d=this;return _async_to_generator$2((function*(){var p;(Cc.debug("PodPAFTracker.stop()",e,n),yield d.canTrackItem(e))&&(assertTracker(d.tracker,"PodPAF"),d.state.transition(Oc.stop,d.getExplicitStateContext(n)),yield d.trackEvent(kc.PLAY_STOPPED,null!==(p=n.position)&&void 0!==p?p:0),d.stopSynchronizing(),d.currentItem=void 0)}))()}exit(e,n={}){var d=this;return _async_to_generator$2((function*(){var e;(Cc.debug("PodPAFTracker.exit()"),yield d.canTrackItem(d.currentItem))&&(d.state.transition(Oc.exit),yield d.trackEvent(kc.PLAY_STOPPED,null!==(e=n.position)&&void 0!==e?e:0),d.stopSynchronizing(),d.currentItem=void 0)}))()}synchronize(){if(void 0===this.tracker||void 0===this.mkInstance||void 0===this.currentItem)return void this.stopSynchronizing();const e=this.state.currentState===wc.paused,{playbackRate:n,currentPlaybackTime:d}=this.mkInstance,p=e?0:n,h=Math.round(1e3*d);Cc.debug(`PodPAF: synchronize rate: ${p} and current time: ${h}`),this.tracker.synchronize(p,h)}startSynchronizing(){void 0===this.synchronizeTimeout&&(this.synchronizeTimeout=setInterval(this.synchronize,6e4))}stopSynchronizing(){void 0!==this.synchronizeTimeout&&(clearInterval(this.synchronizeTimeout),this.synchronizeTimeout=void 0)}getContextForNewItem(e){let n;const d=null==e?void 0:e.userInitiated,{lastTrackedEvent:p}=this.state,h=void 0===p;n=void 0!==d?this.determineManual(e):h?Ec.MANUAL:Ec.AUTOMATIC;return{manual:n,reason:h?Tc.PLAY_START_REASON.PLAY:d?Tc.PLAY_START_REASON.PLAY_OTHER:Tc.PLAY_START_REASON.NEXT}}getMappedStopReason(e){if(void 0!==e.endReasonType)return Tc.PLAY_STOP_REASON[cc[e.endReasonType]]}determineManual(e){let n;const d=null==e?void 0:e.userInitiated;return void 0!==d&&(n=d?Tc.TYPE.MANUAL:Tc.TYPE.AUTOMATIC),n}getExplicitStateContext(e){return{manual:this.determineManual(e),reason:this.getMappedStopReason(e)}}getAdditionalPlaybackData(e,n){const{lastPlayStartEvent:d,lastTrackedEvent:p}=this.state;let h,y=null==d?void 0:d.position;return e===kc.PLAY_STARTED?y=n:(null==p?void 0:p.eventType)===kc.PLAY_STARTED&&(h=n-(null!=y?y:0)),{playDuration:h,playStartPosition:y}}getAdditionalTrackingData(e,n){var d,p;const{delegatedPlayback:h}=determineDelegatedPlayback(e),{currentPlaybackDuration:y}=e;return{delegatedPlayback:h,isSignedIn:Bi.isAuthorized,language:getLanguageId(null===(d=Array.isArray(navigator.languages)?navigator.languages:"string"==typeof navigator.language?[navigator.language]:[])||void 0===d?void 0:d[0]),playStartTime:(new Date).getTime(),playerHardwareFamily:"Airplay"===h?null===(p=n.runtime)||void 0===p?void 0:p.userAgent.ua:void 0,topic:Ac,overallLength:asMilliseconds(y),contentLength:y}}constructor(){_define_property$1(this,"currentItem",void 0),_define_property$1(this,"dispatcher",void 0),_define_property$1(this,"mkInstance",void 0),_define_property$1(this,"services",void 0),_define_property$1(this,"tracker",void 0),_define_property$1(this,"playActivityProcessor",void 0),_define_property$1(this,"synchronizeTimeout",void 0),_define_property$1(this,"state",void 0),this.state=new PodPafStateMachine}}function _define_property(e,n,d){return n in e?Object.defineProperty(e,n,{value:d,enumerable:!0,configurable:!0,writable:!0}):e[n]=d,e}function _object_spread(e){for(var n=1;n<arguments.length;n++){var d=null!=arguments[n]?arguments[n]:{},p=Object.keys(d);"function"==typeof Object.getOwnPropertySymbols&&(p=p.concat(Object.getOwnPropertySymbols(d).filter((function(e){return Object.getOwnPropertyDescriptor(d,e).enumerable})))),p.forEach((function(n){_define_property(e,n,d[n])}))}return e}function _object_spread_props(e,n){return n=null!=n?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):function(e,n){var d=Object.keys(e);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);n&&(p=p.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),d.push.apply(d,p)}return d}(Object(n)).forEach((function(d){Object.defineProperty(e,d,Object.getOwnPropertyDescriptor(n,d))})),e}_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[String,Object]),_ts_metadata("design:returntype",Promise)],PodPAFTracker.prototype,"handleNowPlayingItemDidChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[String,Object]),_ts_metadata("design:returntype",Promise)],PodPAFTracker.prototype,"onPlaybackStateChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],PodPAFTracker.prototype,"handleTargetWirelessChange",null),_ts_decorate([Bind(),_ts_metadata("design:type",Function),_ts_metadata("design:paramtypes",[]),_ts_metadata("design:returntype",void 0)],PodPAFTracker.prototype,"synchronize",null);const Mc=_object_spread({get info(){return function(){var n,d,p,h,y,_,m,g,b,P,S;const T={};T.version=e.version;const k=getHlsJsCdnConfig();T.hlsJSURL=k.hls,T.rtcJSURL=k.rtc,T.hlsJSVersion=void 0!==window.Hls?window.Hls.version:"not-loaded";const E=getInstance();T.instanceId=null==E?void 0:E.id;const O=null==E?void 0:E.services.runtime;var I,$,A,R,C,M,D,j,x;return T.runtime=void 0===O?void 0:{browser:`${O.browser.name} ${O.browser.version}`,engine:`${O.engine.name} ${O.engine.version}`,os:`${O.os.name} ${O.os.version}`,mobile:O.isMobile,keysystems:O.availableKeySystems},T.controller=null!==(I=null==E||null===(n=E._playbackController)||void 0===n?void 0:n.constructor.name)&&void 0!==I?I:"none",T.player=null!==($=null==E||null===(p=E._mediaItemPlayback)||void 0===p||null===(d=p.getCurrentPlayer())||void 0===d?void 0:d.constructor.name)&&void 0!==$?$:"none",T.queue={size:null!==(A=null==E||null===(h=E.queue)||void 0===h?void 0:h.length)&&void 0!==A?A:0,position:null!==(R=null==E||null===(y=E.queue)||void 0===y?void 0:y.position)&&void 0!==R?R:-1,currentItem:void 0===(null==E||null===(_=E.queue)||void 0===_?void 0:_.currentItem)?void 0:{id:null==E||null===(m=E.queue)||void 0===m?void 0:m.currentItem.id,type:null==E||null===(g=E.queue)||void 0===g?void 0:g.currentItem.type,title:null==E||null===(b=E.queue)||void 0===b?void 0:b.currentItem.title,attributes:null!==(C=null==E||null===(P=E.queue)||void 0===P?void 0:P.currentItem.attributes)&&void 0!==C?C:{}}},T.nowPlayingItem=void 0===(null==E?void 0:E.nowPlayingItem)?void 0:{id:E.nowPlayingItem.id,type:E.nowPlayingItem.type,title:E.nowPlayingItem.title,attributes:null!==(M=null==E||null===(S=E.queue)||void 0===S?void 0:S.currentItem.attributes)&&void 0!==M?M:{}},T.isPlaying=null!==(D=null==E?void 0:E.isPlaying)&&void 0!==D&&D,T.playbackModes={shuffle:["off","on"][null!==(j=null==E?void 0:E.shuffleMode)&&void 0!==j?j:0],repeat:["off","one","all"][null!==(x=null==E?void 0:E.repeatMode)&&void 0!==x?x:0],autoplay:!0===(null==E?void 0:E.autoplayEnabled)?"on":"off"},T.devFlags=Object.entries(w).reduce((function(e,[n,d]){return _object_spread_props(_object_spread({},e),{[n]:d.value})}),{}),T}()}},w);function asyncGeneratorStep$1(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator$1(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep$1(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep$1(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function loadLinksData(){return _loadLinksData.apply(this,arguments)}function _loadLinksData(){return(_loadLinksData=_async_to_generator$1((function*(){const e=[{feature:"album-song",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/albums?/(?:[^/]+/)?(?<album>\\d+)$",requiredQueryParams:{i:"(?<identifier>\\d+)"},mediaAPI:{resources:["songs"]}},{feature:"albums",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/albums?/(?:[^/]+/)?(?<identifier>\\d+)$",mediaAPI:{resources:["albums"]}},{feature:"algo-stations",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/stations?/(?:[^/]+/)?(?<identifier>(?:ra|st).\\d+)",mediaAPI:{resources:["stations"]}},{feature:"artist-default-playable-content",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/artists?/(?:[^/]+/)?(?<identifier>\\d+)$",mediaAPI:{resources:["artists","default-playable-content"]}},{feature:"genre-stations",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/genre-stations?",mediaAPI:{resources:["stations"],parameterMapping:{genres:"filter[genres]",eras:"filter[eras]",tags:"filter[tags]",moods:"filter[moods]"}}},{feature:"library-albums",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/library/albums?/(?:[^/]+/)?(?<identifier>(?:l).[a-zA-Z0-9-]+)$",mediaAPI:{resources:["albums"]}},{feature:"library-album-song",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/library/albums?/(?:[^/]+/)?(?<album>(?:l).[a-zA-Z0-9-]+)$",requiredQueryParams:{i:"(?<identifier>i\\.[a-zA-Z0-9-]+)"},mediaAPI:{resources:["songs"]}},{feature:"library-playlists",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/library/playlists?/(?:[^/]+/)?(?<identifier>(?:p).[a-zA-Z0-9-]+)$",mediaAPI:{resources:["playlists"]}},{feature:"music-videos",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/music-videos?/(?:[^/]+/)?(?<identifier>\\d+)$",mediaAPI:{resources:["musicVideos"]}},{feature:"personal-general-radio",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/stations?/me$",mediaAPI:{resources:["stations"],parameters:{"filter[identity]":"personal"}}},{feature:"personal-mixes",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/(?:personal-)?mix/(?:[^/]+/)?(?<identifier>mx.(?:\\d{1,2}|rp-\\d{4}))$",mediaAPI:{resources:["playlists"]}},{feature:"playlists",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/playlists?/(?:[^/]+/)?(?<identifier>(?:pl).[a-zA-Z0-9-]+)$",mediaAPI:{resources:["playlists"]}},{feature:"song",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/(?<storefront>\\w{2})/songs?/(?:[^/]+/)?(?<identifier>\\d+)$",mediaAPI:{resources:["songs"]}},{feature:"steering-request",regex:"http(?:s)?://(?<realm>itunes|music).apple.com/me/stations?/change-station/?$",mediaAPI:{resources:["stations"]}}].map(e=>(e.regex=new RegExp(e.regex),e.requiredQueryParams&&(e.requiredQueryParams=Object.keys(e.requiredQueryParams).reduce((n,d)=>(n[d]=new RegExp(e.requiredQueryParams[d]),n),{})),e));return Promise.resolve(e)}))).apply(this,arguments)}function meetsLinkRequirements(e,n,d={}){const[p]=e.split(/\?|\#|\&/),h=n.regex.test(p);return h&&n.requiredQueryParams?Object.keys(n.requiredQueryParams).every(e=>{const p=d[e];return n.requiredQueryParams[e].test(p)}):h}function filterLinks(e){return _filterLinks.apply(this,arguments)}function _filterLinks(){return(_filterLinks=_async_to_generator$1((function*(e){const n=yield loadLinksData(),d=parseQueryParams(e);return n.reduce((n,p)=>{if(meetsLinkRequirements(e,p,d)){if(n.length>0)if(p.requiredQueryParams)n=n.filter(e=>e.requiredQueryParams);else if(n.some(e=>e.requiredQueryParams))return n;p.requiredQueryParams?p.mediaAPI.parameters=Object.keys(p.requiredQueryParams).reduce((e,n)=>(e[n]=d[n],e),{}):p.mediaAPI.parameterMapping&&(p.mediaAPI.parameters=transform$b(p.mediaAPI.parameterMapping,d,!0)),n.push(p)}return n},[])}))).apply(this,arguments)}function _resolveCanonical(){return(_resolveCanonical=_async_to_generator$1((function*(e){return{results:{links:yield filterLinks(e)},meta:{originalUrl:e,originalQueryParams:parseQueryParams(e)}}}))).apply(this,arguments)}function asyncGeneratorStep(e,n,d,p,h,y,_){try{var m=e[y](_),g=m.value}catch(he){return void d(he)}m.done?n(g):Promise.resolve(g).then(p,h)}function _async_to_generator(e){return function(){var n=this,d=arguments;return new Promise((function(p,h){var y=e.apply(n,d);function _next(e){asyncGeneratorStep(y,p,h,_next,_throw,"next",e)}function _throw(e){asyncGeneratorStep(y,p,h,_next,_throw,"throw",e)}_next(void 0)}))}}function configure(e){return _configure.apply(this,arguments)}function _configure(){return(_configure=_async_to_generator((function*(e){tt.linkChild(Qe),tt.linkChild(Ye),tt.linkChild(De),tt.linkChild(We),e.playActivityAPI=e.realm===Ae.PODCAST?[new PodPAFTracker]:[new MPAFTracker,new LyricsTracker];let n=MusicKitInstance;void 0!==e.rtcOptions&&(e.playActivityAPI=[...e.playActivityAPI,new RTCStreamingTracker(e.rtcOptions),new ClickToPlayTracker]),n=SharePlayInstance;return yield configure$1(e,n,function(){var n=_async_to_generator((function*(n){const{apiOptions:d}=e;let p={apiType:Po.MEDIA_API,options:{}};d&&(p=createMediaAPIServiceDescriptor({configureOptions:d})),yield n.configure([p]),e.declarativeMarkup&&"undefined"!=typeof console&&console.warn&&console.warn("The declarativeMarkup configuration option has been removed in MusicKit JS V3")}));return function(e){return n.apply(this,arguments)}}())}))).apply(this,arguments)}if(Vo){const e=function(){function meta(e){if(detectNodeEnvironment())return;const n=document.head.querySelector(`meta[name=${e}]`);return(null==n?void 0:n.content)||void 0}const e=meta("apple-music-developer-token")||meta("JWT"),n=meta("apple-music-app-build")||meta("version"),d=meta("apple-music-app-name"),p=meta("apple-music-app-version");let h;return(e||n||d||p)&&(h={},e&&(h.developerToken=e),(n||d||p)&&(h.app={},n&&(h.app.build=n),d&&(h.app.name=d),p&&(h.app.version=p))),h}(),n=/interactive|complete|loaded/.test(document.readyState);e&&e.developerToken&&0===getInstances().length&&(n?asAsync(configure(e)):document.addEventListener("DOMContentLoaded",()=>configure(e)))}e.Events=Oi,e.MKError=MKError,e.MediaItem=MediaItem,e.PlayActivityEndReasonType=lt,e.PlaybackActions=Ei,e.PlaybackBitrate=it,e.PlaybackMode=wi,e.PlaybackStates=be,e.PlaybackType=ie,e.PlayerRepeatMode=Li,e.PlayerShuffleMode=io,e.PresentationMode=Pe,e.SKRealm=Ae,e.__dev=Mc,e.__log=rt,e.configure=configure,e.enableMultipleInstances=function(){Go=!0},e.formatArtworkURL=formatArtworkURL,e.formatMediaTime=function(e,n=":"){const{hours:d,minutes:p}=formattedSeconds(e);e=Math.floor(e%3600%60);const h=[];return d?(h.push(""+d),h.push(p<10?"0"+p:""+p)):h.push(""+p),h.push(e<10?"0"+e:""+e),h.join(n)},e.formattedMediaURL=formattedMediaURL,e.formattedMilliseconds=function(e){return formattedSeconds(e/1e3)},e.formattedSeconds=formattedSeconds,e.generateEmbedCode=function(e,n={height:"450",width:"660"}){if(!p.test(e))throw new Error("Invalid content url");var d;let _=null!==(d=n.height)&&void 0!==d?d:"450";var m;let g=null!==(m=n.width)&&void 0!==m?m:"660";const{kind:b,isUTS:P}=formattedMediaURL(e),S="post"===b||"musicVideo"===b||P;"song"===b||"episode"===b?_="175":S&&(_=""+Math.round(.5625*parseInt(g,10))),_=(""+_).replace(/(\d+)px/i,"$1"),g=(""+g).replace(/^(\d+)(?!px)%?$/i,"$1px");const T=(S?"width:"+g:"width:100%;"+(g?"max-width:"+g:""))+";overflow:hidden;border-radius:10px;";let k="https://embed.music.apple.com";return["podcast","episode"].includes(null!=b?b:"")&&!P&&(k="https://embed.podcasts.apple.com"),`<iframe ${[`allow="${y.join("; ")}"`,'frameborder="0"',_?`height="${_}"`:"",`style="${T}"`,`sandbox="${h.join(" ")}"`,`src="${e.replace(p,k)}"`].join(" ")}></iframe>`},e.getHlsJsCdnConfig=getHlsJsCdnConfig,e.getInstance=getInstance,e.getInstances=getInstances,e.getPlayerType=function(e){var n,d;return(null==e?void 0:e.isUTS)||ge.includes(null==e?void 0:e.type)?"video":null!==(d=null==e||null===(n=e.attributes)||void 0===n?void 0:n.mediaKind)&&void 0!==d?d:"audio"},e.prepareMediaAPIItem=prepareMediaAPIItem,e.resolveCanonical=function(e){return _resolveCanonical.apply(this,arguments)},Object.defineProperty(e,"__esModule",{value:!0})}));
